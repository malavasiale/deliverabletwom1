message;sha
[BUG] Fix flaky testLedgerOpenAfterBKCrashed--### Motivation----`BookieFailureTest#testLedgerOpenAfterBKCrashed` is a flaky test case, it cause some pr failed.----```--org.apache.bookkeeper.client.BKException$BKLedgerRecoveryException: Error while recovering ledger--  at org.apache.bookkeeper.client.SyncCallbackUtils.finish(SyncCallbackUtils.java:83)--  at org.apache.bookkeeper.client.SyncCallbackUtils$SyncOpenCallback.openComplete(SyncCallbackUtils.java:157)--  at org.apache.bookkeeper.client.LedgerOpenOp.openComplete(LedgerOpenOp.java:232)--  at org.apache.bookkeeper.client.LedgerOpenOp$1.safeOperationComplete(LedgerOpenOp.java:201)--  at org.apache.bookkeeper.client.LedgerOpenOp$1.safeOperationComplete(LedgerOpenOp.java:193)--  at org.apache.bookkeeper.util.OrderedGenericCallback.operationComplete(OrderedGenericCallback.java:62)--  at org.apache.bookkeeper.proto.BookkeeperInternalCallbacks$TimedGenericCallback.operationComplete(BookkeeperInternalCallbacks.java:189)--  at org.apache.bookkeeper.client.ReadOnlyLedgerHandle.lambda$recover$5(ReadOnlyLedgerHandle.java:295)--  at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:760)--  at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:736)--  at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:474)--  at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:1977)--  at org.apache.bookkeeper.client.LedgerRecoveryOp.submitCallback(LedgerRecoveryOp.java:136)--  at org.apache.bookkeeper.client.LedgerRecoveryOp.onEntryComplete(LedgerRecoveryOp.java:202)--  at org.apache.bookkeeper.client.ListenerBasedPendingReadOp.submitCallback(ListenerBasedPendingReadOp.java:67)--  at org.apache.bookkeeper.client.PendingReadOp$LedgerEntryRequest.fail(PendingReadOp.java:170)--  at org.apache.bookkeeper.client.PendingReadOp$SequenceReadRequest.sendNextRead(PendingReadOp.java:392)--  at org.apache.bookkeeper.client.PendingReadOp$SequenceReadRequest.logErrorAndReattemptRead(PendingReadOp.java:435)--  at org.apache.bookkeeper.client.PendingReadOp.readEntryComplete(PendingReadOp.java:581)--  at org.apache.bookkeeper.proto.BookieClientImpl$2.safeRun(BookieClientImpl.java:369)--  at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36)--  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)--  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)--  at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)--  at java.lang.Thread.run(Thread.java:748)--```----![image](https://user-images.githubusercontent.com/20113411/82434983-3add3880-9ac6-11ea-96a3-24fbd71d16d4.png)----### Changes----Test case should cover following situation, which shutdown any one of bookies, and try to open ledger with no bookie recovery. --```--Bookies: 4--ensSize: 3--writeQuorumSize: 2--ackQuorumSize: 2--```------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2337 from lamber-ken/bk-fix-wrong-test;f15b9bd15766d87d04258387a1164260056e088b
[BUG] Fix wrong jdk version on install doc page--### Motivation----We have adopted `lamada expression` and `stream api` in code base, it needs jdk1.8 at least.----e.g org.apache.bookkeeper.meta.zk.ZKMetadataClientDriver--```--Override--public void setSessionStateListener(SessionStateListener sessionStateListener) {--    zk.register((event) -> {--        // Check for expired connection.--        if (event.getType().equals(EventType.None) && event.getState().equals(KeeperState.Expired)) {--            sessionStateListener.onSessionExpired();--        }--    });--}--```----![image](https://user-images.githubusercontent.com/20113411/82619119-a4b12b80-9c07-11ea-92e5-a1e3f5f9ff6b.png)----### Changes----Update `Java Development Kit 1.6` to `Java Development Kit 1.8`----Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>--This closes #2343 from lamber-ken/clean-fix-install-doc;14ae5c8a03a10e55f778ee542afb5ed9a632eb23
[BOOKKEEPER-TOOL] Fix update rate-limiting for update-ledger command--### Motivation--Right now, `UpdateLedgerCmd` provides option `updatespersec` to throttle number of writes on zk. However, it throttles number of reads instead writes. Because of that it takes long time to complete this command as it slows down the read instead applying throttling while writing to zk.----### Modification--- Apply throttling while updating zk.--- If writes are being throttled then we also want to avoid accumulating reads so, added `maxOutstandingReads` option to manage max concurrent reads.----**Note:** We also need this change for #2321 .. so, I will rebase #2321 once this PR is merged.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2336 from rdhabalia/update_rate;e9021a607d55ed1802c44fd503fbf7640ad3ae98
Handle NPE when inet address is not able to resolve network address------Descriptions of the changes in this PR:----*Motivation*----```--06:00:53.731 [BookKeeperClientScheduler-OrderedScheduler-0-0] ERROR org.apache.bookkeeper.client.TopologyAwareEnsemblePlacementPolicy - Unexpected exception while handling joining bookie pulsar-tls-bookie-0.pulsar-tls-bookie.pulsar.svc.cluster.local:3181--java.lang.NullPointerException: null--	at org.apache.bookkeeper.net.NetUtils.resolveNetworkLocation(NetUtils.java:77) ~[org.apache.bookkeeper-bookkeeper-server-4.10.0.jar:4.10.0]--```----*TEST*----The `getAddress` is final method. It is hard to mock.----The method has been covered by other tests.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2301 from sijie/fix_network_utils;993148e5b292a5b5fcaf64c95231e84fd1697831
Add /api/v1/bookie/info REST API--Descriptions of the changes in this PR:----This adds an additional HTTP REST endpoint to expose the bookie's info (only storage numbers for now).----### Motivation----I was looking for an HTTP endpoint that returned the info of only the current bookie, but couldn't find one. The only similar API I've found was `/api/v1/bookie/list_bookie_info`, however it connects to all bookies and may take a long time to respond (plus its response format is difficult to parse).----### Changes----I've added a new API at `/api/v1/bookie/info` that returns a response like:--```json--{--  "freeSpace" : 0,--  "totalSpace" : 0--}--```----Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #2322 from fretiq/add-bookie-info-api;a8eb2d64ef040983493e65ed2c55e3255e3ee3b4
Issue #2305: Bookies should not be allowed to come up without a cookie in metadata store.--### Motivation--Currently we allow bookies to come up even if they don't have a cookie in the metadata store.--The cookie is an identity of a registered bookie and a bookie should not be allowed to come up without it.----### Changes--Update handling of bookie boot up. Add test.--This scenario is rarely expected but can happen in case of corruption or errant deletion of znodes for cookies----Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2306 from Ghatage/disableBootup-Wo-Cookie, closes #2305;a7ca7cff615391d1267f3546735e18b3306eb1e4
QuorumCoverage should only count unknown nodes--The original patch was contributed by ivankelly in PR #2303, I have only fixed checkstyle and removed two tests that were wrong.----Quorum coverage checks if we have heard from enough nodes to know that--there is no entry that can have been written to enough nodes that we--haven't heard from to have formed an ack quorum.----The coverage algorithm was correct pre-5e399df.----5e399df(BOOKKEEPER-759: Delay Ensemble Change & Disable Ensemble--Change) broke this, but it still seems to have worked because they had--a broken else statement at the end. Why a change which is 100% about--the write-path changed something in the read-path is a mystery.----dcdd1e(Small fix wrong nodesUninitialized count when checkCovered)--went on to fix the broken fix, so the whole thing ended up broke.----The change also modifies ReadLastConfirmedOp to make it testable.--Reviewers: Sijie Guo <None>, Rajan Dhabalia <rdhabalia@apache.org>--This closes #2333 from eolivelli/pr2303;f373cb5976ebca41ae036a26ba69f1c341897c08
Fix wrong module artifactId--### Motivation----Fix wrong maven artifactId, there are three module use the same artifactId.----### Changes----![image](https://user-images.githubusercontent.com/20113411/81897790-e4fe2180-95e9-11ea-9449-92941fe4c1bc.png)------Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2329 from lamber-ken/bk-fix-wrong-artifactId;fca0a071c3be99326b9075c24ff17ce76faf7bda
[BOOKIE-MTLS] add support of hostname verification--### Motivation----Right now, bookkeeper-client is not able to perform [hostname-verification](https://tersesystems.com/blog/2014/03/23/fixing-hostname-verification/) when it connects to broker over tls. Hostname-verification feature is already implemented in almost all [http-client](https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/ssl/DefaultHostnameVerifier.java) but it's not supported by [netty](https://stackoverflow.com/questions/13315623/netty-ssl-hostname-verification-support) yet. therefore, client should be able to perform hostname-verification as per [RFC-2181](https://tools.ietf.org/html/rfc2818#section-3.1)----### Modifications----- added client configuration to enable hostname-verification (default disable)--- use [http-client](https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/ssl/DefaultHostnameVerifier.java) but it's not supported by [netty](https://stackoverflow.com/questions/13315623/netty-ssl-hostname-verification-support) to perform hostname-validation rather adding custom logic.--- add httpclient-apache dependency into LICENSE and NOTICE files.----### Result----Bookkeeper client will be able to perform hostname verification while creating ssl session with bookie.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2156 from rdhabalia/hostname;adf086d54f85fa5321574300360f7fd86d47fe8b
Bump jackson.version from 2.9.7 to 2.11.0 (#2326);27c32fc3eb54e9fe8ec1155f97f2f0079f5f716a
[CI] Using master action code for checking rerun commands-- The rerun checks CI can not use ref to get all failure test actions. So I change to use sha of the commits to get all failure test actions to rerun. https://github.com/zymap/bot/pull/3/files--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2332 from zymap/fix-bot;8918fb8d5a2d44048edce0f128f97c56a582ba87
Issue #2106: Update ZookKeeper dependency to 3.5.7--Descriptions of the changes in this PR:--Updated ZooKeeper dependency from 3.4.13 to 3.5.7--Excluded transitive dependency to netty-all.--Updated maven-shade-pluging configuration in 'distributedlog-core-shaded' project. Package 'org.apache.jute' was moved to a ZooKeeper dependency (org.apache.zookeeper:zookeeper-jute), so i added the artifact to the artifactSet.----Updated license files:--- updated Zookeeper to 3.5.7--- removed Jline 2.11--- removed Netty 3.10.1--- added Zookeeper-jute 3.5.7----Master Issue: #2106 ------Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #2112 from dmercuriali/fix/#2106-update-zookeeper, closes #2106;fe25574edc80f7c53141a0bd610bcf26d6b9b8d8
Do not download SNAPSHOT during GitHub actions checks--### Motivation----Sometimes GitHub actions checks are stuck in downloading SNAPSHOTs, there is not need for it----### Changes----Add "-nsu" option to every Maven invokations and remove "-Dstream" that is now useless.--I am also adding "-B" that suppresses the "Progress" noise in logs----This fix relates to #2294--Reviewers: Anup Ghatage <None>, Matteo Minardi <minardi.matteo@hotmail.it>, Rajan Dhabalia <rdhabalia@apache.org>--This closes #2323 from eolivelli/fix/no-snapshot-updates and squashes the following commits:--69b7817a4 [Enrico Olivelli] Add -B-3fa4523b2 [Enrico Olivelli] GitHub Actions: do not look for SNAPSHOT updates;34d35f033e1ef099e60ac75a9d59aecc6c5a2001
Rerun the failed tests by comments---------*Motivation*----Currently, non-committers cannot rerun the failure tests, we need to--provide the ability to let non-committer to rerun the failed tests.--I wrote a Github Actions that can rerun the failed test by comments--`rerun failure tests` and add it to the bookkeeper ci process.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2309 from zymap/rerun-failure-job;d2b350845fc93c46dfdadbc498a78a37f74e6199
Issue #2212: Fix issues in Bookkeeper Docker image that prevented containers from starting up--Descriptions of the changes in this PR:----### Motivation----This PR modifies the Apache Bookkeeper Docker image to fix issues that were causing errors upon container bootstrap. The containers would exit soon after they were launched. See issue #2212 for a description of such an error. ----Note that the problems that are fixed in this PR were observed:----* when launching containers using both Docker Compose and Kubernetes.  --* when we were trying to upgrade the image to: `4.9.2`. It is highly likely that the issue is observed in other versions (except for `4.7.3`) too.  --* when launching both a standalone container as well as a cluster of three containers.----### Changes--The major changes made in this PR are as follows: --* Updates the `Dockerfile` to install `zk-shell`. --* Update the `init_bookie.sh` file to:--   * Use `zk-shell` instead of `/opt/bookkeeper/bin/bookkeeper org.apache.zookeeper.ZooKeeperMain` command that doesn't work. --  * Use `opt/bookkeeper/bin/bookkeeper shell initnewcluster` for initializing the cluster instead of the previously used command that did not work. --  * Increase the time a container waits for an in-flight `initnewcluster` operation. --  * Make the comments more descriptive.--* Modifies `bin/common.sh` to handle the condition when file `/proc/sys/net/ipv6/bindv6only` is missing in the system. This can prevent a container from starting up in some cases. We have seen this issue on some Kubernetes-based environments. --* Fixes errors in `docker-compose.yml` file. ----*Note:* Some of the changes made in this PR are modeled after changes made by sijie for `v4.7.2` in PR #1666 .----### Master Issue--#2212 --------Reviewers: Jia Zhai <zhaijia@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2219 from ravisharda/startup-failure-docker-image, closes #2212;092ebf2a7ec596db0357a072caf123b18a7f29e6
[DOC] SSLContextFactory -> TLSContextFactory--### Motivation--From 4.6.0 SSLContextFactory has been changed into TLSContextFactory. but some of the doc not updated.----### Changes--Updated related doc.--Reviewers: Sijie Guo <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2307 from jiazhai/doc_outdate_ssl;94912a9fdca68391866baf598c36708e406728f8
ISSUE #2310: Adds the autorecovery status service.--Descriptions of the changes in this PR:--------### Motivation----It would be convenient to support enable, disable, or check the status of autorecovery with REST API, just like what does in the toggle command.----### Changes----Adds an API to enable, disable, and get the current status of autorecovery at `/api/v1/autorecovery/status`.----Master Issue: #2310 ------Reviewers: Sijie Guo <None>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Minardi <minardi.matteo@hotmail.it>--This closes #2313 from fantapsody/autorecovery_status, closes #2310;a1b187e338fd5892df7816d48c153e61302483cc
Bump libthrift from 0.9.3 to 0.12.0 (#2201)--Bumps [libthrift](https://github.com/apache/thrift) from 0.9.3 to 0.12.0.--- [Release notes](https://github.com/apache/thrift/releases)--- [Changelog](https://github.com/apache/thrift/blob/master/CHANGES.md)--- [Commits](https://github.com/apache/thrift/compare/0.9.3...v0.12.0)----Signed-off-by: dependabot[bot] <support@github.com>----Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>;e4febdbf048afaf6bdcd8bede16ddd80db0cbc07
Fix mistakes in documentation--Fix minor mistakes in the sentences of the documentation----------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #2271 from yehohanan7/patch-1;380ed4ef79d0429f7d05d611b48915ac77638565
Add forkCount option to parallelize build and tests--### Motivation--Current code forks a new JVM per module. (bookkeeper-server, bookkeeper-proto etc)--This means one fork per module for build and testing, no parallelism within the module where majority of the time goes.--We need parallelism within a module during the test execution so we can have the builds complete faster and have the artifacts shipped out quicker.----### Changes--We use the maven surefire plugin but don't define the `forkCount` and hence set it to default of 1.--This means it executes each module with one thread.--This change sets `forkCount` to 5, enabling parallelism in testing and drastically reducing total turnaround time. (by about 2/3rds!)----*Total build+test time without this change*--```--[INFO] BUILD SUCCESS--[INFO] --------------------------------------------------------------------------[INFO] Total time:  01:06 h--[INFO] Finished at: 2020-03-05T02:01:29-08:00--[INFO] --------------------------------------------------------------------------```--*Total build+test time with this change*--```--[INFO] --------------------------------------------------------------------------[INFO] BUILD SUCCESS--[INFO] --------------------------------------------------------------------------[INFO] Total time:  18:23 min--[INFO] Finished at: 2020-03-05T02:38:22-08:00--[INFO] --------------------------------------------------------------------------```----### Things to watch--Added parallelism may cause some flappers but with much trial and error I have come to the number `5`. The flappers are usually only from conflict in obtaining the same port number.--If needed, we can increase the retryCount, but as of now I consistently don't see any flappers at a `forkCount` of 5--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2278 from Ghatage/parallelizeBuildAndTests;e20a24a6aca44968fe6a597be31e08a552d38dec
ISSUE #2274: The 'metaformat' command does not delete 'idgen' znode--Descriptions of the changes in this PR:----### Motivation----After `metaformat`, ledgerId does not count from 0 because，the `metaformat` command does not delete `idgen` znode.----### Changes----In the `AbstractZkLedgerManagerFactory` avoid skipping the igen and idgen-long nodes----Master Issue: #2274--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2315 from mino181295/leadger-metaformat, closes #2274;76286bc5505e4ba1cfeb47ce30bbe627d53f4869
Force to use Python grpcio less then 1.26.0--- it looks like a newer version of grpcio has been published and we were using open version range--- by forcing a closed ended range of version we workaround the error in integration tests--Reviewers: Jia Zhai <zhaijia@apache.org>, Matteo Minardi <minardi.matteo@hotmail.it>--This closes #2317 from eolivelli/fix/integration-tests-python;f1077a6fa48553d7d8b1cf164e2e5a4f37125204
Fix batch read data in cache does not take effect--Descriptions of the changes in this PR:--------### Motivation----Fix batch read data in cache does not take effect----### Changes----(Describe: what changes you have made)----Master Issue: #2230 --Fixes: #2230 --------Reviewers: Jia Zhai <zhaijia@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2231 from liudezhi2098/issue-branch-xxx;45871dccbb72a5aee30f7bbfaacfa0d6c2c202a5
[bookie-server-config] Avoid considering empty journalDirectories--As discussed at : https://github.com/apache/pulsar/issues/6042----### Issue--We have config management tool which manages bookie-server configuration and sets empty value of `journalDirectories` if bookie-server is still wants to use single journal dir: `journalDirectory`. In this case, bookie-server doesn't consider `journalDirectory` value and keeps empty list of `journalDirectories` which stats bookie with invalid configuration.----### Expected behavior--Bookie-server should parse empty configuration `journalDirectories=` properly and avoid picking up empty value of `journalDirectories` and in that case, bookie-server should fallback to `journalDirectory` config.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2245 from rdhabalia/journal_dir;e7430ce25e3609bf77b028e4f0475dad2147c22d
Allow build on JDK14 - upgrade Groovy compiler--### Motivation----Current version of Groovy compiler for integration tests do not support JDK14----### Changes----Update Groovy Compiler--Update dockerfile-maven-plugin as well------Reviewers: Sijie Guo <None>--This closes #2298 from eolivelli/fix/build-jdk14;665565e9802c3aec4b49df5dd53967b6d1981ca6
Unable to enable TLS if using v2 protocol--Descriptions of the changes in this PR:----*Motivation*----TLS is enabled using `startTLS` but the `startTLS`--is a v3 protobuf request. So if the client is--configured to use v2 protocol, the client is not--able to decode `startTLSResponse`.----*Modifications*----This change is to improve the v2 protocol response handling for--handling `startTLS` response.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2300 from sijie/fix_tls_v2_protocol;87981d420d0ae9d472d4e92b7abc145069e17e61
Update Arquillian Cube to 1.18.2--### Motivation--Update Arquillian to latest version--Reviewers: Rajan Dhabalia <rdhabalia@apache.org>--This closes #2297 from eolivelli/fix/update-arquillian;e482a125429d6b29382ea56b793daa5447927655
[BOOKIE-LEDGER-RECOVERY] Fix bookie recovery stuck even with enough ack-quorum response--### Motivation--As discussed at https://github.com/apache/pulsar/issues/6505 ----Bk-client was not able to recover ledger which has 2 write/ack quorum and one of the bookie went down and recovery was kept failing and bookkeeper client was not able to recover the ledger.----**BK-Client log**----```--20:44:43.721 [BookKeeperClientWorker-OrderedExecutor-1-0] ERROR org.apache.bookkeeper.client.ReadLastConfirmedOp - While readLastConfirmed ledger: 1234567 did not hear success responses from all quorums--20:44:43.721 [bookkeeper-io-12-27] ERROR org.apache.bookkeeper.proto.PerChannelBookieClient - Could not connect to bookie: [id: 0xb8b97441, L:/1.1.1.1:1234]/1.1.1.2:3181, current s--tate CONNECTING : --io.netty.channel.AbstractChannel$AnnotatedConnectException: finishConnect(..) failed: No route to host: /1.1.1.2:3181--        at io.netty.channel.unix.Errors.throwConnectException(Errors.java:112) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.unix.Socket.finishConnect(Socket.java:269) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.doFinishConnect(AbstractEpollChannel.java:665) [netty-transport-native-epoll-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.finishConnect(AbstractEpollChannel.java:642) [netty-transport-native-epoll-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.epollOutReady(AbstractEpollChannel.java:522) [netty-transport-native-epoll-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:423) [netty-transport-native-epoll-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:330) [netty-transport-native-epoll-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:897) [netty-common-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-common-4.1.31.Final.jar:4.1.31.Final]--        at java.lang.Thread.run(Thread.java:834) [?:?]--Caused by: java.net.ConnectException: finishConnect(..) failed: No route to host--```----**Ledger metadata**----```--BookieMetadataFormatVersion 2--quorumSize: 2--ensembleSize: 2--length: 0--lastEntryId: -1--state: IN_RECOVERY--segment {--  ensembleMember: "1.1.1.1:3181"--  ensembleMember: "1.1.1.2:3181"--  firstEntryId: 0--}--digestType: CRC32--```----**Root cause:**--Bookie should be able to recover ledger once it receives the response from total N (`(Qw - Qa)+1`) bookies. But it was waiting for a successful response from both quorums.--Reference: https://bookkeeper.apache.org/docs/4.5.0/development/protocol/----### Modification--Bookie should be able to recover ledger once it receives the response from total N (`(Qw - Qa)+1`) bookies.----Reviewers: Diego Salvi <diego.salvi@diennea.com>,  Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2281 from rdhabalia/recover_q;86f58e8a7269c8e51f246386968ceed051375b8f
 #2288: add metadata to StreamStorage ledgers (#2296)--Descriptions of the changes in this PR:----Added 'application' and 'component' metadata to StreamStorage ledgers.--application: bk-stream-storage-service--component: state-store / checkpoint-store----Master Issue: #2288----* #2288 add metadata to StreamStorage ledgers----* #2288 add metadata to StreamStorage ledgers----Co-authored-by: Dennis Mercuriali <dennis.mercuriali@diennea.com>;c69772b1ace050b166ef69e3bc72d5f2c19cd5af
Remove old Jenkins stuff (#2293)--Remove old Jenkins stuff for GitHub Create Pull Request template--Co-authored-by: Enrico Olivelli <enrico.olivelli@diennea.com>;064c364e7bc20033fa7d0beac6286bfce8fb52bd
2279 fix NPE when exec readjournal command--Descriptions of the changes in this PR:--This PR fix NullPointerException when exec readjournal command--See issue #2279 ----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2280 from aloyszhang/read-jounral;bd3d3b5473f1b8d90d681d03a128c9332c80425d
[BOOKIE-MTLS] add BouncyCastleProvider for security-provider to avoid InvalidKeyException--### Motivation--As described at: https://github.com/apache/pulsar/issues/5047----### Issue----Sometimes user  sees `Invalid TLS configuration` at bookie while loading PKCS8Key file and that can be fixed by using Bouncycastle provider.: https://stackoverflow.com/questions/6559272/algid-parse-error-not-a-sequence/18912362#18912362----```--2019-08-26 16:16:51,983 - ERROR - [BookKeeperClientWorker-OrderedExecutor-0-0:BookieClient179] - Security Exception in creating new default PCBC pool: --org.apache.bookkeeper.tls.SecurityException: Invalid TLS configuration--	at org.apache.bookkeeper.tls.TLSContextFactory.init(TLSContextFactory.java:392)--	at org.apache.bookkeeper.proto.PerChannelBookieClient.<init>(PerChannelBookieClient.java:266)--	at org.apache.bookkeeper.proto.BookieClient.create(BookieClient.java:155)--	at org.apache.bookkeeper.proto.DefaultPerChannelBookieClientPool.<init>(DefaultPerChannelBookieClientPool.java:71)--	at org.apache.bookkeeper.proto.BookieClient.lookupClient(BookieClient.java:168)--	at org.apache.bookkeeper.proto.BookieClient.addEntry(BookieClient.java:245)--	at org.apache.bookkeeper.client.PendingAddOp.sendWriteRequest(PendingAddOp.java:131)--	at org.apache.bookkeeper.client.PendingAddOp.safeRun(PendingAddOp.java:240)--	at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36)--	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)--	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)--	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)--	at java.lang.Thread.run(Thread.java:745)--Caused by: java.lang.IllegalArgumentException: File does not contain valid private key: /my.key.pem--	at io.netty.handler.ssl.SslContextBuilder.keyManager(SslContextBuilder.java:267)--	at org.apache.bookkeeper.tls.TLSContextFactory.createClientContext(TLSContextFactory.java:244)--	at org.apache.bookkeeper.tls.TLSContextFactory.init(TLSContextFactory.java:363)--	... 12 more--Caused by: java.security.spec.InvalidKeySpecException: Neither RSA, DSA nor EC worked--	at io.netty.handler.ssl.SslContext.getPrivateKeyFromByteBuffer(SslContext.java:1045)--	at io.netty.handler.ssl.SslContext.toPrivateKey(SslContext.java:1014)--	at io.netty.handler.ssl.SslContextBuilder.keyManager(SslContextBuilder.java:265)--	... 14 more--Caused by: java.security.spec.InvalidKeySpecException: java.security.InvalidKeyException: IOException : algid parse error, not a sequence--	at sun.security.ec.ECKeyFactory.engineGeneratePrivate(ECKeyFactory.java:169)--	at java.security.KeyFactory.generatePrivate(KeyFactory.java:372)--	at io.netty.handler.ssl.SslContext.getPrivateKeyFromByteBuffer(SslContext.java:1043)--	... 16 more--Caused by: java.security.InvalidKeyException: IOException : algid parse error, not a sequence--	at sun.security.pkcs.PKCS8Key.decode(PKCS8Key.java:351)--	at sun.security.pkcs.PKCS8Key.decode(PKCS8Key.java:356)--	at sun.security.ec.ECPrivateKeyImpl.<init>(ECPrivateKeyImpl.java:73)--	at sun.security.ec.ECKeyFactory.implGeneratePrivate(ECKeyFactory.java:237)--	at sun.security.ec.ECKeyFactory.engineGeneratePrivate(ECKeyFactory.java:165)--	... 18 more--```--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2151 from rdhabalia/bc-mtls;ec3ade0a255d94e8329e9eb3b69ec9c2ed59e6e4
Do not log WARNING about PlacementPolicy for tests and simple setups----Descriptions of the changes in this PR:--Do not log 'New ensemble: {} is not adhering to Placement Policy. quarantinedBookies' in case of ensembleSize = 1------### Motivation--In tests cases and in simple demos it is very annoying to see that log line at "WARNING" level.--If we are requiring only 1 bookie it is not a big deal to WARN that the placement policy is not "adhering"----Reviewers: Matteo Minardi <minardi.matteo@hotmail.it>, Atri Sharma <None>, Sijie Guo <None>--This closes #2286 from eolivelli/fix/no-log-single-bookie;05fe83d6ca97d6bc415bb304e4f24537b7b06c0a
Add Journal PageCache flush interval control when journalSyncData is disabled--Descriptions of the changes in this PR:--### Motivation--There was a weird behavior observed: when journalSyncData is disabled, it will trigger callbacks when the data is flushed to filesystem(PageCache) but still enqueue a fsync request to force write queue to fsync PageCache data to disk frequently. Though the fsync thread dequeue fsync request and execute fsync operation asynchronously, it still cause disk io util increase when fsync frequency high enough. when disk io util increase, especially reach 100%, it will block new journal file creation and lead to journal sync time increases to mutiple seconds.----### Changes--when journalSyncData is disabled, we introduce `journalPageCacheFlushIntervalMSec` to control journal PageCache flush frequency to reduce disk io util, default value is 1000ms--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>--This closes #2287 from hangc0276/bugfix;8201de86a6e04164efa4fabbf91d4c4a67bbd1fe
fix some stats monitor metrics--Descriptions of the changes in this PR:----The journalStats.getJournalQueueSize increase once and decrease twice, so this stat metric will be negative.----It increases in `logAddEntry` function and decrease in `QueueEntry recall` methord and Journal main thread run methord.----so we should delete the decrease in journal main thread run methord.----```--queue.put(QueueEntry.create(--                entry, ackBeforeSync,  ledgerId, entryId, cb, ctx, MathUtils.nowInNano(),--                journalStats.getJournalAddEntryStats(),--                journalStats.getJournalQueueSize()))--```--Reviewers: Sijie Guo <None>--This closes #2290 from hangc0276/bugfix_metrics;fbfd49a1e0307e5d490a2cdf8cbb840ef88cf628
Update Prometheus library to 0.8.1--Descriptions of the changes in this PR:--Update Prometheus library to 0.8.1----### Motivation----We have an obsolete version----### Changes----Update Prometheus library to latest version 0.8.1 and update NOTICE files----Reviewers: Sijie Guo <None>--This closes #2291 from eolivelli/fix/update-prom-081;13103341bcf36f5f939c2638830dd7c31bc8811c
fix bookie decommission sleep timeout value is negative bug--when decommission a bookie, and the ledger size of the bookie is big enough, the thread timeout will get negative, and the decommission operation will give up by throw exceptions as follow--```--14:12:56.982 [main] INFO  org.apache.bookkeeper.client.BookKeeperAdmin - Count of Ledgers which need to be rereplicated: 272752--14:12:56.983 [main] ERROR org.apache.bookkeeper.bookie.BookieShell - Received exception in DecommissionBookieCmd --java.lang.IllegalArgumentException: timeout value is negative--	at java.lang.Thread.sleep(Native Method) ~[?:?]--	at org.apache.bookkeeper.client.BookKeeperAdmin.waitForLedgersToBeReplicated(BookKeeperAdmin.java:1528) ~[org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--	at org.apache.bookkeeper.client.BookKeeperAdmin.decommissionBookie(BookKeeperAdmin.java:1500) ~[org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--	at org.apache.bookkeeper.bookie.BookieShell$DecommissionBookieCmd.runCmd(BookieShell.java:2664) [org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--	at org.apache.bookkeeper.bookie.BookieShell$MyCommand.runCmd(BookieShell.java:277) [org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--	at org.apache.bookkeeper.bookie.BookieShell.run(BookieShell.java:3081) [org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--	at org.apache.bookkeeper.bookie.BookieShell.main(BookieShell.java:3172) [org.apache.bookkeeper-bookkeeper-server-4.9.2.jar:4.9.2]--14:12:57.013 [main] INFO  org.apache.zookeeper.ZooKeeper - Session: 0x206189927840052 closed--```--The exception code is --```--private void waitForLedgersToBeReplicated(Collection<Long> ledgers, BookieSocketAddress thisBookieAddress,--            LedgerManager ledgerManager) throws InterruptedException, TimeoutException {--        int maxSleepTimeInBetweenChecks = 10 * 60 * 1000; // 10 minutes--        int sleepTimePerLedger = 10 * 1000; // 10 secs--        Predicate<Long> validateBookieIsNotPartOfEnsemble = ledgerId -> !areEntriesOfLedgerStoredInTheBookie(ledgerId,--                thisBookieAddress, ledgerManager);--        while (!ledgers.isEmpty()) {--            LOG.info("Count of Ledgers which need to be rereplicated: {}", ledgers.size());--            int sleepTimeForThisCheck = ledgers.size() * sleepTimePerLedger > maxSleepTimeInBetweenChecks--                    ? maxSleepTimeInBetweenChecks : ledgers.size() * sleepTimePerLedger;--            Thread.sleep(sleepTimeForThisCheck);--            LOG.debug("Making sure following ledgers replication to be completed: {}", ledgers);--            ledgers.removeIf(validateBookieIsNotPartOfEnsemble);--        }--    }--```--the ledger size is `272752`, when computing sleepTimeForThisCheck, --`ledgers.size() * sleepTimePerLedger` is `272752 * 10 * 1000 = 2727520000`， --the value exceeds max int value `2147483647`, it will turn to `-1567447296`, then the sleepTimeForThisCheck will be `-1567447296`.-- Thread.sleep will throw `java.lang.IllegalArgumentException: timeout value is negative` exception--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #2284 from hangc0276/bug_fix;025d99f5a2a4cc02f3780a11b58a9b9d6c9940c3
Fixes vertx can not receive the request body---------*Motivation*----Vertx can not receive the request body so that the REST API--can not work well if you have a request with body.----*Modifications*----- Add body handler for the vertx http service----*Verify this change*----- Pass the test `testHttpMethodsWithBody`----Descriptions of the changes in this PR:--------### Motivation----(Explain: why you're making that change, what is the problem you're trying to solve)----### Changes----(Describe: what changes you have made)----Master Issue: #<master-issue-number>--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2241 from zymap/fix-can-not-read-body;92f75da3f8711cb98eda2f435bbd57ffe67e87b7
Drop Maven Profile -Dstream (#2233)--### Motivation----The "stream" profile enables the build of all of the additional packages regarding the 'table service'.--This profile complicates a lot every script and the Maven project.--As the stream storage service is now stable and used in production, it is better to always include those modules.--Regualar developers on bookkeeper-server module won't be affected by this change as it affects only the full build and the release process.----### Changes--Modify every pom.xml in order to enable all of the parts of the pom.xml that would be enabled with '-Dstream'.--Modify release scripts by removing references to -Dstream--Modify bin/common.sh about the auto build feature--Modify Groovy scripts for Jenkins--Do not "shade" libthrift inside Distributed Log Jar----I did not modify the website because currently the precommit validation of the website is broken------* Remove stream Maven Profile----* Delete job_bookkeeper_precommit_java11.groovy----* Delete job_bookkeeper_precommit_java8.groovy----* Delete ticktoc.sh----* Restore -DstreamTests profile----Co-authored-by: Enrico Olivelli <eolivelli@apache.org>;21e0e2f9489be85542c882e5aa41a9a7c67ba827
Move the result of the BKCTL to the console by default--### Motivation ------### Changes----  Move the result of the BKCTL to the console----Master Issue: #2236  --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2268 from SunDapeng1/branch-2267;407a0299af034423aca009fe353c10a9de15f490
2178: IOException Should Be Thrown When Journal Is Corrupted--Fixes #2178 --Reviewers: Enrico Olivelli <eolivelli@gmail.com>,  Sijie Guo <sijie@apache.org>--This closes #2257 from atris/2176;9d6f5db2da75da2050ec753b4a3e7784f90c7c37
Move checkout action to v2 (#2272);b94d3fbb7540618e13781b3db14e2d2bcb2c823d
ISSUE #2218: Write customMetadata on ledgers created by DistributedLog--### Changes----Enable DistributedLog to attach custom metadata to underlying ledgers when writing logs.----The user can pass a LedgerMetadata object to DistributedLogManager#openLogWriter and DistributedLogManager#openAsyncLogWriter. The LedgerMetadata object is then used by the Allocator backing the BKLogWriteHandler every time it must allocate a new ledger.----Master Issue: #2218------Reviewers: Enrico Olivelli <eolivelli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2254 from dmercuriali/2218-distributedlog-ledger-custom-metadata, closes #2218;b84178af53d631b268143f9b8b0a3c3f731bf68a
Fix method order in order to make the execution of TestEntryLog predictable--### Motivation----TestEntyLog reuses the entryLogger variable across test methods execution, resulting in an unpredictable execution.--We can at least make the test work consistently across environments using JUnit built-in FixMethodOrder annotation----### Changes--FixMethodOrder(MethodSorters.NAME_ASCENDING)----Fixes #2260----Reviewers: Atri Sharma <atri@apache.org>--This closes #2266 from eolivelli/fix/flaky;761e42c608689dc595f019a2ac6a92fa1e0d30c7
Revert "bin/bookkeeper shell supports the -conf"--This reverts commit 163db4496d50cae198b80c9d88c14579f6d2e9f3.----Descriptions of the changes in this PR:--Commit 163db4496d50cae198b80c9d88c14579f6d2e9f3 broke "bookkeeper shell" command and integration tests are no more able to work------Reviewers: Sijie Guo <sijie@apache.org>--This closes #2265 from eolivelli/fix/revert-bad-fix;3ae3ad445b9d22b0a6c8b82f8da383955f4d6a4d
Add BP-38 to list of approved releases;018648b8cf7ca8e105c976aaa7e941561d2902e8
BP-38 Publish Bookie Service Info on Metadata Service--This is the BP page for BP-38 Publish Bookie Service Info on Metadata Service----Master Issue: #2215 --------Reviewers: [Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>, Flavio Junqueira <fpj@apache.org>--This closes #2214 from eolivelli/fix/bp-disc;26e03dc8d410627d6a489cd5dd32ae837bc4cc0e
Remove travis--Descriptions of the changes in this PR:----### Motivation----The CI is moved to github actions.------### Changes----Delete travis configuration.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2259 from sijie/remove_travis_ci;9397d111408351bbe329588c026c226b03893f11
[CODE-STYLE] fix build failure for check-style--Descriptions of the changes in this PR:--------### Motivation----PR Validation build is failing with below exception:--```--[ERROR] src/main/java/org/apache/bookkeeper/stream/storage/impl/cluster/ZkClusterInitializer.java:[35] (imports) ImportOrder: Import org.apache.bookkeeper.stream.storage.StorageConstants.getSegmentsRootPath appears after other imports that it should precede--[ERROR] Failed to execute goal org.apache.maven.plugins:maven-checkstyle-plugin:3.0.0:check (default-cli) on project stream-storage-service-impl: You have 1 Checkstyle violation. -> [Help 1]--```--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2258 from rdhabalia/checkZk;6989954e05504c345ae9e50c9c906f8291a6dc02
Website: update Gemfile dependencies--Updating Gemfile dependencies to try fix Travis (see https://github.com/apache/bookkeeper/issues/2252)----Also fixing https://www.cvedetails.com/cve/CVE-2018-17567/ in the meantime----You can find the staging website  https://aluccaroni.github.io/bookkeeper-staging-site--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2256 from aluccaroni/master;e37f3aa03ad4d1ad1e5ded2ffceac3e844e6f46e
Remove Jenkins precommit jobs and fix checkstyle errors----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2255 from sijie/remove_bookkeeper_tests;2836241fbdbe2c8b31718f2374f6fbe50645a2b7
Website: add EOL tag to navbar--As discussed on the mailing list, I'm updating the BookKeeper website to reflect the EOLed version of BookKeeper----You can find the staging website  https://aluccaroni.github.io/bookkeeper-staging-site----Here a screenshot of the new navbar:--![image](https://user-images.githubusercontent.com/11058798/72979770-587ce880-3dd9-11ea-86bf-de4a9aa694d3.png)----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo--This closes #2253 from aluccaroni/master;a5eb8caaf52b04b24abce07b25f4c609675fbd06
bin/bookkeeper shell supports the -conf--### Motivation--`bin/bookkeeper shell ` support `-conf configuration`, but it doesn't work. bk_server.conf is loaded by default, even if the configuration is specified--![image](https://user-images.githubusercontent.com/42792537/70309755-2a534180-1849-11ea-96b0-bd5b07a6b717.png)--Modify `bin/bookkeeper` to specify the configuration file as an absolute path------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2211 from SunDapeng1/branch-2211;163db4496d50cae198b80c9d88c14579f6d2e9f3
[CI] Migrate the Jenkins CI to Github Action---------Master Issue: #2242----*Modifications*----Migrate theJenkins CI to Github Action----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2246 from zymap/migrate-ci;cfb28fe6ef1cb82f7e8e16f3859b02d607555656
Website: Update Release Management for new Time Based Release Plan--As discussed on the mailing list, I'm updating the BookKeeper website to reflect the new Time Based Release Plan.----You can find the staging website  https://aluccaroni.github.io/bookkeeper-staging-site/community/releases/----Please note that I've removed the calendar since it was empty--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2251 from aluccaroni/master;965c874d5ef7455de902dbcedc7471bb60ee886b
[HOTFIX] [DOCS] fix error in leger api document--This PR :--1. add missing comma and dot--2. fix some layout error--in ledger-api document--Reviewers: Sijie Guo <None>--This closes #2250 from aloyszhang/hotfix-ledger-api;41a468743dd1f0b004179ce406fae291c1b80abe
[HOTFIX] [DOCS] remove redundant word in protocol documents--This PR removes redundant word  "because" in protocol documents.----Reviewers: Sijie Guo <None>--This closes #2249 from aloyszhang/hotfix-protocol;325d9c4b9c2b59c77d2db71129d138d0b2207d61
[HOTFIX] fix the http endpoint component count error--This PR is a hotfix for "BookKeeper Admin REST API" document, the compoent of HTTP endpoints should be 5, but it's 4 in the doc.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2248 from aloyszhang/hotfix;1f403f96582b292c2ea29c92ed22c859c2f9cffa
Create ledgersRootPath recursively for 'bin/bookkeeper shell metaformat'--Create ledgersRootPath recursively for `bin/bookkeeper shell metaformat`. The existence of any parent znodes is not an error condition----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2237 from SunDapeng1/branch-2236;004cfe36af8365c6a9bb198ccf74eab311f0249d
Increase the 'segment store path' in the 'Initializing stream cluster' log--Increase the 'segment store path' in the 'Initializing stream cluster' log--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2238 from SunDapeng1/branch-2238;8889efa54e7d8997b79445b1541e8510915ec85b
[bookie-server] add support of client auto cert refresh--### Motivation--as described at: https://github.com/apache/pulsar/issues/6010----Bookkeeper-client caches the tls certificates when it first tries to create a cnx with a given bookie and after that it never reloads certs even when valid certs changes on the file-system or new bookie-connection is created. Because of that as soon as client certs expires and bk-client disconnects from bookie then bk-client is not able to reconnect to bookie until we restart the bk-client process. and we see below TLS exception at bk-client.----```--19:43:03.983 [bookkeeper-io-12-45] ERROR org.apache.bookkeeper.proto.PerChannelBookieClient - Unexpected exception caught by bookie client channel handler--io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: General OpenSslEngine problem--        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:472) ~[netty-codec-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:278) ~[netty-codec-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1434) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:965) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:799) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:433) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:330) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:909) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.32.Final.jar:4.1.32.Final]--        at java.lang.Thread.run(Thread.java:834) [?:?]--Caused by: javax.net.ssl.SSLHandshakeException: General OpenSslEngine problem--        at io.netty.handler.ssl.ReferenceCountedOpenSslClientContext$OpenSslClientCertificateCallback.handle(ReferenceCountedOpenSslClientContext.java:273) ~[netty-all-4.1.32.Final.jar--:4.1.32.Final]--        at io.netty.internal.tcnative.SSL.readFromSSL(Native Method) ~[netty-tcnative-boringssl-static-2.0.20.Final.jar:2.0.20.Final]--        at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.readPlaintextData(ReferenceCountedOpenSslEngine.java:575) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1124) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1236) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1279) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.SslHandler$SslEngineType$1.unwrap(SslHandler.java:217) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1301) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.SslHandler.decodeNonJdkCompatible(SslHandler.java:1215) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1249) ~[netty-all-4.1.32.Final.jar:4.1.32.Final]--        at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:502) ~[netty-codec-4.1.31.Final.jar:4.1.31.Final]--        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:441) ~[netty-codec-4.1.31.Final.jar:4.1.31.Final]--        ... 14 more--```----### Modification--Add support at bk-client to reload certs once they have changed on file-system.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>--This closes #2235 from rdhabalia/bk_client_cert;0098999ebd9d6269770d9a9a2ddd1190e9c83cda
ISSUE #2224: Config ServerConfiguration with setAllowLoopback(true) for Unit Tests--### Motivation----Unit test fails when build master branch----### Changes----Config ServerConfiguration with setAllowLoopback(true) in the class GarbageCollectorThreadTest----Master Issue: #2224 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2226 from coolbeevip/ISSUE-2224, closes #2224 and squashes the following commits:--fdba4fbce [Lei Zhang] ISSUE-2224 set allowLoopback is true-2ff7ca5af [Enrico Olivelli] Account Apache Thrift and Http Client files in LICENSE files - Fix build on Travis-2bbf58e01 [Dapeng] Fixed bin/bookkeeper shell readjournal-9d61fb4fe [Dapeng] [DOCS] Modify “Using Autoecovery?,recover does not support the specified target bookie-2ca4025e4 [Anup Ghatage] [DOCUMENTATION] Add doc for decommissioning bookie process-62e3b9b6f [Enrico Olivelli] Make 4.9.2 as stable-40f349ccf [Enrico Olivelli] Bump Python client version-b1991e6b3 [Enrico Olivelli] Release notes for 4.10-9f4b1359e [冉?龙] Fix the log level of not support Sse42Crc32C-557dfe90f [Jennifer Huang] [DOCS] Update coding_guide.md-43f8cd74f [Enrico Olivelli] Add -Dtwitter to fix auto-build-f57962bcc [Matteo Merli] Removed mutex contention on BufferedChannel-f5d2e5931 [Enrico Olivelli] Add -Dtwitter to release scripts in order to build Twitter stats providers-7efa8e89e [Enrico Olivelli] Fix version in modules that are not active by default-d49b46f4e [Enrico Olivelli] [maven-release-plugin] prepare for next development iteration-5a4213bb0 [Enrico Olivelli] [maven-release-plugin] prepare branch branch-4.10-f8a5974a5 [Charan Reddy Guttapalem] Fix firstStoredEntryId logic in LedgerFragment-8559126a3 [Anup Ghatage] Issue #2145: Make ledgerDirs in Cookie consistent across generating a…;eba63dbfa8c646616b55280c700d8bf5114d3cbe
Remove Twitter Libraries--- Twitter Stats Providers--- Twitter Http Server----Descriptions of the changes in this PR:--- Drop all stats providers used only by Twitter and Twitter Http server --- Fix BookKeeper Server packaging, it did not include Netty epoll transport Linux binding (no .so file)--- Adapt license stuff accordingly  --- Drop third party libs needed by Twitter stuff, most notably: Scala runtime and Netty 3.10------### Motivation----Those modules are apparently no more in use and especially they are no more mantained.--It is better to remove them, the code is still on git, but we won't be building it any more or bundling  useless third party libraries in our releases. ----### Changes--- remove twitter stats providers--- remove twitter http server--- adjust LICENSE file for binary distribution (bookkeeper-all)--- fix pom.xml files--- remove -Dtwitter from release files--- remove -Dtwitter from bin/common.sh--- remove other links to Twitter stuff in current documentation ------Master Issue: #<master-issue-number>--------Reviewers: Dave Rusek <dave.rusek@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo--This closes #2232 from eolivelli/fix/drop-twitter-stuff;e7dd19bb52d0654006decb383cb35ffcde928990
Account Apache Thrift and Http Client files in LICENSE files - Fix build on Travis--fixes #2227----Descriptions of the changes in this PR:--- Account Thrift and Http client in LICENSE files.--- Force using Maven 3.6.3 in MacOSx builds on Travis--- Test only with -Dstream profile------### Motivation----Those files are inside the binary packages but they are not taken into account in LICENSE file.--Travis started to report errors when Travis updated Maven version to 3.6.2 in Linux machines, MaxOSx machines are still with 3.3.9 and the build does not bundle all of the needed jars ! ----Master Issue: #2227 --------Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>--This closes #2228 from eolivelli/fix/license-files;2ff7ca5af53f59f2ba11391292016554ace35720
Fixed bin/bookkeeper shell readjournal--### Motivation--An error occurred while executing `bin/bookkeeper shell readjournal`,--![image](https://user-images.githubusercontent.com/42792537/70305222-d80d2300-183e-11ea-8759-88dfcc90b5be.png)-- the journal file name is hexadecimal, but when readjournal is executed, the journal name is resolved in base 10--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo--This closes #2210 from SunDapeng1/branch-2208;2bbf58e0168df000db1712a84acaecf61d00c347
[DOCS] Modify “Using Autoecovery?,recover does not support the specified target bookie--### Motivation --`bin/bookkeeper shell recover` only receives one parameter i.e. failed bookie. According to [recovery](https://bookkeeper.apache.org/docs/latest/admin/autorecovery/#manual-recovery) it is useless to specify ZooKeeper address and target bookie.--![image](https://user-images.githubusercontent.com/42792537/68930100-a3babf80-07c8-11ea-90e1-320cfac1b77b.png)--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2207 from SunDapeng1/branch-2207;9d61fb4fe4fa2c46a25c12f7fb070878b5bda22d
[DOCUMENTATION] Add doc for decommissioning bookie process--### Motivation--Documentation on how to decommission a bookie safely.----### Changes--Added `decommission.md`--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2199 from Ghatage/decomission-documentation;2ca4025e4c699e49c39272a067d8ec6056ca4358
Make 4.9.2 as stable--Descriptions of the changes in this PR:--------### Motivation----4.10.0 has been released, 4.9.2 has been running in production for a while on several known projects. We can mark 4.9.2 as current 'stable' ----### Changes--Update website config.--Fix DLog version.----------Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <None>--This closes #2200 from eolivelli/fix/change-stable-492;62e3b9b6f121c379754abdc76d727e3c53e13bda
Bump Python client version;40f349ccff6840d53b6421fdcbf6c1ed1bb9ca1b
Release notes for 4.10--Please only consider this commit https://github.com/apache/bookkeeper/commit/0d91a95f306031d85c6a8195b0e6d73523cbfc0a as it contains the release notes.--The previous commit is only the preparation for the website.--Reviewers: Sijie Guo--This closes #2165 from eolivelli/fix/release-notes-410;b1991e6b395aabc41305981e32183709b2617cc2
Fix the log level of not support Sse42Crc32C--Signed-off-by: xiaolong.ran <ranxiaolong716gmail.com>----### Motivation----When users are using Apache Pulsar, they will encounter the following error about `Sse42Crc32C`. But in fact it does not affect the correctness of Apache Pulsar use. But the error level log information will cause confusion for the user.--```--10:12:49.119 [pulsar-ordered-OrderedExecutor-0-0-EventThread] ERROR org.apache.bookkeeper.proto.checksum.CRC32CDigestManager - Sse42Crc32C is not supported, will use a slower CRC32C implementation.--```--------### Changes----Replace the log level of `not support Sse42Crc32C` from error to warn.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2198 from wolfstudy/xiaolong/sse42Crc32C;9f4b1359e58fcd9872e895bc8d8ef14b409f86ac
[DOCS] Update coding_guide.md--### Motivation--The link to `OrderedSafeExecutor` does not work.----### Changes--Correct the link to `OrderedExecutor`.--Reviewers: Sijie Guo <None>--This closes #2196 from Jennifer88huang/patch-1;557dfe90f20fbced7459aafd22e7687de07f934a
Add -Dtwitter to fix auto-build--Descriptions of the changes in this PR:--------### Motivation----Make bin/bookkeeper standalone work again----### Changes------Add -Dtwitter in order to activate "Twitter" profile and build Twitter stats providers.----------Reviewers: Sijie Guo <None>--This closes #2195 from eolivelli/fix/add-twitter-common;43f8cd74fea3e97de11f4bd90532e884df375332
Removed mutex contention on BufferedChannel--### Motivation----Contention on `BufferedChannel` between the journal thread and the ForceWriteThread was introduced in #1228.----`unpersistentBytes` is only used if `unpersistedBytesBound > 0`, which is not true by default. We shouldn't be paying the penalty if not needed.----Also `position` doesn't need to be `AtomicLong` since it's only updated while the mutex is taken. Using a volatile will have the same effect with less overhead.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #2187 from merlimat/buffered-channel-contention;f57962bcc5029512a30f7f89a8d1878df6ac4a36
Add -Dtwitter to release scripts in order to build Twitter stats providers--### Motivation----With this commit we disable Twitter providers from default build--https://github.com/apache/bookkeeper/commit/b689d8313654de21759b2e2d47210b75434038c3----This leads to inconsistences during the release process----### Changes----Add -Dtwitter to every release script----------Reviewers: Sijie Guo <None>--This closes #2192 from eolivelli/fix/fix-release-scripts;f5d2e5931a86a436068d40dede2c537f4a619ee5
Fix version in modules that are not active by default;7efa8e89e3ac6fb96fdad277ab65d02e924cd7b8
[maven-release-plugin] prepare for next development iteration;d49b46f4e80f7e62456ed252dcfb9d7c2c957bb7
[maven-release-plugin] prepare branch branch-4.10;5a4213bb0810427ac09d7b47671a42f88b0af97a
Fix firstStoredEntryId logic in LedgerFragment--Descriptions of the changes in this PR:----- firstStoredEntryId logic in LedgerFragment should return '-1'--only if no bookie contains any entry of that LedgerFragment.----This is a serious issue, in our cluster we observed for a particular ledger, which is marked under replicated, it is returning -1 for firstStoredEntryId and 10 for lastStoredEntryId. Because of that the ReplicationWorker, tries to replicate entryId ‘-1’ and as expected it keeps failing while reading it. So ledger remains under replicated for ever.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2180 from reddycharan/fixfirststoredentryidcom and squashes the following commits:--3cb8ae443 [Charan Reddy Guttapalem] change Long to long-9d9db66dd [Charan Reddy Guttapalem] minor log changes-37b025ccb [Charan Reddy Guttapalem] review comments-6e63fbb1e [Charan Reddy Guttapalem] review comments-dbf836b32 [Charan Reddy Guttapalem] Fix firstStoredEntryId logic in LedgerFragment-2978a1a39 [Charan Reddy Guttapalem] Fix firstStoredEntryId logic in LedgerFragment;f8a5974a56cd18a613e16a181c76ab538b0e7ec5
Issue #2145: Make ledgerDirs in Cookie consistent across generating a…--…nd setting----Descriptions of the changes in this PR:----### Motivation----In PR #1794 we brought in a way to generate a cookie from command line.--However during generation, we have to also encode the ledger dirs by default.----### Changes----Added encoding of ledger dir paths while setting the ledger dirs in a generated cookie in `GenerateCookieCommand.java`.--Tweaked existing test to include more than one ledger path for test coverage.----Master Issue: #2145 --Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2146 from Ghatage/community/2145, closes #2145 and squashes the following commits:--2de21f854 [Anup Ghatage] Fix checkstyle-4695675ff [Anup Ghatage] Revert to handling encoding like in generateCookie(), Add another test-90d02136a [Anup Ghatage] Change GenerateCookieCommandTest's to encodeDirPaths while creating cookies-d8da5153a [Anup Ghatage] Issue #2145: Make ledgerDirs in Cookie consistent across generating and setting;8559126a3ec00f2b1912d40d37b8bf8a000b0c4b
[DOC] Improve the Manual deployment document.--### Motivation--Following the [Manual deployment](https://bookkeeper.apache.org/docs/latest/deployment/manual/), startup bookie may have failure since there is no znode(e.g. /ledger) about bookie in zookeeper. ----### Changes----Modify the site/docs/latest/deployment/manual.md, set up cluster metadata before startup of bookie.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2183 from SunDapengcmss/branch-2183;029e8e0e02d8e384e7d08ca548b593368574cf36
Upgrade Apache Parent Pom to 19--Descriptions of the changes in this PR:--Update the reference to the common Apache Parent POM, version 19------### Motivation--Be up to date with ASF-wide configurations----### Changes--Change the version--------Reviewers: Sijie Guo <None>--This closes #2184 from eolivelli/fix/update-apache-parent;798a97eb14da3c00bf73eac14553ab0c06ccca14
Journal scan should throw IOException when it reads negative length--Descriptions of the changes in this PR:----### Motivation----During journal replay, we can encounter negative length value if there is journal corruption. Currently, due to this bug, we pass negative length to limit a buffer, which throws IllegalArgumentException.----### Changes----Updated the Journal class to throw `IOException` with a clear message, instead of unclear `IllegalArgumentException`.----Master Issue: #2176----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #2177 from karanmehta93/master;14c445dae3976ec314ec7d1bac0e2d30a9d0e4c0
Fix logic of areEntriesOfLedgerStoredInTheBookie------Descriptions of the changes in this PR:----- in BookKeeperAdmin.areEntriesOfLedgerStoredInTheBookie method, segmentNum--is not correctly incremented while iterating over the segments of--the ledger. Fixing the logic of it.--- this issue caused decombookie bookieshell command to wait forever.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2186 from reddycharan/fixareledgersstoredcom;4872b1f2bbdb0cdde72ed7922b8de25dc17f58de
[DLOG] LogReader shouldn't be added to pending if not locking--The pendingReaders set in BKDistributedLogManager exists so that if--the manager is closed which the lock is being acquired for a reader,--that reader will be closed (even though it hasn't been returned to the--client).----In the case that the reader is opened without a lock, there--is not async action being performed. Previously we were also adding--these readers to the pendingReaders, but they were never being removed--from the pendingReaders, causing a memory leak. This change avoids--adding no-locking readers to pendingReaders.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2185 from ivankelly/orphan-reader;4f56edf012de8fbf1e33657b390f01fc823aa2c4
Update maven version to 3.6.2 for Jenkins--Descriptions of the changes in this PR:----### Motivation----Update maven version to 3.6.2 for Jenkins build environments, since maven 3.6.0 is no longer available in the environment.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #2181 from karanmehta93/updateMavenVersion;7c24301856fcc502ae2c595195cf48ac62ffe47d
Call exceptionHandler if Bookie.start fails with exception.----Descriptions of the changes in this PR:----When main thread of Bookie/BookieServer has exited with exception while starting Bookie,--Bookie process shouldn't be alive because of any non-daemon thread that has already--started.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Karan Mehta <k.mehta@salesforce.com>--This closes #2173 from reddycharan/fixbookiestartup;114de135f402d2f8de045fb9413e804247841def
Add documentation for ByteBuffer lifecycle when adding entries--Descriptions of the changes in this PR:----Adding documentation for the issue [here](https://github.com/apache/bookkeeper/issues/2138) as discussed [here](https://github.com/apache/bookkeeper/issues/2138#issuecomment-522099668).----Master Issue: #2138 ----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2175 from karanmehta93/master;14c9979047bb4ecd30619a9184e446c2e87fec26
Enhance deferLedgerLockReleaseOfFailedLedger in ReplicationWorker--Descriptions of the changes in this PR:----**Issue:** In the past, ReplicationWorker (RW) retrial logic is enhanced to backoff--replication after threshold number of replication failures of a ledger. This is--to help in a pathological situation where data (ledger/entry) is unavailable.--But this is sub-optimal solution, since there is possibility that each RW can--try recovering a ledger threshold number of times, before a RW defers--ledgerLockRelease. Also each time a RW tries to recover it would read entry/fragment--sequentially and writes to new bookies until it finds a missing entry (completely--unavailable) before failing on replication of that ledger. This is done for--each retrial and it bloats the storage and overreplication need to detect and--delete it, which runs once a day by default. So because of this cluster can--run out of storage space and may become RO cluster. Also this puts quite a bit of--load on cluster in vain.----**So the new proposal is to**--- On each RW. remember the state in addition to the counter. State must include the entries which RW failed to read.--- Counter and state must kept around in each RW node. And exponential backup should be used for deferLedgerLockReleaseOfFailedLedger--- During next attempt by RW, try to read the failed entries which is noted in the state. Read must be successful before proceeding replicating.--- With this model we avoid duplicate copies on each attempt. At the most each RW will create only one copy--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #2166 from reddycharan/enhancereplication;2f996dcf0159f945f7ec97ce7402e5d293009444
Avoid throwing exception when doing EntryLogger.internalReadEntry--### Motivation----In the refactoring part of #1819, the `internalReadEntry()` behavior was changed into throwing an exception when reading an entry from a different ledger. ----This is causing a big performance issue when doing read-head from the ledger storage, because we keep reading from the current entry log until we find an entry from a different ledger. --Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2172 from merlimat/read-internal;1e63d3c83e89d152cb603955e303b5377d8ab8e6
Update bc tests to include versions up to 4.9.x--### Motivation----With backward compatibility tests we should cover the compatibility of current version against old versions, current we are only test current version against ancient releases.----This change supersedes #1648 from sijie ----### Changes----Change the list of versions to test clients and bookie upgrade--------Reviewers: Matteo Merli <mmerli@apache.org>--This closes #2171 from eolivelli/update_bc_tests;6acb63f91136b5c93bc5a30baf4d06cfaf5eacbf
Change Python client version to 4.10.0--According to the release guide, before cutting a release we have to remove the 'alpha' qualifier from Python client version--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #2163 from eolivelli/fix/python-client;7071dac225cb2e4924e4c1e75225e572270a7135
Fix tests and upgrade libs to make tests pass on JDK13--- Upgrade Mockito and PowerMock with a version that support JDK12+--- Fix bash script tests--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #2169 from eolivelli/fix/make-tests-pass-jdk13;cc9d66aa1826f8d583a9b939a9840657877ed275
Make the project buildable with JDK12 and JDK13--Upgrade Lombok to 1.18.10--Upgrade Groovy and Groovy Compiler and Maven Compiler plugin--Fix an inverted if that prevented **bkctl** to work with JDK11+ and it made GC LOGGING opts not applied with JDK8 (in bkctl command), a regression introduced by #2132--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #2160 from eolivelli/fix/build-jdk12;afd8dbadd8a205fe4de4daa9d0c09680effab49d
[BOOKIE] auto refresh tls cert at bookie-server--### Motivation----Right now, if certs are rotated then bookie doesn't pick up refresh cert and we have to restart the bookie. So, we need a way to auto refresh certs into bookie.----### Modification----- add configuration `tlsCertFilesRefreshDurationSeconds` to auto refresh cert--- bookie checks last modified date of the cert after auto-refresh duration and refresh certs if requires----### Result----- Bookie can refresh certs without restart.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2154 from rdhabalia/auto_mtls;4c6cf097d9b823c8e839e176a06266a58bcb7bf5
Issue #2152: Amend disk usage warn log--### Motivation----Fixes #2152----### Changes----Replace `diskUsageThreshold` by `diskUsageWarnThreshold` when disk usage threshold doesn't trigger first.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2153 from murong00/branch-2153, closes #2152;4487cee4f14bd495a9b02071e0bdd0fc7df0dbf6
Improve journal throughput when journalSyncData is disabled.--Descriptions of the changes in this PR:----### Motivation----There was a weird behavior observed: when `journalSyncData` is disabled, the journal throughput decreased with multiple journal dirs on same journal disk.----The problem is when `journalSyncData` is disabled, we still sync data to disk when rolling the journal file. The sync time increases to multiple seconds, because it has to flush all the files to disk and wait the whole sync operation to be completed.----### Changes----when `journalSyncData` is disabled, we trigger callbacks when the data is flushed to filesystem but still enqueue a fsync request to force write queue to make sure we still fsync data frequently.----Also added a journal perf tool to do performance testing on journal.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #2150 from sijie/journal_perf;171e2f914c05357d9e81c7e951f5c86a0f463a75
Journal should respect to `flushWhenQueueEmpty` setting----Descriptions of the changes in this PR:----*Motivation*----Currently journal doesn't respect to `flushWhenQueueEmpty` setting.--Even `flushWhenQueueEmpty` is set to false, we can still see flushes--triggered due to queue empty.----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #2147 from sijie/fix_flush_when_empty;f1df81f6590e048b93ec21776f931a28f0468a45
Simplify if statements--### Changes----* Simplify `if` statements where it is possible (mainly for `if` statements returning boolean values)--* Remove redundant semicolons--* Remove the `close` method where the resource is used withing the try-with-resources block--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2137 from vzhikserg/simplify-if-statements;9e34c9a7e75b87441c2455139a715e39ff985f43
Replicascheck comprehensive testcases.----Descriptions of the changes in this PR:----- adding comprehensive testcases for newly added--scrutiny - replicasCheck.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2141 from reddycharan/replicaschecktest;9540d8473ebbe49425ece1088047cd544e8427f9
Replace C style array declaration with Java style--### Motivation----The C style array definitions look weird for a Java developer.----### Changes----All C style array declarations were updated with the Java array declarations and the stylechecker rule was added to enforce the Java way. --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2139 from vzhikserg/replace-c-style-array-declaration-with-java-style;0034fe684136e318d1a7e8b384968d703d2dd8c4
Remove redundant array creation--### Changes----Remove redundant array creation in log statements to simplify the code.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2129 from vzhikserg/remove-redundant-array-creation;1df8ae9abd2069d7db7f5551ec7cb1de1b9e3bae
Make default Bookie scripts work on JDK11+--- detect new Java versions in bin/common.sh--- use different defaults on JDK8 vs JDK11+----Descriptions of the changes in this PR:--Change distribution scripts in order to detect a JDK newer then JDK8 and set default JVM options accordingly.----### Motivation----Because I want that BookKeeper tools run out of the box with JDK11----### Changes--1) detect a JDK newer then JDK8, but checking if exists $JAVA_HOME/bin/jshell (this is quite robust, better then parsing some Java version string)--2) use new defaults for JDK11, in particular do not enable experimental and deprecated options, use the new [Java Unified Logging](https://openjdk.java.net/jeps/158) log system for GC----Please note the output of "Java Unified Logging" is very different from the old pre-Java9 one and --options are different, there is no simple port.----Master Issue: #1912--------Reviewers: Sijie Guo <None>--This closes #2132 from eolivelli/fix/run-jdk11;1ff4438858df888141a31e4049ba8ad845c9cc10
Issue #2127: Allow user override default SASL service name bookkeeper--Descriptions of the changes in this PR:--default SASL service name "bookkeeper" can be override by JVM property "bookkeeper.sasl.servicename"----### Motivation--------### Changes----Instead of use a constant value, it would read from JVM property first, if it doesn't exists, then use default value from constant variable SaslConstants.SASL_BOOKKEEPER_PROTOCOL----Master Issue: #2127--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo--This closes #2128 from 29x10/master, closes #2127;60ff4ec791f94362eee9aecc67670cbdbf2b2ee6
Upgrade to latest Maven version 3.6.1--### Motivation--- ASF CI does not support Maven 3.5.0--- Maven 3.5.0 is a very old version----### Changes----- update Jenkins DSL files to "Maven (latest)"--- update release procedure to Maven 3.6.1--- update docker based dev environment to use Maven 3.6.1 + jdk11 (it was 3.5.0 + legacy jdk9)----------Reviewers: Sijie Guo <sijie@apache.org>--This closes #2135 from eolivelli/fix/upgrade-maven;832853d7c156e3ea76add272627082a4eb653ef0
Issue #2130 : Fix for broken URLs--Fixed broken URLs in README for Programmer Guide, Tutorial and Java API.----Descriptions of the changes in this PR:----Updated the URLs.----### Motivation--Wanted to go through the tutorial when I came to the repo and found the links were broken in the README.--### Changes------Master Issue: #2130----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2131 from pavankumarchaitanya/master, closes #2130;38e0c2d3ccc1a3f31c6c1f47c5ab059962eb1a8b
Make build pass on JDK11, fix javadoc configuration----Descriptions of the changes in this PR:----### Motivation----Build fails on recent JDK11 versions and on JDK11, see #2133, this is because javadoc has problems with references to core Java API when source version is set to 8.----### Changes--Upgrade Java doc plugin to latest 3.1.1 and disable auto linking to core Java classes with--`<detectJavaApiLink>false</detectJavaApiLink>--`--Closes #2133--------Reviewers: Sijie Guo <None>--This closes #2134 from eolivelli/fix/javadoc-jdk11;5311e00f399ae3b5cb39fe03d8b5dd8c0547de14
Implementation of new scrutiny - replicas check (Part-1)--Descriptions of the changes in this PR:----- this is implementation of scrutiny mentioned in--https://github.com/apache/bookkeeper/blob/master/site/bps/BP-34-cluster-metadata-checker.md--- In this commit, urLedgersElapsedRecoveryGracePeriod check is added to placementPolicyCheck.--- new scrutiny is added replicasCheck and it is disabled by default.--- this is first part of replicas check, in this part currently metrics are not added and--also delayed replicas check for potentially faulty ledgers (failure in trying to get--info. from Bookie of the ensembles of the ledger) is not added.--- have to add more failure test scenarios for replicas check logic.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <None>--This closes #2120 from reddycharan/replicascheck and squashes the following commits:--d4dc81e15 [Sijie Guo] Merge remote-tracking branch 'apache/master' into replicascheck-5a3fa848f [Matteo Minardi] Issue #2124: Test 'ListBookiesCommand ' is failing-df24f672a [vzhikserg] Use bulk operation instead of iteration-2a1cfe249 [vzhikserg] Fix log statements with incorrect placeholders;86e8a72c7fcfb38b76bcbf434df586f3dc00a2af
Issue #2124: Test 'ListBookiesCommand ' is failing--Introduced and fixed the tests involving the ListBookiesCommand------Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>--This closes #2125 from mino181295/fix/test-cmd-list, closes #2124;5a3fa848f1817d447446f8250de559d631b81487
Use bulk operation instead of iteration--### Changes----* Use the `addAll` method instead of iteration--Reviewers: Sijie Guo <None>--This closes #2122 from vzhikserg/bulk-call-instead-of-iteration;df24f672ae7d0f9503980cd0a8f782470f6e663b
Fix log statements with incorrect placeholders--### Changes----The following changes were made:----- remove unused placeholders in the log statements--- add missing placeholders to the log strings to show the complete information--- remove unnecessary initialization of object arrays in the log statements --Reviewers: Sijie Guo <None>--This closes #2123 from vzhikserg/fix-log-statements;2a1cfe249830f8dee0570031c8d0c132c32fe24e
[CI] Prune networks older than 12h--Previously we were using a filter which matched on the network name of--the networks we create. However, docker seems to have removed this--functionality, so now we just prune all unused networks which are more--than 12h old (no CI job should be taking more than 12h).----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2126 from ivankelly/ci-failure;b182b7478687328126a6aced27d5359fdf280e5c
Website update for 4.9.2 release--Added 4.9.2 release to website--Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <None>--This closes #2098 from merlimat/master;eecb259de2ac2d2995aab0aa29263529a69a698d
Issue #1961: Included ZooKeeper client AclId.--Descriptions of the changes in this PR:--Included ZooKeeper Acl to the builder.----### Changes----It is now possible to unbind DistributedLog namesapaces.----Master Issue: #1961-----Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <None>--This closes #2118 from hugomiguelabreu/master, closes #1961;ecf1c715f88feb8bcaf08b9063f774b0443f7ead
Issue #2103: Avoid stop of entry log compaction--### Motivation----As mentioned in #2103, if an exception occurs during compaction of a specific entry log, `GarbageCollectorThread` does not perform compaction of other entry logs until the bookie server is restarted. As a result, the number of entry logs continues to increase and eventually it will run out of disk space.----### Changes----The cause of the compaction stop is that the `compacting` flag remains true if `compactor.compact(entryLogMeta)` throws some exception.--https://github.com/apache/bookkeeper/blob/b2e099bbc7b13f13825fe78ab009ca132cb3a9ba/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/GarbageCollectorThread.java#L504-L519----Therefore, fixed `GarbageCollectorThread` so that it set the compaction flag to false even if compaction of a specific entry log fails.----Master Issue: #2103--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2121 from massakam/entry-log-compaction, closes #2103;1adc93f05954fdb06d7e8b548d606e281831924a
[BK-SERVER] Clean up over-replicated ledgers owned by different bookies--### Motivation--As described at: https://github.com/apache/pulsar/issues/4632--- Sometimes due to overreplication, bookie contains ledgers which are not owned by that bookie anymore and that bookie is not part of the ensemble-list of those ledgers. In this case, GC finds out those overreplicated ledgers and --- deletes their index from dbStorage (rocksDB) and --- tries to delete them from entrylog files.----However, bookie doesn't delete them from entry-log files due to change made in [#870](https://github.com/apache/bookkeeper/issues/870) where bookie avoids deleting ledger if znode of that ledger exists.----Because of that bookie ends up storing large number entrylog files with ledgers which are owned by different bookies. It also cause OOM when GC tries to deal with large number of entry log files.----### Modification----Delete the ledgers if bookie is not part of ensemble list of over-replicated ledgers--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2119 from rdhabalia/overRepl;6b892a45f02a6d8d0b1d33235d4134d91e3ea111
Implement a method to get all the Bookies--In this PR I'm adding a `BokKeeperAdmin#getAllBookies` to retrive all the bookies (cookie) retriving them from the `RegistrationClient`----This is still a work in progress, I'm adding some tests in the next commit.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2117 from mino181295/allbookies;762a61365408d81a20193ef4ae1d44394746c105
Implementation of ZoneawareEnsemblePlacementPolicy----Descriptions of the changes in this PR:----Implementation of ZoneawareEnsemblePlacementPolicy----- This is meant to be used in public cloud infrastructure in which--Availability zones (AZs) are isolated locations within data center--regions from which public cloud services originate and operate.--- ZoneawareEnsemblePlacementPolicy is a placement policy implementation--which uses zone information for placing ensembles.--- In this PlacementPolicy, it is assumed the networktopology/networklocation-- is going to be two level tree, where first part indicates zoneid--and the second part indicates upgradedomainid.--- Here upgrade domain is a set of bookies in an AZ that can be brought--down together for short term maintenance with no impact to the service.--This would help in enabling parallel patching.--- Upgrade domain is a logic concept/division and it may be mapped to--cloud provider native cluster/grouping like Placement Groups in AWS.----Introduce soft PlacementPolicyAdherence----- for ZoneawarePlacementPolicy if in a writeset the number--of zones are in between minnumofzones and desirednumofzones--then it is considered MEETS_SOFT.--- if all of the writesets have zones >= desirednumofzones--then it is considered MEETS_STRICT--- if a writeset contains < minnumofzones then it is considered--FAIL--- add corresponding metric for PlacementPolicyAdherence.MEETS_SOFT----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #2113 from reddycharan/zoneawareplacementpolicycommunitybranch;b34162a932b93a7e65451dce3f6e10bfda707997
Added zookeeper host configuration. Closes #1960--Descriptions of the changes in this PR:--Added host IP binding to sandbox.----### Motivation--Allowing running the sandbox inside guest machines and be accessible by all system (including other guest machines). When binding 127.0.0.1 other guest machines will experience an error. By allowing to bind the correct IP the namespace will be available and correctly configured for other hosts.----### Changes--Added a new argument to the _dlog_ tool allowing to define the host IP to bind ZooKeeper and DistributedLog namespace.----Master Issue: #1960--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2081 from hugomiguelabreu/master, closes #1960;54ce17312f53c9b2a1ac3ea83303a7bebebc0a31
Issue #1970: Ensure getStickyReadBookieIndex returns valid bookie index--Descriptions of the changes in this PR:----Master Issue: #1970--Related Issues: apache/pulsar#3715 apache/pulsar#4526----*Motivation*----Fixes #1970----By default bookie uses a random generator to generate a bookie index as the sticky--read bookie index. However the random generator will generate negative numbers. Hence--it will generate negative bookie indexes in write set and cause ArrayIndexOutOfBoundException--when bookkeeper attempts to read entries.----*Modifications*----Make sure getStickyReadBookieIndex not return negative number.----*Verify this change*----This problem introduced by a random generator. It is very hard to write a unit test to reproduce this issue.--Existing StickyRead tests are good to cover this code change.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Yong Zhang <zhangyong1025.zy@gmail.com>--This closes #2111 from sijie/fix_sticky_read, closes #1970;96fc2e2aac4d026fe336ae8347521d9910165dd5
[DLOG] Delete empty inprogress segment on recovery--This addresses an issue, whereby if a user is using getLastTxId() to--find the first txnid when starting to write, they will continue to be--able to write if the last segment written by the previous writer was--empty. If the last segment was empty, then the maxTxId would be higher--than the result of getLastTxId(). maxTxId is read from a znode, while--getLastTxId() reads the txid of the last persisted record. In the case--of an empty inprogress segment, the maxTxId znode was being updated--with the expected first transaction id of the segment.----This patch addresses the issue with the following changes:--1. The maxTxId znode is only updated when inprogress segment is--   completed, so it's value always refers to a transaction that--   exists.--2. On recovery, if the inprogress segment is empty, delete it. There--   was a TODO comment to do this already there.--3. When generating the sequence number, allow a potential sequence--   number which is equal to the current max sequence number, as this--   can be the case where recovery deleted an inprogress empty segment.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2099 from ivankelly/txnid-issue;533dd5d6e9d3ac9b24d2462f6ae4d4240a4bffdf
Use https for Twitter maven repo--### Motivation----Fetch the maven dependencies through HTTPs --Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2100 from merlimat/merlimat-patch-1;f719fb002b6f4f1d73c944e7d3a39d39f79b581c
Testcase for limitStatsLogging.------Descriptions of the changes in this PR:----bd2b16e880d172d4761461fdbf85c1bd19b24e36 had introduced--'limitStatsLogging' feature, which would be used to limit statslogging,--where it is needed. eg - we would like to suppress logs from PCBC--in Auditor/ReplicationWorker process.----In this commit I'm adding testcases for this feature.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2109 from reddycharan/testlimitstatslogging;6820f890343e51a6b2b1c9544b90dc1c6ca40dea
Bring back statslogger to BookKeeper client in ReplicationWorker process.----Descriptions of the changes in this PR:----bd2b16e880d172d4761461fdbf85c1bd19b24e36 is supposed to fix this issue,--but it missed passing statsLogger to createBookKeeperClient method.----For more info. check desc. of bd2b16e880d172d4761461fdbf85c1bd19b24e36.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2108 from reddycharan/enablebookieclientlogger;be3bdd0fa20f818158c25f6b59fcfc89d82c4734
Display filesystem and docker info for all jenkins runs--Descriptions of the changes in this PR:----Changes to shell commands in few scripts----### Motivation----It was difficult to reproduce jenkins test failures locally and the cause might be due to differences in underlying file system. These commands will output more information to spot the exact differences.----### Changes----Running `df` command with an additional `-T` parameter to output filesystem information--Added `docker info` command to print docker details before every test run------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2107 from karanmehta93/master;839cf3c09add5ed0c33980adbdfced3bb83bba4d
Update distributedlog library to use NoSuchLedgerExistsOnMetadataServer--*Motivation*----Issue #2066 introduced `NoSuchLedgerExistsOnMetadataServer`. But the distributedlog--library is not updated to reflect to this change.----*Modifications*----Change to use `NoSuchLedgerExistsOnMetadataServer` in the right place.--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2102 from sijie/fix_failure_test;fb8b58e9dff3fcdb30cf8faabff442d683922232
ISSUE #1927: fix NoNodeException in LocalBookeeper--### Motivation--It addresses #1927 where it provides a conf check at the beginning of startLocalBookiesInternal function.--### Changes----- Add a conf check at the beginning of startLocalBookiesInternal function where non-default zkLedgersRootPath is not allowed.----cc sijie --Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2082 from zhaohaidao/master, closes #1927;4fe353425ef6e6df1a04cd1be541139881abae9b
Entries must be acknowledged by bookies in multiple fault domains before being acknowledged to client--Descriptions of the changes in this PR:----Bookkeeper write logic makes sure that there are at least ackQuorumSize--number of successful writes before sending ack back to the client. In--many cases these may fall into the same fault domain. A mechanism to--force bookkeeper to make sure that there are acks from at least--minNumRacksPerWriteQuorum number of fault domains and a configuration--to enforce this.----Signed-off-by: Ankit Jain <jain.asalesforce.com>----Master Issue: #2095 --Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2096 from ankit-j/ankit-j/enforceFragmentMultipleFaultDomainWrite and squashes the following commits:--c90fd5a3d [Ankit Jain] Addressing review comments-07deae673 [Ankit Jain] Addressing @reddycharan's review comments-14164e291 [Ankit Jain] Fixed spacing error in bk_server.yaml-22c8b3c03 [Ankit Jain] Updated testing.-917ed1c45 [Ankit Jain] Move readLock.unlock to finally block-78e0cd501 [Ankit Jain] Modify test to not use default rack for bookies-ca0bc3b8b [Ankit Jain] Entries must be acknowledged by bookies in multiple fault domains before being acknowledged to client-d35aa22ad [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.;b88f4b813f5ee5846b4879972e2c8359ac0eb4f2
Update lastLogMark to EOF when replaying journal--Descriptions of the changes in this PR:----### Motivation-- --The [commit](https://github.com/apache/bookkeeper/commit/36be8362399341022c8de64f9319270726df2cb3) caused integration test failure `test101_RegenerateIndex`, with the exception--```--```java.io.IOException: Invalid argument--    at sun.nio.ch.FileDispatcherImpl.read0(Native Method)--    at sun.nio.ch.FileDispatcherImpl.read(FileDispatcherImpl.java:46)--    at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)--    at sun.nio.ch.IOUtil.read(IOUtil.java:197)--    at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:159)--    at org.apache.bookkeeper.bookie.JournalChannel.read(JournalChannel.java:257)--    at org.apache.bookkeeper.bookie.Journal.fullRead(Journal.java:1171)--    at org.apache.bookkeeper.bookie.Journal.scanJournal(Journal.java:792)--    at org.apache.bookkeeper.bookie.Bookie.replay(Bookie.java:924)--    at org.apache.bookkeeper.bookie.Bookie.readJournal(Bookie.java:886)--    at org.apache.bookkeeper.bookie.Bookie.start(Bookie.java:943)--    at org.apache.bookkeeper.proto.BookieServer.start(BookieServer.java:141)--    at org.apache.bookkeeper.server.service.BookieService.doStart(BookieService.java:58)--    at org.apache.bookkeeper.common.component.AbstractLifecycleComponent.start(AbstractLifecycleComponent.java:78)--    at org.apache.bookkeeper.common.component.LifecycleComponentStack.lambda$start$2(LifecycleComponentStack.java:113)--    at com.google.common.collect.ImmutableList.forEach(ImmutableList.java:408)--    at org.apache.bookkeeper.common.component.LifecycleComponentStack.start(LifecycleComponentStack.java:113)--    at org.apache.bookkeeper.common.component.ComponentStarter.startComponent(ComponentStarter.java:80)--    at org.apache.bookkeeper.server.Main.doMain(Main.java:229)--    at org.apache.bookkeeper.server.Main.main(Main.java:203)--```----As discussed on slack, it is hard to figure out an exact reason as to why the native JNI call fails with an invalid argument. Hence this PR proposes that the `lastLogMark` is updated to journal EOF instead of an arbitrary LONG.MAX_VALUE. The FileChannel interface defines that the implementors can pass in any long offset and the file handler should return EOF immediately when trying to read it. However it doesn't seem to be working as expected.----### Changes----Updated `Journal#setLastLogMark()` method to accept an `scanOffset` instead of constant `LONG.MAX_VALUE`.----ivankelly eolivelli --Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2105 from karanmehta93/master;f89e3fbb751fbef7012e695ed5873eade13ba4f5
Fix flaky testIOVertexHTTPServerEndpointForARWithPrometheusProvider test--Descriptions of the changes in this PR:----- in testIOVertexHTTPServerEndpointForARWithPrometheusProvider test--it is not correct to assume that Auditor would have been created and--started completely when we complete AutoRecoveryMain.start and see it--status as started. It would make sure AuditorElector.submitElectionTask--has submitted election task but not the completion of Auditor.start.--So instead of relying on Auditor metric (NUM_UNDER_REPLICATED_LEDGERS),--use ReplicationWorker metric - NUM_FULL_OR_PARTIAL_LEDGERS_REPLICATED.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2093 from reddycharan/fixflakytest;26e8004e6b93f5acaff7f69dba14511a7cf44d58
Fallback to use v3 protocol for some types of requests if they are not implemented in v2--Descriptions of the changes in this PR:----### Motivation----#2071 ----### Changes----- Add a client pool use v3 wire protocol--- Obtain client by version--- Currently only support `writeLac` and `readLac`----Master Issue: #2071 --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2085 from zymap/compatible_protocol;dba831375ad0f10821c04258fb08f70cce3f4b67
[SITE] modify nettyMaxFrameSizeBytes Description--Descriptions of the changes in this PR:----Fixes #2079----### Motivation--when the client-side attempt to send more than the default size bytes, it should set up the corresponding parameter `setNettyMaxFrameSizeBytes(int maxSize)`----(Explain: why you're making that change, what is the problem you're trying to solve)----Master Issue: #2079 --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2086 from hellozepp/issue-2079;7fbd3620a09852e5ac7a4c206bcf2d070151db03
Update and flush lastLogMark when replaying journal--Descriptions of the changes in this PR:----Update `lastLogMark` in memory after replaying each journal--Check for writable ledger dirs with `minUsableSizeForEntryLogCreation` to flush the `lastMark` file for bookies in ReadOnlyMode--Log line changes----### Motivation----Master Issue: #2087 ----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #2090 from karanmehta93/master and squashes the following commits:--f802cf6da [Karan Mehta] Fixed small issue in constuctor chaining in BookKeeperClusterTestCase-407e9f1ff [Karan Mehta] Moved lastLogMark updation logic to Journal.java-585313196 [Karan Mehta] Fix checkstyle errors-c3d47014a [Karan Mehta] Fix testJournalLogAddEntryCalledCorrectly test-c72b7b55e [Karan Mehta] Addressed nit-5d238f2b7 [Karan Mehta] Refactored code to update lastLogMark only when replaying journal and addressed nits-b5515697f [Karan Mehta] Issue #2087 Update and flush lastLogMark when replaying journal-d35aa22ad [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.;36be8362399341022c8de64f9319270726df2cb3
[BK-CLIENT] Check empty ledger-parent node while deleting ledger--### Motivation----As discussed at [#4276](https://github.com/apache/pulsar/issues/4276), while deleting ledger, bk-client should check parent node is empty before issuing delete request for parent znode.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #2097 from rdhabalia/led_del and squashes the following commits:--f5c0ca36c [rdhabalia] return callback with ok-ede5e9403 [rdhabalia] [Bk-Client] Check empty ledger-parent node while deleting ledger-d35aa22ad [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.-b4ca4537b [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.-aa84c7fdd [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation-10859afb7 [Matteo Merli] Added HTTP handler to expose bookie state-707ae5c85 [karanmehta93] ISSUE #2075: Bookieshell lastmark command isn't functional, always returning 0-0-41b39c6ef [Charan Reddy Guttapalem] ISSUE #1967: make ledger creation and removal robust to zk connectionloss-973d2ab0d [Matteo Merli] Use pure python implementation of MurmurHash-9bb7e4b82 [Venkateswararao Jujjuri (JV)] Explicit error message if extent is not present on ZK (#2066)-bd699e61d [mtang01] ISSUE #2067: reduce byte[] allocation in add entry-7c62e1232 [karanmehta93] ISSUE #2073: ReadOnlyBookieTest#testBookieContinueWritingIfMulti…-42e77802c [Ivan Kelly] DLog Namespace#openLog should declare LogNotFoundException-86bce12b5 [Yong Zhang] Migrate command `ledgermetadata`-407cb35e5 [Charan Reddy Guttapalem] ISSUE #1967: make ledger creation and removal robust to zk connectionloss-eaa601404 [Like] Support asynchronous fence request for V2 ReadEntryProcessor-d23b45ec8 [Ivan Kelly] Fix typo in overview page for 4.8.2-44ee320b6 [Ivan Kelly] k-316b71923 [Ivan Kelly] Wait for LAC update even if ledger fenced-066621507 [Yong Zhang] Migrate command `updatecookie`-6f3396801 [Yong Zhang] Migrate command `triggeraudit`-60d993edf [Yong Zhang] Migrate command `autorecovery`-ed008f278 [Yong Zhang] Migrate command `whoisauditor`-5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`-90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`-848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation-06f2b6f50 [Yong Zhang] Migrate command `updateledgers`-7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`-d4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed-5c150f283 [Enrico Olivelli] Release notes for 4.9.1-1246826ba [Yong Zhang] Migrate command `recover`-1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`-67f83620e [Yong Zhang] Migrate command `readledger`-bfbd6b023 [Yong Zhang] Migrate command `decommission`-d40b8b69f [Yong Zhang] Migrate command `readlog`-95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`-e2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`-0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool-6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`-c391fe58d [Yong Zhang] Migrate command `readlogmetadata`-120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`-bf66235e5 [Yong Zhang] Migrate command `deleteledger`-751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time-138a7ae85 [Yong Zhang] Migrate command `metadataformat`-b043d1694 [Yong Zhang] Migrate command `listledgers`-4573285db [Ivan Kelly] Docker autobuild hook-e3d807a32 [Like] Fix IDE complain as there are multi choices for error code-9524a9f4a [Yong Zhang] Migrate command `readjournal`-6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed-e35a108c7 [Like] Fix error message for unrecognized number-of-bookies-5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null-6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2-1448d12aa [Yong Zhang] Migrate command `listfilesondisk`-4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`-468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty-f26a4cae0 [Ivan Kelly] Release notes for v4.8.2-ec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`-8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`-fa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl;335c2aba9bfd24eff224f1afae393026c17a2d5a
Added release notes for release 4.9.2--### Motivation----Release notes for patch release --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2088 from merlimat/relnotes-4.9.2;2ff26d69e400d16f533f424c6e95f2f30189e183
[BK-GC] avoid blocking call in gc-thread--### Motivation----Right now, we have below 3 issues because of which gc thread gets blocked forever and it can't perform gc-task further. Below issues are mainly related to blocking call while doing zk-operation without timeout. ----bug-fixes:--1. right now, [GC - ScanAndCompareGarbageCollector](https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/ScanAndCompareGarbageCollector.java#L142) passes timeout in millisecond to [LedgerManager](https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/LongHierarchicalLedgerManager.java#L166) but it --takes it as second and again try to convert it in millis so, 30Kms timeout becomes [30M ms timeout](https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java#L245). Sp, fix timeout unit during gc.----2. Right now, GC makes blocking call to get list of children on ledger znode and sometime zk-call back doesn't comeback which blocks the gc-thread forever. However, recently we added the timeout on the [object-waiting-lock](https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java#L243-L248) which doesn't work because it's in while loop and `object.wait(timeout)` completes without any exception and GC threads keep running in while loop.----3. add zk-timeout during delete ledgers in bookie else it can also block the GC thread.------------### Changes----add timeout while bk-gc makes zk-call to verify deleted ledgers.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Rajan Dhabalia <rdhabalia@apache.org>--This closes #1940 from rdhabalia/verify_gc;f5ddc36cc30c5bab5d2e8ebc5fa552c2ad0d6eea
Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.----Descriptions of the changes in this PR:----- Moving components/methods which are common in nature with respect to--placementpolicy from RackawareEnsemblePlacementPolicyImpl to--TopologyAwareEnsemblePlacementPolicy, so that any new placementpolicy--implementation can extend TopologyAwareEnsemblePlacementPolicy and reuse--those common components/generic.--- Change signature of methods of RackChangeNotifier interface.--- Delete duplicate methods in RackawareEnsemblePlacementPolicyImpl and--TopologyAwareEnsemblePlacementPolicy (missed removing them in #2089)--- Created separate class for BookieNode--- This change has no functionality change, it is just reorganizing code.----Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #2092 from reddycharan/placementpolicyrefactoring;d35aa22ade87969a4f8e932d925c5d134feb764b
Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.--Descriptions of the changes in this PR:----- Moving components/methods which are common in nature with respect to--placementpolicy from RackawareEnsemblePlacementPolicyImpl to--TopologyAwareEnsemblePlacementPolicy, so that any new placementpolicy--implementation can extend TopologyAwareEnsemblePlacementPolicy and reuse--those common components/generic.--- This change has no functionality change, it is just reorganizing code.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2089 from reddycharan/3azplacement;b4ca4537b62e75f71e3329186652f982025175a2
GetListOfEntriesOfLedger implementation----Descriptions of the changes in this PR:----As described in this BP - https://github.com/apache/bookkeeper/blob/master/site/bps/BP-34-cluster-metadata-checker.md, this request returns list of entries bookie contains for the given ledger in an encoded format. The returned list provides weakly consistent state, of the entries of the ledger.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1931 from reddycharan/getlistofentries and squashes the following commits:--467bb8b73 [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation-757f99156 [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation-4e84bcba0 [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation-f5655bb29 [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation;aa84c7fdd24a925f57f087670b205a35fb8ef237
Added HTTP handler to expose bookie state--### Motivation----Allow to check the state of the bookie through HTTP.----The main reason is to allow light-weight probes that can be run frequently to establish whether the bookie is running and meets a minimum readiness criteria. One example is to automatically wait until the bookie has completed the startup sequence.----### Changes----Added new HTTP handler that exposes the values from the bookie `StateManager`. --Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1995 from merlimat/bookie-state;10859afb7e8f2ee095e70f4e5482959bb5a3067a
ISSUE #2075: Bookieshell lastmark command isn't functional, always returning 0-0--Descriptions of the changes in this PR:--------### Motivation----`lastmark` shell command is to be used while debugging however currently it cannot be used since it returns incorrect value.----### Changes----Updated `LedgerDirsManager` object initialization to use correct `ledgerDirs`.--Master Issue: #2075--------Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2076 from karanmehta93/ISSUE-2075, closes #2075;707ae5c8536f967c0369f951d6178670c5dd031d
ISSUE #1967: make ledger creation and removal robust to zk connectionloss----- fix test failures in TestLedgerMetadataSerDe----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2070 from reddycharan/fixzktestfailures, closes #1967;41b39c6eff249729a698838e880ad77cc0c18c67
Use pure python implementation of MurmurHash--### Motivation----BK table python client is depending on `mmh3` library for MurmurHash. This library wraps a C based function but there are no binaries published on PyPI. Therefore users need to have a GCC installed in order to install the BK client lib, since it compiles it at install time. GCC is typically not available in Docker containers.----### Modifications----Include a pure python implementation of MurmurHash to use if the C based is not found. ----Notes:-- * I couldn't find any published pure-python MurmurHash implementations on PyPI-- * Importing public-domain code is permitted by ASF------Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #2069 from merlimat/mmh3;973d2ab0da91e5a24b1d30990ca6bb1484f07f7e
Explicit error message if extent is not present on ZK (#2066)--* Explicit error message if extent is not present on ZK----Client can get no extent error in the following two scenarios.--1. When client attempted to read/open an extent that--   is not on ZK (metadata server)--2. When client attempted to read a Ledger which is on metadata--   server, but somehow missing on bookies (Data server)----It is quite confusing to get the same error, NoSuchLedgerExists--for both these cases. This checkin introduced a new error at the--BookKeeper client level, NoSuchLedgerExistsOnMetadataServer if--it is not available on ZK.----For errors related to Ledger is not available on bookie,--I left NoSuchLedgerExists as-is(instead of changing it to--NoSuchLedgerExistsOnDataServer) to minimize code changes.----This change alone provides enough distinction between these--two types of errors.----Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjuri@salesforce.com>----* Checkstyle fixes----* Some more fixes----* Fixing DL test fixes;9bb7e4b8245507ce1aefc9ff9a316c1407016240
ISSUE #2067: reduce byte[] allocation in add entry--Descriptions of the changes in this PR:--This change removes a byte[] copy in DigestManager digest calculation--(computeDigestAndPackageForSending)--that puts crc header and payload in a continuous buffer. Instead,--it uses protobuf ByteString.concat to concatenate header and payload--without copy when building protobuf message.----------### Motivation----In add entry code path, I see lots of byte[] allocated to do digest calculation.  It's possible to not allocate byte[]. ----### Changes----Don't allocate a ByteBuf to copy data. Keep header and data separate, but use ByteString.concat when construct protobuf message.----Master Issue: #2067 --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2068 from mtang01/add_entry_mem, closes #2067;bd699e61d729f327b5de302089d11bc3dcadfeb8
ISSUE #2073: ReadOnlyBookieTest#testBookieContinueWritingIfMulti…--…pleLedgersPresent is flaky----Descriptions of the changes in this PR:----Updated the test to use random port number for bookie startup instead of predefined one.----### Motivation----ReadOnlyBookieTest#testBookieContinueWritingIfMultipleLedgersPresent test is flaky due to this reason.----### Changes----(Describe: what changes you have made)----Master Issue: #2073 --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2074 from karanmehta93/master, closes #2073;7c62e1232cf8063d3b0f0dc59978da69710602b5
DLog Namespace#openLog should declare LogNotFoundException--Other methods such as delete do, so openLog should declare it to be--consistent and to give users a hint that it can be caught.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #2072 from ivankelly/dl-openlog-ex;42e77802c025964d826c3b57e8f18c4bc464c481
Migrate command `ledgermetadata`--Descriptions of the changes in this PR:----Using `bkctl` run command `ledgermetadata`----### Motivation----#2018 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2019 from zymap/command-ledgermetadata;86bce12b58f997430f87771abb95854ee41a7248
ISSUE #1967: make ledger creation and removal robust to zk connectionloss----Descriptions of the changes in this PR:----The bookkeeper project ZooKeeperClient wrapper for the ZooKeeper client--will resend zk node creations and removals upon reconnect after a--ConnectionLoss event. In the event that the original succeeded, the--resent operation will erroneously return LedgerExistException or--NoSuchLedgerExistsException for creation and removal respectively.----For removal, this patch limits the operation by allowing it to always--succeed if the ledger does not exist in order to make it idempotent.--This is appears to be the simplest solution as exclusive removal isn't--important.----**Note, the above is an actual change to the bk client semantics**----For creation, exclusive creation is cleary important for correctness,--so this patch adds a creator token field to the LedgerMetdata to--disambiguate the above race from a real race. For--AbstractZkLedgerManager, this is simply a random long value.----There's an oportunity for optimization with the above if exclusive--ledger creation failures are expected to be common.  You only actually--need to perform this check if the operation was really resent.  I chose--not to go this route yet because it would require messing with the--ZooKeeperClient interface to surface that information without burdening--other callers.----If the client is set to version 2 or older, this field will be ignored--and the old behavior will be retained.  If the client is version 3 or--newer but creation races with an older client, the new client will--interpret the nonce to be BLANK and thereby detect the race correctly.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2006 from reddycharan/zkretrialrobust, closes #1967;407cb35e594e2334ae687f7c884651c7642349fa
Support asynchronous fence request for V2 ReadEntryProcessor--Currently, the ```ReadEntryProcessor``` v2 does not support asynchronous fence request, which wait for 1000 milliseconds to wait it done if it's a fencing request. This pull request attempt to support asynchronous response if a thread pool is provided. ----Closes #283--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2021 from liketic/refactor;eaa6014049e6bc8253f5b0282e4ace8a3aff92e2
Fix typo in overview page for 4.8.2--The release notes link text was saying the latest version rather than--4.8.2.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2048 from ivankelly/doc-typo-relnotes;d23b45ec840b75307ebf4a108053d8539c8b349a
k--Otherwise the watch objects will accumulate and eventually cause an--OOM on the bookie, if LAC doesn't progress.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #2051 from ivankelly/tme-oom;44ee320b64ee1d47ee8b278a843bd033660b7aa0
Wait for LAC update even if ledger fenced--Previous behaviour was to return straight away. However, LAC can--change when the ledger is fenced and there is no guarantee that a--fenced ledger will turn into a closed ledger (fencing client may--crash), which would cause the client tailing with longpoll LAC to go--into a tight loop.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>, Sijie Guo <sijie@apache.org>--This closes #2052 from ivankelly/wait-on-fenced;316b71923e841c9fdb61159067c4bcf6075d1f21
Migrate command `updatecookie`--Descriptions of the changes in this PR:----#2059 ----### Description----Provide some admin operation about cookie----```--Command to update cookie----Usage:  bkctl cookie admin [flags]----Flags:----    -d, --delete--        Delete cookie both locally and in zooKeeper----    -e, --expandstorage--        Add new empty ledger/index directories----    -f, --force--        Force delete cookie----    -host, --hostname--        Expects config useHostNameAsBookieID=true as the option value----    -l, --list--        List paths of all the cookies present locally and on zooKeeper------    -h, --help--        Display help information--```----### Changes----Update command `updatecookie` to `admin`----Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #2060 from zymap/command-updatecookie;066621507f2d40ea67aa7d7ddadbb9304db17993
Migrate command `triggeraudit`--Descriptions of the changes in this PR:----- Using `bkctl` run command `triggeraudit`----### Motivation----#2011 --Reviewers: Sijie Guo <sijie@apache.org>, Jia Zhai <zhaijia@apache.org>--This closes #2012 from zymap/command-triggeraudit and squashes the following commits:--5a4b496ec [Yong Zhang] Fix conflict ----236b7d6e5 [Yong Zhang] Fix validation-b039b637e [Yong Zhang] Rename file-8bea52522 [Yong Zhang] Remove unused imports-d39d1e886 [Yong Zhang] Migrate command `triggeraudit`-60d993edf [Yong Zhang] Migrate command `autorecovery`-ed008f278 [Yong Zhang] Migrate command `whoisauditor`-5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`-90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`-848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation-06f2b6f50 [Yong Zhang] Migrate command `updateledgers`-7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`-d4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed-5c150f283 [Enrico Olivelli] Release notes for 4.9.1-1246826ba [Yong Zhang] Migrate command `recover`-1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`-67f83620e [Yong Zhang] Migrate command `readledger`-bfbd6b023 [Yong Zhang] Migrate command `decommission`-d40b8b69f [Yong Zhang] Migrate command `readlog`-95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`-e2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`-0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool-6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`-c391fe58d [Yong Zhang] Migrate command `readlogmetadata`-120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`-bf66235e5 [Yong Zhang] Migrate command `deleteledger`-751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time-138a7ae85 [Yong Zhang] Migrate command `metadataformat`-b043d1694 [Yong Zhang] Migrate command `listledgers`-4573285db [Ivan Kelly] Docker autobuild hook-e3d807a32 [Like] Fix IDE complain as there are multi choices for error code-9524a9f4a [Yong Zhang] Migrate command `readjournal`-6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed-e35a108c7 [Like] Fix error message for unrecognized number-of-bookies-5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null-6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2-1448d12aa [Yong Zhang] Migrate command `listfilesondisk`-4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`-468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty-f26a4cae0 [Ivan Kelly] Release notes for v4.8.2-ec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`-8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`-fa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl;6f33968019c3452cefc2d78e0258bb3206d78e8a
Migrate command `autorecovery`--Descriptions of the changes in this PR:----- Using `bkctl` run command `autorecovery`----### Motivation----#2009 --Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2010 from zymap/command-autorecovery and squashes the following commits:--6fcd96904 [Yong Zhang] Fix validation-cd383f372 [Yong Zhang] Rename package-efb573221 [Yong Zhang] Rename command-89da2852e [Yong Zhang] Fix error in bookieshell-a037501ee [Yong Zhang] Rename args-4bb36b0b3 [Yong Zhang] Fix imports postion-e41a742d3 [Yong Zhang] Add unit test for command `autorecovery`-b0c91f704 [Yong Zhang] Rename file-cb06f66de [Yong Zhang] Migrate command `autorecovery`-ed008f278 [Yong Zhang] Migrate command `whoisauditor`-5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`-90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`-848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation-06f2b6f50 [Yong Zhang] Migrate command `updateledgers`-7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`-d4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed-5c150f283 [Enrico Olivelli] Release notes for 4.9.1-1246826ba [Yong Zhang] Migrate command `recover`-1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`-67f83620e [Yong Zhang] Migrate command `readledger`-bfbd6b023 [Yong Zhang] Migrate command `decommission`-d40b8b69f [Yong Zhang] Migrate command `readlog`-95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`-e2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`-0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool-6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`-c391fe58d [Yong Zhang] Migrate command `readlogmetadata`-120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`-bf66235e5 [Yong Zhang] Migrate command `deleteledger`-751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time-138a7ae85 [Yong Zhang] Migrate command `metadataformat`-b043d1694 [Yong Zhang] Migrate command `listledgers`-4573285db [Ivan Kelly] Docker autobuild hook-e3d807a32 [Like] Fix IDE complain as there are multi choices for error code-9524a9f4a [Yong Zhang] Migrate command `readjournal`-6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed-e35a108c7 [Like] Fix error message for unrecognized number-of-bookies-5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null-6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2-1448d12aa [Yong Zhang] Migrate command `listfilesondisk`-4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`-468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty-f26a4cae0 [Ivan Kelly] Release notes for v4.8.2-ec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`-8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`-fa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl;60d993edf50417ace9777d2f40cc2bbc97510125
Migrate command `whoisauditor`--Descriptions of the changes in this PR:----- Using `bkctl` run command `whoisauditor`----### Motivation----#2007 ----Reviewers: Sijie Guo <sijie@apache.org>, Jia Zhai <zhaijia@apache.org>--This closes #2008 from zymap/command-whoisauditor;ed008f27807a75ba384246fc7fae6ca3a5a6971f
Migrate command `Whatisinstanceid`--Descriptions of the changes in this PR:----#2027 ------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2028 from zymap/whatisinstanceid;5b8e0971a35f0c0ee3e237b612a52c12a8c4c923
Migrate command `rebuild-db-ledger-locations-index`--Descriptions of the changes in this PR:----#2036 ----Reviewers: Sijie Guo <sijie@apache.org>--This closes #2034 from zymap/command-RDBLLI;90c79444d6211cd66f4259c04c4e246097821b75
ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation--This bugfix for the FastCodahale timer implementation ensures that percentiles provided by a FastSnapshot are calculated correctly even if the total count of events (provided by FastTimer) is out of sync with the recorded events in the percentile buckets.----### Motivation----FastCodahale Timer implementation may miscalculate percentiles if snapshots of values are slightly out of sync, and if only few events have been recorded.----FastCodahale Timers use fine-grained locking and are meant to tolerate that (some) values change while being recorded or while snapshots are created. Currently, the total count of requests is not synchronized with the number of requests recorded in percentile buckets. If a snapshot is created while the total count of the timer has been incremented beyond the sum of values in the percentile buckets, the percentile calculation may produce wrong values.----For example, if 3 percentile values have been recorded, but the overall count is 4, then the percentile calculation would be based on 4 values. This becomes most obvious if a percentile > .75 (e.g. p95) is being calculated. For this, the implementation will try to find 0.95 * 4 values, which is more than the 3 values recorded in the buckets. Since no bucket fulfills the criteria, the bound of the last (overflow) bucket will be returned, i.e. Long.MAX_VALUE.----### Changes----FastSnapshots now bases the percentile calculation on the sum of values in the percentile buckets rather than a count provided by the caller (i.e. FastTimer). This ensures that percentiles are calculated correctly without the need of having all counters fully synchronized.----Master Issue: #2053 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2054 from nicmichael/fast-codahale-bugfix, closes #2053;848f8527f9d4745753b2f1e22ac1b8e981ea0d1d
Migrate command `updateledgers`--Descriptions of the changes in this PR:----#2057 ----```--Update bookie id in ledgers (this may take a long time).----Usage:  bkctl ledger update [flags]----Flags:----    -host, --hostname--        Expects configuration useHostNameAsBookieID=true as the optin value----    -l, --limit--        Maximum number of ledgers of ledgers to update (default: no limit)----    -p, --printprogress--        Print messages on every configured seconds if verbose turned on--        (default: 10 secs)----    -v, --verbose--        Print status of the ledger updation (default: false)----    -s, updatepersec--        Number of ledgers updating per second (default: 5 per sec)------    -h, --help--        Display help information--```----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2058 from zymap/command-updateledgers;06f2b6f50ca2c6c1ccc630aa9d9fd761abf1becc
Migrate command `regenerate-interleaved-storage-index-file`--Descriptions of the changes in this PR:----#2033 ----```--Regenerate an interleaved storage index file, from available entrylogger files.----Usage:  bkctl bookie regenerate-interleaved-storage-index-file [flags]----Flags:----    -b, --b64password--        The password in base64 encoding, for cases where the password is not--        UTF-8.----    -d, --dryrun--        Process the entryLogger, but don't write anthing.----    -l, --ledgerids--        Ledger(s) whose index needs to be regenerated. Multiple can be--        specified, comma separated.----    -p, --password--        The bookie stores the password in the index file, so we need it to--        regenerate.This must match the value in the ledger metadata.------    -h, --help--        Display help information--```----Reviewers: Sijie Guo <sijie@apache.org>--This closes #2035 from zymap/command-RISIF;7ad5849b1b0d9dbf2274a6fd00ad26f7286f7cff
Avoid useless verify if LedgerEntryRequest completed--Avoid useless verify if LedgerEntryRequest completed----Change-Id: Ifda2a6e218c49105a5627be69566ea2ce4a57699----Descriptions of the changes in this PR:--Print misleading logs when the SpeculativeRequestExecutionPolicy is turned on：--2019-04-03 18:30:49,839 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: -1 , actual: 602--2019-04-03 18:30:49,839 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: -1 , actual: 606--2019-04-03 18:30:49,839 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: -1 , actual: 610--2019-04-03 18:30:49,839 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: -1 , actual: 614--2019-04-03 18:30:49,843 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 644 , actual: 622--2019-04-03 18:30:49,843 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 640 , actual: 626--2019-04-03 18:30:49,843 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 656 , actual: 630--2019-04-03 18:30:49,843 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 652 , actual: 634--2019-04-03 18:30:49,843 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 648 , actual: 638--2019-04-03 18:30:49,846 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 660 , actual: 642--2019-04-03 18:30:49,846 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 675 , actual: 646--2019-04-03 18:30:49,846 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 671 , actual: 650--2019-04-03 18:30:49,846 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 667 , actual: 654--2019-04-03 18:30:49,846 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 663 , actual: 658--2019-04-03 18:30:49,848 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: -1 , actual: 670--2019-04-03 18:30:49,849 ERROR org.apache.bookkeeper.client.DigestManager: Entry-id mismatch in authenticated message, expected: 692 , actual: 662--------### Motivation--Avoid useless verify and redundant logging(caused by the use of recycled `entryImpl`) if LedgerEntryRequest completed----### Changes--Return immediately if completed----Master Issue: #<master-issue-number>--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #2061 from huangdongfa/master;d4dbb6bfb6cd7a56a8baf95472a7f6fc680d0ca2
Release notes for 4.9.1--Descriptions of the changes in this PR:--- Release notes for Apache BookKeeper 4.9.1--- Add Apache BookKeeper docs for 4.9.1 to the website--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1992 from eolivelli/fix/releasenotest491;5c150f28339d7b32f351f34ee8a7469d265b8613
Migrate command `recover`--Descriptions of the changes in this PR:----#2055 --Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2056 from zymap/command-recover;1246826ba749f57d3d428deb7606dd582836ca69
Migrate command `localconsistencycheck`--Descriptions of the changes in this PR:----#2042 ----Using bkctl run command localconsistencycheck----```--Validate Ledger Storage internal metadata--Usage:  bkctl bookie localconsistencycheck [flags]--Flags:----    -h, --help--        Display help information--```--Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2043 from zymap/command-localconsistencycheck and squashes the following commits:--c31f07a00 [Sijie Guo] Merge branch 'master' into command-localconsistencycheck-c391fe58d [Yong Zhang] Migrate command `readlogmetadata`-120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`-bf66235e5 [Yong Zhang] Migrate command `deleteledger`-c9bb4a42c [Yong Zhang] Migrate command `localconsistencycheck`-751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time-138a7ae85 [Yong Zhang] Migrate command `metadataformat`-b043d1694 [Yong Zhang] Migrate command `listledgers`-4573285db [Ivan Kelly] Docker autobuild hook-e3d807a32 [Like] Fix IDE complain as there are multi choices for error code-9524a9f4a [Yong Zhang] Migrate command `readjournal`-6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed-e35a108c7 [Like] Fix error message for unrecognized number-of-bookies-5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null-6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2-1448d12aa [Yong Zhang] Migrate command `listfilesondisk`-4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`-468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty-f26a4cae0 [Ivan Kelly] Release notes for v4.8.2-ec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`-8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`-fa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl;1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9
Migrate command `readledger`--Descriptions of the changes in this PR:----#2040 ----- Using `bkctl` run `readledger`----```--Read a range of entries from a ledger.----Usage:  bkctl bookie readledger [flags]----Flags:----    -b, --bookie--        Only read from a specific bookie----    -ef, --entryformatter--        Set entry formatter----    -fe, --firstentryid--        First Entry ID----    -r, --force-recovery--        Ensure the ledger is properly closed before reading----    -le, --lastentryid--        Last Entry ID----    -l, --ledgerid--        Ledger ID----    -lf, --ledgeridformatter--        Set ledger id formatter----    -m, --msg--        Print message body------    -h, --help--        Display help information--```----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2041 from zymap/command-readledger and squashes the following commits:--56b0a4581 [Yong Zhang] Remove unused import-30dafa85f [Yong Zhang] Merge branch 'master' into command-readledger-bfbd6b023 [Yong Zhang] Migrate command `decommission`-d40b8b69f [Yong Zhang] Migrate command `readlog`-95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`-e2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`-c465c4761 [Yong Zhang] Remove unused import-0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool-6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`-931df8c2c [Sijie Guo] Merge branch 'master' into command-readledger-c391fe58d [Yong Zhang] Migrate command `readlogmetadata`-120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`-bf66235e5 [Yong Zhang] Migrate command `deleteledger`-87e6644f2 [Yong Zhang] Fix some conflict-5ae05f0d2 [Yong Zhang] Migrate command `readledger`-751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time-138a7ae85 [Yong Zhang] Migrate command `metadataformat`-b043d1694 [Yong Zhang] Migrate command `listledgers`-4573285db [Ivan Kelly] Docker autobuild hook-e3d807a32 [Like] Fix IDE complain as there are multi choices for error code-9524a9f4a [Yong Zhang] Migrate command `readjournal`-6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed-e35a108c7 [Like] Fix error message for unrecognized number-of-bookies-5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null-6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2-1448d12aa [Yong Zhang] Migrate command `listfilesondisk`-4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`-468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty-f26a4cae0 [Ivan Kelly] Release notes for v4.8.2-ec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`-8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`-fa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl;67f83620eb8ed93bf73322293deb1a1bde8d09c7
Migrate command `decommission`--Descriptions of the changes in this PR:----#2049 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #2050 from zymap/command-decommissionbookie;bfbd6b023b68ca0c23bf976274279ac8338181f5
Migrate command `readlog`--Descriptions of the changes in this PR:----#2044 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #2045 from zymap/command-readlog;d40b8b69f1b25f4ad3cd9992db616b847fed54d8
Migrate command `nukeexistingcluster`--Descriptions of the changes in this PR:----#2029 ------Reviewers: Sijie Guo <sijie@apache.org>--This closes #2030 from zymap/command-nukeexistingcluster;95d145a15f5410e207ce610b6b4af8758851ab97
Migrate command `listunderreplicated`--Descriptions of the changes in this PR:----- Using `bkctl` run command `listunderreplicated`----### Motivation----#2013 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2014 from zymap/command-listunderreplicated;e2b1dc7f3197891a437f689c35bff93e4e0c9a5d
ISSUE #2023: change cached thread pool to fixed thread pool--Descriptions of the changes in this PR:----change newCachedThreadPool() to newFixedThreadPool(int)----### Motivation----newFixedThreadPool(int) can be freely configured with the total number of threads, while cached thread pool may cause OutOfMemoryError when there are too many threads need to created.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2024 from bd2019us/patch, closes #2023;0988e12c7a12e1ffae2cdbe932ba414ec06f40cc
Migrate command `initnewcluster`--Descriptions of the changes in this PR:----#2046 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #2047 from zymap/command-initnewcluster;6a6d7bbd995acd55389ec209e42e099647c988fd
Migrate command `readlogmetadata`--Descriptions of the changes in this PR:----#2038 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #2039 from zymap/command-readlogmetadata;c391fe58dfdb283e54d809a8d24200c9a34d5dfc
Migrate command `lostbookierecoverydelay`--Descriptions of the changes in this PR:----- Using `bkctl` run command `lostbookierecoverydelay`----### Motivation----#2015 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #2016 from zymap/command-lostbookierecoverydelay;120d67737f894c8c9ce5d7954c697015f8e7b1e2
Migrate command `deleteledger`--Descriptions of the changes in this PR:----#2025 ------Reviewers: Sijie Guo <sijie@apache.org>--This closes #2026 from zymap/command-deleteledger;bf66235e5bfa2aa094d17b7e555d0dd5661a6f4d
ISSUE #2020: close db properly to avoid open RocksDB failure at the second time--Descriptions of the changes in this PR:----### Motivation----If not releasing resources of failed/closed asyncStore, new creating of the same store identifier will fail, mainly caused by RocksDBException, like #2020 shows.----### Changes----add scStores to factory's instance variable at the `addstore` method of `MVCCStoreFactoryImpl` class;--release store when open fail;----Descriptions of the changes in this PR:----Master Issue: #2020 ------Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2022 from ArvinDevel/issue2020, closes #2020;751e55fa433172422fb82556ff748c5f6f2bfc41
Migrate command `metadataformat`--Descriptions of the changes in this PR:----#2031 ----Reviewers: Sijie Guo <sijie@apache.org>--This closes #2032 from zymap/command-metaformat;138a7ae8569fa36b70e03ba61c57104d6ab94f18
Migrate command `listledgers`--Descriptions of the changes in this PR:----Using `bkctl` run command `listledgers`----### Motivation----#2004 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2005 from zymap/command-listledgers;b043d1694569a934d9f27347ec2d15180f7a95c0
Docker autobuild hook--This hook will allow docker autobuild to build from the offical tag--and removes the need to update the dockerfile after the release has--been made.----It also adds a build arg, DISTRO_URL which can be used for testing--release candidates.----```--docker build --build-arg BK_VERSION=4.9.1--    --build-arg DISTRO_URL=<rc-tarball-url> .--```----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #2017 from ivankelly/docker-tag2;4573285db9e027416bf33ab9b959b952d2b0e8d5
Fix IDE complain as there are multi choices for error code--There are two ```Code``` in ```org.apache.bookkeeper.client. BKException```:----The first is https://github.com/apache/bookkeeper/blob/f26a4cae0e9205ad391c6d4d79f2937871864c28/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BKException.java#L136----The second is https://github.com/apache/bookkeeper/blob/f26a4cae0e9205ad391c6d4d79f2937871864c28/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/api/BKException.java#L180----BKException's subclasses cannot auto choice which ```Code```. ----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1999 from liketic/fix-code;e3d807a32a0a9b69d0ac8db3ca17398373dbee28
Migrate command `readjournal`--Descriptions of the changes in this PR:----- Use `bkctl` execute `readjournal` command----### Motivation----- Migrate from bookieshelll--------Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #2000 from zymap/command-readjournal;9524a9f4a82dd990aa437a2931bf2e5541ea0a37
Fix when met unexpect entry id crashed----Fixes #2001----*Motivation*----When met a unexpect entry id, db indexes failed cleanup.----*Modifications*----Catch the exception and ignore it.----Master Issue: #2001 --------Reviewers: Jia Zhai <zhaijia@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #2002 from zymap/fixnoentryexception;6c3f33f55fc3754925323b1d077108331d027aaf
Fix error message for unrecognized number-of-bookies--Closes #1925 --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1997 from liketic/fix-issue-1925;e35a108c7a47d746d5010ee5178712496741cc18
fix potential NPE when releasing entry that is null--Descriptions of the changes in this PR:----### Motivation--A interrupt exception can occur during the poll operation of the blocking and cause a NPE to be thrown----### Changes--Check if entry is null before trying to release it----Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1998 from jerrypeng/fix_NPE;5902ee27be2fb7eeade53f5e8e4afd3fe573ad5c
[RELEASE] Update website to include documentation for 4.8.2----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1993 from ivankelly/482site;6aa73ce050feb247f491a489a42f6e3db09961cf
Migrate command `listfilesondisk`--Descriptions of the changes in this PR:----- Replace command `listfilesondisk` ----### Motivation----- Use `bkctl` to run command `listfilesondisk`--- #1989 --### Changes----- Add command in `bkctl`----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1990 from zymap/command-listfilesondisc and squashes the following commits:--922e2b70a [Sijie Guo] Merge branch 'master' into command-listfilesondisc-8d72a00bd [Yong Zhang] Migrate command `listfilesondisk`;1448d12aa6399b64d272b9d3f820fbf128cb371e
Issue #1987: Migrate command `convert-to-interleaved-storage`--Descriptions of the changes in this PR:----- Migrate command `convert-to-interleaved-storage`----### Motivation----- #1987 --- Use `bkctl` to run command `convert-to-interleaved-storage`----### Changes----- Add command in `bookiegroup`----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1988 from zymap/command-ctis, closes #1987;4de5983793707e764c8dc604cfb6308748664677
In DbLedgerStorage use default values when config key is present but empty--### Motivation----Currently setting the `dbStorage_writeCacheMaxSizeMb=` with empty value is making the--DbLedgerStorage initialize to fail since the empty string is being parsed as long. ----Instead, we should just apply the default value as in the case where the config key is not there.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1996 from merlimat/db-storage-config;468743e7e45ce5a862ddef41de0e4b87d988402a
Release notes for v4.8.2----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #1976 from ivankelly/v4.8.2-relnotes;f26a4cae0e9205ad391c6d4d79f2937871864c28
Issue #1985: Migrate command `convert-to-db-storage`--*Motivation*----- Use bkctl to run command `convert-to-db-storage`----*Modifications*----- #1985 --- Add command in `bookieGroup`----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1986 from zymap/command-ctdb, closes #1985;ec2636cd2e3285eefc1eabc2634e5b5576fe81b8
Issue #1982: Migrate command `bookiesanity`--Descriptions of the changes in this PR:----- migrate command `bookiesanity`----### Changes----- use command by `bkctl bookie sanity`----Master Issue: #1982 ----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1983 from zymap/command-bookiesanity, closes #1982;8cc7239ac95ea1673b188d57a89aa39d4ecd3c8f
Issue #1980: Migrate command `ledger` from shell to bkctl--Descriptions of the changes in this PR:----Migrate command `ledger` from shell to bkctl----### Motivation----#1980 ----### Changes----- Add new implement for `ledger`----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1981 from zymap/command-ledger, closes #1980;fa90f0185c51e8f842148945e4958cbc02cbe023
Tool to search and replace bookie ids in ledger metadata--To use:--```--bin/bkctl bookieid searchreplace --from <from> --to <to>--```----To be used in cases where the DNS name of the bookie has to change, and you don't want all the data to have to be moved by autorecovery.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #1968 from ivankelly/bk-replace-bookieid;f4cbf8a395150e4ea360ef2c8b1cfa95d6d0625f
Issue #1977: Migrate command 'bookieinit'--Descriptions of the changes in this PR:----Migrate command `bookieinit` from shell to bkctl----### Motivation---- Issue #1977 ----### Changes----- Replace command `bookieinit` in shell----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1978 from zymap/command-bookieinit, closes #1977;009eb5d5ba5c4269235aa6727a9e50fe87afbdfe
Migrate command `bookieformat`--Descriptions of the changes in this PR:----Migrate command `bookieformat`.----### Motivation----#1974 ----### Changes----- Add command `bookieformat` to bkctl--- Replace command in shell----Reviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1975 from zymap/command-bookieformat and squashes the following commits:--90e8a1dde [Yong Zhang] Add doc-e079383ac [Yong Zhang] Fix the way deal with exception-eb78fe74f [Yong Zhang] Add unit test for `commandformat`-a3bafe6d9 [Yong Zhang] Migrate command `bookieformate` to bkctl;5a3448860be585972aa328aa1602b63ead177269
Migrate command `bookieinfo` to bkctl--### Motivation----Migrate command `bookieinfo` to bkctl.----### Changes----You can execute as `bin/bkctl bookie  info`.----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1972 from zymap/yongzhang/command_info;6b602f77883ceaf926e8246ba622c54d048b55a3
Add validateConf to AbstractDNSToSwitchMapping--Descriptions of the changes in this PR:----- when setConf of AbstractDNSToSwitchMapping  is called it--should do sanity checking of the conf/env. and throw--RuntimeException if things are not valid.--- For RawScriptBasedMapping.validateConf, try executing--the script with no arguments for sanity check purpose.--Here it is expected that running script with no arguments--would do sanity check of the script and the env.----(there are 2 commits in this PR, but this PR is meant for the second commit and there is other PR for the first commit)--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1965 from reddycharan/sanitycheckmappingconf;2576afdbe460e76047999725bd5988486ccf378e
[DLOG] Avoid double read in readahead--There was a bug in the ReadAheadReader whereby, if it was in a paused--state and the last segment it had read had been closed, then when a--writer started writing new segments, the ReadAheadReader would issue a--double read. This would end up triggering an error when it got to the--end of the segment as the issued one of the issued reads would then be--cancelled when the segment was closed.----This fix adds an explicit state machine to the reader and moves all--state transitions to run on the ordered executor, so only one read can--ever be issued at a time.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1973 from ivankelly/dlog-reader-crash-master;db5d7e7cf30d58c9c463ce29c7d7900115717206
Use the same thread to monitor ledger and index directories--Closes #1655 --Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1957 from liketic/reduce-monitor-threads;629230cb13a7ccb1211343dbb0a8bfe7a674ed96
Use automatic resource management to close streams--We can use automatic resource management introduced in java 7, which makes code shorter.--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1958 from liketic/use-resource;73f36a2272ef061444fcb871976ef89c5ca9ded8
[PYTHON] Fix python client version--Descriptions of the changes in this PR:----*Motivation*----pip doesn't work with '-SNAPSHOT'. Use `-alpha-0` instead of `-SNAPSHOT` for python.----*Modifications*----- update setup.py file--- update release guide----------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1954 from sijie/fix_python_version;b67e8b262e3dbf77a7ef5f13c2e22bd191c85d00
Use conf value in RackawareEnsemblePlacementPolicyImpl.initialize method------Descriptions of the changes in this PR:----- Use conf value in RackawareEnsemblePlacementPolicyImpl.initialize method,--instead of uninitialized enforceMinNumRacksPerWriteQuorum variable--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1964 from reddycharan/fixexceptioncondition;756cae7462919f03c7eea9dcf2985a1a6fdc64cd
Add http method test for vertx-http server--### Motivation----As discussed at #1953, adding test to verify all http-method works for vertx-http-server.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1963 from rdhabalia/gc_test;4e32ef618fd3b6a60d9ff7f78ea40c8d11464d96
Fix unable download twitter dependencies---------Fixes #1962----*Motivation*----There are some twitter dependencies can't download from repo----*Modifications*----- remove some using in StatsLoggerBenchmark.java--- update some config in pom.xml----Descriptions of the changes in this PR:----You can add -Dtwitter to choose add twitter dependencies.----### Motivation----(Explain: why you're making that change, what is the problem you're trying to solve)----### Changes----(Describe: what changes you have made)----Master Issue: #1962--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1966 from zymap/master;b689d8313654de21759b2e2d47210b75434038c3
[DOC] popover for 'striped' as well as 'striping'--Adds a popover term for 'striped' to match 'striping'.----### Motivation----<img width="817" alt="screen shot 2019-02-19 at 14 08 07" src="https://user-images.githubusercontent.com/1994486/53020896-ddd07e00-344f-11e9-9327-7beb380515d7.png">----The first "link" text has no pop-over, but the second does. ----### Changes----Just copies the pop-over for striping. It seems inelegant vs. allowing multiple pop-over terms to refer to the same HTML fragment rather than being 1-1, but also is a straightforward and unobtrusive change.----Master Issue: (no issue)--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1951 from kjgorman/striped-popover;9ad191ca0fc0bf2eaeabdc5dc796c8c53fe390a8
[BOOKIE-HTTP-SERVER] Fix: broken vertx rest endpoints--### Motivation--Right now, vertx-http-server is not serving any rest endpoint except get because vertx server doesn't add put/post/delete http-methods into routing rules.----### Modification--Add put/post/delete http-methods into routing rules.--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1953 from rdhabalia/http_ep;9c14476422ee865769152917405607bd330046fa
Log error (if any) in Shell.runCommand------Descriptions of the changes in this PR:--- Log error (if any) in Shell.runCommand even in the case of successful execution--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1956 from reddycharan/printshellerror;b829eb2e11d211cefb283c0919f2b893d30d2f35
Fix obsoleted proposals document link--Closes #1531 --Reviewers: Sijie Guo <sijie@apache.org>--This closes #1959 from liketic/fix-link;35c9640bfdc232fb961574299981d5f85895d425
Exclude defaultrack bookies when enforceMinNumRacksPerWriteQuorum is enabled----Descriptions of the changes in this PR:----- enforceMinNumRacksPerWriteQuorum is meant to be used for strict placement policy. So when--it is enabled, bookies which belong to default faultzone/rack (because of failure in resolving--network location) should be excluded from bookie selection.--- add gauge for number of bookies in default faultzone/rack. It will be helpful to create alerts--based on this gauge.--- add gauge for number of ledgers found not adhering to strict placement policy in Auditor's--placement policy check. This gauge will be more helpful in creating alert instead of using--monotonously increasing alert.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Pasha Kuznetsov <None>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1941 from reddycharan/ignoredefaultzoneandfixmetrics;49135b6b48a45a5fbc1fd8696dd595e4dc832da8
[DOC] Fix command path in documents--Closes #1556--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1948 from liketic/fix-cmd-dir;31901ffd1041fa4cd8374aa4a32ef0ef372a8b8f
BOOKKEEPER-1919: putEntryOffset translate FileInfoDeletedException--IndexInMemPageMgr should translate FileInfoDeletedException into--NoLedgerException as expected by users like--InterleavedLedgerStorage.updateEntriesLocations and--EntryMemTable.flushSnapshot.----Signed-off-by: Samuel Just <sjustsalesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1950 from athanatos/forupstream/wip-1919;10272ead9d9b446aeee3d8acd5df9febfd5705c7
Filter empty string for networkTopologyScriptFileName------Descriptions of the changes in this PR:----- filter empty string for networkTopologyScriptFileName.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1952 from reddycharan/ignoreemptystring;166be82390ff18c402647838895ba07e3372e51d
[BK-GC] Fix GC thread gets blocked--### Motivation----It addresses below thread-stuck while performing gc in bookie.----```--Thread 3363: (state = BLOCKED)-- - java.lang.Object.wait(long) bci=0 (Compiled frame; information may be imprecise)-- - java.lang.Object.wait() bci=2, line=502 (Compiled frame)-- - org.apache.bookkeeper.util.ZkUtils.getChildrenInSingleNode(org.apache.zookeeper.ZooKeeper, java.lang.String) bci=34, line=243 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator.getChildrenAt(java.lang.String) bci=8, line=165 (Compiled fr--ame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$LeafIterator.<init>(org.apache.bookkeeper.meta.LongHierarchic--alLedgerManager$LongHierarchicalLedgerRangeIterator, java.lang.String) bci=11, line=187 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$InnerIterator.advance() bci=137, line=261 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$InnerIterator.next() bci=28, line=281 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$InnerIterator.next() bci=4, line=278 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$InnerIterator.next() bci=4, line=278 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator$InnerIterator.next() bci=4, line=278 (Compiled frame)-- - org.apache.bookkeeper.meta.LongHierarchicalLedgerManager$LongHierarchicalLedgerRangeIterator.next() bci=8, line=304 (Compiled frame)-- - org.apache.bookkeeper.meta.HierarchicalLedgerManager$HierarchicalLedgerRangeIterator.next() bci=26, line=117 (Compiled frame)-- - org.apache.bookkeeper.bookie.ScanAndCompareGarbageCollector.gc(org.apache.bookkeeper.bookie.GarbageCollector$GarbageCleaner) bci=195, line=168 (Compiled frame)-- - org.apache.bookkeeper.bookie.GarbageCollectorThread.doGcLedgers() bci=8, line=393 (Compiled frame)-- - org.apache.bookkeeper.bookie.GarbageCollectorThread.runWithFlags(boolean, boolean, boolean) bci=39, line=355 (Compiled frame)-- - org.apache.bookkeeper.bookie.GarbageCollectorThread.safeRun() bci=28, line=333 (Compiled frame)-- - org.apache.bookkeeper.common.util.SafeRunnable.run() bci=1, line=36 (Compiled frame)-- - java.util.concurrent.Executors$RunnableAdapter.call() bci=4, line=511 (Compiled frame)-- - java.util.concurrent.FutureTask.runAndReset() bci=47, line=308 (Compiled frame)-- - java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask) bci=1, line=180 (Compiled frame)-- - java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run() bci=37, line=294 (Compiled frame)-- - java.util.concurrent.ThreadPoolExecutor.runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) bci=95, line=1142 (Compiled frame)-- - java.util.concurrent.ThreadPoolExecutor$Worker.run() bci=5, line=617 (Interpreted frame)-- - io.netty.util.concurrent.FastThreadLocalRunnable.run() bci=4, line=30 (Interpreted frame)-- - java.lang.Thread.run() bci=11, line=748 (Interpreted frame)--```----### Changes----add time-out to zk operation to avoid GC thread blocking.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1937 from rdhabalia/gc_dead;d511f590c15dd86345719ba842bd373411c6da49
[DOC] Add python client release instructions to release guide----------Reviewers: Jia Zhai <zhaijia@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1942 from sijie/update_instructions_on_publish_pythonclient;0f8322181a0e83bc9bb3b1821736865359ac93ab
[WEBSITE] Update release schedule for 4.10.0----------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1932 from sijie/update_release_schedule;8c7c377d4ee726ad932dbe6463f5c7c993832536
fix invalid formatter xml--### Motivation----`formatter.xml` is an invalid xml and eclipse fails to load it.------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1939 from rdhabalia/format_xml;ec6ba500163b9f0b10d4597365d27e162281193b
Bump Netty and GRPC version------Descriptions of the changes in this PR:----*Motivation*----When we bumped Netty's version, we didn't bump the gRPC version.--So the gRPC version has become very old.----*Modifications*----Bump both gRPC and Netty version to make them aligned with each other.-------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1934 from sijie/bump_grpc_version;9132659d5c0fa17d04109fad0841ffe637fc40f7
[DEV] Break current ISSUE_TEMPLATE into multiple single templates--Descriptions of the changes in this PR:----*Motivation*----Following the Github community recommendations (https://github.com/apache/bookkeeper/community)--to break down current ISSUE_TEMPLATE to multiple single templates----*Modifications*----- break down the `ISSUE_TEMPLATE.md` into multiple files in `ISSUE_TEMPLATE`--- fix the skip phrase in PULL_REQUEST_TEMPLATE-------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1933 from sijie/fix_pull_request_templates;a08defd82d412a0c7ebcec8b4eca5d5020fe7988
[RELEASE] Release Notes for 4.9.0----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>--This closes #1910 from sijie/bk490_release_notes;4868b55e6fcfcbf4a5a4aa52a4e1ea7ce74f9562
PlacementPolicy checker validating EnsemblePlacementpolicy----Descriptions of the changes in this PR:----- As described in BP-34,--https://github.com/apache/bookkeeper/blob/master/site/bps/BP-34-cluster-metadata-checker.md,--this change introduces new checker - cluster-metadata-checker with initial responsibility--of validating the EnsemblePlacementpolicy of segments of ledgers (which are writeclosed/fenced).--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1902 from reddycharan/placementpolicyscrutiny;a79cd081114ed45d2e0121d524ea1b710d7d2452
[RELEASE] Update Dockerfile to 4.9.0----------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1929 from sijie/update_docker_file;1da10f8cfaa7ad2bd132f7136291e20ce2d97d5c
[RELEASE] Update website to include documentation for 4.9.0----------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1928 from sijie/update_website_490;2755784bac9af0a48b3c8a0af0cee63d730640aa
Ignore usage of localNode in PlacementPolicy.----Descriptions of the changes in this PR:----'ignoreLocalNodeInPlacementPolicy' specifies whether to ignore localnode--in the internal logic of placement policy. If it is not possible or useful--to use Bookkeeper client node's (or AutoReplicator) rack/region info. for--placement policy then it is better to ignore localnode instead of false--alarming with error/warn log lines and metrics.----It is not valid to expect rack mapping information to be available for Bookkeeper--client and ReplicationWorker nodes. So if rackmapping info. is not available--then it is better to ignore creation of BookieNode by resolving rack information--for the client localnode. Otherwise it would log unnecessary warn/error log lines--and rack resolution failure metrics.--Reviewers: Sijie Guo <sijie@apache.org>, Jia Zhai <zhaijia@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1917 from reddycharan/ignorelocalnodeinplacementpolicy;d8b894f3a1a60e6df2071e8d8ca89e3e02ba222a
Add semantically meaningful return values to placement policy--Currently newEnsemble and replaceBookie in EnsemblePlacementPolicy--return a apache commons Pair<> with the second argument being a--boolean to denote whether the placement conforms strictly to the--policy. From calling code, the meaning of this second value is--unclear.----This patch replaces Pair<> with an PlacementResult object, in which--the strict conformity argument is clearly labels. This will also allow--extension in the future to return more metadata about particular--placements.----Also, we shouldn't put third party library classes in interfaces.----Issue:  #1914----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1916 from ivankelly/meaningful-placement-res;737f92b2782fc0d027c51ea6bf88cb6b802398db
[TABLE SERVICE] bump python client version to 4.10.0-SNAPSHOT------Descriptions of the changes in this PR:----*Modifications*----Bump the development of python client to 4.10.0-SNAPSHOT--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1911 from sijie/bump_python_client_development;03e7d6e48822e656d6b652359f780f0cb1513bc1
Revert "fix/pair"--This reverts commit 615f96701a461160d6d246e5387668b0e3406609.;3d2a1d9f6cf1de158054e8af242823a29b92e4e8
fix/pair;615f96701a461160d6d246e5387668b0e3406609
[RELEASE] add bkctl package to release scripts----Descriptions of the changes in this PR:------*Motivation*----starting from bookkeeper 4.9.0, a separate tool package `bkctl` is released.----*Modifications*----add bkctl into release scripts--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1907 from sijie/include_bkctl_package;5b737b037e2c771a2e8c9f2de3bbcc6812b80b2b
[RELEASE] Release table service python client----Descriptions of the changes in this PR:----*Motivation*----Update the table service python client version to release version----*Modifications*----Bump the version to 4.9.0--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1906 from sijie/release_python_client;b1f840e5d35d64d29bedbd0f6c6a9c39f08c040a
[BUILD] Fix master build after release 4.9.0------Descriptions of the changes in this PR:----*Motivation*----when creating branch-4.9, maven release plugin doesn't bump the version for stream modules.----*Modifications*----run `mvn versions:set` to manually fix the version for all modules--------Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1909 from sijie/fix_master_build;ff8147fabe6a10563849c753e97037698e37aee9
[maven-release-plugin] prepare for next development iteration;8c24f94e171d20c65c21887131c32862c9e5af29
[maven-release-plugin] prepare branch branch-4.9;2a2f77527628b060f7eca107f9a1a4c885cd3081
HTTP GetMetaService returns JSON rather than calling #serialize--Once the binary ledger metadata serializing is available, the output--of GetMetaService would no longer be understandable. In preparation--for this, make GetMetaService use output JSON, rather than directly--calling #serialize.----Master issue: #723----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1864 from ivankelly/get-to-string;19a598eb8273cf197bb7ebf373b070c03977d5f6
Small fix wrong nodesUninitialized count when checkCovered----Descriptions of the changes in this PR:----### Motivation----Since count `nodesUninitialized` is always 0,--there is no wait if we haven't seen any OK responses and there are still nodes not heard from----### Changes----Correct  nodesUninitialized count and add a related testcase--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1900 from huangdongfa/fix-error-nodesUninitialized;dcdd1e887ef01f7515053f7eb06f8479de8700ff
replace default source-release-assembly by bookkeeper-dist--fix for #1895--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1904 from hboutemy/master;58b9d284dbe8bd67d67e62d3be412db88a4d1a85
Binary metadata format--This patch adds a binary metadata format and bumps the metadata format--version to 3. The contents of the binary metadata is the same as the--contents of the text format for now. The difference is that the binary--is more compact, and the fields can be added to the metadata when--using the binary format, which isn't possible with the text--format. With the text format, parsing with a client that didn't--recognise the new field would fail.----For now, the text format (version 2) is still used by default. We will--provide a tool to allow administrators to bump to version 3.----Some tests have been modified to provide digest and password to the--builder. All protobuf metadata in released versions has had digest and--password (first protobuf metadata was in release-4.2.0). So if new--metadata is created or read with version 2, it will have this two--fields set.----Master issue: #723----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1866 from ivankelly/binary-metadata;534366536ea8180b405ad430604389a8948cf42f
Move Jobs from Obsolete JDK9 to JDK11----Descriptions of the changes in this PR:----- create new jobs for JDK 11--- disable spotbugs on JDK 11 on CI--- drop jdk9 and jdk10 from Travis--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1903 from eolivelli/fix/ci-jdk11-part1;55c6a66bf06b1b29cb9e76c82d150d0f0412422f
Make Spotbugs pass on JDK11--Descriptions of the changes in this PR:--- upgrade spotbugs to 3.1.8--- disable spotbugs on JDK11 (due to for https://github.com/spotbugs/spotbugs/issues/756)----### Motivation----This change is on the way to give full "official" support do JDK11----### Changes----- upgrade spotbugs to 3.1.8--- fix new spotbugs issues--- disable spotbugs on JDK11 (due to for https://github.com/spotbugs/spotbugs/issues/756)--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1849 from eolivelli/fix/ci-java11;d00491bc103dd85fb60307257bc2ad6d44f3118f
Enhance EnsemblePlacementPolicy and DNSResolverDecorator to log relevant metrics.----Descriptions of the changes in this PR:------Make changes to EnsemblePlacementPolicy so that it would return boolean value indicating--if the return value of newEnsemble and replaceBookie are strictly adhering to corresponding--PlacementPolicy or it fell back to random.----Similarly DNSResolverDecorator should log a metric when it was unable to resolve rack info and--it is using default rack.------Reviewers: Samuel Just <sjust@salesforce.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1883 from reddycharan/enhanceplacementpolicy;42fe1506afe04b8068b897c530c7ca7188da503e
Allow to configure sticky reads--### Motivation----Currently the BK client is issuing the read requests in round-robin fashion across all the bookies in the write set.----One issue with this approach is that it's not taking full advantage of the read-ahead cache, either explicit (like in `DbLedgerStorage`) or implicit (by reading data through Linux page cache which will do some prefetching).----With `e=2`, `w=2`, when we read `e-0` from `bookie-1` and `e-1` from `bookie-2`, we fail to take advantage of the fact that `bookie-1` will have already `e-1` in memory.----Effectively with `e-2`, `w-2` the disk read IO will be doubled, compared to the amount of data served to BK clients. The larger the quorum, the bigger will be overhead (eg: `e=5`, `w=5` will lead to 5x reads from disk).----### Changes----Added a BK client flag for "sticky reads". When reading from a ledger that has `E=W` (every bookie has all the entries), the sticky reads will direct all read request to 1 single bookie in the ensemble.--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1808 from merlimat/single-bookie-per-ledger-read-master;4c8587715104cde6dbd70d1e7de0fc1853122eda
Configure Netty allocator in bookie and client--### Motivation----This is based on #1754. Adding the code to configure and use the allocator wrapper in bookie and client.----(I'll rebase once the first PR is merged)--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1755 from merlimat/use-allocator;1a66de0f1841309390261e90d8d0d0af7aa2ede6
Allow to configure BK for low latency busy-wait settings--### Motivation----Added `enableBusyWait` configuration option to turn on CPU Affinity and busy wait on sockets and queues.------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1812 from merlimat/configure-busy-poll;e4265470881431fb7a78c8ab714c237239169e12
ISSUE #1892: ILS: reset retry in consistency check loop--This patch additionally:--- modifies InterleavedLedgerStorageTest.java to test with and without--  entryLogPerLedger--- refactors the test a bit to ensure that the gc calls really do race--  with the right part of the checker--- addresses a few other more cosmetic errors----(bug W-5721713)--Signed-off-by: Samuel Just <sjustsalesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1894 from athanatos/forupstream/wip-1892, closes #1892;ed7ca37e96639b8d7105653e971c1bd1b4533f8a
Revert maxLedgerMetadataFormatVersion changes in layout--There is ongoing discussions about how to do this, so I'm reverting this--change for now to allow 4.9 release to proceed. The change modifies the--contents of the layout znode, so once they're in an official release they--cannot be removed without breaking BC.----The reverted changes are:----dd684b Ledger manager factories initialized with max metadata version--dce4fd Add max ledger metadata format version to layout----Master issue: #723----Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1890 from ivankelly/revert-max-format;e921193b464bc86b24fa63bb71ba85ebb2d523c6
Multiple calls to LedgerHandle#close should wait on actual close--The previous behaviour was to complete successfully immediately if--close had already been called on the handle. This allowed for--potential consistency violations, as the caller could believe that the--ledger was closed, when in fact the close operation was still in--progress and could still potentially fail.----Issue: #1712----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1889 from ivankelly/double-close-anomoly;52d195700381bb3782a86e983f1a8c62d12bad2a
Introduce a configuration framework for better organizing and documentating configuration settings--Descriptions of the changes in this PR:----### Motivation----One common task in developing bookkeeper is to make sure all the configuration--settings are well documented, and the configuration file we ship in each release--is in-sync with the code itself.----However maintaining things in-sync is non-trivial. This proposal is exploring--a new way to manage configuration settings for better documentation.----### Changes----- Introduce `ConfigKey` for defining a configuration setting key in a configuration--- Introduce `ConfigKeyGroup` for grouping configuration settings together--- Introduce `ConfigDef` for generating the configuration definition for a given configuration--- Add a `save` method for saving a configuration definition into a configuration file----Master Issue: #1867 --------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1869 from sijie/config_defs;21d71fb9e576d95e2ff2adf7a961a2847b96a9f9
Bring back statslogger to BookKeeper client in ReplicationWorker process.----Descriptions of the changes in this PR:----- https://github.com/apache/bookkeeper/commit/2837f6257baf15dc9dd9eb4bcac34596b442be33--had inadvertently removed StatsLogger to BookKeeper client instance in ReplicationWorker process.--So restore StatsLogger in BookKeeper client object.--- Also introduce new config called - 'limitStatsLogging', which would be used to limit statslogging--as and when needed.--- currently this config is used to limit the stats from PCBC. Because if AR process is running in--each Bookie node, then for each AR there will be n number of PCBCs and totally it comes out to--n^2 PCBCs in the cluster. Which is unmanageable from stats collector perspective. So this config--value can be set to true in AR config.----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1888 from reddycharan/bringbackmetricsforarprocess;bd2b16e880d172d4761461fdbf85c1bd19b24e36
[STATS] [DOC] Add @StatsDoc annotation for ledger cache stats----Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document the ledger cache stats.----*Changes*----- convert ledger cache stats to use StatsDoc for documenting metrics----Master Issue: #1785----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1872 from sijie/ledgercache_stats;6fa8fc3825044e05f06f4408cf5eb410a0bee163
[STATS] [DOC] Add @StatsDoc annotation for garbage collector stats--Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document gc stats.----*Changes*----- convert gc stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1875 from sijie/gc_stats;b2e099bbc7b13f13825fe78ab009ca132cb3a9ba
Issue #1884: (@W-5697664@) dir_*_usage stats are reported as 0 ...--for read-only bookies after a restart----### Motivation----Fixing the Issue #1884:----When a read-only bookie is restarted it keeps reporting `dir_*_usage`--stats as `0` until it becomes writable again.----This is caused by the `LedgerDirsMonitor.check` only updating--`diskUsages` if there are any writable dirs, or if the total usage--goes below the low water mark, otherwise relying on previously filled--values which are `0` after a bookie is restarted.----### Changes----* Change the `LedgerDirsMonitor.check` to update `diskUsages`--  even when there are no writable dirs.--* Add new `testLedgerDirsMonitorStartReadOnly` testing this scenario.--* Simplify previous tests checking read-only since `diskUsages`--  are now updated regardless if a bookie is in read-only mode.----jvrao reddycharan --------Reviewers: Sijie Guo <sijie@apache.org>, Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #1885 from pasha-kuznetsov/issue-1884-dir-usage-ro-restart, closes #1884;1b2138fd4ecdbc4dfec00709b51e1367dfd49654
BP-37: Improve configuration management for better documentation----Descriptions of the changes in this PR:----*Motivation*----One common task in developing bookkeeper is to make sure all the configuration--settings are well documented, and the configuration file we ship in each release--is in-sync with the code itself.----However maintaining things in-sync is non-trivial. This proposal is exploring--a new way to manage configuration settings for better documentation.----Master Issue: #1867----------Reviewers: Matteo Merli <mmerli@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1868 from sijie/bp37_conf_documentation;616d4c15bf85fcbe3fdfa039c8da875cc94e81f7
[STATS] [DOC] Add @StatsDoc annotation for journal stats------Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785),--this PR is to document the journal stats.----*Changes*----- convert journal stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1870 from sijie/statsdoc_journal;7e047d93fc9b4407667c7a5d858dcd88a046598f
[STATS] [DOC] Add @StatsDoc annotation for bookkeeper autorecovery stats--Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document bookkeeper autorecovery stats.----*Changes*----- convert bookkeeper autorecovery stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Jia Zhai <None>--This closes #1879 from sijie/replication_stats;c0138f3758333877739f256303722dd892663979
[STATS] [DOC] Add @StatsDoc annotation for db ledger storage stats----Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document the db ledger storage stats.----*Changes*----- convert db ledger storage stats to use StatsDoc for documenting metrics----Master Issue: #1785----------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1874 from sijie/ldb_stats;fe7bed386af725e44621b534a6c516b743a15716
Add get method for rest endpoint gc--Descriptions of the changes in this PR:----Add get method for rest endpoint gc to get force triggered GC running status on Bookie.--true -- force triggered GC is running on Bookie. false -- not running.----### Motivation----This is base on PR #1838, and in the review comments sijie is suggested to add get methods.----### Changes----Add get method for rest endpoint gc and unit test.----------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1840 from jiazhai/rest_gc_get;e05850aad6d0cff0dcb143e90bbbedcc88b2caef
[STATS] [DOC] Add @StatsDoc annotation for memtable stats--Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document the memtable stats.----*Changes*----- convert memtable stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1873 from sijie/memtable_stats;6b7c2efc249783033965c6d79e0a5180a4083bef
[STATS] [DOC] Add @StatsDoc annotation for bookkeeper client stats------Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document bookkeeper client stats.----*Changes*----- convert bookkeeper client stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1878 from sijie/client_stats;f4bbc21d39a8af5947fafecb2a52febf8b478b9e
[STATS] [DOC] Add @StatsDoc annotation for interleaved ledger storage stats--Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document interleaved ledger storage stats.----*Changes*----- convert interleaved ledger storage stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1877 from sijie/interleaved_stats;132ecd74906d2336c31eaaa9ceb529c5cf26efdc
[STATS] [DOC] Add @StatsDoc annotation for bookie state manager stats------Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document bookie state manager stats.----*Changes*----- convert bookie state manager stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1876 from sijie/bookie_state_stats;d82163f6315bcd59bbb77deae59aa26e84763f37
[STATS] [DOC] Add @StatsDoc annotation for entrylogger stats--Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785),--this PR is to document the entrylogger stats.----*Changes*----- convert entrylogger stats to use StatsDoc for documenting metrics----Master Issue: #1785--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1871 from sijie/document_ledgerstorage_stats;e5cf9d4fe575bbb24fbd08d142a820362763b327
[CI] Update precommit job captions with trigger phrase------Descriptions of the changes in this PR:----*Motivation*----Sometime people don't know how to retrigger a bookkeeper precommit job.----*Changes*----This PR is adding the trigger phrase to the job caption. so people will know--how to retrigger the jobs in the PR itself.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1881 from sijie/update_jenkins_for_self_instructions;2c590322fdf27de008aae9fc98c405eaf2f27b1c
ISSUE #1770: Add local checker for Sorted/InterleavedLedgerStorage--The main goal of this patch is the ScrubberService LifecycleComponent--which runs in the background periodically verifying the internal--consistency of the LedgerStorage. To get that to work:----- LedgerStorage now has a localConsistencyCheck call with--implementations in Interleaved and Sorted.----- In service of that implementation, LedgerCache gains an interface for--iterating safely over the entries of a ledger with a way of handling--concurrently modified or deleted ledgers with corresponding--modifications to LedgerEntryPage for detecting deletion.----- EntryLogger has been refactored to permit checking the correctness--(and throwing a descriptive exception in case of a problem) of an entry--without actually reading it for use within localConsistencyCheck.----- The two mechanisms for iterating over a ledger's entries in--BookieShell have both been replaced with the new single implementation--(InterleavedLedgerStorageTest now has a test checking the output of the--affected command.)----- Misc changes to *LogCompactor to support tests in--InterleavedLedgerStorageTest.----Because the consistency check needs to run in the background and hold--LEP instances potentially for a relatively long time, a delete may--overlap with the scan of an LEP page. As part of this patch,--IndexInMemPageMgr and LedgerEntryPage now permit an LEP to be marked--deleted and not added back to the set of free pages until released.----This patch also adds an option to run the checker on startup (defaults--to false).----(bug W-5188823)--(bug W-5153309)--(rev cguttapalem)--Signed-off-by: Samuel Just <sjustsalesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1819 from athanatos/forupstream/wip-1770, closes #1770;9a0da5c5a667704afbb120c029cf1bb309ac985f
Ledger manager factories initialized with max metadata version--In dce4fd4 the max metadata format version was put in the--configuration which was then used to create ledger managers. This is--not safe though, as it there are multiple paths which through which--ledger manager factories are created and some may not see this--configuration modification. For example, on a new cluster where there--is no preexisting layout, the layout isn't written until after the--ledger manager factory has been created.----This patch changes LedgerManagerFactory#initialize to explicitly--require that the max ledger metadata format is specified in the call.----Master issue: #723--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1865 from ivankelly/explicit-max;dd684b30c734642dc1347cd931cb483de2ef4888
changingEnsemble should be negated before calling unset success--If the first pending add op is completed, but does not have the--replaced bookie in its write set, callbacks are triggered straight--away.----Previously this would then hang forever, as the changingEnsemble would--be true. This patch sets changingEnsemble to false before calling--unsetSuccessAndSendWriteRequest so that if callbacks are triggered--straight away, they can actually complete. It also moves the call to--unsetSuccessAndSendWriteRequest outside of the metadataLock so that--the callbacks don't run inside the lock.----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1857 from ivankelly/block-order;4c64b3c78d1120d3421a9f50abb9ec9ca97e8864
Fix selectFromNetworkLocation in RackawareEnsemblePlacementPolicyImpl----Descriptions of the changes in this PR:----Since beginning, selectFromNetworkLocation(excludeRacks, excludeBookies,..)--method kind of ignores predicate/ensemble passed to that method--https://github.com/apache/bookkeeper/blob/branch-4.7/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/RackawareEnsemblePlacementPolicyImpl.java#L694.----This was kind of ok, because so far effectively this method is called from only--one place - https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/RackawareEnsemblePlacementPolicyImpl.java#L612,--which passes TruePredicate.INSTANCE and EnsembleForReplacementWithNoConstraints.INSTANCE.----But it is not ideal to ignore those parameters in selectFromNetworkLocation(excludeRacks, excludeBookies,..),--from future usage perspective. So passing the received predicate and ensemble to the underlying calls.----Reviewers: Sijie Guo <sijie@apache.org>, Samuel Just <sjust@salesforce.com>--This closes #1862 from reddycharan/fixrackaware;df857dd678810e396ba44531e4c4546e67a0eb7a
[RELEASE] [WEBSITE] Add documentation for release 4.7.3--*Motivation*----Add documentation for release 4.7.3----Descriptions of the changes in this PR:----------Reviewers: Matteo Merli <mmerli@apache.org>--This closes #1859 from sijie/website_473;97dda46fec47e8e8e2e75bcfd35284adf00cf7ff
Update BookKeeper version in Docker file for 4.8.1 release--Descriptions of the changes in this PR:--Change version from 4.8.0 in 4.8.1 on Dockerfile in branch-4.8------### Motivation----Distribute new Docker images for 4.8.1 release------------Reviewers: Sijie Guo <sijieapache.org>----This closes #1851 from eolivelli/fix/docker-4.8.1--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1854 from eolivelli/fix/pick-481-docker;bfd77268a00787cbbc0dc43d665d94ca195c4652
[RELEASE NOTES] Release Notes for 4.7.3----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1850 from sijie/release_notes_473;41837e680e25ad80a802a2c4123bb0110e30155a
remove misleading comment----Descriptions of the changes in this PR:----*Motivation*----ParallelRead is actually used internally at ledger recovery. It is used at production.----*Changes*----Removed misleading comment.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1671 from sijie/remove_misleading_comment;b959f8f4d9363a11d27a28150b1fad54123d83cc
Add max ledger metadata format version to layout--The max ledger metadata format version is the maximum format version--that will be used to write ledger metadata. By setting it in the--ledger layout it becomes a cluster-wide configuration which is--initialized along with the cluster. Any cluster initialized with the--current code will end up with version 2. For this cluster serde will--only ever serialize with up to version 2 of the ledger metadata--format, so all clients that understand version 2 will continue to--work, even as the software version increases and new metadata formats--become available (such as the binary metadata format coming soon).----Currently there is no handling in LedgerMetadataSerDe, because we--don't have a new version, but when there is, it will use--```--Math.min(maxLedgerMetadataFormatVersion,--         metadata.getMetadataFormatVersion())--```--to decide which serialization method to use.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1858 from ivankelly/format-version;dce4fd4c16e5423a76a4be7aa76b23a52335c7fa
[TABLE SERVICE] remove extra code--Descriptions of the changes in this PR:--review code and found extra code.------### Motivation--clean code----### Changes----clean extra code----Master Issue: #<master-issue-number>--------Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1856 from xujianhai/master;e9699918d9ce0e5f8983387928ba14f64986e231
Mark 4.8.1 as latest release--Descriptions of the changes in this PR:----Change website configuration so that the downloads make suggest 4.8.1 and 4.8.0------------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1855 from eolivelli/fix/mark-481-latest;80a12e74276c455775e87e6fea3df4ed530c3850
Users of LedgerMetadata should use the api interface--All users to LedgerMetadata should use api.LedgerMetadata rather than--client.LedgerMetadata.----Some methods have been promoted to the interface to allow this.----Other methods have been moved out to a utility class that acts purely--on api.LedgerMetadata.----client.LedgerMetadata has been renamed to LedgerMetadataImpl.----Master issue: #723----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1852 from ivankelly/kill-store-ctime;8e0e9fb0fd2792bcce5ce9466ab5d2e1423f756f
LedgerMetadata should require digest and password together--There's never a case when setting the digest and password where you--only have one, but not the other.----The patch adds validation in LedgerMetadata that if you provide one, you--provide the other. The only case where you don't provide these is when --using pre-4.1.0 (i think) metadata.----Master issue: #281----Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1836 from ivankelly/builder-pw;4f8fae51802c0f51daaa6410fa929d671b58fbf5
[TABLE SERVICE] add a bookie registration based grpc name resolver--Descriptions of the changes in this PR:----*Motivation*----Table service is using grpc name resolver to figure out the alive servers serving table service.--Currently it is using default dns name resolver. In the context of Pulsar, since brokers talk--to bookies via zookeeper service discovery, it is making sense for brokers talk to table service--via zookeeper service discovery. So this PR is to add a bookie registration based grpc name resolver.----*Changes*----Implement a bookie-registration library based grpc name resolver.--------Reviewers: Jia Zhai <None>--This closes #1842 from sijie/add_zookeeper_resolver;02f706f18c6a76083bac4e0002f428d27bb8cbdb
Let OS choose port for vertx test--The previous implementation was searching for a open port by--repeatedly trying to startServer on ports starting at 8080. However,--after the first attempt fails, the Vertx instance in VertxHttpServer--is broken and the test hangs. 8080 is a very common port to have stuff--running on, so these hangs have happened to be repeatedly.----This fix is to allow the OS to choose the port, by specifying 0 as the--listening port and querying afterwards.----Issue: #1821----Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1853 from ivankelly/vertx-8080;b39564183eb8cab5ab21752843fe65a949fc96ff
Move serialization code out of LedgerMetadata--This PR moves the serialization code out of LedgerMetadata so that it--can later be adapted to run different serialization code depending on--the environment.----Notable non-refactor changes:--- LedgerMetadata#toString no longer uses #serialize because it's no--  longer available. Instead it uses the ToString helper from guava.--  byte[] fields are now base64 encoded.--- There's a new state enum and getter in api.LedgerMetadata. This is--  so that LedgerMetadataFormat can be removed from--  client.LedgerMetadata.----Master issue: #723----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1848 from ivankelly/refactor-md-serde;d6007edc419751378e5f7efb2a944693c1956401
Set default sizes of DbLedgerStorage read and write cache to be proportional to JVM direct memory----### Motivation----To simplify Bookie configuration when using `DbLedgerStorage`, set the memory size defaults for WriteCache, ReadCache and RocksDB block cache to be pegged to the available direct memory configured in the JVM.----User can always configure specific values and override this behavior.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1813 from merlimat/auto-conf-db-storage-mem;1285d20f5200a1a1e4e5ed7de4c712559c6123b4
[CI] increase timeout of website build to 120 mins------Descriptions of the changes in this PR:----*Motivation*----Since we have more releases, the build time for website is increasing to beyond 30 min.--Increase it to 120 mins for now--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1844 from sijie/change_website_buildtime;ce81fe85d55561b6569230b7fcb6b043c5d2615c
Rename LedgerMetadataBuilder#closingAt to  parameter order (#1835)--* Rename LedgerMetadataBuilder#closingAt to clarify parameter order----The two parameters are long, which can be confusing.----Master issue: #281;079013e6637ed3c3ea543cb2a094dbd5c8ee0e00
[STATS] Add @StatsDoc annotation for bookie server request stats------Descriptions of the changes in this PR:----*Motivation*----As part of [BP-36](https://github.com/apache/bookkeeper/issues/1785), this PR is to document the request stats--for bookkeeper server.----*Changes*----- add `parent` and `happensAfter` in StatsDoc--- convert bookie request stats to use StatsDoc for documenting metrics----Master Issue: #1785 --------Reviewers: Jia Zhai <None>--This closes #1839 from sijie/bp36_add_parent_and_happensafter;8979e9e0dc7f1c7e6bae2636c508ca529593e17a
[RELEASE] fix docker mount volume issue------Descriptions of the changes in this PR:----* Motivation---- #1674 introduced a regression for running release scripts on mac.-- the destination should be "/home/${USER}" rather than ${LOCAL_HOME}.-- because the docker os is linux. Otherwise the gpg keys can not propagated-- correctly from host machine to docker.----* Changes---- Use `/home/${USER}` as the destination path----------Reviewers: Jia Zhai <None>--This closes #1845 from sijie/fix_release_scripts;b0708b58f9d6490ed4e47ec688067bebdeb121aa
[LEDGER STORAGE] DbLedgerStorage should do periodical flush------Descriptions of the changes in this PR:----*Motivation*----DbLedgerStorage doesn't drive checkpoint itself. so currently DbLedgerStorage flush only--happens either when write-cache is full or entry log file rotated. The correctness is still--maintained. However the behavior is different from original yahoo behavior.----*Changes*----Revert the behavior back to original periodical flush--------Reviewers: Matteo Merli <mmerli@apache.org>, Jia Zhai <None>--This closes #1843 from sijie/dbledgerstorage_sync;d7fffac47f013a6902f9b61e8f8ffcb3ed29abff
Only publish suspect ledgers if they have missing fragments--This is a fix for a flake in--AuditorPeriodicCheckTest#testIndexCorruption. Auditor#checkAllLedgers()--runs a check on all ledgers, passing ProcessLostFragmentsCb as a--callback to LedgerChecker#checkLedger for each one.----LedgerChecker#checkLedger triggers the callback on completion,--regardless of whether there are fragments missing on not. Previously,--ProcessLostFragments was not checking if there were lost fragments--before publishing the ledger as suspected in zookeeper.----The flake triggered as there were always two ledgers that existed when--the check occurred, both would be reported as suspected, and it was--random which would be returned while polling for underreplicated--ledgers.----The fix is to check that something is actually underreplicated before--publishing.----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1834 from ivankelly/auditor-periodic-flake;dfbfa8d22844956be599c62f12ed13d8abe52696
Use ${sha1} instead of ${ghprbActualCommit} for Pre-commit Jobs--Descriptions of the changes in this PR:----### Motivation----According to  the documentation of the GitHub Pull Request plugin:--- ${sha1} means a commit which is the result of merging the PR branch with the target branch--- ${ghprbActualCommit} is directly the PR branch----So currently we are not testing the PR branch against the target branch, but only the branch "as it is"----see:--https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=4&ved=2ahUKEwje0PjpnuDeAhUF2SwKHXN4BgYQFjADegQIAxAB&url=https%3A%2F%2Fwiki.jenkins.io%2Fdisplay%2FJENKINS%2FGitHub%2Bpull%2Brequest%2Bbuilder%2Bplugin&usg=AOvVaw2XvPL5ynRYnqVEWqpe9cs1----### Changes----Use ${sha1} instead of ${ghprbActualCommit} for Pre-commit Jobs--------Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo--This closes #1818 from eolivelli/fix/jenskin-use-sha1;6d4e5c806ebcb593815ce23e21762cd0672de9cc
[UTILS] Move ReflectionUtils to bookkeeper-common module--Descriptions of the changes in this PR:----*Motivation*----RefelectionUtils contains helpers for loading classes from relections.--It is useful across the project. However the class is in `bookkeeper-server` module only.----*Changes*----Move this class to `bookkeeper-common` module--------Reviewers: Jia Zhai <None>--This closes #1841 from sijie/move_reflection_utils;5602c51192483075686746afb84c3449a470a98d
Add rest endpoint trigger_gc to trigger GC on Bookie--Descriptions of the changes in this PR:----Add rest endpoint trigger_gc to trigger GC on Bookie----### Motivation----Some times user would like to trigger GC manually instead of waiting to the timeout or disk full. --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1838 from jiazhai/rest_force_gc;641db3b4ff29d8e04216fee84625546707631e8e
Release notes for 4.8.1--Release notes for 4.8.1----The commit to review is d09296c589b8a188937833ca51a4b24ea337a901--------Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1795 from eolivelli/fix/481-release-notes;1a44de7c26f81e4e9070906853aab172cf2bee18
Remove MathUtils.now()--Descriptions of the changes in this PR:----*Motivation*----`MathUtils.now()` using System.nanoTime doesn't provide accurate time. It is used--for measuring pupose. However since `nanoTime` can have numeric overflow, so when--it is used for converting into milliseconds, it is misleading and error-prone. A--lot of places using `MathUtis.now` can all replaced with `System.currentTimeMillis()`.----It leads to unknown behavior on compactions. examples is shown in the following figure.----<img width="1157" alt="wechatimg180" src="https://user-images.githubusercontent.com/1217863/48965961-d860b600-ef7c-11e8-9394-1d51cef5c68c.png">----example: this graph shows the major_compaction_count. major compaction is supposed to run every day. but in the graph, there is no major compaction occuring in 4 days.----*Changes*----Remove `MathUtils.now()` and replace it with `System.currentTimeMillis()`.----------Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1837 from sijie/remove_mathutils_now;a32e29d66162b76a8dd6f58d3eacb7b62dd07ba2
Make custom metadata final--Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1833 from ivankelly/immut-cust;4019f75536d99d4af85269221811f2e41d4f8fae
Remove LedgerMetadata copy constructor--A copy constructor makes no sense when it's not possible to mutate the object.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1832 from ivankelly/kill-copy;4d3ffae69e96a0ed9b1fe68c43c5192565f56f1b
Prepare website structure for 4.8.1 release--Signed-off-by: eolivelli <eolivelliapache.org>----Descriptions of the changes in this PR:--------### Motivation----Prepare the wesite for 4.8.1 release----### Changes----Create the structure for docs for 4.8.1--------Reviewers: Sijie Guo <sijie@apache.org>--This closes #1790 from eolivelli/fix/site-481-structure;d02cf45f11b25fbdfdf3206790994a720688ceb3
Make LedgerMetadata fields for closing immutable--Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1831 from ivankelly/close-immut;9b3c6b73d8f667d52eb78025f07d3aedec6e9de0
Remove LedgerMetadata methods modifying ensembles--Remove any methods in LedgerMetadata that modify the ensemble. With--this change the ensembles are 100% immutable.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1830 from ivankelly/no-mod-ensemble;32ae78311c1a284551e2a6b6941d11d05fec097e
[SCRIPTS] improve bookkeeper script to better handle standalone command----Descriptions of the changes in this PR:--------*Motivation*----`bin/bookkeeper standalone` is broken when a release package is built without including `stream` profile.----*Changes*----`standalone` is a service component including everything. so fail the command if it can't locate corresponding components.----Related Issues: #1822----------Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1823 from sijie/refactor_bookkeeper_scripts;2a5e37c186387998aa0d7cf36766777d7e194151
Move utility method from LedgerMetadata to test--The method is only used in the test, so it should live there.----Master issue: #281----Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1829 from ivankelly/move-junk;b52869bfff2caf8d2fd525a25828e95a3014a2e9
Remove duplication logic for 'minNumRacksPerWriteQuorum' handling in RackawareEnsemblePlacementPolicyImpl--Descriptions of the changes in this PR:----With this change--https://github.com/apache/bookkeeper/commit/9ba4c4e0d8be770e03110a958fb8b75a65ae0f59--we introduced 'minNumRacksPerWriteQuorum' config option. To handle that, logic is added in--RackawareEnsemblePlacementPolicyImpl.newEnsembleInternal and RackQuorumCoverageSet. But in--retrospect, this is kind of duplicate logic and changes made in RackawareEnsemblePlacementPolicyImpl.newEnsembleInternal--is not really needed, because anyhow 'apply' of predicate (RRTopologyAwareCoverageEnsemble) is called, which calls--'apply' method on all the concerned RackQuorumCoverageSet.--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1810 from reddycharan/revertrackawarechanges;8c65088dcd019fa9fe17d39745ca1400ccf7bbbb
Make most LedgerMetadata fields final--Make most fields in LedgerMetadata final. The ones which I have not--changed in this patch require a more involved change, so they'll come--in separate PRs.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1828 from ivankelly/mostly-final;10df5e7f0f5b6554844f378757edd24e1f3b2fab
Remove LedgerMetadata constructors except one for builder--LedgerMetadata shouldn't generally be created outside the client,--except for testing. In the case where it is, the builder should be--used to construct it.----I've left the copy constructor for now, as I don't feel comfortable--removing it until all fields are final, which will occur soon.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1827 from ivankelly/kill-constructors;c6031e0bdc8002b9cae1e1a90d27a32d9e315d5b
Fix flake in AuditorPeriodicBookieCheckTest--The flake was occurring because the bookie checker was trying to--connect to a TCP endpoint that didn't respond (1.1.1.1) and was--waiting for the whole tcp connect timeout (10sec), while the test was--waiting 10 seconds for the success condition to occur. The success--condition often occurred just after the test fails.----The solution was to bring the connect timeout for the client down to--500ms, giving the auditor plenty of time to register the--underreplicated ledger.----I guess this used to pass in the past because maybe 1.1.1.1 was--actually rejecting packets instead of dropping them, and these changed--when cloudflare took over the address. I changed the endpoint to--192.0.2.0/24 range (TEST-NET) to avoid a similar scenario in the--future.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1826 from ivankelly/auditor-bookie-flake;ac7c567f81376dcf277467f2097a90c101de447b
LedgerMetadata#parseConfig uses Metadata Builder--parseConfig is one of the main places that mutates member fields of--LedgerMetadata. This change removes these mutates to make it use--LedgerMetadataBuilder instead.----Master issue: #281----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1825 from ivankelly/parse-builder;f49bd035db01f5b50df88c6c43329f7824984181
AbstractZkLedgerManager should catch all exceptions from parseConfig--And always complete the request if an exception does occur, rather--than throwing it out to the higher level, and hanging the request--forever.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1824 from ivankelly/catch-all-exception-zk;79bb0b1c8570359b2ac9b1e4a5c84ac3eca93496
Change LedgerManager to use CompletableFuture--All new uses of LedgerManager are creating GenericCallbackFutures to--pass in as the callback. This patch cuts out the middleman, and makes--LedgerManager return CompletableFutures itself.----The patch only touches the CRUD operations, and not--LedgerManager#asyncProcessLedgers, which I may tackle in a later PR.----Master issue: #281----Reviewers: Sijie Guo <sijie@apache.org>--This closes #1809 from ivankelly/metastore-futures;2260cb4d99990cdd3edbaa3591ea26c3643502de
Rollback snakeyaml version (Fixes IT tests)--The stats gen (#1787) change introduced a version of snakeyaml which--is incompatible with arquillian-cube (between 1.19 and 1.23 they--remove some methods).----This was picked up by the integration tests, but overriden to submit.----This change pins the snakeyaml version at 1.19, thereby allowing the--integration tests to run again.----Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1817 from ivankelly/fix-it;1a030239d6c3c221b140a02e3ef8ba137f709985
Introduce condensed encoding format for availabilityOfEntriesOfLedger--Descriptions of the changes in this PR:----- this condensed encoding format will take fewer bytes than initially--proposed bit vector.--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1814 from reddycharan/updatebpdoc;fe50b8c975acce46a2ed680c82de62cba36b058e
[BOOKIE] Fix sorted ledger storage rotating entry log files too frequent------Descriptions of the changes in this PR:----*Motivation*----A strong behavior was observed when using sorted ledger storage with single entry log manager on production:----"the entry log files are rotated very frequently and small entry log files are produced".----The problem was introduced due to #1410.----At current entry logger, when a new entry log file is created, EntryLogger will notify its listeners--that a new entry log file is rotated via [`onRotateEntryLog`](https://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogManagerBase.java#L152).----Before the change in #1410, `SortedLedgerStorage` inherits from `InterleavedLedgerStorage`.--So when a new entry log file is rotated, `SortedLedgerStorage` is notified.----However after the change in #1410, `SortedLedgerStorage` doesn't inherits `InterleavedLedgerStorage` anymore.--Instead, the relationship is changed to composition. `SortedLedgerStorage` is composed using an interleaved ledger--storage. So the entrylog listener contract was broken. `SortedLedgerStorage` will not receive any `onRotateEntryLog`--notification any more.----*Changes*----When `SortedLedgerStorage` initializes, it passes its own entry log listener down to the interleaved ledger storage.--So entry logger can notify the right person for entry log rotations.----*Tests*----Existing tests should cover most of the case. Looking for how to add new test cases.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Andrey Yegorov <None>--This closes #1807 from sijie/fix_rotation_behavior;deebe6db0c2fbd89cd7558e3a7ce76ec076aac5b
Fix cpu-affinity module build on jdk10+--Port tricks from circe-checksum to cpu-affinity module in order to make the build pass on JDK11--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1816 from eolivelli/fix/jdk11-cpu-affinity-build;0c623d54ed15102667d2d1ac389998a1ffdcf11c
Added BlockingQueue implementation based on JCtools--### Motivation----Add a `BlockingQueue` implementation that is suitable for low latency and low contention. ----Key points:-- * Optimized for multiple producers and single consumer-- * When waiting for entries, the thread is blocked with busy wait to avoid context switch.----(This will be used in subsequent PRs to optionally enable it)--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1682 from merlimat/blocking-queue;5997963d5b68d6fc6d341352fb40562eb92dab2b
Added module to enable CPU affinity--### Motivation----This is part of a set of changes aimed at reducing latency in BK at the expense of other aspects (eg: max throughput). While not intended to be used as default settings, they might be good to have whenever the latency becomes critical. ----Pinning a thread to a particular CPU will ensure no other process will execute on that CPU reducing all scheduler induced context switches that will cause latency jittery.----A given thread that wants to get pinned to a CPU just needs to call: ----```java--CpuAffinity.acquireCore();--```----It's called `acquireCore()` because it will also disable hyper-threading on the pinned cpu.----Subsequent PRs will use this module to have the option to pin critical threads to available CPUs.----### Changes-- * Added JNI module to call `sched_setaffinity()` to pin a thread to a particular CPU-- * Automatically discover available isolated CPUs-- * Acquire file-based locks to allow multiple processes on same machine to acquire CPUs independently.--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1641 from merlimat/cpu-affinity;dab8310f09c963112bb7a3efede5763ac35ee185
[STATS] introduce `StatsDoc` annotation for better documenting metrics exposed by bookkeeper--Descriptions of the changes in this PR:--------### Motivation----A common ask from people using bookkeeper is how they can monitor bookies and bookkeeper clients, what kind of metrics that bookkeeper exposes--and what are the important metrics. Currently bookkeeper doesn't provide any metrics page for guiding people on monitoring bookkeeper services.----In order to help people on this, we need to provide a few documentation pages about metrics. However if we just write such pages, those pages--can quickly get out-of-dated when code is changed.----### Changes----- Introduce an annotation `StatsDoc` for annotating the counters/gauges/opstats in the source code.--- Provide a tool to generate the stats and their documentation into a yaml file.----The yaml file will be used by the website for rendering a metrics reference page.----### Results----```--"server":--  "bookie_BOOKIE_READ_ENTRY_BYTES":--    "description": |---      bytes stats of ReadEntry on a bookie--    "type": |---      OPSTATS--  "bookie_WRITE_BYTES":--    "description": |---      total bytes written to a bookie--    "type": |---      COUNTER--  "bookie_BOOKIE_ADD_ENTRY":--    "description": |---      operations stats of AddEntry on a bookie--    "type": |---      OPSTATS--  "bookie_BOOKIE_RECOVERY_ADD_ENTRY":--    "description": |---      operation stats of RecoveryAddEntry on a bookie--    "type": |---      OPSTATS--  "bookie_BOOKIE_ADD_ENTRY_BYTES":--    "description": |---      bytes stats of AddEntry on a bookie--    "type": |---      OPSTATS--  "bookie_BOOKIE_FORCE_LEDGER":--    "description": |---      total force operations occurred on a bookie--    "type": |---      COUNTER--  "bookie_READ_BYTES":--    "description": |---      total bytes read from a bookie--    "type": |---      COUNTER--  "bookie_BOOKIE_READ_ENTRY":--    "description": |---      operation stats of ReadEntry on a bookie--    "type": |---      OPSTATS--```----Master Issue: #1786--------Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1787 from sijie/stats_generator;450f27ce3c80f78151bdd962c9deb31e92df6620
BP-36: Stats documentation annotation------Descriptions of the changes in this PR:----*Motivation*----A common ask from people using bookkeeper is how they can monitor bookies and bookkeeper clients, what kind of metrics that bookkeeper exposes--and what are the important metrics. Currently bookkeeper doesn't provide any metrics page for guiding people on monitoring bookkeeper services.----In order to help people on this, we need to provide a few documentation pages about metrics. However if we just write such pages, those pages--can quickly get out-of-dated when code is changed. The proposal here is to seek a programming way for generating metrics related pages.----Master Issue: #1785--------Reviewers: Sijie Guo <sijie@apache.org>, Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Andrey Yegorov <None>--This closes #1786 from sijie/bp_stats_generator;1590ca3c7056f878cf1d0c6298f277d4cd04315c
Move version out of LedgerMetadata--The version is a property of the metadata store and not of the--LedgerMetadata object itself. Putting it in the LedgerMetadata forces--that LedgerMetadata to be mutable, as it needs to be updated before--being sent to the LedgerManager.----This change moves version out of LedgerMetadata and modifies the--LedgerManager to use Versioned<LedgerMetadata>.----This is a large change, but almost purely mechanical.----TestHttpService has been modified to remove a preexisting flake in a--test which had to be modified for this change.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1797 from ivankelly/kill-set-version;9fd28d0cef37b0c69fb015a864c3629652e2aa38
[tools] package bookkeeper tools into a separated distribution--Descriptions of the changes in this PR:----*Motivation*----Server distribution contains a lot of stuffs that doesn’t need to run bkctl and bookkeeper shell, such as stats providers, http servers and many other dependencies.----At many environments, you want to deliver a set of tools to your customers to interact with or operate bookkeeper clusters. They don’t care about server side stuffs and ask them to use a server package to run a tool makes things confused.----*changes*----Create a new ‘bkctl’ package that only contains bookkeeper shell and new cli.----------Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1798 from sijie/package_bookkeeper_tool;8ad1e9031eca426324583d29b50d6c70046310d5
ISSUE #1799: bkctl is broken with default build options--Descriptions of the changes in this PR:----*Motivation*----`bkctl` is designed in a modularized way for extensibility.--it loads command groups via ServiceLoader. However current build--profile doesn't leverage this extensibility. Instead it hardcodes--all the commands in one service load file. So if `bkctl` is built--without `-Dstream`, it will broke.----*Changes*----- move `ledger` related commands to `tools/ledger`--- generate the service load file by concating `commands` files from each module's resources directory.----*Results*----bkctl works for all build profiles.----- without `-Dstream`----```--$ bin/bkctl----bkctl interacts and operates Apache BookKeeper clusters----Usage:  bkctl [flags] [command group] [commands]----Commands:----    bookie      Commands on operating a single bookie--    bookies     Commands on operating a cluster of bookies--    cookie      Commands on operating cookies--    ledger      Commands on interacting with ledgers----    help        Display help information about it----Flags:----    -c, --conf--        Configuration file----    -n, --namespace--        Namespace scope to run commands (only valid for table service for now)----    -u, --service-uri--        Service Uri----    -h, --help--        Display help information----Use "bkctl [command] --help" or "bkctl help [command]" for more information--about a command--```----- with `-Dstream`----```--$ bin/bkctl----bkctl interacts and operates Apache BookKeeper clusters----Usage:  bkctl [flags] [command group] [commands]----Commands:----    bookie          Commands on operating a single bookie--    bookies         Commands on operating a cluster of bookies--    cluster         Commands on administrating bookkeeper clusters--    cookie          Commands on operating cookies--    ledger          Commands on interacting with ledgers--    namespace       Commands on operating namespaces--    table           Commands on interacting with tables--    tables          Commands on operating tables----    help            Display help information about it----Flags:----    -c, --conf--        Configuration file----    -n, --namespace--        Namespace scope to run commands (only valid for table service for now)----    -u, --service-uri--        Service Uri----    -h, --help--        Display help information----Use "bkctl [command] --help" or "bkctl help [command]" for more information--about a command--```----Master Issue: #1799 --------Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1800 from sijie/refactor_bkctl, closes #1799;faeb9bb89c40045bd63681ecab662b838cdeec32
Fix bugs in DefaultEnsemblePlacementPolicy----Descriptions of the changes in this PR:----- bookieInfoMap is not initialized and newEnsemble will throws BKNotEnoughBookiesException if--diskWeightBasedPlacement is enabled--- add test coverage for DefaultEnsemblePlacementPolicy with diskWeightBasedPlacement enabled------Reviewers: Sijie Guo <sijie@apache.org>, Andrey Yegorov <None>--This closes #1788 from reddycharan/defaultplacementfix;398aa4cdc4b168f76d453fd74eda66182e24b21f
Fix indentation in BP-34 doc----Descriptions of the changes in this PR:----- just indentation fix------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1803 from reddycharan/bp34fix;3cc261a6ad819613026da6b856f1a1719b35d9bb
Fixed Auth with v2 protocol--### Motivation----BK auth framework is currently broken when using v2 protocol.----### Changes---- * Fixed auth when using V2 protocol-- * Made sure a client with authentication enabled can talk to a bookie without authentication. This is required in any case when enabling/disabling authentication on a live cluster.-- * Run all auth tests against both v2 and v3 protocol.----This should be included in 4.7.2 to give a path to upgrade.----cc/ rdhabalia --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1805 from merlimat/fix-v2-auth;dc2aaaa070d9a8d393409b69c80ad668b70f6d2b
[BUILD] Ignore `versionsBackup` file generated by `mvn versions:set`----Descriptions of the changes in this PR:----*Motivation*----`mvn versions:set` will generate files suffixed with `.versionsBackup`----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1801 from sijie/exclude_versionsbackup;86dda9a3872028d7d06fe43a148d0e7547e9b26f
[TOOLS] improve bkctl help message------Descriptions of the changes in this PR:----*Motivation*----Currently `bin/bktcl help` will output all command groups all together.--It is a bit hard to tell what command groups to use, especially some--commands are used for table service.----*Changes*----Introduce `category` in the cli spec to define which category that a--command group belongs to. So when it prints out the help message, it--can use that information to categorize the command groups together--to provide better user experience.----*Results*----```--$ bin/bkctl help--bkctl interacts and operates Apache BookKeeper clusters----Usage:  bkctl [flags] [command group] [commands]----Infrastructure commands :----    bookie          Commands on operating a single bookie--    bookies         Commands on operating a cluster of bookies--    cluster         Commands on administrating bookkeeper clusters----Ledger service commands :----    ledger          Commands on interacting with ledgers----Table service commands :----    namespace       Commands on operating namespaces--    table           Commands on interacting with tables--    tables          Commands on operating tables----Other commands :----    help            Display help information about it--```--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1793 from sijie/add_groups;843c0cc2fe73fc59d743e41dde81178608a29b8e
[TOOLS] add cookie related commands------Descriptions of the changes in this PR:----*Motivation*----In some use cases, you need cookie related tools to create/delete/update/get cookie when handling production issues.--Currently bookkeeper doesn't provide such commands.----*Changes*----Add cookie related commands----- create--- delete--- get--- update--- generate--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1794 from sijie/add_cookie_commands;e31e844505c59a9c119c6896a7f789db8f432dc2
Issue #1791: Read Submission should bypass OSE Threads--### Motivation----Profiling of our Bookkeeper Client code for read requests shows that client threads spend half of their time in dispatching requests to OrderedExecutors (just the dispatch itself, not the execution inside OSE): 54% of their CPU time is spent in OrderedExecutor.executeOrdered() (called by LedgerHandle.readEntriesInternalAsync()). The high time spend in request submission to OSE is largely caused by Linux scheduling cost, that is the cost of dispatching the OSE thread to CPU: 42% of total time (3/4th of executeOrdered() time), threads spend in Unsafe.unpark(), which is essentially Linux scheduling/dispatching of another thread.----### Changes----This change executes read submissions (PendingReadOp) on read-only ledger handles directly inside the client thread instead of submitting them to Ordered Executors.----Tests with a prototype have shown significant improvements in both overall CPU consumption as well as read latency. The additional work client threads have to do (the dispatch of the read requests to netty) is roughly the same as the (saved) dispatch cost to OSE, so the change turns out to be neutral for CPU consumption of client threads. In some experiments, the savings even exceed the additional work, and client threads consume less cpu even though they "do more". It also frees up lots of resources in OSE threads. Since it eliminates one context-switch in read submission and also avoids serialization of reads to the same ledger (or ledgers hashing to the same OSE), it also reduces read latency. For a mixed read-write workload (14,000 reads/sec on read-only ledgers, 4,000 writes/sec on another set of ledgers), this change has reduced CPU consumption of OSE threads by 25%, kept CPU consumption of client (and Netty) threads the same, and yielded a 6% improvement of read latency (as measured by BK Client).----Master Issue: #1791: Read Submission should bypass OSE Threads----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Andrey Yegorov <None>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1792 from nicmichael/DirectRead, closes #1791;6b99ff73278d4e655509f61ea44284e54716f5a8
Cache InetSocketAddress if hostname is IPAddress------Descriptions of the changes in this PR:----- in BookieSocketAddress if IPAddress is hostname then it is okay--to cache InetSocketAddress, since the canonicalhostname of the node--dont change.------Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Andrey Yegorov <None>--This closes #1789 from reddycharan/bookieaddressonlywhenhostname;102475a954eb0c00c1cc2ccf022db4b7c0bb9eea
Upgrade to Netty 4.1.31 and use individual dependencies--### Motivation---- * Upgrade to latest Netty version which brings in perf improvements and some new features (eg: https://github.com/netty/netty/pull/8267) ---- * Broke down the dependencies from `netty-all` into individual components, as discussed at https://github.com/apache/bookkeeper/pull/1755#discussion_r228449352------Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1784 from merlimat/netty-4.1.31;da3bd81ef8849589d63d6051c4f1dc86981c7436
Use default metric registry in Prometheus exporter--### Motivation----Currently the Prometheus exporter is using a private metrics register. This doesn't work well for BK client where we want to expose in the same registry of application, or when we want to interact with other tools that use the default static registry (eg: log4j, jetty integrations for prometheus).----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1765 from merlimat/prometheus;108747149e9ebc2380b0f92905edbe93034c075a
ISSUE #1767: security vulnerabilities in 3rd party dependencies--Descriptions of the changes in this PR:----Upgraded jline and jackson to remove security vulnerabilities mentioned in #1767 ----### Motivation----Remove security vulnerabilities mentioned in #1767 ----### Changes----Upgraded jline and jackson 3rd party dependencies----Master Issue: #1767 --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1777 from mptap/fix-1767-remove-vulnerabilities, closes #1767;40b0bd101dccd3cd9aefc8c3e915b34071ae1229
[TABLE SERVICE] [PYTHON] add default port to service hosts--Descriptions of the changes in this PR:----*Motivation*----Similar as #1778, add default port to service hosts if port is missing.----*Changes*----add default port to service hosts if they miss ports----Related Issue: #1778--------Reviewers: Jia Zhai <None>--This closes #1780 from sijie/fix_python_service_uri;911a08f7a3bcb82688f9d1a5b6ef7b86a615a2f9
[TABLE SERVICE] add default port to service hosts----Descriptions of the changes in this PR:----*Motivation*----Currently we have to add `4181` in the service uri in order to make it work.--Ideally it would be great that the system can fill the default port if port is missing.----*Changes*----add default port when parsing `ServiceURI`----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1778 from sijie/add_default_port;d13bffc0a2853b8d2876c3314f6732eaf576534a
[TESTS] Issue #1752: disable etcd tests in normal builds------Descriptions of the changes in this PR:----*Motivation*----apache/bookkeeper#1766 attempts to disable etcd tests in normal builds.--however it only added the `integrationTests` profile but didn't disable tests--in normal builds.----*Changes*----Disable etcd tests in normal builds----Master Issue: #1752 --------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1779 from sijie/run_etcd_tests_on_integrationtests, closes #1752;49924130d083015b788c43f057d66c993d343c82
Reduce stack traces in logs for common cases--### Motivation----For common "error" conditions the exception message is the only important bit while the stack traces are just adding clutter the logs files. ------Reviewers: Andrey Yegorov <None>, Sijie Guo <sijie@apache.org>--This closes #1776 from merlimat/master;b17b1657e938aa41d747fd49537559c4f29860de
[TABLE SERVICE] Fix python client can't read keys written by java clients--Descriptions of the changes in this PR:----*Motivation*----Python client is a thin table service client. So it relies on storage container--intercepting the requests to attach routing header. It attaches the routing header--if the requests are needed to route to remote containers; however for the local containers--it doesn't attach the right routing header.----*Changes*----Fix `StorageContainerImpl` to use proxy routing interceptor to intercept requests to attach routing header.----*Tests*----Add integration tests in python client & add test for python clients reading key/value pairs written by java clients.--------Reviewers: Jia Zhai <None>--This closes #1771 from sijie/remove_python23_incompatible_changes;f3b8c6a78f149e442e40a1e3d1d0583ebe306e36
[TESTS] Fix integration test TestCompatUpgradeYahooCustom.testUpgradeYahooCustom--Descriptions of the changes in this PR:----*Motivation*----apache/bookkeeper#1749 fixes bash script issue but it introduced `set -e` which--will fail `bin/bookkeeper` if grepping configuration file failed.----*Changes*----`set -e` is useful to fail fast if anything fails in the bash script. This change--is to mask exit code of `grep` operation, since the bash script already handle--the grep result.----*Tests*----Manually verified the change works. And the existing TestCompatUpgradeYahooCustom.testUpgradeYahooCustom--integration tests would also verify if the change fixes the problem or not.--------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Ivan Kelly <ivank@apache.org>--This closes #1772 from sijie/fix_common_scripts;676dc825efefe7222d8da11d9a7bcf15247f18eb
ISSUE #1757: prevent race between flush and delete from recreating index--IndexPersistencManager.flushLedgerHandle can race with delete by--obtaining a FileInfo just prior to delete and then proceeding to rewrite--the file info resurrecting it.  FileInfo provides a convenient point of--synchronization for avoinding this race.  FileInfo.moveLedgerIndexFile,--FileInfo.flushHeader, and FileInfo.delete() are synchronized already, so--this patch simply adds a deleted flag to the FileInfo object to indicate--that the FileInfo has become invalid.  checkOpen is called in every--method and will now throw FileInfoDeleted if delete has been called.--IndexPersistenceManager can catch it and deal with it appropriately in--flush (which generally means moving onto the next ledger).----This patch also eliminates ledgersToFlush and ledgersFlushing.  Their--purpose appears to be to allow delete to avoid flushing a ledger which--has been selected for flushing but not flushed yet avoiding the above--race.  It's not sufficient, however, because IndexInMemPageMgr calls--IndexPersistenceManager.flushLedgerHeader, which can obtain a FileInfo--for the ledger prior to the deletion and then call--relocateIndexFileAndFlushHeader afterwards.----Also, if the purpose was to avoid concurrent calls into--flushSpecificLedger on the same ledger, it's wrong because of the--following sequence:----t0: thread 0 calls flushOneOrMoreLedgers--t1: thread 0 place ledger 10 into ledgersFlushing and completes--flushSpecificLedger--t2: thread 2 performs a write to ledger 10--t3: thread 1 calls flushOneOrMoreLedgers skipping ledger 10--t4: thread 0 releases ledger 10 from ledgersFlushing--t5: thread 1 completes flushOneOrMoreLedgers----Although thread 1 begins to flush after the write to ledger 10, it won't--capture the write rendering the flush incorrect.  I don't think it's--actually worth avoiding overlapping flushes here because both FileInfo--and LedgerEntryPage track dirty state.  As such, it seems simpler to--just get rid of them.----This patch also adds a more agressive version of testFlushDeleteRace to--test the new behavior.  Testing with multiple flushers turned up a bug--with LedgerEntryPage.getPageToWrite where didn't return a buffer with--independent read pointers, so this patch addresses that as well.----(bug W-5549455)--(rev cguttapalem)--Signed-off-by: Samuel Just <sjustsalesforce.com>--(cherry picked from commit 7b5ac3d5e76ac4df618764cafe80aef2994703ec)----Author: --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1769 from athanatos/forupstream/wip-1757, closes #1757;41e4bccb9694e1f373e919f6891b8e88b2232c5e
Issue #1752: Etcd docker based tests are running on wrong jobs on CI------Descriptions of the changes in this PR:----*Motivation*----Fixes #1752 ----Etcd metadata driver is using testcontainer to run Etcd in containers for integration tests.--However this job is running as part normal build, which can cause container image being deleted--due to concurrent builds.----*Changes*----Move etcd metadata driver tests to be as part of `integrationTests`----Master Issue: #1752 -------Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1766 from codingwangqi/move_etcd_to_integration_tests, closes #1752;6c2d58ef059ad64d36c71b205061c2d6aefaab35
[WEBSITE] Fix broken link to ledger-api#example-application--Link should be to a section in same page--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1764 from merlimat/fix-docs-link;d9444ba143c9cdba4af427afdd9f0b696c1d7683
Kill LedgerMetadata#isConflictWith--It doesn't make sense anymore, as local copies of the metadata are--never modified, only updated with the latest version from the metadata--store.----In effect, this logic has been broken out to the places where we try--to update the metadata store copy. Each time we try to update the--metadata store, we ensure that the update we are applying still makes--sense with regard to the copy of the metadata we are updating.----Master issue: #281----Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1760 from ivankelly/kill-is-conflict-with;fcd63f9a78a59aa48c693b4491fc5241ed350ff6
[MERGE SCRIPT] remove authors section------Descriptions of the changes in this PR:----*Motivation*----We are using github api to merge pull requests now.--So the authors section is not correct, remove that section and rely on github merge api.----*Changes*----remove authors section in the commit log.----------Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1758 from sijie/fix_merge_scripts;86fd29525266dbdb8fcb7950321d99c1b565bebf
Don't cache Bookie hostname DNS resolution forever--### Motivation----`BookieSocketAddress` is resolving the bookie DNS name in its constructor and then using the already resolved `InetSocketAddress` instance.----If the IP of a bookie changes, the BK client will continue to use the old IP address.----### Changes----Construct a new `InetSocketAddress` each time `getSocketAddress()` gets called (eg: each time we attempt to make a new connection) so that we're making sure to get the right IP.----I cannot think of a good way to add unit test for this at this point, suggestions are welcome. ----I think this should be included in a patch release as well 4.7.3 or 4.8.1--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Ivan Kelly <ivank@apache.org>--This closes #1762 from merlimat/fix-dns;3d8bad44a40ce5cb173df5dfd7cb06d81bed26e1
Remove LedgerMetadata#getEnsembles in favour of #getAllEnsembles--They do the same thing except that #getEnsembles returns a TreeMap--while #getAllEnsembles returns a NavigableMap.----LedgerMetadata#getAllEnsembles is part of the api interface.----Master issue: #281----Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1759 from ivankelly/remove-get-ensembles;f52d5dd11bb1e6059fbc841e41b242a828a8b768
Use immutable metadata in LedgerHandle--Which means that for the two LedgerHandle operations that mutate the--metadata, ensemble change and closing, ensure that metadata is written--to the metadata store before the client ever uses it.----Master issue: #281--Author: Ivan Kelly <ivank@apache.org>-Author: Sijie Guo <guosijie@gmail.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>, Samuel Just <sjust@salesforce.com>--This closes #1646 from ivankelly/immutable-handle-failures;6bf69714ed2e336499bec7d3513773bf8a4f2a02
Modules dependencies do not need to be included in checksum Jar--The current assembly configuration is including the jars of the modules dependency inside its own jar.----These jars are completely ignored, but they take up non trivial space.----With this change the size of `circe-checksum.jar` goes from 2.8 MB to 62 KB.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1751 from merlimat/master;2f73da607714b622ef5aafbf073d46b55dea89a4
Adding multi-node ZKCluster test util class------Descriptions of the changes in this PR:----- adding multi-node ZKCluster util class--- adding new interface for ZKCluster util and having separate implementaions for--single node ZKCluster and multi-node ZKCluster----### Motivation----This helps in adding more test coverage to Zookeeper aspects.--Author: Sijie Guo <guosijie@gmail.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: cguttapalem <cguttapalem@salesforce.com>-Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1753 from reddycharan/multinodezkcluster;afb62329a85ef8c28c013a9f8a195dc22cbd3ad9
Netty allocator wrapper--### Motivation----Configuring the correct JVM memory settings and cache sizes for a BookKeeper cluster should be simplified.----There are currently many knobs in Netty or JVM flags for different components and while with a good setup the systems is very stable, it's easy to setup non-optimal configurations which might result in OutOfMemory errors under load.----Ideally, there should be very minimal configuration required to bring up a BookKeeper cluster that can work under a wide set of traffic loads. In any case, we should prefer to automatically fallback to slower alternatives, when possible, instead of throwing OOM exceptions.---- * Provide a wrapper to have a single unified configuration point for Netty allocator configuration.-- * Provide fallback policy when dealing with direct memory OOM errors----### Changes---- * This is the first PR. It only contains the allocator wrapper implementation. Subsequent PR will add the changes to use it.-- * Added `bookkeeper-common-allocator` module to have a no-dependencues module that can be used directly from Pulsar client library too (which doesn't depend on BK).----Author: Sijie Guo <guosijie@gmail.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Matteo Merli <mmerli@apache.org>-Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: Samuel Just <sjust@salesforce.com>--Reviewers: Qi Wang <None>, Sijie Guo <sijie@apache.org>, Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1754 from merlimat/allocator;379d2ba8570eed1f92f8a468158f1a2d0861aaa6
[BUILD] Fix build & bash script error when not using `stream` profile--Descriptions of the changes in this PR:----*Motivation*----There are two issues in current master when building without stream----- build `bkperf` failed--- bin/bookkeeper is using the wrong module----*Changes*----- build `bkperf` module as part of `stream` profile--- fix the problem in `bin/bookkeeper` locating the right module--- add two tests in travis to test builds without `stream` profile--------------Author: Sijie Guo <guosijie@gmail.com>-Author: Sijie Guo <sijie@apache.org>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #1749 from sijie/fix_build_without_stream_profile;7016d0af6850ae565cc674a6d286782bbb5ba33a
Set ConnectionExpired Listener to MetadataClientDriver in AR----Descriptions of the changes in this PR:----- add setConnectionExpiredListener method to MetadataClientDriver interface.--- add listener to shutdown AR in the case of metadata connection expiry------### Motivation----This commit - 4f0d2a195bd9be3788876b47813cee1440cf005c, has removed the shutdown logic in AutoRecoveryMain incase of ZK client session expiry, with the following reason "which doesn't make any sense for current retryable zookeeper". But if the ZK session has expired then it is not completely correct to let AutoRecoveryMain to continue to run in that state.--Author: Sijie Guo <guosijie@gmail.com>-Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: cguttapalem <cguttapalem@salesforce.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1747 from reddycharan/conexpirylisten;345ee95ff5c1431c382ecd4ba8cae3bfed457d6d
[TABLE SERVICE] [CLIENT] storage client can open tables on a different namespace--Descriptions of the changes in this PR:------*Motivation*----In some cases, we are using same storage client for opening tables under different namespaces.--It would be good that a client instance can do that.----*Changes*----- Add methods to `StorageClient` to open tables under different namespaces--- Add `asClient` to `StorageAdminClient` to convert admin client to storage client----------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1733 from sijie/improve_client_interface;26c77d24f848a42c8e339820dbea869233f9475e
ReadEntryCallback in ReadLedgerEntriesCmd shouldn't release buffer.------Descriptions of the changes in this PR:----- ReadEntryCallback in ReadLedgerEntriesCmd shouldn't release buffer,--which is not owned by the callback.----### Motivation----with the following change, Per channel bookie clients owns the buffer for read responses. So it is not correct for ReadEntryCallback in ReadLedgerEntriesCmd to release buffer--https://github.com/apache/bookkeeper/commit/8d048abce486c63d428041f77ee9a506756f4d1e#diff-e50ee2c1aec1539ea185a94605b0e550R1611----because of this issue I'm seeing following error with ReadLedgerEntriesCmd--```--/Workspace/SFStorage/bookkeeper/bookkeeper-server/bin$ ./bookkeeper shell -localbookie readledger -bookie ****  -ledgerid 00000000-0000-0000-0000-000000000003 -firstentryid 1 -lastentryid 3--JAVA_HOME not set, using java from PATH. (/usr/bin/java)------------- Lid=00000000-0000-0000-0000-000000000003, Eid=1 -----------18:32:03,724 ERROR Unexpected throwable caught --io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1--	at io.netty.buffer.AbstractReferenceCountedByteBuf.release0(AbstractReferenceCountedByteBuf.java:100) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]--	at io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:84) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]--	at org.apache.bookkeeper.proto.PerChannelBookieClient$ReadCompletion.handleV3Response(PerChannelBookieClient.java:1699) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at org.apache.bookkeeper.proto.PerChannelBookieClient$3.safeRun(PerChannelBookieClient.java:1286) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [bookkeeper-common-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]--	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]--	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.22.Final.jar:4.1.22.Final]--	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]------------- Lid=00000000-0000-0000-0000-000000000003, Eid=2 -------------18:32:03,733 ERROR Unexpected throwable caught --io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1--	at io.netty.buffer.AbstractReferenceCountedByteBuf.release0(AbstractReferenceCountedByteBuf.java:100) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]--	at io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:84) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]--	at org.apache.bookkeeper.proto.PerChannelBookieClient$ReadCompletion.handleV3Response(PerChannelBookieClient.java:1699) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at org.apache.bookkeeper.proto.PerChannelBookieClient$3.safeRun(PerChannelBookieClient.java:1286) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [bookkeeper-common-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]--	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]--	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]--	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.22.Final.jar:4.1.22.Final]--	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]--```--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Andrey Yegorov <None>--This closes #1736 from reddycharan/readledgerfix;5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c
ISSUE #1737: EntryMemTable.newEntry: always make a copy--Retaining a reference to that array assumes that the caller--won't reuse the array for something else -- an assumption--violated by Journal.scanJournal and probably other callers.----(bug W-5499346)--(rev cguttapalem)--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: --Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1744 from athanatos/forupstream/wip-1737, closes #1737;df6595804cb1d78f5b531ae2db3a7c751439eb1c
[TABLE SERVICE] [TESTS] add integration tests for python clients--Descriptions of the changes in this PR:----*Motivation*----We need have test coverage for python clients.----*Changes*----- add scripts to run python client tests for different python versions--- make sure the client can be built on both python2 and python3--- add a postcommit job to run python tests--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1742 from sijie/python_integration_tests;c5c5795fc737bbfa52f130d83a2fa2ede9bd581a
ISSUE #1703: IllegalReferenceCountException at closing EntryLogManagerForSingleEntryLog--Descriptions of the changes in this PR:----*Motivation*----Fixes #1703.----The active entry log channel in EntryLogManagerForSingleEntryLog is closed twice during shutdown.--One is by EntryLogManagerForSingleEntryLog#close and the other one is EntryLogManagerForSingleEntryLog#forceClose().----*Changes*----This change is adding logic in BufferedChannel to make sure BufferedChannel can be closed multiple times.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>, Andrey Yegorov <None>--This closes #1735 from sijie/issue_1703, closes #1703;ba6d3ee3d0005c809d926f952b1c1b4d33215dd5
Issue #1738: Journal: add a metric for the time ForceWriteRequest spent in the queue--### Motivation----Investigated latency spike in one of the bookie clusters.--At some point the question at hands was "how much time ForceWriteRequests spend in the queue in this case".--There is no metric to answer this question.----### Changes----Added new metric.----Master Issue: #1738 --------Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1739 from dlg99/fix/forcewrite-metric, closes #1738;125fdb9761ffaaf5551d5e192d82b23fe555165f
Issue #1740: IOUtils.close() only accepts Closeable as a vararg which results in unnecessary Object[] created if only one Closeable passed there--Descriptions of the changes in this PR:----added close() variant that takes one Closeable.----### Motivation----100% of close() usage is with one Closeable.----### Changes----light refactoring.----Master Issue: #1740 --------Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1741 from dlg99/nit/ioutils, closes #1740;117ba4d7e2965f520d98a96a6ada7af54d9947ce
[TABLE SERVICE] [CLIENT] provide scripts for uploading python clients to pypi--Descriptions of the changes in this PR:----*Motivation*----make the python client available for usage----*Changes*----- update README and setup.py--- set the client version to `4.9.0-alpha-0`--- scripts to build python client and upload it to pypi----*Result*----https://pypi.org/project/apache-bookkeeper-client/4.9.0a0/--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1734 from sijie/upload_python_client;ece38f5994fd30d1f132e6f45ae15a406cc926bf
Introduce lifecycle components for managing components in AutoRecovery----Descriptions of the changes in this PR:------- lifecycle components for managing components in AutoRecovery--- expose metrics of AR in the same http admin endpoint----Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1726 from reddycharan/stackar;3c3416669d750b70d4f9c0e3ac1c704b77b45023
[TABLE SERVICE] [STATS] enable stats for grpc calls on both client and server--Descriptions of the changes in this PR:----*Motivation*----We need visibility on both client and server on table service.----*Changes*----- introduce grpc monitoring interceptors for both client and server--- enable monitoring interceptors on both client and server--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1731 from sijie/grpc_stats;97c6656a9600d20763202ee6a7946383da1bd712
[TABLE SERVICE] [CLI] improve table service related cli commands--Descriptions of the changes in this PR:----*Motivation*----Add missing commands for table service related operations.----*Changes*----- Add missing commands such as get/delete--- Fill the default service uri if it is not provided--- Define the command ops in `Commands` util class--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1724 from sijie/improve_console;cb7b0916978725e4f42814c9ba5824b5dd1b0209
Add Oracle JDK11 to Travis CI build--Descriptions of the changes in this PR:----### Motivation----Start testing builds on JDK11, as it is the latest available version of Java ----### Changes----Add Oracle JDK 11 to Travis configuration file----Master Issue: #1710--------Author: --Reviewers: Sijie Guo <sijie@apache.org>--This closes #1732 from eolivelli/fix/travis-jdk11;9b00ef3760a96ddce7e49e6cfdf2f7740554aaa9
[TABLE SERVICE] [STORAGE] improve the logic on creating the meta range for a table--Descriptions of the changes in this PR:----*Motivation*----Currently the creation of meta range for table is deferred until we first try to use it.--The propagation of stream properties is carried by the client.----*Changes*----Improve the creation logic to fetch stream properties from the root range.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1730 from sijie/cache_stream_props;897c643e4248fc9fd716c3124b007aa8c540b6ff
Fix Kerberos tests on JDK11:----Descriptions of the changes in this PR:--- move to Kerby (MiniKDC code copied from Apache ZooKeeper repository)--- adapt tests to run with new KDC--- force TCP on krb5.conf for tests (this is needed for Kerby, which opens only TCP by default config)------Master Issue: #1710 --------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1716 from eolivelli/fix/kerby-11;b6db915f7b787b100a4feeb5999bf288cf8737ed
Enhance Auditor----Descriptions of the changes in this PR:----- store last checkAllLedgers executed time in metadataserver.--- use that value for determining the initialDelay of checkAllLedgers call--- add dedicated metric for bookieCheck--- add more log lines in Auditor------### Motivation----In Auditor checkAllLedgers is scheduled to run for every ‘auditorPeriodicCheckInterval’ and with initial delay of ‘auditorPeriodicCheckInterval’. But the problem is if Auditor role keeps transforming to another AR process, it might not get chance to do ‘checkAllLedgers’ task. Considering default value for 'auditorPeriodicCheckInterval' is 1 week, it is not uncommon situation.----### Changes----Thats why I'm planning to persist last successful checkAllLedgers execution ctime in ZK, so that next time when a new AR becomes Auditor, it would use that as reference to decide the initial delay value.----Author: cguttapalem <cguttapalem@salesforce.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1683 from reddycharan/auditormetricslogs;4dac14b7ff3844b1d7e41515162c44f0e1ab9a1f
[TABLE SERVICES] [PERF] Provides a simple perf tool for testing put and inc performance--Descriptions of the changes in this PR:----*Motivation*----Need to know what is the performance of table service.----*Changes*----Provide a simple perf tool following what RocksDB is doing. Currently support simple testing for put and inc operations.----------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1727 from sijie/async_benchmark;c5cd2aac5430382767f54fd8c3f62c86f6322ab2
Decorate OrderedExecutor threads rather than runnables--Actually, decorate the runnables too, but apply the decoration in a--decorator on the thread so that if a runnable/callable is passed to--the thread, the decoration will be applied.----This allows users of OrderedExecutor/Scheduler to use--executor.chooseThread() for CompletableFuture async handlers and still--get things like the MDC context.----Author: --Reviewers: Andrey Yegorov <None>, Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1729 from ivankelly/decorate-exec;0ee2c042a6c0430624fb6db8393dab5a7128a176
[TABLE SERVICE] [CLIENT] Implement the python client to access tables--Descriptions of the changes in this PR:----*Motivation*----Providing a python client to access tables----Fixes #1690----*Changes*----Implement the python client to access tables using the table grpc requests--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1723 from sijie/python_client;bbddabcb0b77316558c3cd12fbaf7d6559b6974d
[TABLE SERVICE] [CLIENT] Provide a simple version of storage clients--Descriptions of the changes in this PR:----*Motivation*----The PR #1721 provides a routing service for proxying grpc requests--to the correct storage container. That means that the storage client--can be implemented using simple grpc calls since all containers can--serve same grpc requests.----*Changes*----Implement a simple version of storage clients by using server-side--routing to route grpc requests to the correct storage containers.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1722 from sijie/proxy_table_requests2;337b4c04aee608ff3fb5efb74c52d2445b6b6b81
Add optional compile time only annotations-api dependency dropped in JDK11--Descriptions of the changes in this PR:----### Motivation----Java Annotations API has been dropped from JRE since JDK11. We should add it explicitly at compile time.--As we are using only the 'Generated' annotation, which has "source" retention when can add the dependency as 'optional'.--We are not re-distributing the JAR in binary packages.----### Changes----Add 'optional' dependency wherever it is needed (all GRPC artifacts for instance)----Master Issue: #1710--------Author: Sijie Guo <guosijie@gmail.com>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1725 from eolivelli/fix/jdk11-add-annotations-api;7da429ea0e4f29b11da532f269196047162053ef
[TABLE SERVICE] [STORAGE] add routing table for proxying table service requests--Descriptions of the changes in this PR:----*Motivation*----In order to implement non-java clients and avoid the complexity in the client implementation.--We need to proxy a routing table in the server side for proxying table service requests.----*Changes*----Add routing table in the service side to proxy grpc requests to the right storage containers.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1721 from sijie/add_routing_table;3446c2cdb9c49ab5f547657a5d12e92022b56721
[TABLE SERVICE] Intercepted storage server channel should shutdown the underlying managed channel--Descriptions of the changes in this PR:----*Motivation*----When a storage server channel is intercepted, the underlying channel will not be `ManagedChannel`--any more. so closing storage server channel will never close the underlying managed channel.----*Changes*----StorageServerChannel#intercept should keep reference to the original storage server channel.--so when closing the intercepted channel, it can close the original channel.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1720 from sijie/close_intercepted_channel;580d29e47052fad058456c5028debe75701ea3a8
[TABLE SERVICE] [COMMON] add BytesHashRouter--Descriptions of the changes in this PR:----*Motivation*----Currently the hash router takes `ByteBuf`. At some cases,--we need to compute the hash of bytes array directly.----*Changes*----Add `BytesHashRouter` to compute hash value of bytes array directly,--avoiding wrapping bytes into `ByteBuf`--------Author: Sijie Guo <guosijie@gmail.com>-Author: Enrico Olivelli <eolivelli@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1719 from sijie/bytes_hash_router;443b24a630500cd248041de4583f09dbce90c398
[INTEGRATION TESTS] Dump container logs before stopping tests--Descriptions of the changes in this PR:----*Motivation*----For debugging purpose, it would be great to dump container logs before--stopping tests.----*Changes*----Copying container and bookkeeper logs before stopping the tests.----------Author: Sijie Guo <guosijie@gmail.com>-Author: Enrico Olivelli <eolivelli@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1718 from sijie/dump_container_logs;dd1c8e0794786ea2e87918df451f912d84098a67
[TABLE SERVICE] [CLIENT] Provide a timeout mechanism on closing the client--Descriptions of the changes in this PR:----### Motivation----Closing the storage client sometime takes long time. And closing the client typically happens at the last step. So we don't necessarily to be blocking at waiting it to complete.----### Changes----Provide a timeout version of sync close. And timeout the closing operation if it doesn't complete within 1 second.--------Author: --Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1717 from sijie/close_storage_client;0c4accbce977fbc6191689bcb5792e2a3563eb78
[TOOLS] [PERF] Add a `segread` perf command to read distributedlog streams in segment splits--Descriptions of the changes in this PR:----*Motivation*----Find what is the bottleneck/throughput limit of reading a single ledger.----*Changes*----Provide a `segread` perf command to split a stream into a list of segments and split segments into splits,--and test reading segment splits in parallel.--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1713 from sijie/segment_readers;7f2564c49d6ad7795908886433d3afcc4155c9d9
Fix release notes for 4.8.0--Descriptions of the changes in this PR:----- Fix a bunch of typos and indentation issues on 4.8.0 release page--- Fix releases.md----------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1714 from eolivelli/fix/release-notes-480-2;e2e3912dac624c9e892b6775dbe267b603f1887b
[LOGGING] PendingReadOp should log the error code when failing requests--Descriptions of the changes in this PR:----*Motivation*----Currently when a request is failed, bookkeeper client logs the error message. However the log--message doesn't include error code. It makes debugging hard.----*Changes*----Improve the log message to include error code----------Author: --Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1709 from sijie/improve_error_logging;33e9d27beb857834e4dc7b5ca3b69bff9d89bb9f
Upgrade Mockito to 2.22.0 in order to support build on JDK11--Descriptions of the changes in this PR:--------### Motivation----Running tests on JDK11 requires a new version of Mockito, because in JDK11 they dropped Unsafe.defineClass.----### Changes----Upgrade Mockito----Master Issue: #1710--------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1711 from eolivelli/fix/upgrade-mockito;1f0bc8cabd7fd25af142f4963310b5205b146ceb
[TABLE SERVICE] introduce a client interceptor to attach routing information for table service rpc calls----Descriptions of the changes in this PR:----*Motivation*----Currently java client deals with request routing and attach routing information before sending the request.--If we try to apply same mechanism for non-java language clients, it requires implementing this complex--routing logic for every non-java language client, which is not a desirable solution.----So we should move the request routing to the server side, which can simplify the implementation of non-java--language client.----*Changes*----Introduce a client interceptor which intercepts table service rpc calls and mutating the rpc request with--correct routing information. This interceptor can be used at server side for proxying grpc requests.--------Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Sijie Guo <guosijie@gmail.com>-Author: Sijie Guo <sijie@apache.org>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Jia Zhai <None>--This closes #1708 from sijie/proxy_requests;ea334eab4a95654ec6a15b7c23aaf4c8c79ba11c
Issue #1696: fixed potential ConcurrentModificationException in mock in MdcContextTest--Descriptions of the changes in this PR:----Changed LinkedList to ConcurrentLinkedQueue to avoid potential ConcurrentModificationException in callbacks.----### Motivation----Test flapped.----### Changes----(Describe: what changes you have made)----Master Issue: #1696 --------Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Sijie Guo <guosijie@gmail.com>-Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Venkateswararao Jujjuri (JV) <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1699 from dlg99/fix/issue_1696_MdcContextTest, closes #1696;7d7c88e46baf17c2893585c6d7d958df6e92f0c0
Update Docker File to use 4.8.0 and signature from eolivelli@apache.org--Descriptions of the changes in this PR:----Update docker image to latest and greatest BookKeeper version----------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1707 from eolivelli/fix/update-docker-480;890808a765e2869289104cc9c332eb6d2f539fb4
Release notes for Apache BookKeeper 4.8.0--Update the website with the releases notes for Apache BookKeeper 4.8.0--------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1676 from eolivelli/fix/release-notes-480;79709a48dcf8b56a0f7e83e5c4fcf8aa23cab628
[TABLE SERVICE] improve the bookkeeper script to better detect whether table service is enabled or not--Descriptions of the changes in this PR:------*motivation*----Currently `bin/bookkeeper` automatically choose modules based on the command.--However it would be much better to detect which module to use by checking the bookkeeper configuration settings.----*changes*----Improve `bin/bookkeeper` to better detect which module to use based on bookkeeper server configuration.--Additionally adding dlog related settings in the server configuration file.----------Author: Sijie Guo <guosijie@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1705 from sijie/improve_bookkeeper_scripts;a04642bb2baede4fe6c2dbfe8eb89abf120f2f28
[TABLE SERVICE] [LOGGING] improve logging at zk storage container manager--Descriptions of the changes in this PR:----*Motivation*----the storage container manager probes containers to ensure containers are started and stopped to reflect to topology change.--however the logging can be very annoying if there is no topology changed.----*Changes*----Improve the logic to only log the message when topology is changed.--------Author: Sijie Guo <guosijie@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Sijie Guo <sijie@apache.org>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1704 from sijie/reducing_logging_storage_containers;fa2f19d076cde5514a5f24613045b14a491871d4
autorecovery-use-metadata-driver (part 3) : remove zookeeper from Auditor class--Descriptions of the changes in this PR:----This is the 3rd change to remove zookeeper from Auditor. It also changes how--we construct metadata driver from AutoRecoveryMain. Since we are using bookkeeper client--and admin across auditor and replication. So change the AutoRecoveryMain to construct--the bookkeeper client from client configuration and pass bookkeeper client down to--replication worker and auditor.--------Author: Qi Wang <codingwangqi@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Sijie Guo <guosijie@gmail.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1695 from codingwangqi/autorecovery_metadata_part3;2837f6257baf15dc9dd9eb4bcac34596b442be33
Issue #1700: fixed: TimedRunnable does not anticipate exception from wrapped runnable--Descriptions of the changes in this PR:----added try/finally around runnable.run()----### Motivation----To correctly track (metrics/log) runnable that throw unexpected exception.----### Changes----added try/finally around runnable.run()----Master Issue: #1700 --------Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Sijie Guo <guosijie@gmail.com>-Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1702 from dlg99/fix/issue_1700_timedrunnable, closes #1700;d8e0a9aa6097eacd13afc2898f89627a15e59e02
[BUILD] Ignore pid files----Descriptions of the changes in this PR:------*Motivation*----when running bookkeeper servers using `bin/bookkeeper-daemon`, `pid` files--will be added in current directory.----*Changes*----Add `.pid` in `.gitignore`, so those pid files will be ignored.--------Author: Sijie Guo <guosijie@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1706 from sijie/ignore_pid_files;e4f1d848714fddb86d5ebf9832a8605074e63ec4
[TOOLS] Add a perf tool for benchmarking bookkeeper--Descriptions of the changes in this PR:----### Motivation----when investigating performance on scanning entries in bookkeeper, it is hard to know what is the expectation of what kind of throughput that application can get. we need a perf tool to understand the baseline of performance that bookkeeper can provide.----### Changes----this tool is following what pulsar perf tool is doing and using dlog library for evaluating the write and read throughput on bookkeeper using one (or a few) dlog streams.--------Author: Sijie Guo <sijie@apache.org>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1697 from sijie/bkperf;c02e0fbd2a0618b9a4e40c995a186f003ab9070b
[TABLE SERVICE] [PYTHON] add hash router for computing the hash routing value for a given key--Descriptions of the changes in this PR:----*Motivation*----As part of implementing python client for #1690, we need a hash router to compute the hash routing value--for a given key.----*Changes*----- Murmur2 is not well supported in python 3. so standarized hash computation in using Murmur3.--- Change java hash router to use Murmur3--- Add python hash router--- Add unit tests to cover the hash value computation and make sure it is consistent across java and python----Master Issue: #1690 --------Author: --Reviewers: Jia Zhai <None>--This closes #1698 from sijie/message_router;bb818f2c5cf1a92cb45b2e69a9be452708785cad
autorecovery-use-metadata-driver (part 2) : remove ZooKeeper from ReplicationWorker--Descriptions of the changes in this PR:----*Changes*----This is the second part of changing AutoRecovery to use metadata driver. It removes--the zookeeper reference from ReplicationWorker, because the zookeeper instance is not--used anyway----This change is based on #1693 -------Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: Qi Wang <codingwangqi@gmail.com>-Author: Sijie Guo <guosijie@gmail.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1694 from codingwangqi/autorecovery_metadata_part2;cd85888086a819b20325d997680abe91ac3e786e
Enable storeSystemTimeAsLedgerUnderreplicatedMarkTime------Descriptions of the changes in this PR:----- Enable the Auditor to use system time as underreplicated ledger mark time.--If this is enabled, Auditor will write a ctime field into the--underreplicated ledger znode.----https://github.com/apache/bookkeeper/commit/f4094c4992d5b22630fa633085a00a9152b87ffe introduced feature to Record ctime for underreplicated ledger mark time.--Author: Sijie Guo <guosijie@gmail.com>-Author: Qi Wang <42832902+codingwangqi@users.noreply.github.com>-Author: cguttapalem <cguttapalem@salesforce.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1692 from reddycharan/enablectime;af246529b0728087b1c65a50b919abe7d4b5103f
autorecovery-use-metadata-driver (part 1) : move AutoRecoveryMain to use MetadataBookieDriver----Descriptions of the changes in this PR:----### Motivation----We are introducing Etcd as the metadata storage. However AutoRecovery currently is still tied to zookeeper. In order to use Etcd as the metadata storage, we have to move AutoRecovery related classes to use metadata driver API.----### Changes----This is the first change for changing AutoRecovery to use metadata driver. It changed AutoRecoveryMain to use metadata driver api and also removed the shutdown logic on session expired, which doesn't make any sense for current retryable zookeeper.-----------Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1693 from codingwangqi/autorecovery_metadata;4f0d2a195bd9be3788876b47813cee1440cf005c
[TABLE SERVICE] [PYTHON] introduce a python client for table service--Descriptions of the changes in this PR:----*Motivation*----We need a python client for accessing table service.----*Changes*----This is the first change for introducing a python client for table service.----- setup the directory structure for the python client--- setup build, lint, test for the client--- implement the admin client for creating/deleting/getting namespaces/streams--- add examples for admin client----Master Issue: #1690--------Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1691 from sijie/stream_python_client;4deb4d15390f4b633021539b3c92806291411f57
Issue #1639: Etcd based metadata driver implementation--Descriptions of the changes in this PR:----Provide a metadata driver based on Etcd. The changes were based on sijie's prototype at #1114 ----Master Issue: #1639 -------Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1640 from codingwangqi/etcd_metadata_driver, closes #1639;c7f1e70f437423ed70f6feb02ef14d2d032abb9e
Bump journal and fileinfo version.------Descriptions of the changes in this PR:------- As part of ISSUE #1527, new versions of 'journalFormatVersionToWrite'--and 'fileInfoFormatVersionToWrite' are introduced. Since 4.8 release version--is created, default values of these versions should be bumped.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1689 from reddycharan/bumpjournalversion;72331e21cc84430a8f77f757557c8d2fbddf3554
[TABLE SERVICE] remove build warnings "Import xxx.proto but not used"--Descriptions of the changes in this PR:----*Motivation*----There are build warnings about `Import xyz.proto but not used`. for example:----```--cluster.proto: warning: Import common.proto but not used.--kv_store.proto: warning: Import kv.proto but not used.--```----*Changes*----Remove unused imports----------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1685 from sijie/remove_warnings;45321ba7981fdcdcd3194b14a055487b1a5a227a
Shutdown appropriate EntryLogger instance.----Descriptions of the changes in this PR:----- EntryLogger's instance shutdown method should be called--- Otherwise test would flap, since in tearDown method, FileUtils.deleteDirectory can fail because of EntryLogFile PreAllocation task.----Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1686 from reddycharan/entrylogtest;04edde0668c30b79391f9d00ded0494bbc9aca08
ISSUE #1687: Using eval instead of exec to handle quotes in healtcheck.sh--Descriptions of the changes in this PR:----Fixes https://github.com/apache/bookkeeper/issues/1687------### Motivation----https://github.com/apache/bookkeeper/issues/1687----### Changes--Using eval instead of exec to run the health check script.----Master Issue: #1687 --------Author: matevarga <mate@monadic.hu>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1688 from matevarga/master, closes #1687;0284c147d5a81578b7005af6f8ee5bd28c6cae15
Fix license issues in master--The only blocking error is that the GRPC NOTICE had not been bubbled--up to our notice.----The links for common-lang 3.6 and jackson 1.9.11 were also wrong, and--while these aren't required in license files, bad links makes it--harder to check if a dependency has been correct noted in the LICENSE--and NOTICE.----Author: Andrey Yegorov <dlg99@users.noreply.github.com>-Author: Ivan Kelly <ivank@apache.org>-Author: SongWang <aCoder2013@users.noreply.github.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1684 from ivankelly/v48-license;a9665f8494ae7e6fb6066ebfb652e72228fb677b
Issue #1679 : Fix build failure due to javadoc--Descriptions of the changes in this PR:--------### Motivation----Fix build failure due to javadoc, additionalOptions' type is  an array .--### Changes----correct assignment strategy of additionalOptions to avoid type mismatch----Master Issue: #1679 ----Author: songsong <songsong@taovip.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1681 from aCoder2013/fix-javadoc-build, closes #1679;0ab6864e51524ed02e7eae29cbcdfc94a0c6d073
Issue #850: Added request context across client and bookies.--Descriptions of the changes in this PR:---- - MDC context is passed to runnables, callables etc.-- - protocol extended, context is sent to bookie servers, restored there and back on client with the response.--   Hopefully did not miss some nuance on the server side, largely rely on changes in ordered executors to do all the magic.-- - did microbenchmarking of the protocol changes (strings added to protobuf, MDC context preserved/restored). Looks ok.-- - added unit tests.----(bug W-5291641) --(bug W-5291648)------### Motivation----Troubleshooting of request-level failures/errors can be simplified if request id was passed through all the stages of the request, from threadpools on the client to bookies to the response back on the client. --Log4j/Slf4j allows logging of MDC data so it makes sense to use this functionality for logging.----### Changes---- - MDC context is passed to runnables, callables etc.-- - protocol extended, context is sent to bookie servers, restored there and back on client with the response.--   Hopefully did not miss some nuance on the server side, largely rely on changes in ordered executors to do all the magic.-- - did microbenchmarking of the protocol changes (strings added to protobuf, MDC context preserved/restored). Looks ok.-- - added unit tests.----Master Issue: #850 --------Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Venkateswararao Jujjuri (JV) <None>, Sijie Guo <sijie@apache.org>--This closes #1672 from dlg99/feature/correlation_id, closes #850;c9dc301feb48ca170c3d6205a36fca63a4950c5a
[DEV] make merge script work with python 3--Descriptions of the changes in this PR:----### Motivation----make sure the script works for python 3 as well.----### Changes----since python2 and python3 have different syntax and library, make a copy of the merge script for python3.--------Author: --Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1677 from sijie/make_merge_script_works_for_37;e04c791499e51f2d5b4f288c5f349777103c555d
Utility to dump/restore ledger metadata to/from file--Dumping will dump the serialized metadata to a file. Restoring will--parse the metadata from the file and write it to the metadata store.----Also changes the LedgerIdFormatter to default to long formatter (it--was UUID before, and we don't even currently support UUID ledger ids).----This fixes #1604----Author: Ivan Kelly <ivank@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>-Author: cguttapalem <cguttapalem@salesforce.com>-Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Jia Zhai <None>--This closes #1667 from ivankelly/dump-metadata-to-from-file;b2439d67073c880d350f93c1939bbede5e00ec49
Release script: swap mapping of directories--The script assumed that the layout of /home on the host machine is the same as in the container.-This change makes the script work even on machines in which the HOME is /home/xxxx/username and not simply /home/username--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1675 from eolivelli/fix/invert-mapping;5a818b226bf2c3e3d9d649ffe1e690af5ec2f794
Release script: Use realpath() to map to current user home--This change enables to run the release scripts on linux boxes in which the user's home is not at /home/username--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1674 from eolivelli/fix/better-userland-mapping;d8f2cd1b88a144b6a00c5b8d68c8071d014f5ece
Use useradd -l option for docker scripts--This is a workaround for the Docker issue https://github.com/moby/moby/issues/5419--If you run the scripts with an very large uid the script hangs and it fills up the disk which contains /var/lib/docker--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1673 from eolivelli/fix/docker-large-uid;c420b39a3dab4e9f8896c59d92cbfe4e9a7a0d30
Remove unnecessary log statement in LedgerDirsManager.getWritableLedgerDirs--Descriptions of the changes in this PR:--### Motivation--- when Bookie reaches diskusage threshold, LedgerDirsMonitor for every diskCheckInterval it logs NoWritableLedgerDirException call stack and message "All ledger directories are non writable".--### Changes--So remove unneccessary log statement in LedgerDirsManager.getWritableLedgerDirs and let the caller deal with the thrown exception.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Andrey Yegorov <None>, Sijie Guo <sijie@apache.org>--This closes #1670 from reddycharan/fixdirsmonitorlog;052908ef30818d9f1e6be56bf3a3e3083c5bd6fb
BookieWatcherImpl doesn't initCause when throwing MetaStoreException--Descriptions of the changes in this PR:--### Motivation--when BookieWatcherImpl throws MetaStoreException, it doesn't provide the cause. so when the exception is logged, we can't tell the actual failure cause.--Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1637 from codingwangqi/fill_cause_in_exception;0446c823e36c762479cde9f69883175f8b140074
Issue #1664 Cancel Scheduled SpeculativeReads--If configured every read request schedules a Future task-to send speculative reads on speculativeReadTimeout.-When the read is completed successfully, this task must be-canceled otherwise it leads to memory consumption and under-heavy load the tasks get accumulated which forces lengthy-GC cycles. These lengthy GC cycles may cause ZK lease expiry-and all other sorts of problems eventually resulting in application-errors.--This fix makes sure that the scheduled Futures are cancelled-at the end of read task.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-(ref Andrey)--Descriptions of the changes in this PR:--### Motivation--(Explain: why you're making that change, what is the problem you're trying to solve)--### Changes--(Describe: what changes you have made)--Master Issue: #<master-issue-number>--Author: JV Jujjuri <vjujjuri@salesforce.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1665 from jvrao/ups_speculative_cancel, closes #1664;cdd659471e1fb75aaf7738302dbf0dfaf44a9127
ISSUE #1662: LocalBookKeeper use layout manager and ledger path configs--The URI patch had a side effect of causing LocalBookKeeper to always--use a URI string of the form zk:// which defaults to HLM.  This--patch updates LocalBookKeeper to generate zk+<layout>:// based on--the legacy LEDGER_MANAGER_FACTORY_CLASS config when present.  +null--will be used otherwise and defaults to HLM.  Further, use the--(admittedly deprecated) zkLedgerRootPath config to determine the--ledger path (defaults to /ledger, so the behavior will be unchanged--if unspecified).----(bug W-5415276)--(rev cguttapalem)--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1669 from athanatos/forupstream/wip-1662, closes #1662;74bd92605bc4986705031aea8943905dbc9f9f85
ISSUE #1653: Clients with zk:// uri's should read layout from store--zk+null:// will cause the layout to be read from the store.  This patch--updates zk:// to do the same.  This matches past behavior with an--unspecified ledgerManagerFactoryClass.----Some tests needed to be updated with the new behavior.----(bug W-5415120)--(rev cguttapalem)--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1668 from athanatos/forupstream/wip-1653, closes #1653;8711c3b911beb79c20ca87e47077a8ab4ccf5025
[DEV] clean up merge script--Descriptions of the changes in this PR:---- ### Motivation----The development of bookkeeper has been moved from JIRA to Github.--So we can clean up the merge script to remove those instructions--assuming we are still on apache mirror and JIRA.---- ### Changes----This change follows the changes that I have adjusted at apache/incubator-pulsar#2526----- remove related logic about JIRA from merge script--- change merge script to use github merge api-------Author: --Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1663 from sijie/improve_merge_script_2;f1f5dfe6d42fae4006bd16f284db211ff441c876
BP-35: 128 bits support--Descriptions of the changes in this PR:----### Motivation----BookKeeper coordinates with a metadata store to generate a cluster wide `ledgerId`.--Currently this is a signed `64 bit` number (effectively 63 bits). This method works--great because we have a centralized metadata store for coordinating the id generation.--However this method may not scale as the cluster size and number of ledgers grow.----[Universally unique identifier - Wikipedia](https://en.wikipedia.org/wiki/Globally_unique_identifier)--is a preferred way to generate decentralized globally unique IDs and it takes `128 bits`.--This method can scale well as it doesn't need a centralized coordination.----This BP proposes the changes for increasing ledger id from `63 bits` to `128 bits`.----Master Issue: #603-------Author: Sijie Guo <sijie@apache.org>--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Venkateswararao Jujjuri (JV) <None>--This closes #1611 from sijie/bp_35_128bits;992db732f42e5d4425ec2f986fb42e29515a182b
Utility to rebuild interleaved storage index files--We came across a case where the a ledger had been deleted from-zookeeper accidently. It was possible to recover the ledger metadata-from the zookeeper journal and old snapshots, but the bookies had-deleted the indices by this time. However, even if the index is-deleted, the data still exists in the entrylog.--This utility scans the entrylog to rebuild the index, thereby making-the ledger available again.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1642 from ivankelly/regen-from-entrylogger;318893399b8040a7d291b8094f0d218a3b4e4f1e
Open ledger returns no ledger exception if ledger id is negative--Descriptions of the changes in this PR:--### Motivation--if I open a ledger with negative value, bookkeeper client responds 'NoSuchLedgerException'. But I think it should return `IllegalOpException`, because it is an illegal exception.--Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1638 from codingwangqi/fix_return_code;40185e1f39fafd0c796cec38d463ebd55edaa250
[WEBSITE] Issue #1652: fix anchor links at download page--Descriptions of the changes in this PR:--As reported in #1652, the anchor links at download page are broken.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1656 from sijie/fix_download_links_2, closes #1652;83aae3357ceaa40f2ae70c186da951b8f52f57db
ISSUE #1658: License file: typo "Google Protocal Buffers" instead of "Google Protocol Buffers"--Fix a typo in LICENSE files for binary distributions.--Master issue #1658--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1659 from eolivelli/fix/protocal-typo, closes #1658;d7c99f86dd60534739c9eec1c826b4736c38c162
Make LedgerFragmentReplicator use MetadataUpdateLoop--Master Issue: #281--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1645 from ivankelly/ledger-fragment-immutable-metadata2;a031e0ede1767960d191d70a6cda21990d1f541e
[WEBSITE] fix download link to allow user choosing mirror site--Address the download link according to https://www.apache.org/dev/release-distribution#download-links--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1650 from sijie/fix_download_links;5d0d0569f0f394f709e66371643d80d5bb79a2d7
ISSUE #1630: TestHttpService#testWhoIsAuditorService is flaky--Descriptions of the changes in this PR:-- ### Motivation--Fixes #1630. The problem is auditor elector was started async, the test itself doesn't wait until election completed.-so the test can be running before auditor runs elector.-- ### Changes--The fix is simple, just wait until auditor completes election.--Master Issue: #1630--Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1649 from codingwangqi/issue_1630, closes #1630;18a40787930df990e9e3ac3aad58011dc65b1b9f
[WEBSITE] 4.7.2 only has sha512 file not sha1 file--Descriptions of the changes in this PR:--*Motivation*--Since 4.7.2 bookkeeper releases only provide sha512 file, not sha1 file.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #1647 from sijie/update_website_472;1db41acf1503e38694dba60adb478b2bfb4d41f9
[DOCKER] update package to 4.7.2 in dockerfile--Descriptions of the changes in this PR:--### Motivation--We need to generate 4.7.2 docker image.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1644 from sijie/update_docker_image_47;8326b3033390d649261aae2f3576bb7f922f1f3e
Recovery uses immutable metadata--And MetadataUpdateLoop to update it.--Master issue: #281--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1621 from ivankelly/recovery-immutable;c766575c7b36c2692fe403c996a3fd3516e5708a
Fix EntryLoggerAllocator.stop--Descriptions of the changes in this PR:--- make sure EntryLoggerAllocator.stop terminates pending allocatorExecutor's task.-Otherwise tests would flap, since even after EntryLoggerAllocator.stop, there is-possibility of new entrylog creation, which is not expected.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1627 from reddycharan/entryalocshut;af9d4c312ef1640fbbfb6765943c9a83242a4f37
[RELEASE] Release Notes for 4.7.2--Descriptions of the changes in this PR:--Add the release notes for 4.7.2 release--Author: Sijie Guo <sijie@apache.org>--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1628 from sijie/release_notes_472;04ce76aac703b4ad5c2e809edba03b3dbb6a80e1
[RELEASE] [WEBSITE] Create documentation for release 4.7.2--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1634 from sijie/website_472;fa498fc110480adf6ce77da1f03216e3ff4eb198
Update testcontainers to latest version--Descriptions of the changes in this PR:--### Motivation--the latest version of testcontainers provides a `doStart` method to allow adding logic before `doStart`.--Author: Qi Wang <codingwangqi@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1636 from codingwangqi/update_testcontainers;18ce02ccd30607a70b694373fa4bca1719bd1d34
[RELEASE] update release script to generate sha512 instead of sha1--*Motivation*--According to [checksums requirements](http://www.apache.org/dev/release-distribution#sigs-and-sums),-the project should supply a sha256 and/or sha512 checksum file, and should not supply a MD5 and sha1 checksum file.--*Changes*--Update the release script to generate sha512 files--Descriptions of the changes in this PR:--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1631 from sijie/sha512_files;4f70973aef55813ffccb6eb312e3fc6cb089207f
Allow construction of mock client context from scratch--So that ledger handle functionality can be tested without-instantiating a BookKeeper client.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1625 from ivankelly/mock-client-context;dca54b531e90cb0a0d91628efedd30959ee62ecc
ISSUE #1623: ReadOnlyLedgerHandle: don't schedule monitorPendingAddOps()--The LedgerHandle constructor schedules an addEntryQuorumTimeout check-with the bk client scheduler. However, the only place this callback is-canceled is in the closeAsync (the one which returns a future, not to be-confused with asyncClose) method. asyncClose and close() both leak this-callback. Moreover, ReadOnlyLedgerHandle invokes the LedgerHandle-constructor and so also creates this callback, but it overrides close()-and asyncClose() without passing them through.--ReadOnlyLedgerHandle already overrides-initializeExplicitLacFlushPolicy() to avoid write specific state.  This-patch generalizes that hack to initializeWriteHandleState() and the-cleanup to tearDownWriteHandleState().  tearDownWriteHandleState() is-moved into doAsyncClose(), which appears to be called for closes in-general.--(rev cguttapalem)-(bug W-5362724)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1624 from athanatos/forupstream/wip-1623, closes #1623;9279dcc13b95406dbcb7a333fcb8a8961f52bf16
Provide async version of markLedgerUnderreplicated for LedgerUnderreplicationManager--Descriptions of the changes in this PR:-- ### Motivation--Auditor has multiple places calling sync methods in async callbacks.-This raises the possibility hitting deadlock. Issue #1578 is one of the examples.--After looking into the `LedgerUnderreplicationManager`, `markLedgerUnderreplicated`-is the only interface that will be called in async callbacks. This change is-to provide an async version of `markLedgerUnderreplicated`.-- ### Changes--- add `markLedgerUnderreplicatedAsync` interface in `LedgerUnderreplicationManager`.-- implement the logic of `markLedgerUnderreplicated` using async callbacks-- use `markLedgerUnderreplicatedAsync` in the Auditor--Related Issues: #1578-Master Issue: #1617--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1619 from sijie/async_sync_autorecovery;73b428c7975c975f25956815670493a7093441ec
Add mock registration client--For testing the client without having to boot zookeeper.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1622 from ivankelly/mock-reg-client;3672a280e9b1f776514cba7066e5100aa7a32d08
Avoid usage of RocksDB deleteRange() in DbLedgerStorage--### Motivation--There are few issues that are reconducible to a performance degradation in RocksDB when using deleteRange() feature (eg: https://github.com/apache/incubator-pulsar/issues/1737 and others).--There is some discussion going on RocksDB to address this issue: https://github.com/facebook/rocksdb/issues/3959--In the meantime, we should rollback the change and don't use deleteRange until these issues are resolved.--### Changes--This PR is essentially reverting back the commit https://github.com/yahoo/bookkeeper/commit/4b849904bcd65b49cf963e6508dc7fb745f56294 from Yahoo branch (which was squashed when merging back to apache).-The only addition here is to use `DELETE_ENTRIES_BATCH_SIZE` to amortize the cost of `batch.flush()` when there are many ledgers with few entries.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1620 from merlimat/rollback-delete-range;dca471dfddbdbdea3dac029ddd76958340fa6629
UpdateLedgerOp uses MetadataUpdateLoop--Also refactored a lot of things around the operation that didn't make-sense, like the executor.--Master issue: #281--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1587 from ivankelly/update-ledger-op;a5b4b93d76d69caed5800a4d4a56bd3e8add92ec
Get currentEnsemble from ledger rather than directly from metadata--This will allow us to override the currentEnsemble being used during-recovery without modifying the metadata itself.--Master issue: #281--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1586 from ivankelly/current-ensemble;77b7fb870ef0fc2743dbe444c768c6c63bbe6875
Allow to configure num of Netty IO threads in client and bookie--### Motivation--Currently the number of IO threads for client and bookie are set to `2 *  Runtime.getRuntime().availableProcessors()`. Added configuration options to tune it.--Author: Matteo Merli <mmerli@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1612 from merlimat/configure-io-threads;b9916d3d87208af36be6a7b061a594a33c897271
Index for lockarray should be non-negative--Descriptions of the changes in this PR:--Make sure lockIndex is non-negative.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1616 from reddycharan/modfix;4eec3ce0f3dcd16b5ff84f14a95f9acc1d78e552
Issue #1610: netty leak detector logs 'LEAK: HashedWheelTimer.release() was not called before it's garbage-collected.' in unit tests--Descriptions of the changes in this PR:--Enabled netty's paranoid leak detection for tests.-Fixed most of the 'LEAK: HashedWheelTimer.release() was not called before it's garbage-collected.' issues. Did not fix ones produced by AuditorElector. In long term we should fix these, ByteBuf leaks in BufferedChannel and whatever else we find and make tests fail if netty logs a leak.--### Motivation--I used to have random test timeouts/failures caused by delayed bookie shutdown when I built repo with OpenJDK 8 but ran tests after switching to Oracle JDK 8 (or vice versa). After these changes tests did not fail in these runs.--### Changes--Made bk/bkadmin/auditor close resources properly in the tests and shutdown calls.-Changed order of initialization in Bookkeeper so it creates HashedWheelTimer after bookie client, in case bookie client creation fails due to misconfiguration.--Master Issue: #1610--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1613 from dlg99/fix/issue_1610_hashedwheeltimer, closes #1610;5f2d45c8fa0619d50423f1672303fea2d1a59238
ISSUE #1578: Fixed deadlock in auditor blocking ZK thread--### Motivation--Fixes #1578--After getting ZK callback from ZK event thread, we need to jump to a background thread before doing synchronous call to `admin.openLedgerNoRecovery(ledgerId);` which will try to make a ZK request a wait for a response (which would be coming through same ZK event thread currently blocked..)--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1608 from merlimat/fix-auditor-deadlock, closes #1578;f782a9d818a12479d08c580a68b2566715da4c89
Ensure BufferedChannel instance is properly closed--Whenever the the `EntryLogger` is closing the `BufferedChannel` instance (the channel used for writing) it is closing the file descriptor but it's not calling `close()` on the object itself.--This causes a small mem leak for each log file, because the `writeBuffer` from `BufferedChannel` is never released.--I think this should be considered for a 4.7.1 release.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1414 from merlimat/fix-entry-log-leak;dd964d6388987d2431b9fc5afa87d6e2e993feb8
Make LedgerHandle injectable--This patch removes the hard dependency of LedgerHandle on BookKeeper.-This allows us to create an instance of LedgerHandle independently,-with a fully mocked BookieClient or LedgerManager and be clear on-where the objects used by the LedgerHandle are coming from.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1589 from ivankelly/injectable-lh;8e103282de68102ecb1cf4cbafae690ef0914f6f
Issue #1584: LedgerHandleAdv should expose asyncAddEntry variant that takes ByteBuf (LedgerHandle exposes it as public)--Descriptions of the changes in this PR:--- exposed asyncAddEntry as public, similarly to other variants.-- fixed ByteBuf retention--### Motivation--It's useful to have this exposed as public for clients to make use of netty's allocator and pass ByteBuf directly.--### Changes--exposed asyncAddEntry as public, similarly to other variants.--Master Issue: #1584--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1585 from dlg99/feature/issue-1584-LedgerHandleAdv-public-addEntry-bytebuff, closes #1584;299fb58deed3dc284342716d52b7f918cc6cefc4
Downgraded ZK version to 3.4.13--### Motivation--BK 4.7 has shipped with newer ZooKeeper client 3.5.3-beta. In many cases, there has been concerns regarding having a dependency on a "beta" release. Irrespective of the seriousness of these concerns for the specific case of ZK which has been in alpha/beta for a very long time, we should not have dependency on versions of software for which the team itself has marked as "not yet stable".--Adding to that, there is no clear roadmap or ETA for when final 3.5.x stable release will be available.--### Changes-- * Downgraded ZK to latest stable version 3.4.13- * Adjusted few usages of new client APIs that were introduced in 3.5.x--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1601 from merlimat/downgrade-zk;f5474b1380b73819ba9f85b42d006f9ad7e45aa5
BP-34: Cluster metadata checker--Descriptions of the changes in this PR:--- BP for cluster metadata checker--Master Issue: #1602--Author: cguttapalem <cguttapalem@salesforce.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1603 from reddycharan/checkerbp;bf7e15e04f8f040abb0fe346faa762f95d42e447
[BOOKIE] Avoid throwing exceptions if a loopback address is returned from the possible ip check--Descriptions of the changes in this PR:-- ### Motivation--At some network environment, a loopback address might be returned by default. However when you-want to specify `advertisedAddress` to avoid the loopback address, it still throws exception as-following:--```-17:23:35.696 [main] ERROR org.apache.bookkeeper.server.Main - Failed to build bookie server-org.apache.bookkeeper.bookie.BookieException$UnknownBookieIdException: java.net.UnknownHostException: Trying to listen on loopback address, 127.0.0.1:3181 but this is forbidden by default (see ServerConfiguration#getAllowLoopback())-	at org.apache.bookkeeper.bookie.Bookie.possibleBookieIds(Bookie.java:325) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.bookie.Bookie.checkEnvironmentWithStorageExpansion(Bookie.java:415) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.bookie.Bookie.checkEnvironment(Bookie.java:256) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.bookie.Bookie.<init>(Bookie.java:627) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.proto.BookieServer.newBookie(BookieServer.java:115) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.proto.BookieServer.<init>(BookieServer.java:96) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.server.service.BookieService.<init>(BookieService.java:42) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.server.Main.buildBookieServer(Main.java:299) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.server.Main.doMain(Main.java:219) [org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.server.Main.main(Main.java:201) [org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.proto.BookieServer.main(BookieServer.java:252) [org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-Caused by: java.net.UnknownHostException: Trying to listen on loopback address, 127.0.0.1:3181 but this is forbidden by default (see ServerConfiguration#getAllowLoopback())-	at org.apache.bookkeeper.bookie.Bookie.getBookieAddress(Bookie.java:564) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	at org.apache.bookkeeper.bookie.Bookie.possibleBookieIds(Bookie.java:315) ~[org.apache.bookkeeper-bookkeeper-server-4.7.1.jar:4.7.1]-	... 10 more-```--The exception is thrown on `possibleBookieIds` check. However we don't need to throw exception on `possibleBookieIds` check-if it is a loopback address. We can defer the exception until bookie attempts to listen on the loopback address.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1609 from sijie/avoid_exceptions_on_possible_ips;0459d673891c911ba8ed8e83a90f083b71a9d413
Typo in bookie request processor read handling--The response in the case of overload should take the ledgerId and-entryId from the read request.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1590 from ivankelly/request-processor-typo;987f8046d9f253354c512bd2aa32307ff9ed1019
ISSUE #1528: logging "No network topology script is found when using script based DNS resolver" can be noisy and misleading.--Descriptions of the changes in this PR:-- ### Motivation--"No network topology script is found when using script based DNS resolver" is misleading and noisy.-- ### Changes--Only log the error message but not the stack trace.--Master Issue: #1528--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1605 from sijie/fix_log_message, closes #1528;d57cc6679b4181e514d04e8f3f1d7e598308d78f
ISSUE #1606: Fixed race condition during expansion of concurrent open hash maps--### Motivation--As reported in #1606, there is a race condition in the concurrent open hash maps implementation. The race happens when the maps gets re-hashed after the expansion and the new arrays are substituting the old ones.--The race itself is that a thread doing a `get()` on the map is first checking the current `capacity` of the map, uses that to get the bucket and then tries to do optimistic read of the value in that bucket.--This assumes `capacity` update is visible only after the `values` array is already swapped, but that is not always the case in current code.--### Changes- * Use `volatile` qualifier for `capacity` and `values` arrays to ensure ordering of memory read is respected by compiler- * In rehashing, update `capacity` after `values`--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1607 from merlimat/fix-concurrent-maps, closes #1606;a7e66e1dd84ff17c918dbbf54e5baa18ff9c9c9b
Provide consistent locking mechanism in EntryLogManagerForEntryLogPerLedger--Descriptions of the changes in this PR:--Assumption: The lock stored alongside the EntryLog in this map is meant-to be used to ensure that no two threads can be writing to the same-ledger at the same time.--The above invariant can be violated if the EntryLogAndLockTuple-object is evicted from the cache while in a critical section nominally-protected by the contained lock.--The conditions required for this to happen would be pretty odd ---there needs to be a huge amount of cache churn during one of-the protected operations.--The fix for this issue is to allocate in the constructor a fixed array of locks and select-for each EntryLogAndLockTuple a lock from that array-deterministically by ledgerId such that the same ledgerId-will always get the same lock.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1600 from reddycharan/elmlock;b0c04dffdf0c6f243ef9f17326c9e5ad83d20544
Make bookie client an interface--So that it can be mocked easily for testing.-This patch also contains a simple mock.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1595 from ivankelly/bookie-client-iface;36d8590e42f8f34f79568dad7494c38c28adecb4
Make bookie watcher an interface--So that it can be mocked out easily for testing.-This patch also contains a simple mock.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1594 from ivankelly/bookie-watcher-iface;511fc810d753dbdf147a2e2eabb9065192cdf7e5
Create CI jobs for branch-4.8--In order to ensure quality on branh-4.8 we need to create CI jobs which run periodically QA tests--Author: Sijie Guo <sijie@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1593 from eolivelli/ci_jobs_for_48;046debbb1a315dfe3ee46064391cb8882ce3d9cc
Add a deployment method using docker-compose--Descriptions of the changes in this PR:--### Motivation--Provide a deployment method using docker-compose.--### Changes--- Use helm as the template engine to generate docker compose file-- Deploy zookeeper in cluster mode in docker-compose-- Manages port mapping to make it able to access out side of the docker-composed cluster.--Author: Khurrum Nasimm <khurrumnasimm@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1530 from khurrumnasimm/docker_compose;83f78c3b8187f7f0e4a93c50055e2e08b0bdd4e3
Delayed write ensemble change may cause dataloss--Descriptions of the changes in this PR:--The Original intent of this change is to do a best-effort ensemble change.-But this is not possible until the local metadata is completely immutable.-Until the feature "Make LedgerMetadata Immutable #610" Is complete we will use-handleBookieFailure() to handle delayed writes as regular bookie failures.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1591-Relate Issue: #1395--Author: JV Jujjuri <vjujjuri@salesforce.com>-Author: Ivan Kelly <ivank@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1592 from jvrao/datalossbug;3ab6e9253555d013a8c6eb3b90cddffa090fcaee
Avoid releasing sent buffer to early in BookieClient mock--If the buffer was sent to more than one bookie with the mock, it would-be released after being sent to the first one. Each write should-retain a refCount themselves, and then release when done.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1598 from ivankelly/double-rel-mock;6b9cbf2052b27f331553f2738483ae21bf12b49c
Move GenericCallbackFuture so it can be used in production code--It's a useful utility to have when dealing with callbacks.--Author: Ivan Kelly <ivank@apache.org>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1597 from ivankelly/gen-cb-future;269f609f6573ed2b529f20eb8e2e0182baa9db12
Move MockLedgerManager out of MetadataUpdateLoopTest--This mock is useful for other tests, so move it out.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1596 from ivankelly/mocklm-common;9a2efacd08e2360868b79efe10296aade8e2e5b1
Fix master versions (4.8.0-SNAPSHOT->4.9.0-SNAPSHOT)--Some pom versions and the versions in bk_test_bin_common.sh were-missed when the version was bumped to 4.9.0-SNAPSHOT, which is killing-all builds.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1599 from ivankelly/broken-master;dd5b938fd48bfa1164b94fa083b1b39e6094c7a4
[maven-release-plugin] prepare for next development iteration;9cd10484f527c8f2fc144c94fe92588a3f30904e
[maven-release-plugin] prepare branch branch-4.8;5f3d28228ac984ded435d932b05cb1d348694dfc
Record ctime for underreplicated ledger mark time.--Descriptions of the changes in this PR:--Enable the Auditor to use system time as underreplicated ledger mark time.-If this is enabled, Auditor will write a ctime field into the-underreplicated ledger znode. This would be useful in knowing when the-ledger is marked underreplicated, using BookieShell commands and also later-we can add alerts/metrics on under replicated ledgers which remained under-replicated for more than acceptable duration.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1576 from reddycharan/urlctime;f4094c4992d5b22630fa633085a00a9152b87ffe
Metadata Update mechanism--This patch introduces a metadata update mechanism for the client which-will be used in all places where metadata is updated.--The mechanism takes a bunch of predicates and functions, and runs a-loop again the ledger manager, attempting to apply the mutation-required as specified.--It assumes that the ledger metadata objects on the client side are-immutable and that any metadata object read reflects state that exists-on the metadata store. This isn't the case right now, but as the-current metadata updates are changed to use this, it will be the case.--This patch also introduces a limited LedgerMetadataBuilder, though-only the fields required for testing at mutable.--Master Issue: #281--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1577 from ivankelly/ledger-fragment-immutable-metadata;123ceabe0a3de46fab6eb61bff9d530b7e212100
Enhancing DecommissionBookieCmd--Descriptions of the changes in this PR:--- adding bookieid option to DecommissionBookieCmd, to enable decommissioning remote-bookie. This might be needed because, in an extreme scenario Bookie node might not-be completely accessible and hence we might need to decommission a Bookie remotely.-- also DecommissionBookieCmd should delete the cookie of the decommissioned Bookie.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1582 from reddycharan/decomfix;afa1c2008ddf2eff7cec3fd9c055157f41e0fdd3
Make each ensemble in ensemble list immutable--Previously, the ensemble list was a Map<Long, ArrayList<BookieSocketAddress>>.-ArrayList is by definition mutable, so ensemble passed to metadata users are-always mutable.--This patch changes in ensembles in the list to be immutable. We were also leaking-the implementation of ledger metadata to the placement policy, so this has been-modified to use List<BookieSocketAddress> also.--Master issue: #281--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1575 from ivankelly/ledger-fragment-immutable-metadata and squashes the following commits:--14977a242 [Ivan Kelly] fix dlog-bdaef31e8 [Ivan Kelly] checkstyle-6e3431118 [Ivan Kelly] Make each ensemble in ensemble list immutable;2b14458d966f80d991cec35ed7460639db52997b
Disallow direct access to LedgerHandle#metadata--This object has been accessed and mutated all over the client, which-makes it hard to do anything with the object. This patch removes the-direct accesses, so the object can only be accessed through an-accessor.--Master issue: #281--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1574 from ivankelly/onlyaccessmdthroughaccessor;7ec196624f0cd0cd1d57b47d24d35788adfcbcde
LedgerManager should return the metadata just written--First part of changes to make ledger metadata immutable. The client-should only act on metadata which has been written to zookeeper. To-this end, we need to be able to get back from the ledger manager what-has been written to zookeeper (with the version number updated).--Master issue: #281--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1573 from ivankelly/ledger-manager-returns-ledgermeta;130cccba2b218e965660ddd3266af30aeed56d0f
ISSUE #1559: Fix for moveLedgerIndexFile logic in relocateIndexFileAndFlushHeader--Descriptions of the changes in this PR:--- In IndexPersistenceMgr.relocateIndexFileAndFlushHeader, if the-currentDir is full and if it is the only indexDir which is-eligible for newIndexFile creation then instead of failing with-NoWritableLedgerDirException it should flushHeader without trying-to move LedgerIndexFile.--Master Issue: #1559--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1560 from reddycharan/fixfileinfomove, closes #1559;e0d82804cefb97e8eaada19c10bc0e0fae70f002
ISSUE #1565: Update 'upgrade' doc for 4.8 release--Descriptions of the changes in this PR:--Update 'upgrade' doc by adding an entry-"4.7.x to 4.8.0 upgrade" for ExplicitLac persistence--Master Issue: #1565--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1568 from reddycharan/upgradenote, closes #1565;fe266906c83b38d25a575fd8f745556e132e4349
Write DEFERRED_SYNC docs--Write a little documentation about DEFERRED_SYNC WriteFlag and force() API--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1571 from eolivelli/fix/bp14-docs;f40a29ddef3586c53fad4b9098a85342390a498b
Flag to disable test reruns from the commandline--Useful when trying to hunt down flakes.--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1570 from ivankelly/retryFlag;f265f6e5c05ece3db8d1e2f9322f8d68ddeefa74
Replace guava multimap in PCBC with custom impl--For a long time PerChannelBookieClient has used guava-LinkedListMultiMap to store conflicting V2 completion keys and-values. This is problematic though. Completion keys are pooled-objects. When a key-value pair is stored in a LinkedListMultiMap, if-it is the first value for that key, a collection is created for the-values, and added to a top-level map using the key, and then the key-and the value are added to the collection. When a second value is-added for the same key, the key and value are simply added to the-collection. The problem occurs when the first key is removed. PBCB-will recycle the key object, but this object is still being used in-the multimap in the top-level map. This causes all sorts of fun like-NullPointerException and IllegalStateException.--Because of this, this patch introduces a very simple multimap-implementation that only stores the key one time (in the collection)-and uses the hashCode of the key to separate the collections into-buckets. It's pretty inefficient, but this code it only hit in the-rare case where a client is trying to read or write the same entry-from the same ledger more than once at the same time.--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1569 from ivankelly/conc-test-flake;3ec8231c58a2ebe50c0c6a082e2feab231540116
ISSUE #1538: Expose MetricsServer in http server--Descriptions of the changes in this PR:--Expose MetricsServer in  http server under `/metrics`--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1546 from jiazhai/issue_1538, closes #1538;16553057b0ddba53ac169c4fef81336e2bd26116
[TABLE SERVICE] Set storage type on creating tables--Descriptions of the changes in this PR:--*Motivation*--We are using same metadata objects for both streams and tables. and we are-using a storage model to distinguish them. We need to make sure we setting the storage-model when creating tables.--*Changes*--Set storage type on creating tables.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1551 from sijie/set_storage_type;d3e9d56c18df337fa22da47aa8458bde5b74d141
Provide BookieId option for listledgers command--Descriptions of the changes in this PR:--### Motivation--While diagnosing/analyzing/debugging cluster, sometimes it would be helpful to know the list of the ledgers residing in a particular bookie. Currently there is no simple way (BookieShell command) to find out that.--### Changes--For listledgers BookieShell command, provide bookieid option, which helps us in knowing list of ledgers residing in this particular Bookie.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1555 from reddycharan/printledgersofbookie;3ddbaace58a2b95304d7b05e5c86afb9f509c067
ISSUE #1527: Make ExplicitLAC persistent--Descriptions of the changes in this PR:--For persisting explicitLAC, we can follow the-same approach as followed in persisting-fencing information / stateBits (d69986c)-in FileInfo file and special marker entry-in Journal.--### Motivation--ExplicitLAC is kept in the memory and it can be lost in bookie reboot.-Though it is an extreme corner case scenario, it can break one of the BK guarantees.-" If you read once you can always read it".-If all the bookies of the Write stripe were rebooted, it can loose its explicitLAC value and the client-which was able to read the entry before the reboot, can't read it anymore.--Master Issue: #1527--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1532 from reddycharan/storeexplicitlac, closes #1527;21f125d76870d7c244b87ad32a2f6f52421778eb
Provide utils to dump component configuration as json string (#1552)------*Motivation*----It is useful to dump configuration during service components started.--Bookie server already did that.----*Changes*----- Move JsonUtil to bookkeeper-common module to make it available to other modules.--- Add toJson method to ComponentConfiguration;43bf7a40da1ff5fe6f784accc2bd3f9194490186
ISSUE #1563: Spammy logs on Bookie in ReadEntryProcessorV3 in case of tailing reader on empty ledger--Descriptions of the changes in this PR:-### Motivation--In case of an empty ledger the bookie floods the disk with an useless message.--### Changes--Make that line "No ledger found while reading entry" to be logged at 'debug' level.--Master issue #1563--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1564 from eolivelli/fix/1563-logs, closes #1563 and squashes the following commits:--f66a9b8c0 [Enrico Olivelli] only skip logging for LastAddConfirmed Entry-83f6217a0 [Enrico Olivelli] Issue-1563 Spammy logs on Bookie in ReadEntryProcessorV3 in case of tailing reader on empty ledger;573e86b6c13a106d748c01778dcaeee9d45c39c4
ISSUE #1544: [DLOG] ConcurrentModificationException with nonblocking logReader.readNext(true)--Descriptions of the changes in this PR:--*Motivation*--Fixes #1544. ConcurrentModificationException is thrown when trying to access a non-thread-safe hashmap from different threads.--*Changes*--Make sure accessing to this non-thread-safe hashmap is under synchronized block.--*Tests*--It is a bit tricky to reproduce this race condition in a unit test or an integration test. so not going to attempt adding any tests.--Master Issue: #1544--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1558 from sijie/issue_1544, closes #1544;ec7fb62f025a3b03b42fd92b38bc836515310fad
ISSUE #1540: Bookie/BookieServer components shutdown will fail to end exit the BookieProcess--Descriptions of the changes in this PR:-- ### Motivation--Fixes the issue at #1540.--If Bookie/BookieServer components are shutdown internally because of any fatal errors-(ExitCode - INVALID_CONF, SERVER_EXCEPTION, ZK_EXPIRED, ZK_REG_FAIL, BOOKIE_EXCEPTION) then-it will go through shutdown method logic and shutdowns components internal to Bookie/BookieServer-but it will not succeed in bringing down the bookie process.--This is because in BookieServer.main / server.Main.doMain it would wait for the startComponent-future to complete-http://github.com/apache/bookkeeper/blob/master/bookkeeper-server/src/main/java/org/apache/bookkeeper/server/Main.java#L227 .-The startComponent future will be market complete only in runtime shutdownhook --https://github.com/apache/bookkeeper/blob/master/bookkeeper-common/src/main/java/org/apache/bookkeeper/common/component/ComponentStarter.java#L66.--But the problem is nowhere in Bookie/BookieProcess shutdown we are calling System.exit() and hence-the runtime shutdownhook is not executed to mark the startComponent future to complete. Hence-Main.doMain will wait forever on this future though Bookie/BookieServer components are shutdown-because of known fatal errors.-- ### Regression--Issue #508 introduced this regression. Before this change, the main thread is blocking using `BookieServer#join()`.-When bookie is dead for any reason, the DeathWatchThread will kill the bookie and bookie server. so the main thread will quite.-However after #508 is introduced, the lifecycle management is disconnected from the bookie and bookie server. so when they are dead,-lifecycle management is unaware of the situation and the main thread doesn't quite.-- ### Changes--- Add `UncaughtExceptionHandler` to lifecycle components-- When a lifecycle component hits an error, it can use `UncaughtExceptionHandler` to notify lifecycle component stack to shutdown the whole stack--Master Issue: #1540--Author: Sijie Guo <sijie@apache.org>--Reviewers: Andrey Yegorov <None>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1543 from sijie/fix_lifcycle_components, closes #1540;50f29ed9425095e2115b7c18518b8e9a81c204e9
Allow concurrent write requests for same entry in V2 protocol--With the V2 protocol we have previously allowed a single client to-issue concurrent read requests for the same entry. We didn't allow the-same for write requests, as we always assume single writer. This-assumption isn't absolutely correct though. When opening a ledger, the-recovery process will rewrite entries after the LAC. To-PerChannelBookieClient these look no different to normal writes.--If a client tries to open a ledger multiple times concurrently,-currently some of the attempts can hang forever since there is no-support for concurrent writes.--This patch adds support for concurrent writes, so multiple concurrent-ledger open attempts will always complete (though some may fail for-unrelated reasons).--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1547 from ivankelly/conc-open;424204ebecb8ba2e4856cb2f570f3a8bf1589da8
[TABLE SERVICE] Improve bin/bookkeeper standalone to start all available service components--Descriptions of the changes in this PR:--*Motivation*--Currently `bin/bookkeeper standalone` simply starts local bookies. It is not very useful when using-standalone for local development for other service components.--*Changes*--- change `bin/bookkeeper standalone` to start a cluster of zookeeper, bookkeeper and table service containers-- add `bin/standalone.process` to start a cluster of zookeeper, bookkeeper and table service containers in one process-- change `bin/standalone` to support both process and docker-compose--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1553 from sijie/improve_bk_standalone;1d8366a0a2468856d3a5671d36b17f542cb0c75c
ISSUE #1541: Fix ReadOnlyBookie constructor--Descriptions of the changes in this PR:--### Motivation--ReadOnlyBookie doesn't sets shutdownHandler to its statemanager.--There are couple of issues with how 'stateManager' is handled in ReadOnlyBookie,--- ReadOnlyBookie creates its own stateManager in its constructor but it does not sets shutdownHandler.-- Also, it is not correct to create stateManager instance in Bookie constructor and then again in ReadOnlyBookie constructor and override the instance created in super constructor.--### Changes--- move initializeStateManager logic to a method and override it in ReadOnlyBookie.--Master Issue: #1541--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1557 from reddycharan/readonlybookiefix, closes #1541;4d5353bb7ea6c7f6cf2cb62992d122b265687b05
[CI] Cleanup workspace before build--Descriptions of the changes in this PR:--*Motivation*--A lot of CI jobs failed due to gitlock file left in the workspace--*Changes*--Cleanup workspace before build--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1566 from sijie/cleanup_workspace;89f8ee91ff768664b5da2c52fcac1d1b7f0614f0
Disable testConcurrentWriteAndReadCalls in EntryLogTest--Descriptions of the changes in this PR:--*Motivation*--Those tests passed locally. However they are taking very long time to complete and cause all CI jobs become very flaky.-In order to unblock all PRs, disable these tests in EntryLogTest.--*Changes*--Marked 4 tests in EntryLogTest as `FlakyTest`.--Relate Issue: #1516--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1561 from sijie/disable_some_entrylog_test;e5b144cf45dd176d0369e7dc0ada2bb53e34d912
[TABLE SERVICE] Fix Journal replay issue on range deletion--Descriptions of the changes in this PR:--*Motivation*--We use `\000` as an indicator for null key in the protobuf delete operation.-However when we convert the protobuf delete request to an delete operation,-we didn't take `\000` into account.--*Changes*--- Fix ProtoDeleteOpImpl and ProtoRangeOpImpl to handle '\000'--(have a separated PR for an integration test to ensure this work)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1554 from sijie/fix_journal_replay;f4ef21fb05f9f5826413bedb04cf00da85d56416
[TABLE SERVICE] Support getStreamById in root range store.--Descriptions of the changes in this PR:--*Motivation*--Stream readers need to fetch metadata information by quering its metadata using stream id.--*Changes*--Add support in root range to get stream properties using stream id.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1550 from sijie/add_get_stream_by_id;3a52ce74a92ac84f61a5834ef7ee701a7e6f7988
ISSUE #1534: LedgerCache should be flushed--Descriptions of the changes in this PR:--### Motivation--EntryLogComparator.CompactionScannerFactory.flush just calls "ledgerStorage.updateEntriesLocations(offsets);" but not "ledgerStorage.flushEntriesLocationsIndex()".--Because of this, EntryLogCompactor.compact method would remove compacted entryLog without updated offsets/locations getting flushed/persisted/fsynced to LedgerCache (Index/FileInfo files). This could lead to data corruption/loss if Bookie is broughtdown/killed before those updated offsets/locations are flushed/persisted/fsynced.-### Changes--In EntryLogComparator, before removing compacted entryLog, LedgerCache (IndexInMemPageMgr and Index files) should be flushed, just like EntryLogger.--Master Issue: #1534--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1536 from reddycharan/compactfix, closes #1534;7a2e73177d3147221a0992455a9b73049d9a5447
ISSUE #1537: fix distributedlog incubator link--Descriptions of the changes in this PR:-### Motivation--In bookkeeper website, we are still using incubator locations for dlog references. we should change it to http://bookkeeper.apache.org/distributedlog--### Changes-change links from-`https://distributedlog.incubator.apache.org`-to-`https://bookkeeper.apache.org/distributedlog`--Master Issue: #1537--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1545 from jiazhai/issue_1537, closes #1537;1760c0590b6ed775ca55911f4e2a177234c59cc7
ISSUE #1542: Unable to run 'bookkeeper' shell script from /bookkeeper/bin folder--Descriptions of the changes in this PR:--*Bug*--```-Getting NoClassDefFoundError while trying to run 'bookkeeper' shell script from 'bin' folder. Issue seems to be related with classpath (cached classpath file - cached_classpath.txt)--~/Workspace/Community/bookkeeper/bin$ ./bookkeeper shell-JAVA_HOME not set, using java from PATH. (/usr/bin/java)-cat: bookkeeper-server/target/cached_classpath.txt: No such file or directory-Error: A JNI error has occurred, please check your installation and try again-Exception in thread "main" java.lang.NoClassDefFoundError: org/apache/commons/configuration/Configuration-at java.lang.Class.getDeclaredMethods0(Native Method)-at java.lang.Class.privateGetDeclaredMethods(Class.java:2701)-at java.lang.Class.privateGetMethodRecursive(Class.java:3048)-at java.lang.Class.getMethod0(Class.java:3018)-at java.lang.Class.getMethod(Class.java:1784)-at sun.launcher.LauncherHelper.validateMainClass(LauncherHelper.java:544)-at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:526)-Caused by: java.lang.ClassNotFoundException: org.apache.commons.configuration.Configuration-at java.net.URLClassLoader.findClass(URLClassLoader.java:381)-at java.lang.ClassLoader.loadClass(ClassLoader.java:424)-at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:349)-at java.lang.ClassLoader.loadClass(ClassLoader.java:357)-... 7 more-```--*Motivation*--Fixes #1542--*Problem*--`bin/common.sh` uses a relative path for caching classpath and locating the pom file.--*Changes*--- change to use full path for cached classpath file and the module pom file-- add a test case to cover this problem--Master Issue: #1542--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #1548 from sijie/fix_issue_1542, closes #1542;b1d23b483a06f987efab8b794a9e754dc4552542
Website - Add other usecases to the overview page--Add Twitter Manhattan and Herddb.org Distributed Databases usecases for BookKeeper as Write-Ahead-Log--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1539 from eolivelli/fix/websiteusacase;30175bf0b924a7da16cbd5ed8cb7e870dff76d73
[RELEASE] Bump bk version to 4.7.1 in docker file--Descriptions of the changes in this PR:--Bump bk version to 4.7.1 to build docker image for `4.7.1`--Author: Sijie Guo <sijieapache.org>--Reviewers: Jia Zhai <None>--This closes #1523 from sijie/bump_docker_version--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1529 from sijie/cherry-pick_docker_change;e3884801569725283963385a35f63c5d1d8b3880
LedgerManagerIteratorTest: avoid ledger collision--For the non-LHLM managers, the ledger space seems to be small enough to-allow collisions to occasionally cause a test failure.  Remember-created ledgers to avoid collisions.--(bug W-5104859)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1526 from athanatos/forupstream/wip-ledger-manager-iterator-test;28dee8464764b0edceeb31ce24424f0947b5789b
[WEBSITE] update release guide to reflect current release process--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1525 from sijie/fix_release_guide;cf89f25677877abb172a95cd2c40bfd760b225a8
ISSUE #1495: Option to enforce minNumRacksPerWriteQuorum--Descriptions of the changes in this PR:--Provide an option to enforce the guarantee of minNumRacksPerWriteQuorum-if it is enabled. If it cann't find a bookie to enforce the guarantee-then the API in RackawareEnsemblePlacementPolicy should throw-BKNotEnoughBookiesException.--Master Issue: #1495--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1496 from reddycharan/enforceminracks, closes #1495;10c510333d904debf54eb832524f6e09dcc0685d
[RELEASE] update website with 4.7.1 documentation--Descriptions of the changes in this PR:--Signed-off-by: Sijie Guo <sijieapache.org>--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1522 from sijie/update_website;bdfe2291d93f2a5c9baf68a4e2ee0b8648e73062
ISSUE #705: add site/scripts/release_minor.sh for minor releases--Descriptions of the changes in this PR:--*Motivation*--Currently `site/scripts/release.sh` only supports major releases.--*Changes*--Added a similar `release_minor.sh` to support minor releases.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1524 from sijie/provide_script_release_minor, closes #705;880294f512102f6d841517f827ce2740a0eeeac4
[RELEASE] Release Notes for Release 4.7.1--Descriptions of the changes in this PR:--Release Notes for release 4.7.1--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1518 from sijie/release_notes_471;7204d3762fca005e3fcffa625cd15ef83576f120
Fix typo in bk_server.conf--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1520 from ivankelly/ivankelly-patch-1;c7aa989865d6a67c7377237e89e7cd7878b58645
BP-14 force() API - client side implementation--- Introduce the client side force() API-- Implementation on the client side wire protocol for FORCE_LEDGER RPC-- Disable ensemble changes for DEFERRED_SYNC writers-- Prevent v2 client from using force() API.--The force() API enables the client (usually with DEFERRED_SYNC write flags) to require a point of synchronization with all the bookies in the ensemble, to have guarantees about durability of previously written entries (and ackknowledgerd), this way LastAddConfirmed is able to advance.--For DEFERRED_SYNC writers LastAddConfirmed will advance only using this API--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1436 from eolivelli/bp14-force-client-api;f7dce110fdca47c93664d1d9c71cda8cb08c9cc2
Move TimedOutTestsListener from dlog to bookkeeper-common--Descriptions of the changes in this PR:--This PR is to debug CI problems observed at #1516--### Motivation--dlog uses a `TimedOutTestsListener` to dump the jvm stack when a junit test timed out.-move this class to bookkeeper-common and built with `test-jar`, so it can be used across the project.--### Changes--relocate `TimedOutTestsListener` and its related classes from distributedlog-common to bookkeeper-common.--Related Issue: #1516--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1517 from sijie/add_test_timedout_listener;c5a36219bbb7cfce343137bf3c361f7eb80bd64e
ISSUE #1476: LedgerEntry is recycled twice at ReadLastConfirmedAndEntryOp--Descriptions of the changes in this PR:--The issue #1476 is caused by peculative reads with object recycling, same request object will be added to the CompletionObjects multiple times with different txnid.  In fact the logic of process the request already take this into account, only on place inside `ReadLastConfirmedAndEntryOp.requestComplete` forget to check requestComplete before calling `submitCallback` which in turn call request.close.--### Motivation--to fix #1476--### Changes--check `requestComplete` before `submitCallback` in `ReadLastConfirmedAndEntryOp.requestComplete`--Master Issue: #1476--Author: Sijie Guo <sijie@apache.org>-Author: infodog <infodog@hotmail.com>-Author: zhengxiangyang <zxy@xinshi.net>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1509 from infodog/issue1476, closes #1476;6476fc323fffd328ed9620d9aa39c4c232f8d2be
Issue #1489: Better Prevent Read Outliers during short-term Bookie Slow-Down--### Motivation--Bookies can temporarily be slow for a large number of reasons, often for just a brief time of few milliseconds to seconds such as during Java Garbage Collection or EntryLog compaction. For writes, latencies of individual bookies are masked by acknowledging the client after a quorum of bookies have replied. However for reads, we don't have any equivalent feature to mask short-term latencies of individual bookies yet (in case of SequenceReadRequests). This PR implements such a feature by reordering reads to prefer bookies with a high probability of being fast over bookies that are potentially slow.--### Changes-This change implements a configurable reordering of read requests in Bokkeeper client based on the number of pending requests to each bookie that could service the request. The intention is to mask the latency of one bookie by directing a read request to another bookie that could potentially service the request faster. This should help prevent read time outliers due to bookies that temporarily are responsing slow, for example due to Java garbage collection, compaction, or any other kind of hickup. Unlike the implementation for Issue #709, this algorithm quickly reacts to both an or decrease increase in queue length of a bookie relative to others, and allows to redirect requests long before they would hit the speculativeReadTimeout. Once the problem is resolved (e.g. Java GC finished), it will quickly direct requests to the previously "slow" bookie as its queue length decreases.--Reordering of reads is based on a threshold of relative queue length to other bookies. Setting the threshold very low will more frequently reorder the read set and potentially result in better latency, but will also reduce data affinity of reads. Reads send to other than the preferred bookie have a low chance to be served from file system cache on that bookie, and will likely result in a physical read. Small thresholds therefore shuffle read requests more among bookies and may lead to reduced file system cache reach and increased physical reads on disks. A larger timeout will maintain data affinity and avoid above problems, but only kick in once a bookie has built-up a considerable queue of requests. It therefore masks only slightly larger outliers, and leads to overall better efficiency.--Master Issue: #1489--Author: Nicolas Michael <nmichael@salesforce.com>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1504 from nicmichael/ReadReordering, closes #1489;134a6c25a846731dc2ad0dc6c3e848170557b7b9
Allow to configure read-only mode in ZooKeeperClient--Underlying `Zookeeper` instance has an option to specify the client is fine to remain connected when the ZK quorum is lost, just in read-only mode.--We should expose the "allow read-only mode" option in `ZooKeeperClient`.--One example of use case for this flag is when connecting to a ZK ensemble that is just used for configuration/metadata store, in which no ephemeral nodes are used. It's therefore better to keep the connection with ZK and be able to keep reading (possibly stale) data from ZK rather than no read at all. Concrete use case is for ZK session for Pulsar global ZK ensemble, where we read configuration data and we don't really need to have a valid session when brokers are trying to read.--Author: Sijie Guo <sijie@apache.org>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1344 from merlimat/zk-client-read-only;9f55f78815c80d6b335d8e1cf6fd91196aeb8cff
Issue #1511: Upgrade nokogiri to version 1.8.2--Version <1.8.2 contain a security vulnerability.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1515 from ivankelly/nokogiri, closes #1511;53792ec1c3593a00f7b549fb6146182f8b74f10b
ISSUE #1490: BookieJournalForceTest is flaky--Descriptions of the changes in this PR:--### Motivation--The test cases in BookieJournalForceTest check if the forceWriteQueue is empty after everything is flushed.-However if `adaptiveGroupWrites` is enabled, the forceWrite thread will insert a marker entry into force write queue,-this will fail the forceWriteQueue length checking.--### Changes--Disable `adaptiveGroupWrites` in BookieJournalForceTest--Master Issue: #1490--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1512 from sijie/fix_journalforcetest, closes #1490;7b04ce80fd56250afa37efcb60b61a1bf235256a
[TABLE SERVICE] replaying TxnRequest is not implemented--*Motivation*--when enabling table service for pulsar at apache/incubator-pulsar#1922, I noticed that replaying TxnRequest is missed somehow.--*Solution*--This PR implements the replaying TxnRequest logic in the command process.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1505 from sijie/replay_txn_request;b65fa438d6212eb4a89a848b4f2642ba2ad573da
[TABLE SERVICE] Fix StringUtf8Coder and add VarIntCoder--Descriptions of the changes in this PR:--*Motivation*--The getSerializeLen() returned by StringUtf8Coder is different from the serialized buffer size.--*Changes*--- Fix StringUtf8Coder-- Add tests to coders-- Add a VarIntCoder--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1507 from sijie/fix_string_coder;42f6ea63ce6cd00cc699ff54272437aebbb985ca
Issue #1500: PendingReadOp.logErrorAndReattemptRead logs errors with debug level, some of them useful for troubleshooting at info/warn level--(bug W-3976846)--Descriptions of the changes in this PR:--Changed log level of one line from debug to info--### Motivation--Useful for troubleshooting of prod issue, don't want to have debug log enabled in prod all the time.--### Changes--Changed log level of one line from debug to info--Master Issue: #1500--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1501 from dlg99/fix/pendingreadop-log, closes #1500;fa58c9ac7b6efd95424319238993e8eb62fa6aa3
[TABLE SERVICE] Fix ZkClusterMetadataStoreTest--Descriptions of the changes in this PR:--### Motivation--initialize signature was changed. but the test was not changed.--### Changes--Fix the test case.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1506 from sijie/fix_zk_cluster_initialize;bacd4c12debdeeeeb30eec7666fcadee037cfc08
Issue #1498: Log messages/exception text in DiskChecker shows 'used <threshold' in 'used > threshold' situations--(bug W-3812505)--Descriptions of the changes in this PR:--Fixed log/exception text.--### Motivation--Reduced confusion when debugging an issue/going through the logs.--### Changes--replaced '<' with '>'--Master Issue: #1498--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1499 from dlg99/fix/diskchecker-log, closes #1498;6d13b8e90fa89b46cb847b0928c0a24dcd3ef2ea
[DEVTOOLS] Use ASF Jenkins API properly--Descriptions of the changes in this PR:--According to https://cwiki.apache.org/confluence/display/INFRA/Using+the+ASF+Jenkins+API,-we need to include 'tree' or 'depth' when using ASF jenkins API.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1503 from sijie/access_jenkins_apis_should_include_depth;852367f053a3268885718257cbac55b696117670
[WEBSITE] Include trademark attribution in footer--Descriptions of the changes in this PR:--According to http://www.apache.org/foundation/marks/pmcs#attributions, include trademark attribution in the footer.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1502 from sijie/update_trademarks;5b8614f088d470f2eb7d8fc96ef92e42a8e01cce
[BOOKIE] [DBLEDGERSTORAGE] fix illegal reference count exception on filling read cache--Descriptions of the changes in this PR:--*Problem*--ByteBuf is released at a finally block. DbLedgerStorage doesn't have to release it on return. If it does so, that will cause-double-release and it will throw IllegalReferenceCountException.--*Solution*--Remove `ByteBuf.release` at return.--Related Issue: #1487--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1488 from sijie/fix_double_release_on_db_ledgerstorage;4764c7637ecdcadfaddac74244d5c78449589c07
[CI] Allow selecting a list of precommit checks to skip in the pull request description.--Descriptions of the changes in this PR:--*Motivation*--precommit checks are good. however sometime it takes a long time to wait for precommit checks to complete,-for trivial changes (e.g. documentation, ci jenkins files, scripts, proposals).--*Changes*--This PR updates the PULL_REQUEST_TEMPLATE.md to provide a list of precommit checks to be allowed to skip.-So people can choose skip some precommit checks when filing a pull request.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1494 from sijie/skip_tests_is_too_general;2b66cb16d6f6a16c556ac304d3337a74f99a95df
[TABLE SERVICE] Move table service cli to bookkeeper-tools--Descriptions of the changes in this PR:--*Motivation*--This PR follows #1478  to move table service cli to bookkeeper-tools.-So different service components are now available in one cli tool.--*Changes*--- move stream/cli module to tools/stream module-- organize the table service commands as groups:--* cluster-* namespace-* table-* tables--*Output*--Example output:--```-$ bin/bkctl-bkctl interacts and operates Apache BookKeeper clusters--Usage:  bkctl [flags] [command group] [commands]--Commands:--    bookie          Commands on operating a single bookie-    bookies         Commands on operating a cluster of bookies-    cluster         Commands on administrating bookkeeper clusters-    ledger          Commands on interacting with ledgers-    namespace       Commands on operating namespaces-    table           Commands on interacting with tables-    tables          Commands on operating tables--    help            Display help information about it--Flags:--    -c, --conf-        Configuration file--    -n, --namespace-        Namespace scope to run commands (only valid for table service for now)--    -u, --service-uri-        Service Uri--    -h, --help-        Display help information--Use "bkctl [command] --help" or "bkctl help [command]" for more information-about a command-```--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1485 from sijie/stream_cli;2aad54347870bddc03aa071c67eac18a23beadff
ISSUE #1491: fix GLIBC_2.14 dep issue for protoc-3.5.1-linux-x86_64--Descriptions of the changes in this PR:--I tried to build the bookkeeper branch-4.7 on RHEL6 and ran into:--```- /lib64/libc.so.6: version `GLIBC_2.14' not found (required by bookkeeper-proto/target/protoc-plugins/protoc-3.5.1-linux-x86_64.exe)-```-This is similar to google/protobuf#4109 and it's related to google/protobuf#4138--We can take advantage of pulsar's fix apache/incubator-pulsar#1914 here--Master Issue:  https://github.com/apache/bookkeeper/issues/1491--Author: Ethan Li <ethanopensource@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1492 from Ethanlm/ISSUE-1491, closes #1491;dc30f4938664cbfe07f061e35007c37871ad6b28
RegionAwareEnsemblePlacementPolicy class should use super class's minNumRacksPerWriteQuorum variable--Descriptions of the changes in this PR:--RegionAwareEnsemblePlacementPolicy class should use minNumRacksPerWriteQuorum-variable which is declared in its super class - RackawareEnsemblePlacementPolicyImpl,-since it is related to its super class.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1484 from reddycharan/fixregpp;b8a5289a968e4afca2b7ef557fd978234c162b2f
[TABLE SERVICE] dlog configuration settings are not propagated--Descriptions of the changes in this PR:--*Motivation*--When stream storage server starts the bookie watcher service, it waits for at least `ensembleSize` bookies-available before starting other components. However the dlog settings are not propagated correctly. so when-using this component in an environment that only has 1 bookie (e.g. pulsar standalone). Startup will be hanging-on waiting 3 bookies.--*Solution*--load the dlog settings from the base configuration.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1486 from sijie/fix_loading_dlog_configuration;3a663e491e92c4f329dfde091f937f41dbb2cace
[TABLE SERVICE] Improve logging message on initializing table range stores.--Descriptions of the changes in this PR:--*Motivation*--Exceptions might be throwing on starting/stopping table ranges. It would be good to have logging messages about the state transition for debugging purpose.--*Build*--Only touch following stream modules, skip bookkeeper-server related tests:--[skip tests]--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1493 from sijie/improve_logging;798e6b8f3f26d55eef7ee50e8a4abe12db477e57
Improve merge script on checking the statuses of github checks (missing commit)--    Descriptions of the changes in this PR:--    *Motivation*--    Sometimes Jenkins CI job might already succeed, however they failed on publishing the build status-    to Github due to timeout (one example is attached below). In this case, we don't need to rerun the jenkins check again.--    ```-    Setting status of 55c1d54f3293e5166c59f238afd3fb3d98c7eb67 to SUCCESS with url https://builds.apache.org/job/bookkeeper_precommit_client_tests/21/ and message: 'SUCCESS-     '-    Using context: Jenkins: Client Tests-    Could not update commit status of the Pull Request on GitHub.-    org.kohsuke.github.HttpException: Server returned HTTP response code: -1, message: 'null' for URL: https://api.github.com/repos/apache/bookkeeper/statuses/55c1d54f3293e5166c59f238afd3fb3d98c7eb67-            at org.kohsuke.github.Requester.parse(Requester.java:633)-            at org.kohsuke.github.Requester.parse(Requester.java:631)-            at org.kohsuke.github.Requester.parse(Requester.java:631)-            at org.kohsuke.github.Requester.parse(Requester.java:594)-            at org.kohsuke.github.Requester._to(Requester.java:272)-            at org.kohsuke.github.Requester.to(Requester.java:234)-            at org.kohsuke.github.GHRepository.createCommitStatus(GHRepository.java:1075)-            at org.jenkinsci.plugins.ghprb.extensions.status.GhprbSimpleStatus.createCommitStatus(GhprbSimpleStatus.java:281)-            at org.jenkinsci.plugins.ghprb.extensions.status.GhprbSimpleStatus.onBuildComplete(GhprbSimpleStatus.java:239)-            at org.jenkinsci.plugins.ghprb.GhprbBuilds.onCompleted(GhprbBuilds.java:205)-            at org.jenkinsci.plugins.ghprb.GhprbBuildListener.onCompleted(GhprbBuildListener.java:28)-            at hudson.model.listeners.RunListener.fireCompleted(RunListener.java:211)-            at hudson.model.Run.execute(Run.java:1769)-            at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:43)-            at hudson.model.ResourceController.execute(ResourceController.java:97)-            at hudson.model.Executor.run(Executor.java:429)-    Caused by: java.net.SocketTimeoutException: Read timed out-            at sun.reflect.GeneratedConstructorAccessor10056.newInstance(Unknown Source)-            at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)-            at java.lang.reflect.Constructor.newInstance(Constructor.java:423)-            at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1944)-            at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1939)-            at java.security.AccessController.doPrivileged(Native Method)-            at sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1938)-            at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1508)-            at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)-            at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)-            at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347)-            at org.kohsuke.github.Requester.parse(Requester.java:602)-            ... 15 more-    Caused by: java.net.SocketTimeoutException: Read timed out-            at java.net.SocketInputStream.socketRead0(Native Method)-            at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)-            at java.net.SocketInputStream.read(SocketInputStream.java:171)-            at java.net.SocketInputStream.read(SocketInputStream.java:141)-            at sun.security.ssl.InputRecord.readFully(InputRecord.java:465)-            at sun.security.ssl.InputRecord.read(InputRecord.java:503)-            at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:983)-            at sun.security.ssl.SSLSocketImpl.readDataRecord(SSLSocketImpl.java:940)-            at sun.security.ssl.AppInputStream.read(AppInputStream.java:105)-            at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)-            at java.io.BufferedInputStream.read1(BufferedInputStream.java:286)-            at java.io.BufferedInputStream.read(BufferedInputStream.java:345)-            at sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:735)-            at sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:678)-            at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1587)-            at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)-            at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)-            at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347)-            at org.kohsuke.github.Requester.parse(Requester.java:602)-            ... 13 more-    Finished: SUCCESS-    ```--    *Changes*--    Improve the merge script to check jenkins status before treating the checks as failed.--    Author: Sijie Guo <sijie@apache.org>--    Reviewers: Enrico Olivelli <eolivelli@gmail.com>--    This closes #1497 from sijie/improve_merge_script;acec56f4928acbefbe3670ee0fdbf2c5d65f15d4
Improve merge script on checking the statuses of github checks--Descriptions of the changes in this PR:--*Motivation*--Sometimes Jenkins CI job might already succeed, however they failed on publishing the build status-to Github due to timeout (one example is attached below). In this case, we don't need to rerun the jenkins check again.--```-Setting status of 55c1d54f3293e5166c59f238afd3fb3d98c7eb67 to SUCCESS with url https://builds.apache.org/job/bookkeeper_precommit_client_tests/21/ and message: 'SUCCESS- '-Using context: Jenkins: Client Tests-Could not update commit status of the Pull Request on GitHub.-org.kohsuke.github.HttpException: Server returned HTTP response code: -1, message: 'null' for URL: https://api.github.com/repos/apache/bookkeeper/statuses/55c1d54f3293e5166c59f238afd3fb3d98c7eb67-	at org.kohsuke.github.Requester.parse(Requester.java:633)-	at org.kohsuke.github.Requester.parse(Requester.java:631)-	at org.kohsuke.github.Requester.parse(Requester.java:631)-	at org.kohsuke.github.Requester.parse(Requester.java:594)-	at org.kohsuke.github.Requester._to(Requester.java:272)-	at org.kohsuke.github.Requester.to(Requester.java:234)-	at org.kohsuke.github.GHRepository.createCommitStatus(GHRepository.java:1075)-	at org.jenkinsci.plugins.ghprb.extensions.status.GhprbSimpleStatus.createCommitStatus(GhprbSimpleStatus.java:281)-	at org.jenkinsci.plugins.ghprb.extensions.status.GhprbSimpleStatus.onBuildComplete(GhprbSimpleStatus.java:239)-	at org.jenkinsci.plugins.ghprb.GhprbBuilds.onCompleted(GhprbBuilds.java:205)-	at org.jenkinsci.plugins.ghprb.GhprbBuildListener.onCompleted(GhprbBuildListener.java:28)-	at hudson.model.listeners.RunListener.fireCompleted(RunListener.java:211)-	at hudson.model.Run.execute(Run.java:1769)-	at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:43)-	at hudson.model.ResourceController.execute(ResourceController.java:97)-	at hudson.model.Executor.run(Executor.java:429)-Caused by: java.net.SocketTimeoutException: Read timed out-	at sun.reflect.GeneratedConstructorAccessor10056.newInstance(Unknown Source)-	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)-	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)-	at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1944)-	at sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1939)-	at java.security.AccessController.doPrivileged(Native Method)-	at sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1938)-	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1508)-	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)-	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)-	at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347)-	at org.kohsuke.github.Requester.parse(Requester.java:602)-	... 15 more-Caused by: java.net.SocketTimeoutException: Read timed out-	at java.net.SocketInputStream.socketRead0(Native Method)-	at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)-	at java.net.SocketInputStream.read(SocketInputStream.java:171)-	at java.net.SocketInputStream.read(SocketInputStream.java:141)-	at sun.security.ssl.InputRecord.readFully(InputRecord.java:465)-	at sun.security.ssl.InputRecord.read(InputRecord.java:503)-	at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:983)-	at sun.security.ssl.SSLSocketImpl.readDataRecord(SSLSocketImpl.java:940)-	at sun.security.ssl.AppInputStream.read(AppInputStream.java:105)-	at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)-	at java.io.BufferedInputStream.read1(BufferedInputStream.java:286)-	at java.io.BufferedInputStream.read(BufferedInputStream.java:345)-	at sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:735)-	at sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:678)-	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1587)-	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492)-	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)-	at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347)-	at org.kohsuke.github.Requester.parse(Requester.java:602)-	... 13 more-Finished: SUCCESS-```--*Changes*--Improve the merge script to check jenkins status before treating the checks as failed.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1497 from sijie/improve_merge_script;204341825d616ee8e31317a2a0230049b2f4d03f
Remove phrase trigger on post commit jobs--Descriptions of the changes in this PR:--*Problem*--After enabling phrase trigger on precommit jobs to allow rerun individual precommit jobs, "retest this please" will run all the jobs including postcommit jobs.--*Solution*--Running postcommit jobs on pull requests doesn't make sense. This PR removes all the phrase trigger from postcommit jobs.--Additionally, fixes typos and also increases the timeout for integration tests.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1482 from sijie/fix_typoes;08c115568b1ef63bcbfd885f5ef252b4f3db0720
Fix checkstyle in EntryLogTest--Descriptions of the changes in this PR:--*Problem*--PR #1465 introduces a checkstyle error, but somehow it wasn't caught by CI jobs.--*Solution*--Fix the checkstyle error and bring master back to normal.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1483 from sijie/fix_checkstyle_complains_entrylogtest;9a0bf5a0d9fc6606a57ff87bdb484386e4caab49
Upgrade RocksDB to 5.13.1--Upgrade RocksDB version to include a fix for empty SSTs written by flushing with deleteRange() operations that cause assertion failures on DB open.--Description can be found at : facebook/rocksdb#2717--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1466 from merlimat/upgrade-rocksdb;7bbd3dee4e060046fcdf06294bb9d18bb22b41b9
Metrics for EntryLogManagerForEntryLogPerLedger.--Descriptions of the changes in this PR:--Add counters/statsloggers for EntryLogManagerForEntryLogPerLedger.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1460 from reddycharan/elmmetrics;bfa4f9d5f10897ea854865d260248af9de6e10be
Update the new bookkeeper tools to use the new framework--Descriptions of the changes in this PR:--*Motivation*--#1471  introduces a new tools framework based on jcommander. This PR is changing the new bookkeeper-tools to leverage that framework.--*Solution*--- Changed the related classes to use the new framework.-- Rename `BookKeeperCLI` to `BKCtl` and `bookkeeper-cli` to `bkctl`-- Use service loader to load command groups to allow better extensibility-- Rename command group `cluster` to `bookies`--*Results*--Example output of this change:--```-$ bin/bkctl-bkctl interacts and operates Apache BookKeeper clusters--Usage:  bkctl [flags] [command group] [commands]--Commands:--    bookie      Commands on operating a single bookie-    bookies     Commands on operating a cluster of bookies-    ledger      Commands on interacting with ledgers--    help        Display help information about it--Flags:--    -c, --conf-        Configuration file--    -u, --service-uri-        Service Uri--    -h, --help-        Display help information--Use "bkctl [command] --help" or "bkctl help [command]" for more information-about a command-```--*sub command*-```-$ bin/bkctl help bookie-Commands on operating a single bookie--Usage:  bkctl bookie [command] [command options]--Commands:--    lastmark        Print last log marker--    help            Display help information about it--Use "bkctl bookie [command] --help" or "bkctl bookie help [command]" for more-information about a command-```--*sub-sub command*--```-$ bin/bkctl bookie help lastmark-Print last log marker--Usage:  bkctl bookie lastmark [flags]--Flags:--    -h, --help-        Display help information-```--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1478 from sijie/bkctl_tools;b9b46172c4f7ac1aa2a42ff8b0fceb24ef03ed68
Append ledgersMap when entrylog is removed from cache.--Descriptions of the changes in this PR:--In EntryLogManagerForEntryLogPerLedger when ledger-entrylog-entry is removed from cache, it will be moved to-rotatedEntryLogs list. Before moving it to rotatedEntryLogs,-ledgersMap should be appended.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1465 from reddycharan/fixappendledgersmap;1b5aba204e0e8b3ae85d467abd42e0478bea99df
Improve precommit build time--Descriptions of the changes in this PR:--*Motivation*--The build/test time of `bookkeeper-server` is almost close to or more than 1 hr.--*Solution*--Split the precommit jobs into multiple jobs:--- *PR Validation* : run `apache-rat:check`, `checkstyle:check`, to ensure codestyle and license headers-- *Build (Java x)* : run `package` `spotbugs:check`, to ensure PR can be compiled and tested on different java environments. No spotbugs errors. `bookkeeper-server` tests are skipped.-- *Integration Tests* : run integration tests with docker environment-- *bookkeeper-server Tests* : tests `bookkeeper-server` on certain packages:-  - bookie: `org.apache.bookkeeper.bookie`-  - client: `org.apache.bookkeeper.client`-  - replication: `org.apache.bookkeeper.replication`-  - tls: `org.apache.bookkeeper.tls`-  - all others: all other tests in `bookkeeper-server` module--Each job can be triggered and skipped individually.--- *PR Validation* : "(re)run pr validation" | "" (unskippable)-- *Build (Java x)* : "(re)build java(8|9)" | "skip build java(8|9)"-  - "(re)build" to build on both java8 and java9-  - "skip build" to skip building jobs on both java8 and java9-- *Integration Tests* : "(re)run integration tests" | "skip integration tests"-- *bookkeeper-server tests* : "(re)run (bookie|client|replication|tls|remaining) tests" | "skip (bookie|client|replication|tls|remaining) tests"-  - "(re)run tests" to run all bookkeeper-server test jobs-  - "skip tests" to skip all bookkeeper-server test jobs--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1481 from sijie/improve_build_time;9ca77faf2ab2d175a7bdefec94f5d9a47b08d4f8
Throttle integration tests to run 1 build per host--Descriptions of the changes in this PR:--If running multiple integration tests build on same host, they will be conflicting on installing docker images. So throttle integration tests to run max 1 build per host.--See discussions at : http://mail-archives.apache.org/mod_mbox/pulsar-dev/201806.mbox/%3CCAJdLeK0nj9n-TKC4t43Nyc8bO9UUW17wM%2By_fF68EgFL6Fpo8w%40mail.gmail.com%3E--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1480 from sijie/disable_concurrent_builds;ecf5de6af7f90a3bf5a8a65177bff6078995112c
Abstract the tools framework to allow merging multiple CLI tools together--Descriptions of the changes in this PR:--*Motivation*--There are multiple CLI tools spreading across multiple places, e.g. new bookkeeper cli, stream storage cli and dlog. There have similar implementations. It would be better to consolidate all these tools in one place `bookkeeper-tools`.--This is a PR to prepare moving `stream/cli` to be part of bookkeeper-tools.--*Solution*--- Abstract the CLI logic in bookkeeper-tools into a simple tools framework that can be reused in a extensible way to unify multiple tools together.-- organize the tools module into tools/framework and tools/all--*Result*--Example output of the tool using this framework is listed as below:--```-$ bin/bkctl-bkctl interacts and operates Apache BookKeeper clusters--Usage:  bkctl [flags] [command group] [commands]--Commands:--    bookie          Commands on operating a single bookie-    bookies         Commands on operating a cluster of bookies-    cluster         Commands on administrating bookkeeper clusters-    ledger          Commands on interacting with ledgers-    namespace       Commands on operating namespaces-    table           Commands on interacting with tables-    tables          Commands on operating tables--    help            Display help information about it--Flags:--    -c, --conf-        Configuration file--    -n, --namespace-        Namespace scope to run commands (only valid for table service for now)--    -u, --service-uri-        Service Uri--    -h, --help-        Display help information--Use "bkctl [command] --help" or "bkctl help [command]" for more information-about a command-```--*result from help sub-command*--```-$ bin/bkctl help table-Commands on interacting with tables--Usage:  bkctl table [command] [command options]--Commands:--    get         Get key/value pair from a table-    inc         Increment the amount of a key in a table-    put         Put key/value pair to a table--    help        Display help information about it--Use "bkctl table [command] --help" or "bkctl table help [command]" for more-information about a command-```--*result from help sub-sub-command*--```-$ bin/bkctl table help inc-Increment the amount of a key in a table--Usage:  bkctl table inc [flags] <table> <key> <amount>--Flags:--    -h, --help-        Display help information-```--Master Issue: #1000--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1471 from sijie/tools_framework;879253176ac3df556242d0dacd7440b6e501af19
Improve precommit CI jobs on handling PRs made to branches--Descriptions of the changes in this PR:--*Motivation*--Current precommit CI jobs uses `master` as target branch for applying the pull requests.-However pull requests might be made against branches. e.g. #1469, precommit jobs can't run properly on those pull requests. This PR tends to address the problem.--*Solution*--Use `ghprbTargetBranch` as the build branch for precommit jobs.--Besides that, split the validation goals (e.g. checkstyle, apache-rat) from build/test goals (package, spotbugs), this reduces build time for different jdk versions and address problem when running checkstyle:check with other goals (e.g. deploy).--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1475 from sijie/run_precommit_jobs_over_target_branches;9e937cfc9da15521fff1946ad3470d1f35b3b016
Improve merge script to merge PRs based on branches--Descriptions of the changes in this PR:--*Motivation*--Merge script doesn't handle well on handling PRs based on branches. So committers ended up-using merge button to merge PRs. so we lose a lot of informations such as descriptions, reviewers-in the commit message.--*Solution*--This PR fixes the problems on handling merging PRs based on branches.--This allows us merging #1469 using merge script.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1477 from sijie/merge_pull_request_from_branch;7a2612076eba9fbfd32aa177c66e4a1d0b58edf6
Support build on JDK10--- switch to "javac -h" in circe-checksum instead of 'javah' because in JDK10 javah has been dropped (see http://openjdk.java.net/jeps/313)-- add openjdk10 to Travis-CI--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1470 from eolivelli/nar-jdk10;4582050a8d51139dc4302a010a7bbd837d849cf8
ISSUE #1472: [TABLE SERVICE] TestStorageClientBuilder.testBuildClientInvalidNamespaceName failed--Descriptions of the changes in this PR:--*Problem*-- #1457 changed the validation of namespace/stream name. so "-" is a valid character.--*Solution*--Fix the test.--Master Issue: #1472--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1473 from sijie/fix_storage_client_builder, closes #1472;0cb9de02c3734f7811c0b36e32e612542533791a
Issue #1467: build failing with MavenReportException: Error while generating Javadoc. (#1468);9472596792932cb785ac842544b45cc45bcf6578
Issue #1409: Added server side backpressure (@bug W-3651831@) (#1410)--(@bug W-3651831@) backpressure: server-side backpressure;319f761ca1769d0b35aa70c99b3a1ea8795acaf8
[CI] Run integration tests concurrently if possible--Descriptions of the changes in this PR:--Execute integration tests concurrently if necessary.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1463 from sijie/concurrent_builds;9b1cffd1332e1748aed994e520daa1d04a1ee82f
ISSUE #1455: Revert ": Unable to process suppressions file during checkstyle execution"--Descriptions of the changes in this PR:--This reverts commit 4bc021a438ca1e5acff23f7e3cb6cdb6984c1066 to address the issue we saw in #1461--Related Issue: #1456--This fixes #1461--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1462 from sijie/fix_maven_builds, closes #1455;1f4217609f9e77d6ec7158e6158e0683308abd09
ISSUE #1458: [CI] Fix bookkeeper-seed CI Job--Descriptions of the changes in this PR:--*Motivation*--Issue #1454 introduced a typo, which cause the seed job can not parse groovy DSL files.--*Solution*--Fix the typo.--Master Issue: #1458--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1464 from sijie/fix_job_seed, closes #1458;cf6d8b40da75e8f02ca3790763bc9c70d1d677ef
BP-33: Move releasing official docker images out of main repo--Descriptions of the changes in this PR:--*Motivation*--Current bookkeeper docker images are auto-built by apache docker account. However it becomes problematic in the release process:--Docker autobuild uses release tag for labeling the versions for docker images. But the Dockerfile can only be updated after a release is successfully made. So we have to retag a release after a release, in order to update Dockerfile to build the docker images.--Master Issue: #1449--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1450 from sijie/official_docker_images;a804faeafe40e1ffd74e85e8f7104811c02cd8c4
[TABLE SERVICE] cleanup : provide unified service uri for resolving service endpoints--Descriptions of the changes in this PR:--*Motivation*--Currently there are multiple settings in `StorageClientSettings` on configuring how to resolve-service endpoints to find the services. It is a bit inconvinient and confusing--*Solution*--Provide a class `ServiceURI` for parsing service uri to retrieve common informations including:--- serviceName-- serviceInfos-- serviceUser-- serviceHosts-- servicePath--It extends the java.net.URI and does parsing and validation in the same place. Then it can be used-by the grpc name resolver to resolve service endpoints.--Also update dlog to use it for resolving its namespace uri.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1459 from sijie/name_resolver;24e097f8d518d574db7aefd04d2d2cbaba8ea425
Make bookkeeper-server module buildable on jdk10--Upgrade lombok and javadoc plugin to latest versions.-This way it is possible to work on most of the modules using JDK10.--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1453 from eolivelli/fix/build-jdk10;5521a9f9109c59733323760fe54c4149635be633
[TABLE SERVICE] cleanup : cleanup protobuf definitions--Descriptions of the changes in this PR:--*Motivation*--There are some unused fields and some fields that were not renamed correctly from col to namespace.--*Solution*--This is a cleanup PR to remove unused fields and rename "col" to "ns" or "namespace".--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1457 from sijie/cleanup_fields;f65d47f0e0df796ed4b4bd6e028994ad2592dfd1
[TABLE SERVICE] remove StorageContainerRequest and StorageContainerResponse--Descriptions of the changes in this PR:--*Motivation*-- #1448 uses reverse proxy for serving storage container requests and responses. so the `StorageContainerRequest` and `StorageContainerResponse`- become redundant.--*Solution*--removes `StorageContainerRequest` and `StorageContainerResponse`--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1452 from sijie/remove_storage_container_request_response;27c13835d3facf4618706079ebd704c0d8f163e1
Issue 1455: Unable to process suppressions file during checkstyle execution--Descriptions of the changes in this PR:--*Motivation*--Failed to run `mvn clean apache-rat:check checkstyle:check install -DskipTests`--```-[ERROR] Failed to execute goal org.apache.maven.plugins:maven-checkstyle-plugin:3.0.0:check (default-cli) on project bookkeeper-stats-api: Failed during checkstyle execution: Unable to process suppressions file location: bookkeeper/suppressions.xml: Cannot create file-based resource:invalid block type -> [Help 1]-[ERROR]-[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.-[ERROR] Re-run Maven using the -X switch to enable full debug logging.-[ERROR]-[ERROR] For more information about the errors and possible solutions, please read the following articles:-[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException-[ERROR]-[ERROR] After correcting the problems, you can resume the build with the command-[ERROR]   mvn <goals> -rf :bookkeeper-stats-api-```--*Solution*--- Make `buildtools` not inherit from bookkeeper root pom.-- Make bookkeeper root pom includes `buildtools` as a `provided` dependency for each module.--Master Issue: #1455-Related Issues: #1435--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1456 from sijie/fix_ci_failure;4bc021a438ca1e5acff23f7e3cb6cdb6984c1066
Update release procedure to use candidate tags for voting--Descriptions of the changes in this PR:--*Motivation*--We used final release tag during release voting procedure. However there might be changes-happen between different candidate votes. So we ended up retagging the release tag for-different votes.--*Solution*--Use a candidate tag for voting. After a release is approved, create the final release tag.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1451 from sijie/update_release_guid;254b4464ca2a8775afb3b1ac2eba57ca920b36a4
Allow CI to publish a snapshot version with gitsha information--Descriptions of the changes in this PR:--*Motivation*--Currently bookkeeper publishes a snapshot release nightly to maven artifacts. It provides a convenient solution for people to try out new bookkeeper releases as soon as the changes land in master branch. However sometime it is also problematic when you reference this snapshot version in other projects, subsequent changes in bookkeeper might potentially break those projects.--*Solution*--Update the CI to provide a mechanism to publish a snapshot version with gitsha information. so it can publish a snapshot version that is pinned to the given gitsha. so the projects can safely use a snapshot version for development without worrying bookkeeper changes break it.--*NOTES*--The mechanism is a manual operation. It should be used when it is needed.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1454 from sijie/publish_snapshot_with_gitsha;16ef25b64ef3f9a3bef00a382dc1ae2a58bdd108
[TABLE SERVICE] use grpc reverse proxy to serve storage container requests--Descriptions of the changes in this PR:--*Motivation*--#1430 introduced client interceptor and grpc reverse proxy for storage container requests. This PR is the subsequent change to leverage client interceptor and reverse proxy for storage container requests.--*Changes*--**Client Changes**--Changed `StorageContainerChannel` to add client interceptor to stamp storage container id into the the requests' metadata.--**Server Changes**--- moved the stream storage logic out of storage containers to a `service` package. the main logic will be kept in `RangeStoreService` and `RangeStoreServiceFactory`.-- make the storage container logic for hosting `StorageContainerService`.-- Each storage container will run an inprogress grpc server for serving the grpc services registered to the container and provide an `channel` for accessing those grpc service.-- Changed the server to use reverse proxy for serving/proxying storage container requests.--*NOTE*--This change doesn't directly remove `StorageContainerRequest` and `StorageContainerResponse`.  It would be done in a subsequent change.--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1448 from sijie/storage_container_channel;305e3fb327a4ef478b0c69a8a9389fd68c6cdd12
Include stream modules in bookkeeper distributions only when `-Dstream` is specified--Descriptions of the changes in this PR:--*Motivation*--stream modules are only built when `-Dstream` is specified. so if we want to include-binary distribution, `-Dstream` is needed. This updates those modules with profiles-that enabled when `-Dstream` is specified.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1447 from sijie/fix_stream_module;ed895a160444cb1866467d25148b16b6629991ce
Add printreplicationworkerid option to ListUnderreplicatedCmd.--Descriptions of the changes in this PR:--Add printreplicationworkerid option to ListUnderreplicatedCmd.-This helps in knowing who is holding lock on UnderReplicated ledger,-and diagnosing that ReplicationWorker if we are seeing any issues in-rereplication.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1446 from reddycharan/printreplicationworkerid;42aae8d8abe5ee13e5b76283adadd3456cf87558
[TABLE] mark TableClientTest & TableClientSimpleTest as FlakyTest--Descriptions of the changes in this PR:--*Motivation*--These two integration tests are flaky on shutting down. Mark them as `FlakyTest` to make CI stable while investigating the issue.--*Changes*--Move `FlakyTest` annotation from bookkeeper-server test jar to bookkeeper-common test jar. So it can be used across multiple modules.--At the same time, remove redundant `FlakyTest` annotation at distributedlog-core module.--Related Issue: #1440--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1445 from sijie/mark_two_integration_tests_as_flaky;1457825086a5a73cda2142e0984e7c858e185b8a
Update bookkeeper dependencies : netty/protobuf/grpc--Descriptions of the changes in this PR:--*Motivation*--The netty version in bookkeeper is a bit dated than the version in pulsar.-Hence the grpc version is limited to the version that use same netty version.-It causes issues at pulsar using bookkeeper, because pulsar has been using-a newer version for longer time. This causes conflicts when pulsar client and-grpc are used together without proper shading.--*Solution*--Upgrade netty/protobuf/grpc dependencies.--- update netty from `4.1.12` to `4.1.22`, which is the one grpc is using and closer to the one that pulsar is using.-- update grpc from `1.5.0` to `1.12.0`, which is using netty `4.1.22` and protobuf `3.5.1`.-- update protobuf from `3.4.0` to `3.5.1`--Related Issue: apache/pulsar#1844--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1441 from sijie/bump_grpc_version;7ea615e1a2a0f661cadf89fea3c668c82969cbb7
Provide the flag to allow ignoring startup failures on loading extra server components--Descriptions of the changes in this PR:--Addressed the comments in apache/bookkeeper#1420--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1426 from sijie/flag_to_allow_silent_failures;5fb4112eee2a54232995e06f2a5f1acffe4a5929
ISSUE #1442: Assembly descriptor contains a filesystem-root relative reference '/'--Descriptions of the changes in this PR:--*Motivation*--Warnings on buidling bookkeeper dist packages. See #1442.--*Solution*--Remove "/" from the relative reference.--See https://lonelycoding.com/maven-assembly-plugin-warning-the-assembly-descriptor-contains-a-filesystem-root-relative-reference/ for details.--Master Issue: #1442--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1443 from sijie/address_assembly_warnings, closes #1442;7075e364fcfe871441c3eef58d85d6f0484ca956
Fix checkstyle warnings--Descriptions of the changes in this PR:--*Motivation*--There were two concurrent PRs merged at the same time.--apache/bookkeeper#1435 (checkstyle changes) was merged before apache/bookkeeper#1430. so checkstyle warnings-introduced by apache/bookkeeper#1430 were not caught by any CI jobs.--*Solution*--Address the checkstyle warnings introduced by apache/bookkeeper#1430--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1444 from sijie/fix_checkstyle_issue;059ebafd63fc7ca99e5e418d83c2b19b1275cade
[TABLE SERVICE] client interceptor and storage container grpc proxy--Descriptions of the changes in this PR:--This is a subsequent change after apache/bookkeeper#1428.--*Motivation*--Current almost every grpc requests are wrapped into `StorageContainerRequest` and their responses-are wrapped into `StorageContainerResponse`. It makes things a bit complicated on adding new grpc-services.--*Changes*--To simplify things, this PR introduces two functionalities for simplifying dispatching container requests/responses.--1) *StorageContainerClientInterceptor*: A grpc `ClientInterceptor` that stamps container information (currently is `scId`) into the requests' metadata before sending the requests to the wire.--2) A simple grpc reverse proxy to dispatch grpc requests to the channels provided by a `ChannelFinder`.--*Tests*--1. Existing unit tests covered client interceptor changes.-2. Introduced a `stream-storage-tests-common` module to include common classes that would be used for testing.-3. Introduced a `PingPongService` for testing reverse proxy : unary/client-streaming/server-streaming/bidi-streaming.--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1430 from sijie/interceptor_container_requests;bff7106b307ee9a2cac041c1f1048478e03e6b24
Issue #1434: Checkstyle is not executed at some modules--Descriptions of the changes in this PR:--*Motivation*--Checkstyle was supposed to run at `validate` phase for every modules. However checkstyle is not running at some modules.-This introduces inconsistency between modules.--*Changes*--- Fix Checkstyle warnings.-- Remove `checkstyle` plugins from modules, only leave it at root pom file or modules that have overrides. This improves default build time.-- Add `checkstyle:check` to CI jobs.--*NOTES*--`microbenchmarks` has too many checkstyle volations. so skip checkstyle for this PR.--Master Issue: #1434--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1435 from sijie/checkstyle_tests, closes #1434;6bfad08b4851406c219c1b5dc445c33453e7ecc4
Use maven-exec-plugin to get the maven project version for CI jobs--Descriptions of the changes in this PR:--*Motivation*--The current approach to get project version isn't reliable on CI environment. It might have garbage output (e.g. exceptions).--*Solution*--Changed to use `exec-maven-plugin` to echo `${project.vesion}`. It provides a more reliable approach to get version on CI environments.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1437 from sijie/fix_getversion_problem;78ccddfeeda9de0187fc379799507d27fa2aaeaf
ISSUE #1438: BookKeeperVerifierMain: fix typo for drain_timeout argument--(bug W-5025785)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1439 from athanatos/forupstream/wip-1438, closes #1438;3aeda6fc98f379e4fa663807c3fd9d75e6092b2a
Allow overriding `redirectTestOutputToFile` with environment settings--Descriptions of the changes in this PR:--Some modules (e.g. `tests/integration`) are allowed to override `redirectTestOutputToFile` behavior; while some are disallowed.--This PR is to make all modules are allowed to override that setting.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1432 from sijie/make_redirectTestOutputToFile_configurable;8f48b0e305430d767f665c408450351ae067d19e
Exclude `.vagrant` from apache-rat:check--Descriptions of the changes in this PR:--*Motivation*--apache/bookkeeper#1401 provides a `Vagrantfile` for running integration tests on linux vm.-A `.vagrant` directory will be left under `dev` directory, which it will fail `apache-rat:check`.--*Solution*--Exclude `.vagrant` directory from apache-rat check--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1431 from sijie/fix_apache_rat_check;0c14137dd515c71e2d68da07c78cc5772a2ad25a
Fix bookkeeper post commit CI--Descriptions of the changes in this PR:--*Motivation*--apache/bookkeeper#1422 includes stream storage integration tests in tests/integration.-so we need to include `-Dstream` on building the tests.--*Solution*--Update the bookkeeper post commit CI jobs to include `-Dstream`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1429 from sijie/fix_post_commit_ci;e475ac3343f51b7ee0796eebecad829330baa92a
[TABLE SERVICE] Move grpc services from server module to storage module--Descriptions of the changes in this PR:--*Motivation*--Current almost every grpc requests are wrapped into `StorageContainerRequest` and their responses-are wrapped into `StorageContainerResponse`. It makes things a bit complicated on adding new grpc-services.--To simplify things, we can use grpc ClientInterceptor to stamp container information (e.g. scId)-into the request metadata and write a grpc service registry to take the container information from-request metadata and dispatch requests to containers.--In order to achieve it, we need to move the grpc services to storage container.--*Solution*--This PR moves grpc services from server module to storage module, so we can simplify the wire protocols.--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1428 from sijie/move_grpc_service_to_storage;ea0b90cd9971b99be17b4e1ae9dbcd66c630daa6
Publish bookkeeper dev image to docker hub--Descriptions of the changes in this PR:--*Motivation*--We built a `bookkeeper-current` image that reflects latest master for integration tests. However currently we don't publish this docker image to any docker registry. So it is inconvenient to test latest master in dockerized environments.--*Solution*--- Add a dev script to publish `bookkeeper-current` image to configured docker registry specified at `DOCKER_REGISTRY`-- Update the nightly snapshot job to publish generated `bookkeeper-current` image to docker hub `apachebookkeeper`-- Add `bin/standalone` script to use `docker-compose` to launch a 3-nodes bookkeeper cluster locally. The script generates docker-compose.yml and handles mounting local volumes and port forwarding. so developers can use that for quick development.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1427 from sijie/push_current_docker_image;b0b69a337b4220752dfb512fdb99cfc5bdab564a
[TABLE SERVICE] Move integration tests under `stream/tests/integration` to `tests/integration/cluster`--Descriptions of the changes in this PR:--The original integration tests were written based a non-dockerized standalone stream cluster. Moved them to use-the dockerized integration test framework. So all the integration tests are actually testing the table service run as part of bookies.--This change is based on #1422 .-a371ff2 is the change in this PR to be reviewed.--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1423 from sijie/move_more_stream_it_tests;e34dd384c865a3494079ec9f38e4a0d87bd0ce51
ISSUE #1415: [DLOG] org.apache.distributedlog.fs.TestDLFileSystem fails on CI--Use a generated tempDir for DL FS tests instead of using an hard coded /tmp path--Fix for #1415--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1417 from eolivelli/fix/no-tmpdir-fsdl, closes #1415;206443dff3fde2ca2eaa355b9799ecc6d5100988
[TABLE SERVICE] start table service as an extra component of bookie--Descriptions of the changes in this PR:--*Motivation*--table service was built over bookkeeper ledgers. it is an extension to bookies' functionalities, so it is much convenient to start the service as one additional component with bookie, just like how we start `AutoRecovery` along with bookie.--*Solution*--- include `stream/server` module as part of bookkeeper server/all binary distributions-- abstract `StorageServer` to allow controlling whether to start bookie or not-- provide a ServerLifecycleComponent of `StorageServer`, so it can be used as an extra component of bookie--*Tests*--- improve the integration tests to start table service as part of bookie containers-- move `LocationClientTest` to container based integration tests--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1422 from sijie/start_table_service;f4e234439ef45bdedb244bc2375e2f9d0426c20c
BP-14 WriteFlag DEFERRED_SYNC Client Side Implementation--Introduce implementation of WriteFlag#DEFERRED_SYNC on LedgerHandle (purely client-side).--Tests are only on the client-side (with Mockito), there is no implementation on the bookie side. Most significant tests will come with the force() API, at this point we can only test that we have not broken the LAC advance mechanism.--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV)--This closes #853 from eolivelli/bp14-deferred-force-write-client-side;9655943e6be5ac86060134c16ec24d6f0c822f56
Allow bookie to start if failed to load extra server components--Descriptions of the changes in this PR:--*Motivation*--`extraServerComponents` provides the flexibility to allow bookie to start with extra server components.-It acts as a plugin mechanism to extend the functionality of bookies. However it is okay to allow bookie-start up when failed to load extra server components.--This is a change for allowing starting table service as extra components in bookies.--*Solution*--Catch the exception and log it when failed to load extra server components.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1420 from sijie/allow_start_bookie;c8bcecc3fb38932a2e6444d5362ad1d82ee630af
Build stream modules for integration tests--Descriptions of the changes in this PR:--*Motivation*--apache/bookkeeper#1422 adds table service as part of integration tests. so we need to build stream modules-in order to run integration tests for apache/bookkeeper#1422--*Solution*--Add "-Dstream" in the maven commands for `precommit-integrationtests` CI job.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1424 from sijie/compile_stream_module;445347cdc82aef61104bb8afced6b333bfc041b9
Provide a util method to run functions with metadata client driver--Descriptions of the changes in this PR:--*Motivation*--Currently `MetadataDrivers` provides util methods to run functions with metadata bookie driver.-It is convinient to provide a util method to run functions with metadata client driver as well.--*Solution*--Provide a util method `runFunctionWithMetadataClientDriver` to run functions with metadata client driver.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1421 from sijie/utils_to_run_client_driver;f6778ab7c1424bc5d71b6b52337649c0b06ae669
Fix dev/check-binary-license on macOS--Descriptions of the changes in this PR:--*Motivation*--`dev/check-binary-license` is used for checking whether LICENSE files are updated to reflect the dependencies included in the distribution packages.-However this script doesn't work on macOS, which makes the development on macOS inconvinient.--*Solution*--The change removes `--wildcards` from tar command. The option only works on linux machines.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1418 from sijie/fix_check_license_script_master;44259ab273589c1ec5d04c7e8653d21d443da34e
Issue #570: EntryLogManagerForEntryLogPerLedger implementation--Descriptions of the changes in this PR:--This is < sub-task6  > of Issue #570--introducing EntryLogManagerForEntryLogPerLedger, which is the-implementation of EntryLogManager for entrylog per ledger-feature.--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Andrey Yegorov <None>, Sijie Guo <sijie@apache.org>--This closes #1391 from reddycharan/entrylogmanagerentrylogperledger, closes #570;916cd6655a70407e8c251c74814543ba1dbcf026
Provide zookeeper startup script--Descriptions of the changes in this PR:--*Motivation*--ZooKeeper is a dependency of bookkeeper shipped along with bookkeeper dist package. However we never provide any script to startup zookeeper in the bookkeeper binary package and never test the zookeeper version shipped along with bookkeeper--*Solution*--- add zookeeper in `bin/bookeeper` scripts to start zookeeper using bookkeeper scripts-- refactor bookkeeper docker scripts to start bookie/zookeeper/standalone-- use zk adminPort for health check, since 4letters commands are explicitly disabled at 3.5--*Tests*--Existing integration tests test the docker scripts and the bash script changes to start zookeeper.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1416 from sijie/package_zookeeper;0fd1f4f81ff9acf3ab6776a8afc5f3673b786a2d
Bookies should be from different racks in a Writequorum.--Descriptions of the changes in this PR:--Ideally RackAwareEnsemblePlacementPolicy should try to select-bookies from different racks for a write quorum. So in a-WriteQuorum, bookies should be from WriteQuorum number of racks,-provided there are sufficient number of available racks and-bookies.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1397 from reddycharan/configracks;9ba4c4e0d8be770e03110a958fb8b75a65ae0f59
Add a docker based `BookKeeperClusterTestBase` for failure related integration tests--Descriptions of the changes in this PR:--*Motivation*--Currently we don't have any failure related testing for table service. Since we are using docker as the integration testing infrastructure,-It is better to use container for those failure testings, rather than going down the path as what we did before.--*Solution*--This change provides the basic test base for bookkeeper cluster using dockers. `BookKeeperClusterTestBase` provides the similar functionalities-to start/stop bookies as what we did in the unit test.--`bookkeeper/tests/containers` in `integration-tests-topologies` provides all the basic containers used for testing.-`tests/integration/cluster` and `tests/integration/topologies` provides the test base for writing tests using dockerized bookkeeper cluster.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1412 from sijie/docker_cluster_dev;5bdfbf6a673b69a9027f85ad4e82c427d41646be
Add a test docker image for current version only--Descriptions of the changes in this PR:--*Motivation*--The current test images don't use any scripts that shipped with official docker image.-We basically don't have any test coverage on the official docker image we shipped for each release.--*Solution*--Introduce a `bookkeeper-current` image representing an image for latest master.--Use `apachebookkeeper/all-versions-image` for BC tests, use `apachebookkeeper/bookkeeper-current` as tests only needs latest master image.--Add an integration test to test standalone mode using the `bookkeeper-current` image--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1408 from sijie/docker_dev;2414ce0526f64663d6ceab1b642862ff6f8eb1fa
Issue #1405: ReplicationWorker should back-off retrying.--Descriptions of the changes in this PR:--ReplicationWorker should backoff replication-after threshold number of replication failures of a ledger.--Currently ReplicationWorker will do busy retrials if-replication is failed for a ledger, instead it should-backoff if replication had failed for threshold-number of times. This can be done by deferring-releasing of underreplicated lock by-'lockReleaseOfFailedLedgerGracePeriod' amount-of time.--Master Issue: #1405--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1406 from reddycharan/fixreplicator, closes #1405;8c077a93e50ea844e0c39ca042ed2aa8cbd6d256
ISSUE #1390 Ensemble change on delayed write error--Error on delayed writes are dropped if the addEntry-is in complete state (ack quorum satisfied).-This change records the delayed write failure and forces-ensemble change onthe next write. This saves from having-extended under replicated status on the ledger and also-avoids unnecessary build up at PCBC channel.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Descriptions of the changes in this PR:--(PR description content here)...--Master Issue: #<master-issue-number>--Author: JV Jujjuri <vjujjuri@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1395 from jvrao/bk-issue-1390-delayedWriteError, closes #1390;a26747890195549e21d48d3fee4f36251ee613d6
Refactor bookkeeper bash scripts and move dlog script to root bin directory--Descriptions of the changes in this PR:--*Motivation*--Since 4.7, we have moved bash scripts and configuration to the root directory. However the scripts and configurations for dlog and table-service modules are still in their own modules. It is inconvenient and confusing. This change mainly refactor current bookkeeper script to make it reusable for other modules.--*Code Change*--The main changes are:--- abstract the common logic in `bin/bookkeeper` to `bin/common.sh`. These common logics include:-   * common definitions on environment variables, such jvm settings, bk conf, log4j conf, classpath and such.-   * common functions can be reusable, such as find jars, add maven dependencies.-- simplify `bin/bookkeeper` and `bin/bookkeeper-cli` by reusing `bin/common.sh`-- remove `stream/distributedlog/core/bin/dlog` to `bin/dlog` and simplify it by reusing `bin/common.sh`--*Tests*--Most of the changes in this PR are tests to ensure this script refactor is done correctly.--- introduced a module `tests/scripts` for testing all the bash scripts in bookkeeper project. This module uses [shUnit2](https://github.com/kward/shunit2) for testing bash scripts. This gives a good test coverage on `bin/common.sh`.--- add a few CLI smoketests under `tests/integration/smoke` to smoke test all CLI tools, including `bin/bookkeeper shell`, `bin/bookkeeper-cli` and `bin/dlog`. This makes sure all the CLI scripts work well after refactor.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1407 from sijie/include_dlog_library;7446d5c5d999c88de3cf2b9a36d793295c751a91
ISSUE #1403: ArrayIndexOutOfBoundsException is thrown on readLastAddConfirmedAndEntry--Descriptions of the changes in this PR:--*Motivation*--There are two bugs in `ReadLastAddConfirmedAndEntry`:--1) a regression was introduced by #657. the long poll read op is attempting to long-poll reading lac. since lac is stored across ensemble, so the retry logic assumes it will attempt over all the bookies in the ensemble. however #657 use a `write-quorum-size` write set for tracking those attempts. this leads to ArrayIndexOutOfBoundsException reported at #1403. The integrate tests added in this PR can easily reproduce this issue.--2) there was a bug on retry logic when a ledger whose ensemble size is larger than write quorum size. when this happens, it will claim lac is not advanced prior to attempt the bookie in the ensemble. so the client will never know lac is advanced if using long poll reads on such ledgers. The integrate tests added in this PR can also catch this issue.--disclaim: twitter uses long poll reads but never uses `ensembleSize > writeQuorumSize`. so this is not a problem for dlog users.--*Solution*--- introduce a `getWriteSetForLongPoll` call that uses `ensembleSize` for building the write set. this would address problem 1)-- fix the assignment of `numEmptyResponsesAllowed`, so the long poll reads can work with `ensembleSize > writeQuorumSize`-- add integration tests for long polling reads--at the same time, also add an integration test for normal tailing reads with--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1404 from sijie/longpoll_tests, closes #1403;92591733c8b778f63cd71a00b2c7ed2c69c41312
Use isEmpty method instead of size check--In HTTP ListLedgerService use is Empty instead of size check.--Author: Ali Ahmed <alahmed.se@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1371 from aahmed-se/minorRefactor;0d862fa42792301f26127addd5cc5a6a0114ce9b
Issue #1396: Export metrics in same http server--Descriptions of the changes in this PR:--*Motivation*--Currently metrics provider and http admin endpoint are isolated due to the way how things are modularized.-This requires two ports to be used, one is for metrics provider to expose metrics, while the other one is used by-http admin endpoint for expose admin endpoints.--When implementing a bookkeeper operator on k8s, it becomes confusing on managing those ports and do health checks.-It would be good to allow export metrics in same http admin endpoint if it is enabled.--*Solution*--- Introduce a method `writeAllMetrics` in stats provider to allow stats provider exporting metrics.-- Add a `MetricsService` in bookie http service and export stats provider's metrics under `/metrics` endpoint.--This fixes #1396--Master Issue: #1396--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1399 from sijie/same_http_metrics_port, closes #1396;6a48cd580814d71f931668fd78025f70aecf485c
BP-14 forceLedger wire protocol server side implementation--Implementation of the wire protocol for the BP-14 force ledger API on bookie side--Author: Enrico Olivelli <eolivelli@apache.org>-Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>,  Venkateswararao Jujjuri (JV) <vjujjuri@salesforce.com>--This closes #1393 from eolivelli/bp14-simple-force-ledger-proto;94c7ce0ba535181bc0fa78c4cb4cc612b1d6b773
Fix TestSmoke#testTailingReads--Descriptions of the changes in this PR:--*Motivation*--TestSmoke#testTailingReads is testing the tailing behavior at bookkeeper. However the current testing logic is a bit-problematic on checking whether the reader has caught up with the expected last add confirmed. so the read logic break-earlier before reading the expectedLastConfirmedEntry.--*Solution*--Fix the checking logic on breaking the read loop.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1402 from sijie/fix_integration_tests;cd71e0981dffa92edf51f9665117a30265b1cf4a
Provide a vagrantfile to launch a linux vm for running integration tests--Descriptions of the changes in this PR:--*Motivation*--Currently all bookkeeper's integration tests and bc tests are docker based and written-using arquillian framework. Due to the network issues in docker and the way how bookies-advertise themselves in the cluster, we can *ONLY* run integration tests in a linux-environment. It is inconvinient to people who is using macOS as the development environment.--*Solution*--This PR is providing a Vagrantfile to lanuch a dev vm that contains all the tools required-for running integration tests and bc tests. So people can actually debug and test integration-tests locally using a linux vm.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1401 from sijie/vagrant_files;eec48c4e21145c361dcbd749ab699922dfc0c68c
ISSUE #1339: Cleanup the directories created by DbLedgerStorageTest--Descriptions of the changes in this PR:--  Cleaned up the directories `dir1` and `dir2` left behind by the test `DbLedgerStorageTest`--Master Issue: #1339--Author: arunlakshman <arunmuthuravi@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1398 from arunlakshman/issue1339, closes #1339;175c8ded8417bb50467218edcce5fc2971f0752e
BP14 - forceLedger bookie side implementation--This is the bookie side implementation of the force() API as defined in BP-14, without the wire protocol handler.-We will introduce a new RPC which allows the client to ensure that all data sent for a  given ledger is persisted durably to the bookie, this is useful for DEFERRED_SYNC writers. In this case we are simulating a regular sync'd write to the journal choosen for the ledger.--Author: Enrico Olivelli <eolivelli@apache.org>-Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, JV Jujjuri <vjujjuri@salesforce.com>--This closes #1375 from eolivelli/bp14-simple-forceledger;3bd411910b3651e5dcb9df44d1f77cd6f6cd0ca6
[TABLE SERVICE] a zk based storage container controller--Descriptions of the changes in this PR:--*Motivation*--The original storage container "controller" was written in helix. The helix controller's placement is kind of not assuming any properties of shared storage. however the table service is leverage bookkeeper's as its segment/log store. the table service is built in a more `stateless` way, where a storage container can be moved between servers in a much lightweight way.--Also helix codebase is a bit large, if we eventually going to eliminate zookeeper, the cost of switching it off helix will be much expensive. so this PR is introducing a simple zk based controller for assigning storage containers to servers.--*Solution*--In this zk base solution, it is comprised of 3 parts: server registration, cluster & storage controller, storage container manager.--**registration**--this solution leverages existing registration client/manager interfaces. so each storage server registers itself under `/stream/servers/available`.--**cluster & storage controller**--A storage server is elected as a the leader, which runs a ClusterController. The cluster controller reads cluster metadata from zookeeper (the cluster metadata includes like how many containers available in the cluster), and use a storage controller to compute an assignment plan as the ideal state for container assignment mapping, and then update the assignment mapping to zookeeper under `/stream/assignment`.--**storage container manager**--Each storage server runs a storage container manager, which watches the assignment plan in zookeeper. The cluster controller updates the assignment plan. Once it receives watches/updates from the assignment plan that computed by cluster controller, the storage container manager will align itself to the ideal assignment map by starting/stopping storage containers.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1392 from sijie/table_service_manager;8e7583b4c691dc44bb9057a2fe472a44184346a5
Enable Prometheus stats provider to use custom http container--This change enable Prometheus stats provider to:-- use an user supplied registry-- do not start internal Jetty server--The context is to run the Bookie inside a process together with a servlet container (like Apache Tomcat) and use the existing web endpoint instead of opening another http (plain) port--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1394 from eolivelli/prom-use-servlet;0ccde17214168ec1f87741d1053ef66ce2344fff
Add smoke tests for LedgerHandleAdv and TailingReads--Descriptions of the changes in this PR:--Add two tests:--- basic writes/reads with LedgerHandleAdv-- tailing reads with LedgerHandle--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1389 from sijie/more_integration_tests;e77a80a74454f25ff315450bc50cf392ed3bc94f
Make bookie state manager & registration manager reusable outside of bookie--Descriptions of the changes in this PR:--*Motivation*--Since 4.6.0, we have already abstracted a pretty good interfaces around registration service and state management. Most of the classes can actually be reused for use cases that have similar service discovery and writable/readonly state transition management.--*Solution*--The change is try to cleanup `BookieStateManager` and `ZKRegistrationManager` to make them more generic and can be reused for other usage.--*Result*--Registration Interfaces and StateManager can be used outside of bookie.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1373 from sijie/refactor_bookie_state_manager;acb4e653428f38337af94bcb829956b44e39312d
[TABLE SERVICE] [DLOG] Fix `ConcurrentModificationException` on accessing component configuration--Descriptions of the changes in this PR:--*Motiviation*--Currently when running table service in standalone mode, it occasionally throws `ConcurrentModificationException`. Because-multiple components are sharing same underlying composite configuration. It causes the contention between copying keys and retrieving keys.--*Solution*--Change the component configuration to use a concurrent hashmap based configuration. Also changed the `loadConf` behavior to copy the keys / sub-keys-into the component configuration. This prevents components sharing same underlying composite configuration.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1378 from sijie/fix_conf;9134401954e860021a1a7314c55861eca0481ae6
ISSUE #1387: added unit test for LedgerHandleAdv handling of attempts to use LedgerHandle's specific API calls (add without specifying entry id)--Descriptions of the changes in this PR:--- added unit test.--Master Issue: #1387--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1388 from dlg99/fix/ISSUE-1387_LedgerHandleAdv_with_nonAdv_usage, closes #1387;20e3f6c3e16e409b03d3d0fefad699c856ca3b49
Refactor EntryLogger class--Descriptions of the changes in this PR:--- Split EntryLogger class into multiple classes.-- create separate classes for EntryLogManager, EntryLoggerAllocator and EntryLogManagerForSingleEntryLog.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1365 from reddycharan/refactorentrylogger;cf7a72b011378ac5be8e04edd35dfb97e00cedab
Fix TestCompatUpgrade--Descriptions of the changes in this PR:--*Motivation*-- #1352 update the BC tests to include newer versions, however it removes the flags that used for 4.6.0 to handle badly shutdown.- This change makes the BC tests become very flaky.--*Solution*--- apply `badlyshutdown` flag to both from 4.6.0 to 4.6.1 and from 4.6.1 to 4.6.2 upgrade--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #1386 from sijie/vagrant_files;92525c2ae30f41badb3986e3bc69de3aceb67e2d
Fix format problem of BP-32--Also mark BP-32 as accepted.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1383 from sijie/fix_typos;0b01c125df58dc85d5f965ce151a278d37ec6d3c
ISSUE #1384: Bump checkstyle version--Descriptions of the changes in this PR:--*Motivation*--mvn build fails on a centos/7 box. Exceptions are thrown as below:--```-[ERROR] Failed to execute goal org.apache.maven.plugins:maven-checkstyle-plugin:2.17:check (checkstyle) on project circe-checksum: Execution checkstyle of goal org.apache.maven.plugins:maven-checkstyle-plugin:2.17:check failed: An API incompatibility was encountered while executing org.apache.maven.plugins:maven-checkstyle-plugin:2.17:check: java.lang.NoSuchMethodError: org.slf4j.spi.LocationAwareLogger.log(Lorg/slf4j/Marker;Ljava/lang/String;ILjava/lang/String;Ljava/lang/Throwable;)V-```--*Solution*--The problem was addressed in https://issues.apache.org/jira/browse/MCHECKSTYLE-335. We need to bump the checkstyle plugin version to `3.0.0`--Master Issue: #1384--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1385 from sijie/vagrant_files, closes #1384;d47efa9fcc4601228d14219275b8d450256ccca8
ZKLedgerManager.writeLedgerMetadata should return appropriate error.--Descriptions of the changes in this PR:--ZKLedgerManager.writeLedgerMetadata should return-NoSuchLedgerExistsException error in the case it-gets KeeperException.Code.NONODE rc value from ZK.-ZKLedgerManager.removeLedgerMetadata does that as well.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1382 from reddycharan/abstractzkledgermanagerissue;7580ce9dd8449f777e35b580bb6786f12d7703bc
[TABLE SERVICE] apply backoff policy to rpc requests if storage container is not found--Descriptions of the changes in this PR:--*Motivation*--A storage container can move between servers due to failures, or it can take time to start on a server. During that short period of time, it is "unavailable" and clients will receive `Status.NOT_FOUND` from grpc channels. The client should retry on this error and attempt to re-locate the storage container again.--*Modification*--- add backoff policy in client settings-- apply the backoff policy at storage container channel. if it receives `NOT_FOUND` grpc exception, it will reset the server channel, so subsequent requests will re-attempt to relocate the storage container.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1379 from sijie/rpc_backoffs;843dd035b3ed8ff890bad176021319abf4871220
BP-32: Advisory (optimistic) write close--Descriptions of the changes in this PR:--initial proposal for Advisory (optimisitic) write close--Master Issue: #1343--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1374 from reddycharan/advwriteclosebp;c4af73427378312d9e7d50cc06a9523a78ecaf41
OrderedScheduler#chooseThread(key) handle null key--Descriptions of the changes in this PR:--*Motivation*--It is more convenient if OrderedScheduler#chooseThread(key) can handle null key. so the applications who is using #chooseThread don't need to worry which method to choose - `chooseThread()` vs `chooseThread(key)`.--*Solution*--in `chooseThread(key)`, fallback to randomly pickup a thread if key is null.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1372 from sijie/order_scheduler_null_key;1f0f92c0c0cfc0cafe0cab976d8c5fbdf34c10d3
Issue #570: Introduce EntryMemTableWithParallelFlusher--Descriptions of the changes in this PR:--This is < sub-task4  > of Issue #570--When there is going to be entrylog per ledger, then for-better utilizing the availability of multiple entrylogs,-parallel flush of entrymemtable can be done. In this-sub-task EntryMemTableWithParallelFlusher is introduced,-which uses OrderedExecutor with "numOfMemtableFlushThreads"-number of threads.--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1358 from reddycharan/memtableparallel, closes #570;a3c141eee827c583828251756d4e52a70398b7af
ISSUE #1086 (@bug W-4146427@) Client-side backpressure in netty (Fixes: io.netty.util.internal.OutOfDirectMemoryError under continuous heavy load) (#1088)--* ISSUE #1086 (@bug W-4146427@) Client-side backpressure in netty (Fixes: io.netty.util.internal.OutOfDirectMemoryError under continuous heavy load);9c3e8c9f835781507ac833473abc39e821bdbf36
[TABLE SERVICE] Dlog based checkpoint store--*Motivation*--Currently the table range stores are using local filesystem as a checkpoint store. It is okay for running as standalone mode.-But it doesn't work to run in a distributed mode. This change is introducing a dlog based checkpoint store to make sure all-the sst files of table ranges are durably checkpointed into bookkeeper itself.--*Solution*--Introduced a dlog based checkpoint store.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1366 from sijie/dlog_checkpoint_manager;2edcaa60303270152991307260846c201c57d9b5
Issue #1345: entrylogger.flush should flush currentlog first.--Descriptions of the changes in this PR:--It is incorrect to call flushrotatedlogs first and-then flushcurrentlogs in the EntryLogger-(EntryLogManager) flush method. It should be other way around.--Master Issue: #1345--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1360 from reddycharan/elmflushorder, closes #1345;82ad464d3b40e0f69e55556ae15ad06f29ec5003
Issue #1363: Fast and Garbage-Free Codahale Statistics Timers--This change introduces a new Codahale-based metrics provider "FastCodahaleMetricsProvider" in the codahale-metrics-provider artifact, which can be activated through the "statsProviderClass" config parameter (no changes made to the existing "CodahaleMetricsProvider"). This new "FastCodahaleMetricsProvider" brings a new timer implementation "FastTimer", which extends Codahale's Timer class, provides an identical API, is registered in Codahale's timer registry, and can be queried through the existing JettyServices implementation. FastTimer provides similar functionality as Codahale's default timer, but is significantly faster and (nearly) garbage free.--The improvements of FastTimer over Codahale default Timer with ExponentiallyDecayingReservoirs are:-* entirely garbage-free Timer updates (only snapshot creations when querying a timer allocate a small number of Java objects)-* 3x faster Timer updates (i.e. 3x shorter code-path to update a timer)-* half the memory footprint (in default configuration)--FastTimer reduces GC pause times in our experiments as described in Issue 1363 by half (same as entirely deactivating all timers).--The primary functional differences between FastTimer and Codahale default Timer with ExponentiallyDecayingReservoirs are:-* FastTimer keeps values for a fixed, configurable time period (default: 60 seconds) rather than exponentially decaying them-* FastTimer bucketizes event times rather than storing discrete values. Percentile values depend on the bucket resolution.--Design Considerations------------------------The design goals of this timer implementation are for it to be- - fast (i.e. few instructions to update a timer)- - scalable (i.e. little synchronization cost for concurrent timer updates)- - garbage-free for timer updates (i.e. no object allocation for timer updates)- - space-efficient (i.e. as little memory footprint as possible while achieving first three goals)- - provide similar functionality as Codahale's default timers with ExponentiallyDecayingReservoirs--This implementation provides rate and response times over a configurable sliding time window. Data-is stored in upfront allocated circular arrays, in which each array element holds data-for one second. Data is overwritten in a circular fashion without the allocation of new data-structures and is therefore garbage-free for all timer updates.--This implementation does not store individual response times, but instead allocates bucketized counters-upfront, which are incremented for any event falling into a particular response time bucket. A-fine-grained bucket definition (intended for capturing successsful events) and a coarse-grained-bucket definition (intended to capture failure or timed-out events) are provided.--To improve scalability of concurrent timer updates, most data structures are replicated HASH_SIZE-times, and calling threads updating a timer are hashed to individual instances. Performance tests-(see below) have shown that this implementation is light-weight enough to achieve slightly better-scalability than Codahale's default timers even without hashing, and can further improve scalability-if hashing is used.--Trading off performance and scalability vs. memory footprint, we need to be conservative in the hash-size we chose. Different flavors of this timer implementation have been evaluated using JMH-micro-benchmarks (see microbenchmarks/src/main/java/org/apache/bookkeeper/stats/TimerBenchmark.java),-comparing implementations of FastTimer with a time window of 60 seconds and-- (DEV1)   a HASH_SIZE of 3 for all data structures (meters, counters, min/max, and response time buckets)-- (DEV2)   a HASH_SIZE of 1 for all data structures (meters, counters, min/max, and response time buckets)-- (FINAL)  a HASH_SIZE of 3 for meters, counters, min/max, and no hashing for response time buckets-to the default timer implementation-- (BASE-E) Codahale Timer with ExponentiallyDecayingReservoir (default as used by bookkeeper code)-- (BASE-T) Codahale Timer with SlidingTimeWindowReservoir configured to 60 seconds-- (BASE-S) Codahale Timer with SlidingWindowReservoir configured to hold 100,000 events.--Based on results below, implementation (FINAL) was chosen as the final FastTimer implementation, as it-achieves nearly the same throughput as (DEV1) at nearly the same memory footprint as (DEV2), and-ultimately achieves roughly 3x higher throughput and scalability that Codahale's default implementation-at around half the memory footprint.--The following results have been collected on an eight core x86 server running at 3.2 GHz (updated-timers are shared across 4 threads):--```-Config   Timer Impl             Timers   Threads      ops/ms   Alloc B/op   Kb/TimerPair------------------------------------------------------------------------------------------ DEV1    FastTimer (Hash 3)          1         4   11487.904        0                253- DEV1    FastTimer (Hash 3)         10         4   22621.702        0                253- DEV1    FastTimer (Hash 3)        100         4   21781.319        0                253- DEV2    FastTimer (Hash 1)          1         4    5138.143        0                 88- DEV2    FastTimer (Hash 1)         10         4   22902.195        0                 88- DEV2    FastTimer (Hash 1)        100         4   19173.085        0                 88- FINAL   FastTimer (Hash 3/1)        1         4    9291.002        0                 99- FINAL   FastTimer (Hash 3/1)       10         4   16379.940        0                 99- FINAL   FastTimer (Hash 3/1)      100         4   16751.020        0                 99- BASE-E  CodahaleTimer               1         4    3845.187       82.609            189- BASE-E  CodahaleTimer              10         4    7262.445       35.035            189- BASE-E  CodahaleTimer             100         4    7051.77        32.843            189- BASE-T  CodahaleTimer/TimeWindow    1         4     102.479       90.851            174- BASE-T  CodahaleTimer/TimeWindow   10         4      68.852       84.812            174- BASE-T  CodahaleTimer/TimeWindow  100         4     153.444      136.436            174- BASE-S  CodahaleTimer/SlidingWdw    1         4    4670.543        0               2103- BASE-S  CodahaleTimer/SlidingWdw   10         4   13696.168        0               2103- BASE-S  CodahaleTimer/SlidingWdw  100         4   12541.936        0               2103-```--- ops/ms is the number of timer updates per millisecond.-- Alloc B/op is the number of bytes allocated per timer update-- Kb/TimerPair is the heap footprint per pair of timers (one with fine-grained, one with coarse-grained buckets)--The following test results include snapshot creation every 109 timer updates (typically, we would assume-snapshot creation to be much less frequent), and show that also with snapshots in the mix, FastTimer outperforms-Codahale default Timers both with respect to throughput and scalability as well as object allocation:--```-Config   Timer Impl             Timers   Threads      ops/ms   Alloc B/op--------------------------------------------------------------------------- FINAL   FastTimer (Hash 3/1)        1         4    1569.953       23.707- FINAL   FastTimer (Hash 3/1)       10         4    7316.794       24.073- FINAL   FastTimer (Hash 3/1)      100         4    6498.215       24.073- BASE-E  CodahaleTimer               1         4     246.953      481.771- BASE-E  CodahaleTimer              10         4    1989.134      476.807- BASE-E  CodahaleTimer             100         4    1514.729      468.624- BASE-T  CodahaleTimer/TimeWindow    1         4       6.063    43795.810- BASE-T  CodahaleTimer/TimeWindow   10         4      44.651    33916.315- BASE-T  CodahaleTimer/TimeWindow  100         4     180.431    12330.939- BASE-S  CodahaleTimer/SlidingWdw    1         4      17.439    14683.756- BASE-S  CodahaleTimer/SlidingWdw   10         4     107.257    14683.745- BASE-S  CodahaleTimer/SlidingWdw  100         4     236.538     9767.106-```--Unfortunately Codahale does not have a Timer interface we can implement, and some Codahale-base classes are assuming instances of Timer (for example, our JettyServices instantiate a-Codahale MetricsServlet, which instantiates a Codahale MetricsModule, which only serializes-timers that are instances of Timer class into the json output stream). Unless we wanted to-reimplement or override all these base classes, we can't just implement Codahale's Metered and Sampling-interfaces. Instead we have to extend its Timer class, even though we're not using any of its-inherited functionality or data structures. The inherited (unused) member variables of Codahale Timer-consume slightly less than 512 byte per FastTimer (measured around 425 byte in Codahale 3.1).-Above memory footprint results include ~ 1 kb of inherited (unused) data structures, which comprise-around 1% of FastTimer's overall memory footprint.--In terms of functionality, FastTimer provides the same functionality as Codahale's timers-(in default configuration with ExponentiallyDecayingReservoirs), with the following exceptions:-- Statistics are kept for a fixed amount of time (rather than exponentially decayed), by-  default 60 seconds. As a consequence, getMeanRate(), getOneMinuteRate(),  getFiveMinuteRate()-  and getFifteenMinuteRate() all return the same value if FastTimer is configured to use a-  60 second time window.-- FastTimer and FastSnapshot only record bucketized instead of discrete response times. As a-  consequence, the accuracy of percentiles depends on bucket granularity. FastSnapshot also-  can't return discrete values: getValues() returns an empty array, and size returns 0.--Author: Nicolas Michael <nmichael@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1364 from nicmichael/FastTimer, closes #1363;ed3b0105d0e1adbb118641cc39f886659d140361
Issue #791: Eliminate byte[] copies in AddEntry code path--The AddEntry code path in Bookkeeper Client performs several copies of the send buffer before sending it out to bookies, which not only costs CPU cycles for array copying, but also drives up object allocation rate and thus increases young GC frequency.--Currently, the send buffer is prepared by DigestManager.computeDigestAndPackageForSending(), which wraps the netty ByteBuf containing the data together with a (direct) header buffer into a ByteBufList. So far, we haven't yet allocated or copied any new buffers. But in order to send the buffer to the bookies, PendingAddOp.safeRun() will invoke sendWriteRequest() for each bookie in the write set, which will eventually invoke PerChannelBookieClient.addEntry() for each bookie. In here, we are now allocating two new byte[] and copying the buffer twice per bookie for V3 protocol with protobuf:-    byte[] toSendArray = toSend.toArray();      // 1st byte[] allocation and copy-    .setBody(ByteString.copyFrom(toSendArray)); // 2nd byte[] allocation and copy-If for example we're using a write set size of 3, then we allocate 6 byte arrays and copy the same buffer 6 times.--All 6 copies can be eliminated if DigestManager.computeDigestAndPackageForSending() would return a ByteBuf (or ByteBufList) that is backed by an array, which we can access and use without further copying it. PerChannelBookieClient.addEntry() could then wrap this array into a protobuf ByteString without performing any additional copies.--This change eliminates all byte[] allocations and copies in PCBC by:-1. allocating a new (pooled) array-backed heap ByteBuf for header, digest, and data in DigestManager.computeDigestAndPackageForSending()-2. copying the data payload into this newly allocated ByteBuf and returning it wrapped into a ByteBufList of size 1 (instead of header + body separately)-3. enhancing ByteBufList to give access to the underlying array if it consists of only a single ByteBuf that's backed by an array-4. extracting the underlying array in PerChannelBookieClient.addEntry() from ByteBufList and wrapping it into protobuf ByteString without copying it.--With this change, no more object allocations are required in this code path. DigestManager uses a pooled array (1). We're adding one arraycopy in (2) compared to the original code path, trading this against the allocations and copies we save later on.. Later steps, in particular step (4), is free of object allocation and array copies.-As a result, the object allocation rate in the AddEntry code path is reduced significantly. In case of a write set size of 3, it is reduced from 6 to 0. This translates into much less frequent young generation garbage collections (in my experiments with write-heavy workload by ~4x overall).--Author: Nicolas Michael <nmichael@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1361 from nicmichael/AddEntryNoCopy, closes #791;e021ac31cb1acb8de6d4161a618e76127d04d1c8
[RELEASE-4.7.0] update BC tests--Descriptions of the changes in this PR:--add 4.6.2 and 4.7.0 to BC tests list--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1352 from sijie/update_bc_tests;e9aeddd89623bf1cd0c9ecb8ef200c7a3dd47f95
Add config BK_metadataServiceUri for docker--Descriptions of the changes in this PR:--While trying docker in 4.7.0 release, found that the new config parameter `metadataServiceUri` was changing leaked, and docker could not run success.-This change add the config `BK_metadataServiceUri` for docker config, and make docker 4.7.0 runs success.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1362 from jiazhai/docker_conf;f78ea8238b44c8ae52ea6cf9445228afdeffc7aa
In EntryLogger.addEntry method, rollLog flag should not be ignored.--In EntryLogger.addEntry method, rollLog flag should not be ignored.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1359 from reddycharan/fixrolllogcall;a02b3f494331e830f7b34c9d833069af4db8e81c
ISSUE #1246: Scripting the whole release procedure--Descriptions of the changes in this PR:--*Motivation*--Releasing bookkeeper becomes tricky after introducing `circe-checksum`, since we need to ensure linux jni library is shipped as part of `circe-checksum`.--*Solution*--- switch to use docker for generating bookkeeper release-- scripting the whole release procedure as many as possible--Master Issue: #1246--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1329 from sijie/release_scripts, closes #1246;7fe8427bbd00603ef07f6846f27a6cc4f2fa1376
[RELEASE-4.7.0] add integrationtests CI job for branch-4.7--Descriptions of the changes in this PR:--add integrationtests CI job for branch-4.7--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1353 from sijie/make_it_test_as_postcommit_jobs;c21c53bd7de8341d1e0b5c3c8d5d2e1c33857f93
ISSUE #1354: Spin-Wait for I/O completion wastes CPU time in BK Client--Issue 1354: Spin-Wait for I/O completion wastes CPU time in BK Client (JDK8)--This bugfix for issue 1354 changes the call of CompletableFuture.get() in SyncCallbackUtils.waitForResult() to CompletableFuture.get(Long.MAX_VALUE, TimeUnit.NANOSECONDS), which leads to the same behavior, but avoids spinning (and thus reduces CPU consumption) in JDK8.--Author: Nicolas Michael <nmichael@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1355 from nicmichael/FutureNoSpin, closes #1354;325dd9308896cd924bf78f3437824622a91f125a
Issue #570: Introducing EntryLogManager.--Descriptions of the changes in this PR:--Introducing EntryLogManager interface, which abstracts out current activeLogChannel,-rotatedLogChannels and corresponding lock for activeLogChannel. The current logic of-handling logs is moved to EntryLogManagerForSingleEntryLog class, in the-next sub-task EntryLogManagerForEntryLogPerLedger will be introduced. Also there-are minor changes to createNewLog logic and leastUnflushedLogId logic.--This is < sub-task5  > of Issue #570--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1281 from reddycharan/entrylogmanager, closes #570;a71da1d1bae1790c913b773cdb14f61374687625
[RELEASE-4.7.0] upgrade guide and release notes--- add upgrade for 4.6.x to 4.7.0-- backfill upgrade guide in old releases-- add release notes for 4.7.0-- add 4.7.0 to releases--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1330 from sijie/update_release_notes;1f265385ea03e8ca15693d8547f0fa04062e32bc
[RELEASE-4.7.0] update docker file--Descriptions of the changes in this PR:--update the release version from 4.6.0 to 4.7.0 and its corresponding gpg key--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1351 from sijie/update_docker_file;8248a4d790607436c5709b1dca2d929115b47331
Provide memory & gc options in bookkeeper script--Descriptions of the changes in this PR:--It is convenient to provide `MEM_OPTS` and `GC_OPTS` in bookkeeper script and bkenv.sh to allow overriding jvm settings through.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1342 from sijie/gc_settings;1242e3757c3dffd3c846787756c49779aee31d13
Update release schedule for 4.8.0--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1341 from sijie/update_release_schedulea;7f010d29cbef0cbdf75b472df28cd9ea85f5c419
Only check ipv6 binding when /sbin/sysctl exists--Descriptions of the changes in this PR:--*Problem*--If bookkeeper is included in some slim docker images, sysctl might not exists at all.-It would fail bookie to start.--*Solution*--Only check ipv6 binding when /sbin/sysctl exists--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1340 from sijie/disable_ipv6_binding;51c26dcf3446ef0bf2bc7c753e5d188e29123ae8
Fallback to use `getZkServers` and `getZkLedgersPath` when resolving from metadata service uri--Descriptions of the changes in this PR:--*Problme*--Dlog tests are failing because dlog is using an external zookeeper client, where both `zkServers` and `metadataServiceUri`-are not set on client configuration. It will throw NPE when trying to resolve `zkServers` and `zkLedgersRootPath` from metadata service uri.--*Solution*--Fallback to use deprecated `getZkServers` and `getZkLedgersPath` when metadata service uri is null--Related Issues: #1336--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1338 from sijie/fix_dlog_tests;c3e96a76be35a0adb6f700491dd0a8786d5b2957
Use metadata service uri rather than zkServers--Descriptions of the changes in this PR:--*Motivation*--Metadata service uri is introduced as part of BP-29. However most of the tests and tools are still assuming `zkServers`.-This causes a problem if people configures `metadataServiceUri`, some of the admin tools don't actually work.--*Solution*--This change changes bookkeeper to use `metadataServiceUri` in all the possible places and provides methods to resolve zkServers-and zkLedgersRootPath from metadata service uri. This ensures:--1) if users configure `metadataServiceUri`, all the tools would work properly.-2) if users doesn't configure `metadataServiceUri` and still use `zkServers` and `zkLedgersRootPath`, all the tools would still work.--*Changes*--The main changes are:--- deprecated direct usage of `getZkServers`, `setZkServers`, `getZkLedgersRootPath`, `setZkLedgersRootPath, `getZkAvailablePath` at AbstractConfiguration-- provide util methods `resolveZkServers` and `resolverZkLedgersRootPath` in `ZkMetadataDriverBase` for resolving zookeeper specific settings from metadata service uri-- change the tools to use `getMetadataServiceUri`-- change the tests to use `getMetadataServiceUri` to ensure code coverage--*NOTES*--There are a few places still using `getZkServers`, `setZkServers`. those are hard to change at this moment.--Related Issue:-- #1335--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1336 from sijie/fix_local_bookkeeper;3d39435d316bc05e64c4247aeb8455bcd2a96989
Issue #1335: LocalBookKeeper doesn't work with metadata service uri--Descriptions of the changes in this PR:--*Problem*--`"zk+hierarchical://localhost:2181/ledgers"` is invalid because `"` is an invalid character.--*Solution*--Fix the invalid settings in `bk_server.conf`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1337 from sijie/fix_invalid_settings, closes #1335;9921613829dba70a2903ee19ddfc4dc757fb39ab
[maven-release-plugin] prepare for next development iteration (missing modules);ca4d4e0590a45cb377db348c08f90fb2ec0b0147
Create CI jobs for branch-4.7--Descriptions of the changes in this PR:--We need to CI jobs running for subsequent minor releases on branch-4.7.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1328 from sijie/create_ci_job_for_4.7;8cd9f91bd49b0453e2ee5e787d5a5729255b466c
[maven-release-plugin] prepare for next development iteration;49fda75662b85712d3eae77484cf38b40b74abe1
[maven-release-plugin] prepare branch branch-4.7;d719bb75dce951547f390a0de42d100fe5289387
Prepare 4.7.0 release--Descriptions of the changes in this PR:--- copy the current `docs/latest` as `docs/4.7.0`-- bump latest development release to 4.8.0 SNAPSHOT release--beside that, also change stable version to 4.6.2 release--NOTE: this change doesn't put 4.7.0 in the menu. will update menu and releases page after 4.7.0 is released--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1326 from sijie/prepare_release_4.7;61a227b797695fb8dad0d70fe6c2bb256addde29
Update News after release of 4.6.2--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1327 from eolivelli/fix/update-news-462;2af991bceb273eb699b93020961ca26cd72d66af
Update missing configuration settings & missing shell commands--Descriptions of the changes in this PR:--Update missing configuration settings & missing shell commands for preparing 4.7.0 release.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1325 from sijie/update_docs;f5a7a2c3ade4a27255551748ded33f724a74d7ca
Remove WriteFlags from public API--Descriptions of the changes in this PR:--`DeferredSync` is not implemented at server side. So remove `withWriteFlags` from builder API.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1324 from sijie/remove_write_flag;2536c91fde3eefe8f426e4e91e05ccfa26294f03
Improve "Failed to resolve network location" logging--Descriptions of the changes in this PR:--*Problem*--Rackware/Region-Aware is using a script based DNS resolver for resolving network topology. If the network topology script is not configured, the DNS resolver will return `null` as network location. It results in using `default-rack` as the network location and log "Failed to resolve network location" for each resolution.--*Solution*--If a script file is not provided, throw a runtime exception. So the rackaware/region-aware placement policy can fallback to use the default-rack resolver. It would avoid the logging flood.--*Result*--Before this change, it will log following statement for each DNS resolution:--"Failed to resolve network location".--After this change, it will only log following statement during initialization:--```-INFO  - [Time-limited test:RackawareEnsemblePlacementPolicyImpl313] - Failed to initialize DNS Resolver org.apache.bookkeeper.net.ScriptBasedMapping, used default subnet resolver.-java.lang.RuntimeException: No network topology script is found when using script based DNS resolver.-	at org.apache.bookkeeper.net.ScriptBasedMapping$RawScriptBasedMapping.setConf(ScriptBasedMapping.java:150)-	at org.apache.bookkeeper.net.ScriptBasedMapping.setConf(ScriptBasedMapping.java:122)-	at org.apache.bookkeeper.client.RackawareEnsemblePlacementPolicyImpl.initialize(RackawareEnsemblePlacementPolicyImpl.java:306)-	at org.apache.bookkeeper.client.RackawareEnsemblePlacementPolicyImpl.initialize(RackawareEnsemblePlacementPolicyImpl.java:75)-	at org.apache.bookkeeper.client.BookKeeper.initializeEnsemblePlacementPolicy(BookKeeper.java:598)-	at org.apache.bookkeeper.client.BookKeeper.<init>(BookKeeper.java:490)-```--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1323 from sijie/improve_dns_resolver_logging;71901bcd8bb27257b8ef574353d6a851ff6e56f7
Improve logging on ledger dirs monitor to avoid log flooding--Descriptions of the changes in this PR:--*Problem*--When a bookie is in readonly mode, the ledger dirs monitor will keep check the disk usage and generate tons of logs if the disk usage is unchanged. This makes debugging much difficult.--*Solution*--- Improve the logging logic in ledger dirs monitor to only log changes when disk usage is changed.-- Disable logging on checking threshold for high priority writes. Only log changes when high priority writes availability is changed.--*Result*--This reduces the logging when a bookie is outage in readonly mode.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Yiming Zang <yzang2016@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1322 from sijie/improve_monitor_logging;c760c566e7ae98d1d4a7a5892c7414480f0c947a
Release notes for 4.6.2 version--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1297 from eolivelli/fix/releasenotes462;4aec3cefe6d5e59b03d9f27d4a50ee6f4ddccb37
Allow multiple directories in DbLedgerStorage--In normal conditions, the max throughput that a bookie can sustain is mostly determined by how fast we can write entries on the journal.--If we assume a *very* fast journal, for example using multiple journal threads and setting `journalSyncData=false` or with the journal on a RAM disk (there are some cases in which it might make sense), then the LedgerStorage becomes the "bottleneck". We need to be able to flush data on disk faster than the incoming rate, otherwise the write cache will get full and then we have to apply backpressure.--In different testing scenario, the bottleneck has become the LedgerStoarge flush/checkpoint because it's done by a single thread.--For smaller entries (1KB) the limit is ~250 K write/s and the limitation is due to preparing a batch with the offsets to write into rocksdb. Each insertion in the batch needs to cross JNI boundaries and that is expensive.--For bigger entries (10KB), the limit is ~50K write/s (or 500MB /s). This mostly because the single flush thread cannot drive 100% IO utilization on the disks (since it's doing the rest of work). Raw disk writes in that test environment (12 HDDs) could reach 1.4GB/s.--This change is only relative to DbLedgerStorage and it's a simple refactoring that, when configured with multiple directories, it will hash a ledger into a certain directory. Each directory is flushed independently on its own thread.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1289 from merlimat/db-storage-multiple-dirs;4939416c68f20c990d5c98ee19d59ba662f1b4a0
ISSUE #1316: A bookie with non-writable dirs should be able to start in readonly mode--Descriptions of the changes in this PR:--*Problem*--Bookie failed to start when it doesn't have non-writable dirs. Issue is reported at #1316--*Solution*--- Introduce a setting `minUsageSizeForEntryLogCreation` to allow creating entry logs even when there is no writable dirs. This setting is replacing `getIsForceGCAllowWhenNoSpace` for creating new log, since entry log files are created not only for gc/compaction. It can also happen on startup and also journal replays.--- Defer creating entry log files until first write happens, when there is no writable ledger dirs.--- add bunch of tests for EntryLog and Bookie initialization.--Master Issue: #1316-Related Issue: #190--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #1319 from sijie/allow_bookie_to_start_with_no_writable_bookies, closes #1316;ea1a75c0622a93abbd16fd71820f3c0cb5fc3ab0
Avoid contention on netty channel promise--With profiler, I have seen there can be heavy contention between BK threads and Netty IO thread due the the checking for channel write condition that was recently added for monitoring purpose.--The problem relies in that there is one BK thread that is doing the `writeAndFlush()` on the PCBC and getting the `ChannelFuture`, adding a listener to the future.--The write operation, though, is completed in the Netty IO thread and the promise gets also triggered from that thread. So, there is contention between current thread adding the listener and the IO threads completing the promise.--If we add the listener before doing the write on channel, we can avoid the contention. Another option could be to do the write from the Netty IO thread as well.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1321 from merlimat/channel-promise-contention;956b37dad75a98b23cff34e8cfe0179e15e6d98a
y--Previously it was not duplicating, so the underlying ByteBuf was being-returned to the client, and this was having its reader index modified,-which meant that if it was read again, the data could not be read.--By calling duplicate() on the LedgerEntryImpl, the underlying ByteBuf-is sliced and retained, so it has a new set of indices. The retention-does nothing, as the buffer is unpooled.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1318 from ivankelly/dup-mock;e6a3aa7e488b87a6d0d08c5bae8564a944815ad7
ISSUE #1314: Provide a mechanism to allow high priority writes to readonly bookies--Descriptions of the changes in this PR:--*Problem*--Currently we allow fence requests going through readonly bookies, since fence requests are special read requests. However a ledger can only be sealed after it is successfully recovered. If bookies are in readonly, those recovery writes won't go through.--If there is a bookie outage happened (e.g. all bookies are readonly), all ledgers are not able to be sealed. It might be good to have a similar setting like minUsableSizeForIndexFileCreation for recovery writes.--This can improve operability during outage.--*Solution*--- add a setting `minUsableSizeForHighPriorityWrites` to allow accepting high priority writes on readonly bookies.--Master Issue: #1314--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1315 from sijie/allow_high_priority_writes, closes #1314;08d3cf8f014451dbc1485c8fc4985b2ada30a55c
newOpenLedgerOp and ReadHandle implementation for MockBookKeeper--This will allow users of MockBookKeeper to use the new ReadHandle API.--There are two implementations of the ReadHandle interface. One pure,-which isn't backed by any production code, and another on-MockLedgerHandle which passes through to the pure implementation.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1298 from ivankelly/better-mock;bf28ecade1b92204fd97a7cfd9ad3ff885382fbf
Issue #1310: Filter out body and masterKey from ProcessorV3s--Descriptions of the changes in this PR:--In certain logs instances of ProcessorV3 (for eg WriteEntryProcessorV3) are logged.--Logging entry data and credentials details is not appropriate. Filter out-those details--(have to consider other ProcessorV3s as well and testcases to validate this change)--Master Issue: #1310--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1311 from reddycharan/filterlogs, closes #1310;7ec5ff3372cde048fa4be464c14ba66bdf6622c7
longPollThreadPool can not be null--Descriptions of the changes in this PR:--*Problem*--The long polling logic is built with the assumption that there is a thread pool for scheduling deferred reads.-So if people happens to set `numLongPollWorkerThreads` to zero or negative, a null value is passed into long poll requests which causes NPE.--*Solution*--If `numLongPollWorkerThreads` is set to zero or negative, fall back to use read thread pool. If there is no read thread pool, create a thread pool-aligned with num processors.--With this change, turn the default value of `long poll threads` to zero. so no additional threads are needed if long poll feature is not used (e.g. at pulsar).--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Yiming Zang <yzang2016@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1308 from sijie/validate_number_long_poll_threads;6bb5bd09ab75b66c71827d07eb94c47ab8867c0f
Issue #1304: in listunderreplicated cmd provide option to print missing replicalist--Descriptions of the changes in this PR:--in listunderreplicated bookieshell command,-provide option to print missing replicalist--Master Issue: #1304--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1305 from reddycharan/urlbookies, closes #1304;15d583cb6162cf6beb10591ad3d0b6f436c81ea0
Upgrade Maven Assembly Plugin to 3.1.0--- upgrade Maven Assembly Plugin because 2.2.1 version has issues about file permissions-- explicitly set tarLongFileMode to 'posix' in order to handle user ids with large values--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1313 from eolivelli/upgrade-assembly-master;980bf9d0a6073d5294c3a2c3c7a9b7fa12fa89fc
BK configuration file updates--Descriptions of the changes in this PR:--- Change two default values: `fileInfoCacheInitialCapacity` to 1/4 of openFileLimit() and `journalRemoveFromPageCache` to true.-- Fix default values in conf/bk_server.conf to make them consistent with `ServerConfiguration`-- Organize the settings into sections for both `conf/bk_server.conf` and `site/_data/config/bk_server.yaml`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1294 from sijie/update_default_values;80a135f9e1235527f9112309cd3cbd0601757e98
Refactored OrderedSafeExecutor and OrderedScheduler--As outlined in https://lists.apache.org/thread.html/102383ea42f473f36720637e41af0ee83fc38d9f992736e0d1a7f985%3Cdev.bookkeeper.apache.org%3E--right now `OrderedSafeExecutor` is implemented on top of `OrderedScheduler`.  There are few problems with this approach that are causing impact on performance:-- 1. `OrderedScheduler` is a `ScheduledExecutorService` which uses a priority queue for tasks. The priority queue has a single mutex for both publishers/consumers on the queue- 2. There are many objects created for each task submission, due to listenable future decorators--Since in all cases in critical write/read path we don't need delay task execution or futures, we should try to have a light weight execution for that.--### Modifications-- * Inverted the hierarchy between `OrderedSafeExecutor` and `OrderedScheduler`. Now the base class is `OrderedSafeExecutor` and the other extends from it, since it provides additional methods.- * Moved `OrderedSafeExecutor` in `bookkeeper-common` since `OrderedScheduler` was already there.- * Moved `OrderedSafeGenericCallback` in its own file, since it needs to be in `bookkeeper-server` module at this point.- * Changed some method names from `submitOrdered()` into `executeOrdered()` to be consistent with JDK name (`submit()` returns a future while `execute()` returns void).- * Changed `BookKeeper` instance of `scheduler` into `OrderedScheduler` so that the few cases which were using the `mainWorkerPool` could be easily converted to use the scheduler instead.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Andrey Yegorov <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1309 from merlimat/refactor-ordered-executor and squashes the following commits:--9af6eadc2 [Matteo Merli] Fixed findbugs configuration to ignore genereted JMH code-c85ad21e5 [Matteo Merli] Use ImmutableMap-22eba18c8 [Matteo Merli] Added microbenchmark-2c67d0e56 [Matteo Merli] Fix for TestMaxSizeWorkersQueue-54a72ba1b [Matteo Merli] Fix for TestReadAheadEntryReader-019d5202d [Matteo Merli] More fixes for submitOrdered-b8175f311 [Matteo Merli] Fixed array initialization type-5d68d431d [Matteo Merli] Fixed class names in integration tests-7c529dde7 [Matteo Merli] Fixed submitOrdered in DL code-c91259b7d [Matteo Merli] Removed "final" modifier on checkQueue-c5f70d5b4 [Matteo Merli] Merge remote-tracking branch 'apache/master' into refactor-ordered-executor-957c98309 [Matteo Merli] Correctly handle number of tasks in queue check-e45f78c09 [Matteo Merli] Renamed into OrderedExecutor and OrderedGenericCallback-926868429 [Matteo Merli] Refactored OrderedSafeExecutor and OrderedScheduler;46171e67e526702487641438144f28b7eb1aa07b
Make CRC32C_HASH a final static variable and log when we cannot use native crc32c library--For CRC32c there is a marked performance difference when the JNI library is available versus when it's not, since the fallback involves creating many `ByteBuffer`s and copy payloads.--Additionally we should set the static variable to `final` so the optimizer can get rid of the `(CRC32C_HASH instanceof Sse42Crc32C)` checks.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1303 from merlimat/crc-final;678b88ca8e7fc313494b34167785b37102e809d0
Minimize number of thread local instances in CRC32CDigestManager--CRC32CDigestManager uses thread local to store the current crc value (since the crc is computed on the headers and then on the payload).--One issue is that the thread local instances are per-ledger and are never cleaned up from the thread local storage. As new ledgers get used, we'd have more memory used there.--For digest we really need 1 single variable--Changes:- * Use Netty FastThreadLocal instead of JDK ThreadLocal- * Made the thread local variable static, since one thread is computing the checksum for an entry of a given ledge, before moving to next entry.- * Minimized thread local `.get()` access since it's more expensive than regular variable access.- * Removed the usage of `isNewCrc` since initial value for crc32c (as well as crc32) is 0--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1306 from merlimat/impro-crc32c;f5b4b7866f34939b5cfa96bbdd3ff26a376c9677
Avoid acquiring closeLock.readLock() on every add/read operation--In the `BookieClient`, we are always acquiring a readlock when grabbing a connection to use for sending a write/read request.--The lock is the `closeLock` and it's only acquired in "write" mode when the `BookKeeper` instance is closed.--The problem with the read-lock is that it introduces contention between the threads that are acquiring it (even if all of them in read mode). Multiple threads can be be in read mode in the critical section, though they have contention when they're entering/exiting the section.--Additionally, the Java implementation of read/write lock is creating and destroying a lot of objects when that contention happens.--My understanding of the code is that we don't need to acquire the read lock in that point. The reason is that, we are already acquiring the lock in the `lookupClient()` method, although only if the pool is null. Additionally, when `Bookkeeper.close()` is invoked all PCBC will be set to closed as well, so it will not be possibile to create a new connection.--All the line changes in the patch are just removing the readLock acquire and try/finally, and reducing the indentation level.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1292 from merlimat/bookie-client-rw-lock and squashes the following commits:--2104a3aa7 [Matteo Merli] Converted anonymous classes into lambdas-cabad14e5 [Matteo Merli] Avoid acquiring closeLock.readLock() on every add/read operation;9df8dac295c875ee3395d78a2bab3cda0c3c9ddd
Use reflection based CRC32 to pass direct memory pointer--The crc update with the bytebuffer is very expensive, especially in netty > 4.1.12.--```java-crc.get().update(data.nioBuffer());-```--Converting a direct`ByteBuf` into a `ByteBuffer` with `data.nioBuffer()` is actually resorting to allocating an unpooled `DirectByteBuffer` which is actually killing the GC (since direct memory is freed when the `DirectByteBuffer` instances are GCed, but the pauses are > 1 second).--This is an adaptation of a change from Yahoo branch at https://github.com/yahoo/bookkeeper/commit/6c01ca2921a998f3bf2e85cacb27867773e7ea28--Initially I though this change was not needed anymore in 4.7 codebase, and that is true for the CRC32c variant. For the regular CRC32, though, we need to avoid the bad behavior of unpooled direct buffers.--Additionally, as in #1306, the thread local variable was made static to avoid the leakage of instances per each ledger.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1307 from merlimat/crc32-bytebuffer and squashes the following commits:--8b81245a0 [Matteo Merli] Made classed package private-a7ff1573f [Matteo Merli] Use reflection based CRC32 to pass direct memory pointer;d8c95885136b46013ae942b3d32ae0ea66866dd2
Issue #1282: call to appendLedgersMap in flushCompactionLog--Descriptions of the changes in this PR:--with this change https://github.com/apache/bookkeeper/commit/3392beee5c70abe36d36604723e14d97b7764be9 compactionlog was introduced. But for compactionlog call to appendLedgersMap (// Append ledgers map at the end of entry log) isn't made.--So for these logs, getEntryLogMetadata call has to call extractEntryLogMetadataByScanning for getting the metadata of entrylog. Which is a perf hit.--Master Issue: #1282--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1283 from reddycharan/compactionlogfix, closes #1282;2bd24b7bbd531261bb5ca203b02575b1b1eb4890
[DLOG] use Atomic***FieldUpdater and LongAdder if possible--Descriptions of the changes in this PR:--AtomicFieldUpdater + volatile provides similar guarantees as Atomic but use much fewer memory.-In dlog, when handling large number of streams, there can be a lot of Atomic fields with `LogHandler`, `SegmentWriter` and such.-Switching using Atomic to using AtomicFieldUpdater + volatile will save a lot of memory. See [details](http://normanmaurer.me/blog/2013/10/28/Lesser-known-concurrent-classes-Part-1/)--LongAdder is less contended across threads, which is more preferable to AtomicLong when multiple threads update a common sum. E.g. SampledMovingAverageRate.-Switching to use LongAdder if AtomicLong is not needed. See [details](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/LongAdder.html)--Master Issue: #<master-issue-number>--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia@apache.org>, Philip Su <psu@twitter.com>--This closes #1299 from sijie/use_atomic_field_updater;db713f32c24cc9345d8b813aeef9d079b254d16a
[DLOG] Fix TestZKLogStreamMetadataStore--Descriptions of the changes in this PR:--*Problem*--All test cases in `TestZKLogStreamMetadataStore` share same zookeeper cluster. so if the tests-run before `testGetMissingPathsRecursive` runs, they might create the missing path components-for `testGetMissingPathsRecursive`, which will fail the assertion in `testGetMissingPathsRecursive`--*Solution*--Add unique suffix to "/path" for each test case to avoid conflicts--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Jia Zhai <zhaijia@apache.org>, Philip Su <psu@twitter.com>--This closes #1300 from sijie/fix_zk_log_stream_metadata_store;c36cf2b8263ccea9e1c21ac36ff0d9aebd3a88a3
Drop MD5 signatures from Release Guide and add a reference to git sha in VOTE email template--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1301 from eolivelli/drop-md5-release-guide;23d1e61c5a7fdb41ffc8ada3618cd0f9cae21103
Remove references to md5 checksums in download page--According to current ASF suggestions, it is better to stop signing release with MD5, so we need to drop the links in the download page.--See paragraph which states "MD5 hashes are deprecated; please use SHA for new release" at https://www.apache.org/dev/release-signing.html--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1302 from eolivelli/dropmd5-download;7149789b03d392cd7aabc4bb2b07186d657f5986
Added executeOrdered to complement submitOrdered--In many cases, we are not interested in the `ListenableFuture` returned by `submitOrdered()` call. In these cases we can avoid creating the future object which will be ignored by calling the `execute()` instead of `submit()` on the underlying executor.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1290 from merlimat/execute-ordered;31b7db6dffd1eb3169e4304c9864462f56866fc9
Create 4.6.2 documentation stub--This change prepares the directory structure for docs of 4.6.2. New pages are not linked from menu.--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1296 from eolivelli/fix/copy-website-462;837b94429d8aac3c00b4d7f846a3ba770965f6ab
Add sync variants of all methods in handles--As discussed on the mailing list [1], this patch removes the-inconsistency around the naming of the close call on the new handle-APIs, by creating sync versions of each async calls, and renaming the-async versions to have the suffix "Async".--Most of the changes are very mechanical - just a copy of the old-method and some small fixups the javadoc. One thing to note is that-I've made a copy of the close and closeAsync methods in the-WriteHandle interface, so that the ReadHandle and Handle javadoc for-these methods do not have to talk about what it means to close/seal a-ledger.--Another change is that I've removed the SneakyThrows from close, that-would have also been needed on the other sync methods. Instead, I pass a-exception handler to FutureUtils which generates a BKException.--[1] https://lists.apache.org/thread.html/c3784cffb949438510d21e5eac8c0351865c6748c42c380e673a60db%3Cdev.bookkeeper.apache.org%3E--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1288 from ivankelly/async-rename;c1947c7b7d7c0a6736b2a35511b5f70072c12972
Issue #1287: NPE at DNS.reverse--Descriptions of the changes in this PR:--*Problem*--Null value can be returned on retrieving attributes.--*Solution*--If null value is returned, throw NamingException so cached localhost name is used.--Master Issue: #1287--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1295 from sijie/fix_dns_reverse, closes #1287;52cefcfae654e317f341a58da0d0a07e902eefa3
Implement directly ChannelOutboundHandlerAdapter in BookieProtoEncoding#ResponseEncoder--This change is mostly a clean up/refactor which drops intermediate MessageToMessageEncoder and MessageToMessageDecoder from BookieProtoEncoding--Author: Enrico Olivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@gmail.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1286 from eolivelli/fix/java9-response-corrupted;a36f1ab88034d6b1bdfe75e725886c2e8cca1e85
Refactored logAndConvertStatus() to avoid allocation when debug is off--The method `logAndConvertStatus(StatusCode status, int defaultStatus, Object... extraInfo)` is being called when processing the response for each write/read request in `PerChannelBookieClient`.--The logging is only done at debug level and the `extraInfo` is not used otherwise. By taking the `Object...` we're effectively taking a `Object[]` that is allocated each time, along with the boxing for ledgerId/entryId.--Refactored the code separate the logging and the status code conversion, so that we can skip the allocation when debug is off.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1291 from merlimat/log-and-convert-status;4fe823ba19b86abecaf575b009c55b5d8da51b90
Improve FileInfoBackingCache--Descriptions of the changes in this PR:--There are a couple of issues noticed in FileInfoBackingCache:--1) There is a race condition in loadFileInfo between get-check and put. If concurrent loading happens, there might be a FileInfo loaded into the map after get-check. This can cause incorrect reference count on FileInfo.--2) FileLoader is doing I/O operation which happens under a giant write lock.--3) assert is typically not recommended since it is disabled at production runtime typically.--*Changes*--- Check whether fileinfo exists or not after getting write lock and before put-- Move any I/O operations out of write lock-- release the new FileInfo if concurrent puts happen-- remove the usage of assert--Beside that, switch to use ConcurrentLongHashMap to avoid boxing and unboxing.--Related Issues:--#913 #832--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1284 from sijie/improve_fileinfo_backing_cache;1bd2c0eef3af8810e70116633b95c4133183d873
Fixed typos in README.md--Author: dmsergeevp44 <32652957+dmsergeevp44@users.noreply.github.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1285 from dmsergeevp44/patch-1;dffca1ab4c75f977e6cf96a632fda448b52c46b8
Improve write rejection in DbLedgerStorage--This PR contain 2 changes that are much related to each other.--1. Changed DbLedgerStorage write cache read-write lock into a `StampedLock`-   Main reason for using `StampedLock` is that this lock is always taken as a "read" lock, when putting entries in the the cache. It is protecting for the swapping of the write cache when the flush is triggered. Most of the time, we have many threads acquiring the read-lock. `StampedLock` is better in this scenario because there isn't any contention in the optimistic path (just a double volatile read).--2. Have a configurable throttle timing when the write cache is really full.-    If we try to write faster than we can put data in the storage device, eventually both write caches will get full and we have to throttle writes. Added here a setting to configure the amount of time to block the thread (who's calling `Bookie.addEntry()`, it could be IO thread or a addEntryWorker depending on configuration).-   After the timeout, if we still weren't able to flush the write cache and insert the current entry, bookie will reject the write operation, without logging but rather using a counter to keep track of it.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1280 from merlimat/db-storage-stamped-lock;1496ebf8cd0753a92be384e019b7ed6ec03e1ad8
Fixed DbStorage write cache segment index computation--When the write cache was merged from `yahoo-4.3` branch into master, an improvement went in around computing the the write cache segment index (doing shift instead of division) and that introduced a problem.--The write cache is broken into multiple segments (since buffers in JVM can only be at most 2GB). By default we use 1GB segments (or smaller if the write cache is overall smaller).--Because the shift count was wrong, the entries in the first segment were being ovrridden by entries in the 2nd segment (entries in the other segments were all fine).--That would lead to write some garbage in the entry log and subsequent read failures.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1279 from merlimat/fix-write-cache-segment-index;6edbdd905dbb1a20a7e9282047c6a255d1e9f527
Implement `toString` method for CheckpointList and BufferedLogChannel--Descriptions of the changes in this PR:--```-Flushing entry logger 102 back to filesystem, pending for syncing entry loggers : [org.apache.bookkeeper.bookie.EntryLogger$BufferedLogChannel7d98c184].--org.apache.bookkeeper.bookie.SortedLedgerStorage - Reached size org.apache.bookkeeper.bookie.CheckpointSourceList$CheckpointListd2c00ea5-```--`CheckpointList` and `BufferedLogChannel` is missing `toString` implementation.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1278 from sijie/fix_tostring_issue;c4a4318fcd308351b66c39599187c2e79fb0687a
Fix ByteBuf leaking at Journal--Descriptions of the changes in this PR:--BufferLogChannel uses a pooled bytebuf for buffering writes. However Journal only closes the underlying log file channel, but it doesn't close buffer log channel, which can cause bytebuf leaking.--This problem get exposed at #1268--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1275 from sijie/fix_bytebuf_leaking_on_journal;61ed8a697e9c1f6edbd8996819f602f6ca79920d
Fix logging issue on PendingReadOp--Descriptions of the changes in this PR:--`EntryImpl` is recycled after callback is submitted for a given read op. However the object might be referenced after it is recycled, since read callback can come back after the read op is error-out.--This doesn't affect any operation or correctness. However it might introduce some confused logging.--This also got exposed by #1268--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1276 from sijie/fix_recycling_entries;6667955cd1fd973f9880831b4b59f525663d5ff8
Set `ENABLE_DIGEST_TYPE_AUTODETECTION` to true as default value--Descriptions of the changes in this PR:--*Motivation*--We have recorded digest type in the ledger metadata since BK 4.5. it would be great to let client automatically detect the digest type-on opening ledger. So turn on the autodetection feature by default.--*Result*--digest type autodetection is on by default.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1252 from sijie/flip_default_values;c4c8c035df04d702d92b4e57b3fe1e5c1b554afc
Ensure we instantiate threads that extend Netty FastThreadLocalThread--Since we make heavy use of `Recycler` and other `FastThreadLocal` objects from Netty, we should make sure that all (critical) threads that we instantiate are inheriting from `FastThreadLocalThread`.--`FastThreadLocalThread` has an optimization that makes access to `FastThreadLocal` faster. It's a class that extends regular `Thread` and adds a field for the thread local access.--There are a couple of places where we're currently not using `FastThreadLocal`:- * `OrderedScheduler` builder- * `BookieThread` (which is used in `Journal`, `ForceSyncThread`, etc..)--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1274 from merlimat/fast-thread-local;ec8b10ae848576654748ba93ac8a5e0533a901a8
Use final variables in BoundedScheduledExecutorService--Make the fields final so that the optimizer can easily remove the `if (maxTasksInQueue > 0) {}` branch when the limit on the executor is disabled.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1273 from merlimat/final-bounded-executor;0fdbb0622362849662b246a11b107c5f520060ad
Improve `BookKeeperAdmin#format` to avoid constructing redundant resources--Descriptions of the changes in this PR:--*Problem*--After metadata service uri change, all the metadata managers can be retrieved via metadata drivers.-So there is no need to construct another bookkeeper client to get ledger manager factory for formatting ledger metadata.--*Solution*--- remove constructing bookkeeper client and use the metadata driver to get ledger manager factory to format ledger metadata-- expose layout manager in bookie driver as well-- since we are adding `getLayoutManager` in bookie driver, we need to update `MetadataDriversTest`. cleanup the test drivers in `MetadataDriversTest`.--Related Issue: #1269--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1270 from sijie/improve_format;b92251379b1183fea3fe124637390ddc72d5a069
Fixed journalQueueSize counter increment--The `journalQueueSize` counter was only decremented.--Moved the increment in the common method that is called in every path when adding to journal.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1271 from merlimat/journal-stat;20fc51cfddc5e271385795d7b180cf5d35b75a3e
Register jvm_memory_direct_bytes_used metric so that it's reported on Prometheus--The `jvm_memory_direct_bytes_used` metric is being registered on the default Prometheus static registry, though we're only exporting the stats that were added into the local registry instance.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1272 from merlimat/fix-mem-stats;1825dc06c419aca33dc27efe33f5571f1e280a4b
Close bookkeeper client used in format--Otherwise, the executors threads could keep the process calling it-alive. This isn't a problem for BookieShell, since it does a System.exit,-but it currently is for pulsar metadata cluster format.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1269 from ivankelly/close-format-client;9aececa466ed1bc2be731543bd549a51d7c8ed3c
Fixes for multiple journals recovery--Currently, the implementation of multiple journals in bookie is broken because all journal instances are using the same `logMark` file to store the journal marker, stepping into each others.--Adding here a suffix for `logMark` to have unique files: `logMark.0`, `logMark.1` etc.-If there's 1 single journal, we'll keep using `logMark` so there's no compatibility issue.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1254 from merlimat/fix-multiple-journals and squashes the following commits:--41c01af63 [Matteo Merli] Fixed LastMarkCommandTest-15ea26806 [Matteo Merli] Merge remote-tracking branch 'apache/master' into fix-multiple-journals-48346b856 [Matteo Merli] Fixes for multiple journals recovery;adc906f60ff74cce33b150f53a3e2a203c0920d4
Fixed buffer release in v2 BookieProtocol--There was a buffers leak when using V2 bookie protocol. This was introduced with the refactoring and the merges from yahoo branch.--Note: this was only happening when selecting  v2 protocol in client configuration.--The current code was missing a release in both the add and read entries path. I've been running it for some time and the ref-counting seems correct after the fix.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1266 from merlimat/fix-refcounting;01fc8580204d726b62ecb4aac99eeda4f3662acb
Refactored LAC cache in DbLedgerStorage--The `TransientLedgerInfo` cache that holds the LAC (or explicit lac) for all ledgers has showed up in the profiler as a big contention point.--### Modifications-- * Only add an item in `TransientLedgerInfo` is someone has asked for LAC or has set explicity LAC. This will save lot of memory if many ledger are not requiring the LAC info.- * Use `ConcurrentLongHashMap` to store the `TransientLedgerInfo`. There are few advantages:-   - Key in the map is `long` and doesn't need boxing-   - The `get()` operation uses a stamped lock which is ideal in cases the number of `get()` is way bigger than `put()` operations, since it only needs a volatile variable read. In this case the map is only updated when new ledgers are added / removed, but we do a `get()` on each `addEntry()` operation.-  - Schedule periodical cleanup of the map for stale ledger info entries--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1264 from merlimat/refactor-lac-cache-db-ledger-storage;76ba8e294e151092abe1e195009314fdd6eaa64a
BP-29 (task 4): use metadata service uri for constructing registration manager and ledger manager factory--Descriptions of the changes in this PR:--The main changes are at two places:--- Deprecating using ServerConfiguration#getRegistrationManagerClass(). Changed Bookie.java to use MetadataBookieDriver to getRegistrationManager().-- Use MetadataBookieDriver/MetadataClientDriver to retrieve ledger manager factory in Bookie.java / BookKeeper.java--The other changes are in-place changes for replacing using registration manager to using metadata drivers.--- provides a few util functions in `MetadataDrivers` to run `functions` with registration manager / ledger manager factory--Master Issue: #1123--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1251 from sijie/use_metadata_service_uri_in_registration_manager;b53c0c3370c42d753afb852824ea12d2dbce4f2e
ISSUE #881: use initialize insteadof format in docker image--Descriptions of the changes in this PR:--Currently docker image uses format during startup to initialize the cluster. It would be good to separate initialize from format. The initialize command should only create znodes for brand new environment. It should not involve any logic on reformatting.--- use initialize insteadof format in docker image.-- make initialize an atomic operation.-- add initialize and nuke command in makefile.-- fix error for non root user running.--This PR tested by local build, since 4.7 is not released, will bump bk version in Dockerfile once 4.7 released.--Master Issue: #881--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1263 from jiazhai/issue_881, closes #881;fa4e9d7d8cc91c984383779e8bad2248b7951540
Merge tests/jmh into microbenchmark--Descriptions of the changes in this PR:--tests/jmh was added a while ago, but it is got dropped out of root pom with mistakes.-mircobenchmark was added later. it is making sense to merge tests/jmh into microbenchmark module since they are using jmh to do microbenchmarks--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1265 from sijie/move_jmh_to_benchmarks;8ae8e00bab15d2ec5d596547c106c9b39b8d5a40
Collect Prometheus latency stats using DataSketches--The implementation for collecting and estimating the latency quantiles in the Prometheus Java client library is very slow and it is impacting the the bookie performance.--I have added a micro-benchmark that tests our various stats providers. These tests are simulating 16 concurrent threads updating the stats.--#### Counter increment-```-Benchmark                              (statsProvider)   Mode  Cnt    Score      Error   Units-StatsLoggerBenchmark.counterIncrement       Prometheus  thrpt    3  391.882 ±  786.987  ops/us-StatsLoggerBenchmark.counterIncrement         Codahale  thrpt    3  449.341 ± 1337.736  ops/us-StatsLoggerBenchmark.counterIncrement          Twitter  thrpt    3   43.354 ±    9.331  ops/us-StatsLoggerBenchmark.counterIncrement          Ostrich  thrpt    3   43.790 ±    1.332  ops/us-```--Here prometheus is fast, though not as fast as a simple `LongAdder` which can reach ~500M ops/sec.--#### Latency quantiles--```-Benchmark                              (statsProvider)   Mode  Cnt    Score      Error   Units-StatsLoggerBenchmark.recordLatency          Prometheus  thrpt    3    0.255 ±    0.667  ops/us-StatsLoggerBenchmark.recordLatency            Codahale  thrpt    3    4.963 ±    1.671  ops/us-StatsLoggerBenchmark.recordLatency             Twitter  thrpt    3    4.793 ±    0.766  ops/us-StatsLoggerBenchmark.recordLatency             Ostrich  thrpt    3    2.473 ±    6.394  ops/us-```--Here is where Prometheus is super-slow: 250K ops/second max, mostly due to contention and GC pressure.--## Modification--I have re-adapted a stats collector I had done in the Yahoo branch:-https://github.com/yahoo/bookkeeper/tree/yahoo-4.3/bookkeeper-stats-providers/datasketches-metrics-provider/src/main/java/org/apache/bokkeeper/stats/datasketches--This is based on the [DataSketches](https://datasketches.github.io/) library to have very fast and lightweight quantile estimates (along with a number of other operations), plus some tricks to avoid concurrency issues by using thread local collectors and aggregating when needed in background.--After the change, the throughput is 150x the original prometheus collector.--```-Benchmark                              (statsProvider)   Mode  Cnt    Score     Error   Units-StatsLoggerBenchmark.counterIncrement       Prometheus  thrpt    3  531.906 ± 129.602  ops/us-StatsLoggerBenchmark.recordLatency          Prometheus  thrpt    3   27.538 ±   5.893  ops/us-```--It is worth noting that the main bottle-neck in the `recordLatency` test is now the `System.nanoTime()`-call used to pass different samples to the stat logger.--`System.nanoTime()` is not super fast:--```-Benchmark                               (statsProvider)   Mode  Cnt    Score     Error   Units-StatsLoggerBenchmark.currentTimeMillis              N/A  thrpt    3  161.502 ± 267.238  ops/us-StatsLoggerBenchmark.nanoTime                       N/A  thrpt    3   32.822 ±   2.256  ops/us-```--By removing the `System.nanoTime()` call from the benchmark, the Prometheus+DataSketches collector results in:--```-Benchmark                               (statsProvider)   Mode  Cnt    Score     Error   Units-StatsLoggerBenchmark.recordLatency           Prometheus  thrpt    3  108.542 ±  31.848  ops/us-```--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1245 from merlimat/prometheus-datasketches;3bff19956e70e37c025a8e29aa8428937af77aa1
Fixed journal trimming after write cache flush in DbLedgerStorage--`DbLedgerStorage` uses an in-memory write cache to accumulate entries before writing into the entry log.--The flush of the write cache is triggered by 2 factors:- 1. `SyncThread` issuing a checkpoint (eg: every 10sec or 1min)- 2. Write cache is full, so we need to force the flush--In case (1), the checkpoint is also communicated to the journal which can then move the `logMark` forward and eventually discard old unused journals.--In cae (2), we're not moving the `logMark`. This has few side effects:- 1. When restarting the bookie it will replay a bigger portion of the journal- 2. We are moving the `logMark` only every 1min, so we need to keep 1minute of journals on disk-    - If the disk hosting the journal(s) has low capacity, it can fill it up-    - This is evident when mounting the journal on a 60GB ram-disk and using 8 journals in the bookie. At a sufficient rate, the write cache keeps getting flushed, but the journals are only trimmed after 1 minute, thus accumulating 1min worth of writes in the journal device, filling up the space.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1261 from merlimat/db-storage-journal-trimming;70b2e4cf49d2fc4903c277d309dbe8c0bc5e4d7d
Allow to send callbacks from journal thread--In BK 4.3 it was possible to configure 0 threads for the dispatching of journal callback threads.--There might be good reasons to not use a thread pool when dispatching the callback threads:- * Avoiding one more context switch- * Avoiding contention on the executor enqueuing- * When using multiple journals, the journal thread is not a bottleneck anymore--We should allow the same convention (threads=0 means direct execution) that we have in other places.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1258 from merlimat/journal-callbacks;30b7bebff7c99ac2cf6c5b784b8a122b7b3b6022
Replaced synchronized with volatile read in BookieStatus--`BookieStatus.isInReadOnlyMode()` is being called from IO threads at each write request.--Having `synchronized` method is a major source of contention between all these threads and caps the throughput and increases the latency.--Replacing here with a `volatile` variable read. This will have the same exact behavior as today while removing the contention point.--I think we could eventually even do a "dirty" read of that variable to further reduce the overhead of the volatile read.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1259 from merlimat/bookie-status-contention;e60085286f48c73ec779e45c84b4a76b2dc2da38
ISSUE #762: copy codahale files to org.apache.bookkeeper.stats.codahale--Descriptions of the changes in this PR:-Codahale stats providers are sharing same package name with the stats library org.apache.bookkeeper.stats. We should consider moving them to their own package name.-`org.apache.bookkeeper.stats => org.apache.bookkeeper.stats.codahale`--For BC concerns, we need to do this in two phases:-- in 4.7, we copy the files but still have the old files for BC. but mark the old classes as deprecated.-- in 4.8, we remove the old files.-because the class names are used for reflection.--Master Issue: #762--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1257 from jiazhai/issue_762, closes #762;fc8097f33242d6b1a6cbcce10466fb5bfc663b5a
ISSUE #1255: Bookie should not advance the journal marker before creating the index file--Descriptions of the changes in this PR:--*Problem*--Currently Bookie journal 'new ledger' entry if a ledger doesn't exist at ledger storage. This 'new ledger' entry is journaled before adding the entry to ledger storage. so this would cause a problem on checkpointing.--- journal 'new ledger' entry--```-    /**-     * Retrieve the ledger descriptor for the ledger which entry should be added to.-     * The LedgerDescriptor returned from this method should be eventually freed with-     * #putHandle().-     *-     * throws BookieException if masterKey does not match the master key of the ledger-     */-    private LedgerDescriptor getLedgerForEntry(ByteBuf entry, final byte[] masterKey)-            throws IOException, BookieException {-        final long ledgerId = entry.getLong(entry.readerIndex());--        LedgerDescriptor l = handles.getHandle(ledgerId, masterKey);-        if (masterKeyCache.get(ledgerId) == null) {-            // Force the load into masterKey cache-            byte[] oldValue = masterKeyCache.putIfAbsent(ledgerId, masterKey);-            if (oldValue == null) {-                // new handle, we should add the key to journal ensure we can rebuild-                ByteBuffer bb = ByteBuffer.allocate(8 + 8 + 4 + masterKey.length);-                bb.putLong(ledgerId);-                bb.putLong(METAENTRY_ID_LEDGER_KEY);-                bb.putInt(masterKey.length);-                bb.put(masterKey);-                bb.flip();--                getJournal(ledgerId).logAddEntry(bb, false /* ackBeforeSync */, new NopWriteCallback(), null);-            }-        }--        return l;-    }-```--- add entry to ledger storage-```-    /**-     * Add an entry to a ledger as specified by handle.-     */-    private void addEntryInternal(LedgerDescriptor handle, ByteBuf entry,-                                  boolean ackBeforeSync, WriteCallback cb, Object ctx)-            throws IOException, BookieException {-        long ledgerId = handle.getLedgerId();-        long entryId = handle.addEntry(entry);--        writeBytes.add(entry.readableBytes());--        if (LOG.isTraceEnabled()) {-            LOG.trace("Adding {}{}", entryId, ledgerId);-        }-        getJournal(ledgerId).logAddEntry(entry, ackBeforeSync, cb, ctx);-    }--```--The problematic sequence can be described as below:--- thread t1 is adding the first entry of ledger L1-- thread t2 is adding entries of ledger L2-- t1 is adding a journal entry of 'new ledger L1'-- t2 is adding entries after t1 adds the journal entry and before t1 adding the entry to ledger storage-- after t2 added entries, checkpoint happens in the ledger storage. it would roll the journal mark, which will claim the 'new ledger L1' entry as persistent.-- if the bookie restarts, it would fail with no such ledger exception.--The problem can be produced using a unit test: https://github.com/sijie/bookkeeper/commit/5053a717cd578aeb88236d373553d7494501b801--*Solution*--The fix is simple - just make sure the 'new ledger' journal entry is added after an entry is added to ledger storage. so it make sure when checkpoint happen it will flush and create the ledger before moving the journal mark.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Jia Zhai <None>, Yiming Zang <yzang2016@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1256 from sijie/fix_db_ledger_storage_checkpoint, closes #1255;7e8980fff096a9111e9365d0dc959af0625a87db
Jenkins seed job for testing DSLs--The job allows you to specify a repo and a branch. It will look for-all files named .test-infra/jenkins/jenkins_testing_job_*.groovy and-try to generate jobs for them. The seed job is in the folder-bookkeeper-jenkins-testing/ and has lookupStrategy set to-'SEED_JOB'. This means that any job generated by this seed will be-created in the same folder, thus lowering the chance of breaking our-existing production jobs.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1248 from ivankelly/test-seed;96ff1c0d44bf1ac6b0ce3ca21053ae10ab7e2294
Fixed Journal stats names--In `BOOKKEEPER-1009: Use multiple journals in bookie` 123eccd435a4a96a9147ed4a24efbe9025fe79ba there was a change in the metrics name that would be affecting also user not running with multiple journal.--It is a bit inconvenient to aggregate the stats in the metrics collector (how to aggregate 99pct latency for example).--I think the best option is to have a single metric even when using multiple journal threads.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1250 from merlimat/journal-metric-names;4578e6d65a304c870fcba013099badd6018c95de
ISSUE #336: add DC/OS package update and instructions--Descriptions of the changes in this PR:--Provide instructions of updating DCOS package by using latest docker image when do new release.--Master Issue: #336--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1247 from jiazhai/issue_336, closes #336;e20bb40ddff4c5bd033625dc82788b545f8d66ee
Make it possible to build site on ubuntu and debian--Xenial ships with ruby 2.3.1. Debian Stretch ships 2.3.3. The current-Gemfile asks for 2.4.1. This patch drops the requirement to >=2.3.1.--It also make it possible to test the site without sudo.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1253 from ivankelly/site-deb;7e494a222d497aca2f56bacc57a79f022e5a078a
Issue #570: make changes to SyncThread/checkpoint logic.--Descriptions of the changes in this PR:--make changes to SyncThread/checkpoint logic, so that incase of-entrylogperledger, checkpoint happens for every flushInterval-but not when active entrylog is created/rolled over.--This is < sub-task3  > of Issue #570--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1236 from reddycharan/addcheckpointlogic, closes #570;88addff33a9a9474b069ac197d46d2d672ae988d
Fixed Journal static empty array list recycling--When `journalSyncData=false`, we passing `EMPTY_ARRAY_LIST` to the `ForceWriteThread` when the journal is rolled over.--I have seen this exception:--```-18:39:52.285 [ForceWriteThread] ERROR org.apache.bookkeeper.bookie.BookieCriticalThread - Uncaught exception in thread ForceWriteThread and is exiting!-java.lang.NullPointerException: null-	at io.netty.util.Recycler$DefaultHandle.recycle(Recycler.java:219) ~[io.netty-netty-all-4.1.21.Final.jar:4.1.21.Final]-	at org.apache.bookkeeper.common.collections.RecyclableArrayList.recycle(RecyclableArrayList.java:55) ~[org.apache.bookkeeper-bookkeeper-server-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-	at org.apache.bookkeeper.bookie.Journal$ForceWriteRequest.recycle(Journal.java:402) ~[org.apache.bookkeeper-bookkeeper-server-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-	at org.apache.bookkeeper.bookie.Journal$ForceWriteRequest.access$1(Journal.java:399) ~[org.apache.bookkeeper-bookkeeper-server-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-	at org.apache.bookkeeper.bookie.Journal$ForceWriteThread.run(Journal.java:506) ~[org.apache.bookkeeper-bookkeeper-server-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-```--This is due to calling `recycle()` twice on the same `EMPTY_ARRAY_LIST`  instance. The solution is that `EMPTY_ARRAY_LIST` should not be a pooled instance and we should check that before recycling.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1249 from merlimat/fix-journal-list-recycle;cefdeb6e3c6f4231ca8d09e93cc7f3dedd3a058f
Disable using v2 decoder to decode v3 response if usingV2WireProtocol is enabled and handle unknown op in v2 request decoder--Descriptions of the changes in this PR:--*Problem*--- response decoder should use whatever protocol that request is using to decode the response. otherwise it is making wrong assumption on response protocol.-- v2 request decoder doesn't handle unknown op correctly, which will cause netty double-release bytebuf--*Solution*--- make sure response decoder respect the protocol that client is using for sending requests-- v2 request decoder should throw exceptions when fail to decode unknown request--Related issues: #198--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1240 from sijie/bookkeeper_fix_bytebuf_issues;59e48a390c1caa12adb7cc89afd2f9d48790a674
Issue #1241: Fixed NPE in PerChannelBookieClient--The `CompletionValue` object from the map can be null in some cases and we need to protect for it.--Fixes #1241--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1242 from merlimat/fix-npe, closes #1241;f0757e9ac643d6f36a11be4065d163437180cb7e
Removed ServerStats since it was not used anymore--ServerStats class was previously used to expose stats through JMX but it's-not being used anymore and it's just causing lock contention in Bookie IO threads-when using v2 protocol.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1243 from merlimat/remove-server-stats;e3d47ae14a0140b10a6303ecfddbcba66ce90933
Move dependency version management to root pom file--Descriptions of the changes in this PR:--*Motivation*--To have a clear dependency management at bookkeeper, avoid unnecessary version conflicts.--*Changes*--**Dependencies**--- define versions at properties section at root pom file-- move dependency definitions to `dependencyManagement` at root pom file-- avoid specifying dependency version at sub modules unless it is really needed. comments were already / are added for those cases.--**Plugin Dependencies**--- define versions at properties section at root pom file-- use property to specify version when using a new plugin-- remove duplicated configurations on plugins--*Other changes*--- cleanup root pom files for module `stream` and `stream/distributedlog`-- fix some checkstyle violations since we are changing some plugin inheritances.--This fixes #251--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Jia Zhai <None>--This closes #1235 from sijie/cleanup_poms;532a43b4d7b2e43fb345983d987c1f7f09cfd38f
Issue #570: Move logic of unpersistedbytes to bufferedchannel--Descriptions of the changes in this PR:--This is < sub-task2 > of Issue #570.--https://github.com/apache/bookkeeper/commit/26b09abb4202362ca37d6944ce75eb2a3309dc3c-introduced the flushEntrylogBytes factor. But it is structurally correct to have this-logic in BufferedChannel, rather than in EntryLogger, since it is paramter of BufferedChannel.--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1228 from reddycharan/fixunpersistedbytes, closes #570;30261eae3fd8ab25239d57cfb86a200d5f7b6b7d
Reduce running time for testLedgerCreateAdvWithLedgerIdInLoop--This test has flaked in CI regularly mainly because it takes a long-time to run.--This changes reduces the running time by.-1. Creating the ledgers with a ensemble size of 1-2. Creating and writing to the ledgers in parallel-3. Using async methods to write entries to the ledgers--This brought the test from ~60 seconds to ~7 seconds locally.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1233 from ivankelly/ledger-create-adv-timeout;7d932365eb942e0dde03d4bd73ee4500576afd0d
Issue #570: getting rid of unnecessary synchronization in InterleavedLedgerStorage--Descriptions of the changes in this PR:--This is < sub-task1 > of Issue #570.--In InterleavedLedgerStorage, since the initial version of it, addEntry and processEntry methods are synchronized, but they are not required to be synchronized.--Removal of unnecessary synchronization in InterleavedLedgerStorage methods, as described in http://mail-archives.apache.org/mod_mbox/bookkeeper-dev/201707.mbox/%3CCAO2yDyZ946fp2S_qR2iL178hPiXgrnFGb%3DpvkyK4ReSYAtNLBw%40mail.gmail.com%3E--Master Issue: #570--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1225 from reddycharan/nonsynchaddinterleavedstorage, closes #570;e62415676f787c8db243a7bca7feec2dc7de565b
Make shading rule consistent between bookkeeper-server-shaded and bookkeeper-server-tests-shaded--Descriptions of the changes in this PR:--`bookkeeper-server:test-jar` is working with `bookkeeper-server`. we should make `bookkeeper-server-tests-shaded` work with `bookkeeper-server-shaded`.  so this change is to make they have consistent shading rule.--```-<dependency>-      <groupId>org.apache.bookkeeper</groupId>-      <artifactId>bookkeeper-server-shaded</artifactId>-      <version>${bookkeeper.version}</version>-      <scope>test</scope>-    </dependency>-<dependency>-      <groupId>org.apache.bookkeeper</groupId>-      <artifactId>bookkeeper-server-tests-shaded</artifactId>-      <version>${bookkeeper.version}</version>-      <scope>test</scope>-    </dependency>-```--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #1234 from sijie/sijie_improve_tests_shaded;19846b23de3be13e28082d4ba73e21bb8fa39ad2
Dont shade netty at distributedlog-core-shaded--Descriptions of the changes in this PR:--*Problem*--JVM crashed on linux platforms, when`distributedlog-core-shaded` (where netty `4.1.12.Final` was shaded) is used in a project where a non-shaded netty `4.1.21.Final` is used and epoll is enabled.--```-Event: 13.322 Thread 0x00007fef90013000 Exception <a 'java/lang/NoSuchMethodError': Method io.netty.channel.epoll.Native.epollWait0(IJII)I name or signature does not match>             (0x00000000e709c060) thrown at [/build/openjdk-8-8u141-b15/src/hotspot/src/share/vm/prims/jni.cpp, line 4011]-```--Because Epoll is enabled on linux platforms. However because two different netty versions bring in two different jni bindings, when the netty epoll transport tries to resolve the jni library, it hit the signature mismatch issue.--*Solution*--Dont shade netty at all. Let the application resolve which netty version to use.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1231 from sijie/dont_shade_netty;bed1d6f03700838f0667fbab8f8d9032b8294792
ISSUE #1229: PendingAddOp can get recycled before it gets executed--Descriptions of the changes in this PR:-*Problem*--The PendingAddOp can be recycled when it is cancelled before it is executed. so it will hit NPE when it is actually executed. This is a bug introduced by #1091--*Solution*--Only recycle PendingAddOp after it has been run.--Master Issue: #1229--Author: Sijie Guo <sijie@apache.org>--Reviewers: Andrey Yegorov <None>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1230 from sijie/fix_npe, closes #1229;fbc06ef3139ca857c60a2edbc209c8b088e979df
Fix AbstractLedgerManagerFactory on handling both shaded class and original class co-exists case--Descriptions of the changes in this PR:--*Problem*--#1217 addresses the issue when using a shaded class accessing a bookkeeper cluster.  However the assumption was made when the classpath only has shaded classes. However, it didn't address the case when shaded class and original class can co-exist. because IOException is thrown instead of ClassNotFoundException at following code:--```-                Class<?> theCls = Class.forName(layout.getManagerFactoryClass());-                if (!LedgerManagerFactory.class.isAssignableFrom(theCls)) {-                    throw new IOException("Wrong ledger manager factory " + layout.getManagerFactoryClass());-                }-```--*Solution*--This change fixes the issue.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1227 from sijie/debug_issue;3e51b8116c363604f93bdd0c6b6b71ef3387c8a8
Make table service client includes table service related jars--Descriptions of the changes in this PR:--This is a change for #1205--*Motivation*--in order to implify the other project to use table service, it would be good to make sure the client include table service related jars.--*Solution*--Include table service related jars in the client-all jar.--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1226 from sijie/publish_table_service_jars;18b1dabcebe9922878a5ed277ef0f8eaf8bcfc74
Integrate table service in bookkeeper build--Descriptions of the changes in this PR:--- update the pom files to integrate table service with bookkeeper build-- add 3 flags to control building/testing table service. by default the table service will be built and tested with existing maven commands.-  It only builds and runs the tests on following conditions:-    * `-Dstream`: enable building the table service-    * `-DstreamTests`: run the unit tests of table service-    * `-DstreamIntegrationTests`: run the integration tests of table service-- update CI jobs-    * Travis: compile table service for all builds, run unit tests if code modifications happen under `stream` directory-    * Jenkins: compile table service on precommit jobs, compile and run unit tests for postcommit jobs--Master Issue: #1205--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <zhaijia@apache.org>--This closes #1216 from sijie/built_table_service;8322482b8292f9326fb3b72c4b46dc05cc157811
Fix TestBKSyncLogReader--Descriptions of the changes in this PR:--*Problem*--The test case `TestBKSyncLogReader` is waiting an entry beyond a control record, where the number of control records can-vary depend on the timing of flush()/commit(). This introduces the flakiness of this test.--*Solution*--This change changes to wait for readahead go beyond the last user record, which is more deterministic.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Jia Zhai <None>,  Philip Su <psu@twitter.com>--This closes #1168 from sijie/fix_test_sync_log_reader;2d6c30472ccb43eb04b1934b4c0be30283c2864e
Improve Travis Build--Descriptions of the changes in this PR:--*Problem*--There are a couple of problem with current travis build--- apache/bookkeeper#1223 introduce `set -e` on script section, which it cause some weird early-exiting problem.-- we run two installs. one is the default install by travis, the other one is install with apache-rat/spotbug checks in script section, which make the build slow.-- travis_retry and travis_wait spread across different commands in the script section--*Solution*--- move build logic into a bash script file and invoke the script-- skip install section in travis--*Result*--This reduces travis build time by 10+ mins and make it stable--NOTES:--The changes under `site` and `stream/distributedlog` are used `empty commits` to trigger corresponding builds in travis.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1224 from sijie/travis_wait;bd798624bc6d65862c6d3b9abcdf5f492531d291
Refactored ReadResponse ref count handling--This contains a number of changes.--- V2 bookie protocol-  - Add retain and release methods to all responses. For read response-    it handles the data buffer.-  - ReadResponses always have a buffer now, even if empty.--- Server side-  - In the v2 read handler, releasing of the buffer in the case of-    error is left to the very end.--- Client side-  - Per channel bookie clients own the buffer for read responses.-    If a ReadCallback want it to live past the lifetime of the call-    it must call retain.--This change was originally e8643140 in the yahoo-4.3 branch.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1221 from ivankelly/yahoo-bp-11;8d048abce486c63d428041f77ee9a506756f4d1e
Enable buiding website on travis job if a PR is modifying `site`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1223 from sijie/run_tests_on_website_changes;d79c7a77883de1e8bda668f6d16d1e80c3eed33d
Support LacPiggyback, LongPoll and ExplicitLac in db ledger storage--Descriptions of the changes in this PR:--*Motivation*--DbLedgerStorage was developed in yahoo and just merged recently to master. This implementation only works for v2 protocol.-It doesn't work with v3 protocol. When using v3 protocol clients (e.g. dlog library) to talk to bookies use DbLedgerStorage,-the clients hang on waiting responses. because a few methods in DbLedgerStorage throw UnsupportedException--*Solution*--This change focuses on adding the implementations for those methods, in order to support LacPiggyback, LongPoll and ExplicitLac-for v3 protocol. The implementation follows what we had in FileInfoCache but did it in a much simpler way, since all the persistence-information has been managed by db ledger storage itself. All the information required by `LacPiggyback`, `LongPoll` and `ExplicitLac`-are transient.--This change doesn't introduce any new test cases. It reuses existing test cases to test those features using DbLedgerStorage. These-tests are:--- ExplicitLacTest: for testing explicit lac-- TestPiggybackLAC: for testing piggback lac-- TestReadLastConfirmedLongPoll: for testing long polling lac-- TestReadLastConfirmedAndEntry: for testing entry piggyback--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1218 from sijie/support_long_polls;8b8c5515e041347e0fdd791534fa0a694c96c6ae
Website fails to build due to a missing field at the yaml file--Descriptions of the changes in this PR:--The problem was introduced at apache/bookkeeper#898--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1222 from sijie/fix_website;70ff9fc6f831288a51af6b6ce7006a50a12f3902
Pull as many reviewers as possible when merging--Github uses pagination on some apis. This means that if there are a-lot of comments on a issue, it may not pick up approvals by-default. This patch increases the number of review comments to pull,-from a default of 30 to 100. A proper fix would be to enable-pagination using the Link header, but that's a much bigger change, for-little return.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1220 from ivankelly/page_comments;45c5cf5ec0f2560c8858a7167f8c1fc066bf0431
Shade bookkeeper in distributedlog-core-shaded and allow using shaded bookkeeper client to resolve ledger manager factory class--Descriptions of the changes in this PR:--*Motivation*--1. when `distributedlog-core-shaded` is co-used with other bookkeeper jars, it would cause class conflicts because `distributedlog-core-shaded` shades-most of its dependencies except bookkeeper. so it is better to also shade bookkeeper to avoid such conflicts.--2. if we shade bookkeeper, it would cause a problem on resolving ledger manager factory class stored on layout metadata.--```-java.io.IOException: Failed to instantiate ledger manager factory org.apache.bookkeeper.meta.HierarchicalLedgerManagerFactory-	at dlshade.org.apache.bookkeeper.meta.AbstractZkLedgerManagerFactory.attemptToResolveShadedLedgerManagerFactory(AbstractZkLedgerManagerFactory.java:256) ~[distributedlog-core-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-	at dlshade.org.apache.bookkeeper.meta.AbstractZkLedgerManagerFactory.newLedgerManagerFactory(AbstractZkLedgerManagerFactory.java:203) ~[distributedlog-core-shaded-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]-```--*Solution*--- shade bookkeeper dependencies in `distributedlog-core-shaded`-- add flags to allow using shaded bookkeeper jar to resolve ledger manager factory--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1217 from sijie/fix_builds;aada2c649d78101ee455ad5b15b60c2abd97929e
BP-29 (task 3): use metadata service uri for constructing registration client--Descriptions of the changes in this PR:--- Deprecated `getRegistrationClientClass` and changed bookkeeper client to use metadata service uri to construct metadata driver.-- Add a test case for TestZKRegistrationClient and fixes issues caught by the test case.--Master Issue: #1123--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1192 from sijie/use_metadata_service_uri_in_registration;68088398f6aaea7b6fa64489d5f0b87e0c5a4bd5
Bookies should prioritize recovery reads/writes--The change adds a new flag for reads, RECOVERY_READ. This flag is set-when a client is retrying to recover a ledger. Recovery reads should-be higher priority than normal reads, as recovery usually happens when-a writer has failed, and another node needs to take over the stream-that that ledger belonged to. All writes on that stream are blocked-until the ledger the ledger has been recovered, so giving these reads-priority will mean the stream is out for action for the shortest-amount of time possible.--Priority is given to these reads by executing the reads directly in-the BookieRequestProcessor, rather than adding them to the-readThreadPool where they could end up queuing.--This change was originally 372a99db in the yahoo.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #898 from ivankelly/yahoo-bp-10;7540adf110671dc4cea94b5b79b2d379f068d41b
Use the bk OrderedScheduler in dlog--Descriptions of the changes in this PR:--Dlog has an implementation of OrderedScheduler inspired of bk `OrderedScheduler`. It would be good to remove duplicated implementation here since dlog is in the same repo as bk.--- removed the dlog version of `OrderedScheduler`-- make `OrderedScheduler` implement `ScheduledExecutorService` so it can be used by dlog-- change dlog classes to use bk `OrderedScheduler`.--Master Issue: #1024--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1211 from sijie/merge_ordered_scheduler;538aee9e8bb5ef72fa780f76dba2b32701c947b3
Update download pages--Descriptions of the changes in this PR:--- remove redundant sentence in download pages (see comment at #1090)-- change latest release to use mirror_url for downloading packages and dist for asc,md5 files-- change other releases to use achive url for all files--This change fixes #1090--related changes: #1213--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #1214 from sijie/update_download_page;b2ecd28f7f826517340f965af5fa72bf3fb588a5
Update release guide to remove old releases after a new release is completed--Descriptions of the changes in this PR:--Address comments at #1213--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1215 from sijie/update_release_guide;a5b0c6ece4a29d134ec2b2327821d880b42b19f9
Merge remote-tracking branch 'apache/merge_table_service';162df68d53c8f0fce34b55edf9119d47cdd6fac4
ISSUE #1147: Move bookkeeper-server/{bin,conf} to root module--Descriptions of the changes in this PR:--*Motivation*--since 4.7, we are shipping the binary distribution using bookkeeper-dist modules. so it is making more sense to have {bin,conf} directory at root module,-rather than bookkeeper-server module.--*Solution*--- move bookkeeper-server/bin to bin-- move bookkeeper-server/conf to conf-- update the new bookkeeper cli related files as "experimental"--This change is needed for integrating with dlog scripts for BP-26 and new bookkeeper cli for BP-27.--Master Issue: #1147--Related Issues:--- BP-26 #1024-- BP-27 #1000--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1210 from sijie/move_bin_conf, closes #1147;d237b537dc62b53d7ffc51860b98e5bd0a2ca9b8
Add Jia Zhai and Enrico Olivelli to PMC list--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1212 from eolivelli/fix/update-pmc-list;cff50ee31feadf63bad1ccc1ccc3abcdf0fea79d
use FutureUtils/FutureEventListener in bookkeeper-common for dlog--Descriptions of the changes in this PR:--This is a sub-task for apache/bookkeeper#1024--After dlog is merged to bookkeeper, FutureUtils/FutureEventListener is duplicated at bookkeeper-common and distributedlog-common. This change is to remove FutureUtils/FutureEventListener from distributedlog-common and let dlog use the ones in bookkeeper-common.--The changes includes:--- remove `FutureUtils/FutureEventListener` from distributedlog-common-- change dlog classes to use the ones in bookkeeper-common-- change the dlog `OrderScheduler` to extend bookkeeper `OrderedScheduler` (required by FutureUtils.within).--Master Issue: #1024--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1208 from sijie/use_bookkeeper_futureutils;d8325409b8401bb464b457993dd2c007350f1b45
Added MockBookKeeper for unit tests--This mock class is what we use in Pulsar to do unit tests for the managed-ledger library.--This approach might be useful in general, in all cases when creating unit tests of an application that uses the BookKeeper API.--The `MockBookKeeper` behaves like the regular BK client, except it needs no bookies or zookkeeper. All ledgers and data are just kept in an hashmap in memory.--It is possible to inject failure in the sync/async calls, even after N steps. This is very useful to trigger failure in complex operations and cover this paths in unit tests.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1209 from merlimat/mock-bookkeeper;4897e43ca6b58f38f5bad7a04ba4b881b7c7551c
Merge branch 'master' of ../stream_storage_merge into merge_table_service;501d0c09088ae855797df60bdf9f02dfcbe737d5
Prepare merging table service;754f257f8bf0fd28f4ea529311e93f97df593643
Allow derived implementations of RackawareEnsemblePlacementPolicy--Leave public constructor so that it's possible to create a placement policy that derives from RackawareEnsemblePlacementPolicy.--For example, in Pulsar we have an isolation policy that works in conjunction with the rack-aware: https://github.com/apache/incubator-pulsar/blob/ac94698df6c66c4b84faa9f96db71f0019bf955e/pulsar-zookeeper-utils/src/main/java/org/apache/pulsar/zookeeper/ZkIsolatedBookieEnsemblePlacementPolicy.java#L45--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1206 from merlimat/master;c618d9a72b4f79cb2162ba7653c934dda8878596
Allow rackaware policy to be notified of any rack change--This PR is a port from Yahoo branch: https://github.com/yahoo/bookkeeper/commit/dbfd2073b6e687a5b4b9c56a0f0c3436f177db58--It adds a hook so that a placement policy implementation can add a way to notify the main rackaware policy that the rack mappings were updated.--This was used to have a specialized policy that keeps the mapping (bookie -> rack) in ZooKeeper. Whenever the new bookies are added (or updated), the administrator would update the mapping and we need to start using the new settings.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1204 from merlimat/rack-aware-notification;c0aff9f91b79b8b573f50fb4ecd0e300816f6949
BP-30: BookKeeper Table Service--Descriptions of the changes in this PR:--This BP is proposing adding a table (aka key/value) service component as a contrib module to the bookkeeper, which can later be used for metadata storage. This BP together with other BPs forms the ideas of  improving metadata management in bookkeeper.--BP Details: https://docs.google.com/document/d/155xAwWv5IdOitHh1NVMEwCMGgB28M3FyMiQSxEpjE-Y/edit#heading=h.56rbh52koe3f--Related BPs:--- BP-29: Metadata API Module #1123-- BP-28: Etcd Metadata Store #1113--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Venkateswararao Jujjuri (JV) <None>--This closes #1185 from sijie/bp_30_table_service;9bce1bf6831698d11c13b035ce92e3fb098f9ee2
BP-31 BookKeeper Durability Anchor--Descriptions of the changes in this PR:--This is the anchor BP for durability related work.-When sub BPs are created, this will be updated to-reflect the sub BP numbers.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1202--Author: JV Jujjuri <vjujjuri@salesforce.com>-Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1138 from jvrao/BP-31-durability-anchor;7a9f971d076041b87590cbca7747a8144d331d09
BP-28: Etcd as metadata store--Descriptions of the changes in this PR:--This BP is exploring using Etcd as the metadata store.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1113 from sijie/bp_28_etcd_metadata_store;c1988c15d0e0e1e68824dd39bd79525161248bf0
Issue #1195 Handle optional fields gracefully in ReadExplicitLac response--Descriptions of the changes in this PR:--ExplicitLac and header of the last entry are optional fields in the protocol.-Handle them as optionals in the response processing.--TestPendingReadLacOp.java test added by: Samuel Just <sjustsalesforce.com>--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-Signed-off-by: Samuel Just <sjustsalesforce.com>--Master Issue: #1195--Author: JV Jujjuri <vjujjuri@salesforce.com>-Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1196 from jvrao/bk-issue-1195-lacfix, closes #1195;8f6373e60fd77f3c6253657b5eff9b970a0d2143
Add Jenkins Configuration for Code Coverage nightly test--Add a job using Jenkins DSL to run every night a JaCoCo code coverage report which runs tests and sends the report to Coveralls.io--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1203 from eolivelli/code-coverage-dsl;547e017fe4f0bdc55e0a2e7628fad4656429d097
Fix LifecycleComponentStarter;34e6c7c44d8ed0011ca62b2eeedce18fa13dae29
Upgrade JaCoCo and fix code coverage build system--- Upgrade JaCoCo to version 0.8.0 which supports Java 9-- Exclude generated sources from the NAR-plugin files-- Update surefire configuration in order to not fail the build while using -Pcode-coverage--Author: Enrico Olivelli <eolivelli@apache.org>-Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1129 from eolivelli/code-coverage-2;bd69dbdb8d651d6ae482c0bb02e927b3a89fc796
Provide default values for LedgerIdFormatter and EntryFormatter--Descriptions of the changes in this PR:--Provide default values for LedgerIdFormatter and EntryFormatter.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1199 from reddycharan/defaultformatter;cb0c034f8e2e77ad41246a2952463cd7e3b55d6c
Update committers list--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1198 from sijie/add_new_committers;f70f034340dbfaaaeadd31ae7acc4f42b6517124
Fix GSSAPIBookKeeperTest--Descriptions of the changes in this PR:--*Problem*--in GSSAPIBookKeeperTest, `InetAddress.getLocalHost().getHostName()` was used for adding principle to kdc keytab. However in the tests, it uses advertisedAddress (introduced by #1097).--So it causes authentication failed because server can't be found.--*Solution*--Change to use `Bookie. getBookieAddress(..)` to get the real hostname used by bookie for adding keytab entries.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1191 from sijie/fix_gssapibookkeeper_test;f76041b9c81c3856843ce04b09ed39c14fe8c274
Dump config--Descriptions of the changes in this PR:--Dump config-- add utility method to AbstractConfiguration to return config as string and log it-- dump the config during the start of the BookieServer--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1160 from reddycharan/dumpconfig;1f7bf2d5f8338476bfe868953f419bc39dc3052e
Always reset interrupted state after catching InterruptedException--There's many places we did not do it. I've added it.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1189 from ivankelly/interrupt-thread;979de4b17b9ed9e734b8973cb211d9754c0788d1
Test that we don't break compat with Yahoo custom version--We've been merging a lot of changes from yahoo's internal bookkeeper-fork in the past months. The plan is that once everything is in, yahoo-will move to using stock opensource bookkeeper. We need to ensure that-this move goes smoothly, otherwise they wouldn't move. So this set of-tests checks whether master will work with what they are running-internally.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1190 from ivankelly/yahoo-bc;2328569d868368530474de9105d1ef17ffdef790
Issue #1164: TestTruncate#testPurgeLogs is flaky--Descriptions of the changes in this PR:--*Problem*--log segments are truncated in the background after TTL. the truncation is done asynchronously.-so when we finish writing all the log records, the truncation might still not complete yet.--*Solution*--Improve the test case to wait until the last truncation attempt is completed before asserting the log segments--Master Issue: #1164--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1165 from sijie/fix_test_truncate, closes #1164;9db6e919b023c9e3833c51b34c83d6c482b1e659
Propogate exception when bookie shutdown fails--When a bookie fails to shutdown cleanly, we should propogate the-exception that caused the problem to the main thread.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1186 from ivankelly/prop-ex;13dc9230e79c0ecbc30b8b804e506b978c3f9cb1
Allow default methods in MavenClassloader callbacks--AsyncCallback.AddCallback has recently acquired a default method,-which breaks the assumption that there is only one method on these-callbacks. However, if does have a default method that calls the one-method. This patch takes advantage of that to allow us to use-AddCallback in tests.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1187 from ivankelly/groovy-callback-default;e5af4a20f240f38c8ce712a5e3bba4976eb89a41
Disable tests reruns on dev profile--Sometimes you don't want the rerun because you _want_ to see the flake.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1149 from ivankelly/dev-rerun;9eb16c500db2db366851aed1f7b8afac2fc2ca0b
Prune networks from previous runs before IT--If a build fails, it can leave networks around. Run prune before the-integration tests to avoid this.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1184 from ivankelly/prune-networks;245f0c03cdfca0c5cc2ae1aeab3d22765ec3fad0
ISSUE #1166: Create `readonly` path for LocalBookKeeper and BookKeeperClusterTestCase--Descriptions of the changes in this PR:--This fixes #1166--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1167 from sijie/create_readonly_znode, closes #1166;c106859d5a756768fc44738b2b1c60b1743909f5
Allow to disable LZ4 compression in KeyValueStorageRocksDB--In some environments (eg: windows), LZ4 is not statically linked with the RocksDB JNI library bundled in the jar. In this cases we need to allow to disable LZ4 compression on the SST tables.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1181 from merlimat/allow-disabling-lz4-in-rocksdb;b80b72e046adce3e4e74ebbeda595dc4b4e920c2
Fix flaky travis build on checking license header--Descriptions of the changes in this PR:--*Problem*--In some environments, `BK_VERSION` is computed as `Downloading`, which is not a valid bookkeeper version. It fails the `dev/check-binary-license` script.--```-[0K$ if [ "$TRAVIS_OS_NAME" == "linux" ]; then dev/check-binary-license ./bookkeeper-dist/server/target/bookkeeper-server-${BK_VERSION}-bin.tar.gz; fi-tar: ./bookkeeper-dist/server/target/bookkeeper-server-Downloading: Cannot open: No such file or directory-tar: Error is not recoverable: exiting now-tar: ./bookkeeper-dist/server/target/bookkeeper-server-Downloading: Cannot open: No such file or directory-tar: Error is not recoverable: exiting now-tar: ./bookkeeper-dist/server/target/bookkeeper-server-Downloading: Cannot open: No such file or directory-tar: Error is not recoverable: exiting now-```--*Solution*--Remove this `BK_VERSION` setting and use "*" in the file path.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1183 from sijie/address_travis_yml;7584b1b4809e961c90b400912cfd08f7f45f3bfb
Fix type in README;b6558ff827835598bec90da5592e90ed0bac4ab1
Update readme (#43)--- update readme--- fix the classpath in scripts;5254818f0c7e01c24728c1f7e1e31f29b636942f
Bump bk/dl version to 4.7.0-SNAPSHOT (#42);e3608d2a84d9d1606df9f136738d4106207fe1b3
MockBookKeeperTestCase failed on casting ByteBufList--Descriptions of the changes in this PR:--*Problem*--Issue #1141 introduces ByteBufList. But `MockBookKeeperTestCase` still assumes `ByteBuf`. So it fails somes test cases-that use `MockBookKeeperTestCase`--*Solution*--Fix `MockBookKeeperTestCase` to expect `ByteBufList` instead of `ByteBuf`.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #1182 from sijie/fix_mock_bookkeeper_test_case;d8adde373f3d0a9a6831992003b1d0048d7285d2
Cleanup client correctly in TestCompatOldClients#testFencingOldClient--Previously we had been mistakenly cleaning up the classloader twice.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1176 from ivankelly/kill-client-bc-test;0c9f152336e8af012589b713242e46f475f7055d
Use BookieServer#getLocalAddress as the identifier in the test--Descriptions of the changes in this PR:--*Problem*--Issue #1097 introduced using `loopback` nic as the bookie server identifier. However a few test cases construct the bookie socket address using `InetAddress.getLocalHost()` and the bookie port. This bookie socket address can be different from the actual socket address that a bookie is advertising to zookeeper. It will cause test cases fail with certain network settings.--*Solution*--This change use `BookieServer#getLocalAddress()` to retrieve the actual bookie socket address. so it would respect to the server configuration and use the right socket address in the test.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1172 from sijie/use_bookie_server_get_local_address;cbb5ad555292d699e1fb2829cba46b9a7b69a7d8
Enforce zkAcls on initNewCluster--Descriptions of the changes in this PR:--initNewCluster was introduced #979. The new command doesn't honor to zookeeper acls settings. This change is to change those zookeeper calls to use `zkAcls`.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1171 from sijie/enforce_acls;64e86868e8f887e3ffdb47c3955b90c19c124407
V2 decoder marks the reads index of the payload on write--This means that any storage implementation that receives that payload,-can reset the reader index, without jumping into bytes it knows-nothing about.--This was the source of an issue when using V2 protocol with-DbLedgerStorage where the data could not be successfully read back-from the ledger.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1180 from ivankelly/broken-v2-rocks;8c10e56db285788eeb17a4290a417a0745114a77
Fix name on smoke test in pom--It says backwards compat, should be integration--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1178 from ivankelly/smoke-test-name;b321d46a2a2719045d60b990e2bdcbd6c3c2937d
Handle for 4.6.0 and 4.6.1 specially in bc test shutdown--There is a race in 4.6.0 and 4.6.1 which can cause the zk session to-be leaked. The bc test should take this into account, and wait for the-session for expire before continuing.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1179 from ivankelly/wait-longer;7a8b22fb9f2cb0def631a0769a78968920229f7b
Create a forked JVM for each bc test--Until now, BC tests have been running in the maven processes because-they do funny stuff with the classloader which didn't seem to work-with later versions of the surefire plugin. However, using a version-of surefire less than or equal to 2.8.1, we can use-useSystemClassLoader to the same effect, and therefore fork a JVM for-each test. This is desirable to isolate the tests from each other.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1175 from ivankelly/branch-per-bc-test;2a519586f616541182bafa0b135d4f6a04be4fba
Use travis_wait on running mvn test on travis--Descriptions of the changes in this PR:--*Problem*--The travis build can take more than 30 minutes, which exceeds the default limit. so the travis builds on master usually fail--*Solution*--Configure the travis build to use `travis_wait` and configure a higher timeout value.--This was set in dlog travis build : https://github.com/apache/distributedlog/blob/master/.travis.yml#L41--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1174 from sijie/use_tick_toc;85554309046597982ab649782e5a39f93de1e892
Introduce IncrementOption to support `incrementAndGet` (#41);32bd02a5771bfdb56b348dec54ec463c51cfedb6
Cleanup - remove unneeded test cases (#40)--This fixes #34;2f0f6d1b977fbb532f9558242dc0255dd4ba1cb2
Introduce "IGNORE IT CI" to ignore integration tests ci result--Descriptions of the changes in this PR:--*Problem*--Integration tests ci is not very reliable at this moment. so most of the time we have to "IGNORE CI" to allow changes-to be merged. However "IGNORE CI" is a bit too ambiguous, which can potentially ignore other CI results.--*Solution*--This change introduces "IGNORE IT CI" to ignore integration tests ci results only.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1173 from sijie/ignore_integration_tests;b24c986cd5a8057edb2c75f652ceec9feeef234c
Cleanup threads from old clients in BC tests--Some old clients don't clean up their threads correctly. This patch-introduces a thread reaper, which will check if a test has left any-threads running, and try to clean them up if they have.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1177 from ivankelly/thread-reaper;d4277c06f62f680dba9383e68c0699c343e4e5ca
Cleanup - remove `ByteBufUtils`--`ByteBufUtils` is a duplication of netty `ByteBufUtil`.;1807b1679c339bf650231c584a6a417264fadcac
Cleanup - remove writer api from table;6e5210c29d2059e4ef7335b9dbae4bd83f9c26c2
BP-29 (task 2) : Make LedgerManagerFactory a pure interface--Descriptions of the changes in this PR:--    The logic in LedgerManagerFactory#newLedgerManagerFactory is effectively the logic works for zookeeper based implementation.-    In order to produce a clean metadata api, this change is moving this logic to AbstractZkLedgerManagerFactory.--Master Issue: #1123--This change is based on #1127. Only the second commit ce35173 is to review in this PR.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1128 from sijie/make_ledger_manager_factory_interface;1329ec09f2024dc52d8b772e4ee70d9a9cdcfd0d
ISSUE #1103: Add channel TLS counters--(bug W-4482570)--Add counters to track-- active TLS-- active non-TLS channel connections-- failed TLS handshakes-- failed connections--Also,-Added tests to verify counters-Drain pendingOps on TLS handshake failure--Master Issue: #1103--Author: Kishore Udayashankar <kudayashankar@salesforce.com>-Author: kishorekasi <kkasiud1@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1106 from kishorekasi/tls-stats, closes #1103;fa10b7dcd89c40222ba5f30bb60f785bd21669b2
ISSUE #1139: Add debug to replication fencing--Descriptions of the changes in this PR:--When ledger is fenced, the client may get write error.-Not having enough logging in this area making debugging harder.-Optimised the code in addition to adding more logging in this area.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1139--Author: JV Jujjuri <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1140 from jvrao/bk-issue-1139, closes #1139;546eed4913e148a8a4f075ee412d1abe28398ffa
ISSUE #1162: Test for unsetSuccessAndSendWriteRequest with LedgerHandleAdv--Descriptions of the changes in this PR:--Add a test case to verify unsetSuccessAndSendWriteRequest with-LedgerHandleAdv out of order writers which forces ensemble change.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1162--Author: JV Jujjuri <vjujjuri@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1163 from jvrao/bk-issue-1162-test1, closes #1162;9f6c7da19eef89e248a4b2ffa82d9c2a08789270
Issue #1169 Upgrade Surefire plugin to 2.20.1--**Context**--We at Salesforce have been experiencing a series of hard to nail down test failures related to some of our changes causing Bookkeeper tests occasionally hanging up until they were terminated by Maven / Surefire. What's been making it harder to figure out was that the issue was only reproducing on Jenkins, not locally, and the lack of thread dumps along with Surefire failing to produce reports for these tests, making them next to invisible in Jenkins output.--**Related**--Issue #463 / PR #481 changes help terminate tests hanging in `Before` or `After` by changing `Test` based "local" timeouts to `Rule` based "global" ones.--**Proposed changes**--Upgrade Surefire plugin to 2.20.1 which has a few related [fixes and improvements since 2.19.1](https://issues.apache.org/jira/browse/SUREFIRE-1413?jql=project%20%3D%20SUREFIRE%20AND%20fixVersion%20in%20(2.20%2C%202.20.1)):-* [SUREFIRE-1322](https://issues.apache.org/jira/browse/SUREFIRE-1322) Surefire and Failsafe should dump critical errors in dump file and console-* [SUREFIRE-1435](https://issues.apache.org/jira/browse/SUREFIRE-1435) Improve Thread Dump-etc--(bug W-4700391)--Author: Pasha Kuznetsov <pkuznetsov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1170 from pasha-kuznetsov/issue-1169-surefire-2-20-1, closes #1169;7945fcf79652001f825ffade40a4215f68465403
Replace DoubleByteBuf with ByteBufList--This PR aims at a better approach to fix the issue reported in #1108--Instead of using `CompositeByteBuf` which has the downside of needing multiple object allocations per each usage (~7-8), we should have a way to aggregate multiple buffers into a single "logical" frame with no additional overhead.--This PR introduces a `ByteBufList` class which is just a holder of a list of buffers, without imitating the `ByteBuf` API. You can pass a `ByteBufList` to the channel and have the encoder take care of the multiple writes.--Instances of ByteBufList are ref-counted and released to a pool after the write is completed. There are no object allocations or memory copies involved.--Author: Matteo Merli <mmerli@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1141 from merlimat/bytebuf-list-master;df71247a8c9644bbeda7d18d833fde4bef88fb3d
Issue #1152: stats for durability violations in write/read path--Descriptions of the changes in this PR:--Durability contract demands that there are WQ copies spread-across fault zones as per the ensemble placement policy.-There are lots of areas where this contract is violated.--Add stats to track two areas that are well:-a. Write Path: if the write fails after satisfying AQ-b. Read Path: If the checksum error is detected on the read path--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1152--Author: JV Jujjuri <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1155 from jvrao/bk-ssue-1152-stats-1, closes #1152;5203d03930356a322f301e8e72a052ce1972adaa
ISSUE #966: Expose quorum write complete latency to the client--Add quorum write complete latency to the bookkeeper client API. This-allows callers to find out exactly how long the quorum write took for-diagnostic purposes.--(bug W-3616193)-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Fixed merge conflicts, added testing]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #970 from athanatos/forupstream/stats1/qlatency, closes #966;f17b422f2474e436ab7722dca16b778aa626f8ca
ISSUE #1075: Add a noop digest implentation--This digest will add a predefined digest key without actually computing-it. This can be used for testing or in situations/use-cases where digest-is considered overhead.--(bug W-3245776)-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Adapted to current patch]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1087 from athanatos/forupstream/misc/dummy, closes #1075;5aab8ae5ff4c06f8a471a8cab90b20e173776bf3
handle zookeeper session expire in zk ledger manager--Descriptions of the changes in this PR:--cherry-pick twitter/bookkeeperdfcda5cc2efdc03db99fe126499f8e3347f50484--This includes a test case to test `AbstractZkLedgerManager`, including--    1) create/delete/read/write ledger metadata-    2) register/unregister listeners-    3) handling various watched events--This also fixes a couple of cases in the `AbstractZkLedgerManager` what is caught with test case.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1130 from sijie/fix_session_expires;10812a46097d72e7d445675a9360b42aa7c46f8c
Call static methods and build callbacks in MavenClassLoader--To properly test some functionality we need to be able to call static-methods (e.g. for the creation of ByteBuf), and also to be able to-build callbacks (e.g. to call async methods).--This patch implements methods for doing this. For static methods, you-need to pass the className, the method name and a list of-arguments. It first tries to find the method using non-primitive-types, but falls back to trying primative types if possible.--Invokation looks like:-```-cl.callStaticMethod("org.apache.bookkeeper.client.BKException",-                    "create", [-101])-```--For callbacks you specify an interface and the a groovy closure.-It is assumed the closure will take as many arguments as the-callback. The invokation handler doesn't check the method name-called on the callback object, so it only works with callbacks-with a single method.--Invokation looks like:-```-def callback = classLoader.createCallback(-    "org.apache.bookkeeper.client.AsyncCallback\$AddCallback",-        { rc, _ledger, entryId, ctx ->-            // do something-        })-```--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1156 from ivankelly/mvn-cl-adv;353ca1ddf941a9502e3ecd8fcc383fccfcd91c6f
[MERGE YAHOO REPO] YBK-160: Doing distributed random verification of ledger fragments--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/280e39ee-https://github.com/yahoo/bookkeeper/commit/21c23ff1-https://github.com/yahoo/bookkeeper/commit/b1139ac9-YBK-160: Doing distributed random verification of ledger fragments-YBK-160: Addressing Review comments and fixing test-YBK-160: Doing verification only for stored entries--Author: Govind Menon <govindappumenon@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1085 from jiazhai/cherry_picks/i_230;25f42432321afa5357647110ff554aeee7858560
BP-29 (task 1) : Introduce `metadataServiceUrl`--Descriptions of the changes in this PR:--- introduce a new setting `metadataServiceUrl` for replacing implementation specific settings `zkServers` and `zkLedgersRootPath`.-- introduce a metadata driver interface for managing all the metadata interface-- introduce a metadata driver manager for resolving `metadataServiceUrl` and load specific metadata service url based on service scheme. This-  would replace configuring multiple different manager classes using one single `metadataServiceUrl`.--Please NOTE: this change only introduce the new classes, but it doesn't change the client and bookie to use the new setting. It will be done in-a subsequent change.--Master Issue: #1123--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1127 from sijie/introduce_service_uri;4d47418a5bfc186385a1adadeff55e7b8b19fbe3
Fix the travis config on building dlog module--Descriptions of the changes in this PR:--The original intention is building dlog module on 1) branches (non pull requests) 2) pull requests that modify dlog module. However the check logic was wrong in travis.yml. This change fixes the travis yml.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1154 from sijie/debug_travis;86d3f619f75e27397b05ccaa70a0bfd88169035d
BP-27 (part 1): New BookKeeper CLI Skeleton--Descriptions of the changes in this PR:--This is first implementation of BP-27 (#1000). This change includes:--- introduce a bookkeeper-tools module for keep the commands and also for developing the new CLI-- introduce 4 command groups: `cluster`, `bookie`, `client`, `metadata`.-- move 3 command: `listbookies` under `cluster` group, `lastmark` under `bookie` group, `simpletest` under `client` group.-- unit tests for those 3 command.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>, Yiming Zang <yzang2016@gmail.com>--This closes #1094 from sijie/bookie_shell_refactor;969e7292af5a1b4f26cc06c7cacd06b1746224f4
Install pulsar keys when installing yahoo custom image--The pulsar installation script for installing the yahoo custom version-was missing a line to import the keys needed to verify the tarball.--This patch adds the line, and also deletes the original version of the-script which was in the wrong location.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1158 from ivankelly/pulsar-script-again;41afe22e4f5eaec2cfbcdc0187df9fc5e1db7070
ISSUE #1109: Error out pending ops on TLS key mismatch exception--Descriptions of the changes in this PR:--(W-4479117)--- Add Testcase to test certificate mismatch scenario-- On tls handshake failure, replace future.get() with channel.-- Print a warning message on exception caught in a netty context-on connection close, drain pendingOps--rev charan--Master Issue: #1109--Author: Kishore Udayashankar <kudayashankar@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1110 from kishorekasi/tls-keymismatch, closes #1109;40c89198af603d94815711da40698399f8f16c75
Issue #1124: Lower memory usage in GarbageCollectionThread while extracting all ledger meta data--Descriptions of the changes in this PR:--The PR contains the fix to cleanup non-existent ledger log entries from EntryLogMetadata while extracting all log entries.--Master Issue: #1124--Author: Kishor Patil <kpatil@yahoo-inc.com>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1125 from kishorvpatil/gcThreadFix, closes #1124;28de2a8d626f43eda39af00e452e3c12c98c5cba
[MERGE YAHOO REPO] AsyncReadLastEntry should trigger callback with error when ledger is empty--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/9560ab0f-AsyncReadLastEntry should trigger callback with error when ledger is empty--Author: Jia Zhai <zhaijia@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1121 from jiazhai/cherry_picks/i_167;92866a49de755b4dc1e171e25d56ad25aaaa90d0
Fix auditor shutdown logic and move decommision tests out of BookKeeperAdminTest--Descriptions of the changes in this PR:--- the auditor shutdown logic is problematic. most of the tests can finish quickly however it spend more 30 seconds on shutting down.-  because the shutdown logic will be blocked until `awaitTermination` timed out.-- most of the tests in BookKeeperAdminTest don't need 6 bookies. so move the decommission tests to a separate class.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Jia Zhai <None>--This closes #1099 from sijie/improve_admin_tests;c43d8c49fe212a5253c2dfc27c3c3b8c018c697a
Run integration tests on precommit--Builds integration test docker images and runs all tests under tests/.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1148 from ivankelly/jenkins-bc2;5130f3b66b3235ffcc6e42c37a338ae853403d30
Add script missing from custom yahoo docker image--427eb81 references a script which I never added to the commit,-which means the image doesn't build.--This commit adds the script.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1151 from ivankelly/missing-script;4528248da8fd5b3b462afac8527098b6dd1032d0
Replace DoubleByteBuf with CompositeByteBuf because of perf regression with Netty > 4.1.12--Starting from Netty-4.1.13 some internal behavior has changed and that has introduced a performance penalty when using the `DoubleByteBuf`.--The problem resides in the fact that netty falls back to calling `nioBuffers()` and that is creating an array of unpooled direct `ByteBuffers`. That is pretty heavy and the JVM is taking 1 to 3 seconds GC pause to reclaim them.--Short term fix is to go back to `CompositeByteBuf` which doesn't have the problem (the `DirectByteBuffer` instances are pooled and reused). I have verified that GC is back to normal after this patch.--More mid-term, since `CompositeByteBuf` allocates a bunch of objects (counted ~10 per entry) I have a change to replace it with a `ByteBufList` holder class. I have the change almost done but it will take a while to test it to verify corner cases.--This should be considered for a 4.6.2 fix release.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1108 from merlimat/composite-byte-buf-master;1b8ad9cba38ba7ecbfbe3836c6db98a8b319e094
Upgrade arquillian-cube to latest version (0.15.1)--This gets rid of an ugly exception that the framework was throwing.-https://github.com/arquillian/arquillian-cube/issues/957--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1150 from ivankelly/arq-upgrade;fa620b78fa595ad2c0054e3cb6147b707b1276cb
Include yahoo custom version in all versions image--To ensure compatibility between versions during the merge, we need the-yahoo custom version of bookkeeper.--The most straightforward way to get this version is through-pulsar. It's distributed as part of the pulsar distribution, with-scripts to start it and all.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1146 from ivankelly/yahoo-in-image;427eb81a3d77f70db046b350f35dd4c5e68f9ac7
Integration smoke test--Most basic integration test we can have.-- Boots a cluster-- Writes a ledger-- Reads back the ledger-- Shutdown the cluster--If this test fails, something is very wrong.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1133 from ivankelly/smoke-test;204a671a5cd8dc9633a4a4be92b0724c59ce4ae4
Specify repo in MavenClassLoader--This is required for testing yahoo's custom bookkeeper client, as it-doesn't reside in maven central.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1135 from ivankelly/classloader-repo;8bd6f0270fdb36de3c7b7e0bf92eb48d39bdf52e
Gather disk information before CI build--I suspect that we are getting quite a few flakes because of over-full-disks in the CI workers. I'd like to confirm this hypothesis and-gather some information before taking corrective action.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1142 from ivankelly/df-on-build;aff98f2033da143a259396e9369e58f35c4dec63
Split all versions images into released and latest--The released tarballs rarely change, while the latest changes every-build. This patch splits the all version image into a base images with-the released tarballs, and a image which includes all released and the-very latest tarball.--This allows the released image to be cached/pushed to dockerhub, which-will in turn allow us to speed up our CI builds that use the all-version image.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1131 from ivankelly/image-split;7b3c79bcda4db92fc45fc40dfa3e9a96bf411011
Fix shutdown race which left ZK session open--There was a race when shutting down a bookie, where both the main-thread and the shutdown hook thread would try to close the bookie-service. This would result in them racing to set the lifecycle state-and neither would end up cleaning up properly. Specifically, the-starter latch would be counted down, so the main thread would start to-close, then the shutdown hook would run, try to close, and get an-exception when it tried to change the state. Once the all shutdown-hooks end, the process exits, even if main hasn't completed. This-leaves the zookeeper session open.--I've removed the close from main(). The shutdown hook always runs-on a graceful shutdown, so that's the place to do the cleanup.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1132 from ivankelly/shut-race;89eca5ce717a04c6e3ffa2b0aca615f4e38eafe3
Require green CI before merge--CI has been broken since the 2018-02-06, due to a non-green patch-being merged. With the recent flake fixes, CI should only go green if-there's a good reason. More over, any remaining problems will get-fixed faster, if people non-green builds start being a pain for-people.--So, this patch blocks merging with the merge script, if all checks are-not green. It can be overriden by adding a comment with the text-"Ignore CI" (case insensitive), on the PR.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Dave Rusek <dave.rusek@gmail.com>, Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1145 from ivankelly/require-green;21a89a7c486b842846ba9c15d6ec52d4486dd74c
Fix test regression due to change in default ledger manager--TestBenchmark#testReadThroughputLatency() regressed due to the change-in 3ddc5db, where the default ledger manager was changed from flat to-hierarchical.--The fix is to use flat for this test. I've also cleaned up the test a-little, and added some code to the benchmark to make the test run-faster.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1137 from ivankelly/bench-broke;eae32f6b667f0842897f4ca151cc7b7d31ef2e91
Issue-1143 Error on Java 9 using BookKeeperAdmin API and bookkeeper-server-shaded--Update Maven Shade Plugin to 3.1.0--Relates to issue #1143--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1144 from eolivelli/fix/update-shade-plugin;dcb22dddf5a7d97d7c320605facb142cc836c5fd
[MERGE YAHOO REPO] Only reorder read sequence if any bookie is not available--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/1ddd14a1-Only reorder read sequence if any bookie is not available--Author: Jia Zhai <zhaijia@apache.org>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1120 from jiazhai/cherry_picks/i_161;e2b93f28813556c1971a04c1ffe4b65cbe40c427
Remove spammy log messages in Journal--Looks like they were put in while debugging and not cleaned up.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1134 from ivankelly/spam-log;ccc4ed4989a0d3b1f55cec75556065f03de35d99
Entry count parameters for BenchBookie--So that they can be added in the test, to make the test run faster and-not timeout in CI and ruin an otherwise good test run.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1136 from ivankelly/bench-flake;062525cb70ff1c1f7cb53d8b197bc6be651deec7
BP-29: Metadata API module--Descriptions of the changes in this PR:--Related to BP-28 (#1113), this proposal is to propose how we want to organize the metadata modules, to support different metadata storage implementation.--Master Ticket: #1123--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1117 from sijie/BP-29-metadata-store-api;011bb652363b471e52e082cd9a13ff6a31375525
Fix compilation warnings (#39);fce92affe3a2ced4a180f905656b42f8de4c0c99
Consolidate the protobuf definition used in state store and in client/service (#38)--state store and client/service were started as two different projects, and were doing in parallel. so there are some duplication and overlaps on defining the k/v operations.--now these two projects were put together, it would be good to consolidate the protobuf definition to have it only exist in one place.;e92bcec2a71eed2aee9cfb6df3cc7b67bb079414
Use BookieServer#getLocalAddress() in BookieClientTest--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #1119 from sijie/fix_bookie_client_test;3d81d3527126398f1a80003d13ef2dedc00ad9fd
Use the kv api defined in client for statelib (#37)--* Consolidate statelib to use kv api----* Add ToString;c754c8d7cc59947816d5ce8c7b458ae83652bc8b
Travis CI should not use a hardcoded release version for check-release script--Descriptions of the changes in this PR:--CI is going to be broken when we bumped to 4.8.0.  since travis CI is using a hardcoded version for check-release script.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1118 from sijie/fix_check_release_script;46340f9b1fa3eb59abdf502107e46af7b36d4a44
Cleanup registration client interface--Descriptions of the changes in this PR:--This change is mainly to remove `zookeeper` reference from metadata interface. The existence of `Optional<ZooKeeper>` is to allow passing an external zookeeper client to bookkeeper, so bookkeeper can reuse that client instance. That is useful for services like pulsar broker, which they can only instantiate a zookeeper client and pass the zookeeper client around to construct bookkeeper client. However, this pollutes the registration client interface, change the method to `Optional<Object>` as an optional context object and let the implementation interpret it.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1116 from sijie/clean_registration_client_interface;12869703b90a98a62e4c7692e289ea2ae73cf4b1
Change default ledger manager factory from `Flat` to `Hierachical`--Descriptions of the changes in this PR:--the discussion can be found at : http://mail-archives.apache.org/mod_mbox/bookkeeper-dev/201802.mbox/%3CCAO2yDyYdZ8%3D4tViNX1uL0Z67KX78JPD2XBGd7ermjO%3DK%3DscvcQ%40mail.gmail.com%3E--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #1115 from sijie/flip_default_ledger_manager;3ddc5db190b049f181ce7ae29ca34cbc7a7b7eb3
Update PR template--Descriptions of the changes in this PR:--- JIRA is not used anymore. Remove it from PR template.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1111 from sijie/update_pr_template;65953ca2a93b95101071171598edfa1316b24834
Update release schedule--Descriptions of the changes in this PR:--- update current feature release to 4.7.0 and its release window-- add a section in release guide for instructions to update release schedule--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1112 from sijie/update_release_schedule;4107804e1fda6f1314dff64a74a7133ff1ec64e5
Revamped downloads page--This PR addresses issue #1090 and significantly revamps the downloads page to bring it in line with Apache standards. It also makes some changes to the website's general setup and build process to make that process less brittle.--Author: Luc Perkins <lucperkins@gmail.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1104 from lucperkins/lperkins/asf-compliance;908972c73be2743b3aaa369a6d97fff8e46295f8
Use loopback network interface for testcases.--Descriptions of the changes in this PR:--- tests would be more reliable irrespective of the environment (and availability of network connection), if the loopback address is used in testsuites.-- unless loopback address is set explicitly, in my env (while on company's VPN),-UpdateCookieCmdTest is failing most of the times.-- currently allowLoopback is set to true in BookKeeperClusterTestCase,-but it doesn't make Bookies to use loopback interface address.-- loopback network interface should be set explicitly as-listening interface to use loopback address.--Note:--1) will create Issue for this depending on the PR feedback.-2) in other places (where setAllowLoopback is set) also loopback interface needs to be set--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Samuel Just <sjust@salesforce.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1097 from reddycharan/loopbackaddress;ee2f419b77564cca2bfbf8efed2b0f4c4615d542
BP-26 (task 4): run dlog tests when pull requests modify dlog modules--Descriptions of the changes in this PR:--- enable dlog tests on all post commit CI jobs-- for pull requests, only run dlog tests on travis CI and only when the pull requests modify dlog modules.--Master Issue: #1024--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Jia Zhai <None>--This closes #1096 from sijie/enable_dlog_ci;bb3ae067a34e017098bf43011982a335b2768b90
BP-26 (task 3) : Build dlog shaded jar in bookkeeper way--Descriptions of the changes in this PR:--- discard dlog shaded artifacts and build `distributedlog-core-shaded` jar similar as `bookkeeper-server-shaded`-- discard bookkeeper-server shaded artifact-- move all shaded related tests to `tests/shaded`--Master Issue: #1024--Author: Sijie Guo <sijie@apache.org>--Reviewers: Dave Rusek <dave.rusek@gmail.com>, Jia Zhai <None>, Yiming Zang <yzang2016@gmail.com>--This closes #1095 from sijie/dlog_shade_jar;0fbe8b767eaeb1c2d5d90946b3620a4e853a7284
ISSUE #1067: PendingReadOp: recovery, return NoSuchEntry on wQ-aQ+1 errors--In the case of a recovery read, we rely on a NoSuchEntry response on the-first missing entry to determine the final LAC.  As such, we need to-consider an entry to be gone once we see wQ-aQ+1 NoSuchEntry/Ledger-responses from bookies.  Otherwise, a zombie bookie can prevent ledger-recovery from suceeding indefinitely (it'll hit the timeout each time).--There was some preexisting logic from-https://issues.apache.org/jira/browse/BOOKKEEPER-365-b6c1a8bbd7c2d44c2edb59d9938fa073f6f478de,-but it seems to have been too conservative in that it waited for all-responses and required that there were no other errors present.  It-seems now to be unnecessary, and so has been removed.--TestParallelRead.testFailParallelReadMissingEntryImmediately seemed to-rely on the previous logic working outside of recovery, but I believe it-was really meant to test the recovery case, so it has been adjusted.--(bug W-4651456)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Samuel Just <sjust@salesforce.com>, Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1077 from athanatos/forupstream/wip-4651456-recovery-read, closes #1067;e6a2a13876fe676b8fcafa56c3568ea450ad5f67
ISSUE #1063: Write keeps refCnt longer--Descriptions of the changes in this PR:--Current code keeps the toSend buffers until client receives-resonses from all wq bookies. From the senders perspective,-It is not required to keep the refcount on it at the PendingAddOp-level, as the ref is taken at bookie client level.--Keeping these buffers longer will increase the memory pressure-on the client.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Master Issue: #1091--Author: JV Jujjuri <vjujjuri@vjujjuri-ltm2.internal.salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1091 from jvrao/bookkeeper-1063, closes #1063;9d09a9c2a64b745271ef1c6dad9e5ab3ab3f2a5c
BP-27: New BookKeeper CLI--Descriptions of the changes in this PR:--`BookieShell` is the current bookkeeper cli for interacting and operating a bookkeeper cluster. However, this class is getting bigger with more commands added to it. It is facing a few problems for maintenance and extensibility.--- All commands sit in one gaint shell class. It is hard to tell if a command is used for managing a bookie only or if a command is used for managing a cluster.-- Lack of unit tests. This class has very few test coverage. Most of the commands (introduced in early days) don't have a unit test.-- Lack of extensibility. If a new function component (for example, dlog) is introduced, it is a bit hard to extend this CLI to have commands for new function component.--All these problems lead to the proposal here. This proposal is to propose refactoring/redesigning the bookkeeper CLI to allow better managebility for maintenance, better test coverage and better extensibility for new function components.--Master Issue: #1000--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>--This closes #1093 from sijie/BP_27_new_bookkeeper_cli;49b011b3ba4d71482bb50be72f69b505c697aad4
Run checkstyle plugin at validate phase--Descriptions of the changes in this PR:--Most of the modules run checkstyle plugin at validate phase. However a few modules are still running at `test-compile` phase.-Update the checkstyle plugins in those modules to run at validate phase. So the behavior is consistent across the project.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #1098 from sijie/run_checkstyle_at_validate_phase;f83efd4fe6a4a32ffbccb49d1905d50e8013f15b
Issue #605: bk_server.conf wrong default logSizeLimit--It's commented out, but the value is invalid. This patch changes it to-match the default in ServerConfiguration.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1105 from ivankelly/entry-log-size, closes #605;67e818a97bac9204699af8474f42159056d407b9
BP-14 Implementation of WriteFlag.DEFERRED_SYNC on Journal--Implement WriteFlags.DERERRED_SYNC on Bookie side.-In case of DEFERRED_SYNC write Journal will early acknowledge the write, just after flushing the buffer to the OS cache, but before waiting for an fsync.--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #889 from eolivelli/bp14-writeflags-journal;a226dbedff03102291648df3a60e78a2c85ae65f
Dont log ledgermetadata which contains password.--Descriptions of the changes in this PR:--Dont log ledgermetadata contains password used to create-the ledger. Logs are not supposed to reveal such sensitive info.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1092 from reddycharan/fixpasswordlog;67018bd4b1e006f4d957a1f70a1c0e01b9ebb70b
BP-26 (task-2): make distributedlog modules be able to be built in bookkeeper repo--Descriptions of the changes in this PR:--This is the second sub-task of #1024. This change is based on [BP-26/distributedlog_merge](https://github.com/apache/bookkeeper/tree/BP-26/distributedlog_merge) branch (created at #1068).--This change includes:--- move the findbugs.xml and checkstyle/suppression.xml from distributedlog-build-tools to bookkeeper buildtools module.-- mockito: dlog is using mockito 1 while bk is using mockito 2. this change make dlog modules use the mockito dependencies defined at root pom.xml.-- change the description from "Apache DistributedLog" to "Apache BookKeeper :: DistributedLog".-- change the versions from `0.6.0-SNAPSHOT` to `4.7.0-SNAPSHOT`.-- fix the compilation issues with current latest bk--This PR *DOESNT* change the group id of distributedlog modules. They will remain using "org.apache.distributedlog" as the group id.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Yiming Zang <yzang2016@gmail.com>--This closes #1069 from sijie/compile_distributedlog;5cd311c7bd72273e116533d0c438254b881dd653
ISSUE #611: restrict max ensemble change numbers--Descriptions of the changes in this PR:--Add max ensemble change number check--Master Issue: #611--Author: Arvin <arvindevel@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #925 from ArvinDevel/restrict_ensemble_num, closes #611;125cda66931f344a071167b9dd8e21d18fabb79a
[MERGE YAHOO REPO] Support DbLedgerStorage in LedgerCmd to get list of logger files for a given ledgerId--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/384414b6-Support DbLedgerStorage in LedgerCmd to get list of logger files for a given ledgerId--Author: Jia Zhai <zhaijia@apache.org>-Author: Rajan <dhabalia.me@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1057 from jiazhai/cherry_picks/i_209;5ed8768d9ab267111cf2eafcfd0b570b9ab9646c
ZkUtils.asyncDeleteFullPathOptimistic: pass -1 as znodeVersion to parents--znodeVersion for the child won't necessarily match the parents.  This-isn't really meaningful to test since the version of the internal nodes-for all current users will be 0, but fixing it at least will reduce-confusion--Signed-off-by: Charan Reddy Guttapalem <cguttapalemsalesforce.com>-[Adapted to current patch]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #1073 from athanatos/forupstream/misc/zkutilsfullpath;02d6f1d52484f7d8d1b613f4956193d1ed5b4477
Merge branch 'master' into BP-26/distributedlog_merge;a7f3f20024c17f9c99de68952ec1f1d79adedb7a
Merge remote-tracking branch 'apache/master' into copy_distributedlog;937de490b8e2df9ea0e247f15b481015afa21c54
 Remove `type` from StorageContainerRequest (#36);7ebf12b9d7a49d6a9b27dcd5d094516a1d4d0309
Increase job timeout to 200 mins--Descriptions of the changes in this PR:--the postcommit jobs have been timedout for a few days. This change is to increase the build timeout to get all jenkins job enough time to complete.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1089 from sijie/increase_job_timeout;8a25353ac7354cab2c29ef83d40993c6176ac7a4
Lombok doesn't work with groovy--So the Cleanup annotation does nothing. I've changed it in the BC-test to a traditional try {} finally {} since groovy doesn't do-try-with-resources either, and its equivalent doesn't do multiple-objects.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1084 from ivankelly/lombok-dont-work;a7fcf36ccf7485e8d169776950102c8a31a513f8
Test that old clients work with current server--Test that old clients(4.2.0 onwards) can create, open, read, write ledgers on-the latest version of the server.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1083 from ivankelly/new-server-old-client;422620e29b0d5b6d17dfb8e22afa78d57f26c68c
ISSUE #1079: use CachingStatsProvider underly FinagleStatsProvider--Descriptions of the changes in this PR:-use CachingStatsProvider underly FinagleStatsProvider to avoid creating a lot of brand new object--Master Issue: #1079--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1082 from jiazhai/issue-1079, closes #1079;c2d53a4c1781360a4fb5635e91f7fe133475c160
ISSUE #1078: use CachingStatsProvider underly PrometheusMetricsProvider--Descriptions of the changes in this PR:-- add CachingStatsProvider to wrapper PrometheusMetricsProvider;-- add test verify the cache.--Master Issue: #1078--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1081 from jiazhai/issue-1078, closes #1078;d5dffc48a4eda6178bd25610097f2e49763f2377
Fixing validation in BookieShell.scanEntryLogForSpecificEntry--Descriptions of the changes in this PR:--https://github.com/apache/bookkeeper/commit/086537beda9427c057a286ad6c4614659da6ed7f-has messed up conditional checks in BookieShell.scanEntryLogForSpecificEntry.-Reverting those changes.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1076 from reddycharan/fixScanEntryLogForSpecificEntry;47854b9234f612b2080decd4720cf3d1772f8455
URLDecode key/cert paths in TestTLS--In TestTLS we load keys/certs from the classpath, which means we get-the filename as a URL. Since it is a URL it is URL encoded for special-characters. Usually this is not an issue, but in the case that there-are special characters in the path, these will be encoded, and then-when we try to open the file we get a FileNotFoundException. This-occurs on jenkins, when there are two parallel builds on the same-job (it adds a N to the workspace name), and was causing all TLS-tests to fail in that case.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1074 from ivankelly/tls-fix;1ea725d1755995a004f191b24bc6742e100a7899
[MERGE YAHOO REPO] YBK-154: Add sleep after finding free port given OS time to release it--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/40196007-YBK-154: Addign sleep after finding free port so the OS has time to release it--Author: Robert Evans <evans@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1055 from jiazhai/cherry_picks/ii_205;f6af755fd7f5f53b3b5b743bf4f314bcfa8cc89a
ISSUE #934: Additional stats to track netty latencies in PCBC--Descriptions of the changes in this PR:--(bug W-4058645) add metrics to measure netty stack latency-- Counters to track outstanding reads/writes operations-- Collect Netty IO rate and latency histograms--rev ayegorov--PerChannelBookieClient: add additional stats--Adds:-- exceptionCounter-- connectTimer-- addEntryOutstanding-- readEntryOutstanding-- nettyOpLogger--Signed-off-by: Kishore Kasi Udayashankar<kudayashankarsalesforce.com>--Master Issue: #934--Author: Kishore Udayashankar <kudayashankar@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #971 from kishorekasi/pcbc-stats, closes #934;f3166dde6f0429be121110ee534a5574d136248a
Add release date for 4.6.1 to the website--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1080 from eolivelli/update-website-4.6.1;36350c2bfaa6073991cf045486e618abdc32e28f
Release notes for 4.6.1--Author: eolivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #980 from eolivelli/releasenotes461;1b3108a5fd480ef9cba092c9eb0a06ed452e402e
Cleanup unused protobuf definitions (#22);d923c89e6596fcf8e2c7af3f2a4f51f1b418d4c9
Remove OrderedBy annotation (#21);e62445f378575e42f02b1c721663be8995d631c3
Cleanup classloaders in backward-compat tests--The BC tests run in the maven process (for classloader reasons), so we-need to make sure we clean stuff up to avoid running out of memory, as-the classloaders will load a bunch of jars into memory.--Master Issue: #1030--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1070 from ivankelly/cleanup-cl;c8a3c25557ef4e4fc2cfb4a823f5ca5a9e224f11
Format the indent to 4 spaces (to align with bookkeeper coding style);e4a0798c1e6412f58fccabdd956151d81e16bd46
repackage under `org.apache.bookkeeper`;5d749d7b8cb152e2b004e50c2a8e8c4c3e09903f
remove "distributedlog_" from module names;d6f4aa080b4d0586edbdae4a55bb8816471dafc8
ISSUE #1049: Add PERMITTED_STARTUP_USERS to limit bookie startup users--Starting the bookie as the wrong user (such as root) can cause problems-as the on disk files may end up with the wrong permissions.  Add-PERMITTED_STARTUP_USERS to protect against this kind of operational-error.--(bug W-3599751)-Signed-off-by: Dustin Castor <dcastorsalesforce.com>-[Adapted to current code]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1065 from athanatos/forupstream/permitted-startup-users, closes #1049;8cc967c9e8dee2e9225075b4c615307389df0057
Move backward compat tests into their own java package--Master Issue: #1030--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1064 from ivankelly/bc-java-package;61b6a5f00abf0633f5e2310bcc81ccf2f2e188d4
ISSUE #933: Add support for PEM Key file formats--(bug W-4203319) TLS authentication to support PEM format X.509-certificates along with JKS and PKCS12 formats.--Added another KeyStore Type to the list of formats (JKS, PKCS12)-currently supported during SSLContext creation.--rev ayegorov--Signed-off-by: Kishore Kasi Udayashankar <kudayashankarsalesforce.com>--Descriptions of the changes in this PR:--(PR description content here)...--Master Issue: #933--Author: Kishore Udayashankar <kudayashankar@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #965 from kishorekasi/tls-pem, closes #933;76c1fd0d8ad1358fc8799d66b6ec7f242fd2ba71
Merge branch 'master' of /Users/sijie/Workspaces/bookkeeper/../distributedlog_merge into copy_distributedlog;9f016a055782ac7dccb2371909588543730d0e6b
Move distributedlog-io module;d9f3961b4fbc41bc9d5074ec0f1866ccadc183bf
Merge branch 'master' of /Users/sijie/Workspaces/bookkeeper/../distributedlog_merge into copy_distributedlog;7d4ee6c1465a45131cdb816f29b4385060552ef0
Move distributedlog-core module;57da05e53916b5d4ef04feb8e7469acc40fb77fe
Merge branch 'master' of /Users/sijie/Workspaces/bookkeeper/../distributedlog_merge into copy_distributedlog;f6fcf82d5606eef77450854a3f6fe2343b343481
Move distributedlog-protocol module;f74b328e2da5bf485c7d91f1d8434ac753c5007c
Merge branch 'master' of /Users/sijie/Workspaces/bookkeeper/../distributedlog_merge into copy_distributedlog;0459390ec483f8080a5c74ce3586fb1b61578be0
Move distributedlog-common module;fdf74acfcbbc0c6198b1f5b10128cada079fc5b4
BP-26: Move the development of distributedlog library to bookkeeper--Descriptions of the changes in this PR:--This is a BP proposing moving the development of distributedlog library to bookkeeper. See details in the BP file.--Master Issue: #1024--Author: Sijie Guo <sijie@apache.org>--Reviewers: Henry Saputra <hsaputra@apache.org>, Matteo Merli <mmerli@apache.org>, Dave Rusek <dave.rusek@gmail.com>, Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>, Yiming Zang <yzang2016@gmail.com>--This closes #1025 from sijie/bp_move_distributedlog;d06fad25d82a504bc46c906b5c23b5634567d543
[MERGE YAHOO REPO] Fix bookie-shell readJournal by reading from correct journal-directory--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original change is:-https://github.com/yahoo/bookkeeper/commit/c426efea-Fix bookie-shell readJournal by reading from correct journal-directory--Author: rdhabalia <rdhabalia@yahoo-inc.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1056 from jiazhai/cherry_picks/i_207;92b5ef5d70594f9d6a76fc2c34e62925248f7327
[MERGE YAHOO REPO] Flush after writing out index--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original commit is:-https://github.com/yahoo/bookkeeper/commit/fecdb751-YBK-14: Flush after writing out index--Author: Jia Zhai <zhaijia@apache.org>-Author: Robert (Bobby) Evans <evans@yahoo-inc.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #1060 from jiazhai/cherry_picks/i_177;b38cd67a042aae0cac32aef69e814d7ade31bf03
[MERGE YAHOO REPO] Release addEntry-Bytebuf on readOnlyBookie to prevent memory-leak--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original commit is:-https://github.com/yahoo/bookkeeper/commit/42bdc083-Release addEntry-Bytebuf on readOnlyBookie to prevent memory-leak--Author: rdhabalia <rdhabalia@yahoo-inc.com>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #1059 from jiazhai/cherry_picks/i_173;ffbe842d11ddd4e64ee79a3b6f86183be942cfc4
[MERGE YAHOO REPO] Fixed NPE when accessing readonly bookie list--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original commit is:-https://github.com/yahoo/bookkeeper/commit/270b69e4-Fixed NPE when accessing readonly bookie list--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #1058 from jiazhai/cherry_picks/i_165;01430750ce5a2f7c46cce942a7aa6116e41b9508
[MERGE YAHOO REPO] CMS-2060: Catch IndexOutOfBoundsException when reading entry log index map--Descriptions of the changes in this PR:-This is cherry-pick from yahoo repo of branch yahoo-4.3.--original commit is:-https://github.com/yahoo/bookkeeper/commit/2b7aacc5-CMS-2060: Catch IndexOutOfBoundsException when reading entry log index map--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1061 from jiazhai/cherry_picks/i_164;43a896a08dae2a3a273d02e4c1ed81516ab00c85
Enable rerunning flakes twice--Enables a configuration in maven to rerun failed tests a second time.--Master issue: #1031--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1062 from ivankelly/retry-flake;89cf23d52c7876230df4e84a818f8f848a7a7c19
Move backward compat tests under a parent module--To avoid having to many modules directly in tests/, this patch moves-backward compat tests under their own parent module,-tests/backward-compat.--Master Issue: #1030--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1054 from ivankelly/move-dir;8e499793195ed36bf71dd23d6ca8696c2e56b17b
Remove old compat stuff--As compat tests are now docker based, the shading stuff is no longer-needed.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1052 from ivankelly/remove-old-bc;5ad6527c3cba4fb2ad2eb0715e9915b5fb939b8d
Use github repo as a temp location for deploying artifacts (#20);80530b3c786225f1567bba1beaf65e350845b582
Servers formatted without instance id can't join a cluster with insta…--Test that old client can continue to work with servers which are using their-hostname as their bookie id.--This replaces TestBackwardCompat#testCompatWrites and TestBackwardCompat#testCompatReads-from the old BC tests.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1034 from ivankelly/bc-cookie;38f9295c3e1ab2047a82a5181d7f8d5286d4297b
Provide a standalone cluster and a storage cli to interact with it (#19);cab8fd365b53fa5a7ae8a35b6c98abdf4e52f371
New testcases for ZKClient--Descriptions of the changes in this PR:--- new testcases for ZKClient to improve code coverage.--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1051 from reddycharan/zkclienttests;97d72fcf4129d1a31770834e9f6f1e641a9c23f3
Enhance exception logging.--Descriptions of the changes in this PR:--- log exception in the case of exception in Bookie.shutdown-and BookKeeperClusterTestCase.tearDown.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1050 from reddycharan/logexception;07ec9d897255d07f772a084561fb0e17e0f0bc7a
ISSUE #1014: LedgerManager.asyncProcessLedgers bug fixes--Descriptions of the changes in this PR:--- fix for Bug 2 of 1014. Fixing race condition with node removal in 'asyncProcessLedgers'- and making it robust to concurrent modifications like deletions of ledgers.-- fix for Bug 1 of 1014, is already made as part of Issue #978 (decouple metaformat cmd)- feature.-- testcases to validate the fixes.--Master Issue: #1014--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1048 from reddycharan/asyncprocessfix, closes #1014;60ff22670f885058ebedb19c19ff40856e74b53c
Mark BP-20/BP-25 as adopted--Descriptions of the changes in this PR:--BP-20 is adopted in #760  #761-BP-25 is adopted in #1007 #1008--This closes #760 #761 #1007 #1008--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #1047 from sijie/close_bp_25;4a4276fd44a3fd58b2b94e30ac9c4a11bc838d3e
 Support Increment (part 3): fix integration test;eba314291a21a05a862ccb4060da79b66cebc3b6
Support Increment (part 2): provide increment op support in storage container, server and client;9935bb0a5624b4d820601c9826263d80e9500051
Support Increment (part 1): provide increment op support in local state store.;1e1aa52419558cc6584c82e2ccf06b0828304d1a
Table -> Stream (part 4): storage server supports serving readonly table--a `readonly` table is only tailing updates from log streams and applying updates to table ranges.-this allows applications to mutate tables using table writer.;3d9b08d475af825bcc4d2691378c39b5541846a9
ISSUE #1007: move checksum to proto--Descriptions of the changes in this PR:--Refactor checksum to proto-Master Issue: #<1007>--Author: Arvin <arvindevel@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1018 from ArvinDevel/issue1007, closes #1007;a764c7f3336d2acb6b15e1b0197b0dc4cff7e5b1
BP-25: MovingChecksumToProto--Refactor the checksum part of bookkeeper--Descriptions of the changes in this PR:--Current the checksum implementation is in client module while the checksum semantic is more close to protocol. Moreover, moving the checksum implementation to protocol will avoid server module's dependency to client module when doing checksum in server side.--Master Issue: #1007--Author: Arvin <arvindevel@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri <vjujjuri@salesforce.com>--This closes #1008 from ArvinDevel/BP_25_MovingChecksumToProto;a512b737160e7d52ed46964018c51302b2408967
Test compat with useHostNameAsBookieID--Test that old client can continue to work with servers which are using their-hostname as their bookie id.--This replaces TestBackwardCompat#testCompatWrites and TestBackwardCompat#testCompatReads-from the old BC tests.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1033 from ivankelly/bc-hostname;305efca865f1cc8d6c89f6e6a53669e0b1265948
BookKeeperClusterTestCase,UpdateLedgerOpTest: remove call to setAllow…--(bug W-2962634)-Signed-off-by: Andrey Yegorov <ayegorovsalesforce.com>-[Ported to master]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1037 from athanatos/forupstream/tests/setallowloopback;c0cd03031c7decf29276e286904c431b2be75fab
AuditorLedgerCheckerTest: wait for ro transition to make more reliable--(bug W-2999244)-Signed-off-by: Andrey Yegorov <ayegorovsalesforce.com>-[Reworked for master]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1038 from athanatos/forupstream/tests/bookietransition;38a3885a363971635fc2e45ec48d3331a16b8c63
ISSUE #1039: BKClient tests with BookieErrors--Descriptions of the changes in this PR:--- end-to-end tests for validating BKClient readEntry-calls incase of combination of bookie timeouts and-data corruption--Master Issue: #1039--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>-Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1040 from reddycharan/bookkeeperclienttests, closes #1039;381248d64d878b1e970e4842598646c054d7a989
CompactionTest: call storage.shutdown() prior to recreating--(bug W-2962634)-Signed-off-by: Andrey Yegorov <ayegorovsalesforce.com>-[Ported to master]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1036 from athanatos/forupstream/tests/compaction;9b36898dbdfed3fa95a00407d29413a5f8466c04
ISSUE #1041: Adding new testcases--Descriptions of the changes in this PR:--- New Testclass for ZeroBuffer-- New testcases for missing testcoverage in-SortedLedgerStorage, EntryMemTable and LedgerHandleAdv--Master Issue: #1041--Author: cguttapalem <cguttapalem@salesforce.com>-Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1042 from reddycharan/missingtestcases, closes #1041;0ffac5ac9f7c573eab93a43dae86c1a78e1b61de
AuditorPeriodicCheckTest: add test for entries with failed bookie writes--Validate that the auditor's periodic check will detect entries-with failed bookie writes and repair them.--Signed-off-by: Rithin <rithin.shettysalesforce.com>-(bug W-3311952)(bug W-3311965)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1044 from athanatos/forupstream/tests/failedwrites;91dcbce5f0d686f013efab3b76b42962a4546f86
More testcases for LedgerHandle--Descriptions of the changes in this PR:--- New testcases for missing testcoverage in-LedgerHandle and ReadOnlyLedgerHandle--Author: Charan Reddy Guttapalem <cguttapalem@cguttapale-ltm1.internal.salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1045 from reddycharan/ledgerhandlemissingtests;2f3d5e9acd75cbeb9b8c0cc543901b3d017eac7c
ISSUE #978: decouple metaformat cmd--Descriptions of the changes in this PR:--- introduce new commands - initnewcluster, nukeexistingcluster, whatisinstanceid-- add testcases initnewcluster and nukeexistingcluster at BookKeeperAdmin level--Master Issue: #978--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #979 from reddycharan/splitmetaformat, closes #978;51b93bad7622878b1f2f3246c9880851731e84af
Ledgers without masterkey in metadata can't be recovered--Test that ledgers, created without a master key in the metadata, cannot be recovered until-the master key is known.--Replaces TestBookieRecovery from the old tests.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1035 from ivankelly/bc-recovery;519743e51cdc40c3e3ddbfabd83640fc30838a10
Table -> Stream (part 3): Implement dlog based table writer;81c8ed3cb61726f521df482590d2cd48068dff7d
Table -> Stream (part 2): Introduce `defaultBackendUri` in stream configuration--`defaultBackendUri` points to the service that is used for storing the logs for ranges.;16fb26bfc87035d4efda2d75ff42f3a0350e18ea
Table -> Stream (part 1): add table writer for appending events to stream;716684a3f68e47aa50becbd4c51cf252425a1990
Add Table api and its implementation (#18);74185c398ff2bbffde65ae9dc587bfd89ee78c73
Add some simplified kv methods in PTable (#17);caa97bd8968a1d0d19d8cf04822f42c2ab3c20cb
Enable txn on both server side and client side (#16);7464dcca833a9fa7861c6f202cb2f672abd4bb86
Improve the client api to a type-safe api (#15);ef6f8719fe697458e50f8c9cf07c1ec07427acb9
ISSUE #1026: initbookie cmd--Descriptions of the changes in this PR:--- adding a new BookieShell command - "initbookie" command to decouple from-bookieformat. This command initializes bookie, by making sure that the-journalDirs, ledgerDirs and indexDirs are empty and there is no-registered Bookie with this BookieId.--Master Issue: #1027--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1027 from reddycharan/initbookiecmd, closes #1026;1d7a489afb8fee8754b2da1d45745a47542eeca7
Test compatibility between old hierarchical ledger manager and current--Ensures that the current client and server can handle ledgers created by the-hierarchical ledger manager from 4.2.0.--Replaces TestBackwardCompat#testCompatHierarchicalLedgerManager from old tests--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #1029 from ivankelly/bc-heir;f5b7e08d8ba35b7173c6c9fed4221d086cd38fdb
Test upgrade from old server version to new version--This patch contains two tests.-- Upgrade between all released version, up to latest version-- Upgrade direct from 4.1.0 to latest version--In all cases the old client should continue to work with the new version.-In one case(4.2->4.3), we broken client compatibility so the the new client-stops working with the old server.--These tests replace and expand on the testing done by-TestBackwardCompat#testCompat410 with the old BC tests.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1028 from ivankelly/compat401;af6de4871cfa398eb3a95d4700a804455e0bf701
Allow groovy tests to compile on java 9--Older versions of the compiler cannot handle java9 modules.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1032 from ivankelly/groovy-j9;b212e85ccbf6eb8b08d776cce9147f4708c7a153
Only run integration tests with -DintegrationTests--Integration tests have a higher system requirement than normal unit-tests, and take longer to run, so they should be explicitly enabled.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1022 from ivankelly/integ-flag;11b278e202416a3893063e64e3a4579b360d2b5b
Arquillian topologies module--Will allow topologies to be shared among modules, which is important-as arquillian builds and pulls down the containers on a per-module/suite basis.--Currently contains a single topology, which is 3 BK nodes and 1 ZK-nodes. The BK nodes contain all released versions, with no version-started by default.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1023 from ivankelly/topologies;2edd68f5a55168a26b96b8ad993303d5a0be4757
Fixups for broken versions in all versions images--Various versions of bookkeeper have shipped broken by default. This-patch fixes them up in the all versions image, so that they can be-tested.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1021 from ivankelly/broken-versions;55313600735f0ea562fdab5d59671a823f5ce366
Utilities for bookies running in test containers--The changes include:-- Updating configuration in bk_server.conf for one or all bookies-- Run commands on all or one bookie-- Wait for all bookies in the test are up--There are also improvements to DockerUtils#runCommand:-- Better logging-- Catches RunTime exceptions, as Docker-java throws them and it could-  fail the test-- Throw an exception is the command exits with anything but 0--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1020 from ivankelly/bookie-util;6dda0a6c68fbaf2ca198cfbb693db4ac93a0feef
Base modules for integration testing--Integration tests should all specify either of this modules as their-parent.--integration-tests-base is for pure java integration tests.-integration-tests-base-groovy is for groovy integration tests, suchs-as BC testing.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #976 from ivankelly/integ-base-mod;95577675dd908855b6dba4dbe486d49d37dff1f0
[MERGE YAHOO REPO] CMS-1599: make sure we always release the underreplicated lock--Descriptions of the changes in this PR:--CMS-1599: make sure we always release the underreplicated lock--Here is original commit:-https://github.com/yahoo/bookkeeper/commit/850122ed--Author: Siddharth Boobna <sboobna@yahoo-inc.com>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #1010 from jiazhai/cherry_picks/i_120;45e4c5e1c26284635e1eeac392cd896392e2084e
proto/*Processor: clean up logging, include exception stack--For WriteEntryProcessorV3, log fence exception at error in order to help-with debugging the cause of a fenced ledger.--(bug W-3299246)-(bug W-3158835)-Signed-off-by: Andrey Yegorov <ayegorovsalesforce.com>-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Minor formatting fixes]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1016 from athanatos/forupstream/logs1/processors;71fa42a2019cafe15430544deeb351d87c253f8c
ZkRegistrationManager: add log line with root path for prepareFormat--Useful for auditability.--(bug W-4026563)-Signed-off-by: Zhimeng Shi <zshisalesforce.com>-[Updated for current patch]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #1015 from athanatos/forupstream/logs1/format;1e63756bde3a64ce787275fb645297d7d3f79954
[MERGE YAHOO REPO] CMS-1487: Provide tool to read entries from a particular bookie--Descriptions of the changes in this PR:--CMS-1487: Provide tool to read entries from a particular bookie.-Here is original commit:-https://github.com/yahoo/bookkeeper/commit/1a884b02--Author: Jia Zhai <zhaijia@apache.org>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #1009 from jiazhai/cherry_picks/i_115;4487f7447ab90a8a1b80cacb5f77c8f6760bb056
ISSUE #985: Add log messages to indicate bucket levels of entryLog.--(bug W-3333413)-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Fixed merge issues]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #997 from athanatos/forupstream/logs1/compaction, closes #985;0c9e88be25d3a37300cffc518d25a79a49456d24
Add an integrate test case on testing end-to-end kv store (#14);9f901bcb04561d2dac5eff7fbd6fc39b74feedfc
Increase page size for fetching github labels--Descriptions of the changes in this PR:--*Problem*--The default page size for github api is 30 items. The number of labels at bookkeeper are more than 30 items, so `type/task` is not showing up at merge script.--*Solution*--This change is to bump the page size to 100 items.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #1013 from sijie/increase_page_size;fe012e31248a68a53b3976babaa32dbd51fc8e89
PendingReadOp: improve logging for speculative read targets--And add more log messages around speculative read-to understand what bookies were tried, before attempting-speculative read.--(bug W-3315760)-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Fixed merge conflicts and checkstyle issues]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #993 from athanatos/forupstream/stats1/specreadlogs;20db5fe96571a44429cdf0fad0dfd32240c55c51
Rework of binary distribution licenses--All redistributed jars are mentioned in the LICENSE file. If the jar-is ASLv2, it is simply listed under the ASLv2 text. If these ASLv2-jars have their own NOTICE files, then the relevant portions are added-to our NOTICE file.--All jar under license other than ASLv2 get their own section in-LICENSE, which links to the full text of their license. Non-ASLv2-generally do not require an update to NOTICE.--This change also includes a script, check-binary-license, which checks-that the contents on the LICENSE and NOTICE actually matches what-bundled in the distribution tarball.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #888 from ivankelly/license-rework;64da7e75f7d4ff84a3c9a9adddf6089c1cbf9165
Remove unused import from DoubleByteBuf--9fca59 left behind an import, which triggers a failure in checkstyle.-Fix is to remove the import.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #1011 from ivankelly/fix-checkstyle;5e32f634efa833e3ea7c5ae0b235e5a480ddcb95
Maven classloader--This will allow us to test different versions of the client.--Also includes some extra methods to make it easier to work with the-bookkeeper client.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #975 from ivankelly/maven-classloader;733ce31aa97c757f769048ec280316f493b80238
Fix compilation issue: remove duplicated method (#13);b18cdd521a65bd3ea0946411a1ed4986a5f799a8
 Implement table storage using the local mvcc store (#12);70bb9d7f067413d2031229b29c5ef5c7e88d18eb
revert DoubleByteBuf niobuffers() changes--Revert some of the changes in https://github.com/apache/bookkeeper/pull/996 since they cause issues--Author: Sebastian Schepens <sebastian.schepens@mercadolibre.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #998 from sschepens/double-bytebuf-fix-2;9fca590d94bea9bf86a49f1dbdddf2ae37d3e949
Utilities for working with Arquillian and Docker--This patch contains the following utilities.-- An arquillian StopAction which copy logs from /var/log/bookkeeper to-  the target/ directory.-- An arquillian StopAction which dumps the docker log to the target/-  directory.-- An arquillian AwaitStrategy which checks whether a zookeeper cluster-  is running.-- An arquillian AwaitStrategy which returns immediately (surprising-  arquillian didn't already have this).-- Utilities for working with a cluster of zookeeper/bookkeeper running-  on docker.--Master Issue: #903--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #974 from ivankelly/arquillian-util;1f66e478dd78fb2f9ba66b7c92da2ec17c5be089
DoubleByteBuf fix for Netty > 4.1.12--This is a port from Pulsar, DoubleByteBuf has problems with Netty Native Transport.-Original author is  sschepens--see https://github.com/apache/incubator-pulsar/pull/1056--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #996 from eolivelli/fix/doublebytebuf;ff4932b37f68303793acce91840a55fddfda231f
PendingReadOp: add counter for speculative reads--(bug W-3324107)-Signed-off-by: Dustin Castor <dcastorsalesforce.com>-[Ported to current master, added test]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #991 from athanatos/forupstream/stats1/specreadstats;d44bee59b25035ba69976386b55eecac82a1ae3a
Issue #981: Revert "ISSUE #561: Remove exec commands to start in the shell pid"--This reverts commit 7d7497b70507ea3d31b184ebe04d98c733e2cf5b.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #994 from ivankelly/revert-exec, closes #981, closes #561;25b0d93405e87efeb35ca50cbd04ab14488ceaea
ISSUE #988: more log lines for replication status changes--Descriptions of the changes in this PR:--more log lines for replication status changes--Master Issue: #988--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #989 from reddycharan/replicatorlogs, closes #988;1f0d15356ef10c8ebb14dfb3048b66dbec6c0260
Fix tight loop in getFileInfo--The argument to assertions is not evaluated if assertions is disabled,-which was messing up the refcounting for the fileinfo backing-cache. We ended up with dead fileinfo objects in the guava caches,-which triggered an infinite loop.--This patch fixes that by moving the tryRetain() out of the assert. It-also adds defensive code to getFileInfo to ensure that if a fileinfo-object is dead, that it doesn't exist any longer in the caches.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Yiming Zang <yzang2016@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #990 from ivankelly/inf-loop;26c3379c9fdd812ef36da6176d83e26179705535
LedgerHandle: add counters to track ledger->bookie counts--We can use this to detect distribution issues.--(bug W-4188471)-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-[Ported to master, cleaned up a bit, added test]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #977 from athanatos/forupstream/stats1/edist;83f0796923992ec486d0828c2ba34bb8de7727c6
 Implement table storage using the local mvcc store  (#11);d75ee302588669386629d10c755b61bc503e60cc
ISSUE #986: in LocalBK.main do Sys.exit in the case of an Exc--Descriptions of the changes in this PR:--in LocalBookKeeper.main method if there is any exception then it should do System.exit. This is needed,  because, some non-daemon thread (probably in ZK or some other dependent service) is preventing the JVM from exiting, though there is exception in main thread.--Master Issue: #986--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #987 from reddycharan/minorlocalbookkeeperfix, closes #986;c11f5f03139c3f42495e90cd68ce0b0c77aad616
Journal: add stat for cb queue size--Also adds a bit of functionality to TestStatsProvider to facilitate-testing.--(bug W-3019451)-Signed-off-by: Dustin Castor <dcastorsalesforce.com>-[Adapted to current branch, added simple test]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #968 from athanatos/forupstream/stats1/journal;2d9c327fee60f5025ce9adad4d7c863958ab59ef
 Expose table service to grpc endpoint  (#10);8e53bdefa854ba56d897d5e7449b89decff42a31
store stream/range metadata in a mvcc local store (#9);f4d35c4aed390514a4f9965cb69e4bb7e9df8078
Cherry-pick integration tests from stream storage (#8);32f963d01734371ba29fd3af0e523d6d277d8234
Cherry-pick the stream storage server module (#7);e95abb9e445f851b3be8bb82b087c3d2ea27f701
Use local state store to store root range (#6)--* Use statelib to store metadata----* Remove namespace----* Use local state store to store root range;02352236951a37f4981b0b1585444392f2ad92ee
Introduce a store factory to manage and create mvcc stores (#5);0981dbc84be65c3be20eea7d0deb8603a58b666a
Fix the namespace processor filenames (#4);1e72c59c25da37953362cc491cf82560147a991c
 Fix status codes which still reference collection (#3)--#2 renamed collection to namespace but it doesn't finish cleaning up the status code references. This pull request fixes it.;73bdbea10f469120d5b1574f0381da7901e2fa1a
Rename "Collection" to "Namespace" (#2)--to simplify/unify the concepts with pulsar, rename the collection to namespace;f493c27da4248c2a5ef0d8a6fccf3f54404aa6d6
Fix NPE on LocalClientImpl;70d7153a3cbe1aaa03c3f2a2f3946ee1964b9f47
Storage module should depends on the new client module;039084947d1af19d4d1e01e8ac94bf10ba007ace
Rename RangeServer as StorageServer--`RangeServer` was used for servers that host individual `ranges`. since now the server becomes more generic for serving containers and ranges for both streams and tables.;059384693ae544f5db345e5c46df2e0b189762d8
refactor `rangeservice` to `storage`;db293f39c81664bff960d8f6b0f0eb83934fcd33
Add clients-parent module;87ea6ab78e9deec916990362d7b6d6f4fbbb902c
Refactor client package from `stream.client` to `clients`;81c2bca979df310f6d99e0b30d9472b74f6aed7c
Move client implementation from `streamstore/client` to clients/java;5ca0f0ea294c1a33283c54aaabc1de3dd70d5a90
Refactor, cleanup and enable bookkeeper checkstyle--- rename impl as statelib-- move coder from api to common, so it can be shared between statelib and clients-- move statestore api to statelib;9d621ff21dc47e1c884fb3e243c05e955e70257e
Relocate storage package;56ed506b6c727653671771a07d30a8912130a238
Relocate the protocol package;0f547bd4cb1dad3f52513be9ff2763ecee19e05f
Move kv api from `stream.api.view.kv` to `api.kv`;4cf41eb5cd7d090e2b79d9de3a60e12fb0a44ca4
Finished the import of streamstore module and make it compilable.;c2c2ca3ec5df0439f41a1429ff1bdfa56e941e04
Remove the simple name resolver factory.--This simple name resolver factory is introduced from thin client implementation. It is not needed by stream store.;30d889dffa482939512d46ae0be0f08409d08d5c
Move `bookkeeper-common` as `common` module--This `common` module should be split and merged back to `bookkeeper-common` when stream store is open sourced;9a29dd66c9e1fc43d10dbf4ce375309dbcc99369
[md_proxy2 6/14] Pluggable interface to resolve bookie address from name (#40)--* Pluggable interface to resolve bookie address from name;3cc78ba8fb825f166ff6f6fbd217938f3c79b26c
Stream Store : storage api & impl--(cherry-picked from stream storage work, co-authored by Jia Zhai and Sijie Guo);e62bd805d1f66c971284837649d6194f22f18991
Stream Store: Client--- add client module-- implement the location, root range and metadata range apis-- implement the table api--(cherry-picked from stream storage work, co-authored by Jia Zhai and Sijie Guo);32ad5134fdc36d6d1dfb9bca840d5cc3780a44a2
Stream Store: Define the table API in stream store.--(cherry-picked from stream storage work, co-authored by Jia Zhai and Sijie Guo);6befd491916326d856f42da9537a62ccdd58fb77
Stream Store: Protocol module--- add the protocol module for protocol related classes-- basic concepts (collection, stream), rpc service, clients--(cherry-picked from stream storage work, co-authored by Jia Zhai and Sijie Guo);777a89c5a133207fe6cd0b27590d6588a65f957d
Upgrade nokogiri to 1.8.1--Upgrade nokogiri as 1.8.0 has a security vulnerability.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #972 from ivankelly/nokogiri-upgrade;543ad2b5722988d3936680f605b53fd5be5df403
Move dev and dev-debug profiles to top level POM--So that they can be used from other modules.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #973 from ivankelly/move-dev-profile;1a48c6cc66a1e896f0f3fa8b92f22a7f9f843d59
BookieWatcher: add stats for ensemble changes--(bug W-3019451)-Signed-off-by: Dustin Castor <dcastorsalesforce.com>-[Fixed up merge/checkstyle issues, added tests]-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #969 from athanatos/forupstream/stats1/ensemblechange;c53756bdb1fafb3221b32222602cbc86327e17a7
ISSUE #956: gc: add more stats--Add new gc stats:- * RECLAIMED_COMPACTION_SPACE_BYTES- * ACTIVE_ENTRY_LOG_COUNT- * ACTIVE_ENTRY_LOG_SPACE_BYTES- * RECLAIMED_ENTRY_LOG_SPACE_BYTES- * THREAD_RUNTIME- * MAJOR_COMPACTION_COUNT- * MINOR_COMPACTION_COUNT- * ACTIVE_LEDGER_COUNT- * DELETED_LEDGER_COUNT--Removes apparently unused (better named replacements above):- * NUM_MINOR_COMP- * NUM_MAJOR_COMP--(bug W-3038773)-Signed-off-by: Samuel Just <sjustsalesforce.com>-Signed-off-by: Dustin Castor <dcastorsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #967 from athanatos/forupstream/stats1/gc, closes #956;ade42464ad0f65419b1f47dd111514ce11e092ee
Enable checkpointing in AsyncStateStoreWithJournal;793cc3a67ff978b923c09aa58dd87992bb8e31b6
Add test cases for rocksdb incremental checkpointing;be193caab408c7df1cda0944a22e2c29d148a976
Redirect tests output from console to files;362e912dfbbe0277e4d6676c7db36bd338233674
Use default column family for storing data and introduce a `.meta` column family;4ff90362b6591fda48fca69fbe9e29bc2bfc5ff5
Rename `CheckpointManager` to `CheckpointStore` (#1);aaada2ee9fd6974a4bd79b55f4743d40dbecd4c1
ISSUE #945: Enabling BookieShell for LocalBookKeeper--Descriptions of the changes in this PR:--We should be able to execute BookieShell commands against bookies of LocalBookkeeper--eg. for Zookeeper/Metadata Operation-./bookkeeper shell -localbookie listbookies -rw--eg. for Bookie operation-./bookkeeper shell -localbookie 10.3.27.190:5000 lastmark-./bookkeeper shell -localbookie 10.3.27.190:5000 listfilesondisc--Master Issue: #945--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #946 from reddycharan/localbookkeeper, closes #945;78f862362ef35d07f2889de81e1c64c1f1cc9b2a
implement the rocksdb based async kv store;be560d6bb982eb30b29c5224f55a6d57ccca5b9c
- Move the journaling logic to an abstract implementation of AsyncStateStore-- Provide async interfaces on simple kv store;7d4345f684a630718f5c18336844e155a296c2fd
Move the simple kv statestore api/impl to `kv` package;45d49cac9403388a0690240c279aec5fb145fa46
Add the testing page to navbar--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #963 from sijie/add_missing_guide;4bad1f0706609257bdcb2344feda796efaa89c15
Tag all-versions-image with latest--So that scripts using it don't have to bump version each time.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #964 from ivankelly/latest-tag;af41b92b0f0c00be56e6f729f8ed7f9baddbcc6c
Prepare website for 4.6.1 release--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #962 from eolivelli/new461website;3a6699df9b553db569c6882b0de7d467dd504ea3
Docker image for testing--Contains all released versioned and the current version (from the-current source tree). The image only gets built if the docker maven-profile is enabled:--```-mvn package -Pdocker-```--Supervisord is used to start and stop bookkeeper. Each version has its-own supervisord config. The same journal and ledger directories are-used for all versions. Logs are written to per version log files in-/var/log/bookkeeper.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #959 from ivankelly/all-version-docker;0d42faead06db0d9ea1a1d19f806f9f97c4dd54a
ISSUE #897: un-bind zookeeper from bookkeeper admin--Descriptions of the changes in this PR:-- remove zookeeper from LedgerLayout to make LedgerLayout as a pure layout object,-- add LayoutManager, move zookeeper related utils into ZKLayoutManager for storing/reading/delete layout from zookeeper,-- unbind zookeeper from LedgerManagerFactory, use LayoutManager instead,-- unbind zookeeper from bookkeeperadmin.format,-- fix compile and test errors.--Master Issue: #897--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #936 from zhaijack/issue_897, closes #897;998a55fe2b549c93907c5774333be7f4431de3e5
Add descriptive message for TooManyRequestsException--After upgrading from 4.5 to 4.6 I found a lot of "Unexpected condition" in some benchmarks.--TooManyRequestsException is a new error introduced in 4.6, there is not description, so the default description is "Unexpected condition", without a debugger it is not possible to understand the cause of the error.--Author: Enrico Olivelli <eolivelli@apache.org>-Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #921 from eolivelli/toomanyrequests-message;52f511e1a5cbd136e48528e5ed66630250593198
BookieProtoEncoding: use retainedSlice() to reduce garbage--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #940 from athanatos/forupstream/requestprocessorfixes/3;f39c423c8d2c493343e1172a81484c50c1b71168
ISSUE #947: ZK configs for LocalBookkeeper--Descriptions of the changes in this PR:--Master Issue: #947--- make ZK's data directory configurable for local bookie-- Localbookie to use ledgersrootpath from conf file--e032218a910113b0e4de561a76da8bdf61ba3db7-(bug W-2887104) make ZK's data directory configurable for local bookie--Author: Andrey Yegorov <ayegorovsalesforce.com>-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #948 from reddycharan/localbookkeeperzkfixes, closes #947;d6de867f594ee5f7aef25ed8d6591029befe8c19
ISSUE280: Add StateManager to manage Bookie's state, and use it to turn bookie into readonly when sortedLedgerStorage failed to flush data--Descriptions of the changes in this PR:--Add SortedLedgerStorageListener to implement, and add a test case to verify it.--Master Issue: #280--Author: Arvin <arvindevel@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Ivan Kelly <ivank@apache.org>--This closes #873 from ArvinDevel/issue280;6a5f6367a77094406ff0c938cf6b7f6d804451e1
Refactor FileInfo locking and refcounting out IndexPersistenceMgr--There is a number of bugs in index persistence mgr related to how-refcounts are handled and how FileInfos are freed, due to the locking-mechanism. These can result in the fencing bit being lost in ledgers,-which is a serious issue. They also cause flakes in-IndexPersistenceMgrTest#testEvictFileInfoWhenUnderlyingFileExists.--For details see the discussion at:-https://github.com/apache/bookkeeper/pull/513/files/8075b0#r156676238--There are two key problems.--1. FileInfos are flushed asynchronously on eviction. If another thread-tries to read the FileInfo after the flush has been scheduled, but-before it runs, it will read stale date (and we'll possibly lose the-fence bit).-2. FileInfos can be closed while it is still references in the-IndexPersistenceMgr. This means that it can be fenced, but this will-very be flushed to disk because the FileInfo is already closed.--The patch solves this by moving FileInfo locking and refcount into a-separate class, FileInfoBackingCache. When either the write cache or-read cache load a file info, it tries to load it from this backing-cache. All writes to the the backing cache are done under a write-lock. This class also takes care of reference counting. It hands out-CachedFileInfo objects, which will be flushed to disk when all-references are released.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #913 from ivankelly/index-persist-lock;131685252b714daed9daa80ecbaf148f208c9bc5
Exclude travis log for apache-rat:check;6be3e961d406259cb7ac51fc58ae9536478c7e57
Enable apache-rat:check;c4a73d985505f3a74387a031cd28da3216f3f6f5
Remove duplicated matrix section;04afde6f26fa1d2a17347f046eac9bbbe8b29b94
Enable travis ci;40ef78045234c22a4f949ec11338e41ac139b33d
Add LICENSE file;a9b94efcf6035dd215112aa4a38a41825a7c0506
Move api classes to api module;e29964296e4cbc9981e0b9d9a5af465fe13b28f0
Split the statestore module into api and impl;f9bba3c516b7fb2fceba0c5302bd0e23f52475ad
Incremental checkpoint on rocksdb--- introduce checkpoint manager-- implement rocksdb checkpoint and restore tasks-- provide a filesystem based checkpoint manager;cf4e8e07b6ca58440bf5758567d4b238cf271b90
Fix compilation issue after moved statestore out of distributedlog repo;37e2f2033c6bc8c354eeeedcb584dfc7ea62fcec
Move the module from `distributedlog-io/statestore` to root module;578de75b097c53d1be9a658a05faa829f354f103
Introduce StateStores and MVCCStores as factory for supplying stores;02da55bfd4c275bc8fc77e2eb00dcea12225b8b9
Implement cas shortcuts in mvcc store--- put, putIfAbsent-- delete, delete(k, v), deleteRange()-- cas put and delete based on version: vPut, vDelete-- cas put and delete based on revision: rPut, rDelete-- get and range;cc9a7a96792bde6a44c5ae48de93f37334884578
Return the right revision for results;4424ba74748c7156e7b296d09f6b5f0b328e71c8
Make keys optional for range operations and make range operations correctly handle head and tail ranges;f0c251bd6c7880ff9ea84e916b9e2b56cf82e7a7
Implement txn operation in local mvcc store;e7292cdcdc307d356bb63d55608a530487c74f96
Implement delete op in local mvcc store;5170c52052dc89ac7023ba7736fc9fda7920a80f
Implement MVCC Async Store using local rocksdb and distributedlog stream;a25d9f3c252f1082a3ace50db6958f109c53af3f
Add protobuf definition for put/delete/txn request;cef37ed5980a47c8d739ea37590c97fcbb965ff0
Make localStateStoreDir, stream and ioExecutor optional;96e52dec37dafd0d452dc4e9e13b36e12abc398c
Implement put and range operation in mvcc store;a914eed584bba706456c13619dcae5c38f916593
Implement Range and Put Operation;481b57ed2367c80aebe63853c0b078a0f422ff15
address compilation issue with @FreeBuilder;5e36a28c6b1d268088e0e4f3c205bc639f6e48ce
Implement Record Factory;18e918ea576d03a8c42f368a274c450d612df995
Add internal structure for mvcc record;c2a5d41f1539feaa953f67604d17463a0e5266b1
Implement op and result;72b87356a6714c906213a13e298e1194604e1b69
Reorganize builder and op;97656e7cddba04a40b8eabea2d591367676ac112
Add javadoc and annotation, fix checkstyle;f16b5567ecbfe2c8015f5084262fbf3abb2036ec
Make all interfaces;e666fc3c6ea2ca57fe450fa7eb223cb8b63747f9
Async and Sync MVCC Store;3171228d0b8bfebcec81faac584854f93ae888f9
State Store: Add MVCC Store Interface;0cd6116717b725dc5528a32ae78b5cc6a9074685
Fix checkstyle and findbugs errors;8315883abd0f1d01cd7e0b0bbe5d947ca2bf9c11
State Store: Define the k/v interface;5555e0bb3e82a1aed90a1ab174e6a17499ac6c01
Introduce MockClock and MockExecutorController to improve timer-based testing--Descriptions of the changes in this PR:--- introduce MockClock and MockExecutorController to control time advancing to trigger execution on tasks-- convert LedgerDirsMonitor from using Thread to use ScheduledExecutorService (moved the logic in `run` method to `check` without code changes)-- change TestLedgerDirsManager to use MockClock and MockExecutorController to remove the usage of `Thread.sleep`--Master Issue:  #943--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #944 from sijie/mock_scheduler;7fe87f9354a04bb6789f8111242d35a1b730d3ba
ISSUE #935 ISSUE #915: Part 3 - Make circe-checksum module work for both java 8 and java 9--Descriptions of the changes in this PR:--    - switch from jmockit to mockito, and from testng to junit. make testing and mocking framework consistent across modules.-    - skip `-Werror` check in circe-checksum since `finalize` is deprecated at java 9-    - change CRC32CDigestManager to use `circe-checksum` module-    - fix shading to include `circe-checksum`--This change is based #917 . Gitsha 73049f8 contains the changes to make circe-checksum module work for both java8 and java9.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #937 from sijie/fix_pulsar_checksum, closes #935, closes #915;1e2c24b82648aa27974d1a0b91fe80d97c30fef0
Issue 915: Part 2 - Add crc32c integer/long checksum utils under `com.scurrilous.circe.checksum` (#917)--This is the part 2 change of #915. It is based on #916, adding crc32c int/long checksum util classes under com.scurrilous.circe.checksum. It also fixes a incremental checksum issue on long crc32c. I added bunch of test cases to ensure the both long/int crc32 checksum is correct on incremental cases.;312784812aa1349bf2864a5da07f6ace7ff687ba
ISSUE #915: Part 1 - Copy pulsar-checksum module as circe-checksum--Descriptions of the changes in this PR:--- this change copies the files under `com.scurrilous.circe` in pulsar-checksum module into bookkeeper as `circe-checksum`.-- this change doesn't copy files under `org.apache.pulsar` except NativeUtils. will have a subsequent change to add it.-- Move NativeUtils to `com.scurrilous.circe.utils`.-- Update notice files to respect to Trevor Robinson's change--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #916 from sijie/copy_pulsar_checksum, closes #915;a0b05c519b34dd1f4bcd1f440378aeb601c92c90
ISSUE #952: Split the multiple-jdk-versions ci jobs into two--Descriptions of the changes in this PR:--*Problem*--When using a matrix job to define a CI job running on both java 9 and java 8, the workspace file path will be added with "jdk name" (e.g. "JDK 1.8 latest" and "JDK 9 latest"). This will cause file paths contain spaces, and fail the builds.--for example, #879 #880 is one of the examples. #937 can't pass ci because g++ fails when the file path contains spaces.--*Solution*--Splitting the matrix job into two separate jobs suffixed with "java8" and "java9", so it won't contains any space in workspace.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #953 from sijie/separate_jdk_cis, closes #952;f7cdb5775651e9deb268e5cf9dd57e77291be035
ISSUE #954: dir_*_usage stats are always 0--due to mismatch between the way they are initialized in `LedgerDirsManager` and-the way the `diskUsages` is populated subsequently in `LedgerDirsMonitor`--Decisions potentially worth some attention:-- stat names are kept `dir_{dir}_usage` while the actual dirs being checked have been changed to `{dir}/current`;-- the stats aren't being updated if the bookie is in a readonly mode -- uncovered while testing, not sure if it's worth addressing at all, kept the fix minimalistic for now.--(bug W-4594204)--Author: Pasha Kuznetsov <pkuznetsov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #957 from pasha-kuznetsov/dir-usage-stats, closes #954;1a8b35d38737f6d043995a756da10ea111268b4a
ISSUE #950: EntryLogger.extractEntryLogMetadataByScanning: fix check--0 is a valid ledger id. Seems to be causing-test2RWsShouldCompeteForReplicationOf2FragmentsAndCompleteReplication to-fail in cases where the gc runs before the recovery reads happen. The gc-winds up believing the entry log to be empty and deletes it erroneously.--Introduced in 143bd1952851ac70ace9d16c3708ae30dad2a0aa.--(bug W-4596080)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #951 from athanatos/forupstream/issue-950, closes #950;d320936c00c3eeae0a4e2795f0a9bfa780fd6f98
ISSUE #877: add verifier.BookkeeperVerifier--Plays and verifies a non-determinstic read/write stream against a-bookkeeper cluster.--Master Issue: #877--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #890 from athanatos/forupstream/issue-877, closes #877;904857b9a67c7ae4afae38bfeeb3e1eda3daba5a
BookieNettyServer: add contextHandler to the local transport pipeline--Left off of 8e0bd2c3d81b522e97434d8646915f36422a104b.  In fact,-authentication is already enabled on LocalTransport.  This extra line is-needed for the machinery which allows auth plugins to access ssl state.-Currently, the only plugin which uses that machinery is in TestTLS.-Adds test cases to validate that functionality with Local Transport-enabled.--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #941 from athanatos/forupstream/requestprocessorfixes/4;dc30763f21a3b06d6cb429998c3d3cb2a7aac8f2
ISSUE #931,#907: Add option to track task execution time--Fixes a bug in OrderedScheduler introduced in-e33ec10aa400f32c2e0278c15ea80a0f624e5919 which failed to track execution-time with some calls and adds an option to enable it in the bookie.  Also-fixes a bug with task_queued duration.--Add a simple mock for remembering stats long enough to verify that-counters are actually used and sensible in unit tests and bake it into-BookKeeperClusterTestCase so that we can write tests to ensure that the-stats are actually counted and make sense.  Use said mock to add simple-tests for top level read and write stats validating this fix.--(bug W-4276826)-(bug W-4268290)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #932 from athanatos/forupstream/issue-931, closes #931, closes #907;477ff2b594afd4017f6fb9e8f294c9b2a75b0d6a
BookieRequestProcessor: shutdown the longPollThreadPool as well--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #938 from athanatos/forupstream/requestprocessorfixes/1;7f62baec18ba8aa0d2d01134b7c5adfc25c49d42
ISSUE #590 (@bug W-4556980@) Reduce excessive CPU usage on client side: add crc32c--…2c with SSE processor instruction support, benchmark to make sure it is better than crc32--Descriptions of the changes in this PR:--CRC32C for bookkeeper--Master Issue: #590--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #856 from dlg99/feature/crc32c, closes #590;2fbb2916a323edfc097de0de9b2d81e59b37bf6f
ISSUE #922: changes to shading bookkeeper-server jar--Descriptions of the changes in this PR:--**Problem:**--`shadedArtifactAttached` was introduced in 4.6.0 to generate plain and shaded artifact for `bookkeeper-server`. Because for projects (e.g. distributedlog) that would use same protobuf and guava version as bookkeeper, they will use the plain artifact (to avoid shading protobuf/guava multiple times). However there are a few problems with that:--1) bookkeeper-common is not included in the shading include set.-2) `shadedArtifactAttached` only generate a shaded artifact (with relocated classes), but doesn't generate a dependency-reduced pom file. so you have to manually exclude relocated dependencies.--**Solutions:**--- for shaded artifact of `bookkeeper-server`, include all the bookkeeper submodules that bookkeeper-server depends on. so the shaded artifact includes all the classes that need to be relocated.-- introduce a `shaded` module for keeping new shaded libraries. Currently `bookkeeper-server-shaded` is a shaded module of `bookkeeper-server`, while `bookkeeper-server-tests-shaded` is a shaded moulde of the tests jar of `bookkeeper-server`.-- update the client api documentation about the instructions on how to use shaded artifact of `bookkeeper-server` and the new shaded module `bookkeeper-server-shaded`.-- add test cases to verify the shaded artifact and the new shaded modules generate the right artifacts.--**This change doesn't address:**--Currently both client and server are bundled in one `bookkeeper-server`. this change will not introduce any shaded client-only jar. that would be deferred until we split `bookkeeper-server` module.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #928 from sijie/fix_shading, closes #922;1ed78912907cd2157f0b93ecaa653923ede4365c
ISSUE #870: ScanAndCompareGarbageCollector: harden against LM bugs--The idea behind this patch is to make it more likely that more than one-LedgerManager bug would be required to erroneously believe a ledger to be-deleted.-1) Remove the special handling for the completely empty LM.  It's not-really a common case nor is it much of an optimization even when it-happens.-2) Add a config variable to cause the bookie to also check the-LedgerManager.readLedgerMetadata path before actually removing a ledger.-The implementations of readLedgerMetadata and the iterator are-sufficiently different that it seems worth it to have the option of-checking both to guard somewhat against a bug in either.--(bug W-4292747)-(bug W-3027938)-Signed-off-by: Samuel Just <sjustsalesforce.com>-Signed-off-by: Charan Reddy Guttapalem <cguttapalemsalesforce.com>--Master Issue: #870--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Arvin <None>, Sijie Guo <sijie@apache.org>--This closes #876 from athanatos/forupstream/issue-870, closes #870;1f8b26d5f02ae6bccf0d586bcb145f4461f4fde6
Add a section for 4.6.0 in releases.md--Descriptions of the changes in this PR:-- add a section for 4.6.0 in releases.md,-- add a check item for this in release_guide.md--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #920 from jiazhai/update_release_page;65f03e2fc17f56bcc61fa7799559dd0438690658
Fix user email typo in release_guide--Descriptions of the changes in this PR:--Fix user email typo in release_guide--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #919 from jiazhai/fix_typo_in_releaseguide;80d9abb9deaec66932cd8a7f18923ba0076b7ad8
ISSUE #697: bump version to 4.6.0 in Dockerfile--Descriptions of the changes in this PR:--Since 4.6.0 released, bump version to 4.6.0 in Dockerfile to use the latest release--Master Issue: #697--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #918 from jiazhai/issue-697, closes #697;5648ba9da09b21bd0d13bc01b6665efb04a9b035
ISSUE #895: print entrylog metadata--Descriptions of the changes in this PR:--- bookieshell command to print entrylog metadata--Master Issue: #895--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #896 from reddycharan/printentrylogmetadata, closes #895;4274f945da1c8bb556f51e623273a1584040b7b8
ISSUE #893: more options for UpdateCookieCmd--Descriptions of the changes in this PR:--- add ListCookie Options to UpdateCookie command-- add DeleteCookie Option to UpdateCookie command-- move expandstorage command to UpdateCookie command as option,-since expandstorage is just a cookie update operation-- in listfilesondisc command use canonical path (full path)--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>-Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #894 from reddycharan/updatecookiecmd, closes #893;54baa27426a9cb5e697f6b32333070e7f5ef02fb
ISSUE #904: short hostname for bookieid--Descriptions of the changes in this PR:--- provide useShortHostName config to use short hostName for bookieId-- corresponding testcases-- For BKShell commands print appropriate string representation (hostname and ipaddress)-and port number of bookies--Master Issue: #904--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>-Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #905 from reddycharan/shorthostname, closes #904;de9fe40fd5b2189d89f1f51c62201aff08718064
AbstractZkLedgerManager: wrap Log.debug in an isDebugEnabled check--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #908 from athanatos/forupstream/small-fixes-1/zklm-debug;95ee60872ae6a47996dc3215ef911ce375458a72
Journal: Fix journal write queue so it decrements properly.--(bug W-3169683)-Signed-off-by: Dustin <dcastorsalesforce.com>--Author: Dustin <dcastor@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #912 from athanatos/forupstream/small-fixes-1/journal;c8b8267abf6b0aefdc5f3eaae665330f3998b2cc
DefaultSpeculativeRequestExecutionPolicy: fix logger instantiation--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #911 from athanatos/forupstream/small-fixes-1/logger;0b3190e5cb6285b1ad30cfcdc074fde223772d38
EntryLogTest,LedgerCacheTest: use correct tmp dir--These tests weren't overriding the journal dir and so weren't using-an IOUtils tmp dir for the journal.--(bug W-4267131)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #910 from athanatos/forupstream/small-fixes-1/tmpdir;037ce71e08bb7ca6a3d50c9b2d5ace39f37eaf18
BookieProtoEncoding: log messages at TRACE rather than DEBUG--Logging them at debug tends to make logging at DEBUG level pretty-intractable, log them at TRACE instead.--(bug W-4166441)-Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #909 from athanatos/forupstream/small-fixes-1/trace;5ea3110e35e0694fc8ed2218698888041eaf23e8
Fix: fail create-ledger callback on ledgerId generation failure--### Motivation--Recently, we have seen that when bk-client tries to create-ledger and if bk-client lost the zk-connection then bk-client doesn't complete the createLedger-callback. We can see following exception when bk-client fails to generate ledgerId from zookeeper.-```-05:43:35.364 [main-EventThread] ERROR o.a.b.meta.ZkLedgerIdGenerator       - Could not generate new ledger id-org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /ledgers/idgen-long/HOB-0000000001/ID--        at org.apache.zookeeper.KeeperException.create(KeeperException.java:99) ~[zookeeper-3.4.6.jar:3.4.6-1569965]-        at org.apache.zookeeper.KeeperException.create(KeeperException.java:51) ~[zookeeper-3.4.6.jar:3.4.6-1569965]-        at org.apache.bookkeeper.meta.ZkLedgerIdGenerator$1.processResult(ZkLedgerIdGenerator.java:78) ~[bookkeeper-server-4.3.1.56-yahoo.jar:4.3.1.56-yahoo]-        at org.apache.bookkeeper.util.ZkUtils$1.processResult(ZkUtils.java:79) [bookkeeper-server-4.3.1.56-yahoo.jar:4.3.1.56-yahoo]-        at org.apache.bookkeeper.zookeeper.ZooKeeperClient$9$1.processResult(ZooKeeperClient.java:527) [bookkeeper-server-4.3.1.56-yahoo.jar:4.3.1.56-yahoo]-        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:605) [zookeeper-3.4.6.jar:3.4.6-1569965]-        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:498) [zookeeper-3.4.6.jar:3.4.6-1569965]-```--### Modifications--- Bk-client handles and completes ledger-request callback on ledgerId-generation failure.--Author: rdhabalia <rdhabalia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #900 from rdhabalia/create_ledger_ap;b94773ae733e7aca0ff3b6807929ded026dfbe07
BookKeeperBuilderTest has recovery backwards--NoRecovery test was specifying withRecovery(true).-Recovery test was specifying withRecovery(false).--This patch swaps them to how they should be.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #899 from ivankelly/recovery-test-fix;9e4bd8e3de91cafaf87386a29d09f3d62909a5d4
ISSUE #865: LongHierarchicalLedgerManager: refactor to fix races--LongHierarchicalLedgerRangeIterator.initialize() could erroneously exit-with iteratorDone if the lexicographically first path in zk had fewer-than 4 levels.  This can happen for a few reasons including a case where-a client creating a ledger on that path crashed during the zk updates or-the iterator.hasNext() call simply raced with an in-progress node-creation or removal.  ScanAndCompareGarbageCollector is hasNext()-returns false will delete all ledgers on the bookie, so this is a fairly-serious bug.--Ruling out other such bugs was fairly dificult with the structure of the-code as written, so instead use a simpler recursive iterator design with-simpler pre/post conditions.--Also, surface KeeperException.NoNodeException from-ZkUtils.getChildrenInSingleNode so that we can actually handle it in-LHLM.--Master Issue: #865--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #875 from athanatos/forupstream/issue-865, closes #865;155c3c95f3fcc823432e23a93a8cd3f51ebff917
Add command line tool to manually recover ledgers--Descriptions of the changes in this PR:--This is a change ported from yahoo/bookkeeperf4957610.--Author: Sijie Guo <sijie@apache.org>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #886 from sijie/manually_recover_ledgers;9ab30454343118e6c80ca3f3eb13d01e511c89fc
Misc LedgerHandle changes--Adds logging for new ensembles, a getCtime call, and a check for ReadOnlyLedgerHandle in initializeExplicitLacInterval.--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #892 from athanatos/forupstream/misc-ledgerhandle-changes;cfd0428d3f5661505132a31ffcc7a68dda2115a2
make replaceBookie() exclude ensemble bookie racks--Descriptions of the changes in this PR:--This is a change ported back from yahoo/bookkeeper0589d0d58d61364be1a897a5c1478d3109f4fc17. It excludes the ensemble bookie racks when replacing bookies. since there is already a new weight-based placement strategy introduced, so this change only applies when `weight-based` placement policy is not enabled.--This is a change contributed from Siddharth Boobna.--Author: Sijie Guo <sijie@apache.org>-Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #887 from sijie/use_bookie_address;39bdfbcf2e285fc863dfcf927a8d2201c8b1fa01
ISSUE #709: Add Slow Bookkeeper Servers to Placement Policy for read ordering--Descriptions of the changes in this PR:--Maintain a list of slow bookkeeper hosts, which are tried only after readonly bookkeeper hosts are tried. Bookkeeper hosts can be categorized as "slow" when a speculative timeout occurs on that bookkeeper host.--Master Issue:: 709--Author: Philip Su <psu@twitter.com>-Author: Sijie Guo <sijie@apache.org>-Author: philipsu522 <philip.su.522@gmail.com>-Author: Ivan Kelly <ivank@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Yiming Zang <yzang2016@gmail.com>, Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #883 from philipsu522/psu/ISSUE-709-2, closes #709;cc84042a4d494fde42d215ead28093033da6861a
ISSUE #878: add .checkstyle file to apache-rat-plugin exclusion list--Descriptions of the changes in this PR:--- eclipse/checkstyle plugin autogenerates .checkstyle file in all the-projects/modules. So it has to be added to the exclusion list,-otherwise apache-rat:check (mvn clean apache-rat:check install-spotbugs:check) would fail because of these files with unknown-Apache License header.--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #882 from reddycharan/excludecheckstyle, closes #878;e90692274d6ab9b7d80ff5e5dfe94a741e6cf042
ISSUE #879: TestTLS fails when project path contains spaces--Descriptions of the changes in this PR:--Use `URI` rather than `URL`, so it won't use url-encoded path as the file path.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #880 from sijie/relative_path, closes #879;4a4896c9b66741000c923b587ee1eafafca40273
ISSUE #884: Upgrade powermock and mockito to support java 9--Descriptions of the changes in this PR:--powermock supports java9 at the new version (see powermock/powermock#783). this pull request upgrades the powermock and mockito versions, so we are able to run tests on java 9.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #885 from sijie/use_powermock2, closes #884;67d560f9dc2ad71e12ebffde74def7ac1738f6f9
ISSUE #849: LedgerIdFormatter and EntryFormatter Config options--Descriptions of the changes in this PR:--- LedgerIdFormatter, so it can be used for configuring format of LedgerId (Long/hex/UUID) in input/output of BKShell command-- provide config options for both ledgeridformattet and entryformatter and java options for the same for BKShell commands-- enhance ReadLedgerEntriesCmd command to have options rather than as arguments-- fix checkstyle errors - "Redundant 'final' modifier." and for invalid variable name format--Author: cguttapalem <cguttapalem@salesforce.com>-Author: Charan Reddy Guttapalem <reddycharan18@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #864 from reddycharan/ledgerformat, closes #849;62de3cd677b9daa22ce51863562eecc28a144107
Add a testing guide--Descriptions of the changes in this PR:--Putting up a page for `testing` related information. This is the first attempt to document all CI related information.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #874 from sijie/testing_guide_doc;ff42188d069556626cf0673359c02ef9d7ec778b
ISSUE #863: BK client error messages need to be more descriptive--This improves logging of error codes as described in the issue #863. I only addressed the most glaring cases where bare `rc` was logged, by introducing a new logging utility which can be used as follows:-```-LOG.error("Closing ledger {} due to {}", ledgerId, BKException.codeLogger(rc));-```-producing messages similar to the following:--We can also discuss if the cases similar to the following should be brought in line with the above changes, which produces more information compared to the new approach, including stack trace, although not the original one:-```-if (rc != BKException.Code.OK) {-    LOG.error("BK error opening ledger: " + lId, BKException.create(rc)); // <-------------------    finalLedgerIterCb.processResult(rc, null, null);-    return;-}-```--P.S. Please also note that we (Salesforce) are starting to add commit tags simplifying our merge process, e.g. `(bug W-3843968)` -- please let us know if that is significant enough to be discussed separately.--Author: Pasha Kuznetsov <pkuznetsov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #868 from pasha-kuznetsov/error-code-logger, closes #863;301ba6f90fafa77757990e5e0caf773530c06fe2
Issue #328 - Add docker compose example file--This patch adds a docker-compose example file for helping new-users to use bookkeeper.--It runs by default an ensemble with 3 bookies and a client-application based in the following tutorial, but you can leverage docker-compose features to scale up the number of instances.--https://bookkeeper.apache.org/archives/docs/master/bookkeeperTutorial.html--Ref: Issue #328--Signed-off-by: Antonio Ojea <antonio.ojea.garciagmail.com>--Author: Antonio Ojea <antonio.ojea.garcia@gmail.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #871 from aojea/docker, closes #328;48c8fcf9ed04bd4be083d86e1b42736e9f7aa709
add try-with-resources in coding_guide--Descriptions of the changes in this PR:--This is related to PR #845, and want to  add try-with-resources in coding_guide.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #872 from jiazhai/fix_doc;5199fad8afb49276372f71f49810e7565761cafd
DbLedgerStorage -- Added config options in bk_server.conf--Added commented config options with default values.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #860 from merlimat/db-storage-conf;bd89cdf20a6db14d2d0b906238c0e1d4a959b36f
Manage all the jenkins jobs using jenkins-dsl--Descriptions of the changes in this PR:--- use jenkins-dsl to manage all the bookkeeper jobs-- the seed job will poll the files checked in under `.test-infra/jenkins` at master and automatically update other jenkins jobs-- this enforces all the jenkins jobs' changes should go through github reviews and allows everyone can make changes to jenkins jobs.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #866 from sijie/test_infra_jenkins_dsl;2b7b24dc569483bd0231e9cd1f2b9a14cc612045
During journal replay, force to re-insert the master key in ledger storage--When the bookie crashes and restart, it will replay the entries from the journal. In the case of ledgers that were created, but their metadata was not flushed on disk, the ledger metadata might be lost.--This is more evident in `DbLedgerStorage`, since the ledger metadata is cached in memory and it's only inserted in the db at the checkpoint time, though it applies as well for `InterleavedLedgerStorage` where the ledger metadata was inserted in the cache but not fsynced on disk.--If the page cache content is gone, when replaying the journal content, the ledger will be tracked in memory but the bookie won't have the metadata on disk anymore.--Merging from yahoo branch: https://github.com/yahoo/bookkeeper/commit/d3626396ecf1a2b98c782bb30a7b9c00c75c6cdf--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #867 from merlimat/master;d1d6804e15c03a138431945df59a2c41a4f1f205
ISSUE #778: Make build pass using JDK9--Descriptions of the changes in this PR:--- make bookkeeper can be compiled with java 9-- add java9 to travis ci to make sure it can be built for both java8 and java9--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #857 from sijie/compile_with_java9, closes #778;97c35e9c02f0b7be33881d1a1c0c500143f8fc55
Add attribution for binary jars covered by New BSD License--This means a separate LICENSE file for server and all, as all pulls in-more stuff.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #854 from ivankelly/license-fix;d48d3228b991050fc709a8f10c307fd7c5469d5c
DbLedgerStorage -- Added bookie shell tools--Added BookieShell tools for DbLedgerStorage conversion operations:-- * `convert-to-db-storage` --> Convert interleaved indexes to db storage indexes- * `convert-to-interleaved-storage` --> Convert back from db storage to interleaved storage indexes- * `rebuild-db-ledger-locations-index` --> Rebuild the DbLedgerStorage index by scanning the entry log files.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #859 from merlimat/db-ledger-storage-itemized;89ac2a2b7b7883f0b48978bf3dc3802ecf0fc6c1
DbLedgerStorage -- Main implementation--`LedgerStorage` implementation that uses the EntryLogger mechanism but stores the indexes in a RocksDB database.--In addition, there are also a WriteCache and a ReadCache that are used to completely decouple the read & write paths.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #855 from merlimat/db-ledger-storage-impl;bba1c6f5d0d92d647467438876cfa32b699780f6
ISSUE #326: Replace observer/observable with a simplified watcher/watchable implementation--Descriptions of the changes in this PR:--- long poll only need one-time notification on lac updates-- replace observer/observable with a simplified watcher/watchable implementation. watchers are removed after they are fired.-- add `RecycableHashSet` for `Watchable` keeping the list of watchers-- object pooling on `Watchable` and `LastAddConfirmedUpdateNotification`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>--This closes #838 from sijie/rxjava, closes #326;3ba705057ecafb0529676603ae1d2c3f266362a0
ISSUE #668: Use try-with-resources blocks whenever is possible--Use java7 try-with-resources blocks in order to have error prone code and more elegant--Author: Pasha Kuznetsov <pkuznetsov@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #845 from pasha-kuznetsov/try-with-resources, closes #668;b727acf9f90314dd0deffad873841e474cc8b9d8
DbLedgerStorage -- Make some entrylogger methods accessibles--This changes are needed for `DbLedgerStorage` implementation to access some of the protected methods of the EntryLogger.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #844 from merlimat/db-ledger-storage-itemized and squashes the following commits:--b4d886ea [Matteo Merli] Removed timeout and fixed test-46652dd4 [Matteo Merli] DbLedgerStorage -- Make entrylogger read methods accessibles;a671d92441c222052f9a5cdcb396a343d60882e5
ISSUE #841: Unnecessary new Object[] {}, new String[] {} etc calls--This takes care of a few new Object[] {}, new String[] {} etc calls,-mostly leftovers from the older slf4j's LOG API which used to lack-the Object... "vararg" method overloads, making it easier to read-and maintain.--Author: Pasha Kuznetsov <pkuznetsov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #842 from pasha-kuznetsov/redundant-arrays, closes #841;9d59e6f8066669f2f0a07d7a026d9d7dcdaa2e47
DbLedgerStorage -- ReadCache--Adds a `ReadCache` class to be used from LedgerStorage.--The read cache is used when doing read-ahead caching after reading one entry.--The idea is that entries for the same ledger as stored in order (for each flush cycle, eg: 1min). When reading 1 entry, we expect the client to read all subsequent entries. We can then skip the RocksDb `get()` to fetch the index of the entries, by just keep reading from the entryLog, and exploiting page cache and seqeuential reads. The entries are then added to this ReadCache, where they will looked when the request for next entry comes in.--This implementation is based on dividing the memory into multiple segments. Whenever the read cache is full, the oldest segment gets recycled and overwritten with new entries.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #843 from merlimat/read-cache;e87bf7c10d2cd51453ddeb1c31ad8ce0a5f1544a
ISSUE #744: BP-18 introduce write flags--Introduce writeflags on the API and on protobuf files.-Client and server do not use these flags yet.--Author: eolivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #742 from eolivelli/bp14-writeflags, closes #744;3e4ff0dca8557ff03dda2d292c3c6678df8f1a02
ISSUE #741: Switch to Spotbugs--Moved from findbugs plugin to spotbugs.--Author: Matteo Minardi <matteo.minardi@diennea.com>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #834 from mino181295/ISSUE#741, closes #741;7c4e6c9b0035c561e051d028765b319e9ecc9268
Allow subclasses of AbstractConfiguration to use fluent style--And in doing so, get rid of ugly casts.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #835 from ivankelly/abstract-conf-generic;aecf6da41f8978ad82b1f0cf65fc914f242e1d16
Fix Flaky CreateNewLogTest--Descriptions of the changes in this PR:--CreateNewLogTest becomes flaky after fixing #568 because preallocation can happen in the background. Changing the sequence of creating entry logger and entry log file injection to make the test sequence deterministic.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #836 from sijie/fix_createnewlog_test;50d50bd8064f67583c70688171bd3386ae418b64
Fix FlakyTest TestRegionAwareEnsemblePlacementPolicy--Descriptions of the changes in this PR:--include all possible resolved hostnames into the static dns resolver for region aware testing.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #837 from sijie/fix_regionaware;f207d2d9f432d43e2461f260056b91f1ba4803e1
Fixed RocksDb storage options instantiation after library is loaded--In previous commit 8e6c1a2e76a, the initialization of some RocksDb option objects was done before the RocksDB JNI library was loaded, leading to exceptions.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #840 from merlimat/key-value-storage;ddc09d55a4379846c68a56db56889cf94caa777d
DbLedgerStorage -- KeyValue storage interface with RocksDB implementation--Add an interface for a generic key-value storage local library, with the default implementation based on RocksDB.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #829 from merlimat/key-value-storage;8e6c1a2e76a77b0dcf503e25a90a12d2d7b784ab
ISSUE #831: move zkServers and zkTimeout into AbstractCofiguration--Descriptions of the changes in this PR:--both ClientConfiguration and ServerConfiguration contain ZkServers and ZKTimeout, would like to move them into AbstractConfiguration.--Changes:-1, Regarding methods setZkServers/getZkServers/setZkTimeout/getZkTimeout,  remove them in ClientConfiguration and ServerConfiguration; added them in AbstractConfiguration;-2, fix usage of above methods in test cases;--Master Issue: #831--Author: Jia Zhai <zhaijia@apache.org>-Author: Sijie Guo <guosijie@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #833 from zhaijack/issue-831, closes #831;f1bee51d8157399fc4e1b777376b29656d154819
DbLedgerStorage -- Write cache--1st part of DbLedgerStorage related changes.--This PR introduces a `WriteCache` class that is used to store entries before they get flushed on the entryLogs.--The key part is that it provides a way to iterate in order over the entries and it is is garbage-free at steady state.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #828 from merlimat/db-ledger-storage-itemized;271e6faa3ace16c1ca52e55caac3d76d26d1f6ab
Client times out requests in batch rather than individually--This patch is a squash of f59b597f, 00fc5cd2, 1658eb61 & 833dc307 from the yahoo-4.3 branch. The change removes the HashWheelTimer from PerChannelBookieClient and instead runs through all outstanding ops periodically, timing them out as necessary.--The motivation for this change is to reduce the number of objects created per add/read request. With HashWheelTimer a TimerTask needs to be added to the Timer, which allocates and returns a Timeout object. We had to be careful to cancel this timeout on success.--The new approach is simpler, doesn't require any allocation per request, and doesn't require any cancellation. Functionally the end result is the same - very slow requests are timed out.--The patch also makes some additions to the original changes (due to the codebase moving since it was originally written).-- PendingAddOps are changed to use the same mechanism for quorum timeouts.-- The checkTimeout method is moved to the PCBCPool so we can run the check on non-connected PCBC instances. This is necessary for TLS.--Author: Ivan Kelly <ivank@apache.org>-Author: Siddharth Boobna <sboobna@yahoo-inc.com>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #817 from ivankelly/yahoo-bp-9;786da273b0f90c1b35b7244b0408959fd034d411
ISSUE #230: Enable checkstyle on the bookie tests--Descriptions of the changes in this PR:--With this change, checkstyle verification is enabled for the-entire bookkeeper-server package, and all packages use the same `suppressions.xml` file.--Master Issue: #230--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #830 from acoburn/checkstyle_test_bookie, closes #230;13c303f916b5b82702d73e2377b2caf75500243a
Race in PCBC connection if channel inactive before callback--There's a race in PCBC where if the channel is errored before the-connection callback occurs, the channel will hang around as a zombie-forever.--This caused a flake in-TestDisableEnsembleChange#testRetryFailureBookie, but the problem-itself could affect production code. This test hit it because it tries-to reconnect in a tight loop as a bookie is booting.--The error occurs because we only change state with channelInactive if-the channelInactive occurred on the channel that matches the currently-assigned this.channel. If the channel connects successfully, but-channelInactive occurs before the connect callback runs, the channel-will be closed, but the state will be transitioned to CONNECTED. No-more events will occur on the channel, so it'll hang around forever,-and all requests on the channel will timeout.--The fix is to check that the channel is active before assigning it to-this.channel and setting state to CONNECTED. If the channel is not-active at this point, then the else clause of this block will run-which closes the channel, and sets state to DISCONNECTED. In this-case, the next request will trigger a new connection attempt.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #827 from ivankelly/ensemble-flake;a5ca3a9235fecc44e60cca0d46ddb546c2438613
ISSUE #818: add api changes in release notes of 4.6.0--Descriptions of the changes in this PR:-add changes of BookKeeper constructor and EnsemblePlacementPolicy in release notes of 4.6.0--Master Issue: #818--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #822 from jiazhai/issue-818, closes #818;f14be643e9fdc4db39323bc98e2735cfb169e75e
Fix NOTICE and LICENSE--Descriptions of the changes in this PR:--- combine the NOTICE, LICENSE files into one for both src and binary distribution.-- make a few dependencies as `provided`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #820 from sijie/fix_notice_license;5dd324f65fbec5fab2d43a0d14bdf53adb32f9b3
ISSUE #230: Enable checkstyle on client tests--Descriptions of the changes in this PR:--This enables checkstyle verification on the client test-code in the bookkeeper-server module.--These changes are almost entirely related to whitespace, javadocs and import order.--Master Issue: #230--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #825 from acoburn/checkstyle_test_client, closes #230;dcc13052f1f43ff6d6078d12a4d3c8444967b651
Refactored EntryLogger Buffered channel--Porting https://github.com/yahoo/bookkeeper/commit/ecce14449b07e0b40434835bbc01d75d0a36880b from Yahoo branch.--Refactored entry logger to always use pooled `ByteBuf` when reading entries or scanning the log.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #824 from merlimat/entry-logger-refactor and squashes the following commits:--6ddb31d6 [Matteo Merli] Fix DoubleByteBuf readableBytes()-a6df2974 [Matteo Merli] Fixed padding length and journal test-bbe65eb8 [Matteo Merli] Removed BufferedReadChannel close since the buffer was not pooled anyway-c50f4683 [Matteo Merli] Added required changes to uses of BufferedChannel from Journal-6746d038 [Matteo Merli] Refactored EntryLogger Buffered channel;b7bfac88ffae8acd82cae05fe6236f5a7db3a796
Use netty DefaultThreadFactory everywhere to take advantage of fast thread local access--Merging https://github.com/yahoo/bookkeeper/commit/38ff21ad8bbd8ac8ec8a4898ef9ecf473fea94b7 from Yahoo branch.--Netty has a special `FastThreadLocal` class that is used in many places (eg: when borrowing a buffer from a pool). The mechanism in which it works is that the thread has to be created from a particular thread factory to take advantage of it (it adds a couple of fields subclassing the `Thread` class).--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #823 from merlimat/thread-factory;c682ecb076c9cf8b845917244acfc2bc575f4b9d
ISSUE #230: Enable checkstyle on some test classes--Part of #230, this enables checkstyle verification on some-of the test code. This does not do checkstyle validation on-the client or bookie package test code.--Enabling checkstyle on the entire test codebase would result in a _very_ large PR. This is an attempt to break it up into smaller pieces. The changes here are almost exclusively related to whitespace, javadocs and import order.--One public change of note is in `replication.AuditorLedgerCheckerTest`: the `_testDelayedAuditOfLostBookies` method is changed to `testInnerDelayedAuditOfLostBookies`.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #819 from acoburn/checkstyle_test, closes #230;d9f764f9590411c8c2e7c4e9f1a47f77b9ab987f
Use ConcurrentLongLongHashMap in EntryLogMetadata--Porting commits https://github.com/yahoo/bookkeeper/commit/74afc16d1c1e93739edf4a78801c5ccb6afd3883 and https://github.com/yahoo/bookkeeper/commit/eba3bbfbbaf58118c0c5736b56d3897a5928bc89 from Yahoo branch.--Currently the `EntryLogger` is keeping a `ConcurrentHashMap<Long, Long>` to keep track of amount of data stored in a single entry log file for each of the ledgers.--The amount of memory required is high because of the objects boxing. The `Long` used for key and value are 16 bytes each and the hash-map node will take another ~24 bytes.--Additionally, all these objects are created, stored for hours and then GCed, after being tenured.--By using `ConcurrentLongLongHashMap`, we eliminate the object boxing and the need for the "node" since it's a open hashmap. This helps reducing a lot the memory used by the bookie when storing a large amount of entries (54 --> 16 bytes).-Also since we store the items in `long[]`, this will not need objects and it will not affect GC.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #821 from merlimat/entrylog-metadata;143bd1952851ac70ace9d16c3708ae30dad2a0aa
ISSUE #568: Refactor EntryLoggerAllocator to enable preallocation--Descriptions of the changes in this PR:--Enable 'entryLogFilePreallocationEnabled' which is  never be used.--Author: Arvin <arvindevel@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #814 from ArvinDevel/issue568, closes #568;b69f1e4d63e3f7adf04a772bd5cef002c81bc311
Recycle responses callbacks--A response callback is created each time we receive a response from a-server, which can result in a lot of garbage in the fast path.--This change pools the callbacks.--This change was originally 729bd2d0 in the yahoo-4.3 branch.--Author: Ivan Kelly <ivank@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #809 from ivankelly/yahoo-bp-7;a7991e5616b0f78d3b80334774a5b7d63dabb8c9
BP-22: Separate closing ledgers from opening ledgers (#795)--State: Rejected--Reason: Rejected due to lack of agreement that the issues raised in the motivation are valid.;3abf2c7fa743efc72b48c13bdb8977ac64061744
BP-21:  New API close inconsistencies (#790)--State: Rejected--Reason: Rejected due to lack of agreement that the issues raised in the motivation are valid.;b07732e29df22acabb0a7b8198cdff41c04bb27b
Handle unexpected throwable in Bookie V2 request processors--Merging from https://github.com/yahoo/bookkeeper/commit/c54eafbe--When getting any exception, the request processor for V2 protocol must make sure to get some response back to client. In the specific case, it was some NPE that was thrown and not handled properly.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #813 from merlimat/handle-throwable;1d6b5506599accca30129348d52048b25766d1fa
Update the BP workflow--Descriptions of the changes in this PR:--- incorporate the feedback from JV last week: allow people to use google doc for writing a BP. Google doc is great for collaboration in general.-- incorporate Ivan's comment on workflow #761  : how to handle failed BPs. The principle here is BPs are in general good ideas, we should keep those records for future references. so add an instruction on merging the failed BPs.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #810 from sijie/fix_bp_workflow;b8dee21a253f4d6f449e53afa5596cc6c54b189c
ISSUE #805: some fix in release_guide.md--Descriptions of the changes in this PR:--during preparing release 4.6.0, there was some errors meet,-1,-`git tag -d ${VERSION} && git push apache :refs/tags/${VERSION}`-should be-`git tag -d release-${VERSION} && git push apache :refs/tags/release-${VERSION}`--2, .m2/settings.xml may not take effect for "Apache Nexus repository" setting, it may be not your "global settings file"--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>--This closes #811 from jiazhai/issue-805, closes #805;456451bbf925a3d3813238a378c794864f25cb36
ISSUE #230: Enable checkstyle on util package--Part of #230, this adds checkstyle verification to the util package in-bookkeeper-server.--A few notable changes:-  - in `util.HardLink`, the field `osType` becomes `OS_TYPE`.-  - in `util.LocalBookkeeper`, a few package-protected fields are marked private and changed to camelCase.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #815 from acoburn/checkstyle_util, closes #230;0ab3ea0bab5c3d3fe0c84c8a3843467f0bea31cd
Fix flake in TestPerChannelBookieClient--Flake is in testRequestCompletesAfterDisconnectRace. It tests a race-between disconnection and making a request. The flake occurred because-when the disconnection happened, the request would be errorred out,-and this would add a callback to the ordered executor. The test was-shutting down the executor before the callback was actually run (it-may not even have been added in some cases), and this was causing the-request to never complete, failing the test.--The fix is to move the shutdown of the executor to after the assertion-that the request has completed.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #816 from ivankelly/pcbc-flake;7b52db2fb58ac592b54a610b8afb0c9b42184386
Use concurrent open hash map to track pending requests in PerChannelBookieClient--ConcurrentOpenHashMap doesn't allocate a Map.Entry for each-insertion/lookup, so this reduces garbage in the fast path.--Original change 64ab580a in yahoo-4.3 branch.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #808 from ivankelly/yahoo-bp-6;e366d97df11c84e29fcc4aadaab1bb23b30cf9db
Fix checkstyle in PCBC--Two inflight PRs clashes to create a broken build due to-checkstyle being enabled. This patch fixes the checkstyle issue, which-was import order.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #807 from ivankelly/fix-style;d2f90de13d4d6c5da4c49d0d6c1a51dc0dbf6a49
Fixed simultaneus reads on same ledger/entry with v2 protocol--This change is coming from yahoo branch at yahoo/bookkeeperce7b0f7--With v2 protocol there's no way to disambiguate the read request since the completion key is made from (ledgerId, entryId).-This PR introduced an additional multimap to handle the conflicts (multiple simultaneus read requests for the same entry).--Author: Ivan Kelly <ivank@apache.org>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #720 from merlimat/concurrent-read-v2;a32a7f0eabf36ddc8310e9d3b506f2ab277102f1
ISSUE #230: Enable checkstyle on bookie and client--Part of #230, this adds checkstyle verification to the bookie and client packages in `bookkeeper-server`.--Descriptions of the changes in this PR:--The changes here are primarily cosmetic, but there are also two notable changes to point out:--1. In both `TopologyAwareEnsemblePlacementPolicy.TruePredicate` and `TopologyAwareEnsemblePlacementPolicy.EnsembleForReplacementWithNoConstraints` a `public static final` field was renamed from `instance` to `INSTANCE`. This is consistent with the use of an `INSTANCE` field in the `bookkeeper-stats` package. An alternative would be to introduce a public method `getInstance()`, but either way the checkstyle rules don't like a public constant field in lower case.--2. In `UpdateLedgerOp#updateBookieIdInLedgers()`, the `throws BKException` part of the signature is problematic and prevents the checkstyle validation from completing successfully. From what I can tell, that checked exception is never thrown; as such, I have removed that from the signature. I have also removed the corresponding guard from `bookie.BookieShell`.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #806 from acoburn/checkstyle_client_bookie, closes #230;7087fda4e91e9fe8974f9d36e01e275a08bf38f1
ISSUE #689: improve release guide for minor versions--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #777 from eolivelli/improve-guide-minor, closes #689;ee6d9233ae69433d198cb043700a538c4a7b0cbd
Fix bin/bookkeeper to work with release--Part of the assembly process prepends the package name to the-bookkeeper-server, which wasn't taken into account by-bin/bookkeeper. This change takes it into account.--It also stops the script from printing a warning if a directory-doesn't exist.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Jia Zhai <None>--This closes #803 from ivankelly/bad-script;a082e26129ef88f46f676e359011a5736e8dc7db
ISSUE #801: remove assembly plugin in root pom--Descriptions of the changes in this PR:-mvn release:prepare cmd will fail, for the wrong assembly plugin in root pom. This change remove it, for it has already in bookkeeper-dist/pom.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #802 from jiazhai/issue-801, closes #801;f671926f7fbc89e9bb20e2a3b5e937dc6b716cc3
Removed all per-entry allocations in Journal operations--This change was originally b2cc158a from the yahoo-4.3 branch.--Author: Ivan Kelly <ivank@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #798 from ivankelly/yahoo-bp-5;39a539e5c5a3381cad9e5e0da334c7f359e17c3b
ISSUE #230: Enable checkstyle for more packages--Part of #230, this enables the checkstyle plugin for the `replication` and-`server.http.service` packages.--Descriptions of the changes in this PR:--Most of the changes here are merely cosmetic. The only change of any significance is in the `RecoveryBookieService.RecoveryRequestJsonBody` class in which the JSON object fields had to be changed in order to conform to the Checkstyle rules: `bookie_src` to `bookieSrc` and `delete_cookie` to `deleteCookie`. Using a Jackson annotation (`JsonProperty`), however, means that these field names continue to be parsed and serialized as `bookie_src` and `delete_cookie`, respectively.--Author: Jia Zhai <jiazhai@users.noreply.github.com>-Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #800 from acoburn/checkstyle_replication, closes #230;257c21630ab93b6adccbf955899451bd550a1d07
ISSUE #230: Add Checkstyle to some packages--This is part of #230 and adds checkstyle verification to the following-packages in bookkeeper-server:--  - metastore-  - net-  - sasl--Descriptions of the changes in this PR:--Most of the changes are entirely stylistic, but there were a few minor functional changes:--  - In `metastore.MetastoreUtils`, the protected `logger` field was changed to `private` (it is not accessed from outside the class).-  - In `metastore.Value`, the package-protected `comparator` field was changed to `private` (it, too, is not accessed outside the class).--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #799 from acoburn/more_checkstyle, closes #230;356c091b66a2d8b76943f707a5bebfa7939719b5
ISSUE #659: Fix Checkpoint logic in SortedLedgerStorage--Descriptions of the changes in this PR:--- add a test case to reproduce the behavior--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Charan Reddy Guttapalem <reddycharan18@gmail.com>--This closes #677 from sijie/fix_checkpoint, closes #659;81cbba3cf620f2a6df48c0da6ee1ac019de24fbc
ISSUE #230: Enable Checkstyle on the proto package--This is part of #230 and adds Checkstyle verification to the proto-package in bookeeper-server.--The changes here should generally be non-controversial, but I would like to highlight one change for particular review. In the `PerChannelBookieClient` class, there is a `public static final` field called `txnIdGenerator`. The checkstyle rules require that such public fields are ALL_CAPS. So one option would be to change that field to `TX_ID_GENERATOR` (this would be a change to the public API).--The relevant diff is here: https://github.com/apache/bookkeeper/compare/master...acoburn:checkstyle_proto?expand=1#diff-e50ee2c1aec1539ea185a94605b0e550R143--However, that field is never used outside this class, so the other option is to make the field private and keep the name as-is. (Making the field private is also a change to the public API)--I chose the second option because the field seemed more like an internal field. If, however, the field should be left public, I can add a commit that changes the name to `TX_ID_GENERATOR` so that it passes the checkstyle rules.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #792 from acoburn/checkstyle_proto, closes #230;ba7db47ab912269eca160bc1112f46cc417688d1
ISSUE #230: Enable Checkstyle on the meta package--This is part of #230 and adds Checkstyle verification to the meta-package in bookkeeper-server.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #797 from acoburn/checkstyle_meta, closes #230;86b915ce845f4ee3c7c0eb2971e051368d061943
ISSUE 230: Enable Checkstyle on the conf package--This is part of #230 and adds Checkstyle verification to the conf-package in bookkeeper-server.--As with #792, most of the changes here should be non-controversial. However, as with #792, there is a constant field whose name needed to be renamed. `AbstractConfiguration` has a `protected static final` field called `defaultLoader`. This field is used in the two implementing classes, so keeping `protected` visibility seems right. So in this case, the field has been renamed to `DEFAULT_LOADER` while keeping the `protected static final` modifiers.--The changed line is: https://github.com/apache/bookkeeper/compare/master...acoburn:checkstyle_conf?expand=1#diff-b4f821552b13a688d62015e96092e08eR45--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #796 from acoburn/checkstyle_conf;77efe5a8ec69d3c53438eb8f7af2dd2339992388
ISSUE #787: Client should be able to get ledger metadata from Handles.--Descriptions of the changes in this PR:--- create a `LedgerMetadata` interface for exposing public information-- add `getLedgerMetadata` to Handle, so both WriteHandle and ReadHandle are able to access the metadata.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #788 from sijie/ledger_metadata_interface, closes #787;5f3496f740629ba4ea0d0abb3272ca2e6d8ccba7
ISSUE #784: LedgerEntries#close should not throw checked exception--Descriptions of the changes in this PR:--override `close()` in LedgerEntries to make it not throw checked exception.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <zhaijia@apache.org>--This closes #785 from sijie/dont_throw_exception_on_close, closes #784;d5774858934bdfd22c8e873c355722750c50f33b
Make distributedlog compiled with latest bookkeeper version--Descriptions of the changes in this PR:--There are code changes on PendingReadOp for new bookkeeper api in current master. DistributedLog uses PendingReadOp for some administration tools. So the current master doesn't compile with the latest bookkeeper version. This code change is to fix that.--The change here includes:--- bump bk to 4.7.0-SNAPSHOT (will switch to 4.6.0 after it is released)-- change to use the latest CompletableFuture in latest PendingReadOp. (this change doesn't target at making distributedlog work with new API)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #240 from sijie/sijie/use_new_ledger_api;089c2ef0db37ae6ba781f1c49951877c3dbf2f8a
ISSUE #765: Add `isClosed()` to ReadHandle--Descriptions of the changes in this PR:--add `isClosed` to ReadHandle, so distributedlog can use this for implementing readers.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #786 from sijie/is_sealed, closes #765;64650cfc3fc2f25393c71252341a37a03db5be15
ISSUE #695: add release notes for 4.6.0--Descriptions of the changes in this PR:-add release notes for 4.6.0.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #759 from zhaijack/issue-695, closes #695;58d0fc2dcf327beabe31cda54b461bf9a6bbbafa
Tests wait for client to see started bookie--Up until now we were only waiting for the bookie to exist in the-bookie list, after which we triggered a read. However, when the-registration changes went in, the read wasn't actually populating the-mechanism used to select bookies, so we ended up momentarily having-unusable bookkeeper clients until the correct read triggered. This-resulted in flakiness in random tests.--This change makes it so we wait until the client has seen a bookie-before startBookie will return. It also makes sure that reading the-bookie list actually populates the bookie selection mechanism.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #775 from ivankelly/no-enough-bookie-flake;24d53cb241d0cd08c4fb99101d963bceb9b0d8cb
ISSUE #544: Bootup cookie validation considers an empty journal to signify a new bookie--Descriptions of the changes in this PR:--- read cookie from registration manager as the source-of-truth (for all potential options)-- remove duplicated code between checkEnvironment and checkEnvironmentWithStorageExpansion--Author: Sijie Guo <sijie@apache.org>-Author: Ivan Kelly <ivank@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--This closes #712 from sijie/fix_cookie_issue, closes #544;819443cd5efc9393236d76ca2a5e2284efea0e22
BP-20: Github workflow for bookkeeper proposals--Descriptions of the changes in this PR:--Implementing a github workflow for bookkeeper proposals, so all the bookkeeper proposals can be reviewed as code changes, and they can be maintained in the same way as how we maintain documentation.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia03@gmail.com>--This closes #760 from sijie/BP_20;87ffad969c160b0e82944a6638f1710347b0bbeb
Don't print out redundant JMX notice--Users don't really care that JMX is enabled by default, so don't print-it out.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #782 from ivankelly/no-jmx;d207432375e48c901ee13684ec1c395eeded9389
Explicitly search for bookkeeper-server jar--Rather than listing all jars, and excluding some exceptions, search for-jars which match a specific pattern, namely:--  bookkeeper-server-[version].jar--Where [version] may include numbers, dots and optionally -SNAPSHOT.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #772 from ivankelly/fix-local-bookie;90a82c278dab9c878e649d5aa8b0da9580287830
ISSUE #230: Enable Checkstyle on the tls package--This is part of #230 and adds Checkstyle verification to the TLS package in `bookkeeper-server`.--Author: Aaron Coburn <acoburn@amherst.edu>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #779 from acoburn/checkstyle_tls, closes #230;ad546aeee2ce77213bfd99c456441a274013a1bb
Make LedgerEntries an Iterable<LedgerEntry>--This seems to have been overlooked in the previous changes. As the title-says, this change just adds the Iterable<LedgerEntry> to the interfaces-from which LedgerEntries extends.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #770 from ivankelly/ledger-entries-iterable;dc49b8b5c5a5e8d914cb80d4bc18051db8cc5313
ISSUE #553: Documentation for new fluent API--Descriptions of the changes in this PR:--- Add documentation for the new fluent API: create/open/delete, append/write/read, createadv--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #764 from sijie/api_documentation, closes #553;2915f55c9714fcfb88ad443f5d957b786736ecbd
ISSUE #693: add interface and implementation of LedgerEntries--In the new API proposed in #506 , we return Iterable<LedgerEntry> for read entries. It is a bit problematic when returning multiple iterators and have no ability to release the entry buffers hold by ledger entries.-In this change, the implementation of retainIterator() increased the reference of the buffers when creating an iterator, it will be easy for byteBuf's management; it also make LedgerEntries a recycle object, and it is returned to the pool when #close() is called. on #close(), it also releases all the references to release resources.--Descriptions of the changes in this PR:-1. add interface LedgerEntries;-2. add implemtation of LedgerEntries;-3. fix related build and test errors.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: ivankelly, sijie, eolivelli--This closes #727 from zhaijack/issue-693, closes #693;a6f4b792270194474649eda9261635c24c218b0a
ISSUE #763: Javadoc layout should reflect new modules--Descriptions of the changes in this PR:--- add `org.apache.bookkeeper.client.api` in `BookKeeper Client (New Fluent API - Experimental)`-- move prometheus package to `BookKeeper Stats Providers`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Jia Zhai <zhaijia@apache.org>--This closes #768 from sijie/fix_javadoc_layout, closes #763;b20d95469e68acd7b1757e58fcfad0d04e26fec3
Issue #753: Allow option to disable data sync on journal--Context in #753--For deployments where a RAID battery-backed cache is not available and where durability is not a requirements, we should allow bookies to rely on page cache and relax durability.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #754 from merlimat/option-to-disable-sync-master, closes #753;8e056d4dd0262f5ed5245a8dc8abe608b737f6f9
ISSUE #750: support ByteBuf, ByteBuffer, byte[] in both WriteHandle, WriteAdvHandle, ReadHandle--Descriptions of the changes in this PR:--- WriteHandle supports append byte[], ByteBuf and ByteBuffer-- WriteAdvHandle supports write byte[], ByteBuf and ByteBuffer-- LedgerEntry returns byte[], ByteBuffer and ByteBuf--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #755 from sijie/issue_750, closes #750;7108ab4b8e8116dd48c24fdaf845a28e048d7836
ISSUE #766: Bump master to 4.7.0-SNAPSHOT--Descriptions of the changes in this PR:--The master version was not updated when creating `branch-4.6`.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #767 from sijie/bump_master_version, closes #766;3b02baa43dfd9f55c81d57299f1ec4f26d0aa14d
fix releases.md, add release date for 4.5.1 and clean up file--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #758 from eolivelli/updaterelmd451-460;d446b3c5daa8a2593f55c1a166e99e6989e8bcb5
Add release 4.6.0 to releases menu--Descriptions of the changes in this PR:--The documentation for release `4.6.0` was copied by #696. But this release is not updated in the releases menu.--This change is generated by running `site/scripts/release.sh` for preparing 4.6.0 release.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #752 from sijie/update_4.5.1_release_date;d120b7f136ab71daf95757145ea4c000c7145686
ISSUE #688: add bookkeeper-all package and update notice files--Descriptions of the changes in this PR:--    - move src/ to bookkeeper-dist/src/-    - built two packages in bookkeeper-dist: one is `bookkeeper-server` - server only package with prometheus stats provider and vertx http server,-      the other one is `bookkeeper-all` - includes all packages.-    - remove assembly plugin from bookkeeper-server module-    - update release guide--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #737 from sijie/add_slim_module, closes #688;e086f1dec6af8120e692862f29c2f77565760025
ISSUE #731: refine LedgerEntry interface and implementation--In LedgerEntry interface, getEntry() and getEntryBuffer() have completely different behaviours. getEntry() releases bytebuf automatically, while getEntryBuffer() returns the bytebuf (if you don't call getEntry, you are responsible for releasing the entry buffer.--In this change:-make getEntry() reenter-able; make LedgerEntry implement AutoCloseable; LedgerEntry is responsible for releasing the bytebuf it is holding.--Descriptions of the changes in this PR:-1.  add `close` and `duplicate` in `api.LedgerEntry`,-1.  LedgerEntryImpl implements `api.LedgerEntry`,-1.  client.LedgerEntry doesn't implement the new api. it wraps an `api.LedgerEntry`,-1.  add `close` in api.LastConfirmedAndEntry."-1.  fix build and test errors.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #738 from zhaijack/issue-731, closes #731;87d1afcc329d7261f19a6310ca9a7cf2acce4dee
issue #236: shaded jar lose necessary bk jar to execute--Descriptions of the changes in this PR:-- after bump to bk4.6, add bk-proto bk-http dependency to shaded jar--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #237 from ArvinDevel/addBkDependencyInShade, closes #236;89d45bc550f89e16c967c5e691bcc4f6f7d6f2aa
ISSUE #747: Reorder releases menu - 4.5.1 should appear before 4.5.0--Descriptions of the changes in this PR:--- 4.5.1 should appear before 4.5.0-- bump dlog version to 0.5.0--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #748 from sijie/issue_747, closes #747;00a286be3fa1795b4b7a12a7ce417198d4f46710
ISSUE #550: add readLastAddConfirmedAndEntry in ReadHandle for long poll read--Descriptions of the changes in this PR:-1, add a class LastAddConfirmedAndEntry and metnod readLastAddConfirmedAndEntry() in ReadHandle;-2, add implementation for readLastAddConfirmedAndEntry in LedgerHandler;-3, add testcase in BookKeeperApiTest;-4, remove un-used imports, break down long lines, fix wrong comments.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #729 from zhaijack/issue-550, closes #550;c9a1b8adbb2eb4e7bd2fe9d55648ac684828fe8f
ISSUE #674: Documentation for HTTP endpoints--Descriptions of the changes in this PR:-Add a document for http endpoints.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #721 from zhaijack/http_doc, closes #674;c8c3f6745b57cbae6d01deb31ab445ff29e16152
Release notes for 4.5.1--This patch contains new site docs for 4.5.1--Author: eolivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #678 from eolivelli/releasenotes451;3fab8c69e2688cecf5849fce305f708b96542dbb
ISSUE #739: Move the implementation of http services to be under server package--Descriptions of the changes in this PR:--bookkeeper-http module provides the framework for http admin rest api. it is using 'org.apache.bookkeeper.http' and 'org.apache.bookkeeper.http.service. the http package inbookkeeper-server` is reusing these two packages. it is not good for two modules sharing same package name, it is going to be confusing javadoc.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #740 from sijie/http_impl, closes #739;2b660b1e06a9b0deac011d0d6b8a2e990bf974b9
ISSUE #734: bookkeeper-benchmark is broken after protobuf files are moved to bookkeeper-proto--Descriptions of the changes in this PR:--Problem:--The issue was introduced after protobuf files are moved to bookkeeper-proto. so the protobuf is not shaded correctly.-So in bookkeeper-benchmark, it is conflicted with the protobuf version introduced by hadoop.--Solution:--- update the bookkeeper-server pom.xml to shade protobuf correctly-- remove hadoop dependency from bookkeeper-benchmark.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #735 from sijie/protobuf_issue, closes #734;9b538aff7da5cba15ae59b70e0b0c9bd2464dca3
ISSUE #713: Mark new API as experimental--Descriptions of the changes in this PR:--mark new api as experimental - `InterfaceStability.Unstable`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #736 from sijie/mark_api_experimental, closes #713;07bb94f25a49c6f28c5b33ce930c0e2a3601db83
ISSUE #726: Unit Tests failure with BKMetadataVersionException--Descriptions of the changes in this PR:--Problem:--The problem is introduced after making storing ctime optional. the verification become inconsistent because the way how ctime was assigned and compared. It causes the test cases failing in #726--Solution:--This change is to change `isConflict` to ignore comparing ctime if client disables storing system time as ctime.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #730 from sijie/fix_ctime_issue, closes #726;c9a150b58fb1c8636dabbd7930bc3acffbf89881
ISSUE #724: fix wrong link for slack signup--Descriptions of the changes in this PR:-Change the link of slack signup from http://apachebookkeeper.slack.com/ to https://apachebookkeeper.herokuapp.com/ in https://bookkeeper.apache.org/community/slack/ and click the self-register link.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #725 from jiazhai/issue-724, closes #724;e253ca32eb2f9f06b7525b85e7fa2ca870e6d0fa
Bookies should not queue read request indefinitely--Integrating some changes made to Yahoo bookkeeper by Matteo Merli.--The apache bookkeeper thread pool in use by OrderedScheduler is different, and does not have access to setting a queue size limit, so I created QueueAssessibleExecutorService, and check the queue size instead.  Other than that, this code change is pretty similar to Yahoo's.--Original bug description for this change:--Since we are using a thread pool to handle read requests in bookies, we have seen that when the Bookie read IO is maxed out, the requests are being accumulated in the bookie.--Essentially, the bookie is busy serving read requests that have already been timed out on the client side (end to end read latency can reach hours..). The queue keeps growing indefinitely, leading to OOM errors and bookie restart.--All unit tests pass for me locally with this change.--Author: Aaron Gresch <agresch@yahoo-inc.com>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #706 from agresch/agresch_cms1254;ed7696b130a0b7b6fb63b4d37c4a873fa1f8f96f
ISSUE #694: ReadHandle doesn't have getLength() method--Descriptions of the changes in this PR:--- add `getLength()` to ReadHandle interface-- add `getLastAddPushed` to WriteHandle interface-- add unit tests and fix issue in MockBookKeeperTestCase--Author: Jia Zhai <jiazhai@users.noreply.github.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #715 from sijie/api/support_get_length, closes #694;388d4a4c73dfe0f5ed0adc9f77f37ffd9457d117
ISSUE #612: Make bookie recovery work with recovering multiple bookies--Descriptions of the changes in this PR:--This is a change ported from twitter branch.--- Enable recovering multiple bookies in bookie shell-- Add a unit test for BookieShell.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #714 from sijie/recover_command_fix, closes #612;dad7e2ce0d1cf8f04c7e2f128900ea69792c948d
ISSUE #490: Add a flag to not serialize `ctime` field--Descriptions of the changes in this PR:--This request is for DL bookkeeper version upgrade. Because twitter's bk version doesn't include this change, so any ledgers written by new bk version will fail to be read by old version. To simplify the upgrade story, it is good to allow not serialize ctime field.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #718 from sijie/flag_to_not_serialize_ctime, closes #490;a9b64e61598a987ffa6249ab398215436a7928f2
ISSUE #716: PendingAddOp accesses a released ByteBuf--Descriptions of the changes in this PR:--- release `toSend` bytebuf only when a PendingAddOp is recycled.-- fix MockBookKeeperTestCase to run callbacks in the same executor thread.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #717 from sijie/issue_176, closes #716;dd7dc6399504b246c65f7a09657597578b81cb6c
ISSUE #691: Move generated files into their own module--Upcoming changes are using GRpc in conjunction with protobuf. GRpc-generates code that created deprecation warnings when compiled with-java 8, so this change moves all generated code out to another module,-so that we don't have to turn off -Werror for all code.--In any case, at some point we should split the bookkeeper client out-from the server module, at which point we would need the definitions-on a common place.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #711 from ivankelly/proto-module, closes #691;e713953aec8523e1018e0eba458c019ec9ba1f9f
ISSUE #707: NOTICE file should not contain references to JLine--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #708 from eolivelli/notice-jline, closes #707;d0c11d0bf982208008c1f45e62038a33e7d9a73d
BOOKKEEPER-1040: Use separate log for compaction and add transaction support--Problem:-Compaction might keep generating duplicated data which would cause disk full.-This is because we don't have transactional operation for compaction. So if compaction-keeps failing in the middle, bookie would end up with a lot of garbage data.--Change:-1. Introduce abstract class AbstractLogCompactor with an interface compact().-2. Move the existing compaction logic to a separate class called EntryLogCompactor.-3. Introduce transactional compaction, we can recover an incomplete compaction or rollback a compaction failure.-4. Add an configuration to enable transactional compaction--Potential Risk:-1. No risk if we keep using the default compactor.-2. If we choose to enable transactional compaction with separate log file, we need to be careful about it, since we use a separate log for compaction, if we have a lot of old small ledgers in the bookie, we will end up with a lot of small entry log files. And this will potentially cause bookkeeper "Too many open files" because GC will scan all the entry log files and keep them open.--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #704 from yzang/yzang/BOOKKEEPER-1040;3392beee5c70abe36d36604723e14d97b7764be9
Landing pages documentation fixes--There were a few "broken windows" on the current landing pages for the different versions of BookKeeper, including mis-applied code backticks, an incorrect HTML code (`&trades;` instead of `&trade;`), etc.--Author: Luc Perkins <lucperkins@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #702 from lucperkins/bugs/docs-main-page;0ae8abc354c4c7706232aabf474ea37afea90fc2
ISSUE #699: Docker healthchek is failing #699--The docker healthcheck is failing because it's trying to run the-bookkeeper command without specifying a path.--Adding the full path to the command fix this issue.--Signed-off-by: Antonio Ojea <antonio.ojea.garciagmail.com>--Descriptions of the changes in this PR:--(PR description content here)...--Author: Antonio Ojea <antonio.ojea.garcia@gmail.com>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #700 from itsuugo/issue#699, closes #699, closes #699;cbf6668af320135af65c4590385a29fcf6d8d6c8
ISSUE #696: copy site/docs/4.5.0 to site/docs/4.6.0--Descriptions of the changes in this PR:-copy site directory in order to start new release for 4.6.0,-and then documentation changes of release 4.6.0 will be based on this, to make changes more clear.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #698 from jiazhai/issue-696, closes #696;8b2ead67bc895c9e6bfe18228e949da94583230b
fix merge script (#692)--The merge script is broken due to a typo in 4c2e90d2536676f14df944c5d8b4288362aa48b9;2291b51ab96b4b460b05dbe34fb50c5ccde58e2c
ISSUE #501: Fix race in CompactionTest--testMinorCompactionWithNoWritableLedgerDirsButIsForceGCAllowWhenNoSpaceIsSet-was failing regularly on jenkins. The issue was that it was trying to-kick off a forced garbage collection by setting the force flag and-triggering. However, in some cases another GC would be running and-would clear the flag after it had been set, but before the trigger was-called.--This patch adds a new form of triggering which allows the caller to-explicitly specify which flags will be active for the GC run.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #690 from ivankelly/make-compat-fail, closes #501;3ce2fb7ed510976413df07b00c81c3383f5494d1
ISSUE #685: Merge script: make DEV_BRANCH_NAME configurable--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #686 from eolivelli/fix/issue-683-merge-other-branch, closes #685;4c2e90d2536676f14df944c5d8b4288362aa48b9
ISSUE #681: Deploying bookkeeper in k8s using StatefulSets--Descriptions of the changes in this PR:--Provide a yaml file to deploy bookkeeper in k8s using [StatefulSets](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)--Author: Sijie Guo <sijie@apache.org>-Author: Ivan Kelly <ivank@apache.org>-Author: eolivelli <eolivelli@apache.org>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Jia Zhai <None>--This closes #682 from sijie/k8s/statefulsets, closes #681;952cedac10da487c72b7974152242dbc46349978
Recycle AddRequest/AddResponse objects--This change was originally afd0ecb6 & 75bf0fa1 on the yahoo-4.3 branch--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #665 from ivankelly/yahoo-bp-2;e202d955a022a501ea49bc5906c36b38bdbc50df
Update exception handling in constructing bookkeeper client;f30766e95d5f0b284bb74edf65edee052e257e55
Fix DistributedSchedule.WriteSet compilation issue--DisributedSchedule writeset structure is changed in recent 4.6.0-SNAPSHOT version;030aefa7dc97483886699efdcf07364f7020ef5e
ISSUE #666: Introduce registration client for bookkeeper client to do bookie discover--Descriptions of the changes in this PR:-while in BOOKKEEPER-628, It is trying to improve/generalize the bookie registration process.--This PR follows the work of #663, which provide bookie side registration, and it is for client side work, it tries to introduce RegistrationClient for bookkeeper client to do bookie discover.--This PR follows the work of #663, which provide bookie side registration,--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #667 from zhaijack/client_registration2, closes #666;c4c8069456a53669576569389ee45f4ed0e9654c
Recycle PendingAddOps--Avoid creating a new PendingAddOp object for each entry added, thus-saving on garbage.--Originally commit 55ba4723 on the yahoo-4.3 branch.--Author: Ivan Kelly <ivank@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #664 from ivankelly/yahoo-bp-1;34e8bf200c6f3797bd6fa4c5d86646e9eb7f0d3b
Copy site from 4.5.0 to 4.5.1--Copy site directory in order to start new release notes for 4.5.1--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #680 from eolivelli/release-notes-451-copy;c733494bfb42a00a91594730f2241df3ff0fb84f
Recycle instances of callback to obtain a PerChannelBookie client--This change was originally commit e2e77863 in the yahoo-4.3 branch.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #679 from ivankelly/yahoo-bp-3;1c7d103431c15335cc6d6eae0e9c2197b58c1ad3
DistributionSchedule uses custom wrapped int[] rather than HashSet--This avoids the autoboxing on Integers and allocations of cells for-the hashset.--This also implies using wrapped int[] object for the write set in the-DistributionSchedules and PlacementPolicies.--This patch was originally submitted as dc7933b on the yahoo-4.3-branch, though this has been modified extensively to remove the-dependency on carrotsearch hppc and to allow it to work with placement-policies which didn't exist at the time of the original patch.--Author: Ivan Kelly <ivank@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #657 from ivankelly/yahoo-backports;8e20a80b3d22ac1d14ba7a8f2046bdbbe5e95a44
DLFS - A FileSystem API wrapper over dlog API--Descriptions of the changes in this PR:--- FileSystem API wrapper built over dlog API--(This is based on initial implementation from gerritsundaram at #43)--Features supported:--- create and append files-- open files for reading-- input stream and output stream for reading and writing data-- list files-- get file status-- rename-- mkdir--Features aren't supported:--- truncate-- currently there is no clear distinguish between file and dir-- only support delete recursive--(This change includes small changes for #224 #225 #226 ).--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #227 from sijie/fix_create_log;26680c1507949bd8678af987a60fb3f5342fb1a6
ISSUE #675: Enable checkstyle in a few packages--These packages include:--- feature-- processor-- shims-- stats-- streaming-- versioning-- zookeeper--not fully enabled in conf package.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #676 from sijie/fix_checkstyles, closes #675;502c6b1e4b9d65a7ebd373eb6177e925648880f8
ISSUE #265: Add persistable bookie status--Descriptions of the changes in this PR:--- Add support for persisting bookie status-- Add configuration to enable/disable this feature-- Add test cases-- Improve bookie status stat--It also includes changes for BOOKKEEPER-754 (flush ledger storage after replaying journal)--Author: Sijie Guo <sijie@apache.org>-Author: Yiming Zang <yzang@twitter.com>--Reviewers: Yiming Zang <yzang2016@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--This closes #266 from sijie/server_side_crc32, closes #265;3a20fe0ab6c0259ae9143641105c46e48f625f7c
ISSUE #596 ISSUE #583: Auto replication should honor ensemble placement policy--Descriptions of the changes in this PR:--This pull request ports the changes from [twitter/bookkeeperfc7e171](https://github.com/twitter/bookkeeper/commit/fc7e171135a58cddb9e91f5f614b3ceb6f9f9fee)--The changes include:--1. when bookkeeper admin re-replicates a ledger, it will pick a bookie from the available bookies in the cluster to satisfy the placement constraint. (#596)-2. hence, remove `targetBookie` from ReplicationWorker, because the parameter will volatile the placement constraint. (#583)-3. at the same time, change `LedgerFragement` to represent the number of bookies that need to be check and replicate. a) the ledger checker can use the correct bookie index for verifying the existence of entries in a bookie (for stripping case) b) only read entries one time when need to replicate them to multiple bookies.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #641 from sijie/twitter_autorecovery_fixes, closes #596, closes #583;6fcabfc80c5bd6cdfa9252cdfc4ed209cc0620a6
ISSUE #662: Introduce Bookie Registration Manager for bookie server--Descriptions of the changes in this PR:-While in BOOKKEEPER-628, It is trying to improve/generalize the bookie registration process.-This PR is for bookie side, it tries to introduce Bookie registration manager for bookie server.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #663 from zhaijack/bookie_registration, closes #662;e9b857092703719c9ea38a3a74107fe5114af94a
Recycle instances of WriteEntryProcessor and ReadEntryProcessor--merge of some changes from Yahoo's repo--Author: Aaron Gresch <agresch@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--This closes #669 from agresch/agresch_recycle_entryprocessor;767e4556b7f5cc523b127e7987cc442f707699d9
Fail earlier when encountering DNS issues--We had some DNS issues today and various TestRegionAwareEnsemblePlacementPolicy tests were failing for me.--The LOG warning in RackawareEnsemblePlacementPolicyIml was not printing the right variable, which would have given a clue.--Additionally, the repp.myRegion was set to UNKNOWN, causing incorrect code flow.  Added an assert to kill the test as soon as this occurs.--Author: Aaron Gresch <agresch@yahoo-inc.com>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #658 from agresch/agresch_dns_failure;afcaade7c4c866a595b52ce71ee58b19352b2dbb
ISSUE #606: Enhancements in developer environment--Improvements in maven configuration in order to speed up development--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>--This closes #661 from eolivelli/plugins-upgrade, closes #606;0e13f700f662f20445094115a75f00e39f88565d
ISSUE #226: ByteBuf.release() was not called before it's garbage-collected--Descriptions of the changes in this PR:--the problem is a new entry buffer was allocated when closing log segment writer. the entry buffer is never used and also never recycled. It causes an annoying logging.--the fix is to assign a dummy entry writer which basically rejects writes, when closing a log segment writer. it would prevent leaking bytebuf.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #230 from sijie/fix_bytebuf_release_pr, closes #226;54268cee2960ccba62fc984c4ae86997abb6e572
ISSUE #224: listing logs should exclude <default>--Descriptions of the changes in this PR:--exclude `<default>` from listing logs--(the tests are covered by #227)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #229 from sijie/fix_listing_log_pr, closes #224;3a1499044b64832635affcfaf6657725bc01411b
Issue 225: Create log should create missing path components--Descriptions of the changes in this PR:--reuse the methods used by `rename` to create missing path components.--(the test is covered by #227)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #228 from sijie/fix_create_log_pr;dfe465cdd0684bbb348d106b737acf431f29351a
Pool AddCompletions--To avoid generating garbage in the fastpath.--Author: Ivan Kelly <ivan@midokura.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #649 from ivankelly/pool-completions;496843893dfb91c237cbd5ae1f245f90304ea34b
Pool the V2 keys--To generate less garbage in the fast path.--Author: Ivan Kelly <ivan@midokura.com>-Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #648 from ivankelly/pool-keys;70e4bbe437f81f2b226480d7c20999737f686787
Fix a typo in PCBC logging--All ops had writeLac in their logged text, which is confusing--Author: Ivan Kelly <ivan@midokura.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #647 from ivankelly/pcbc-typo;8ca0dd414c1b4519aeb8014a0b65d60318f84f5c
ISSUE #209: Support rename log--Descriptions of the changes in this PR:--- add rename operation in `Namespace`-- add rename operation in `LogStreamMetadataStore`-- implement the rename operation use zookeeper `multi` operation--Author: Sijie Guo <sijie@apache.org>-Author: Shoukun Huai <shoukunhuai@gmail.com>-Author: Arvin <arvindevel@gmail.com>--Reviewers: Jia Zhai <None>--This closes #210 from sijie/4_support_rename_pr, closes #209;6e7237c751949d101bba2dac93bd3a81200633c7
ISSUE164: Move findbug settings files to distributedlog-build-tools--Descriptions of the changes in this PR:--Move findbug settings files to distributedlog-build-tools,-and a little change to bk-shade: add bk-common dependency and unshade netty.--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #216 from ArvinDevel/issue164;ff6ec1905e645d45e7857cc928c37255a81b592d
ISSUE164: Move findbug settings files to distributedlog-build-tools--Descriptions of the changes in this PR:--Move findbug settings files to distributedlog-build-tools,-and a little change to bk-shade: add bk-common dependency and unshade netty.--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #216 from ArvinDevel/issue164;b6852900b5a538a21be816ec8707b4cb8b07d3d0
ISSUE164: Move findbug settings files to distributedlog-build-tools--Descriptions of the changes in this PR:--Move findbug settings files to distributedlog-build-tools,-and a little change to bk-shade: add bk-common dependency and unshade netty.--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #216 from ArvinDevel/issue164;346e3a92be09bc294fbd4d964a7fc394795cee4f
Increase timeouts in TestDisableEnsembleChange--In some narrow cases, if we manage to connect to the bookie, but the bookie-hasn't fully initialized, an add entry message will be dropped, and the-client will wait for the timeout to complete. The timeout is 5 seconds-by default, which was 5x the timeout in the test. This patch increases-the test timeout to 10s, which should give enough time for the addEntry-to fail and be retried.--Author: Ivan Kelly <ivan@midokura.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #646 from ivankelly/ensemble-change-test;51a58cbe3ad6ca7833f433aa9b845480ee690e57
Fix concurrent v2 reads on the same ledger/entry--Original fix from by merlimat in the yahoo-4.3 branch--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #645 from ivankelly/con-read-v2-fix;99bcf09f6d5bbcef2f4c5228cd70e023c2348b03
ISSUE #211: Support listing logs by prefix--Descriptions of the changes in this PR:--- extend `getLogs` to `getLogs(prefix)`, so it provides a filesystem `listFiles`-like semantic.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #212 from sijie/5_support_list_logs_by_prefix_pr, closes #211;9f55ccc7d75a4beedb96aaaeb0a9ca1357977482
Fixed ref counting release on read errors--Original change by merlimat in yahoo-3.4 branch--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #644 from ivankelly/fix-ref-read;fd477f6310a512e76fa3284b100d6e11411939b8
ISSUE #207: Support getFirstLogRecord--Descriptions of the changes in this PR:--- support getFirstLogRecord--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #208 from sijie/3_get_firstrecord_pr, closes #207;84ecaa8201bb97a041ed733ba015e2fe62d39a56
Issue 201: Fix the flaky test TestBKDistributedLogManager.deleteDuringRead--This closes #204, #201;b737e9c77eaba28d6498691c968901f3c53d2a89
ISSUE173: Implement AutoCloseable in BKDistributedLogNamespace--Descriptions of the changes in this PR:--Implement AutoCloseable in BKDistributedLogNamespace--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #214 from ArvinDevel/issue173;ecca567eb7f51355e2196e07b0400e2f8b16d026
ISSUE #213: Correct logger name in BKLogWriteHandler--correct logger name in BKLogWriteHandler--Descriptions of the changes in this PR:--(PR description content here)...--Author: Shoukun Huai <shoukunhuai@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #215 from shoukunhuai/issue-213, closes #213;4462bc31a6ac40b94efd2184e54e35cbc568199d
Use ByteBuf for entrylogger reads--Original patch from merlimat in yahoo-4.3 branch--Author: Matteo Merli <mmerli@yahoo-inc.com>-Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Ivan Kelly <ivank@apache.org>--This patch had conflicts when merged, resolved by-Committer: Enrico Olivelli <eolivelli@apache.org>--This closes #640 from ivankelly/refcount-for-read;1dc9789e89a6bf167ed965edb1ab51fbc449d897
Recycle buffers used in EntryLogger#addEntry--To avoid creating a buffer and letting it go out of scope and be GC'd-each time.--This change was originally made by merlimat in the yahoo-4.3 branch.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>, Ivan Kelly <ivank@apache.org>--This closes #639 from ivankelly/recycle-buf;d31dcbf6ba3a737d66ec3958f8443b007d4e5fad
Fix for BookKeeperBuildersTest--Previous findbugs fix broke it.--Author: Ivan Kelly <ivan@midokura.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #638 from ivankelly/bkbuildertest-fail;7254090d6a822e3c9c244c46fdb354bf56ddb2f3
ISSUE #559: Fix findbugs error on SyncCallbackUtils--Fix FindBugs warning BC_UNCONFIRMED_CAST in  class SyncCallbackUtils--Author: eolivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>, Jia Zhai <None>--This closes #560 from eolivelli/findbugs-synccallback, closes #559;1bd7a80bd295b8e9c82281764864ec949222b5cb
BOOKKEEPER-1062: Fixed the race in AuditorLedgerCheckerTest--Descriptions of the changes in this PR:--This fixes the race condition in the auditor between read only bookies and available bookies.  But because I am not sure of the performance impacts to modifying getReadOnlyBookies, I have opted to add in a new getROBookies.  But I am happy to change it.  This pull request is mostly to show my work and see what others think.--Author: Robert Evans <evans@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #556 from revans2/BOOKKEEPER-1062;40a7f1de440e6aec0b6640fc34a0ec7460c29ab7
ISSUE #561: Remove exec commands to start in the shell pid--Author: Ali Ahmed <a.ahmed@streaml.io>--Reviewers: Enrico Olivelli <eolivelli@apache.org>, Jia Zhai, Sijie Guo <sijie@apache.org>--This closes #557 from aahmed-se/master, closes #561;7d7497b70507ea3d31b184ebe04d98c733e2cf5b
ISSUE #506: BP-15 New CreateLedger API--BP-15 New CreateLedeger API-Introduce new org.apache.bookkeeper.client.api package-Introduce new Mockito based test suite for BookKeeper client--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie.apache.org>, Ivan Kelly <ivank@apache.org>--This closes #549 from eolivelli/bp15-createledger-api-2, closes #506;bd50cacd2b759d53b06a2356c5a9369b6100d635
Avoid copying bytebuf for constructing log record to write;9d0f5b00ac82d37f57a67984c731d95a1895e700
Fix the flaky test TestBKDistributedLogManager.deleteDuringRead;2de1f6dbd278e518c19378748606646158e9bad3
ISSUE #197: Provide a guide for running on k8s--Descriptions of the changes in this PR:--add one page for how to deploy on k8s. it is based on http://bookkeeper.apache.org/docs/latest/deployment/kubernetes/ and use distributedlog image and add instructions on how to create distributedlog namespaces and run benchmark.--This change is based on #196--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #198 from sijie/add_docker, closes #197;c2bf327c907080e2ec40c460dcf9c768fc0699d1
ISSUE #520: Add more http endpoint--Descriptions of the changes in this PR:--#278 introduces BookKeeper Http Endpoint module. However there are only two endpoints, which is “/heartbeat? and “/api/config/serverConfig?. In order to fully leverage the http modules, The goal is to add more endpoints to this modules.-Please reference BP-17 for more details.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #521 from zhaijack/http_endpoint, closes #520;95373234a273920fadc06742479ddcc4e603fa1b
ISSUE #547: Allow load extra lifecycle components when running a bookie server.--Descriptions of the changes in this PR:--- make a common `ServerLifecycleComponet` for the components loaded by a bookie server-- add a flag to allow start extra components.-- add test cases--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #548 from sijie/loadable_components, closes #547;7d3d02e588c1a06f195533c48c5af8149b813978
ISSUE #525: Refactor PerChannelBookieClient--There's a lot of duplicate code in PerChannelBookieClient, particularly in the completions. It makes it more difficult to add anything to the class.--Concretely the patch:-- Factors out common code from PCBC completions-- Makes erroring out a member of completion classes-- Refactors out writing and flushing messages, so all RPCs use same code path-- Moves timeout handling into CompletionValue-- Moves response handling into completions-- Moves logging and status conversion into a common method--Author: Ivan Kelly <ivan@ivankelly.net>--Reviewers: Enrico Olivelli <eolivelli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #526 from ivankelly/refactor-pcbc, closes #525;79f359ff9b77cfce23d52d7a99715768497ee00f
ISSUE #534: Download docs reference old release--Descriptions of the changes in this PR:--use the latest release in the download page--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #539 from sijie/fix_documentation, closes #534;655057cf2fff39dcb1be3d508799080a373efc78
ISSUE #540: BookieServer failed to start because lifecycle component name is not provided--Descriptions of the changes in this PR:--- add component name `bookie-server`-- remove the catch block-- fix the prometheus stats provider package name in configuration files.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #541 from sijie/fix_lifecycle_stack, closes #540;9694fd263a3ee5e03740f99ca21e99918262f395
ISSUE #193: Shade Bookkeeper and unshade ZooKeeper in core module--Descriptions of the changes in this PR:--Shade Bookkeeper and unshade ZooKeeper in core module--Author: Arvin <arvindevel@gmail.com>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #194 from ArvinDevel/shade_bk, closes #193;32ad7bae8201b3b7ce5fe7431f099fb9380eb8f8
ISSUE #165: Enable checkstyle in core module--Descriptions of the changes in this PR:--Fix checkstyle error in core module--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #192 from ArvinDevel/enable_check, closes #165;db06aca15b5bab62500ea973c7626636e2f173a9
ISSUE #181: Enable LogRecord ByteBuf based constructor public--Descriptions of the changes in this PR:-change LogRecord ByteBuf based constructor to public--Author: Arvin <arvindevel@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #182 from ArvinDevel/issue_181, closes #181;e5cd0fe690f47575f62761f7bd4f3ad35c42c801
ISSUE #537: Compilation warning on unchecked cast--Descriptions of the changes in this PR:--add `SuppressWarnings("unchecked")` in TestPrometheusMetricsProvider.java--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #538 from sijie/fix_compilation_error, closes #537;758cdebb655bb68f7fd8017d289ce66ba9072e3e
ISSUE #535: Prometheus metrics provider fails to initialize--Descriptions of the changes in this PR:--- the parameter of `collectorNames` should be Collector rather than String-- add test case for prometheus metrics provider-- rename the classes to under `org.apache.bookkeeper.stats.prometheus` rather than taking the common `stats` package.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #536 from sijie/fix_promethus, closes #535;d82dc1c3e64e12e27ac8492ecbd4204a5529099c
ISSUE #532: Drop all @Test(timeout) annotations--Simply drop the 'timeout' parameter for Test annotations, we have already a global timeout set in surefire configuration--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #533 from eolivelli/task/cleaup-timeouts, closes #532;029fc609cd4933b55af4d40af69ef59dad83a842
ISSUE #527: Introduce backoff and retry utilities--Descriptions of the changes in this PR:-Mainly want to  Introduce backoff and retires utilities:-Backoff implements various backoff strategiesis, and id intended to determine the duration after which a task is to be retried.-Retries is a util class for supporting retries with customized backoff.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #528 from zhaijack/retries_backoff, closes #527;8399707f054e5d387e1af18384efab4cd1b26e57
BOOKKEEPER-1106: Introduce write FileInfo cache and read FileInfo cache--Problem: when read behind happens, it would quickly read bunch of ledgers, which will evict current active ledgers for writing from the ledger cache. with the ledger being evicted from cache, it would impact the write performance.--This feature is contributed by sijie , in which we introduced write file info cache and read file info cache to cache the ledger index separately for read and write, so that when catch up read happens, it will not evict the file info for writes.--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>, Jia Zhai--This closes #513 from yzang/yzang/BOOKKEEPER-1106;2bbecd7da52824c991e1a28573ccf8c8515ea5dd
ISSUE #517: port shared-resource-manager utils from distributredlog--Descriptions of the changes in this PR:--Try to portshared-resource-manager utils  from DistributedLog, so it can be used later on.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #518 from zhaijack/shared_resource, closes #517;80b7676045c34f4678f754f7f78d77c156ba518d
ISSUE #499: make a package contains all the jar--Descriptions of the changes in this PR:-This is a sub-task for #458:-Make Prometheus provider the default in bk_server.conf,-Include stats providers in a -all package,--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #500 from zhaijack/all_bin, closes #499;31bef62d7e63d5a8b198dd09ca2e72646a6bffc8
ISSUE #508: Introduce lifecycle components for managing components in bookie server--Descriptions of the changes in this PR:--The motivation of creating lifecycle components is described in #508.--This changes include:--- create bookkeeper-common module, move some common classes (such as interface annotations) to common module.-- add the lifecycle components in bookkeeper-common module.-- add a package `org.apache.bookkeeper.server` for keeping all server related classes.-- rewrite BookieServer using the lifecycle components: stats provider | bookie server | auto recovery | http endpoint-- BookieServer is still kept for backward compatible, all the main functions are delegated to `org.apache.bookkeeper.server.Main`.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #509 from zhaijack/metadata/lifecycle_management, closes #508;3ede9c6c507aa93432757c4f1fe47c538fa83e34
ISSUE #515: Run bookies using hostIP instead of containerIP in k8s--Descriptions of the changes in this PR:--- use `status.hostIP` rather than `status.containerIP`. so the identifier (ip) of a bookie pod will not be changed after it is restarted.-- use `adverstiseAddress` to advertise hostip as the ip of a bookie pod-- change it to use `hierarchical` ledger manager--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #516 from sijie/run_bookie_using_hostport_bk, closes #515;eba4d6e5d7eab8beab699c6dba8ac41e5ceec3db
BOOKKEEPER-31: Project Logo--Descriptions of the changes in this PR:--- upload the bookkeeper logo to site directory (including both svg and png format)-- add &trademark; to Apache BookKeeper.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #511 from sijie/BOOKKEEPER-31;aa03c523126a2ad9aa0cae3665410bbc4dfb5edd
ISSUE #507: Introduce @FlakyTest annotation for marking a few tests as flaky--Descriptions of the changes in this PR:--- introduced FlakyTest annotation-- mark a few tests as flaky tests (create issues for them)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #504 from sijie/mark_test_as_failures, closes #507;131d1272e53e59645f6cf250e84f29da11568a08
ISSUE #494: Rename ZkVersion to LongVersion--Descriptions of the changes in this PR:--- rename `ZkVersion` to `LongVersion`-- move it from `meta` package to `versioning` package--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #495 from zhaijack/metadata/rename_zkversion_to_longversion, closes #494;d338addc369cbe3b96af4ee4232d0cce7d72d089
[maven-release-plugin] prepare for next development iteration;fae15d4249505003ef940687dd5203d396a12bdf
[maven-release-plugin] prepare for next development iteration;a5c061ce5a99f85b9496c7f010093ee0ccb40052
[maven-release-plugin] prepare for next development iteration;b9af3d5d7cc8961ec839e1f28b1b7495f38fe971
[maven-release-plugin] prepare branch release-0.5.0;1459adbe39715c94b012113b58f1be76c99a79b6
ISSUE #160: Introduce backward compatibility testing--Descriptions of the changes in this PR:--The core testing logic is in `tests/bin/docker-backward-test.sh`.--- introduce an all module for packaging-- add docker images for 0.3.51, 0.4.0-incubating and latest-- add two backward compat testing module-- using docker images for backward compatibility testing--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <None>--This closes #175 from sijie/docker_image, closes #160;abb311cdf839c02a941f416e6f97c8b85afd6fb0
ISSUE #496: some docker images don't need port forwarding--Descriptions of the changes in this PR:--some docker images don't need port forwarding. remove port forwarding from them.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #497 from sijie/remove_docker_port, closes #496;96a45e2a5733c91d89f9e91755ac3f42fdcea4d4
ISSUE #166: Code cleanup for 0.5.0 release--Descriptions of the changes in this PR:--- add InterfaceAudience and InterfaceStability for public API to inform people what changes would be expected for those interface.-- avoid using guava classes in public API since we will provide a shaded jar for distributedlog-core-- enable ImportOrder checkstyle rule in some modules-- move `org.apache.distributedlog.io` to `distributedlog-common` module-- rename `setReadyToFlush` to `flush` and rename `flushAndSync` to `commit` for the new API--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <None>--This closes #172 from sijie/finalize_api, closes #166;8c8338738c8e54087990f25c15d18eafd7935ef4
ISSUE #166: Code cleanup for 0.5.0 release--Descriptions of the changes in this PR:--- add InterfaceAudience and InterfaceStability for public API to inform people what changes would be expected for those interface.-- avoid using guava classes in public API since we will provide a shaded jar for distributedlog-core-- enable ImportOrder checkstyle rule in some modules-- move `org.apache.distributedlog.io` to `distributedlog-common` module-- rename `setReadyToFlush` to `flush` and rename `flushAndSync` to `commit` for the new API--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <None>--This closes #172 from sijie/finalize_api, closes #166;7da9187853c12ee6cf64287e0d5fcb56bdd2b6d0
ISSUE #166: Code cleanup for 0.5.0 release--Descriptions of the changes in this PR:--- add InterfaceAudience and InterfaceStability for public API to inform people what changes would be expected for those interface.-- avoid using guava classes in public API since we will provide a shaded jar for distributedlog-core-- enable ImportOrder checkstyle rule in some modules-- move `org.apache.distributedlog.io` to `distributedlog-common` module-- rename `setReadyToFlush` to `flush` and rename `flushAndSync` to `commit` for the new API--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <None>--This closes #172 from sijie/finalize_api, closes #166;ae9dbfe9c5f1862af664cb51efaf7446276c16a2
ISSUE #492: set the protobuf syntax to 'proto2'--Descriptions of the changes in this PR:--Explicitly set protobuf syntax to `proto2`.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #493 from zhaijack/metadata/set_protobuf_syntax_version, closes #492;e48f9d02924208ad1e929c2876ae2acfcfab0c5d
Issue #430: Add an instruction in docker README to run standalone cluster--Descriptions of the changes in this PR:-Add an instruction in docker README to run standalone cluster, and change the docker image description more accurately--Author: Arvin <arvindevel@gmail.com>--Reviewers: Francesco Caliumi <None>, Jia Zhai <None>--This closes #470 from ArvinDevel/issue_430, closes #430;efc115af4979a5d2009714586daf5e8651a4be3f
y--Descriptions of the changes in this PR:-When added the documentation, the sidebar was not updated, need to update to include k8s deployment.--After fix:-<img width="1371" alt="default" src="https://user-images.githubusercontent.com/26834121/29860959-4101c23a-8d9a-11e7-8e6b-3eeb17a3a5b4.png">--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #484 from zhaijack/fix_sidebar;34b2920f9890f5ab320094b8584f9f93720fd71f
ISSUE #485: Change 'segment' to 'fragment' in docs--Descriptions of the changes in this PR:- Change  'segment' to 'fragment' in docs, and make some relative code more clearer--Author: Arvin <arvindevel@gmail.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #486 from ArvinDevel/issue_485, closes #485;fd27e99ecbb152ef7bbf05a36a9d85c8997d3744
DL-45: DL should allow ByteBuf based API to avoid copying bytes array--Descriptions of the changes in this PR:--This change leverages the `ByteBuf` api introduced in bookkeeper 4.5.0. It will avoid copying bytes array between LogRecord and LogRecordSet/Entry, and avoid copying bytes from DL to BK client.--This change also bump the lz4 library to `1.3.0` to leverage the `ByteBuffer` binding.--Author: Sijie Guo <sijie@apache.org>-Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Leigh Stewart <None>--This closes #151 from sijie/zero_copy;813c675e8d6a5a92d73821ddd1f49883ff2eb0c7
DL-45: DL should allow ByteBuf based API to avoid copying bytes array--Descriptions of the changes in this PR:--This change leverages the `ByteBuf` api introduced in bookkeeper 4.5.0. It will avoid copying bytes array between LogRecord and LogRecordSet/Entry, and avoid copying bytes from DL to BK client.--This change also bump the lz4 library to `1.3.0` to leverage the `ByteBuffer` binding.--Author: Sijie Guo <sijie@apache.org>-Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Leigh Stewart <None>--This closes #151 from sijie/zero_copy;25abd3675da9a6fc7b47ea80a5f1556eb129de8b
DL-45: DL should allow ByteBuf based API to avoid copying bytes array--Descriptions of the changes in this PR:--This change leverages the `ByteBuf` api introduced in bookkeeper 4.5.0. It will avoid copying bytes array between LogRecord and LogRecordSet/Entry, and avoid copying bytes from DL to BK client.--This change also bump the lz4 library to `1.3.0` to leverage the `ByteBuffer` binding.--Author: Sijie Guo <sijie@apache.org>-Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Leigh Stewart <None>--This closes #151 from sijie/zero_copy;5a5ad4625548a5ba78764e01f83dcdbfe0cbeca2
ISSUE #156: Provide a shading jar for distributedlog-core--Descriptions of the changes in this PR:--- provide a shade-all jar (shading all the dependencies) for distributedlog-core. the `shade-all` jar is classified as `shaded`.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #161 from zhaijack/shade_libs, closes #156;0e76212e2295032b2fad29de58bbeacb9c0018ac
ISSUE #274: Ensuring the right number of bookies are passed.--Descriptions of the changes in this PR:-This fixes #274. Ensures that benchmark measure right number of bookies for the warmup.--Author: arvindkandhare <arvind.kandhare@emc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #482 from arvindkandhare/issue-274-benchmarkfix, closes #274;29e74229eda138c13c88ec890ce3d2c215972303
ISSUE #463: Improve bookkeeper unit test--Descriptions of the changes in this PR:--- remove `timeout` on individual tests, instead setting globalTimeout on base test `BookKeeperClusterTestCase` to simplify managing timeout on individual tests-- use maven docker build to run unit tests-- zookeeper cluster uses port 0--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #481 from sijie/merge_fix, closes #463;dd9680373188948f0e7b8f3b994309626a472856
ISSUE #479: CompactionTest#testCompactionWithEntryLogRollover failed--Descriptions of the changes in this PR:--- restart bookie with disabling gc for #testCompactionWithEntryLogRollover-- improve other tests to remove `Thread.sleep` and use a more deterministic way for doing gc--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #480 from sijie/fix_compaction_test, closes #479;ae58e92bd3f0c17ed242544a097dd19656d39c42
ISSUE #468: Introduce JMH for micro benchmarking--Descriptions of the changes in this PR:--- add a `test/jmh` module for micro-benchmarking-- add a protocol related test: serializing and deserializing requests--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #469 from sijie/add_jmh_benchmark, closes #468;c0fdfa5c1a05bd5cadb175928aa02a8e1c3f1e1f
ISSUE #475: Move code-coverage activation to a Maven profile--Move JaCoCo and Coveralls.io configuration to a separate code-coverage profile--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #476 from eolivelli/issue-475-profile-codecoverage, closes #475;b2c2e9e597eb970f511d21adff00fda00b5b6360
ISSUE #462: TestTLS failures--Descriptions of the changes in this PR:--Problem:--The behavior of loading configuration in `AbstractConfiguration` was changed recently.-So the TLS provider was not cleared correctly for the failed tests.--Solution:--Explicitly clear TLS provider for each configuratio to address the failed tests.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #478 from sijie/fix_tls_test, closes #462;6e6556f29ecbf966404423b7d67897e5dcba712a
ISSUE #343: TestFencing.testManyOpenParallel--Descriptions of the changes in this PR:--Problem:--The `LastAddConfirmed` was advanced due to piggyback on recovery adds. It will cause recovery adds become stall because-of the entry id check.--This problem only occurs when there are multiple clients concurrently recover same ledger.--Solution:--Disable lac piggyback on recovery adds.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #477 from sijie/tests, closes #343;5c83b6e2ab7329c428b2c63415f3c695f4edaf12
ISSUE #473: Bump protobuf version from 2.x to 3.x--Descriptions of the changes in this PR:--- Bump protobuf version from 2.x to 3.x-- Removed the generated protobuf files from source repo.-- Use maven protobuf plugin to generate the protobuf files.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #474 from sijie/protobuf3, closes #473;814edb69dda698e6f719bf4b0c970c206064f606
ISSUE #466: Move backward compatibility tests into a separate module--Descriptions of the changes in this PR:--- move backward compatibility test related stuffs to a separate module `test/backward`.-- fix checkstyle for backward compatibility related tests-- other pom file changes: move common dependencies to root pom, use variables-- for bookkeeper-server module, produce a non-shaded jar and a shaded jar. so applications can choose what jar to use.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #467 from sijie/integration_tests, closes #466;160e975a98abfa18a8de9423137763e4a1125b47
ISSUE #337: Docker image: K8s for bookkeeper and instructions on usage--Descriptions of the changes in this PR:--K8s deployment for bookkeeper and instructions on usage--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>--This closes #461 from zhaijack/issue_337, closes #337;51c660ec87a541a4827742569da72a649e2ed5c7
ISSUE #464: Add JaCoCo code coverage configuration to master pom.xml--Introduce JaCoCo configuration to the master pom.xml.-JaCoCo handles Java8 syntax better than Cobertura--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #465 from eolivelli/issue-464-jacoco, closes #464;17c5c445db8a700c595e620ab33275f33c95e4a6
DL-206: Delete the log should also delete the underline ledgers--Problem:-We're not deleting the ledgers when we delete the whole log stream using dlm.delete() API. This would cause a lot of garbage/orphan ledgers in Bookkeeper.--The fix is to delete the ledger when we delete the log stream. Also added a test to validate.--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #152 from yzang/yzang/DL-206;13f88fec96258124e7c20f90f9ed3babced5dc81
ISSUE #459: fix loadConf in AbstractConfiguration--Descriptions of the changes in this PR:-In loadConf, call setProperty for all k-v in baseConf.-Please reference #459 for more anlysis and details.--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #460 from zhaijack/issue_459, closes #459;f4a9a53ce725f8c495e100430a05dc13942d0837
ISSUE #410: BookKeeper binary distribution package contains a CHANGES.txt file--Drop CHANGES.txt--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #456 from eolivelli/issue-410, closes #410;e28ea6baecc181f90b5e26f5456ec3b657938b24
ISSUE #453: fix image broken in website--Descriptions of the changes in this PR:-Fix image broken in website--After fix, image works well.-<img width="1535" alt="default" src="https://user-images.githubusercontent.com/26834121/29500286-ee3e4d88-8651-11e7-80c2-d4febffb0bfe.png">--Author: Jia Zhai <zhaijia@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #455 from zhaijack/issue_453, closes #453;35cffdf6a38b5dba702b11e5902d5aa745429b01
ISSUE #254: Remove BookKeeperTools--Descriptions of the changes in this PR:-remove the BookKeeperTools,-update the latest admin docs and BookieRecoveryTest's annotation.--Author: Arvin <arvindevel@gmail.com>--Reviewers: Jia Zhai <None>, Enrico Olivelli <eolivelli@gmail.com>--This closes #452 from ArvinDevel/master, closes #254;b15e167f49d968d0e990a0eb467ca1f186bdc0a7
ISSUE #407: Enable allowLoopback when starting localbookie--Add allowLoopback=true flag in ServerConfiguration used in main() of LocalBookie facility--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #457 from eolivelli/issue-407, closes #407;3e4c02731787e730c039d6da17ab85b69e73daa1
DL-2: DistributedLog should work with the official apache bookkeeper--This change is to upgrade bookkeeper version to BK 4.5.0.--- upgrade bookkeeper version to 4.5.0-SNAPSHOT (still waiting a few pull requests to merge apache/bookkeeper#297 apache/bookkeeper#287-  - change registerSuccessEvent for StatsLogger to add TimeUnit-  - use netty4 eventloop-  - move twitter repository dependencies to proxy related module only. core library will not depend on scala dependency anymore.--This change is a collaboration change with sijie--We will provide a performance comparison between 0.4.0 (using Twitter BK) and 0.5.0 (using BK 4.5.) in a separate pull request or email.--Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>--This closes #135 from zhaijack/bump_dl_version;075d5b0e0cf7de9ef676a0a0389f08eb40d2196f
DL-2: DistributedLog should work with the official apache bookkeeper--This change is to upgrade bookkeeper version to BK 4.5.0.--- upgrade bookkeeper version to 4.5.0-SNAPSHOT (still waiting a few pull requests to merge apache/bookkeeper#297 apache/bookkeeper#287-  - change registerSuccessEvent for StatsLogger to add TimeUnit-  - use netty4 eventloop-  - move twitter repository dependencies to proxy related module only. core library will not depend on scala dependency anymore.--This change is a collaboration change with sijie--We will provide a performance comparison between 0.4.0 (using Twitter BK) and 0.5.0 (using BK 4.5.) in a separate pull request or email.--Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>--This closes #135 from zhaijack/bump_dl_version;f528fb39918f01551327530f3567fdb36852abc4
DL-2: DistributedLog should work with the official apache bookkeeper--This change is to upgrade bookkeeper version to BK 4.5.0.--- upgrade bookkeeper version to 4.5.0-SNAPSHOT (still waiting a few pull requests to merge apache/bookkeeper#297 apache/bookkeeper#287-  - change registerSuccessEvent for StatsLogger to add TimeUnit-  - use netty4 eventloop-  - move twitter repository dependencies to proxy related module only. core library will not depend on scala dependency anymore.--This change is a collaboration change with sijie--We will provide a performance comparison between 0.4.0 (using Twitter BK) and 0.5.0 (using BK 4.5.) in a separate pull request or email.--Author: Jia Zhai <zhaijia03@gmail.com>-Author: Jia Zhai <zhaijia@apache.org>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>--This closes #135 from zhaijack/bump_dl_version;eaed168536d09c2e56e52fc4a43aabb41b44e6e2
BOOKKEEPER-1105: RackAwarePolicy: Failure to map node into rack may result in failure to add other nodes.--- RackAwarePolicy's no longer uses /default-region if rack mapping fails unless required (by RegionAwarePolicy)-- it no longer fails to add rest of nodes after one node's failed addition,-- added unit tests-- added counters for successful/failed bookie adds/removal-(PR description content here)...--UpdateLedgerOpTest failed but it seems to be known/unrelated issue.--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #425 from dlg99/fix/rackaware;f5d2ba66d6253fb54811d3ceb40d4ef4591dfb20
BOOKKEEPER-1100: Add module for Bookkeeper Http Endpoint--Add Bookkeeper Http Server as a new module [bookkeeper-http]--1. Add children module [http-server], which provide generic api for setting up a Http Server for bookkeeper, allowing to plugin different Http frameworks and inject the implementation of different BK related services to Http Handler to handle different endpoints--2. Add children module [vertx-http-server], which is a Vertx.io based http server implementation--3. Add children module [twitter-http-server], which is a TwitterServer based http server implementation--4. Add a package or org.apache.bookkeeper.http in [bookkeeper-server], which include all the implementation for the services that handle different http endpoint request.--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #278 from yzang/yzang/BOOKKEEPER-1100;de9eecc180cc78fb65b509d7ae0e5ea82fd5dc8c
Issue 141: graduation changes, remove/change incubate related things--- remove the "-incubating" from the code base.-- change website link from http://distributedlog.incubator.apache.org into https://bookkeeper.apache.org/distributedlog-- change repo from https://github.com/apache/incubator-distributedlog into https://github.com/apache/distributedlog-- git from https://git-wip-us.apache.org/repos/asf/incubator-distributedlog.git into https://gitbox.apache.org/repos/asf/distributedlog.git-- remove website foot, whch contains incubate infos in websiteindex.md-- remove Disclaimer file and its references--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #143 from zhaijack/issue_141;ab11ad85562b9fed1d4c6f4fbcbd70731a18ef24
Issue 141: graduation changes, remove/change incubate related things--- remove the "-incubating" from the code base.-- change website link from http://distributedlog.incubator.apache.org into https://bookkeeper.apache.org/distributedlog-- change repo from https://github.com/apache/incubator-distributedlog into https://github.com/apache/distributedlog-- git from https://git-wip-us.apache.org/repos/asf/incubator-distributedlog.git into https://gitbox.apache.org/repos/asf/distributedlog.git-- remove website foot, whch contains incubate infos in websiteindex.md-- remove Disclaimer file and its references--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #143 from zhaijack/issue_141;6a8ed75be57d1ed4ace6bf34910a1093da9c5ef5
Issue 141: graduation changes, remove/change incubate related things--- remove the "-incubating" from the code base.-- change website link from http://distributedlog.incubator.apache.org into https://bookkeeper.apache.org/distributedlog-- change repo from https://github.com/apache/incubator-distributedlog into https://github.com/apache/distributedlog-- git from https://git-wip-us.apache.org/repos/asf/incubator-distributedlog.git into https://gitbox.apache.org/repos/asf/distributedlog.git-- remove website foot, whch contains incubate infos in websiteindex.md-- remove Disclaimer file and its references--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #143 from zhaijack/issue_141;d318022d356d4468b8ced7f1a97c78cdf11e8f74
ISSUE #304: New Release Guide--Descriptions of the changes in this PR:--This is an attempt to improve the current release guide base on a few references :  [Beam](https://beam.apache.org/contribute/release-guide/) [Pulsar](https://github.com/apache/incubator-pulsar/wiki/Release-process)--Add this in main repo for reviews. We can later on make it part of website once #293 is completed.--A few items are TBD. comments are welcome.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #305 from sijie/release_guide, closes #304;2bdb069b9ea9bf114d7beed9d3a4502702fc444a
ISSUE #434: Move the content from wikis to website--Descriptions of the changes in this PR:--copied bunch of links from wiki pages and re-organized the links under `community`.--- first section: mailing list, issue tracking, release schedule and community meetings.-- second section: a few guides on how to contribute, how to report issue and how to release-- last section: resources (e.g. presentations, proposals)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #448 from sijie/sijie/move_contents, closes #434;affc7b073ff229345a5569025f4b65983358a352
ISSUE #443: Update the mailing list--Descriptions of the changes in this PR:--Add a section about `issues` mailing list.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #445 from sijie/issue_443, closes #443;3b41dca602d87d511c203df61d3463d12f9fe756
ISSUE #440: Update "who are we?" page--Descriptions of the changes in this PR:--- add new DL PPMC members to BK PMC-- fix full name and affiliations for a few members--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #447 from sijie/issue_440-, closes #440;0d1593773041dc8a9484ffcf130cb3678e19e825
ISSUE #444: remove doc directory--Descriptions of the changes in this PR:--The doc directory was used by CMS to generate the old bookkeeper website. since we already moved to a new jekyll website, the files in this directory are not used anymore. we can remove them.--Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #446 from zhaijack/issue_444, closes #444;9df2c62f2b1296aaf9e303e5aef26f90fbe184f9
ISSUE #441: fix typos--Descriptions of the changes in this PR:-Fix typos in docker readme.-"Apache ZooKeeper is a software project of the Apache Software Foundation"-->-"Apache Bookkeeper is a software project of the Apache Software Foundation"--"bookkepeer servers" -> "bookkeeper servers"--"The client only need to connect to a Zookkeeper server in the ensamble"-->-"The client only need to connect to a Zookeeper server in the ensemble"--typo of other place:-bookeeper-->-bookkeeper--wile-->-while--acknoledge-->-acknowledge--Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #442 from zhaijack/issue_441, closes #441;e988a3cb876b5939e103e36b985ddab05173569c
ISSUE #385: Upgrade to commons-lang 2.6--Upgrade to commons-lang 2.6 which can run on Java9-see explanation on #385--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #386 from eolivelli/commonslang26, closes #385;f657b5e00d2e44a3fa476a4ab2c933c4a404717a
ISSUE #418: bump docker to use bk - 4.5.0--Descriptions of the changes in this PR:--  bump the docker image to use 4.5.0 binary, update pgp_key and bk version.--  delete yum install for md5sum and sha1sum, since they are already in coreutils, which is default installed; and left them here will report error: 'No Match for argument: md5sum/sha1sum', while 'yum remove' in docker build.--have tested by running make run-dice.--Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Francesco Caliumi <None>--This closes #436 from zhaijack/issue_418, closes #418;739540896357e0079a946b95881a3cef4e6f9a72
ISSUE #435: Build javadoc for releases--Descriptions of the changes in this PR:--- add javadoc links on sidebar and overview pages (try to promote this link for users to find the link easier)-- update javadoc-gen.sh to be able to generate latest javadoc and all javadocs for versions under `docs`--minor fixes:-- pass "JEKYLL_ENV=production" to docker because ci uses docker to build the documentation----Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #438 from sijie/publish_javadocs, closes #435;caba6b1dbd7eab07c8c6dd518797c55739f3524e
ISSUE #431 ISSUE #221: merge scripts should mark milestone when merging pull requests--Descriptions of the changes in this PR:--improve merge script to do:--- assign a milestone-- add `area/` label-- add `type/` label-- add `release/` label-- when a change needs to merge to a different branch, add the bug fix `release/` label--This also addresses #221 to trim the template from pull request body.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <zhaijia03@gmail.com>--This closes #437 from sijie/merge_script_for_bug_releases, closes #431, closes #221;1ff17d899f9998cdefc99c47f0f38a75b99d1c0e
ISSUE #414: use a clone of baseconf in new ServerConfiguration(baseConf)--Descriptions of the changes in this PR:-This PR fix Issue #414 , and in the comments of that issue contains the anysis of the bug.  Main changes:-- Privde a clone of baseConf while do loadconf(baseConf), so make baseConf and newConf work independently.-- Remove 'loadConf(Configuration otherConf) ', since Configuration is an interface in common-configs and not have a clone method.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #424 from zhaijack/issue_414, closes #414;b4a1c76054c54d05d38a89399efa716201a2206b
ISSUE #432: Add "Google Analytics" to the website--Descriptions of the changes in this PR:--Add "google analytics" script to the website for tracking the documentation traffic. We can learn the pattern and improve documentation.--The google account for analytics is managed by bookkeeper pmc.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #433 from sijie/google_analytics, closes #432;88a61eefcc23a72e9ec18d64168dddd0e2e01269
ISSUE #356: Release notes 4.5.0--Descriptions of the changes in this PR:--- summary for release 4.5.0-- highlights for 4.5.0-- full list of JIRA and Github issues.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>--This closes #402 from sijie/release_notes_4.5.0, closes #356;3ebd42936c3af4395823e2754155c0088eb6a579
release 4.5.0: update website--Descriptions of the changes in this PR:--under `site`, run `./scripts/release.sh`--what the script does:--- copy the `latest` to `4.5.0`.-- finalize the version-- update config yml--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #429 from sijie/update_website_for_4.5_release;4615742cc3947e4794aa0afda668876fd01887b1
ISSUE #427: [WEBSITE] sidebar doesn't work on documentation index page--Descriptions of the changes in this PR:--sidebar uses `../../` for relative paths. in order to make this work, we need to move any pages under `docs` on level down and not use `index.md`.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Luc Perkins <None>, Matteo Merli <None>--This closes #428 from sijie/issue_427, closes #427;f5c96ebc9e5952a89f86d0a50093ff65c821701b
Issue #416: Some small post-release documentation fixes--There were a few issues pointed out with the new BookKeeper website/documentation. This fixes issue #416 and makes a handful of spelling and wording fixes.--Author: Luc Perkins <lucperkins@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #426 from lucperkins/docs/small-post-release-fixes, closes #416;eb316394c7d4c4426cfb86d2a9fc794302e5ad0d
ISSUE #422: Don't use community layout for documentation pages--Descriptions of the changes in this PR:--The layout of documentation page is marked as community. when users navigate to this page, it is a bit difficult for the users to figure out where they are. We should stick documentation pages to doc layout.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #423 from sijie/documentation_index, closes #422 and squashes the following commits:--4ec16d6 [Sijie Guo] remove community layout for docs page-21320b4 [Sijie Guo] The index page for documentation should use documentation layout rather than community layout;6e99bb7344463f6b132dd2df5ecc0f5de31909be
Fix typo: TSL should be TLS in server_conf--TSL should be TLS in server_conf--Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Sijie Guo <None>--This closes #421 from zhaijack/fix_conf_typo;bbcf1d8aec197074f707bf3d16684705396322f3
406--Descriptions of the changes in this PR:-- Fix non-privileged user execution-- Change the Makefile in order to always use current user when run the bk image-- Fix Makefile in order to run "make run-demo"-- Adjust unneeded packages remove in Dockerfile--Author: Francesco Caliumi - Diennea <francesco.caliumi@diennea.com>--Reviewers: Jia Zhai <None>, Matteo Merli <None>, Sijie Guo <None>--This closes #406 from caiok/master;755f8f624e20fb8775b100473c14d9775fe8851c
Flip apache baseurl from `/test/content` to `/`--Descriptions of the changes in this PR:--INFRA is cutting the bookkeeper website from CMS to git. we need to flip '/test/content' to '/'.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <None>--This closes #411 from sijie/sijie/move_baseurl_to_root;b7b0a6845e5dc47c30d93d86797deb4aa463df04
ISSUE #349: Move `security` docs under `latest` (hotfix)--Descriptions of the changes in this PR:--#325 moved the docs to under `docs/latest`. so we need to move `security` docs to under `docs/latest/security`.--At the same time, fix two broken links.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #408 from sijie/fix_bad_merges, closes #349;bee543487a2dd18034df2030a175b8f437f8fae3
ISSUE #349: Documentation for security feature in 4.5.0--Descriptions of the changes in this PR:--- add a section for `security`-- overview to introduce security feature-- encryption and authentication using tls-- sasl authentication-- zookeeper authentication--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #350 from sijie/security_docs, closes #349;49b90a66f830482fc970ba625057c7101c201f62
ISSUE #355: upgrade guide--Descriptions of the changes in this PR:--- provide a general upgrade guide-- document notes for upgrading from 4.4 to 4.5.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Jia Zhai <None>--This closes #403 from sijie/upgrade_guide, closes #355;f90fa787522d59114caa3fe8b70345effb627f8e
ISSUE #366: [DOCUMENTATION] LedgerHandleAdv--Descriptions of the changes in this PR:--- add documentation about LedgerHandleAdv-- update overview--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #401 from sijie/issue_366, closes #366;188d7e5fb8d8beb137f13a49b7df8a9cd861cefc
ISSUE #325: [WEBSITE] how to manage documentation between releases--Descriptions of the changes in this PR:--- move `docs` to `docs/latest`-- add a script to proceed release steps-   - copy `docs/latest` to `docs/{version}`-   - in docs/{version}, replace versions-   - bump versions in `_config.yml`-   - generate placeholders for releaseNotes--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Jia Zhai <None>--This closes #400 from sijie/release_versions, closes #325;ae1ba84f0935fdac43e7dd500647a70b2c4ca7f3
Fix zkCli issue--Descriptions of the changes in this PR:-/opt/zk/bin/zkCli.sh was leaked to replace by /opt/bookkeeper/bin/bookkeeper org.apache.zookeeper.ZooKeeperMain and cause:--/opt/bookkeeper/entrypoint.sh: line 61: /opt/zk/bin/zkCli.sh: No such file or directory--Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Sijie Guo <None>--This closes #404 from zhaijack/docker_fix;c6e2f75dce44082e1a3b9ba06d1e37ed3ff5998f
ISSUE #338: add first draft Docker image including community suggestions--This is the first part of #335. And it is based on #197-Main changes:- 327: Docker image: Drop versions and Alpine support.- 260: Docker image: provide a way to pass any desired configuration property via ENV vars.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Matteo Merli <None>, Sijie Guo <None>--This closes #342 from zhaijack/issue_338, closes #338;d107f969a915362dfce8f1b66c221debd434aefd
ISSUE #397: [CI] publish-website job failed when mvn:release bump version to 4.6.0-SNAPSHOT--Descriptions of the changes in this PR:--Use `mvn install` rather than `mvn compile`--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <None>--This closes #398 from sijie/issue_397, closes #397;cbcc64d6d0fd1a3d6738e4efcb0db3d5005ad0f8
[maven-release-plugin] prepare for next development iteration;59562a7bb2b300b0706d17e9fc034d6604b71626
[maven-release-plugin] prepare branch branch-4.5;1b7ed6be98a2f41dc61fa18c5e678deab933f48e
ISSUE #390: [CI] Test errors in TestRackawareEnsemblePlacementPolicyUsingScript--Descriptions of the changes in this PR:--`Shell` class was ported from hadoop, but it contains a lot of unused code. Especially there is not `HADOOP_HOME` will set, so an exception will be thrown. (although the issue seems to be hidden in mac)--This change is to clean up the `Shell` class. The `Shell` class is only used for executing shell script configured in rackaware placement policy.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Enrico Olivelli <None>--This closes #396 from sijie/sijie/cleanup_shell, closes #390;bf1d58f197b9a99863f563ce0fdcb0e1f3483b8d
ISSUE #393: [CI] publish-website job will be marked as failure if it is an empty commit--Descriptions of the changes in this PR:--- use `git diff-index` to checkout if there is any changes to commit or not-- port some changes from CI back to script.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #394 from sijie/issue_393, closes #393;8986f32db757799ea678fa8c31823566572f3082
ISSUE #367: [DOCUMENTATION] add api readUnconfirmedEntries in website doc--Descriptions of the changes in this PR:--add api readUnconfirmedEntries in website doc------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #371 from zhaijack/issue367, closes #367;31960b027f391ee8ca7400cb3e647c20864966a3
ISSUE #391: CI failed with java.lang.ClassNotFoundException: org.hamcrest.SelfDescribing--Descriptions of the changes in this PR:--- include hamcrest dependency for tests (according to [junit](https://github.com/junit-team/junit4/wiki/Download-and-Install) instruction)-- exclude `.repository` to turn ci builds to run with its own local repository-- dump the rat check output to console (easier for debugging on jenkins)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #392 from sijie/bookkeeper-test, closes #391;02580c0c2b2d998e1cdfdffe75458d3b7e85d1fc
ISSUE #383: mvn release:branch fails--Descriptions of the changes in this PR:--- change `compilerArguments` to `compilerArgs`-- use `compilerArg` for configuring the arguments for compilation.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #384 from sijie/sijie/fix_release, closes #383;1c8101ed688d97fa93a8143c697f6c7489d5c6f9
ISSUE #262: Useless option explicitLacInterval is set to 1 in default bk_server.conf--Remove an useless line from default bk_server.conf file--Author: eolivelli <eolivelli@apache.org>-Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #375 from eolivelli/issue-262, closes #262;18f5c6a0a3de8727bcc12a8f6b1747c9a6a3c305
ISSUE #381: update old releases url to achives--Descriptions of the changes in this PR:--- the cms content has been copied from cms to asf-site branch under /content/archives. it is available under http://bookkeeper.apache.org/test/content/archives/-- update the release url from 'bookkeeper.apache.org/docs/rx.y.z' to '{{ site.baseurl }}achives/rx.y.z'--scripts:--- update the scripts to use clone and copy to avoid trash everything in remote. this would prevent overwrite `archives` directory.--content:--- fix syntax error in `shell.yaml` to be able to build website--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #382 from sijie/fix_links, closes #381;423fa658419fe8b4b0731ede52b8f34610a3f663
ISSUE #376: Skip getSysFileDescriptor if JournalRemovePagesFromCache=false--Skip illegal reflective calls if not needed, this way the Bookie will run on Java9 cleanly--We need to access internals of FileDescriptor class only if JournalRemovePagesFromCache=true.-This change will allow to run the bookie on Java9 just by using JournalRemovePagesFromCache=false.--see #376--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #380 from eolivelli/issue-376-minimal-java9, closes #376;7a500dc8082580ad4c85c307ef073edae3ae7f7a
ISSUE #269: upgrade findbugs to 3.0.4--Just update findbugs plugin to latest version. No new warnings to address--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #379 from eolivelli/findbugs-304, closes #269;70533f54a7e53a808f56e7a1112d0e0f7d260397
Issue #372: Allow to configure advertised address in bookies--Add option to configure advertised address for bookies.--Reasons for this are outlined in #372--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>, Sijie Guo <None>--This closes #373 from merlimat/advertised-address, closes #372;464fa55c6debf5fdc835077135846e89729321c6
Issue #377: Make Prometheus stats logger registration idempotent--Make sure the metric are only registered once on Prometheus client lib.--Discusses in #377.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>, Sijie Guo <None>--This closes #378 from merlimat/fix-metrics-double-registration, closes #377;398d33218eb2d9a4932fa69b9b3a29f02b2dce02
ISSUE #362: [DOCUMENTATION] update command line tools--Descriptions of the changes in this PR:--enrich doc for bookie shell------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Luc Perkins <None>, Sijie Guo <None>--This closes #369 from zhaijack/issue_362, closes #362;6c340e06bbc13bd5ce7526f3531a9bab23108776
ISSUE #360: [DOCUMENTATION] configuration settings--Descriptions of the changes in this PR:--  make sure bk_server.conf contains all the settings in ServerConfiguration.java--  update site/docs/reference/config.md (http://bookkeeper.apache.org/test/content/docs/reference/config/)------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Luc Perkins <None>, Sijie Guo <None>--This closes #368 from zhaijack/issue_360, closes #360;8b895d3087130107f4b5714560e7493349c10f5d
Fix navbar hover issue on the main page--This PR fixes the navbar dropdown UX issue shown in the attached image.--<img width="681" alt="screen shot 2017-08-02 at 10 04 20 am" src="https://user-images.githubusercontent.com/1523104/28886622-05333fcc-776f-11e7-8bea-163f60acaaa1.png">--Author: Luc Perkins <lucperkins@gmail.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #370 from lucperkins/docs/fix-dropdown;23f9d815f1f7fa6fa3df55883fa2ec22535d1d2b
ISSUE #351: Apache rat check failed on master--Descriptions of the changes in this PR:--This fix on #352 was adding the exclusion rule in wrong location. this fix is to address that.--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #353 from zhaijack/fix_rat_issue, closes #351;3b7c06481262d5ac84c1a79fa2479570975100a6
ISSUE #351: Apache rat check failed on master--Descriptions of the changes in this PR:--Excludes cacerts from apache-rat check--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #352 from zhaijack/fix_rat_issue, closes #351;610b603a34c0d7fbea151f7d1fd4951a6db1ac9b
Address the problem on merging #183--Descriptions of the changes in this PR:--listenOn should be running in constructing netty server. because we use binding to prevent two bookies start at the same time. #183--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>--This closes #348 from sijie/ssl_merge, closes #183;41f63c86a3d228887f08946dde14d485a40ac7b9
BOOKKEEPER-588: SSL Support for Bookkeeper--+ Merged changes from eoliville-+ Mutual Authentication--Author: kishorekasi <kkasiud1@gmail.com>-Author: Kishore Kasi Udayashankar <kudayashankar@salesforce.com>-Author: Kishore Udayashankar <kudayashankar@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #183 from kishorekasi/BOOKKEEPER-588-kishore;8e0bd2c3d81b522e97434d8646915f36422a104b
ISSUE #333: [WEBSITE] add bookkeeper slack channel to README.md and website--Descriptions of the changes in this PR:--- add slack channel to README-- add slack channel to website--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Luc Perkins <lucperkins@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #341 from zhaijack/issue_333, closes #333;45e7f08f6a88de2fbb2f23df4c15a88625edff5d
ISSUE #344: add a releases page--Descriptions of the changes in this PR:--Add a releases page for keeping the history of apache releases.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>--This closes #345 from sijie/redirection_on_old_releases, closes #344;3713aa7e09eb99f6d9c7221943e40bc33a025071
ISSUE #339: Use ephemeral port for bookkeeper tests and variable unit test improvements--Descriptions of the changes in this PR:--- Enable ephemeral port by default for all BookKeeperClusterTestCase based test cases-- Removed Multi* based classes. A lot of unit tests unnecessarily extended from those base classes. Converted them to extend BookKeeperClusterTestCase directly. Confirmed this with sijie-- Reduce sleep period for some test cases--LedgerEntry fixes for #317-- use checkState rather than checkNull to keep the behavior consistent as before-- fix BookKeeperTest#testReadEntryReleaseByteBufs--TestBackwardCompat:-- removed testCompact400 (400 has been very long time ago, no one is running 400)-- BookKeeperNettyServer should shut down netty server when failed to construct a bookie--TestDiskChecker:-- increased the threshold to 0.99f. be consistent with TestBKConfiguration--BookieInitializationTest-- make each test method using different ledgers path, so registration won't be conflicting between tests--BookieJournalRollingTest-- make sure bookie port is used correctly on restarting bookies.--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #340 from zhaijack/use_ephemral_ports, closes #339;3daf94143ba2b1352a56c68e1b886d7d7cd499a5
ISSUE #321: Update "who are we?"--Descriptions of the changes in this PR:--- add JV to the PMC list-- add siddharth and charan to the committers list-- sort the people by apache ids--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #334 from sijie/sijie/update_who_are_we, closes #321;b299a699794c1f0aa8447704795361739a8bd055
BOOKKEEPER-1102: Clarify BookieInfoReader and fix associated test flappers--BookieInfoReader:--The previous syncronization logic wasn't really correct, and the logic-at the top of the method was far more complicated than it needed to be.-Restrict bookies to be non-null.  Restructure the code to simply use-the BookieInfoReader instance as a single lock.--One significant behavioral change is that we scan every bookie not in-the map, and we clear from the map bookies which returned an error.--Also, explicitely cache the most recent bookie set reported by the-BookieWatcher.  This eliminates the need to call into BookieWatcher-from getReadWriteBookieInfo and the corresponding error path.  The-periodic scan continues to explicitely check.--Another departure is the addition of an explicit retry-on-error param to-trigger retry if any of the requests failed-(getBookieInfoRetryIntervalSeconds).  We'll only retry the ones that-actually failed (along with any new additions since the last run).  This-is useful because bookie startup triggers the addition of the bookie-node to zk before the bookie actually becomes available for the bookie-info request, so there can be rare races in the unit tests between-BookieInfoReader requesting the info and the bookie actually being up.--Also, add a method to allow tests to wait for updates to be reflected.--PerChannelBookieClient: fix error handling for BookieInfo keys--Passing a key corresponding to a GET_BOOKIE_INFO operation to-errorOutReadKey results in a casting exception, clean up the invalid-calls.--BookKeeperClusterTestCase: add killBookieAndWaitForZK--Should reduce the need for tests to wait for an arbitrary period to let-the cluster "settle".--BookKeeperDiskSpaceWeightedLedgerPlacementTest:--This test was heavily time dependent, and the Thread.sleep values did-not work universally.  Instead, eliminate the arbitrary Thread.sleep-values and instead verify the free space changes on each change.--Also, switch the delay on-testDiskSpaceWeightedBookieSelectionWithPeriodicBookieInfoUpdate-to simply use an atomic boolean to signal the value switch.--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #275 from athanatos/forupstream/BOOKKEEPER-1102;a5f8580f53464065243a9af038935f5893434166
ISSUE #314: Enable checkstyle on bookkeeper-server--Descriptions of the changes in this PR:--- enable checkstyle plugin in bookkeeper-server with a suppression configuration file-- enable sort order rule (it was disabled when the rule was imported)--Author: Jia Zhai <zhaijia03@gmail.com>-Author: zhaijack <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #315 from zhaijack/enable_checkstyle, closes #314;f581e030c79abbde81bf165603fccdb5e6a1d38a
ISSUE #323: [WEBSITE] ci job to automatically publish website to apache once the pull request is merged--Descriptions of the changes in this PR:--- add a Dockerfile to use ruby:2.4.1 to build website-- add scripts to run docker file interactively (run.sh) and in ci (ci.sh)-- also remove a few scripts that were not used by jenkins anymore.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--This closes #332 from sijie/sijie/jenkin_jobs, closes #323;50f67361d5deea529d0af80a61e3312a8dd31e7e
ISSUE #320: add scripts for publishing new website to staging and apache--Descriptions of the changes in this PR:--- script for staging changes to a staging-site repo-- steps for how to staging changes for reviews-- script for pushing changes to apache--Author: Sijie Guo <sijie@apache.org>--Reviewers: Luc Perkins <lucperkins@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #322 from sijie/publish_scripts, closes #320;809f2cbf16d9ecb1b04fda23d610deea4c9bfabe
BOOKKEEPER-1103: Fix LedgerMetadataCreateTest random id loop--The previous version would loop indefinitely upon collision.--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #303 from athanatos/forupstream/BOOKKEEPER-1103;3908d9ce6a5530ae2ae8526b9988b983423c026c
ISSUE #294: Beta version of the new website--A generated version of the new site can be seen here:--https://lucperkins.github.io/bookkeeper/--Author: Luc Perkins <lucperkins@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #293 from lucperkins/documentation-changes, closes #294;fdbea38d9767e6eb28fbf8ec7c61491be3e06e66
BOOKKEEPER-935: Javadoc improvements and publish sources and javadocs to Maven Central--Descriptions of the changes in this PR:--- sources: attached source jar for each module-- javadocs: attached javdocs jar for bookkeeper-server, bookkeeper-stats (they are client-facing modules)--for javadocs:-- improve javadoc:aggregate to generate new client-facing api doc. it is comprised with 3 sections now : bookkeeper client, bookkeeper stats api, bookkeeper stats providers-- auditing the client package to make changes to avoid expose internal classes to public.-- introduce interface audience and stability for documenting public interfaces-- improve javadoc for publish api--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This patch had conflicts when merged, resolved by-Committer: Sijie Guo <sijie@apache.org>--This closes #311 from sijie/attach_sources_jar;cf2936548aa7f91e99bb53a8d53cbca567649535
ISSUE #300: EnsemblePlacementPolicy must not use com.google.common.base.Optional but java.util.Optional--Use standard java8 java.util.Optional instead of Optional from Guava.-In BookKeeper 4.5 we are shading Guava so this class is not available to downstream projects--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>, Sijie Guo <None>--This closes #302 from eolivelli/issue-300-no-guava, closes #300;b63eb86da3757a3740f922093128868d5a53394c
BOOKKEEPER-1104: Fix testWithDiskFullAndAbilityToCreateNewIndexFile--The usage threshhold was chosen to be very close to the actual disk-usage at test time.  This made the test unnecessarily fragile in the-case that there other things concurrently using the disk.  Since we-aren't really testing that here, simply set the threshhold to be really-low.--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #310 from athanatos/forupstream/BOOKKEEPER-1104;0ccbc0e9c3e6a82d5e44b8347cc6567e043f253f
ISSUE #296: Bookie supports ephemeral port--Descriptions of the changes in this PR:--- add a flag to allow/disable using ephemeral ports-- change the initialization sequence to support ephmeral port-- added two tests on verifying this behavior--Author: zhaijack <zhaijia03@gmail.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>--This closes #297 from zhaijack/issue_296, closes #296;7a480d3f8e5ec5c8c3592c332cbcab19b4043dad
ISSUE #306: Update SCM info for using mvn:release--Descriptions of the changes in this PR:--- update the SCM info in the pom files, so that mvn:release is able to create release branch.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Matteo Merli <None>--This closes #307 from sijie/use_maven_release, closes #306;c9cf161d81d3fb8afd0af647e1f3d23f9fb50f04
ISSUE #308: LocalBookKeeper.java rethrow Exception in case of failed boot--Do not swallow generic Exceptions during the boot of LocalBookKeeper and let the caller handle errors--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <None>--This closes #309 from eolivelli/issue-308-localboo-exce, closes #308;d5f824755028e08e07e7f3b326b097148c9b3bec
ISSUE #271: LedgerHandle#readEntries leaks ByteBufs--Add a setNettyUsePooledBuffers() client configuration option to let the user decide to use Pooled vs Unpooled ByteBufs.-Using v2 wire protocol Application receives the original ByteBuf return from Channel and it is responsible for 'releasing' it.--Add assertions on LedgerEntry to prevent the user from accessing data more then once--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Matteo Merli, Sijie Guo--This closes #276 from eolivelli/issue-271-leaks, closes #271;c00cb9f69104c99d7ad10242c04175a5d9ef3801
ISSUE #295: LocalBookKeeper fails to start up--Descriptions of the changes in this PR:--remote the zk port and zk servers from the classes and use the values passed in from the method.--Author: Jia Zhai <zhaijia03@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #298 from zhaijack/issue_295, closes #295;671ec2b21d6e603f00abc8f92a04bbec7d5750b2
ISSUE #196: Create Jenkins configuration using OpenStack Jenkins Job Builder--Descriptions of the changes in this PR:--Introduction of Jenkins Job Builder script, in order to have the configuration of Jenkins jobs directly stored in GIT repo.-This will enable reviews of Jenkins configuration--Author: Nicolò Boschi <nicolo.boschi@diennea.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>, Sijie Guo <sijie@apache.org>--This closes #206 from nicoloboschi/JenkinsJobBuilder, closes #196;f27bf45e2643016742f997e3c467363cc3407be7
BOOKKEEPER-1017: Create documentation for ZooKeeper ACLs--This is the documentation for ZooKeeper security and there is an intro about security in general.-It is work-in-progress, I created this PR in order to make it visible and gather suggestions while writing--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <None>--This closes #185 from eolivelli/BOOKKEEPER-1017-zookeeper-docs;313cfa66018836e8d6372b06c29ec551fca91e34
ISSUE #247: Missing JavaDoc for classes--Descriptions of the changes in this PR:--- Addressed the `TODO` comments by adding JavaDoc-- Make sure there is a Github issue for each unaddressed `TODO` comment--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #285 from sijie/issue_247, closes #247;ce57acaa1686493fd32fc58d3332d956db06122b
BOOKKEEPER-1044: Entrylogger is not readding rolled logs back to the logChannelsToFlush list when exception happens while trying to flush rolled logs--Descriptions of the changes in this PR:--This is a straightforward fix to add unflushed list of entry log files back to flushed list.--Test is missing at this point because it is a bit complicated to test this without proper mocking. I would defer adding the test later and creating a github issue later on if it makes sense.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #286 from sijie/BOOKKEEPER-1044;24ac8ead6240aaaaa845afccb4e606fbe0da1602
Issue#243 - asyncAddEntry fails with NPE with LedgerHandlerAdv--Fix asyncAddEntry on LedgerHandleAdv and clean up the asyncAddEntry API, drops BKException which is never thrown in asynch functions--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo--This closes #244 from eolivelli/asyncadd-adv, closes #243;96d82102bef3152934f564db16373b12b1689ead
Provide a minimal test case using v2wireprotocol option--Add testcases on addEntry/readEntries and basic fencing--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo--This closes #273 from eolivelli/issue-272-testv2;626ce687e2342b8a75005cf018540fda76ee15d8
ISSUE #263: Enable request rate limiter in zookeeper client--Descriptions of the changes in this PR:--Eanble request rate limiter in zookeeper client. The rate limiter logic is in place, but is never enabled. This change is to expose the settings in configurations and enable them in zookeeper client at both client and server.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>--This closes #264 from sijie/interface_syncs, closes #263;1c567f88d5827d6728f05adc1d478648859d3ff0
ISSUE #267: Bookie should serve in read only mode during shutting down.--Descriptions of the changes in this PR:--Set the bookie in readonly mode during shutting down. (contributed by yzang)--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>--This closes #268 from sijie/readonly_on_shutdown, closes #267;0ef4a29c9c34022816c7584943404d0fb52b9a1c
BOOKKEEPER-1027: Cleanup README--Descriptions of the changes in this PR:--- Move README to README.md (written it in markdown syntax)-- Organized the README as below:-  - what is bookkeeper and what it can be used for-  - getting started-  - documentation-  - contribution--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli, Jia Zhai--This closes #248 from sijie/update_readme;2d992e39da0fc121901a72849b424c86fb099f03
ISSUE #258: BookieInitializationTest.testRegNodeExistsAfterSessionTimeOut failed--Descriptions of the changes in this PR:--Construct new zookeeper client to ensure the tests get new zookeeper session.--(this change is based on 77c7721 )--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #259 from sijie/issue_258, closes #258;11fdac3cfdfe0900db994b45aa17500974ba3907
ISSUE #256: BookieInitializationTest.testWithDiskFullAndAbilityToCreateNewIndexFile failed--Descriptions of the changes in this PR:--in c49621b, we allow creating FileInfo even when disk is full to allow fence requests succeed at this case.--it is conflicted with Charan's change. Since there is already a setting to configure the min usable size to allow index file creation. if we configure that to be zero, it is same as allowing index file creation even disks are full. so removing the fallback logic introduced in c49621b.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Charan Reddy Guttapalem, Enrico Olivelli--This closes #257 from sijie/issue_256, closes #256;7e9350cff67f0cb72ab757d500d98044cbdd4264
ISSUE #249: Organize findbugs and checkstyle files in buildtools module--Descriptions of the changes in this PR:--Organize findbugs and checkstyle files in buildtools module--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Matteo Merli <None>--This closes #250 from sijie/buildtools, closes #249;7277657740c276b6f036322177c147264ba5100b
BOOKKEEPER-980: BookKeeper Tools doesn't process the argument correctly--Descriptions of the changes in this PR:--Fix the issue described in [BOOKKEEPER-980](https://issues.apache.org/jira/browse/BOOKKEEPER-980).--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <None>, Venkateswararao Jujjuri (JV) <None>--This closes #255 from sijie/BOOKKEEPER-980;f47dd4272f54bb95fd38abdd6c492dbe199dd7a4
ISSUE #252: Enable four-letter-words zookeeper commands in localbookie--Descriptions of the changes in this PR:--Enable four-letter-words zookeeper commands in localbookie--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>, Matteo Merli <None>--This closes #253 from sijie/fix_4letters_issue, closes #252;d61cfaba69cb0f87bc388889a58f2095f4034f30
ISSUE #230: Add Checkstyle to the build process (Part 2)--Fix issues checkstyle reported in-  - org.apache.bookkeeper.auth-  - org.apache.bookkeeper.bookie--Checkstyle is not added to the bookkeeper-server yet.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: sigee <sigee15@gmail.com>--Reviewers: Jia Zhai <None>, Sijie Guo <None>--This closes #234 from sigee/checkstyle2, closes #230;086537beda9427c057a286ad6c4614659da6ed7f
BOOKKEEPER-1095: Long Poll - Server and Client Side Changes--Descriptions of the changes in this PR:--- changes on FileInfo to support notifications on LAC changes-- a new ReadEntryLongPollV3 processor to process readEntry requests with long poll flags-- a new public API for long poll: readLastConfirmedAndEntry. if it is reading beyond the LAC, it will become a long poll request and wait for advancing LAC on bookie side; if it isn't reading beyond the LAC it will be normal reads.-- also have a speculative mechanism for long poll reads.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #220 from sijie/BOOKKEEPER-1094;1b79adaae7ffd4736530bd1088b45de8ac049f98
ISSUE #237: Upgrade to ZooKeeper 3.5.3-BETA--Descriptions of the changes in this PR:--Update ZooKeeper dependency from 3.5.1-alpha to 3.5.3-beta.-This will enable ZooKeeper over SSL------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x ] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [ x] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #238 from eolivelli/zookeeper-3.5.3, closes #237;dc1fba1685fe04931ae2966d2ccc5b418af257ca
Add Checkstyle to the build process (Part 1)--Add checkstyle to-- bookkeeper-benchmark-- Stats API for bookkeeper-- Stats provider for codahale metrics-- Stats provider for Prometheus-- Stats provider for Finagle stats-- Stats provider for twitter-ostrich package-- Stats provider for twitter-stats package--and fix issues checkstyle reported.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [ ] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: sigee <sigee15@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #231 from sigee/checkstyle;a84b5e11114c5a6eabeaf17ba60975439593fa2d
ISSUE #228: BookKeeper Server: Index Page Management Memory Growth--Descriptions of the changes in this PR:--** Improvements **--- Never delete a LedgerEntryPage that has been allocated.-- Track free LedgerEntryPage in a separate list-- Use pages from the free pages list as though they were being freshly allocated-- This guarantees that the direct buffer allocation never exceeds the allocated space for index pages--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--This closes #229 from sijie/lru_related_changes, closes #228;387dc83d6d2db6a1d30bac3216a92f875083d144
ISSUE #208: Improve ledger fence logic--Descriptions of the changes in this PR:--Problem:-    When bookie receive a fence request and couldn't find any writable dirs for the new index file, it will throw exception. This behavior can be improved, because as long as ledger fence request be persisted in Journal, we can say the fence request succeed. It should not depends on the success of flushing new index file.--Solution:--- Add option to fall back to pick from all directories regardless of writable or not when we getFileInfo for a new ledger-- Return success only when ledger fence request has been persisted in Journal------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x] Make sure the PR title is formatted like:-    `<Issue #>: Description of pull request`-    `e.g. Issue 123: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue #>` in the title with the actual Issue number, if there is one.-------Author: Sijie Guo <sijie@apache.org>-Author: Yiming Zang <yzang@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #205 from sijie/improve_fencing_behavior, closes #208;c49621bacaa960d240afbbee83a9703b4cbc3ec2
ISSUE #232: Add code-coverage report--Introduce Cobertura And Coveralls.io plugins in order to run code coverage reports--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--This closes #233 from eolivelli/code-coverage, closes #232;ccf83ed5bd49155697e909e13edb572082e838ec
y--Descriptions of the changes in this PR:-Handle handle non-ascii chars in username in merge script.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [X] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [X] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [X] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: jiazhai <zhaijia@live.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #242 from jiazhai/issue_241;8bb699ed468c39e1ae1c01dd7fc02033d7b74ce2
ISSUE #239: typo in class name SpeculativeRequestExecutor (#240);8aac2cab6630de6dee5e1ccef7f15a6f41758b5f
ISSUE #235: Setter for JournalMaxGroupWaitMSec/JOURNAL_MAX_GROUP_WAIT_M…--Add a setter for JournalMaxGroupWaitMSec configuration property--- [x] Make sure the PR title is formatted like:-    `<Issue # or BOOKKEEPER-#>: Description of pull request`-    `e.g. Issue 123: Description ...`-    `e.g. BOOKKEEPER-1234: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue # or BOOKKEEPER-#>` in the title with the actual Issue/JIRA number.-------Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>--This closes #236 from eolivelli/JOURNAL_MAX_GROUP_WAIT_MSEC, closes #235;3b33d636a058f211e1cc24b748dc9888256899c6
BOOKKEEPER-1033: Handle DirsPartitionDuplication--- Provide configuration for allowDirsPartitionDuplication-- while calculating total disk metrics account Partition Duplication--Author: cguttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <guosijie@gmail.com>--This closes #189 from reddycharan/dirspartitionduplication and squashes the following commits:--99fc6fc1 [cguttapalem] BOOKKEEPER-1033: Handle DirsPartitionDuplication-1d453975 [cguttapalem] BOOKKEEPER-1033: Handle DirsPartitionDuplication;9aff6d52e01b50f25f5dbe1086ff10012ca25c48
BOOKKEEPER-1028 and BOOKKEEPER-1029--    BOOKKEEPER-1028: inc/excl opts listunderreplicated--    - Introduce including and excluding BookieId options-    for listunderreplicatedLedgers--    - But there is limitation that, since replicaslist wont be-    updated in underreplicatedledger zNode there is possibility-    of stale information--      -----------------------------------------------------------    BOOKKEEPER-1029: BookieDecommision Workflow--    - LostBookieRecoveryDelay config param is stored in ZK-    - if LostBookieRecoveryDelay is reset to same value then it force triggers audit immediately-    - Added logic to trigger immediately or schedule pending audittask depending on the changed value in ZK-    - good number of testcases validating focetrigger/reschedluing audittask-    - added bookieshell command to get/set LostBookieRecoveryDelay from ZK-    - added bookieshell command to triggeraudit by resetting LostBookieRecoveryDelay-    - added decommissionbookie bkshell command, which validates the complete replication of ledgers stored in the bookie--Author: cguttapalem <cguttapalem@salesforce.com>-Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <guosijie@gmail.com>--This closes #127 from reddycharan/listunderreplicatedpredicate and squashes the following commits:--34bacf3c [cguttapalem] BOOKKEEPER-1029: BookieDecommision Workflow-eb43ec49 [Charan Reddy Guttapalem] BOOKKEEPER-1029: BookieDecommision Workflow-fcb399df [cguttapalem] BOOKKEEPER-1028: inc/excl opts listunderreplicated;29eb420f1cca07c1a3a7748ed7fbb8a5bc54f2fa
Add missed tests for SortedLedgerStorage--Added two missed tests for SortedLedgerStorage. It was missed when we (twitter) merged the SortedLedgerStorage back.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli, Jia Zhai--This closes #227 from sijie/more_memory_table_related_tests;b59d63e8be237e80872f73d92a31b4213d9a649b
BOOKKEEPER-772: Reorder Read Sequence--Descriptions of the changes in this PR:--    - for rackware placement policy, the bookie in the same rack will be preferred.-    - for region-aware placement policy, the bookie in the same region will be preferred.-    - for any readonly or unavailable (high score in bookie failure history) bookies, they will be at the last position in the sequence.--This change is based on #220 . Please review gitsha 1f7dccd for the reorder change.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Matteo Merli <None>--This closes #224 from sijie/reorder_reads;ee0dddee6849d1968500af666571df668d34393a
Issue 223: Code cleanups--Descriptions of the changes in this PR:--There are some different kind of cleanups by commits. To make the code more readeable and improve code quality and improve performance in some cases.-E.g.:- - Remove unnecessary semicolons- - Remove unused/unneeded/duplicated imports-- Replace l to L in long literals-- Remove boxing on an already boxed value-- Replace iterations to bulk operations--Author: sigee <sigee15@gmail.com>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>, Sijie Guo <None>--This closes #217 from sigee/cleanups;21366fee0e43e69591a03d7b517cf66dff2861d9
Issue 225: Remove Parameterized from CompactionTest--Descriptions of the changes in this PR:--- Split the CompactionTest into two, one is by bytes, while the other one is by entries.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>--This closes #226 from sijie/compaction_tests;e735c0305c8b3737e78ba5a1ba15b5d80a5ffb47
ISSUE #221: Make netty server shutdown idempotent--Descriptions of the changes in this PR:--(see the detailed discussion in #221 )--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>--This closes #222 from sijie/make_shutdown_idempotent, closes #221;450629d4314cf467fbf78da2d2a43840d0ccf783
ISSUE #198: TestBackwardCompat.testCompat410 often fails due to io.netty.util.IllegalReferenceCountException--Descriptions of the changes in this PR:--Problem:--in TestBackwardCompat#testCompact400, the test is to verify the current client can't talk to a 4.0.0 server.--The 4.5.0 client is sending a protobuf encoded request to 4.0.0 server. The 4.0.0 server will interpret the 4.5.0 protobuf encoded request, but it will realize this is bad request and sending v2 protocol encoded response. because the request is a bad request, 4.0.0 server sent a response back with unknown op code.--In current v2 ResponseEnDecoder (listed as below), when it doesn't know the op code, it will return the buffer to the channel. this might cause the misbehavior in the channel pipeline to decrement reference count.--Solution:--throw exception in the EnDeCoder when receiving unknown op code. so the netty can close the connection, error out the pending requests and cleaning up the resources.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <None>--This closes #219 from sijie/issue_198, closes #198;1b0492bf2ac547cf583736d3eaf9849498e42f80
BOOKKEEPER-759: Delay Ensemble Change & Disable Ensemble Change--Descriptions of the changes in this PR:--This pull request contains the changes around ensemble change.--- Delay Ensemble Change: Provide a flag to allow delay ensemble change. if that is set to change, will not do ensemble change until it breaks ack quorum requirements.-- Disable Ensemble Change: Provide a runtime feature flag to allow disabling ensemble change. The ensemble change behavior can be disabled on-the-fly via the FeatureProvider.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x] Make sure the PR title is formatted like:-    `<Issue #>: Description of pull request`-    `e.g. Issue 123: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue #>` in the title with the actual Issue number, if there is one.-------Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--This closes #202 from sijie/client_changes/delay_ensemble_changes;5e399df67c2aa1e5f228c62ba8533ca3293ab147
ISSUE #209: Introduce Speculative Read/Read LAC policy--Descriptions of the changes in this PR:--    - Separate out the logic that determines when speculative reads are scheduled from the individual requests into a separate SpeculativeRequestExecutionPolicy-    - Implement the default speculative read execution policy based on the current mechanism of using first and max timeout-    - Initialize the policy once in the BookKeeper object and use it for individual requests by keeping information about the requests in the call chain.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x] Make sure the PR title is formatted like:-    `<Issue #>: Description of pull request`-    `e.g. Issue 123: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue #>` in the title with the actual Issue number, if there is one.-------Author: Sijie Guo <sijieg@twitter.com>-Author: Robin Dhamankar <rdhamankar@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--This closes #200 from sijie/client_changes/speculative_policy, closes #209;95ebc45fa2d0c4028c31c66b790743f4a7909800
ISSUE #207: change the HashSet to BitSet to handle duplicated bookies on reading entries--Descriptions of the changes in this PR:--Problem:--If there happens to have duplicated bookies in same ledger (it happened before when ensemble change still has problem), the read doesn't work as expected. It hang forever.--Solution:--Change the HashSet to BitSet to use bookieIndex rather than InetSocketAddress to track the heardfrom bookies set.------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x] Make sure the PR title is formatted like:-    `<Issue #>: Description of pull request`-    `e.g. Issue 123: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue #>` in the title with the actual Issue number, if there is one.-------Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #199 from sijie/client_changes/bitset, closes #207;75aca2397e43ec321a049aaec514c99cc9fad235
Issue 212: change github PR template to adjust both issue# and jira# (#213)--change PR template to adjust both issue# and jira#----closes #212;b9648998802ce4bf256e33ffd6296b4c973a4824
BOOKKEEPER-1086: ZkUnderreplicationManager cache watcher--Previously, getLedgerToReplicate left watches each time it traversed the-tree until it found a suitable replication target.  Since we don't have-a way of canceling watches, these watches tended to get abandoned,-particularly on interior nodes, which aren't changed much.  Thus,-over time, some nodes would build up a very large number of watch.--Instead, introduce a caching mechanism to remember outstanding watches-and avoid ever creating two watches on the same node.--Author: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #193 from athanatos/forupstream/BOOKKEEPER-1098;32c2859f0bec9ab74965d954bce038480e4dc2ba
BOOKKEEPER-1034: Bookie start in RO when diskfull--When the disk is above threshold, Bookie goes to RO. If we have to restart the-bookie, on the way back, bookie tries to create new entrylog and other files,-which will fail because disk usage is above threshold,-hence bookie refuses to come up. So with this fix we will try to start in RO-mode if RO is enabled.--Also, if bookie has died abruptly then it may missed flushing EntryMemtable and-IndexInMemoryPageManager. So next time when it starts when disc is full-it is failing to create index file and it is shutting down, though we expect it-to start in readonlymode. So Bookie should be able to create index file-though it has reached the diskusagethreshold, while starting the Bookie in-Readonly Mode. But ofcourse there should be some config to safeguard when-disk usable space is so low.--Minor fixes in shutdown logic of Bookie and Bookieserver.--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #190 from reddycharan/bookiestartinreadonlywhendiskfull;9ddd9e6f9e48b03a57a2c78ec2630303abd49782
ISSUE #216: Remove useless and misleading '&= true'--This is just a super minor issue, I stumbled upon it looking into https://github.com/apache/bookkeeper/pull/58...--Assignments like 'shutDownTask =& true' aren't useful at all. I presume that compiler could strip them out but the code is less readable. (Just note that 'x & true == x').--Removed useless assignments.--Author: Diego Salvi <lothruin.mirwen@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #215 from diegosalvi/master, closes #216;fe8ded50ed8f008457665138ec0e6a88bba67f73
ISSUE #203: TestFencing is failing due to LAC piggyback changes--Descriptions of the changes in this PR:--Problem:--TestFencing is failing after merging LAC piggyback changes. Because LAC piggyback will advance last add confirmed when reading entries.--Solution:--Move the addEntry verification to after reading entries.--At the same time, add more logging to #testManyOpen------Be sure to do all of the following to help us incorporate your contribution-quickly and easily:--- [x] Make sure the PR title is formatted like:-    `<Issue #>: Description of pull request`-    `e.g. Issue 123: Description ...`-- [x] Make sure tests pass via `mvn clean apache-rat:check install findbugs:check`.-- [x] Replace `<Issue #>` in the title with the actual Issue number, if there is one.-------Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #204 from sijie/fix_test_fencing, closes #203;189d7e80b4b0096d580bafa66323fa5f099df65d
BOOKKEEPER-1097: GC test when no WritableDirs--- Functional test validating that Compaction takes place even if there-are no writableledgerdir but there are ledgerdirs according to-LedgerDirsManager.getWritableLedgerDirsForNewLog--- end-to-end testcase of Bookie recovery, incase of Bookie ledgerdir reaching-the threshold, and recovering by forcing the gc/compaction--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Sijie Guo <sijie@apache.org>--This closes #188 from reddycharan/gctestnowritabledirs;59696600784c54192877a5742c6b141eadb07e26
BOOKKEEPER-1092: Ledger Recovery (Part 5) - Add Test Case for Parallel Ledger Recovery--This change is based on #180 (ebf7020 is the change for review)--- Add test case for parallel ledger recovery-- More stats for ledger recovery--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #182 from sijie/recovery_improvements_part5;256e7587331eddd51b7c05f27717c9d4dc848500
BOOKKEEPER-1093: Piggyback LAC on ReadResponse--This change is based #178 - (you can review git sha 40ca8c2)--bookkeeper: LAC piggyback at read response--        - bookie server changes-          * cache maximum lac in file info-          * provide getLastAddConfirmed & setLastAddConfirmed in ledger storage-          * addEntry will set its lac thru setLastAddConfirmed-          * readEntry will read latest lac and piggyback-        - client change-          * check whether the response has lac piggybacked, if there is lac update lac in its corresponding ledger handle.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #180 from sijie/piggyback_lac;90e4e46bccdd1a788e10056f4a3818aa2aead452
BOOKKEEPER-1089: Ledger Recovery (part-4) - allow batch reads in ledger recovery--This change is based on #178 - (you can review git sha 82f73ef)--bookkeeper recovery improvement (part-4): allow batch reading in ledger recovery--    - enable batch read in ledger recovery, so we could parallel reading to improve recovery time.--    RB_ID=266145--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--This closes #181 from sijie/recovery_improvements_part4;90a8f283999ddbfee818629e1be17102e63be22c
DL-124: Use Java8 Future rather than twitter Future--Switch to use Java8 CompletableFuture, to reduce dependencies introduced by twitter future and make it more friendly to users (users don't think of using which version of scala).--This change is based on #132 . Gitsha ce0686e is the change to review.--The changes:--- Change Future to CompletableFuture-- Map to thenApply-- flatMap to thenCompose-- Added a FutureEventListener, and switch addEvenListener to whenComplete (or whenCompleteAsync)-- setValue to complete-- setException to completeExceptionally-- add rescue, ignore, ensure to FutureUtils as util functions.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #133 from sijie/change_twitter_future_to_java_future;1bf73e9f5b1d9a982182681156c90c6de026ce17
DL-124: Use Java8 Future rather than twitter Future--Switch to use Java8 CompletableFuture, to reduce dependencies introduced by twitter future and make it more friendly to users (users don't think of using which version of scala).--This change is based on #132 . Gitsha ce0686e is the change to review.--The changes:--- Change Future to CompletableFuture-- Map to thenApply-- flatMap to thenCompose-- Added a FutureEventListener, and switch addEvenListener to whenComplete (or whenCompleteAsync)-- setValue to complete-- setException to completeExceptionally-- add rescue, ignore, ensure to FutureUtils as util functions.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #133 from sijie/change_twitter_future_to_java_future;7e63cff1c110b7b9435a88ab8ab321659057c298
DL-124: Use Java8 Future rather than twitter Future--Switch to use Java8 CompletableFuture, to reduce dependencies introduced by twitter future and make it more friendly to users (users don't think of using which version of scala).--This change is based on #132 . Gitsha ce0686e is the change to review.--The changes:--- Change Future to CompletableFuture-- Map to thenApply-- flatMap to thenCompose-- Added a FutureEventListener, and switch addEvenListener to whenComplete (or whenCompleteAsync)-- setValue to complete-- setException to completeExceptionally-- add rescue, ignore, ensure to FutureUtils as util functions.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #133 from sijie/change_twitter_future_to_java_future;b4770a090a95802250dc69b13487eeb7ff6e0bb3
ISSUE #191: add template for ISSUE and PR--Following BP-9, provide a template for ISSUE and PR.-When create issue, will use ISSUE template; while create PR will use PR template.--Author: jiazhai <zhaijia@live.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--This closes #192 from jiazhai/issue_191, closes #191;363c5d00b847b7eb2a93826b6d947fd3180a37dd
ISSUE #184: Support GitHub issues in bk-merge script--- Recoganize the issue title and normalize it-- Close the corresponding issue when closing the pr--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--This closes #194 from sijie/support_github_issues, closes #184;164c44bb97e5b3ea8c658f5f376390b787061125
DL-204: Bump libthrift to latest version for distributedlog-core--Currently finagle heavily depends on an out-of-dated version - libthrift 5.0. Proxy modules (client, server) depend on this version, however the core library doesn't really depend on libthrift.--This change is to change libthrift to 0.9.* in distributedlog-core and shade it to avoid it conflict with the version used by finagle.--This change is based on #131 . The main change is at gitsha [6e58786](https://github.com/apache/incubator-distributedlog/commit/6e587869f87cdce50ae93ba3d52767719d1ab5a6)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #132 from sijie/change_thrift_for_core_module;46e6b70feda2e8ad61ba13928df93b2c94d3dd4e
DL-199: Be able to support filesystem-path like name--In order to support hierarchical namespace, we need to be able to support filesystem path like log name.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #130 from sijie/DL_199;83c527c32f9aa7ffd89aac2085e0b798a3ced1af
DL-205: Remove StatusCode dependency on DLException--- Remove StatusCode from exceptions. Use integer as exception codes.-- Also re-organize the modules:--- [ ] distributedlog-protocol (for core structures) and distributedlog-core (for core library).-- [ ] proxy: distributedlog-proxy-protocol (new module for thrift generated protocol), distributedlog-proxy-client (proxy client) and distributedlog-proxy-server (proxy server)-- [ ] benchmark & tutorials.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #131 from sijie/new_layout;b90ad5d89717bb3ca161387af4fce4f913c9e0ae
DL-205: Remove StatusCode dependency on DLException--- Remove StatusCode from exceptions. Use integer as exception codes.-- Also re-organize the modules:--- [ ] distributedlog-protocol (for core structures) and distributedlog-core (for core library).-- [ ] proxy: distributedlog-proxy-protocol (new module for thrift generated protocol), distributedlog-proxy-client (proxy client) and distributedlog-proxy-server (proxy server)-- [ ] benchmark & tutorials.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <None>, Leigh Stewart <lstewart@apache.org>--Closes #131 from sijie/new_layout;8618b21a2395834ac2a6ede41635832b9d26d03f
BOOKKEEPER-1096: recursive znode delete--When ledger is deleted, along with leaf node-all the eligible branch nodes should be-deleted in ZooKeeper.--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #186 from reddycharan/recursiveznodedelete;07852d35856dca232450135913090bac27b29abe
BOOKKEEPER-1088: CompactionTest tests are broken because of--Problem:--5fe86525a9c823f79b3e97fd82ea4aa1c75c79eb this commit broken the master. It is because the merge/rebase introduce duplicated lines--Solution:--This change is to remove the duplicated lines introduced at 5fe86525a9c823f79b3e97fd82ea4aa1c75c79eb--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #187 from sijie/sijie/fix_merge_issue;13c5c88f63f4b7faa63c8c7e42d95f94c6a8d204
BOOKKEEPER-748: Move fence requests out of read threads--This change is moving the fence request out of current read threads and using callback to trigger scheduling read entry and also it refactors the ReadEntryProcessV3 to support long poll in the subsequent requests.--Major changes:--- change fence request to use SettableFuture-- refactor ReadEntryProcessV3: to support run fence request in callback and support long poll (in subsequent requests)-- fix stats issue: requests stats measure the latency from bookie receives the request until it sends the response.-- remove "public static final" for state fields. it is not needed for variables in Interface.--Author: Sijie Guo <sijie@apache.org>-Author: Robin Dhamankar <rdhamankar@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>--Closes #174 from sijie/longpoll/part1_server_side_change;58b92de8b5feee37f8bc9a99d8c98c2a9d9df383
BOOKKEEPER-1088: Ledger Recovery (part-3) - Add a ReadEntryListener to callback on individual request--THIS CHANGE IS BASED ON #177  (you can review 868a3c8 for the only change that belongs to BOOKKEEPER-1088).--bookkeeper recovery improvement (part-3): add a ReadEntryListener to callback on individual request.--- add read entry listener which allow doing batch read, but callback on individual entries in sequence. so in recovery op, we could issue batch reads, then on each individual callback do add entry and stop when received NoSuchEntry.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Venkateswararao Jujjuri (JV) <None>--Closes #178 from sijie/recovery_improvements_part3 and squashes the following commits:--dd24faf [Sijie Guo] Merge branch 'master' into recovery_improvements_part3-2e1ebb9 [Sijie Guo] Merge branch 'master' into recovery_improvements_part3-8b8a3c8 [Sijie Guo] bookkeeper recovery improvement (part-3): add a ReadEntryListener to callback on individual request.-db3e98b [Sijie Guo] Address conflicts-f0fb89c [Sijie Guo] bookkeeper recovery improvement (part-2): add a parallel reading request in PendingReadOp-80ffc6c [Sijie Guo] Address conflicts-3db0b84 [Sijie Guo] bookkeeper recovery improvement (part-1): refactor PendingReadOp;5fe86525a9c823f79b3e97fd82ea4aa1c75c79eb
BOOKKEEPER-1087: Ledger Recovery (part 2) - Add a parallel reading request in PendingReadOp--THIS CHANGE IS BASED ON #176 (you can review f0fb89c)--bookkeeper recovery improvement (part-2): add a parallel reading request in PendingReadOp--- add a parallel reading request in PendingReadOp-- allow PendingReadOp to configure whether to do parallel reading or not-- add flag in ClientConfiguration to allow configuring whether to do parallel reading in LedgerRecoveryOp or not.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #177 from sijie/recovery_improvements_part2;b3b958c2b6a7195b23477d181db3fea1e7d1c248
BOOKKEEPER-944: LowWaterMark Storage Threshold--BOOKKEEPER-944: LowWaterMark Storage Threshold--LowWaterMark Storage Threshold and code refactoring--    - Current implementation toggles READONLY status of the bookie as soon as a directory usage falls below the disk storage threshold.-      Added LowWaterMark parameter that limits such switches.-    	1. Bookie transition from RW to RONLY only when all the ledger dirs usage > HWM (storage threshold)-    	2. Bookie transition from RONLY to  RW only when total system disk usage (ledger/index disks) capacity is < LWM-    	3. When bookie is in RW mode all disks which are < HWM (storage threshold) are RW-    - refactored code and separated LedgerDirsMonitor from LedgerDirsManager, to remove circular dependency-      between LedgerDirsManager and LedgerDirsMonitor and also it improves testability by making them separate classes.-      It becomes easier to do functional/unit level testing and fault-injection testing at LedgerDirsMonitor class level.-    - relevant testcases--Author: Andrey Yegorov <ayegorovsalesforce.com>-Co-Author: Charan Reddy Guttapalem <cguttapalemsalesforce.com>--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #108 from reddycharan/lwmhwm;efd8ec26926d2e75f51d6d576543a0dcc116b83f
BOOKKEEPER-1090: Use LOG.isDebugEnabled() to avoid unexpected allocations--Using `LOG.debug(...)` can lead to multiple unexpected memory allocation, even when the logger it's turned off.-For example, int and long parameter are boxed into Integer and Long objects and the var-arg parameters are using an `Object[]` to hold-them.-We should guard all usages of `LOG.debug()` with the `if (LOG.isDebugEnabled()` guard.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli, Sijie Guo--Closes #179 from merlimat/if-debug;5f945f8a02f5171608810eb002443193c3eb058c
BOOKKEEPER-989: Enable Travis CI for Apache BookKeeper--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>, Matteo Merli <mmerli@apache.org>--Closes #168 from sijie/enable_travis_ci;55d1dc45c4761f150c59a34b94d21e39e69f872c
BOOKKEEPER-1086: Ledger Recovery - Refactor PendingReadOp--this change is the first part of improving ledger recovery. it is basically a refactor change, which:--- abstract an interface for LedgerEntryRequest in PendingReadOp-- rename current implementation to SequenceReadRequest, which read the entry in the sequence of quorum.--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #176 from sijie/recovery_improvements;5c81acaccfb0cb1260acdfd7d0bb95ae84f85654
BOOKKEEPER-1056: Removed PacketHeader serialization/deserialization allocation--When parsing the request packet header, use static methods to avoid creating a `PacketHeader` instance.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <None>, Sijie Guo <None>, Venkateswararao Jujjuri (JV) <None>--Closes #175 from merlimat/packet-header-parsing;a9fe7d94f1890f697633fdca8abdeff23903025f
BOOKKEEPER-1074: Remove JMX Bean--This change is based on #160 , the change here is: gitsha [b3be81f](https://github.com/sijie/bookkeeper/commit/b3be81fadae50f2d4a2e938c2735fa35c6c31421)--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Enrico Olivelli, Matteo Merli--Closes #161 from sijie/remove_jmx_beam;dd08ce1a644de00967dd5fe34ce15caa9789d775
BOOKKEEPER-1085: Introduce the AlertStatsLogger--Introduce the AlertStatsLogger used to increment a metric whenever an event that should never happen is detected. Allow specifying an optional scope to better classify the error conditions--RB_ID=598662--Author: Sijie Guo <sijie@apache.org>-Author: Robin Dhamankar <rdhamankar@twitter.com>--Reviewers: Enrico Olivelli, Jia Zhai--Closes #173 from sijie/add_alert_state_logger;d1f37dafbb475d4d6aab4769335550428c680269
BOOKKEEPER-1083: Improvements on OrderedSafeExecutor--    - use listeningscheduledexecutorservice for the threads-    - as a general util class, expose chooseThread to allow applications use specific thread-    - add a method to force shutdown executor--Author: Robin Dhamankar <rdhamankar@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli--Closes #171 from sijie/add_monitored_thread_pool;e33ec10aa400f32c2e0278c15ea80a0f624e5919
BOOKKEEPER-1084: Make variables finale if necessary--not all logger in bookkeeper & hedwig are static. some class like PendnigReadOp and LedgerEntry would have lots of objects, it might be bad. so this task is to make logger as a static variable if it didn't.--with benefit, cleaning up the imports when touching that file.--RB_ID=141138--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Jia Zhai, Enrico Olivelli--Closes #172 from sijie/make_finale;77a01dc7e6431092f82a7efb02789beb165b75e2
BOOKKEEPER-1078: Local BookKeeper enhancements for testability--BookKeeper: Local Bookkeeper enhancements for testability--1. Allow creating local bookies without always starting a zookeeper server - This is required as tests may want to create and use their own instance of a test zookeeper-2. Allow using non default zookeeper host and more importantly non default ZK port-3. Allowing the caller to specify the initial port for the bookies-4. Optionally shutdown bookies when the bookie thread exits--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>-Author: Robin Dhamankar <rdhamankar@twitter.com>--Reviewers: Enrico Olivelli, Jia Zhai--Closes #164 from sijie/local_bookkeeper_enhancements;0eca5ff57f6e19fe5829d5ef8df228411467401f
BOOKKEEPER-1071: Use per connection instances of request encoder/decoder--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli, Sijie Guo--Closes #170 from merlimat/bk-1071;da70648719679fd1db001c74ad873bf134f16198
BOOKKEEPER-1073: Several stats provider related changes.--- add finagle stats provider-- provide the ability to remove gauge and scopes-- update jetty versions for twitter-sciences stats provider--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai, Enrico Olivelli--Closes #160 from sijie/add_channel_writer_timer;fc51f73cbc9cdaae9876bc08cafa3e7a80826207
BOOKKEEPER-1079: shell lastMark throws NPE--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Sijie Guo--Closes #167 from eolivelli/BOOKKEEPER-1079;9bade929dd87829a8903e402f6c3e3be366a854a
BOOKKEEPER-1010: Moving Guava to 20.0--This patch updates Guava to version 20.0 and shades it--Author: arvindkandhare <arvind.kandhare@emc.com>-Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo, Enrico Olivelli--Closes #166 from eolivelli/guava_version;fd3331a2769a29c379ed63e21ed2dc3c0f85ba25
BOOKKEEPER-1077: Allow configuration journal/ledger paths for local bookkeeper.--Author: Sijie Guo <sijieg@twitter.com>-Author: Robin Dhamankar <rdhamankar@twitter.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #163 from sijie/to_string_mark;6698912e4d35119a2e85a6ea3877c6771073489c
BOOKKEEPER-1075: BK LedgerMetadata: more memory-efficient parsing of configs--It is the contribution from Alex Yarmula--commit 9d9d7dd26235a9beda4421b7bed750fea1789076-Author: Alex Yarmula <aktwitter.com>-Date: Wed Sep 23 05:57:30 2015 -0700--BK LedgerMetadata: more memory-efficient parsing of configs-Looking at the most prevalent client-side memory allocations, I noticed that we allocate 4KB every time we open a ledger. This is caused by allocating a 4KB buffer (in TextFormat.toStringBuilder) to account for the maximum possible Protobufs message, which is unnecessary in our case: we know the exact size of the metadata ( << 500 B) and don't need to allocate more.-TextFormat.merge(Readable, Message.Builder) is the current method we use. This changes to use TextFormat.merge(CharSequence, Message.Builder), which avoids the extra 4K allocation conversion + an extra StringBuilder.--RB_ID=745700--Author: Alex Yarmula <ak@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli, Sijie Guo--Closes #162 from sijie/bk_ledger_metadata_efficiency;64bedc2f92d5bb17783c6ea2a2db7ea29170f264
BOOKKEEPER-1068: Expose ByteBuf in LedgerEntry to avoid data copy--To avoid copying the entries payloads when writing/reading on a ledger and having to allocate a lot of `byte[]` on the JVM heap, we need to accept Netty ByteBuf buffer.--By passing a ByteBuf, an application can use a pooled buffer, pointing to direct memory, to the `LedgerHandle.addEntry()` and have the same buffer forwarded on the connection sockets to the bookies.--The same thing on the read side, `LedgerEntry` exposes an additional `getEntryBuffer()` method that can be used to get the underlying buffer and possibly forward that to some other connection, with zero-copy behavior (excluding getting data in-out of the kernel).--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Jia Zhai, Sijie Guo, Enrico Olivelli--Closes #155 from merlimat/byte-buf-ledger-entry;7b1eec47092d0de6776c5a89575dbfc678165ee7
BOOKKKEEPER-1072: CompactionTest is flaky when disks are almost full--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <None>, Jia Zhai <None>--Closes #159 from sijie/BOOKKEEPER-1072;8ba8ab9403dbc464c68caf6e7cd3fc490670731e
BOOKKEEPER-391: Support Kerberos authentication of bookkeeper--This patch contains a very basic AuthProvider which uses JAAS and so enables the usage or GSSAPI/Kerberos for BookKeeper authentication--Author: eolivelli <eolivelli@apache.org>-Author: eolivelli <eolivelli@gmail.com>--Reviewers: Robert (Bobby) Evans <None>, Sijie Guo <None>--Closes #110 from eolivelli/BOOKKEEPER-391-kerberos;667390d1a6305c31608130929ba0d68a0b5a4763
Remove package-info.java under com.twitter.distributedlog.subscription--There is still one file left under com.twitter.distributedlog after repackage. This change is to delete this file.--https://github.com/apache/incubator-distributedlog/tree/master/distributedlog-core/src/main/java/com/twitter/distributedlog/subscription--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <zhaijia03@gmail.com>--Closes #129 from sijie/sijie/remove_subscription_files;bc973476cbed0fa5bc2e5349c4478f7697c7dadd
BOOKKEEPER-1070: bk-merge-pr.py use apache-rat:check goal--Author: eolivelli <eolivelli@apache.org>--Reviewers: Jia Zhai <None>--Closes #158 from eolivelli/BOOKKEEPER-1070-rat;7da9ed293db87103efcc28b7e706c0b386131ec1
BOOKKEEPER-1055: Optimize handling of masterKey in case it is empty--On each request client and bookies are exchanging the ledger masterKey, which is a 20 bytes MAC digest of the ledger password.--For each request there is a considerable overhead in allocating byte arrays when parsing the add/read requests.--If the client is a passing an empty password, we should optimize the data path to skip all allocations (related to the masterKey) and instead rely on a static byte array.--Author: Matteo Merli <mmerli@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--Closes #156 from merlimat/empty-password;0f16da8961521372b9bec953ab62c8913bb8dc31
BOOKKEEPER-1069: If client uses V2 proto, set the connection to always decode V2 messages--Avoid handling parsing exception for each request and instead adapt to what the client is sending.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <None>, Sijie Guo <None>--Closes #157 from merlimat/always-v2;e44c7388399e5589cf44e38c58bb84c74da544af
BOOKKEEPER-1048: Use ByteBuf in LedgerStorage interface--To pass ref-counted buffer from Netty directly to the storage and the Journal, we need to have LedgerStorage to accept ByteBuf instead of ByteBuffer--#### Note--This commit is on top of BOOKKEEPER-1048 / #138. Once that gets merged, I will rebase. Posting now to get Jenkins run. Please review last commit f53f772f79d0a334edc0f05e66edb7cc645b1ffa in this PR for now.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <None>--Closes #139 from merlimat/bytebuf-in-ledger-storage;0f81461d2d1dc5cf9db4de9a46599d7d64e3dac6
BOOKKEEPER-1061: BookieWatcher should not do ZK blocking operations from ZK async callback thread--In some cases, the BookieWatcher can get the ZK event thread stuck. This happens when a ZK blocking request is issued from a ZK callback thread.--We should decouple the blocking requests in a separate executor to avoid deadlocking ZK client.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>, Sijie Guo <sijie@apache.org>--Closes #149 from merlimat/bookie-watcher-thread;5d43260e84c6121df72c0ee4c844651bfb726638
BOOKKEEPER-1067: Add Prometheus stats provider--Prometheus (https://prometheus.io) is a metrics collection system, similar but much more flexible than graphite.--It would be good to expose the Bookie and BookKeeper client stats directly so that a Prometheus instance can collect them (and also check the process status and add alerts).--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #154 from merlimat/prometheus;d863513719b696638e3369f4bbfde9abf5fd3d5f
BOOKKEEPER-1008: Netty 4.1--Added more ref-count fixes from yahoo-4.3 branch on top of #116--Author: Matteo Merli <mmerli@apache.org>-Author: Matteo Merli <mmerli@yahoo-inc.com>-Author: Kishore Kasi Udayashankar <kudayashankar@salesforce.com>--Reviewers: Jia Zhai <zhaijia03@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #138 from merlimat/netty-4.1;74f795136c1fff3badb29fc982d0cc2d43096b45
BOOKKEEPER-1058: Ignore already deleted ledger on replication audit--Replication auditor should skip ledgers that were deleted since the auditing was started.--Author: rdhabalia <rdhabalia@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #146 from merlimat/ignore-deleted-ledgers-in-replication;811ece53a1c975c4e768422f3d622ac9de6b3e41
BOOKKEEPER-1063: Use executor.execute() instead of submit()--… creation of unused FutureTask--When submitting tasks to an executor, if the `FutureTask` object is not being used we should use `execute()` instead of `submit()` in order to avoid the task object allocation.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #150 from merlimat/executor-execute;5130d3596f7fb862e38910bf0a0a1dae3ed892e8
BOOKKEEPER-1064: ConcurrentModificationException in AuditorLedgerCheckerTest--As seen in:-https://builds.apache.org/job/bookkeeper-master-git-pullrequest/371/--The test is iterating over a hash map that gets updated by a different thread. The map needs to be concurrent.--```-java.util.ConcurrentModificationException-	at org.apache.bookkeeper.replication.AuditorLedgerCheckerTest.stopAuditorElectors(AuditorLedgerCheckerTest.java:130)-	at org.apache.bookkeeper.replication.AuditorLedgerCheckerTest.tearDown(AuditorLedgerCheckerTest.java:114)-```--All subsequent tests in the same class are failing because of the 1st test not cleaning up properly.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #151 from merlimat/bk-1064-auditor-ledger-test;d7f7b922f3ea0471452115c6271fd18ab63d3505
BOOKKEEPER-1066: Introduce GrowableArrayBlockingQueue--In multiple places, (eg: journal, ordered executor, etc..), we are using `LinkedBlockingQueue` instances to pass objects between threads.--The `LinkedBlockingQueue` differs from the `ArrayBlockingQueue` in that it doesn't require to define a max queue size, though, being implemented with a linked list, it requires to allocates list nodes each time an item is added.--We can use a `GrowableArrayBlockingQueue` that behaves in the same way as the `LinkedBlockingQueue`, but it's implemented with an array that can be resized when the queue reaches the capacity.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #153 from merlimat/growable-blocking-queue;e2894a9e9946b4cc4647c280094bcb2eb1a521ea
BOOKKEEPER-1054: Add gitignore file--We should have a .gitignore file to hide all build generated files.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>--Closes #144 from merlimat/git-ignore;eeaddeda66fc687d20c2309a8cbc109c5dfeed89
BOOKKEEPER-1059: Upgrade to SLF4J-1.7.25--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>--Closes #147 from merlimat/slf4j-1.7;fc4800544bcd60c66fa682e6ffcbf2789b7fbb74
BOOKKEEPER-1060: Add utility to use SafeRunnable from Java8 Lambda--Since BK-4.5.0 is already switched to Java8, we should have a simple and concise way to pass lambdas where a `SafeRunnable` is required.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>--Closes #148 from merlimat/safe-runnable;af397e2247d453af25db6a1f33426fb9c69e2cdf
BOOKKEEPER-1053: Upgrade RAT maven version to 0.12 and ignore Eclipse project files--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Jia Zhai <None>--Closes #143 from merlimat/rat;d8a7ac310947049f65687e33d92b847c44c91a39
BOOKKEEPER-1052: Print autorecovery enabled or not in bookie shell--Print the current status of auto-recovery, whether it's enabled or disabled.--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Enrico Olivelli <None>--Closes #142 from merlimat/autorecovery-enabled;5531014ab1cf282d35d4d53db975192b853bf7a6
BOOKKEEPER-1051: Fast shutdown for GarbageCollectorThread--Several unit tests are taking very long time to complete (eg: `BookieLedgerIndexTest` taking ~10 minutes).-The reason is that these tests are playing with the ZK quorum shutting it down and after the test succeeds, the shutdown phase is taking long time, since we try to do graceful shutdown with 1min wait time.-I think is better to interrupt immediately the garbage collector thread when shutting down the bookie.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>--Closes #141 from merlimat/fast-gc-thread-shutdown;1a2e017b65812e6e50975213a365aa37eba9fa96
BOOKKEEPER-1050: Cache journalFormatVersionToWrite when starting Journal--Reading the journal version format from `ServiceConfiguration` each time is inefficient.-`ServiceConfiguration` is based on Java properties which is based on a String to object hashtable. Each read implies acquiring a mutex and converting from object to int.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <None>--Closes #140 from merlimat/cache-journal-conf;61a5446b8923e5ce0b2a46891a385fd480275bac
BOOKKEEPER-1047: Add missing error code in ZK setData return path--The log warning is not printing the error code returned by ZooKeeper--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #137 from merlimat/missing-error-msg;d5af77c05256d5942c19aff2654c5d8f5ac1eb79
BOOKKEEPER-1046: Avoid long to Long conversion in OrderedSafeExecutor task submit--When submitting tasks to an OrderedSafeExecutor, most of the time a ledger id is being passed. Given that the method accepts and Object, the primitive `long` is boxed into a `Long` allocated on the heap.--Added specific method overload to directly accept longs as the key in the OrderedSafeExecutor.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@apache.org>--Closes #136 from merlimat/executor-long-conversion;25c113f62a40bff6ff91cf82f699fd1d35b102fb
BOOKKEEPER-1045: Execute tests in different JVM processes--The current Maven Surefire configuration is using:-```xml-<forkMode>always</forkMode>-```--This is a deprecated config and apparently it's not creating new processes for each test as intended.--Currently the tests are leaking a big number of files and threads due to several reasons:- * Tests that instantiate bookies and call shutdown() without calling start() before are creating and initializing the ledger storage but not closing it, leaking threads and several fds-  * ZooKeeperClient sometimes doesn't shutdown the zk handle if the test completes too quickly, leaking sockets.- * Several tests are passing bad config, so the bookie/client start gets exception (on purpose) and then doesn't clean up some partial objects.- * ...--That make running the test suite to be dependent on ulimit of the machine.--Until we can fix (almost) all the test to do proper cleanup, we should make maven to run tests in separated processes.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli<eolivelli@apache.org>, Jia Zhai <zhaijia@apache.org>--Closes #135 from merlimat/bk-1045-test-forks;5d282dceae140577b97a12db5b2b531c7d84e985
BOOKKEEPER-552: 64 Bits Ledger ID Generation--This PR supersedes #112--Instead of moving LongHierarchicalLedgerManager to HierarchicalLedgerManager, LongHierarchicalLedgerManager is still a stand-alone manager. HierarchicalLedgerManager has been moved to LegacyHierarchicalLedgerManager, and a new HierarchicalLedgerManager class has been put in its place, which is backwards-compatible with the original (now legacy) HierarchicalLedgerManager.--This new HierarchicalLedgerManager leverages the new LongZkLedgerIdGenerator to generate Ids, and uses the LongHierarchicalLedgerManager to manage metadata for ledger IDs > 31 bits long. For shorter ledger ids, the LegacyHierarchicalLedgerManager is used, to keep backwards-compatibility.--Author: Kyle Nusbaum <knusbaum@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>--Closes #114 from knusbaum/BOOKKEEPER-552;057af8dbce6c08794eb8b46ca52ca13f222d9bbb
BOOKKEEPER-1019: Support for reading entries after LAC--This patch introduces a new client-side configuration option to allow reads outside the boundary of the local LastAddConfirmed value.--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--Closes #121 from eolivelli/BOOKKEEPER-1019-read-after-lac;9c79e078b8cfefc24251aefcb727760fb99229ed
BOOKKEEPER-1042: Deploy SNAPSHOTS of master to public Apache Repository--Make all pom.xml files have a -SNAPSHOT version.--Currently we have the 'compats' subprojects which have a strange versioning scheme.-Actual versioning scheme for that poms will clash will other versions of the project, because they are fixed and do not depend on the common parent pom.--Changing the version will make the build more reproducible and it is a prerequisite for the deployment of -SNAPSHOT version to the official Apache Snapshots Repository--Author: Enrico Olivelli <eolivelli@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--Closes #134 from eolivelli/BOOKKEEPER-1042-pom-for-snapshots;c72ff5efbfaa21cbc95c21f89692190aa52a5a29
BOOKKEEPER-1043: Upgrade Apache Parent Pom Reference to latest version--Author: eolivelli <eolivelli@apache.org>--Reviewers: Ivan Kelly <ivan@ivankelly.net>--Closes #133 from eolivelli/BOOKKEEPER-1043-upgrade-pom;c94bbbacd7dcf369c51480a21ad8e55f1af4c9a6
BOOKKEEPER-1038: Fix findbugs warnings and upgrade to 3.0.4--- upgrade to findbugs 3.0.4-- fix DLS_DEAD_LOCAL_STORE At BookieInfoReader.java (introduce a constant)-- fix EQ_OVERRIDING_EQUALS_NOT_SYMMETRIC At PerChannelBookieClient.java (introduce a V3CompletionKey)--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #131 from eolivelli/BOOKKEEPER-1038-findbugs;83d5d9e2a51c8c135bfc97d3831beccebe11a69a
BOOKKEEPER-1039: bk-merge-pr.py ask to run findbugs and rat before merge--Add the ability to optionally run findbugs and apache RAT before every merge using the PR merge script--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #132 from eolivelli/BOOKKEEPER-1039-merge-findbugs;de59bd2ad038428cfa61cfdefe1266f3356e1937
BOOKKEEPER-1018: Allow client to select older V2 protocol (no protobuf)--Tested manually - running all tests locally. Will tag contributors. when ready for review (for now putting up to test via Screwdriver and manual review)--Author: Govind Menon <govindappumenon@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #126 from govind-menon/BOOKKEEPER-1018;f74d07d6b96ba3e6f1270d053fa36676cf680304
DL-174: added getParent method to Utils to replace usage of File.getParent which changes / to \ on Windows--…ich changes / to \ in Windows.--Author: adamtracymartin <atmartin@yahoo.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #104 from adamtracymartin/DL-174;6a80ebc30244da56bc0e3fc64d02650ddfd6d6cb
DL-173: changed FileUtils.deleteDirectory to FileUtils.forceDeleteOnExit so d…--I am doing a new pull request because I deleted the branch in the remote.-Actions done to fix the conflict.-1. git checkout DL-173-2. git checkout master distributedlog-protocol/src/main/thrift/service.thrift-3. git fetch-4. git add *-5. git commit with message--The actual fix for this branch is changing FileUtils.deleteDirectory to FileUtils.forceDeleteOnExit.--Author: adamtracymartin <atmartin@yahoo.com>--Reviewers: Jia Zhai <zhaijia03@gmail.com>, Sijie Guo <sijie@apache.org>, Leigh Stewart <lstewart@apache.org>--Closes #116 from adamtracymartin/DL-173;ba3505e60f83f8f99c480414a56dd6dec25a832b
DL-196: Remove 'Copyright 2017 The Apache Software Foundation' from license header--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <zhaijia03@gmail.com>--Closes #126 from sijie/sijie/fix_license_headers;0dd0e4fe0ae29dec3864e7539144a6ffca64df19
BOOKKEEPER-997: Wire protocol change for supporting long poll--adding fields in ReadRequest to support piggying back lac on read responses and support long poll requests.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Matteo Merli <mmerli@apache.org>--Closes #125 from sijie/longpoll/part0_wire_protocol_changes;24fae0322327d8fd75c30524546924f27e278448
BOOKKEEPER-1022: Make BookKeeperAdmin implement AutoCloseable--Author: eolivelli <eolivelli@apache.org>--Reviewers: Robert (Bobby) Evans <None>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--Closes #128 from eolivelli/BOOKKEEPER-1022-bkadmin-autocloseable;12bb13cdb1feca0fa6739f8e6287c326fb5fdb94
BOOKEEPER-1002: Limiting the number of open files to avoid process max--Author: Matteo Merli <matteo.merli@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #129 from kishorvpatil/bk1002;0f155f38bb48d23aab4ac8489f7908925b8f0cca
BOOKKEEPER-1031: close the ledger handle in ReplicationWorker.rereplicate--…cate--Otherwise, we build up an unbounded set of Listeners in the-AbstractZkLedgerManager listenerSet structure which never go-away.--Signed-off-by: Samuel Just <sjustsalesforce.com>--Author: Samuel Just <sjust@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #130 from athanatos/forupstream/BOOKKEEPER-1031;48aa69dd0ba41f5ba7bb2b04f31172c919be4391
BOOKKEEPER-1021: Improve merge script to handle github reviews api--Author: Sijie Guo <sijie@apache.org>--Reviewers: Govind Menon <None>--Closes #123 from sijie/sijie/improve_merge_scripts;ab707d2c6b3251b2a9a30a6d14074704460b3da5
BOOKKEEPER-1018: Revert ": Allow client to select older V2 protocol (no…--… protobuf)"--This reverts commit 9001e300ce0d5d2655d437e3eaa52f91487caed6.--I broke trunk - not exactly sure how - I will fix it and put up the PR again. For now I'm reverting the commit.--Author: Govind Menon <govindappumenon@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #124 from govind-menon/BOOKKEEPER-1018-Revert;f30f60889e0810a47797daf4107c0d9bc2ee998c
BOOKKEEPER-1018: Allow client to select older V2 protocol (no protobuf)--Originally done by Matteo Merli (merlimat). Tagging sijie and eolivelli  for review.--Author: Govind Menon <govindappumenon@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #120 from govind-menon/BOOKKEEPER-1018;9001e300ce0d5d2655d437e3eaa52f91487caed6
BOOKKEEPER-1020: Fix Explicit LAC tests on master--Author: eolivelli <eolivelli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Robert (Bobby) Evans <evans@yahoo-inc.com>--Closes #122 from eolivelli/BOOKKEEPER-1020-fix-explicitlac-test;9836c87dc2c082c46692d60c60cf9e23c7b0b06c
BOOKKEEPER-390: Provide support for ZooKeeper authentication--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #76 from eolivelli/BOOKKEEPER-390;b30b527ba995978694ebf735c02b508374001021
BOOKKEEPER-1004: Allow bookie garbage collection to be triggered manu…--Ran CompactionTest#testForceGarbageCollection--Author: Govind Menon <govindappumenon@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #109 from govind-menon/BOOKKEEPER-1004;825e0e7b4a27730d85afbe823a405ba333de3a65
BOOKKEEPER-852: Release LedgerDescriptor and master-key objects when not used anymore--Maps with ledger descriptors and master-keys are not cleaned after a ledger gets deleted.--For this PR, please only take a look at the last commit 18e3455. The other 2 commits are already in separate PRs. I'll rebase this PR once they'll get merged.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #78 from merlimat/bk-ledger-descriptor;bf8ef14bc1bfdde6c6c8edcd7f380b4beca023f6
BOOKKEEPER-950: Ledger placement policy to accomodate different storage capacity of bookies--…ge capacity of bookies--This change introduces Disk weight based ledger placement. Currently free disk space is the only supported-weight for a bookie. This change also introduces a new protocol message between bk client and server-called GET_BOOKIE_INFO. This message is used by the client to retrieve the free disk space info from-all the bookies. The existing placement policies: DefaultPlacementPolicy and RackAwarePlacementPolicy-have been enhanced to make use of the weight while selecting bookies. New test cases have been added to-test RackawarePlacement with weights. A new test class has been added to test the weight based selection-algorithm in a stand alone fashion.--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #93 from rithin-shetty/weightBasedPlacementDec13;0583175de72446d00088611000310b000e8e61df
DL-184: reduce server_graceful_shutdown_period_ms from 35s to 20s, which is smaller than the default daemon stop timeout value--Author: xieliang <xieliang007@gmail.com>--Reviewers: Leigh Stewart <lstewart@apache.org>, Sijie Guo <sijie@apache.org>--Closes #115 from xieliang/DL-184-graceful;03c53f514867dac06d72ec587827b22acb457d73
BOOKKEEPER-970: Bump the zookeeper version to 3.5--in DL, we need to leverage the asynchronous version of 'multi' in zookeeper. so this jira is to bump the zookeeper version to 3.5 to support async multi.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #79 from sijie/sijie/bump_zookeeper_version;1e4ccaf167936fb4ad0de8c29ecf840bed3e89ed
BOOKKEEPER-1001: Make LocalBookiesRegistry.isLocalBookie() public--Author: Francesco Caliumi - Diennea <francesco.caliumi@diennea.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>, Sijie Guo <sijie@apache.org>--Closes #106 from caiok/BOOKKEEPER-1001;986110c4d03a38db81c166216cf4db81a9cb5cb7
BOOKKEEPER-1013: Fix findbugs errors on latest master--- 100% synchronization on _explicitLac_ on FileInfo-- 100% synchronization on _length_ on LedgerHandle-- fixed the print format issue on journal dir names array-- fix checkpointsource list hashCode, equals()--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #118 from sijie/sijie/bk_1013;3d3340be7d754af1738a117ee07e3bed04ec5547
DL-191: Fix license header issues--the copyright year is wrong.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>, Flavio Junqueira <fpj@apache.org>--Closes #121 from sijie/sijie/fix_license_header;b2285e64df3258dbab1d84687118cbdc041891d8
BOOKKEEPER-1007: Explicit LAC: make the interval configurable in ms--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Robert (Bobby) Evans <None>, Venkateswararao Jujjuri (JV) <None>, Sijie Guo <sijie@apache.org>--Closes #111 from eolivelli/BOOKKEEPER-1007-explicitlac-ms;f20568eaa25e0efe6926ede9030a210382e3005b
BOOKKEEPER-1003: Fix TestDiskChecker so it can be used on /dev/shm--The test generates a threshold which is negative if used on a disk where-the usable disk size is very close to the total disk size. A negative-threshold is invalid so the test fails in the wrong way. This fix stops-the threshold from going negative.--Full disclosure, most of these changes were actually done by ivankelly  For this I am mostly just putting them back into open source.--Author: Kishor Patil <kpatil@yahoo-inc.com>--Reviewers: Venkateswararao Jujjuri (JV) <vjujjuri@salesforce.com>, Sijie Guo <sijie@apache.org>--Closes #107 from kishorvpatil/BOOKKEEPER-1003;f3671fc9f588c7a53a9b3cdd520580c45dae06e3
BOOKKEEPER-999: Stop leaking threads in BookKeeper client--Author: Robert (Bobby) Evans <evans@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <zhaijia03@gmail.com>, Kai S <None>, Venkateswararao Jujjuri (JV) <None>--Closes #105 from revans2/BOOKKEEPER-999;32ebf0ad68f85daffdec571e28206339a4d09443
BOOKKEEPER-998: Increased the max entry size to 5MB--Full disclosure, most of these changes were actually done by merlimat For this I am mostly just putting them back into open source.--Author: Robert (Bobby) Evans <evans@yahoo-inc.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Venkateswararao Jujjuri (JV) <None>--Closes #104 from revans2/BOOKKEEPER-998;28c264c8655f74e09ceee5ad499942cfb0dc65dc
BOOKKEEPER-1009: Use multiple journals in bookie--Mostly https://github.com/apache/bookkeeper/pull/71 with comments addressed--Will shortly add tests.--merlimat  Would it be ok to close 71?--Author: Govind Menon <govindappumenon@gmail.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #115 from govind-menon/BOOKKEEPER-1009_B;123eccd435a4a96a9147ed4a24efbe9025fe79ba
BOOKKEEPER-996: LongHierarchicalLedgerManagerFactory is missing license header--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #103 from sijie/sijie/fix_rat_issue;91db1254c1118c4efa1c520f61850a3382f41fff
BOOKKEEPER-874: Explict LAC from Writer to Bookies--Introduce a new feature for sending explicit LAC to bookies.-A writable LedgerHandle creates a timer thread to send explicit LACs-at the intervals specified through configuration paramenter,-explicitLacInterval. If this is set to zero, this feature is disabled,-no timer thread is created.--Explicit LAC is sent only if the client did not get a chance to send-LAC through piggyback method for "explicitLacInterval" time.-To implement this, introduced two new protocol messages to the-Bookkeeper protocol -  WRITE_LAC and READ_LAC, in addition to its-current READ_ENTRY and ADD_ENTRY.--Reviewed-by: Charan Reddy Guttapalem <cguttapalemsalesforce.com>-Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-Co-Author : Charan Reddy Guttapalem <cguttapalemsalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #89 from reddycharan/explicitlacsinglecommit;c813b3d3298586ded02032a57a99d5fc6c974581
DL-186: fix common.sh grep bug; kill MultiReader java process as expected--Author: xieliang <xieliang007@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #114 from xieliang/DL-186-smoketest;712d1cb77f53a814bd2f678fcdd1f9c9db637292
 BOOKKEEPER-873 and BOOKKEEPER-553--    BOOKKEEPER-873: CreateLedgerAPI to accept ledgerId-    Add ledgerCreateAdv with ledgerId interface to Bookkeeper-    and corresponding Junit tests.--    BOOKKEEPER-553: LongHierarchicalLedgerManager-    - LongHierarchicalLedgerManager to support 63 bits ledgerid (positive long)-    - LongHierarchicalLedgerManager splits the generated id into 5 parts (3-4-4-4-4)--Author: Venkateswara <vjujjuri@salesforce.com>-Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #88 from reddycharan/ledgerhandleadvwithledgerid;42e8f1294f206cbe51a6af669cf605833b78bf42
BOOKKEEPER-959: ClientAuthProvider and BookieAuthProvider Public API used Protobuf Shaded classes--This fix removes the explicit usage of protobuf from ClientAuthProvider and BookieAuthProvider API, since protobuf library is shaded and relocated on the distributed public version of BookKeeper--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #67 from eolivelli/BOOKKEEPER-959;13d668f2208bf472e4938cfdfd2de912eaa11275
BOOKKEEPER-968: Entry log flushes at configurable chunks--With this patch one can configure interval (in bytes) for entry log to flush writes to the disk.--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #77 from dlg99/task/entry-log-flush;26b09abb4202362ca37d6944ce75eb2a3309dc3c
BOOKKEEPER-949: Allow entryLog creation for compaction--Allow entryLog creation even when bookie-is in RO mode for compaction--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>-Reviewed-by: Andrey Yegorov <ayegorovsalesforce.com>-Reviewed-by: Charan Reddy Guttapalem <cguttapalemsalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #99 from reddycharan/entrylogcreationforcompaction;ba5dadcb3e1fa942f2f1a17178fd368c4bd0f0c4
BOOKKEEPER-907: EntryFormatter should be configured--for ReadLedgerEntriesCmd, EntryFormatter should-be configurable and HexDumpEntryFormatter should-be one of them.--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #101 from reddycharan/entryformatter;ca7e5fd80662745e7f64ee8f70c66dc9734f6e3a
BOOKKEEPER-943: Reduce log level of AbstractZkLedgerManager--Just change from "info" to "debug"--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #98 from eolivelli/BOOKKEEPER-943-reduce-logs;43971c3b9e4a9ac37ee07b398ed5506e040f9310
BOOKKEEPER-991: Get list of disk files--BKShell Command for-Getting list of DiskFiles --Journals/EntryLogs/IndexFiles--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #100 from reddycharan/listfilesondisc;0fbb98b3629df18518ab6b2298bdd6fe5f19af7e
BOOKKEEPER-992: ReadLog Command Enhancement--- Take arguments lid and eid and prints just that entry-- Take arguments of position range and print entries-which are located in that position range--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #102 from reddycharan/readlogcommand;15d6f600e7158e2eecb0ae7231455305e5d1ceaa
Fix the script to make sure binary package can execute scripts correctly--- fix the release jar path-- copy the common script to each modules otherwise the built package won't be able to execute-- change the type of runner and copy the runner script to each tutorial module--Author: Sijie Guo <sijie@apache.org>--Reviewers: Jia Zhai <zhaijia@apache.org>--Closes #111 from sijie/sijie/copy_all_scripts_to_modules;90e09af0fbfa6f05106e07ac8833be26abfa3f9a
[maven-release-plugin] prepare for next development iteration;a1e1bb1fc016a99c383bc9f20220342ac2ee5561
[maven-release-plugin] prepare for next development iteration;5548c21dff62d544a0035f0cbb3cc59e385a4bd5
[maven-release-plugin] prepare branch release-0.4.0-incubating;b7d28756c5be788ac7819dbeb5e7d8d92e920afb
[maven-release-plugin] prepare branch release-0.4.0-incubating;eeb96c180b1b53d6608b13cf7077e3006ffdcb47
Remove Xlint compiler arguments for building release;c3077c499489e114ef17bfd31afc5509387d664e
DL-170: All dependency versions should be defined in the parent pom--make all dependencies' version be defined in the parent pom file.--Author: Gerrit Sundaram <gerritsundaram@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #97 from gerritsundaram/DL-170;9bfb2a2d52dfd2f8890049accf96f3fa4f79878c
DL-170: All dependency versions should be defined in the parent pom--make all dependencies' version be defined in the parent pom file.--Author: Gerrit Sundaram <gerritsundaram@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #97 from gerritsundaram/DL-170;8ba3c921f1b650df6e1f924f2e4a0bd7d5acdfa8
DL-28: changed // comments to /* */--Author: adamtracymartin <atmartin@yahoo.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #100 from adamtracymartin/DL-28;c248f9dbbc87bddb087fe7b3012772049241636a
DL-83: Add javadoc to website--- update the javadoc plugin to aggregate api by 'core library' and 'proxy service'. (turn some java class to package private and delete unused files. so they won't appear in java doc)-- improve the website build script to include javadoc-- update some readme files to include user mail list and slack channel--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #96 from sijie/sijie/merge_website_script;4b6c849f1b19571f3b38db71ae520b2b39cd5438
DL-83: Add javadoc to website--- update the javadoc plugin to aggregate api by 'core library' and 'proxy service'. (turn some java class to package private and delete unused files. so they won't appear in java doc)-- improve the website build script to include javadoc-- update some readme files to include user mail list and slack channel--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #96 from sijie/sijie/merge_website_script;965c82de9f22f66b2cde9dc03e14137e87145656
DL-176: Rename the DL artifact from com.twitter to org.apache.distributedlog--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Dave Rusek <drusek@apache.org>, Leigh Stewart <lstewart@apache.org>--Closes #102 from sijie/sijie/fix_pom_file_layout;361b423a14753a2a8b696fd352115bc87fb9284c
DL-176: Rename the DL artifact from com.twitter to org.apache.distributedlog--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Dave Rusek <drusek@apache.org>, Leigh Stewart <lstewart@apache.org>--Closes #102 from sijie/sijie/fix_pom_file_layout;9d1f3bdfd01fdb3f003120d33aa5e5655fefb768
DL-171: adding a short sleep to let the WriteCompleteListener have time to run before the final position be requested--once the "writer.write" is done, if "writer.position()" be invoked easier than the WriteCompleteListener onSuccess callback, due to the "synchronized", the position result will be 0, not the expected 33. we can just add a short sleep to avoid this test issue.--Author: xieliang <xieliang007@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #98 from xieliang/DL-171-Fix-TestAppendOnlyStreamWriter;6cd251227258da58b2ab5d6ebffc620431e04b92
DL-4: Repackage the source under apache namespace;e0e819b015b4e2910ac267321123cdbfd0f71fd0
DL-4: Repackage the source under apache namespace;817989ce704261be588d33ff952719706599b6c6
DL-165: Add TestTimedOutTestsListener to dump timed out cases thread dump--Author: xieliang <xieliang007@gmail.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #91 from xieliang/DL-165-TimedOutTestsListener;ef1ca0e73e8ca832dabc46497058aeda6ca6b537
DL-165: Add TestTimedOutTestsListener to dump timed out cases thread dump--Author: xieliang <xieliang007@gmail.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #91 from xieliang/DL-165-TimedOutTestsListener;3319bc0231f27322f2008c326e0256c90e799f67
DL-140: Fix distributedlog-core findbug inconsistent synchronization warings--Author: xieliang <xieliang007@gmail.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #71 from xieliang/DL-140;c7e78df8b7555b3a57f69ffbdff3072d29b8e024
DL-164: Create stream operation should not be submitted by StreamImpl;da6cd40e0864548b94fee3fed63549026e446dd9
DL-163: clean up direct zookeeper and bookkeeper usage and use metadata/data store abstraction--- introduce NamespaceDriver class to manage metadata/data store abstractions-- clean up direct zookeeper and bookkeeper usage and use metadata/data store abstraction-- separate MetadataAccessor from DistributedLogManager-- remove deprecated classes;d15bc06466e345651f53ef7a7f5a771ac4880446
DL-162: Use log segment entry store interface--- Use log segment entry store interface-- Delete the old readahead implementation;a83b233a79300c0bf1b3dcac0a24fef628ad48f8
DL-161: Rename ledger id to log segment id--Along with providing log segment store related interfaces, clean up the naming from 'ledger id' to 'log segment id'. So it would become clear when we can plugin different log segment store.;1166e11904ab83ec64e0147998cebffc653bdbf3
DL-160: Remove 'DLSN' suffix from async and sync readers;590805a487fbfcc3c85c9baf5988106a9037dc2f
DL-159: ReadAhead Improvement (part 2) - New ReadAhead Reader using the LogSegmentEntryReader interface--Provide a new ReadAhead reader using the log segment entry reader interface. It does reading entries in a batch in parallel for batches, rather than reading entries in batch by batch. This would help mitigate the slow bookie problem.--The core change is the new ReadAheadEntryReader.;714ae49baff3c9f390fb65afa9b8cf801c5a5316
DL-159: ReadAhead Improvement (part 2) - New ReadAhead Reader using the LogSegmentEntryReader interface--Provide a new ReadAhead reader using the log segment entry reader interface. It does reading entries in a batch in parallel for batches, rather than reading entries in batch by batch. This would help mitigate the slow bookie problem.--The core change is the new ReadAheadEntryReader.;d7105aa88f29faecd779c4371fb023775e2c7e40
DL-195: ReadAhead Improvement (part 1) - Interface for LogSegmentEntryReader and LogSegmentEntryWriter--Create interface for log segment entry reader and writer to abstract data write/read operations.;a5e892fc1901100e267e6a677261936a87b9d22b
DL-195: ReadAhead Improvement (part 1) - Interface for LogSegmentEntryReader and LogSegmentEntryWriter--Create interface for log segment entry reader and writer to abstract data write/read operations.;e2c6bc0d7faa7b7912a51a7a4ed6e1b9ac5653bf
DL-158: update truncation status for all completed log segments--update turncation status for all completed log segments, when purge truncated log segments we will leave one complete log segment.;fd08cedc7e1e5df4cdf307a1dd615319bdc1bdd6
DL-157: resource placement for write proxy;da53069b9858fd904a68ce84b5954c60a0ba05b2
DL-119: Fix the logging on closing readahead worker;09a34b0e9b814bf602dceccd64ad7dbfc718fcfb
DL-118: Stream metadata store followup - rename ZKLogMetadata* to LogMetadata*--As the followup change, this change is to remove 'ZK' from 'ZKLogMetadata*' class;3a512326dc2cec7e4c62e0dc8fe569fdc5305373
DL-117: Stream metadata store--This change is to abstract the zookeeper operations into a stream metadata store, so we can replace zookeeper with other metadata store easily.--So the metadata operations in distributedlog now are managed by 3 classes:--- LogMetadataStore : it is the namespace metadata store : it manages the location (uri) mapping for streams and handle namespace operations.-- LogStreamMetadataStore: it is the stream metadata store : it manages the metadata for a single stream, such as managing read/write lock, retriving/creating stream metadata, deleting metadata and such.-- LogSegmentMetadataStore: it is the segment metadata store : it manages the log segment metadata for individual log segment.--LogMetadataStore and LogSegmentMetadataStore are already there. This change focus on LogStreamMetadataStore--Changed:--* abstract all the zookeeper metadata operation in log handlers to LogStreamMetadataStore-* remove disabling max tx id santify check, as maxTxId update is part of the metadata update transaction--Not changed:--the name of ZKLogMetadataForReader and ZKLogMetadataForWriter are not changed. I will send out a change to rename these two classes as they are not related to zookeeper anymore.;de4711ddf87571c4de5686385663aef3f19fcaf7
DL-116: Add tool for deleting subscriber from subscription store--Test Plan:--1. manually create znode for subscribers resume point-2. use the tool to delete the subscriberId;68f796019ce771a44ba20548046a444177143be0
DL-115: fix force get log segment logic--Summary:--We should remove the ledger closed check:--- force to get log segments if the reader has been idle for a while after open the ledger-- idleReaderWarnThreshold should be 2x larger than readLACLongPollTimeout;d606ee4ba0080431c5ec67b8805ff3bb269005d6
DL-114: Add namespace watch tool--Port simple namespace watch tool from downstream--Author: Leigh Stewart <agrodellic@gmail.com>-Author: Leigh Stewart <lstewart@twitter.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #80 from leighst/lstewart/dlog/watch_tool;aa60a4e830183f6d9a61ab9100cf845712e281b7
DL-113: Improve the sync reader benchmark--Add more logging information for calcuating the stats for catching up reads;7c4476cd01e2ed7530cbb6f429d78f083837b838
DL-112: Improve SyncReader to access readahead cache directly--This changes the implementation of SyncReader to let it access the read ahead cache directly, rather-than calling AsyncReader to fetch the entries. It would reduce the function calls that SyncReader spends-on reading individual records.;c9e76260dee1d661906c8bf89b032950f92c6d0e
DL-111: ReadAhead Cache should cache entries rather than records--Current readahead cache cache records. So it will be a lot of callbacks (function calls) when polling a record off the readahead cache. Most of the cpu cycles are unnecessarily spent-on function calls on polling records off the readahead cache. It is the throughput bottleneck for a DL reader.--This change is to change ReadAhead cache to cache entries rather than records. Defer the deserilization of records later on when the reader wants to access the records. It also make-the cache more efficient to reduce the memory footprint.;ee117235dc1a6fa76093c315c0fed4239831cd63
DL-110: Write control record if necessary when roll a log segment;b90cce8bbffa23f348058f8977a740b97f39dee2
DL-109: Add a tool to find the stream containing the given ledger;35587d3d70cf60b84f425db13718b4537336fd80
DL-108: Log rate limiting more clearly;0d424a17571ab19039f8b7c7a5766980b6373090
DL-107: Added unregistering gauges for distributedlog-core and distributedlog-benchmark;13a7381f50fea4b9300cd111fdd5b671954fbd7e
DL-106: Use namespace after it is closed will throw AlreadyClosedException;b42a8c34511612bef539d30d7ade5f68234297af
DL-102: Add routing service to write proxy server side--this change is to add getOwner rpc in write proxy. so we can change the client side to get owner from write proxy first for routing service. in this way, we can start experiementing any resource placement algorithms.;2cdd371f8799f47a5d473eb429f72d95337ca607
DL-105: Make compression stats available per stream;1eb1b1e94407de828694c1caead6b865b7e28887
DL-104: BKClientReadTimeout can be equal to getReadLACLongPollTimeout so current config validates;9eabddb64a0b47d7c2c2096e571f5f2586f28d11
DL-102: Add routing service to write proxy server side--this change is to add getOwner rpc in write proxy. so we can change the client side to get owner from write proxy first for routing service. in this way, we can start experiementing any resource placement algorithms.;fdee73641c1841448451bf34f859a78ac6bd9d08
DL-101: Improve session expire handling on fetching log segments for readers--This change focuses on improving the session expire handling on fetching log segments for readers.--The log segment management in DL is now done by 3 parts.--- a LogSegmentMetadataStore (one per namespace instance): it is used for fetching the log segments from log segment metadata store (ZooKeeper). it doesn't do any caching.-- a LogSegmentMetadataCache (one per namespace instance): it is a guava cache based metadata cache. it maintains a mapping between log segment metadata path and the log segment metadata. it manages the cache for the log segments that will be accessed in this namespace instance. it doesn't manage the sequence of the log segments for streams.-- a PerStreamLogSegmentCache for each BKLogHandler. the log segment cache is per stream. it maintains the sequence of the log segments.--BKLogWriteHandler doesn't watch the log segment changes. It fetches minimal number of log segments when it is created and fetches the full list of log segments for truncations. New log segments will be added to the per stream log segment cache with log segment rolling.--BKLogReadHandler watch the log segments changes and only notify when the list of log segments is changed. the session handling which is specific to the metadata store is hidden to the implementations of LogSegmentMetadataStore.--The change tries to cleanup bunch of unused methods in BKLog{Read,Write}Handler too.;7f2b59a7e6fa115793ed71d8cc1ad1cb9da677be
DL-101: Improve session expire handling on fetching log segments for readers--This change focuses on improving the session expire handling on fetching log segments for readers.--The log segment management in DL is now done by 3 parts.--- a LogSegmentMetadataStore (one per namespace instance): it is used for fetching the log segments from log segment metadata store (ZooKeeper). it doesn't do any caching.-- a LogSegmentMetadataCache (one per namespace instance): it is a guava cache based metadata cache. it maintains a mapping between log segment metadata path and the log segment metadata. it manages the cache for the log segments that will be accessed in this namespace instance. it doesn't manage the sequence of the log segments for streams.-- a PerStreamLogSegmentCache for each BKLogHandler. the log segment cache is per stream. it maintains the sequence of the log segments.--BKLogWriteHandler doesn't watch the log segment changes. It fetches minimal number of log segments when it is created and fetches the full list of log segments for truncations. New log segments will be added to the per stream log segment cache with log segment rolling.--BKLogReadHandler watch the log segments changes and only notify when the list of log segments is changed. the session handling which is specific to the metadata store is hidden to the implementations of LogSegmentMetadataStore.--The change tries to cleanup bunch of unused methods in BKLog{Read,Write}Handler too.;037713709672b3b500f7375a1bd81c1649956e3f
DL-151: TestBKLogReadHandler#testGetFirstDLSNWithOpenLedger is flaky--- Flush/Commit records only after the data are written-- Disable immediate flush-- Reduce num writes from 100 to 10--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #84 from sijie/sijie/FixTestGetFirstDLSNWithOpenLedger;ff21a477e2697daa0759d6a3b7daf5354db156df
DL-150: Ensure namespace path is created for TestZKLogMetadataForWriter--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #83 from sijie/sijie/FixTestCreateLogMetadata;30742c0375eb11dd653f92f734aaa478faa6c0cc
DL-155: fix flaky TestAsyncReaderLock#testReaderLockMultiReadersScenario--Ran the case with changed patch 30 times, all are passed;   and it'll fail w/o patch--Author: xieliang <xieliang007@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #88 from xieliang/DL-155;3953dfb058ce841c8a23faadfc707ed5995f7b40
DL-145: the write requests should be error out immediately even if the rolling writer still be creating--Passed all test cases locally, now TestDistributedLogService#testServiceTimeout case is stable on my box--Author: xieliang <xieliang007@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #78 from xieliang/DL-145;ef4572afa128dabf0607068eadfb6f3e50d43da2
BOOKKEEPER-964: Ignore findbugs warnings--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #96 from eolivelli/BOOKKEEPER-964-findbugs;f53cbf82758af7f620ecd1506c76801bd0e75c86
DL-97: Remove unused methods in BKLogHandler--merge code change on remove unused methods in BKLogHandler.--Author: Sijie Guo <sijie@apache.org>-Author: Sijie Guo <sijieg@twitter.com>-Author: Leigh Stewart <lstewart@twitter.com>-Author: Jordan Bull <jbull@twitter.com>-Author: Dave Rusek <dave.rusek@gmail.com>-Author: Dave Rusek <drusek@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #69 from sijie/merge/DL-97;ed4d2bff7443f861a288ac3e0d47ec036bc751f2
DL-129: Enable checkstyle plugin for distributedlog-protocol module--- add build-tools module for check style configurations-- fix style problems in distributedlog-protocol-  * sorted import-  * fix javadoc-  * constant static name and static name--Author: Xi Liu <xiliuant@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #54 from xiliuant/xi/checkstyle;a6a463591a823bd930aa8b921b17cef70ea445c1
BOOKKEEPER-986: Handle memtable flush failure--- If the memtable flush is failed previously then-for the next addEntry call it will try to flush the-existing snapshot--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #92 from reddycharan/handlememtableflushfailure;6e738d0c02ebe6710a24aad505e2fd9386bb8821
BOOKKEEPER-983: BookieShell LedgerDelete Command--BookieShell Command for LedgerDelete--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #90 from reddycharan/ledgerdeletecommand;9a506c261d3702ddd3f39556f4331b91da952a6e
BOOKKEEPER-988: Add missing license header--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #95 from sijie/sijie/fix_license_header;54863473365572f955a8e7a3e022614f5f5e4604
DL-91: Be able to close writer within a timeout duration--merge twitter's change on closing writer.--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>-Author: Jordan Bull <jbull@twitter.com>-Author: Leigh Stewart <lstewart@twitter.com>-Author: Dave Rusek <dave.rusek@gmail.com>-Author: Dave Rusek <drusek@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #64 from sijie/merge/DL-91;77de65efa4e06aa4434ba87f4760e6851ae8c6ba
DL-28: using /* */ style comment to avoid scrooge windows platform issue--Author: xieliang <xieliang007@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Leigh Stewart <lstewart@apache.org>--Closes #73 from xieliang/DL-28;6fb1a5d564eb72cabd94b28e58e0b7052424335b
DL-122: Use assertions from Junit rather than assert() for tests--* changed all instances of `assert()` to junit versions in `src/test`--Here is the script I used to find all instances of `assert()` inside the `src/test` folder:--```-grep -r "assert(" * 2>/dev/null | grep -v "main"-```--The `grep -v "main"` removes all instances of the usage within the main source tree (which there are quite a few). I did this as I assumed the JIRA ticket spirit was not to remove those instances from the main tree and thus would require including `junit` in core compilation rather than scoped for `test` as is.--Author: Brennon York <brennon.york@capitalone.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #77 from brennonyork/DL-122;715fa5cefc31a7041725cb959641287f60921dd7
DL-123: Every tests should have timeout--* used a simple bash script to find any tests without a timeout--Here is the below bash executed from the root directory. This could be expanded to take in more than one line above the initial `grep` although, for more, it only reduces the false positive rate. After this patch there are only 4 false positives (tests where the text immediately above is not `Test(timeout = ...)`).-```-grep -r "public void test" -B 1 * | awk '($NR+1) % 3 !=0 {printf $0; printf " "} NR % 3 == 0 {print " "}' | grep -v "timeout"-```--Author: Brennon York <brennon.york@capitalone.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #75 from brennonyork/DL-123;64bcb21f5e6e21b49ac743941445d63b8b4e87d3
DL-136: Avoid empty catch blocks--* resolves the 9 empty catch blocks in `src/main`-* leaves 49 errors within `src/test` unchanged-  * if we want to resolve those as well let me know, wasn't sure how we wanted to handle that--Used an independent checkstyle that looked for [empty catch blocks](http://checkstyle.sourceforge.net/config_blocks.html#EmptyBlock). Did a quick manual analysis and cannot find any other empty catch blocks in `src/main` so cannot rectify the original 22 as stated in the [Kiuwan blog](https://www.kiuwan.com/blog/analyzing_distributedlog_twitter-2/).--Author: Brennon York <brennon.york@capitalone.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #74 from brennonyork/DL-136;8b05fe3a171bc8aba245ef3e0b3cccd785691387
DL-90: Don't use stack and codec together for configuring thriftmux--merge Twitter's change on thriftmux--Author: Sijie Guo <sijieg@twitter.com>-Author: Jordan Bull <jbull@twitter.com>-Author: Sijie Guo <sijie@apache.org>-Author: Leigh Stewart <lstewart@twitter.com>-Author: Dave Rusek <dave.rusek@gmail.com>-Author: Dave Rusek <drusek@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #62 from sijie/merge/DL-90;6aa61c918ff2b3ddd1ba2fd9b98f8423d2411006
DL-88: remove watches when unregister children watches--merge twitter's change from Sijie Guo--Author: Sijie Guo <sijieg@twitter.com>-Author: Jordan Bull <jbull@twitter.com>-Author: Leigh Stewart <lstewart@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #60 from sijie/merge/DL-88;b06b537a54654824eb130e11bd3286c1120723d4
DL-87: Introduce periodic keepalive control record in writer--merge twitter's change from Leigh Stewart--Author: Jordan Bull <jbull@twitter.com>-Author: Sijie Guo <sijieg@twitter.com>-Author: Leigh Stewart <lstewart@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #59 from sijie/merge/DL-87;db17ed7b24abd2a938dc344a0bae4a703349c207
DL-86: Improve handling of lock conflicts in zk session lock--merge twitter's change from Sijie Guo.--Author: Jordan Bull <jbull@twitter.com>-Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #58 from sijie/merge/DL-86;7b5dc6231e89d282fe00b95cb845ddaf15b034e8
BOOKKEEPER-966: change bookieServer cmdline to make conf-file and option co-exist--Currently, when using bookieServer cmdline to start a bookie, you will either give it a cofiguration file by "-c booke.conf"; or add some options like "<bookie_port> <zk_servers> <journal_dir> <ledger_dir [ledger_dir]>" in a fix sequential.-It may not satisfy some of the requirement. So changed it to be co-exist for configuration file and options.--By this change, it will first use settings in configuration file; and then use options to overwrite some of the settings, if there are some options provided.--Here is an example after this change:-```-BookieServer -c bookie.conf -z localhost:2181 -m /bookkeeper/ledgers -p 3181 -j /mnt/journal -l "/mnt/ledger1 /mnt/ledger2 /mnt/ledger3?-```-Here, in this command:--z is for “Zookeeper client instance?;--m is for "Zookeeper ledgers root path for bookies";--p is for "bookie service port exported";--j is for "bookie journal directory";--l is for "bookie ledgers directories".--Author: jiazhai <jia.zhai@emc.com>-Author: jiazhai <jiazhai@users.noreply.github.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #75 from jiazhai/BOOKKEEPER-966;73edd4a99191d3c710b24a85eed3e2dbcd0a93bc
BOOKKEEPER-946: Provide an option to delay auto recovery of lost bookies--Fixing a bug in the test AuditorLedgerCheckerTest.testDelayedAuditOfLostBookies which-fails sometimes with:-AuditorLedgerCheckerTest.testDelayedAuditOfLostBookies:367->_testDelayedAuditOfLostBookies:345 audit of lost bookie isn't delayed--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #82 from rithin-shetty/audit_delay_fix;669ab4ac32bcbf6b3d883a07ed942d36d25b8a6e
BOOKKEEPER-971: update bk codahale stats provider version--Update bk stats provider: from codahale to yammer.-Currently io.dropwizard.metrics 3.1.0 is used most widely. will change version to 3.1.0.--And change CodahaleMetricsProvider.getMetrics() to public, since this would be used outside package.--And a small bug here:-```-            File outdir;-            if (Strings.isNullOrEmpty(prefix)) {  < === if (!)-                outdir = new File(csvDir, prefix);-            } else {-                outdir = new File(csvDir);-            }-```--Author: jiazhai <jia.zhai@emc.com>-Author: jiazhai <jiazhai@users.noreply.github.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #83 from jiazhai/BOOKKEEPER-971;be99f024df5d53b3988f585ab46d6b604592acf1
BOOKKEEPER-967: New testsuite for RackPlacement--Added New Testsuite for testing-RackAwareEnsemblePlacementPolicy using-ScriptBasedMapping. It works-only on Unix based OS, because of Shell-script.--This testsuite has similar testscenarios as in-TestRackawareEnsemblePlacementPolicy.java.--Also here it is assumed that the script file-has execution permission.--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #86 from reddycharan/testrackawareusingscript;4bb57ef0b1b72eb1118963efc3ab9f0e9bec0e1c
BOOKKEEPER-987: BookKeeper build is broken due to the shade plugin--This is simply an upgrade of the maven-shade-plugin to version 2.4.3--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Rithin Shetty <rithin@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #94 from eolivelli/BOOKKEEPER-987;d2e82d4942be079cbfdb179e9a3fe3e574beff8d
BOOKKEEPER-984: Fix BookieClientTest.testWriteGaps--in commit 9359d682a1598e30364eca6021d976f911e055b2, the third field (last add confirmed) in the message. changed the test to include the lac in the test so the test logic can work as expected.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>--Closes #91 from sijie/sijie/BOOKKEEPER-984;6d2737ca22533aed461ed71e94d2472a6664df3c
DL-141: Fix broken scripts in tutorials and add integration test to travis ci--- fix the broken scripts used in tutorials-- fix the write_proxy configuration (a change was merged to validate configuration which it brokes the configuration too)-- add integration test to validate the basic end-to-end functionalities--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #76 from sijie/sijie/script_for_ci;0451d59c89b0df346e39c921acf6f066d949bfe0
Clean up and fix a few shell scripts--This is still in progress.--- remove trailing white spaces in a few places-- fix some scripts (not rely on git); style consistency-- validate that the vagrant configuration works-- one of the Dockerfile was not correct--Author: Franck Cuny <fcuny@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #55 from franckcuny/fcuny/hack-week-cleanup and squashes the following commits:--fe3965d [Franck Cuny] Fix dlog script for core.-f15cefd [Franck Cuny] fix a few more things in the common script.-c32dee2 [Franck Cuny] Remove useless cd-622d3ab [Franck Cuny] Fix bundle for service.-93e9485 [Franck Cuny] A few more fixes for benchmarks' scripts.-a3fc4ef [Franck Cuny] Remove trailing white spaces in the doc-27f90f1 [Franck Cuny] Rename bookkeeper hosts from node to bk.-21d89f8 [Franck Cuny] Do not assume git is available in the shell scripts.-480bc34 [Franck Cuny] Remove comment from Dockerfile-a7ac7c0 [Franck Cuny] Git ignore pid files-179eddc [Franck Cuny] Ignore .vagrant directory created by vagrant.-9bf33fc [Franck Cuny] Create a valid snapshot.-5800829 [Franck Cuny] Remove Dockerfile and docker directory.;13b890b738f6470463a6c8f72917fe94cdfb97bd
DL-127: Fix coverall report--Author: Sijie Guo <sijie@apache.org>--Reviewers: Franck Cuny <franck.cuny@gmail.com>--Closes #53 from sijie/sijie/remove_reporting;3a0025998c65df7794ae2a1b20ad1d58c03bf410
DL-127: Fix coverall report--Author: Sijie Guo <sijie@apache.org>--Reviewers: Franck Cuny <franck.cuny@gmail.com>--Closes #53 from sijie/sijie/remove_reporting;8a4f4a63b1f066598e887ca34620d88f7db2bdd5
DL-49: Support building project with scala 2.10 and 2.11--Author: Sijie Guo <sijieg@twitter.com>-Author: Sijie Guo <sijie@apache.org>--Reviewers: Franck Cuny <franck.cuny@gmail.com>--Closes #22 from sijie/sijie/support_scala_2.10_and_2.11;2717eb4e37c88925fc4c0059bba013fd0f3aba97
Update a couple of scripts--Mostly style.--Author: Franck Cuny <fcuny@apache.org>-Author: Leigh Stewart <lstewart@twitter.com>-Author: Khurrum Nasim <khurrumnasimm@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #46 from franckcuny/fcuny/update-scripts and squashes the following commits:--50c16ec [Franck Cuny] Rename a variable in one of the shell script.-924ba7e [Franck Cuny] Run `git rev-parse` only once when building the bundle.-f1d3b3f [Franck Cuny] Remove more duplicated shell scripts.-90ce66f [Franck Cuny] Do not duplicate code for the 'bundle' script.-13987ea [Franck Cuny] Build cobertura report only on master for successful builds-525ec9a [Khurrum Nasim] Fix deadlock on BKSyncLogReaderDLSN-23c9190 [Leigh Stewart] Add documentation for distributedlog-benchmark-85aa8a7 [Franck Cuny] Make the shell style more consistent.-4f81ba2 [Franck Cuny] Rely on git to find the root directory.;aebd68049eec8417769059d7500ab9a4ebb19c27
BOOKKEEPER-976 Fix license headers--…ftware Foundation"--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #84 from eolivelli/BOOKKEEPER-976;f710e5a44569aa080b80eff855fff2c3810957fd
BOOKKEEPER-964: Add concurrent maps and sets for primitive types--In BookKeeper there are many instances of maps and sets that use ledger id-and entry ids as keys or values. JDK concurrent collections have the overhead-of boxing all the primitive values into objects (eg: long --> Long) that would-need to be allocated from the heap. In addition to that, JDK map implementations-are closed hash tables and they will require at least one more allocation to hold-the linked-list/tree node.--There are already available libraries that offer primitive collections with-zero-allocation, but none of these support concurrent maps/sets.--We have added a handful of specializations, all based on the same implementation-idea. We have a hash table which is broken down into multiple sections. Each-sections, on its own, is an open hash table with linear probing, protected by-a stamped lock.--All insertions, lookups and iterations on these collections are allocation free.--```-ConcurrentLongHashMap: Map<long, Object>-ConcurrentLongHashSet: Set<long>-ConcurrentLongLongHashMap: Map<long, long>-ConcurrentLongLongPairHashMap: Map< Pair<long, long>, Pair<long, long> >-ConcurrentOpenHashMap: Map<Object, Object>-ConcurrentOpenHashSet: Set<Object>-```--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <Enrico.olivelli@diennea.com>--Closes #72 from merlimat/bk-collections;ecbb053e6e873859507e247cae727f4bc8b9f7fa
BOOKKEEPER-955: in listLedgers method currentRange variable has to be…--… updated to the next iterator--in BookKeeperAdmin listLedgers method currentRange variable is not getting updated to next iterator-when it has run out of elements--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Venkateswararao Jujjuri <vjujjuri@salesforce.com>--Closes #63 from reddycharan/listledgersfix;4cf097871d28b70a53f8c6bffaf1c2022e9953b2
BOOKKEEPER-948: Provide an option to add more ledger/index directorie…--…s to a bookie--This change allows the addition of new ledger and index directories to a bookie. Thus-increasing ts storage capacity. The option is exposed via 'allowStorageExpansion'-boolean configuration option. Also, the newly added directories need to be empty to be-accepted. Two new test cases have been added to test this functionality.--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #59 from rithin-shetty/storage_expansion;66515e74d3fb03d21cad4eccb446a90ab7e94597
Fix deadlock on BKSyncLogReaderDLSN--Change the lastSeenDLSN to volatile to remove the synchronization block to avoid deadlock with sharedLock--Author: Khurrum Nasim <khurrumnasimm@gmail.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #42 from khurrumnasimm/kn/fix_deadlock;baa0afc059dc0a96d5fb8c902a0504cf8fd30e02
BOOKKEEPER-912: Allow EnsemblePlacementPolicy to choose bookies using ledger custom data (multitenancy support)--Author: eolivelli <eolivelli@gmail.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #68 from eolivelli/BOOKKEEPER-912 and squashes the following commits:--6c1eaca [eolivelli] BOOKKEEPER-912 Allow EnsemblePlacementPolicy to choose bookies using ledger custom data (multitenancy support)-7c0ab37 [eolivelli] BOOKKEEPER-912 Allow EnsemblePlacementPolicy to choose bookies using ledger custom data (multitenancy support);95ea4815b5313ea2ab02e5192c9f577d1c0fe24e
BOOKKEEPER-965: Long Polling Part I: Changes in the write path--This is the first in the series of changes for enabling long polling between bookkeeper client and the bookkeeper server. The changes were originally implemented in the Twitter fork and these pull request combine multiple commits from Twitter's bookkeeper fork as they include not only the changes made initially but also bug fixes added since.--The first change captures the changes on the write path (AddEntry). We track the last add confirmed in the FileInfo so that we can trigger actions when the value is updated--Author: Robin Dhamankar <robindh@Robins-MacBook-Air.local>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #73 from robindh/LongPollWritePath;9359d682a1598e30364eca6021d976f911e055b2
BOOKKEEPER-962: Add more journal timing stats--It is useful to know the sync latency on the journal to identify disk/filesystem-related latency spikes that will cause all the entries to queue up. In the same-line, it's useful to track the amount of time spent in the journal queue.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #70 from merlimat/bk-journal-latency;2ba9a2c4f7192ec0abaccdfd334025b4ddb9da66
BOOKKEEPER-961: Assign read/write requests for same ledger to a single thread--When entries for the same ledger are processed by the bookie we should avoid-the reordering of the request. Currently, if multiple read/write threads are-configured, the requests will be passed to the executor and writes for same-ledger will be spread across multiple threads.--This poses 2 issues:- 1. Mutex contention to access the LedgerDescriptor- 2. If the client receives add-entry acks out of order it has anyway to wait-    for the acks of previous entries before acknowledging the whole sequence-    to the application. In practice, the reordering is increasing the latency-   experienced by the application.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #69 from merlimat/bk-fixed-ledger-thread;7673febb6519fedb96320ec98db71601826a63b1
BOOKKEEPER-958: Fix for ZeroBuffer Bug--Fix for readOnlyBuffer of ZeroBuffer bug--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #66 from reddycharan/zerobufferfix;026ef10e1e9706ead4f1bc6763ded2e28c91480d
BOOKKEEPER-957: LedgerHandleAdv fixes--- making addToLength call synchronized-- adding op to pendingAddOps after doing sanity check--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #65 from reddycharan/ledgerhandleadvfix;8f0bed9f8401001abd683c420757610996cf96d8
BOOKKEEPER-956: Fix for HierarchicalLedgerRangeIterator--Fix for HierarchicalLedgerRangeIterator, to make it work-for LedgerIds of length 9 and 10--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #64 from reddycharan/hierarchicalledgermanagerfix;cc3d2701687ce1a4ff14502e2214a381b43aed5f
BOOKKEEPER-903: metaformat command fix--metaformat command should delete underreplicated ledger-znodes and lock nodes--Author: Charan Reddy Guttapalem <cguttapalem@salesforce.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #62 from reddycharan/metaformatfix;309cbba65c8532ef84c70efe181b3162e3078333
BOOKKEEPER-946: Provide an option to delay auto recovery of lost bookies--If auto recovery is enabled, and a bookie goes down for upgrade or even if it looses zk connection-intermittently, the auditor detects it as a lost bookie and starts under replication detection and-the replication workers on other bookie nodes start replicating the under replicated ledgers. All-of this stops once the bookie comes up but by then a few ledgers would get replicated. Given the-fact that we have multiple copies of data, it is probably not necessary to start the recovery as-soon as a bookie goes down. We can wait for an hour or so and then start recovery. This should-cover cases like planned upgrade, intermittent network connectivity loss, etc.--This change:-    1) Provides a bookie option 'lostBookieRecoveryDelay' in secs, which when set to a non zero value,-       will delay the start of recovery by that number of seconds. By default, this option is set to 0;-       which means the audit is not delayed.-    2) If another bookie were to go down in this interval, the recovery is immediately started and the-       one scheduled for future is canceled.-    3) Adds counters to track how many audits were delayed(#1) and how many scheduled audits were-       canceled due to multiple bookie failures(#2).-    4) Three junit tests to verify the new feature.--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: siddharth.boobna@gmail.com <siddharth.boobna@gmail.com>, Enrico Olivelli <eolivelli@gmail.com>--Closes #58 from rithin-shetty/audit_delay;0abf37c64ced0fe49a6470bc0e2be632e47902d6
BOOKKEEPER-952: Fix RegionAwareEnsemblePlacementPolicy--allocate bookies evenly as much as possible across all regions--https://issues.apache.org/jira/browse/BOOKKEEPER-952--RB_ID=880463--Author: Yiming Zang <yzang@twitter.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #61 from yzang/apache_master and squashes the following commits:--a0a9979 [Yiming Zang] fix Inefficient use of keySet iterator instead of entrySet iterator-d882c28 [Yiming Zang] fix RegionAwareEnsemblePlacementPolicy test case fix the algorithm for balanced placement across regions.;4383b0b171d5fdfcdfa55c196998bbc6b7fdc260
DL-32: Fix Findbug warnings--- Bump the version to 3.0.3-- Fix all the findbug warnings-- Enable findbugs:check on travis ci--Author: Jon Derrick <jonathan.derrickk@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #19 from jderrickk/jd/fix_findbugs_error and squashes the following commits:--c48c89c [Jon Derrick] Merge branch 'master' into jd/fix_findbugs_error-d9b0425 [Jon Derrick] verify findbugs on travis ci-985501b [Jon Derrick] Fix findbug errors on all modules-18e8267 [Jon Derrick] Remove distributedlog-example-ffa8361 [Jon Derrick] Fix findbugs in distributedlog-protocol;b9247a10caa4ff635184da52c8975a921877b500
DL-32: Fix Findbug warnings--- Bump the version to 3.0.3-- Fix all the findbug warnings-- Enable findbugs:check on travis ci--Author: Jon Derrick <jonathan.derrickk@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #19 from jderrickk/jd/fix_findbugs_error and squashes the following commits:--c48c89c [Jon Derrick] Merge branch 'master' into jd/fix_findbugs_error-d9b0425 [Jon Derrick] verify findbugs on travis ci-985501b [Jon Derrick] Fix findbug errors on all modules-18e8267 [Jon Derrick] Remove distributedlog-example-ffa8361 [Jon Derrick] Fix findbugs in distributedlog-protocol;2b2f33f51c8d3ac78fb7b969294eab952d730a99
BOOKKEEPER-924: addEntry() is susceptible to spurious wakeups--Use Java8 CompletableFuture instead of SyncCounter--Author: eolivelli <eolivelli@gmail.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #60 from eolivelli/BOOKKEEPER-924 and squashes the following commits:--61e6b1a [eolivelli] BOOKKEEPER-924 addEntry() is susceptible to spurious wakeups-7d7eaf7 [eolivelli] BOOKKEEPER-924 addEntry() is susceptible to spurious wakeups-f865610 [eolivelli] BOOKKEEPER-924 addEntry() is susceptible to spurious wakeups-e75569a [eolivelli] BOOKKEEPER-924 addEntry() is susceptible to spurious wakeups-cdd32c3 [eolivelli] BOOKKEEPER-924 addEntry() is susceptible to spurious wakeups;bf4a4d6a07f9d615752054c6743035cebd86716e
BOOKKEEPER-612: Region aware placement--- Introduce the concept of a two level Network Topology with region as the first level and rack as the second level-- NodeBase, Node and NetworkTopology manage this two level hierarchy and position of individual nodes in this hierarchy-- An implementation of RegionawareEnsemblePlacementPolicy that distributes nodes across regions and within regions uses rack aware placement to place nodes--This is a stacked diff (opening to start a review), we would still merge the dependent pull request first.--Author: Robin Dhamankar <robindh@Robins-MacBook-Air.local>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #56 from robindh/RegionAwarePlacement;bbd1eb8d8560b03834175fbd996b85237df09f5c
Add infinite retry policy to zookeeper client used by tests--This change is to improve the tests running on travis ci--Author: jiazhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #25 from jiazhai/zhaijia/fix_federated_namespace;941bd8ddf4b65e4dc0cec56f1e76c3cfe157be5a
BOOKKEEPER-945: Add counters to track the activity of auditor and repl…--…ication workers--Once we enable auto recovery, auditor and replication workers start their activity.-Today there is no way to monitor it using counters. This change introduces the-following counters to track various activities of auditor and replication workers like:--- Time taken by auditor to build the bookie->ledger list-- No. of under replicated ledgers detected-- Time taken by auditor to publish the under replicated ledger list-- Time taken by auditor to check all the ledgers in the cluster-- No. of ledgers replicated by each replication worker-- No. of entries and bytes of data read and written by each replication worker-- Auditor can also report the distribution of ledgers within the cluster: how many bookies own a piece of ledger, etc.--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #57 from rithin-shetty/auto_recovery_counters;9dc05fc080ddf01e69eb89ce1b0865c552d3de53
BOOKKEEPER-930: Option to disable Bookie networking--Author: eolivelli <eolivelli@gmail.com>--Reviewers: sijie@apache.org <sijie@apache.org>--Closes #49 from eolivelli/BOOKKEEPER-930;9db51b8d532d18485798d9dd96973c22450a0495
Mark some dl tests as flaky--mark some dl tests as flaky and link the corresponding investigation jiras--Author: jiazhai <zhaijia03@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #20 from jiazhai/zhaijia/fix_travis_build;a1890ec9992442ca0e051a674df2a130de6fd0a9
DL-36: travis ci build failed with assembly plugin--- use 'mvn package' instead of 'mvn verify'-- fix the assembly script-- added missed license headers--Author: Jon Derrick <jonathan.derrickk@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #14 from jderrickk/jd/fix_assembly_package;18ad45fa87c18f362e93060922d6b25729d503ce
DL-31: Provide flag to disable zk based distributed lock--DL doesn't enforce any leader election. However it still provides a zookeeper ephemeral znode based lock for leader election. It is unnecessary if applications use core library directly already have its own leader election mechanism.--This change is to provide a flag to allow disable the zk based lock.--Author: Sijie Guo <sijieg@twitter.com>--Reviewers: Leigh Stewart <lstewart@apache.org>--Closes #9 from sijie/sijie/flag_to_disable_lock;e39e3b036145907e9df87f72fb7b9773c4f35b45
DL-1: Clean up the distributedlog pom files--- changed the version to 0.4.0-incubating-- changed names to include 'Apache DistributedLog' and use '::' as separator-- add developers, mail lists and jira--Author: jiazhai <zhaijia03@gmail.com>--Reviewers: Franck Cuny <franck.cuny@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #10 from jiazhai/zhaijia/fix_apache_version;25af8e2950670648c04047e65ed67136c6a81ba7
DL-1: Clean up the distributedlog pom files--- changed the version to 0.4.0-incubating-- changed names to include 'Apache DistributedLog' and use '::' as separator-- add developers, mail lists and jira--Author: jiazhai <zhaijia03@gmail.com>--Reviewers: Franck Cuny <franck.cuny@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #10 from jiazhai/zhaijia/fix_apache_version;55937e03ec9f9d9c9939af6dcaa7f420cd655924
DL-21: Fix DL flaky test cases--DL-21: Fixed a few DL flaky test cases.--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #5 from yzang/yzang/fix_flaky_test;b99cee8295439e10c88d4290abe21e422eff833d
BOOKKEEPER-937: Upgrade protobuf to 2.6--protobuf/protoc 2.4 cannot be installed with brew on mac and building it on mac always result is build errors hence leaves an option of switching to linux to run protoc.-I upgraded to 2.6 instead. It is compatible with 2.4 on the wire and shaded so should not create any problems. All tests passed.-Please ignore changes in java files in attached patch during review; these are auto-generated.--protobuf 2.4 in compat* dependencies is shaded now to not conflict with 2.6.--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: eolivelli@gmail.com <eolivelli@gmail.com>, zhaijia03@gmail.com <zhaijia03@gmail.com>, sijie@apache.org <sijie@apache.org>--Closes #51 from dlg99/task/BOOKKEEPER-937;28f23e80bc1f64a22b45c52166cd51d526eacb5b
BOOKKEEPER-938 ledger digestType autodetection on open--Currently digestType verification in LedgerOpenOp seems to be treated as part of security logic.-Since it is checked after password and error explicitly states that digestType mismatched,-all that evil hacker has to do is to change digest type to another one. There are only two of them after all.--here is the scenario significantly affected by current behavior:--1. user rolls out clients with digestType set to MAC and creates lots of ledgers.-2. user notices that MAC is slower than CRC32 and decides to change digestType.-3. more ledgers created with CRC32.-4. user tries to read old and new ledgers--> now old ledgers cannot be read because of the digest type mismatch.--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #52 from dlg99/fix/BOOKKEEPER-938-digest-autodetect;64f596f4563436b3e4cfe0f57714fc3012778b4c
DL-20: Validate bk read timeout in configuration--DL-20: Ensure bkcReadTimeoutSeconds is larger than readLACLongPollTimeout--Author: Yiming Zang <yzang@twitter.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #4 from yzang/yzang/validate_configuration;bf0f60c84034c7d3a1b4f51ef686db5de2bf9f2c
BOOKKEEPER-941: Feature Switches for controling client and server behavior--- Introduce Features that are dynamic configuration options-- Allow specifying Features as configuration parameters--This is a port of the feature switches following changes-https://github.com/twitter/bookkeeper/commit/c2a092ab9b585f1d30d9e9b9dead0533efa49855-https://github.com/twitter/bookkeeper/commit/f9762d126e311a6b129e6e169dc62c2a0bdb7b4a--Author: Robin Dhamankar <robindh@Robins-MacBook-Air.local>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--Closes #54 from robindh/FeatureSwitches;c43858b5095318b50f4c7f86fc33b0a9e454bee5
BOOKKEEPER-933: ClientConfiguration always inherits System properties--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #50 from eolivelli/BOOKKEEPER-933 and squashes the following commits:--0bcae1e [eolivelli] BOOKKEEPER-933 ClientConfiguration always inherits System properties-beb68fb [eolivelli] BOOKKEEPER-933 ClientConfiguration always inherits System properties;8324632b2983beba1528ab53a999340756c7f563
BOOKKEEPER-927: LedgerHandleAdv to handle disabled ledgers operation …--…throttling--BOOKKEEPER-886 missed taking care of LedgerHandleAdv.-This takes care of that issue.--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #45 from jvrao/bookkeeper-927;1f7e47005588eedd879d0b9d163b4f125c6a0d59
BOOKKEEPER-940: Fix findbugs warnings after bumping to java 8--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--Closes #55 from eolivelli/BOOKKEEPER-940;2f71beb5e4b06691d4fd6c2601b78632236b3533
BOOKKEEPER-939: Fix typo of bookkeeper merge pr script--There is typo of bk-merge-pr.py script on merging pr without a jira id.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #53 from sijie/sijie/fix_merge_script;2506c98f8cc474d538df84ca30d229fbe0470e29
BOOKKEEPER-932: Move to JDK 8--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #48 from merlimat/bk-932;d5cea821c2201db77bd75a9bc48ff4bf9f483ce2
BOOKKEEPER-922: CreaterId in ledger metadata--Introduces a generic Map<String, byte[]> customMetadata to be stored as part of ledger metadata on the metadata server(zk).--Author: Rithin Shetty <rithingmail.com>--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>--Closes #46 from rithin-shetty/JIRA-922-ledgerCustomMetadata;6d71b8292bc255e21f2dcf048be191650c01b4dc
BOOKKEEPER-908: BKLedgerExistException creation is missing--Add missing case statement for Code.LedgerExistException-in the crearte() function of BKException class--Signed-off-by: Venkateswararao Jujjuri (JV) <vjujjurisalesforce.com>--Author: JV <vjujjuri@salesforce.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #44 from jvrao/bookkeeper-908;e5f3afa5ef84dbc466562664f1f8b0cd60779c02
A few changes to the shell scripts to start bookies--Author: Franck Cuny <franckcuny@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #43 from franckcuny/fcuny/scripts-start-server;3196448632fd93b53964d58aaf070709d2bb050c
Add executions for maven-assembly-plugin.--Add the executions steps to produce a single archive with all the jars,-scripts and configuration files.--Author: Franck Cuny <fcuny@twitter.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #42 from franckcuny/fcuny/maven-assembly;ab069c3628562a90357b989e50d626acfc608695
Merge remote-tracking branch 'origin/master' into dockerize;bb31fd75bf4cf022001e9be25ea725477b0a5e16
Vagrant based solution to create multi-node deployment (#34)--* Added vagrant files to start 3 ZK nodes and 3 BK nodes with writeproxy----* Removed comments----* Setting env vars for writeproxy----* Got it working for proxy and normal writes----* Fixing minor bugs----* Updated with comments on the pull request----* Creating a docker file which calls into the vagrant bookkeeper script----* Updated to the public version of twitter bookkeeper;8ad9b2929dbddb5124b58c86feaca5fca73d9acf
BOOKKEEPER-881: Upgrade surefire plugin to 2.19.1--Upgrade to using maven surefire plugin version 2.19.1--Author: Rithin Shetty <rithingmail.com>--Author: Rithin <rithin.shetty@salesforce.com>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #47 from rithin-shetty/surefire-upgrade;bd2ebcd75f41552f37166616e05821f4f7752f26
Added vagrant files to start 3 ZK nodes and 3 BK nodes with writeproxy;88f134e018608a4cccfc8f374ea8168581d1b839
Add documents on running distributedlog in distributed mode;5c768b0a3cf573a4ba71f8b6edc9f183fdce4f65
Fixes #14: remove concurrency from ConfigurationSubscription tests (#16);089735246f6084e9f68085ab03999394c7158a72
Initial Check-in for distributedlog oss;7e7fcf6618417a0846baae4b6ee84778571a3556
Initial Check-in for distributedlog oss;5a71ed88116fcdffcccdb99eb79055912c46a85e
Bump version to 4.5.0-SNAPSHOT;f36bb289c19f5528572b677d1529951ae4346a93
Updated CHANGES.txt for release 4.4.0;d1df2dbdc06666490867285812654ca8e91647a9
BOOKKEEPER-926: Compacted entries are not properly synced before updating index--…ting index--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Guo Sijie <sijie@apache.org>--Closes #41 from merlimat/bk-926;d32010f5fcc6a040a56dc8b983cc14d107cff2df
BOOKKEEPER-925: Fix FindBugs discovered issues in master--sijie Fixed the other findbugs error--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Guo Sijie <sijie@apache.org>--Closes #40 from merlimat/bk-925;f8e0331f14a933ad2ed3d933c5eea927020b4967
BOOKKEEPER-925: Fix FindBugs discovered issues in master--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Siddharth Boobna <siddharth.boobna@gmail.com>, Guo Sijie <sijie@apache.org>--Closes #39 from merlimat/bk-925;101de10a817d2a0704ce746eaed90cc0d73ca078
BOOKKEEPER-921: Typo in LocalBookkeeper: Use InetAddress.getHostAddress instead of InetAddress;696a1515bcd4ef41ef27944dad64ac3e1c9d4991
BOOKKEEPER-895: GC ledgers that are no longer a part of the ensemble--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Guo Sijie <sijie@apache.org>--Closes #25 from sboobna/BOOKKEEPER-895;dd575a16decbeaab1f230db271bc400d7e434216
Auditor is sometimes marking as failed a bookie switching from available to read-only mode--…hing from available to read-only mode--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Enrico Olivelli <eolivelli@gmail.com>, Guo Sijie <sijie@apache.org>--Closes #37 from merlimat/bk-919;40af841a366323d19fde2ae73d198824c16af688
BOOKKEEPER-920: Extend bk-merge-pr.py to add more info to Jira ticket…--… when merging--Author: user.email <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #36 from merlimat/bk-920;d66b9f0b4d27eae59fb9d6e607f24b2e8a0e611a
BOOKKEEPER-911: Fix TestReplicationWorker tests in master--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>, Flavio Junqueira <fpj@apache.org>--Closes #29 from merlimat/bk-911;91595fc04ac6168b5a652e803e55caadae757f74
BOOKKEEPER-870: Change the default value for bookie settings.--- ENTRY_LOG_SIZE_LIMIT to 1GB-- increase GC_WAIT_TIME to 10 minutes, since 1 second isn't good for a real production environment-- FLUSH_INTERVAL to 10 second. lowering this value won't help since the actual checkpoint only happened on entry log file rolling-- OPEN_FILE_LIMIT to 20000.-- JOURNAL_MAX_GROUP_WAIT_MSEC to 2 ms. make the default value for low latency-- READ_ONLY_MODE_ENABLED to true. enable readonly mode by default.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #35 from sijie/sijie/BOOKKEEPER-870;10cab08d0a8b4ca4b182554dee95834dc42175d2
BOOKKEEPER-917: LocalBookKeeperTest seems to be silently failing--Fixing the `AuthHandler` to use localhost address when passed a `LocalChannel`--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #34 from merlimat/bk-917;b42d8db2b03079ce65d603d808442297ad759433
BOOKKEEPER-913: Fix flakiness in TestBackwardCompat--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #31 from merlimat/bk-913;f2bc62b85e9bb855416fa4ea424cfd19ae9944e5
BOOKKEEPER-880: Make LedgerHandle implement AutoCloseable--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Rakesh R <rakeshr.radhakrishnan.potty@intel.com>--Closes #33 from eolivelli/BOOKKEEPER-880;89b032a1b59bebaf1bd48a95c0eb0f3e0caa2519
BOOKKEEPER-914: ReadOnlyBookieTest.testBookieShouldTurnWritableFromReadOnly is intermettently failing--BOOKKEEPER-914 fixed testBookieShouldTurnWritableFromReadOnly flapping.-Now test waits for bookie to transition to read-only.--Author: Andrey Yegorov <ayegorov@salesforce.com>--Reviewers: Matteo Merli <mmerli@apache.org>, Sijie Guo <sijie@apache.org>--Closes #32 from dlg99/bugfix/BOOKKEEPER-914;3efde26e0510be38237c73a7bfeeb105f25d8dbe
BOOKKEEPER-904: BookieInitializationTest.testDuplicateBookieServerStartup fails on non-english machines--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #30 from eolivelli/master;3fe7e7dad1a1a5a1ac958ef245f244d36523c0ea
BOOKKEEPER-910: In LocalBookkeeper, Zookeeper server and client use different host addresses--Author: Arun M. Krishnakumar <akrishnakumar@salesforce.com>--Reviewers: Matteo Merli <mmerli@apache.org>;19a5efe21ca0b33156a405f1084ddaa9ba4b28f5
BOOKKEEPER-896: VM-local transport--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>--Closes #21 from eolivelli/BOOKKEEPER-896;e5939ed587d81212fb032a37b2b83401359fa7fc
BOOKKEEPER-578: LedgerCacheImpl is reserving 1/3 of Heap size but allocates NonHeap memory--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #28 from merlimat/bk-578;d607b366ba493617408888a768a99ee3f3ffb976
BOOKKEEPER-901: Authentication framework--Author: Ivan Kelly <ivank@yahoo-inc.com>--Reviewers: Sijie Guo<sijie@apache.org>--Closes #23 from merlimat/authentication-framework and squashes the following commits:--aa01548 [Ivan Kelly] BOOKKEEPER-901: Add an authentication framework-f930fbd [Ivan Kelly] BOOKKEEPER-794 BookkeeperProtocol.Response.status is completely ignored;b1c12c0f41b7c27b2452fef311f12077d771f431
BOOKKEEPER-909: ZooKeeper of LocalBookkeeper should use the correct tickTime--Reviewers: Matteo Merli <mmerli@apache.org>;e32c38890ffbd0291e24e2b3f2625374b27f1f67
BOOKKEEPER-894: add command to read ledger entries form shell--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #24 from sboobna/BOOKKEEPER-894;a13d75d7eae29f1ce42dbfe5c6b4878a822fdf91
BOOKKEEPER-594: AutoRecovery shutting down on SyncDisconnected--Author: Matteo Merli <matteo.merli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #26 from merlimat/bk-594;1a98088e38ca0a43c26d9a4847619b0a27bb90e8
BOOKKEEPER-769: Remove the Hedwig Code--- Remove code directories for Hedwig code-- Remove code directories under compat-- Remove Hedwig related documentation-- Remove references to Hedwig code in pom files--* There is an unrelated findbugs violation in BookieWatcher which is not related to this change-* There were flaky tests that failed locally but passed when I reran them--Author: Robin Dhamankar <robindh@Robins-MacBook-Air.local>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #27 from robindh/RemoveHedwig;9a8d62b1d1231f2fe6feca7e0c407a426a1278d5
BOOKKEEPER-902: Test failures in EntryLogTest--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #22 from merlimat/bk-902;410ff7263a477d4b75a43d006adde3549225a4b9
BOOKKEEPER-898: listen to read only bookie changes also in auditor--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #19 from sboobna/BOOKKEEPER-898;a77042db1b024b5cb2bdd2a5f49ea18a43bc036b
read only bookie runs replicator and does not release the under replicated lock after failing--… only bookie--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #17 from sboobna/BOOKKEEPER-900;fe52b500cfec1c93725fa967ad2d5e0e7350580c
Bookie should return to read-write mode once the disk usage drops before the threshold--…o read only mode--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #18 from sboobna/BOOKKEEPER-899;bfa74f736ba270cc1a0bd0f7a1a6c643a00e385d
BookKeeper client should try not to use bookies with errors/timeouts when forming a new ensemble--…hen forming ensembles--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #11 from sboobna/BOOKKEEPER-889;c8255f8c5f73a2353293ec1d9612dbb98f291ccc
BOOKKEEPER-851: Configurable LedgerStorage implementation--sijie Addressed almost all comments from https://reviews.apache.org/r/33096--Only point still open is how to treat the `SortedLedgerStorage` and the flag `sortedLedgerStorageEnabled=true` in the config file--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #6 from merlimat/bk-851-configurable-ledger-storage;96adbf1d613a63602c8b1b4aad1b0a7d17e6eee3
BOOKKEEPER-841: Bookie should calculate ledgers map writing a new entry log file--sijie I've addressed all comments from https://reviews.apache.org/r/33061--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #5 from merlimat/bk-841;2c567d008c644df5db8c441fb9aaf135ed36db95
BOOKKEEPER-897: Fix findbugs warnings and missing apache license header--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #15 from sijie/sijie/BOOKKEEPER-897;9bd9e061bc225f36d8c9d516d4265aa209e4e90e
BOOKKEEPER-879: Record ledger creation time--Author: eolivelli <eolivelli@gmail.com>--Reviewers: Sijie Guo <sijie@apache.org>, Flavio Junqueira <fpj@apache.org>--Closes #2 from eolivelli/master and squashes the following commits:--509ad4f [eolivelli] BOOKKEEPER-879: Record ledger creation time-227d50c [eolivelli] BOOKKEEPER-879: Record ledger creation time-94cdee6 [eolivelli] BOOKKEEPER-879: Record ledger creation time-2a8e700 [eolivelli] BOOKKEEPER-879: Record ledger creation time-c43f0b4 [eolivelli] BOOKKEEPER-879: Record ledger creation time-e33f2e0 [eolivelli] BOOKKEEPER-879: Record ledger creation time;bac3ed3603f9dc9864beb610bea215c186ef4fab
BOOKKEEPER-891: Read entries failure should trigger callback only once--When reading multiple entries with `LedgerHandle.asyncReadEntries()`, in case there is a read error, the callback is currently being invoked for each of the requested entries.-Since a single "success" callback is expected, we should also have a single "failure" callback invocation.--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #12 from merlimat/bk-891-read-callbacks;9c937f5d814d4079b6134db361a0e2de1e37cd05
BOOKKEEPER-893: explicitly call bk shutdown to set the exit code--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #14 from sid825/BOOKKEEPER-893;63395a3e3d9bb253ea2745042631e44a3d195ea0
BOOKKEEPER-886: Allow to disable ledgers operation throttling--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #7 from merlimat/bk-886-disable-throttling;d96a2db912278e3d88ed59d8d3e15b62bc37ffd4
BOOKKEEPER-888: Dispatch individual callbacks from journal in different threads--Currently the journal is sending all the responses from a single thread, after the entries in a batch are synced. Since a thread pool has been configured, it is better to spread the send-response tasks to all the available threads.--Author: Matteo Merli <mmerli@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #8 from merlimat/bk-888;63a2a91eba191e92a1902cf5400325dcf4d36089
BOOKKEEPER-892: Bookie sanity test--Author: Siddharth Boobna <sboobna@yahoo-inc.com>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #13 from sid825/BOOKKEEPER-892;61390322ea591bcfe3186e289c27f331c86941ad
BOOKKEEPER-890: Concurrent modification exception when removing listener in…--… Bookkeeper ZK ledger manager--Author: Matteo Merli <mmerli@apache.org>--Reviewers: Sijie Guo <sijie@apache.org>--Closes #9 from merlimat/bk-890-concurrent-modification;626b7e8bb0b84271df97cfbf0a1b157c6cfe5a18
BOOKKEEPER-883: Test timeout in bookkeeper-benchmark--Problem:--The BenchReadThroughputLatency is tight with FlatLedgerManager. so lots of assumptions are made based on how the znodes are changed when ledgers are created. There was a change introduced LedgerIdGenerator, which broke the assumptions that made by BenchReadThroughputLatency.--Fix:--- Use a hashset to cache processed ledgers on reacting on children changes-- Remove unpredictable test on next ledger-- Fix an error logging on FlatLedgerManager processing ledgers--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #10 from sijie/BOOKKEEPER-883;8729d12be50295086e7440dfa5d0256abb7688d5
BOOKKEEPER-855: handle session expire event in bookie (sijie)--This change is to retry bookie registration when zookeeper session expired.--Author: Sijie Guo <sijie@apache.org>--Reviewers: Ivan Kelly <ivank@apache.org>, Matteo Merli <mmerli@apache.org>--Closes #1 from sijie/sijie/BOOKKEEPER-855;92722ee9c34b069e23d1a87d7fc78256b8540268
BOOKKEEPER-885: Script to merge github pull request (sijie via mmerli)--Utility for creating well-formed pull request merges and pushing them to Apache. A modified version based on Spark project (https://github.com/apache/spark/blob/master/dev/merge_spark_pr.py)--Author: Sijie Guo <sijie@apache.org>--Reviewers: Matteo Merli <mmerli@apache.org>--Closes #4 from sijie/sijie/BOOKKEEPER-885;19160e44d3d6814127e35f9a2c1062bcae57213f
BOOKKEEPER-877: Script for generating patch for reviews (sijie);e42efa9a84d554c8c0cdc9faf39d5efb85fe01f0
BOOKKEEPER-867: New Client API to allow applications pass-in EntryId. (Venkateswararao Jujjuri via sijie) (missing CHANGES.txt);e47fb5703d1a26db238dd20aa58bc580830dd5af
BOOKKEEPER-867: New Client API to allow applications pass-in EntryId. (Venkateswararao Jujjuri via sijie);355ddbc7c13e39c49a58371d467e87aa80f696d7
BOOKKEEPER-866: Fix compile issue when Updating junit to latest release version( 4.12) in the test of  Bookkeeper-server. (Jia Zhai via sijie);8a3922e00d5fc3f82cb28ca032595b02db1a516e
BOOKKEEPER-872: Resource leak with unclosed LedgerManager in HierarchicalLedgerManagerFactory#format() (Ted Yu via sijie);9803ee8e6293dcd0346b1ca3cb0f2666b5e12382
BOOKKEEPER-826: PendingAddOp is ignoring ack response after meet ack quorum constraint (sijie);885cebf113ea104dc579f93d6e112825a3bf1959
BOOKKEEPER-868: Add ADD_ENTRY quorum timeout (Leigh Stewart via sijie);48ab23ef3e16f8edfda2a977f9c0fc99c441db40
BOOKKEEPER-862: Add tracing and stats to OrderedSafeExecutor for debugging slow tasks (Leigh Stewart via sijie);6cfecea6c3e2b6e327fb53ac85f1894df81a10b2
BOOKKEEPER-438: Move ledger id generation out of LedgerManager (Tong Yu via sijie);5662416d8ecef535fb089baa0a10e0dae08ae805
BOOKKEEPER-802: Bookkeeper protocol documentation (ivank via sijie);a59bd5687e2f5c4a4ac3f2a957543b5a1a3148d8
BOOKKEEPER-863: Potential resource leak with unclosed LedgerManager in BookieShell (Ted Yu via sijie);c29a4f2601f72f8543cc4b1db419c84b01de75ce
BOOKKEEPER-760: Don't close PCBC proactively if bookies disappeared from zookeeper znodes (sijie via fpj);8bf97fb5ba115b1d053bbc9a779335455e6926c5
BOOKKEEPER-687: Use static final Logger for hedwig related modules (Ankur Garg via sijie);8c1b9ebc22988aabb42ba9cfe79be8898fc5a69e
BOOKKEEPER-796: Make bookkeeper client use reconnectable zookeeper wrapper (sijie via fpj);a80bba272ecd7344ac552f3888ef5db49cbbdeb5
BOOKKEEPER-823: Clean up temp files created by hedwig tests (Jia Zhai via sijie);8df7e0fb18547e9805238f4bb15d3d0d67978422
BOOKKEEPER-858: Fix broken links and typos in bookkeeper documents (Youngjoon Kim via sijie);35fbcc357970f126b6b9f9a7bf2a453bd3786044
BOOKKEEPER-821: Failing to write lastId to ledger directories should not fail startup of bookies (zhaijia via sijie);6286c39eaa8f7422323fc3405c72f9c6333f444f
BOOKKEEPER-854: NPE on InterleavedLedgerStorage.onRotateEntryLog (sijie);1387b2be44686abfe78bf4efee4ad52d2d699e12
BOOKKEEPER-835: Update copyright for 2015 on all active branches (sijie) (missing CHANGES.txt file);5bd2edbf82bd0c8bd9ea9e507b07d23cb856f934
BOOKKEEPER-835: Update copyright for 2015 on all active branches;6688d96b52072496202f607f8c55976472f4c9a6
BOOKKEEPER-846: TestLedgerChecker times out (rakeshr via sijie);26b17cba50aded931afb2e66d549fbeb8f4f1d39
BOOKKEEPER-833: EntryLogId and EntryLogLimit should not be larger than Integer.MAX_VALUE (sijie);da1a2fa6b19ddcdba68834147bf6afbe5bf90cbf
BOOKKEEPER-836: disable compaction when disk becomes full, otherwise compaction will fill up disk quickly (zhaijia via sijie);e0d331781ec7a0e415bc6f16c38686aab34cb0c5
BOOKKEEPER-695: Some entry logs are not removed from the bookie storage (Matteo Merli via sijie);b6dd505342051f267ca6af5fba1b70637c1e3fe0
BOOKKEEPER-848: Use volatile for lastAddConfirmed (Matteo Merli via sijie);70da24d504e3f4cba0d87a0914a0add7ea19394d
BOOKKEEPER-847: ArrayIndexOutOfBoundsException in LedgerFragmentReplicator::updateEnsembleInfo (zhaijia via sijie);b24cd7fd85bb3235036e660ff3a295dc939705e6
BOOKKEEPER-850: Use nanoseconds to calculate poll timeout when doing group commit (Matteo Merli via sijie);fe6259c7eade644c8d2a5e96aba61c1792d64843
BOOKKEEPER-849: Collect stats with sub-milliseconds precision (Matteo Merli via sijie);6622b46d4979c92cd9c3f450e3832d63513c6a22
BOOKKEEPER-844: Add more metrics about latency and bytes characteristics on bookie operations (Tong Yu via sijie) (missing file);638b332569a0ce4c502cc4d15be535a67d464f9d
BOOKKEEPER-844: Add more metrics about latency and bytes characteristics on bookie operations (Tong Yu via sijie);c181ea8aa409ed17f28e5b901ae33adc0faaf4be
BOOKKEEPER-834: test case error in test class TestDiskChecker (zhaijia via sijie);7177f2a03c52ca0457ea7d1a9c946f194ffb1c5f
BOOKKEEPER-828: Script for updating docs on website from master branch (ivank via sijie);4a4802ab5ef1a98eb40cd2bfb4b2f76409745220
BOOKKEEPER-840: Deadlock on flushLock on compaction (sijie);68c5b5a40c33b813482e8a2371eedcb2e0d224e8
BOOKKEEPER-831: Outdated links in tutorial (ivank via sijie);f2928dca4860b3c1461b99b834992e16901c8a87
BOOKKEEPER-837: UpdateLedgerOp - Replace AbstractFuture with SettableFuture (rakeshr via sijie);0c7dfc077b413d4019b68133cb7461832eae3541
BOOKKEEPER-839: AuditorPeriodicCheckTest timeout (rakeshr via sijie);e89ee080f1894143ed3415f27017b89eefe3ceb1
BOOKKEEPER-838: ForceWriteThread::run() leaks “logFile.close()? when interrupt comes (zhaijia via sijie);8b23bd30c5e7388e91f650615671d754a9ee2727
BOOKKEEPER-830: Documentation has no structure (ivank via fpj);afbab15ad6778f1010b726b7f765a47417fbbed0
BOOKKEEPER-827 change throttle in GarbageCollector to use either "by entry" or "by byte" (Jia Zhai via fpj);0d6a65d3b14122f0c0a3a4e9d6a4fbe569165ec7
BOOKKEEPER-634: Provide admin tool to rename bookie identifier in ledger metadata (rakeshr via ivank);99b40326fed855906b709cbe1f562f45bda79e5d
BOOKKEEPER-832: Allow starting bookie in ReadOnly mode (zhaijia via ivank);4050e79654704ebc0224cc024980e297fdc56473
BOOKKEEPER-803: Guide for making a replicated log out of ledgers (ivank);264995cf2fc97ae527a8c24b369790a424d88d87
BOOKKEEPER-801: Bookkeeper client tutorial (ivank);91b80f6c8d538fd9c16b30907c95d93ee90af04a
BOOKKEEPER-814: clean up temp files that generated by test cases. (zhaijia via ivank);0e3d95c9411289b89961e434ce760e3726290761
BOOKKEEPER-795: Race condition causes writes to hang if ledger is fenced (sijie via ivank);e79f8736a7dfc2c7191455e4e88b85a85f0472bf
BOOKKEEPER-811: Recovery tool doesn't remove cookie after recovering one bookie (Charles Xie via sijie);24591f1514624e09a07ef2f34ba35116ea847266
BOOKKEEPER-810: Allow to configure TCP connect timeout (Charles Xie via sijie);92e502233d1489290fbcb448b932fdc4b569d431
BOOKKEEPER-813: BookieShell doesn't find index directory (Charles Xie via sijie);e790cab6d89de3cff3ee32842347d0176b6e24c5
BOOKKEEPER-804: Client program is not terminated when using openLedgerNoRecovery (ivank via sijie);2b88b11fa7597254ccbf828f16efc665e852788d
BOOKKEEPER-820: print out fi.isFenced() in BookieShell (zhaijia via sijie);492997b1e6fe73426dda799a6eaf228329a9342f
BOOKKEEPER-809: Wrong metric on LedgerDeleteOp and LedgerOpenOp (Charles Xie via sijie) (missing CHANGES.txt);ff5d2c5125d7d7fbe48d7935524820c55a887124
BOOKKEEPER-805: NullPointException in bookie server when using twitter-ostrich-provider (Youngjoon Kim via sijie) (missing CHANGES.txt);8a5ac72762480f5f972aafcf1fc8207e12ef76e3
BOOKKEEPER-809: Wrong metric on LedgerDeleteOp and LedgerOpenOp (Charles Xie via sijie);0dfb4fb94d0ccc98e1050f662712d85bcf2003b1
BOOKKEEPER-805: NullPointException in bookie server when using twitter-ostrich-provider (Youngjoon Kim via sijie);130ebfa8f3763c1b98b29124a2bb648b2a810281
BOOKKEEPER-799: Distribution schedule coverage sets don't take gaps in response lists into account when writequorum > ackquorum (ivank);5de01f700ede31f186f5d8d97afac382f1e45327
BOOKKEEPER-800: Expose whether a ledger is closed or not (ivank);78d6e49d4d6bf83ee53655e6198848b896c4239c
BOOKKEEPER-815: Ledger fence state is lost when the ledger file is evicted (Charles Xie via ivank)--Change-Id: I7de7a893043f1304b75d7545899ec5b022148e6b;6a94e45c6b813978d6b4fa98eeb87175d0241d96
BOOKKEEPER-797: IllegalArgumentException when calling CodahaleOpStatsLogger#toOpStatsData()--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1640597 13f79535-47bb-0310-9956-ffa450edef68;b17a30a46a820a9914bcee713f156698d93ff734
BOOKKEEPER-793: Move to java 7--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1631943 13f79535-47bb-0310-9956-ffa450edef68;3020fcb555d978c986e4e014e79c14d9817b606a
Add JNA license in NOTICE files--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1631683 13f79535-47bb-0310-9956-ffa450edef68;ea03266f5c5af20281de7bd147faeb9bc715065f
Update README to reflect bookkeeper modules--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1631681 13f79535-47bb-0310-9956-ffa450edef68;334f75ea5516158a9cb544be7ee678c3945ec0a9
Bump version number to 4.4.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1629127 13f79535-47bb-0310-9956-ffa450edef68;528270848b98f2090d51dfea9f6652aa1fc10b66
Preparing for release 4.3.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1629124 13f79535-47bb-0310-9956-ffa450edef68;643992144d17297d2a5a8414f0a1e106d0fc8b99
BOOKKEEPER-773: Provide admin tool to rename bookie identifier in Cookies (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1628193 13f79535-47bb-0310-9956-ffa450edef68;2d630bbd594de7a79afbf227ed41f84484a527f5
BOOKKEEPER-787: Modify Cookie by removing 'znodeVersion' state/field (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1627068 13f79535-47bb-0310-9956-ffa450edef68;479cb452d43785c88c729934e079d5ca4939ba90
BOOKKEEPER-786: Fix Findbugs Error In Codahale Stats Provider (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1626721 13f79535-47bb-0310-9956-ffa450edef68;36478d1e639ba099cc4256ca2b2fbcc98f7649dd
BOOKKEEPER-782: Use builder pattern for Cookie (rakeshr via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1625888 13f79535-47bb-0310-9956-ffa450edef68;86480a21d366210eec96a7f47f2d43f1313705cc
BOOKKEEPER-784: BookKeeperCloseTest#testLedgerCheck is failing intermittently (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1625886 13f79535-47bb-0310-9956-ffa450edef68;4a2174a91fbd6b85fed640ef58f1c98fd28ee2d4
BOOKKEEPER-785: Fix javadoc warnings in trunk (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1625885 13f79535-47bb-0310-9956-ffa450edef68;4f0e52d027ed277576344ecbde1938ed3eeb7aae
BOOKKEEPER-783: Avoid running out of fds in MutlipleThreadReadTest (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1625611 13f79535-47bb-0310-9956-ffa450edef68;c918051659f9f9231989531304a0a0a15f0f939e
BOOKKEEPER-775: Improve MultipleThreadReadTest to reduce flakiness (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1624161 13f79535-47bb-0310-9956-ffa450edef68;77e68b5b033f306f8575b66278e8765784394413
BOOKKEEPER-776: Flaky test BookieRecoveryTest (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1623741 13f79535-47bb-0310-9956-ffa450edef68;fb6324b064e5b367d48d59fc44381462431d500a
BOOKKEEPER-781: Fix OOM on Hedwig Tests (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1623713 13f79535-47bb-0310-9956-ffa450edef68;2e1346c5fb6f8641f23dd926e1626211657be2ca
BOOKKEEPER-778: Flake in TestTryReadLastConfirmed (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1623618 13f79535-47bb-0310-9956-ffa450edef68;caf9ef945c93833f8cbc3bb0e6e451e1e58855cb
BOOKKEEPER-736: Stats for AutoRecovery (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1622832 13f79535-47bb-0310-9956-ffa450edef68;6fe9f6349443aaa193749e7d436a7aaca30d3ccd
BOOKKEEPER-718: AuditorLedgerCheckerTest is flakey (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1622830 13f79535-47bb-0310-9956-ffa450edef68;8abec018fca57d9cee9efd13a7085d8808a3b57e
BOOKKEEPER-779: jmx reporter for codahale metrics provider (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1622828 13f79535-47bb-0310-9956-ffa450edef68;fd6835e4f06d3cbb6a33062f582e4756d0a3139b
BOOKKEEPER-777: Flake in LedgerCloseTest (ivank via fpj)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1622827 13f79535-47bb-0310-9956-ffa450edef68;8f81eba34d2af8444be9f713447e12f4387e5932
BOOKKEEPER-780: Findbug issue in trunk (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1622568 13f79535-47bb-0310-9956-ffa450edef68;0c96765dffe3850ae6fc80397f9bc221421f1fa3
BOOKKEEPER-704: reconnectable zookeeper client wrapper (sijie via ivank) [missing file]--Change-Id: I46cf3237ec5e1998039fedee9d127752c1389a73--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1618817 13f79535-47bb-0310-9956-ffa450edef68;e61a1968c488a7517912be69e5d2cc98eb421040
BOOKKEEPER-630: Add tag to o.a.b.net.* to indict which release of hadoop they came from, move DNS to o.a.b.net.* and indent (sijie via ivank)--Change-Id: I9dd16912da6f23543d069434e9419495fdf8f314--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1618737 13f79535-47bb-0310-9956-ffa450edef68;c0cef66c6b34c635ec69a69ef033f96600ca5b99
BOOKKEEPER-704: reconnectable zookeeper client wrapper (sijie via ivank)--Change-Id: I00c73788f4ed5911713906b4d7622ca6dcec79a5--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1618732 13f79535-47bb-0310-9956-ffa450edef68;38a6fd30048c5fe165409a9ca536fb1ffbdbf537
BOOKKEEPER-774: Flaky test org.apache.bookkeeper.test.ReadOnlyBookieTest.testBookieShouldTurnWritableFromReadOnly (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1617888 13f79535-47bb-0310-9956-ffa450edef68;b6f33e49d0671a5b982bcb3613c5c9844f6aec8b
BOOKKEEPER-697: stats collection on bookkeeper server (sijie via fpj) (missing file)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1616094 13f79535-47bb-0310-9956-ffa450edef68;e30e116fc65088aad428b4151e1ab39c73c99676
BOOKEEPER-697. stats collection on bookkeeper server (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1615338 13f79535-47bb-0310-9956-ffa450edef68;69620e6561196975295752175b01354877a9fdde
BOOKKEEPER-582: Make bookie and client use protobuf for requests (non-wire part) (missing files) (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1613567 13f79535-47bb-0310-9956-ffa450edef68;4ec0bf11c3fdb78e390c5c889140d8fbf87ce60b
BOOKKEEPER-582: Make bookie and client use protobuf for requests (non-wire part)-(sijie via fpj)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1613315 13f79535-47bb-0310-9956-ffa450edef68;c81076e4d9521bc67653a917e9fb9edbe27bf073
BOOKKEEPER-739: Test timeouts mostly ignored (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1612972 13f79535-47bb-0310-9956-ffa450edef68;8f09334e24deaa8e80674a702c498d802986f3c8
BOOKKEEPER-768: fix typo seconds to milliseconds in benchmark output (jialin via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1610596 13f79535-47bb-0310-9956-ffa450edef68;37fda574a530eedc6bd3ba5030e2f3e0805c10f8
BOOKKEEPER-765 bookkeeper script should fall back to java in path if JAVA_HOME is not set (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1601592 13f79535-47bb-0310-9956-ffa450edef68;c9db762707538a99a92852e60b88bed577b01377
BOOKKEEPER-767: Allow loopback in tests (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1600881 13f79535-47bb-0310-9956-ffa450edef68;80c6e5526c63409e4f359905d0fd319ac7d2b129
BOOKKEEPER-766: Update notice.txt files to include 2014 (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1600594 13f79535-47bb-0310-9956-ffa450edef68;68deb96d2d1de45eea0c358c0eab39847d51e1f8
BOOKKEEPER-746: 5 new shell commands. List ledgers, list metadata, list underreplicated, show auditor and simpletest (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1599470 13f79535-47bb-0310-9956-ffa450edef68;404b83abafb94b62c0ced2ba7cf6878762643746
BOOKKEEPER-745: Fix for false reports of ledger unreplication during rolling restarts. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1599145 13f79535-47bb-0310-9956-ffa450edef68;d86917af98c2a7442619f1b71aa6d4d1da5945f4
BOOKKEEPER-751: Ensure all the bookkeeper callbacks not run under ledger handle lock (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1598585 13f79535-47bb-0310-9956-ffa450edef68;d11665de31b5ee6969128062569f2081b5d9cf79
BOOKKEEPER-758: Add TryReadLastAddConfirmed API (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1598565 13f79535-47bb-0310-9956-ffa450edef68;64d0170510849e29de9762957a7107d1a7f07284
BOOKKEEPER-763: findbugs fails to run on jenkins (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1598541 13f79535-47bb-0310-9956-ffa450edef68;209dbf4982eb997c9691c4331dcaea3b7e4af6d6
BOOKKEEPER-756: Use HashedwheelTimer for request timeouts for PCBC (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1597752 13f79535-47bb-0310-9956-ffa450edef68;ce3abc6e03216563613db23bd8dd11cf58645982
BOOKKEEPER-750. Flake in BookieAutoRecoveryTest#testEmptyLedgerLosesQuorumEventually (ivank via fpj)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1597125 13f79535-47bb-0310-9956-ffa450edef68;d67f3a752d291b1f55e5b9597eca6b135d3626ee
BOOKKEEPER-750. Flake in BookieAutoRecoveryTest#testEmptyLedgerLosesQuorumEventually (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1597124 13f79535-47bb-0310-9956-ffa450edef68;151c50dbe992efcaf0fa831dbf829b792b8bb925
BOOKKEEPER-755: Incorrect number of seconds specified in a day (Joseph Redfern via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1594744 13f79535-47bb-0310-9956-ffa450edef68;e3594b50f93b881f8ded9fe26c9ae2f875e054ea
BOOKKEEPER-747: Implement register/unregister LedgerMetadataListener in MSLedgerManagerFactory (fpj via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1593889 13f79535-47bb-0310-9956-ffa450edef68;3ed06c0e9246a3ac21e1340d01f1ee7be612194f
BOOKKEEPER-629: Support hostname based ledger metadata to help users to change IP with existing installation (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1593518 13f79535-47bb-0310-9956-ffa450edef68;19b821c63b91293960041bca7b031614a109a7b8
BOOKKEEPER-744: Run the auditor bookie check periodically (ivank) [missing files]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1592706 13f79535-47bb-0310-9956-ffa450edef68;e824ac2691f4e86ac5ced675cd3ffb66f00e059a
BOOKKEEPER-744: Run the auditor bookie check periodically (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1592705 13f79535-47bb-0310-9956-ffa450edef68;4c27506835dd0a58ee0a37c4422c44237a344b30
BOOKKEEPER-716: padding writes for bookie journal (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1591079 13f79535-47bb-0310-9956-ffa450edef68;5c18886657c88f48672554c0f814cf6418ad1e18
BOOKKEEPER-743: Periodic ledger check running too often as doc doesn't match implementation. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1589694 13f79535-47bb-0310-9956-ffa450edef68;54c54f71a5fad10838c66c6a6b28ef13d9388931
BOOKKEEPER-742: Fix for empty ledgers losing quorum. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1589636 13f79535-47bb-0310-9956-ffa450edef68;e1838f47800120252a3b5db77b7d1169e1daf801
BOOKKEEPER-432: Improve performance of entry log range read per ledger entries (yixue, sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1576883 13f79535-47bb-0310-9956-ffa450edef68;88533163987f328be1d36c9f6fc208667f2144a0
BOOKKEEPER-740: AutoRecoveryMainTest#testAutoRecoverySessionLoss is failing (Rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1575795 13f79535-47bb-0310-9956-ffa450edef68;1ac25ebe98dd3038f68fe80e79570b9beceb0be8
BOOKKEEPER-363: Re-distributing topics among newly added hubs. (aniruddha via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1575338 13f79535-47bb-0310-9956-ffa450edef68;2d427e8d4b2c1d889ab5586e28e198c140a10489
BOOKKEEPER-730: Shade pom file missing apache license header (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1575247 13f79535-47bb-0310-9956-ffa450edef68;9d4ce1671cd6731b9b9652399c24a91c34e0bc65
BOOKKEEPER-715: bookie: delay dropping journal cached pages (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1575246 13f79535-47bb-0310-9956-ffa450edef68;12daded8c22edc11363ec4eddfbba670e66ee9ad
BOOKKEEPER-717: journal should look forward to group time-out entries (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1575243 13f79535-47bb-0310-9956-ffa450edef68;261bb8f671dc233d3b604b3355bb20d82edac539
BOOKKEEPER-654: Bookkeeper client operations are allowed even after its closure, bk#close() (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1570647 13f79535-47bb-0310-9956-ffa450edef68;653dd6d733e9022a6189a2c8546bb8e3afa22715
BOOKKEEPER-731: Missing BOOKIE_PID_DIR and BOOKIE_STOP_TIMEOUT in env variables list (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1566512 13f79535-47bb-0310-9956-ffa450edef68;f19744d30ed879022a66de885cb1236d54582d2b
BOOKKEEPER-732: Add env variable ENTRY_FORMATTER_CLASS to the bkenv.sh (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1566510 13f79535-47bb-0310-9956-ffa450edef68;68ffb83d69e6e9be3da94e78d5f76bd6c57b2316
BOOKKEEPER-724: Shade introduces RAT error (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1565180 13f79535-47bb-0310-9956-ffa450edef68;8aafd10f6634f039e33b0576d4b61121b494e93a
BOOKKEEPER-726: PerChannelBookieClient should print address that it failed to connect to when it fails to correct (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1565115 13f79535-47bb-0310-9956-ffa450edef68;7e0b69cac5d406c777765bc1fa879520ea9176ec
BOOKKEEPER-725: AutoRecoveryMain should exit with error code if deathwatcher finds dead thread (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1565112 13f79535-47bb-0310-9956-ffa450edef68;3870ff300c64dc41828fdc8c9627e76450cff077
BOOKKEEPER-729: Bookie shouldn't exit with 0, if exiting from deathwatcher and thread death was caused by OOM (ivank via fpj)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1565109 13f79535-47bb-0310-9956-ffa450edef68;b62a67b1b11a10fe378a0bef25b846887cd104b1
BOOKKEEPER-728: Bookkeeper#Builder is not public, so can't be used outside of client package (ivank via fpj)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1565105 13f79535-47bb-0310-9956-ffa450edef68;63232dec02952e3404beeafd0c73fc61c2c7cd17
BOOKKEEPER-727: Names of bookie write/read threads are backwards (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1564949 13f79535-47bb-0310-9956-ffa450edef68;94ebe62b8c6ddcd2b52e8bc4eac4e102ff4cf720
BOOKKEEPER-644: Provide a bookie address wrapper (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1564946 13f79535-47bb-0310-9956-ffa450edef68;92a62781682721e7c6bb47a95c72029fb91d2e2f
BOOKKEEPER-708: Shade protobuf library to avoid incompatible versions (rakesh, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1563566 13f79535-47bb-0310-9956-ffa450edef68;0345c8095ee47aefd7d40a07e2a621079c94f4fd
BOOKKEEPER-703: Document all the settings added in BOOKKEEPER-656 (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1560917 13f79535-47bb-0310-9956-ffa450edef68;8bb0cde556cf1dc07d62cd74ca6739b392242cf0
BOOKKEEPER-643: Improve concurrency of entry logger (sijie & Aniruddha via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1560348 13f79535-47bb-0310-9956-ffa450edef68;694568b0ff0d048c284c8d5db0c9455d30dfa3ce
BOOKKEEPER-720: CheckpointSource.MIN#compareTo does exactly the opposite of what it should (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1560263 13f79535-47bb-0310-9956-ffa450edef68;7b44d9552d8b854160278582db3f5ca07882358a
BOOKKEEPER-661: Turn readonly back to writable if spaces are reclaimed. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1560066 13f79535-47bb-0310-9956-ffa450edef68;9b1e561cb5e4f081f40bf8b751bcc2c16226092e
BOOKKEEPER-719: Inconsistent synchronization of org.apache.bookkeeper.stats.CodahaleMetricsProvider.metrics (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1560045 13f79535-47bb-0310-9956-ffa450edef68;23f3760dd5d79e6894616834aa41d59089c9548a
BOOKKEEPER-696: stats collection on bookkeeper client (Aniruddha, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1559918 13f79535-47bb-0310-9956-ffa450edef68;75f103d9d6694ae0116fe741a2dfbf60e3c63ce1
BOOKKEEPER-429: Provide separate read and write threads in the bookkeeper server (Aniruddha via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1559917 13f79535-47bb-0310-9956-ffa450edef68;96cc0e11ca2166a5e5326be4ead0dab595b7e4bc
BOOKKEEPER-710: OpenLedgerNoRecovery should watch ensemble change. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1559192 13f79535-47bb-0310-9956-ffa450edef68;78c0d2515f2e381b2c690bdbf2bf9bad03d1250c
BOOKKEEPER-662: Major GC should kick in immediately if remaining space reaches a warning threshold (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1558410 13f79535-47bb-0310-9956-ffa450edef68;da8864ad7cd53d302eb27ab31f942bdbae160a98
BOOKKEEPER-714: Logging channel exceptions in PerChannelBookieClient (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1556732 13f79535-47bb-0310-9956-ffa450edef68;79a73f0f71be5701b44ab47c14f92945989b1417
BOOKKEEPER-709: SlowBookieTest#testSlowBookie fails intermittently (Rakesh R via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1555158 13f79535-47bb-0310-9956-ffa450edef68;5c3a30f8e423da51b1ee03173a336400335de3b8
BOOKKEEPER-701: Improve exception handling of Bookkeeper threads (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1548385 13f79535-47bb-0310-9956-ffa450edef68;34c260bfc7db379351fa8807897603b9a9b9012b
BOOKKEEPER-712: bookkeeper script should use java from JAVA_HOME (vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1548024 13f79535-47bb-0310-9956-ffa450edef68;42185c2e3d9e6d85b095842ac051f3a3c4a4d22f
BOOKKEEPER-711: bookkeeper-daemon.sh will not remove the pid file one successful stop (vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1548023 13f79535-47bb-0310-9956-ffa450edef68;810f10e9c628604a7697172df79478d9186be637
BOOKKEEPER-565: Make an option to separate storing entry log files from index files. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1547123 13f79535-47bb-0310-9956-ffa450edef68;7c7e009691bc24642018e4f5c81123a0667d4e8b
BOOKKEEPER-678: BookieServer shutdown hangs indefinitely at NioServerSocketChannelFactory.releaseExternalResources (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1544452 13f79535-47bb-0310-9956-ffa450edef68;67dccebdbee27476657898a370c4f1808231fc4b
BOOKKEEPER-699: Codahale metrics implementation of stats API (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1540366 13f79535-47bb-0310-9956-ffa450edef68;eb7066a02a50e2b15e66dfd4e99706ecf79454e6
BOOKKEEPER-700: GarbageCollectorThread exsiting with ArrayIndexOutOfBoundsException (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1537130 13f79535-47bb-0310-9956-ffa450edef68;ea4a13a45d8d2102f5f0098e404d3de66777a39b
BOOKKEEPER-698: Bookie client closure is not considering timeoutExecutor (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1536965 13f79535-47bb-0310-9956-ffa450edef68;f345cb9472250eca2b724fa14b8d2c08425b6a2f
BOOKKEEPER-615: Twitter stats implementation of stats interface (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1536635 13f79535-47bb-0310-9956-ffa450edef68;6c6ec2b2f9cb1aff37001f3d9f002cc820096404
BOOKKEEPER-614: Generic stats interface, which multiple providers can be plugged into (sijie & ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1536616 13f79535-47bb-0310-9956-ffa450edef68;cd05194d8bbb03a08d8d9fbeb09738bd8a2e09a8
BOOKKEEPER-602: we should have request timeouts rather than channel timeout in PerChannelBookieClient (Aniruddha, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1536584 13f79535-47bb-0310-9956-ffa450edef68;2d0cd0d1b9d41f3b600f6dac308c6d34317ae676
BOOKKEEPER-659: LRU page management in ledger cache. (Aniruddha, Robin Dhamankar & sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1534640 13f79535-47bb-0310-9956-ffa450edef68;bf5c1838b4b0d764aa9f24842643fd9339610b9c
BOOKKEEPER-664: Compaction increases latency on journal writes (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1534503 13f79535-47bb-0310-9956-ffa450edef68;9602c32f16184e10873d53c269e270e3cd0ebeed
BOOKKEEPER-688: NPE exception in PerChannelBookieClient (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1534498 13f79535-47bb-0310-9956-ffa450edef68;24dc8ac30c97620cf4dbef48deff2bb957932eb8
BOOKKEEPER-673: Ledger length can be inaccurate in failure case (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531970 13f79535-47bb-0310-9956-ffa450edef68;33ea58027b0a3ba160f7ac19d20568709f453f4d
BOOKKEEPER-676: Make add asynchrounous in ledger recovery (aniruddha via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531944 13f79535-47bb-0310-9956-ffa450edef68;a3575c3ebcb323a53d7a193488453aa44557c97a
BOOKKEEPER-605: Use static Logger objects everywhere for bookkeeper (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531920 13f79535-47bb-0310-9956-ffa450edef68;16978d671b8d6d9e563edb3a6119a4be574245af
BOOKKEEPER-657: Journal Improvement (Robin Dhamankar via sijie) (add missing file)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531495 13f79535-47bb-0310-9956-ffa450edef68;dc1f36e982f3fc2955141c8e0de5e04c6ac06053
BOOKKEEPER-657: Journal Improvement (Robin Dhamankar via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531494 13f79535-47bb-0310-9956-ffa450edef68;bedfebf93f8c9f93fac19bd58005dce6e0ffbd17
BOOKKEEPER-638: Two bookies could start at the same time to access bookie data. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531302 13f79535-47bb-0310-9956-ffa450edef68;d9f4e60c850291d17e12ed44776b88cf02335701
BOOKKEEPER-658: ledger cache refactor (Robin Dhamankar via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1531203 13f79535-47bb-0310-9956-ffa450edef68;0f853a49d7e6899151f63ae9b1912ed936e5a5fb
BOOKKEEPER-686: Bookie startup will fail if one of the configured ledgerDir is full and the same is used for replaying the journal (Rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1528307 13f79535-47bb-0310-9956-ffa450edef68;8dafa943a1d5a1cf562d94cc6d2f656e0c0be17e
BOOKKEEPER-645: Bookkeeper shell command to get a list of readonly bookies (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1528306 13f79535-47bb-0310-9956-ffa450edef68;3d9bb20a7f7e510bce7c16be392c0ac82c3a3496
BOOKKEEPER-666: Naming threads of ExecutorService (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1528305 13f79535-47bb-0310-9956-ffa450edef68;e2013e3f2b2e3e10ce5d1977adac8e073fd0404d
BOOKKEEPER-640: Log improvement - add shutdown/exit log message for the bookie services (rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1528304 13f79535-47bb-0310-9956-ffa450edef68;dea488afbf4615e4416079f5517a6e3ae1000c17
BOOKKEEPER-683: TestSubAfterCloseSub fails on 4.2 (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1526841 13f79535-47bb-0310-9956-ffa450edef68;441891b2d76b3b0244d00480e0ab70f2d2121d57
BOOKKEEPER-675: Log noise fixup before cutting 4.2.2 (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1521667 13f79535-47bb-0310-9956-ffa450edef68;bc0eb8b14278999a5c6550fbca6531b862beb12b
BOOKKEEPER-446: BookKeeper.createLedger(..) should not mask the error with ZKException (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1521474 13f79535-47bb-0310-9956-ffa450edef68;aadaae443e1bc70505150a3218a54ff66ebfb921
BOOKKEEPER-580: improve close logic (sijie & ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1516929 13f79535-47bb-0310-9956-ffa450edef68;98d6dcec7403c523cfd07cf48ed878e1ab13eae0
BOOKKEEPER-649: Race condition in sync ZKUtils.createFullPathOptimistic() (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1516465 13f79535-47bb-0310-9956-ffa450edef68;d8e6972385e6662ddcf398fc2de47622a9bef22d
BOOKKEEPER-632: AutoRecovery should consider read only bookies (vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1516139 13f79535-47bb-0310-9956-ffa450edef68;c4fd34f0f13a044c0261732ff2dd454acc4b73de
BOOKKEEPER-624: Reduce logs generated by ReplicationWorker (vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1515774 13f79535-47bb-0310-9956-ffa450edef68;f41bb6f8b521e26a0a746530e648a9ca2120af51
BOOKKEEPER-668: Race between PerChannelBookieClient#channelDisconnected() and disconnect() calls can make clients hang while add/reading entries in case of multiple bookie failures (sijie & ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1515769 13f79535-47bb-0310-9956-ffa450edef68;2179f1bf6d656d7c5f7e89f2eeaaa0732f0b9608
BOOKKEEPER-667: Client write will fail with BadMetadataVersion in case of multiple Bookie failures with AutoRecovery enabled (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1513459 13f79535-47bb-0310-9956-ffa450edef68;94d65d8d2e3239ad0694d3c2252fca0e3dbea8b3
BOOKKEEPER-604: Ledger storage can log an exception if GC happens concurrently. (sijie & ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1513198 13f79535-47bb-0310-9956-ffa450edef68;d1ad860f8e83530e0d8f1498a35da2e9fbb85962
BOOKKEEPER-663: HierarchicalLedgerManager iterator is missing some ranges and the last ledger in the range (mmerli via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1507997 13f79535-47bb-0310-9956-ffa450edef68;22509a7a2c8acbd5cce182529169fc0057e55b0d
BOOKKEEPER-642: Bookie returns incorrect exitcode, ExitCode.ZK_REG_FAIL is getting overridden (Rakesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1506582 13f79535-47bb-0310-9956-ffa450edef68;d3328c5a78137de5416f3d8bc1f269f2ac648e6b
BOOKKEEPER-653: Timeout option is missing in few testcases (Rakesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1506569 13f79535-47bb-0310-9956-ffa450edef68;67ffec189fc77e53a8dcbe666b1695a3b790e8da
BOOKKEEPER-607: Filtered Messages Require ACK from Client Causes User Being Throttled Incorrectly Forever (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505726 13f79535-47bb-0310-9956-ffa450edef68;a889f63d1041a84d6b894874b31681ed35312781
BOOKKEEPER-652: Logger class name is wrong in LedgerCacheImpl.java (Rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505185 13f79535-47bb-0310-9956-ffa450edef68;61e619c2b2215fca05df3498256e3f0966a668ff
BOOKKEEPER-646: BookieShell readjournal command is throwing BufferUnderflowException (Rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505181 13f79535-47bb-0310-9956-ffa450edef68;4a2c740129d506f620dcfbdb5e1e852258a726d2
BOOKKEEPER-635: jenkins build should highlight which lines of the patch cause raw analysis errors (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505179 13f79535-47bb-0310-9956-ffa450edef68;d9682edfc57911ccb9d70ae41c6627112a96a355
BOOKKEEPER-610: Make SyncThread use an executor (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505175 13f79535-47bb-0310-9956-ffa450edef68;f3731732ce984f41b8530939254706f9e597583d
BOOKKEEPER-563: Avoid Journal polluting page cache (Robin Dhamankar via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505174 13f79535-47bb-0310-9956-ffa450edef68;4d66c36cf8825ab3f9f4a389bddfb924a0df9107
BOOKKEEPER-600: shouldClaim flag isn't cleared for hedwig multiplex java client (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1503075 13f79535-47bb-0310-9956-ffa450edef68;53c208b09483c90207aecf0e27e669ee810619c2
BOOKKEEPER-601: readahead cache size isn't updated correctly (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1502803 13f79535-47bb-0310-9956-ffa450edef68;0ce12e55edb179fc55bc9c5749a589a52bb36b3a
BOOKKEEPER-636: Latest txn logs might be deleted in a race condition which is not recoverable if BK goes down before next txn log created. (vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1499731 13f79535-47bb-0310-9956-ffa450edef68;ed3bb58f5cc5cd4176573cb696bb7277c628b26a
BOOKKEEPER-641: DeathWatcher thread is unnecessarily running even after bookie shutdown (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1499445 13f79535-47bb-0310-9956-ffa450edef68;0d9708c65998f48ba9b692ff5532251a0e1b8bc9
BOOKKEEPER-637: NoSuchEntry exception when reading an entry from a bookie should not print ERROR level message (mmerli via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1499032 13f79535-47bb-0310-9956-ffa450edef68;ad11d4144dbf024fcdfd22a2a043c7790f940dc3
BOOKKEEPER-620: PerChannelBookieClient race during channel disconnect (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1497814 13f79535-47bb-0310-9956-ffa450edef68;bf3224adf56b74e7d8c2792eec9dcdab9c49e3d3
BOOKKEEPER-633: ConcurrentModificationException in RackawareEnsemblePlacementPolicy when a bookie is removed from available list (vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1496706 13f79535-47bb-0310-9956-ffa450edef68;0cd4be8fde5206d956addd29cbad0391ceca1716
BOOKKEEPER-623: LedgerChecker should avoid segments of closed ledger with higher start entryId than closed entry. (vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1496705 13f79535-47bb-0310-9956-ffa450edef68;119e2034303b45478123a0fa62c1c48925b201c1
BOOKKEEPER-313: Bookkeeper shutdown call from Bookie thread is not shutting down server (vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1495513 13f79535-47bb-0310-9956-ffa450edef68;01cccee0298f3e0f9d32acc550ed94a7c9fafdfd
BOOKKEEPER-619: Bookie should not create local cookie files if zookeeper is uninitialized (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1495508 13f79535-47bb-0310-9956-ffa450edef68;a3de791cb79873c4f9b99e7ac1b9ade75ea225ac
BOOKKEEPER-618: Better resolution of bookie address (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1493400 13f79535-47bb-0310-9956-ffa450edef68;fce6d459242361e2363b9b92f8c764b04c7ddfd7
BOOKKEEPER-627: LedgerDirsMonitor is missing thread name (rakesh via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1493377 13f79535-47bb-0310-9956-ffa450edef68;5ef7f760d8ccf2bc765e77891447ed050926f4a3
BOOKKEEPER-626: BOOKIE_EXTRA_OPTS are added twice (vinay via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1493373 13f79535-47bb-0310-9956-ffa450edef68;0a208e10117f8c5201e0414ce3d644d2367b5abc
BOOKKEEPER-592: allow application to recommend ledger data locality (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1492274 13f79535-47bb-0310-9956-ffa450edef68;1c04906c0077d228076c3d157d815e5c7219bb0c
BOOKKEEPER-617: BOOKKEEPER-544 breaks hedwig-server/bin/hedwig script (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1489775 13f79535-47bb-0310-9956-ffa450edef68;faf2ed87762fabe4f6cb5f629cf5a7132869ca60
BOOKKEEPER-603: Support Boost 1.53 for Hedwig Cpp Client (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1488954 13f79535-47bb-0310-9956-ffa450edef68;cf2a858bb7bc669e12058e2dda1a996a67d3d37a
BOOKKEEPER-611: Speed up bookkeeper tests (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1488138 13f79535-47bb-0310-9956-ffa450edef68;ccc9545c4565c337ef6ea06004149de75b4dd3af
BOOKKEEPER-257: Ability to list all ledgers (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1480978 13f79535-47bb-0310-9956-ffa450edef68;4c89310f8b8e09f2ad394a7e7fd5fffc8f51e701
BOOKKEEPER-608: Make SyncThread a reusable component (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1480580 13f79535-47bb-0310-9956-ffa450edef68;c2bb7ffb366d5c1942ee2e040516af749a705115
BOOKkEEPER-577: BookieFailureTest uses sync/wait()/notify() incorrectly (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1480051 13f79535-47bb-0310-9956-ffa450edef68;f86e4929ef9c0ddfa7d26d230caefa369a2a0dde
BOOKKEEPER-562: Ability to tell if a ledger is closed or not (fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1479649 13f79535-47bb-0310-9956-ffa450edef68;3a4f8920ba5017ef37d7641d3d5f0eeb0bbc590b
BOOKKEEPER-564: Better checkpoint mechanism (sijie & ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1479085 13f79535-47bb-0310-9956-ffa450edef68;d175ada58dcaf78f0a70b0ebebf489255ae67b5f
BOOKKEEPER-584: Data loss when ledger metadata is overwritten (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1476283 13f79535-47bb-0310-9956-ffa450edef68;685ca079690f8be2cbcfacb615fc0eb5a798b8da
BOOKKEEPER-598: Fails to compile - RESUBSCRIBE_EXCEPTION conflict (Matthew Farrellee via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1465438 13f79535-47bb-0310-9956-ffa450edef68;09ec928ee0218caeef5661ba60978fd18b2e553b
BOOKKEEPER-599: NPE in PerChannelBookieClient (jiannan via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1465437 13f79535-47bb-0310-9956-ffa450edef68;cdf138e24b76f934721eb1e82a226d0be296b838
BOOKKEEPER-596: Ledgers are gc'ed by mistake in MSLedgerManagerFactory. (sijie & ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1464385 13f79535-47bb-0310-9956-ffa450edef68;b118823702e946ccdeb14843e2691fdd760a59e4
BOOKKEEPER-595: Crash of inprocess autorecovery daemon should not take down the bookie (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1463599 13f79535-47bb-0310-9956-ffa450edef68;c8f9135e7d3147a2a474df31b430b8c403e2792a
BOOKKEEPER-597: Add flag to output test logs to stdout (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1463555 13f79535-47bb-0310-9956-ffa450edef68;feb077afa2e5064f24f011067fd626c81ede8491
BOOKKEEPER-581: Ledger recovery doesn't work correctly when recovery adds force changing ensembles. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460765 13f79535-47bb-0310-9956-ffa450edef68;455aabfd3b6ffd4247f6df63cb29d0694b359cdd
BOOKKEEPER-506: Provide better topic release algorithm (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460751 13f79535-47bb-0310-9956-ffa450edef68;e14cbe41b5db846a5d819fcae6e82bc489ebeb73
BOOKKEEPER-586: Remove recursive call in delivery manager (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460709 13f79535-47bb-0310-9956-ffa450edef68;6268be59c7d8cf411860a6807a2cb45bc1c891f4
BOOKKEEPER-583: Read from a ReadOnlyBookie fails if index fileinfo is not in ledger cache (vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460524 13f79535-47bb-0310-9956-ffa450edef68;d1bb8ec0e7c65e241f55c8b700395570e0ee5daf
BOOKKEEPER-557: Compiler error showing up badly with jdk 7 (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460523 13f79535-47bb-0310-9956-ffa450edef68;f2bb5603ff33b8ac54bcdf2daddb61cf3e65de80
BOOKKEEPER-573: Script to start a bookkeeper cluster (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1457598 13f79535-47bb-0310-9956-ffa450edef68;9868081b708b27f272e2a92cf04163996caf9544
 BOOKKEEPER-585: Auditor logs noisily when a ledger has been deleted (ivank via sijie) --git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1457596 13f79535-47bb-0310-9956-ffa450edef68;9f0d2a3e2f4279921f8fa1df8aad708773124cd5
BOOKKEEPER-576: Bookie client should use netty Decoder/Encoder (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1457592 13f79535-47bb-0310-9956-ffa450edef68;1b7cb6fa9704d10a3a6134edfd0b12d85bf0012c
BOOKKEEPER-579: TestSubAfterCloseSub was put in a wrong package (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1454625 13f79535-47bb-0310-9956-ffa450edef68;94ea9a8629ce404566d875895208dabe82c99fbe
BOOKKEEPER-559: Fix occasional failure in AuditorBookieTest. Contributed by Ivan Kelly.----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1452915 13f79535-47bb-0310-9956-ffa450edef68;ea5a13d748918f495ad1cb1e37c0f995e3d53072
BOOKKEEPER-574: Extend the bookkeeper shell to get a list of available bookies. Contributed by Ivan Kelly----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1450005 13f79535-47bb-0310-9956-ffa450edef68;f31a366fa581b5561bc51d6dd06ce2ebfe3c9f03
BOOKKEEPER-567: ReadOnlyBookieTest hangs on shutdown (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1447772 13f79535-47bb-0310-9956-ffa450edef68;d40d380363f7ab608231e91b84dd94e3478f3773
BOOKKEEPER-549: Documentation missed for readOnlyMode support (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1447759 13f79535-47bb-0310-9956-ffa450edef68;f4d189431ee77d1133b617dba9e939756cb9d721
BOOKKEEPER-548: Document about periodic ledger checker configuration (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1447756 13f79535-47bb-0310-9956-ffa450edef68;040a442bef5b93143a9e07c0b601fddea88c5712
BOOKKEEPER-569: Critical performance bug in InterleavedLedgerStorage (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1446902 13f79535-47bb-0310-9956-ffa450edef68;cda181255f0bb2ebc1a69f75b2b6f84b50c4fba0
BOOKKEEPER-568: NPE during GC with HierarchicalLedgerManager (Matteo via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1446444 13f79535-47bb-0310-9956-ffa450edef68;5b7b6835c74a11162164e90e66bb05a84411a8c2
BOOKKEEPER-555: Make BookieServer use Netty rather than a custom IO server (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1445085 13f79535-47bb-0310-9956-ffa450edef68;26731c770bf8e3cb54ec0466c027b6e313983bba
BOOKKEEPER-554: fd leaking when move ledger index file (sijie, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1445033 13f79535-47bb-0310-9956-ffa450edef68;3bcabc5adb48e75dd041384ebcbb0017d56c3299
BOOKKEEPER-556: BookieServerMXBean#getServerState makes no sense (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1444340 13f79535-47bb-0310-9956-ffa450edef68;3902ae5a6056ba6348f71c873d23f74ac32cebef
BOOKKEEPER-561 Findbugs report errors with openjdk. Contributed by Ivan Kelly.----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1444174 13f79535-47bb-0310-9956-ffa450edef68;f060c0d2745b47314562bc94ecb5f525e2addb07
BOOKKEEPER-526: multiple threads for delivery manager (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1443017 13f79535-47bb-0310-9956-ffa450edef68;b4bac04a8141fa116223de8028471facbe343555
BOOKKEEPER-312: Implementation of JMS provider (mridul via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1441108 13f79535-47bb-0310-9956-ffa450edef68;e95b9392d4ba38c68617dff16de53e523d8ea51b
BOOKKEEPER-544: Modify hedwig server tests to allow client testcases to start/stop them as part of their tests (mridul via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1438120 13f79535-47bb-0310-9956-ffa450edef68;7bed2a74a98f49b31c1653a513944f60a359776c
Fixup for CHANGES.txt (some issues were missing or wrongly placed, also removed tabs)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432977 13f79535-47bb-0310-9956-ffa450edef68;ec430abc550d8d1d66e9dd8dc3c096f44e666eeb
BOOKKEEPER-472: Provide an option to start Autorecovery along with Bookie Servers (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432964 13f79535-47bb-0310-9956-ffa450edef68;087e490270c6e006b9e4b47035f20fea843149be
Updating version in CHANGES.txt & pom.xml after branching for 4.2.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432921 13f79535-47bb-0310-9956-ffa450edef68;582370359c8e0e399b30df5a7e60a569b0d5aadf
Updating version in CHANGES.txt before branching for 4.2.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432916 13f79535-47bb-0310-9956-ffa450edef68;17de3dbe64450bfab7505d7cf51e082eb5672bc8
BOOKKEEPER-513: TestMessageFilter fails periodically (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432902 13f79535-47bb-0310-9956-ffa450edef68;7d8079c446110872d8f6d50eff86268a3cb4e989
BOOKKEEPER-503: The test case of TestThrottlingDelivery#testServerSideThrottle failed sometimes (jiannan & sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1432485 13f79535-47bb-0310-9956-ffa450edef68;96b5aa8e6463c36a0421e47f9892479aa63f885b
BOOKKEEPER-539: ClientNotSubscribedException & doesn't receive enough messages in TestThrottlingDelivery#testServerSideThrottle (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431869 13f79535-47bb-0310-9956-ffa450edef68;1374b7ad2738f6c52a2aed1d0ee4e412aa382086
BOOKKEEPER-538: Race condition in BookKeeper#close (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431536 13f79535-47bb-0310-9956-ffa450edef68;4250c1f93962af30e6e40759e006035a7089613e
BOOKKEEPER-530: data might be lost during compaction. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431378 13f79535-47bb-0310-9956-ffa450edef68;7c1793d2979b01062682b70687839a978bf65c4c
BOOKKEEPER-540: #stopServingSubscriber when channel is disconnected. (Fangmin via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431235 13f79535-47bb-0310-9956-ffa450edef68;40de140171a26b0943909900d6af4a73b31a641e
BOOKKEEPER-543: Read zk host list in a wrong way in hedwig server (Fangmin via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431232 13f79535-47bb-0310-9956-ffa450edef68;a9b851b3afe2d8031ad426fdd2e579ba003fe02c
BOOKKEEPER-542: Remove trailing spaces in IndexCorruptionTest (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430972 13f79535-47bb-0310-9956-ffa450edef68;5c19add8bc394d3caae4fddf566e149281370a52
BOOKKEEPER-529: stopServingSubscriber in delivery manager should remove stub callbacks in ReadAheadCache (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430954 13f79535-47bb-0310-9956-ffa450edef68;1f5278d06ddbf4da0d2d6ed41676321f89a4aecd
BOOKKEEPER-533: TestSubAfterCloseSub fails strangely in tests (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430933 13f79535-47bb-0310-9956-ffa450edef68;f0db18abedd30af1d6191d068652b93db0c68fc6
BOOKKEEPER-541: Add guava to notice file (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430898 13f79535-47bb-0310-9956-ffa450edef68;55a6e1b983420b40813b327f67bbbff8196a8e41
BOOKKEEPER-531: Cache thread should wait until old entries are collected (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430795 13f79535-47bb-0310-9956-ffa450edef68;faf407d5d40e9d476bab2a926f41b993bf87098f
BOOKKEEPER-532: AbstractSubscriptionManager#AcquireOp read subscriptions every time even it already owned the topic. (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430091 13f79535-47bb-0310-9956-ffa450edef68;ed9b6037be51845f7cab2446593df695ffcede59
BOOKKEEPER-534: Flakeyness in AuditorBookieTest (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1430041 13f79535-47bb-0310-9956-ffa450edef68;f7ce39d522827a0359a0183eae02694ebb35bafd
BOOKKEEPER-355: Ledger recovery will mark ledger as closed with -1, in case of slow bookie is added to ensemble during recovery add (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1429756 13f79535-47bb-0310-9956-ffa450edef68;b625fdc27a429341143e204338cf5deab3188e9e
BOOKKEEPER-524: Bookie journal filesystem gets full after SyncThread is terminated with exception (Matteo, fpj via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1429650 13f79535-47bb-0310-9956-ffa450edef68;f80dcedaeea5f701822f02484c098cf4df2f04da
BOOKKEEPER-293: Periodic checking of ledger replication status (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1428777 13f79535-47bb-0310-9956-ffa450edef68;005b62cc60093dd5b32d4abecd06c2e441bc62ae
BOOKKEEPER-507: Race condition happens if closeSubscription and subscribe happened at the same time (in multiplexed client). (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1428277 13f79535-47bb-0310-9956-ffa450edef68;ee29f75f3f6a0168008da2e424e4174f2aee8cbb
BOOKKEEPER-409: Integration Test - Perform bookie rereplication cycle by Auditor-RW processes (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1428258 13f79535-47bb-0310-9956-ffa450edef68;b4e985b32cbb5aa7c6b109898f9d8bf51b2fd330
BOOKKEEPER-55: SubscribeReconnectRetryTask might retry subscription endlessly when another subscription is already successfully created previously (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1428059 13f79535-47bb-0310-9956-ffa450edef68;a27b64e340a6ad12f1e9588d1d55fa51f0b2d1f0
BOOKKEEPER-523: Every test should have a timeout (ivank, sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1426772 13f79535-47bb-0310-9956-ffa450edef68;7b2b91579000bc99d6fdded3aefb349975058c6f
BOOKKEEPER-514: TestDeadLock hanging sometimes (ivank, sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1426461 13f79535-47bb-0310-9956-ffa450edef68;ea36e59a1c314bf698d572e5f714e0b68e554a6e
BOOKKEEPER-520: BookieFailureTest hangs on precommit build (sijie via fpj, jira reopened)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1426349 13f79535-47bb-0310-9956-ffa450edef68;8a396e1f74ff9f9cf25d3b4bfc43c8a112992555
BOOKKEEPER-447: Bookie can fail to recover if index pages flushed before ledger flush acknowledged (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1425588 13f79535-47bb-0310-9956-ffa450edef68;7de3ecbd5d5052138a9c4aded9256c5030ab2f6d
BOOKKEEPER-522: TestHedwigHub is failing silently on Jenkins (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1425586 13f79535-47bb-0310-9956-ffa450edef68;a0ae97c232caafa1fda9955f9aaa9f99564b74fe
BOOKKEEPER-463: Refactor garbage collection code for ease to plugin different GC algorithm. (Fangmin, ivank, fpj via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1425585 13f79535-47bb-0310-9956-ffa450edef68;fa13426970bd4b6d7ffc086e776559f87349ef71
BOOKKEEPER-520: BookieFailureTest hangs on precommit build (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1424335 13f79535-47bb-0310-9956-ffa450edef68;a3da8c74c4226b7d92e9d0eba9591334351afa45
BOOKKEEPER-500: Fencing doesn't work when restarting bookies. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1423419 13f79535-47bb-0310-9956-ffa450edef68;d69986c4df6b51ed6ed27c5f45a7b6850e69dacd
BOOKKEEPER-496: Ensure that the auditor and replication worker will shutdown if they lose their ZK session (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1423409 13f79535-47bb-0310-9956-ffa450edef68;e5b0dd0d9e47394202f5a20cedf409f487d90beb
BOOKKEEPER-509: TestBookKeeperPersistenceManager failed on latest trunk (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1423405 13f79535-47bb-0310-9956-ffa450edef68;a4d8a34fb0779551208ad003b950e0b9a9d86d42
BOOKKEEPER-342: add documentation for hedwig metadata manager interface. (sijie, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1423281 13f79535-47bb-0310-9956-ffa450edef68;c784b602325361a7606f2f53b677996e2c23f730
BOOKKEEPER-490: add documentation for MetaStore interface (sijie, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1423278 13f79535-47bb-0310-9956-ffa450edef68;3ab615ebbce3871b1d15099f4e24ecaae9e83d8a
BOOKKEEPER-375: Document about Auto replication service in BK (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1422952 13f79535-47bb-0310-9956-ffa450edef68;a8d61e64604a6ea5ce6caccc5d29aea2abac69f3
BOOKKEEPER-512: BookieZkExpireTest fails periodically (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1422174 13f79535-47bb-0310-9956-ffa450edef68;d1a3c6d11eb4433c7e25eeba6ac21fe2db3a2696
BOOKKEEPER-511: BookieShell is very noisy (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1422173 13f79535-47bb-0310-9956-ffa450edef68;8c1e71f2b9cb8425046517f69a5024c31d47783c
BOOKKEEPER-428: Expose command options in bookie scripts to disable/enable auto recovery temporarily (rakesh, ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1422056 13f79535-47bb-0310-9956-ffa450edef68;5428454ca34823a225eafb114128931d313d9e2f
BOOKKEEPER-428: Expose command options in bookie scripts to disable/enable auto recovery temporarily (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1422054 13f79535-47bb-0310-9956-ffa450edef68;e4a42af6933c0cb0be441b3d9d5d28790aa9a7b9
BOOKKEEPER-504: Fix findbugs warning in PendingReadOp (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421875 13f79535-47bb-0310-9956-ffa450edef68;dffe13f5b16200e192c36547021c34c186d00de8
BOOKKEEPER-426: Make auditor Vote znode store a protobuf containing the host that voted (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421781 13f79535-47bb-0310-9956-ffa450edef68;8125700069b14f80ebd135ddd1a2b67de256cb1e
BOOKKEEPER-408: BookieReadWriteTest will enter the endless loop and will not leave out (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421401 13f79535-47bb-0310-9956-ffa450edef68;e0011de4475969c19023694f5074b50e5d12a08f
BOOKKEEPER-341: add documentation for bookkeeper ledger manager interface. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421388 13f79535-47bb-0310-9956-ffa450edef68;4320f6f8a2621c852c19fa81ba7edd8a9e6c87a7
BOOKKEEPER-262: Implement a meta store based hedwig metadata manager. (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421384 13f79535-47bb-0310-9956-ffa450edef68;3a950e6f7f5ca8b646e82c61c98a65991df8d88f
BOOKKEEPER-483: precommit tests only check toplevel rat file, not the one for submodules. (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421346 13f79535-47bb-0310-9956-ffa450edef68;d932c9b2181cc9f9b6bb3b43abd5af04cda206b8
BOOKKEEPER-336: bookie readEntries is taking more time if the ensemble has failed bookie(s) (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421242 13f79535-47bb-0310-9956-ffa450edef68;496f442a7a68dd549355e845540c6c72c2fbb44c
BOOKKEEPER-458:  Annoy BKReadException error when changing ledger. (jiannan via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421239 13f79535-47bb-0310-9956-ffa450edef68;d58a71dbd1f07a3edf65c4af80ae18a4d9a95755
BOOKKEEPER-365: Ledger will never recover if one of the quorum bookie is down forever and others dont have entry (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421235 13f79535-47bb-0310-9956-ffa450edef68;b6c1a8bbd7c2d44c2edb59d9938fa073f6f478de
BOOKKEEPER-404: Deprecate non-SubscriptionOptions Subscriber Apis (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1421083 13f79535-47bb-0310-9956-ffa450edef68;1e35d5d5e6de6a33cd4ca200f3d5d92dcf7cb58d
BOOKKEEPER-493: moveLedgerIndexFile might have chance pickup same directory (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420854 13f79535-47bb-0310-9956-ffa450edef68;55610c26eb3b8b4cd5dd1955a434c2642334c605
BOOKKEEPER-205: implement a MetaStore based ledger manager for bookkeeper client. (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420607 13f79535-47bb-0310-9956-ffa450edef68;5414cec92a99135c8ba0bc0f6768bd348c65e2fb
BOOKKEEPER-497: GcLedgersTest has a potential race (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420532 13f79535-47bb-0310-9956-ffa450edef68;7fa41ff318a31f973d1de12afe8db0f9893ac653
BOOKKEEPER-495: Revise BK config doc (fpj, ivank via fpj)-(a few extra edits to bookieCOnfigParams.textile)- ---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420318 13f79535-47bb-0310-9956-ffa450edef68;7275006bf7d13194aff768b22da55814e11b1cc2
BOOKKEEPER-495: Revise BK config doc (fpj, ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420308 13f79535-47bb-0310-9956-ffa450edef68;7467d2697103abba54d8f665724d630721064e78
BOOKKEEPER-491: Hedwig doc for configuration (fpj, sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1420069 13f79535-47bb-0310-9956-ffa450edef68;be155aa0c61f6b7bc0bf3d4f2ea56a9b97e590bf
BOOKKEEPER-498: BookieRecoveryTest.tearDown NPE (fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1419496 13f79535-47bb-0310-9956-ffa450edef68;77efd1c00100b533d67e716579b439e94d4050e3
BOOKKEEPER-465: CreateNewLog may overwrite lastLogId with smaller value (yixue, fpj via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1419311 13f79535-47bb-0310-9956-ffa450edef68;7d3dde696ae859297ece4e2c9a047afde4fa5865
BOOKKEEPER-469: Remove System.out.println from TestLedgerManager (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1419306 13f79535-47bb-0310-9956-ffa450edef68;a063f9b19d035d8c2d9e76e3741368cf41e7d292
BOOKKEEPER-474:  BookieReadWriteTest#testShutdown doesn't make sense (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1418685 13f79535-47bb-0310-9956-ffa450edef68;40ac04bfee52f2e0fd45397cf5d02fa31236c753
BOOKKEEPER-431: Duplicate definition of COOKIES_NODE (uma via fpj). -Additional commit to fix the DEFAULT_ZK_LEDGERS_ROOT_PATH constant.----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1418638 13f79535-47bb-0310-9956-ffa450edef68;d0217c170a0906bdf3188cc89a290f6da0950146
BOOKKEEPER-431: Duplicate definition of COOKIES_NODE (uma via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1418637 13f79535-47bb-0310-9956-ffa450edef68;66a0dde14f8d69ebdd409f3a2011d03bcd6b62cd
BOOKKEEPER-453: Extract commonality from MultiplexSubscribeResponseHandler and SimpleSubscribeResponseHandler and put into an abstract class  (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1418280 13f79535-47bb-0310-9956-ffa450edef68;baef283841c05bcb4ebceaaa5d540f7a30e4af1a
BOOKKEEPER-475: BookieRecoveryTest#testSyncBookieRecoveryToRandomBookiesCheckForDupes() iterates too much (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1417190 13f79535-47bb-0310-9956-ffa450edef68;366d393f2e58acdd5494da4ae60513c3ae5730c4
BOOKKEEPER-461: Delivery throughput degrades when there are lots of publishers w/ high traffic. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1417066 13f79535-47bb-0310-9956-ffa450edef68;7f67e765c73890a2f838ec8f5d43b814ce42c84b
BOOKKEEPER-470: Possible infinite loop in simple.SubscribeReconnectCallback (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1417046 13f79535-47bb-0310-9956-ffa450edef68;6030beaba9e770db9b856b8de1b06dab843b2ccc
BOOKKEEPER-399: Let hub server configure write quorum from ack quorum. (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416677 13f79535-47bb-0310-9956-ffa450edef68;55f6300ef7eea86c7573d07d65341e2f9ad982a4
BOOKKEEPER-484: Misc fixes for test scripts (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416655 13f79535-47bb-0310-9956-ffa450edef68;c86eb1c481fd837269d370cbcc248274708b0887
BOOKKEEPER-347: Provide mechanism to detect r-o bookie by the bookie clients (Vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416590 13f79535-47bb-0310-9956-ffa450edef68;7f6adbe34f828f6c86fe30bfa398180fdb512425
BOOKKEEPER-442: Failed to deliver messages due to inconsistency between SubscriptionState and LedgerRanges. (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416560 13f79535-47bb-0310-9956-ffa450edef68;0ea460606e4a45a07a79c356ad1d58a6119e0d31
BOOKKEEPER-459: Rename metastore mock implementation to InMemory implementation (jiannan via ivank) [remove directory]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416526 13f79535-47bb-0310-9956-ffa450edef68;4380e52969beac534fd1da6a68bd28d48b9ba7e9
BOOKKEEPER-459: Rename metastore mock implementation to InMemory implementation (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416519 13f79535-47bb-0310-9956-ffa450edef68;03bf28db4e8e99a4326e0e01c7a9f7134f151a7b
[REVERT] BOOKKEEPER-336 bookie readEntries is taking more time if the ensemble has failed bookie(s) Basic speculative functionality  in place-Accidently committed this change, before approval. Reverting (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416408 13f79535-47bb-0310-9956-ffa450edef68;bdf3bfd631493d82688404dde35eed491ec946ad
BOOKKEEPER-291: BKMBeanRegistry uses log4j directly (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416400 13f79535-47bb-0310-9956-ffa450edef68;6a6d25e7e9a2c3cc4370799ec2529915929e5acc
BOOKKEEPER-336 bookie readEntries is taking more time if the ensemble has failed bookie(s) Basic speculative functionality  in place--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416393 13f79535-47bb-0310-9956-ffa450edef68;f12b7896e1640bed64cedb0d96bdd82b6cf26a86
BOOKKEEPER-351: asyncAddEntry should not throw an exception (Matteo Merli via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416352 13f79535-47bb-0310-9956-ffa450edef68;c958b32da81936cee535c411f2214d900f54442c
BOOKKEEPER-485: TestFencing hung (ivank via fpj)----THIS line, and those below, will be ignored----M    CHANGES.txt-A    bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestPerChannelBookieClient.java-M    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1416000 13f79535-47bb-0310-9956-ffa450edef68;100785f6f1feb2e6dd1c7de769adab5c88e87427
BOOKKEEPER-482: Precommit is reporting findbugs errors in trunk (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415920 13f79535-47bb-0310-9956-ffa450edef68;e14983cbea5238a75a45bff4f23a8e431a5892f0
BOOKKEEPER-389: add documentation for message filter. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415691 13f79535-47bb-0310-9956-ffa450edef68;3ce797955e66d709fd9d96419bc484cab4ddeec3
BOOKKEEPER-480: Fix javac warnings (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415492 13f79535-47bb-0310-9956-ffa450edef68;2522f9863b30359b617b6fd2ab6190c1f1cc8570
BOOKKEEPER-481: Fix javadoc warnings (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415491 13f79535-47bb-0310-9956-ffa450edef68;aa1fecd255bcc3c23d4037c675df88c9c0ba78ab
BOOKKEEPER-487: Add existed hub server settings to configuration template file (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415269 13f79535-47bb-0310-9956-ffa450edef68;ea84d6cc0f7ba8549466104175777369b6de5fac
BOOKKEEPER-457: Create a format command for Hedwig to cleanup its metadata. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1415176 13f79535-47bb-0310-9956-ffa450edef68;0d198abad7b41d8326913384967aeb1239ab0528
BOOKKEEPER-476: Log to file during tests (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1414382 13f79535-47bb-0310-9956-ffa450edef68;9512c57d2c370604e732037c8a3cf262cb60b8a9
BOOKKEEPER-477: In ReadOnlyBookieTest, we should wait for the bookie to die before asserting on it (ivank via fpj)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1414233 13f79535-47bb-0310-9956-ffa450edef68;38336805e367664fbda2a9c6993d5d343c956752
BOOKKEEPER-479: Fix apache-rat issues in tree (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1414207 13f79535-47bb-0310-9956-ffa450edef68;d3ee645781a1ed422d53a027e3d397451dd4c0d2
BOOKKEEPER-471: Add scripts for preCommit testing (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1414044 13f79535-47bb-0310-9956-ffa450edef68;8a3b4ac9a70eca5e55f7c5163c9c62d677c06aa7
BOOKKEEPER-440: Make Write/Delete SubscriptionData Restricted to Version (Fangmin Lv via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1413745 13f79535-47bb-0310-9956-ffa450edef68;e2d624f8b09beca1f3a5c9224aad1aa254642f28
BOOKKEEPER-460: LedgerDeleteTest checks wrong place for log file (Fangmin Lv via ivank) [missing file]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1413700 13f79535-47bb-0310-9956-ffa450edef68;967149c238389e96b760dbda4d4f722aee46b0b5
BOOKKEEPER-460: LedgerDeleteTest checks wrong place for log file (Fangmin Lv via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1413685 13f79535-47bb-0310-9956-ffa450edef68;e789bc0dae00b6e8881912a73c1e55f370c83c84
BOOKKEEPER-467: Allocate ports for testing dynamically (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1412818 13f79535-47bb-0310-9956-ffa450edef68;b3a05cd74652affe4a69f40609de0b92769e05a4
BOOKKEEPER-454: hedwig c++ tester script assumes sh is bash (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1412629 13f79535-47bb-0310-9956-ffa450edef68;afa7a082a6f8ab6936729fb68d84bcebf09e1f19
BOOKKEEPER-466: ZooKeeper test utility sets the port number as the tickTime (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1412061 13f79535-47bb-0310-9956-ffa450edef68;10091096ec339c1524877195172325343b20e02f
BOOKKEEPER-468: Remove <echo> from protobuf generation in hedwig (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1412025 13f79535-47bb-0310-9956-ffa450edef68;0a164a8f7166b853cbf874b91f9a82e51f13f668
BOOKKEEPER-204: Provide a MetaStore interface, and a mock implementation. (Jiannan Wang via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1407520 13f79535-47bb-0310-9956-ffa450edef68;9b7b78890c2f0631a2b62bbbaa8de35ede102c0e
BOOKKEEPER-444: Refactor pending read op to make speculative reads possible (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1406707 13f79535-47bb-0310-9956-ffa450edef68;c32437ad4ff1d1e267f885a0bd67100cebb57ba6
BOOKKEEPER-452: Rename ClientConfiguration multiplexing_enabled to subscription_connection_sharing_enabled (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1406541 13f79535-47bb-0310-9956-ffa450edef68;da1b308ba8eb4dc0cd93b5ad19065067c354f242
BOOKKEEPER-370: implement multiplexing cpp client. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1405159 13f79535-47bb-0310-9956-ffa450edef68;2dd4ff7d82d7dc95eb959ad803164f2a5df96968
BOOKKEEPER-368 Implementing multiplexing java client. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1405028 13f79535-47bb-0310-9956-ffa450edef68;f633075dd0b0cae6c50db0f7284798089a9cf83b
BOOKKEEPER-434: [Hedwig CPP Client] Delay resolving default host until necessary. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1404255 13f79535-47bb-0310-9956-ffa450edef68;0658723fdbcfeceddc983b770d78b01602a64f06
BOOKKEEPER-430: Remove manual bookie registration from overview (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1404083 13f79535-47bb-0310-9956-ffa450edef68;fb28dd140d1c0f6b3737f840b9d62da36713d820
BOOKKEEPER-425: Cleanup Bookie id generation (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402526 13f79535-47bb-0310-9956-ffa450edef68;536d86ec4b93909e870d6bc65fba7037360ea036
BOOKKEEPER-439: No more messages delivered after deleted consumed ledgers. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402501 13f79535-47bb-0310-9956-ffa450edef68;223a3fb3fbc78fe4dc1922967fe3daa3edfc3fb2
BOOKKEEPER-346: Detect IOExceptions in LedgerCache and bookie should look at next ledger dir(if any) (Vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402464 13f79535-47bb-0310-9956-ffa450edef68;3a9a88708d3a1e9e2337a8cc99c3bb727f93ffc4
BOOKKEEPER-441: InMemorySubscriptionManager should back up top2sub2seq before change it (Yixue via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402459 13f79535-47bb-0310-9956-ffa450edef68;ffd46bcd1c7e2c78f6d41355a2215f73661764c1
BOOKKEEPER-416: LedgerChecker returns underreplicated fragments for an closed ledger with no entries (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402172 13f79535-47bb-0310-9956-ffa450edef68;7dced572419c90b27b587eccc09d48032e7a6a9c
BOOKKEEPER-424: Bookie start is failing intermittently when zkclient connection delays (rakeshr via ivank) [missing files]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402159 13f79535-47bb-0310-9956-ffa450edef68;2c7236cf339a2de3cf3fbc0aaa8cd88cc4398ca0
BOOKKEEPER-424: Bookie start is failing intermittently when zkclient connection delays (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1402146 13f79535-47bb-0310-9956-ffa450edef68;eb01b7c1a9d22a55f0107d8b3ba60807d4fd05f4
BOOKKEEPER-427: TestConcurrentTopicAcquisition hangs every so often (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1401286 13f79535-47bb-0310-9956-ffa450edef68;db1484669db7076d71b0ad890f8867e86a18229f
BOOKKEEPER-411: Add CloseSubscription Request for multiplexing support (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1400836 13f79535-47bb-0310-9956-ffa450edef68;d0807e31f6d531cee5898bea3c2af3e312dbe61b
BOOKKEEPER-435: Create SubscriptionChannelManager to manage all subscription channel (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1400827 13f79535-47bb-0310-9956-ffa450edef68;81aa20165c13aab333f9f0fd6b4e948de2ba1cef
BOOKKEEPER-345: Detect IOExceptions on entrylogger and bookie should consider next ledger dir(if any) (Vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1399680 13f79535-47bb-0310-9956-ffa450edef68;794d8c6a363433bc129deeb5568e83ac716379e6
BOOKKEEPER-369: re-factor hedwig cpp client to provide better interface to support both one-subscription-per-channel and multiple-subscriptions-per-channel. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1399578 13f79535-47bb-0310-9956-ffa450edef68;5f9f6ef0719a19e48815e8b021da43e8ad15f6f7
BOOKKEEPER-422: Simplify AbstractSubscriptionManager (stu via fpj)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1399159 13f79535-47bb-0310-9956-ffa450edef68;cb059545270e4517c90d2b52000ea06404307f16
BOOKKEEPER-436: Journal#rollLog may leak file handler (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1398995 13f79535-47bb-0310-9956-ffa450edef68;2385d7a7054dd7e4c3241374b1f5f57360a5a468
BOOKKEEPER-417: Hierarchical zk underreplication manager should clean up its hierarchy when done to allow for fast acquisition of underreplicated entries (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1398834 13f79535-47bb-0310-9956-ffa450edef68;bf3d55f0cbd3461626148ad436a78923047dd797
BOOKKEEPER-418: Store hostname of locker in replication lock (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1396536 13f79535-47bb-0310-9956-ffa450edef68;de64ff31f01e2a6e7889bae8d75681d2176f21bc
BOOKKEEPER-413: Hedwig C++ client: Rename RUN_AS_SSL_MODE to SSL_ENABLED (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1396531 13f79535-47bb-0310-9956-ffa450edef68;ce0e7b2077d495ca9f4192da1154f565cb9def5b
BOOKKEEPER-415: Rename DeliveryThrottle to MessageWindowSize (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1396524 13f79535-47bb-0310-9956-ffa450edef68;c4519d96d592967aaad1d056db3d31cbe56de865
BOOKKEEPER-315: Ledger entries should be replicated sequentially instead of parallel. (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1394542 13f79535-47bb-0310-9956-ffa450edef68;e2487b794ef8d93a1d1380a62ffa212381930393
BOOKKEEPER-319: Manage auditing and replication processes (Vinay via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1394145 13f79535-47bb-0310-9956-ffa450edef68;ba01aed276fc847926310376520d3ec513503c61
BOOKKEEPER-367: Server-Side Message Delivery Flow Control (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1394066 13f79535-47bb-0310-9956-ffa450edef68;f57cbe507d0f366fa76e0e163e867e4a7f93d958
BOOKKEEPER-278: Ability to disable auto recovery temporarily (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1393983 13f79535-47bb-0310-9956-ffa450edef68;24fb0bca0dbdd2ad14c5afcd7fb2fc31f80882f5
BOOKKEEPER-143: Add SSL support for hedwig cpp client (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1392319 13f79535-47bb-0310-9956-ffa450edef68;853ac6bf0107a8b80e44328ce825a8e710ee8986
BOOKKEEPER-364: re-factor hedwig java client to support both one-subscription-per-channel and multiplex-subscriptions-per-channel. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1390777 13f79535-47bb-0310-9956-ffa450edef68;eba338eb398f8a22987c6bd8352bf2d649fb7c33
BOOKKEEPER-397: Make the hedwig client in RegionManager configurable. (Aniruddha via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1390401 13f79535-47bb-0310-9956-ffa450edef68;881cda5c85d17f952bdc2c7e101eef669bce35d2
BOOKKEEPER-388: Document bookie format command (kiran_bc via ivank) [Corrected CHANGES.txt]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1388558 13f79535-47bb-0310-9956-ffa450edef68;cf414cc06ad85d9222de710152cb81bd60943aa5
BOOKKEEPER-388: Document bookie format command (vinayrpet via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1388557 13f79535-47bb-0310-9956-ffa450edef68;00341197badcc1646b8d3fb4ec87ac526ed93b85
BOOKKEEPER-405: Let's add Thread name for ReplicationWorker thread. (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1387525 13f79535-47bb-0310-9956-ffa450edef68;53d3fbf26af00ccc25605fb80bbd73c09c3d90f0
BOOKKEEPER-252: Hedwig: provide a subscription mode to kill other subscription channel when hedwig client is used as a proxy-style server. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1384836 13f79535-47bb-0310-9956-ffa450edef68;820ce5949c6a32ddca32ce7b408a57e27f5086bb
BOOKKEEPER-32: Clean up LOG.debug statements (Stu Hood via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1384782 13f79535-47bb-0310-9956-ffa450edef68;ec977dbe1e7bfb56dc93b6ba72d11f0468345668
BOOKKEEPER-403: ReReadMetadataCb is not executed in the thread responsible for that ledger (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1384700 13f79535-47bb-0310-9956-ffa450edef68;4f2b11213baf8551ef778599b14a6fc17d95f21d
 BOOKKEEPER-392: Racey ConcurrentMap usage in java hedwig-client (Stu Hood via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1384336 13f79535-47bb-0310-9956-ffa450edef68;6bffc3245ae3c2f9a671a0549f394c192460217f
BOOKKEEPER-325: Delay the replication of a ledger if RW found that its last fragment is in underReplication. (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1384080 13f79535-47bb-0310-9956-ffa450edef68;420a6e5e6cab583929622d190d2cd3b360cbd102
BOOKKEEPER-208: Separate write quorum from ack quorum (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1383872 13f79535-47bb-0310-9956-ffa450edef68;e353a8f93ad48d8785bbaa7162a8a9ebca40a15f
BOOKKEEPER-396: Compilation issue in TestClient.java of BenchMark ( showing this in eclipse) (umamahesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1383286 13f79535-47bb-0310-9956-ffa450edef68;26671da549558c4b16da42f2eabfad65fa223831
BOOKKEEPER-383: NPE in BookieJournalTest  (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1382016 13f79535-47bb-0310-9956-ffa450edef68;6f364a214d2b65f5823af2e5699bbc59dc08a4c9
BOOKKEEPER-387: BookKeeper Upgrade is not working. (surendra via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1381879 13f79535-47bb-0310-9956-ffa450edef68;06b50969499330d4a5421b48a042fdee63857d23
BOOKKEEPER-395: HDFS dep transitively depends on a busted pom (Stu Hood via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1381874 13f79535-47bb-0310-9956-ffa450edef68;3d036b0bf3939b042f4ba01a80b8b81ca6774d1b
BOOKKEEPER-300: Create Bookie format command (Vinay via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1381870 13f79535-47bb-0310-9956-ffa450edef68;0eee9e5cd4b5b3affd930a736a3cc2d68a8da976
BOOKKEEPER-394: CompositeException message is not useful (Stu Hood via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1381848 13f79535-47bb-0310-9956-ffa450edef68;64fa78224ed46189032a616f00e1755fd71d93e2
BOOKKEEPER-386: It should not be possible to replicate a ledger fragment which is at the end of an open ledger (ivank & umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1380488 13f79535-47bb-0310-9956-ffa450edef68;800fe7de43333d14dedb2ab64e08a89a78fa31b2
BOOKKEEPER-385: replicateLedgerFragment should throw Exceptions in error conditions (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1380293 13f79535-47bb-0310-9956-ffa450edef68;504369377af29b6d09a801243ead58805784765a
BOOKKEEPER-335: client-side message filter for cpp client. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1380273 13f79535-47bb-0310-9956-ffa450edef68;d169f8843e819e7ef49c1fdfe69a85308f420a4a
BOOKKEEPER-334: client-side message filter for java client. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1380268 13f79535-47bb-0310-9956-ffa450edef68;2ffc123e5ffb37163512a89301a128f07f05750c
BOOKKEEPER-384: Clean up LedgerManagerFactory and LedgerManager usage in tests (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1379445 13f79535-47bb-0310-9956-ffa450edef68;9fcb7c0cddee8b78e1c3aa8db5f7478d9a13397c
BOOKKEEPER-371: NPE in hedwig hub client causes hedwig hub to shut down. (Aniruddha via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1378112 13f79535-47bb-0310-9956-ffa450edef68;fbfd10fa94d909144c369e1514db31669a16872b
BOOKKEEPER-376: LedgerManagers should consider 'underreplication' node as a special Znode (Uma via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1378103 13f79535-47bb-0310-9956-ffa450edef68;06f8f930786ad5c771b8f06ec5d6fe4af5ad3c89
BOOKKEEPER-337: Add entry fails with MetadataVersionException when last ensemble has morethan one bookie failures (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1378023 13f79535-47bb-0310-9956-ffa450edef68;cb8415d5defb27efeb8fa7ab1c92a60d4f5c31af
BOOKKEEPER-333: server-side message filter (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377756 13f79535-47bb-0310-9956-ffa450edef68;6379ae858d11bac62a95ccb06675e2bd511f822a
BOOKKEEPER-272: Provide automatic mechanism to know bookie failures (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377716 13f79535-47bb-0310-9956-ffa450edef68;6b44bc232811e379463f71a27293c3f31ed398ba
BOOKKEEPER-304: Prepare bookie vs ledgers cache and will be used by the Auditor (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377703 13f79535-47bb-0310-9956-ffa450edef68;d930b579a1e96757e1698bf91bc1c99ac1cb5f35
BOOKKEEPER-382: space missed at concatenations in GarbageCollectorThread logging (Brahma via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377671 13f79535-47bb-0310-9956-ffa450edef68;c59b3d2e495e4ab7483b161ab9c2ce59f0c1e013
BOOKKEEPER-381: ReadLastConfirmedOp's Logger class name is wrong (surendra via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377656 13f79535-47bb-0310-9956-ffa450edef68;8e9a19f762fa27d297bf1b401c55fdbabdbcdc82
BOOKKEEPER-380: ZkLedgerUnderreplicationManager.markLedgerUnderreplicated() is adding duplicate missingReplicas while multiple bk failed for the same ledger (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377630 13f79535-47bb-0310-9956-ffa450edef68;621ace8d93eb322f01416e9a98aac23ac87799e3
BOOKKEEPER-248: Rereplicating of under replicated data (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377100 13f79535-47bb-0310-9956-ffa450edef68;97c76a36d79d1d96314cd7e832d1dfbd1211965d
BOOKKEEPER-378: ReplicationWorker may not get ZK watcher notification on UnderReplication ledger lock deletion. (umamaheswararao & ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1377075 13f79535-47bb-0310-9956-ffa450edef68;b3331cbc528aa32ceb30dcbc676d298beda62df3
BOOKKEEPER-354: [BOOKKEEPER-296] [Documentation] Modify the bookkeeper start script and document the bookkeeper stop command in bookkeeperConfig.xml (Kiran BC via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1375448 13f79535-47bb-0310-9956-ffa450edef68;c0746ba1c9569427d5839e3f350f4d8394f01320
BOOKKEEPER-299: Provide LedgerFragmentReplicator which should replicate the fragments found from LedgerChecker (umamahesh via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374719 13f79535-47bb-0310-9956-ffa450edef68;89e1c0913e70ce4c345c1c82b92ae91fac80b1d2
BOOKKEEPER-372: Check service name in bookie start/stop script. (nijel via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374345 13f79535-47bb-0310-9956-ffa450edef68;be94b88ea61b75246586b6495f8d3710d4c4217a
BOOKKEEPER-332: Add SubscriptionPreferences to record all preferences for a subscription (sijie via ivank) [missing files]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374327 13f79535-47bb-0310-9956-ffa450edef68;45034f5f4a51225b9f963840741818da7869a85c
BOOKKEEPER-332: Add SubscriptionPreferences to record all preferences for a subscription (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374321 13f79535-47bb-0310-9956-ffa450edef68;14e23b6d9cf4015cd76c7ed3d5258bfbcbb05ef8
BOOKKEEPER-283: Improve Hedwig Console to use Hedwig Metadata Manager. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374265 13f79535-47bb-0310-9956-ffa450edef68;bb0888acafee138989dffb1cfee732145c953f38
BOOKKEEPER-247: Detection of under replication (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374195 13f79535-47bb-0310-9956-ffa450edef68;fbba5c91318c00d77bd62c211066ae13a14d9d00
BOOKKEEPER-338: Create Version.NEW and Version.ANY static instances of Version so that were not passing around nulls (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1374189 13f79535-47bb-0310-9956-ffa450edef68;f4daacff80da6802528320f5a920e1989cf20fac
BOOKKEEPER-246: Recording of underreplication of ledger entries (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1372808 13f79535-47bb-0310-9956-ffa450edef68;74e097e0b171871f4f0c067600949376ff98cb5d
BOOKKEEPER-326: DeadLock during ledger recovery (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1372343 13f79535-47bb-0310-9956-ffa450edef68;391f9246890b416398e48886fe5ed3c4d2e866ab
BOOKKEEPER-191: Hub server should change ledger to write, so consumed messages have chance to be garbage collected. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1371255 13f79535-47bb-0310-9956-ffa450edef68;ec17d0be6a1a655a40ae4e56abff3e121f7d6f20
BOOKKEEPER-340: Test backward compatibility for hedwig between different versions. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1369854 13f79535-47bb-0310-9956-ffa450edef68;5c59fa532fa44a1803e1d986181c58c1b00f0a4c
BOOKKEEPER-259: Create a topic manager using versioned write for leader election (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1369778 13f79535-47bb-0310-9956-ffa450edef68;4d9f3d32a063975303f42a7108cbd4892062ab89
BOOKKEEPER-339: Let hedwig cpp client support returning message seq id for publish requests. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1369767 13f79535-47bb-0310-9956-ffa450edef68;41b399cd2a4c85fa0b077f0a7749f5cca4e9c423
BOOKKEEPER-343: Failed to register hedwig JMX beans in test cases (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1369115 13f79535-47bb-0310-9956-ffa450edef68;4088f7ac7b700588a935485b0a9723a36cc995f3
BOOKKEEPER-331: Let hedwig support returning message seq id for publish requests. (Mridul via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1367117 13f79535-47bb-0310-9956-ffa450edef68;0092518bb3e345de2113f29450c9e1557cfc8020
BOOKKEEPER-352: Should not use static ServerStats/BKStats instance in TestServerStats/TestBKStats (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1366384 13f79535-47bb-0310-9956-ffa450edef68;46a2663a842c6d256c73fba1bd12eb70559c115e
BOOKKEEPER-330: System.currentTimeMillis usage in Hedwig (uma via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1365873 13f79535-47bb-0310-9956-ffa450edef68;3de1c6668a60999230f446011ca27fa7629b4465
BOOKKEEPER-317: Exceptions for replication (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1365870 13f79535-47bb-0310-9956-ffa450edef68;6e33b2519f98f08faa248056e9e017dd8ba8de90
BOOKKEEPER-349: Entry logger should close all the chennels which are there in Map, instead of closing only current channel. (umamaheswararao via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1365869 13f79535-47bb-0310-9956-ffa450edef68;051320f212b2a6263d2d95db780db62911b9c0f6
BOOKKEEPER-327: System.currentTimeMillis usage in BookKeeper (uma via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1364808 13f79535-47bb-0310-9956-ffa450edef68;df619306ca4c6dd9eba94cbc5ce159e43a5b9ee5
BOOKKEEPER-2: bookkeeper does not put enough meta-data in to do recovery properly (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1362974 13f79535-47bb-0310-9956-ffa450edef68;f13b9f4e26fe9b213837d1e68596b55f74163070
BOOKKEEPER-306: Change C++ client to use gtest for testing (ivank via sijie) (fix wrong entry in CHANGES.txt)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1362408 13f79535-47bb-0310-9956-ffa450edef68;e60f542937a51dd3bb05b770a989478625c734af
BOOKKEEPER-310: Changes in hedwig server to support JMS spec (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1361968 13f79535-47bb-0310-9956-ffa450edef68;51ca99b871ebf85738c82cb1f86eb7de223a44b2
BOOKKEEPER-329: provide stop scripts for hub server (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1360311 13f79535-47bb-0310-9956-ffa450edef68;0e06ddeb7e47bd8794fd378629602e41ea4a1fd9
BOOKKEEPER-250: Need a ledger manager like interface to manage metadata operations in Hedwig (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1360300 13f79535-47bb-0310-9956-ffa450edef68;c2efd0a48c5d1ea4edd7bf33c69a7e5270942eb4
BOOKKEEPER-328: Bookie DeathWatcher is missing thread name (Rakesh via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1358895 13f79535-47bb-0310-9956-ffa450edef68;fbcc0b583fd698cfa9ca232f4be5b0d584bb3ee5
BOOKKEEPER-294: Not able to start the bookkeeper before the ZK session timeout. (rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357581 13f79535-47bb-0310-9956-ffa450edef68;09e5d180231f5307a58a89d0c89169bca890bddf
BOOKKEEPER-296: It's better provide stop script for bookie (nijel via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357466 13f79535-47bb-0310-9956-ffa450edef68;db71147d9df0ad9efa697275e934330d21c99a88
BOOKKEEPER-318: Spelling mistake in MultiCallback log message. (surendra via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357464 13f79535-47bb-0310-9956-ffa450edef68;6b249579f1cdf4e9fb940b0bf54b8d55a1ab38b2
BOOKKEEPER-324: Flakeyness in LedgerCreateDeleteTest (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357277 13f79535-47bb-0310-9956-ffa450edef68;763479b6f94fd4827ee28e9f698cfa9a31095061
BOOKKEEPER-320: Let hedwig cpp client could publish messages using Message object instead of string. (jiannan via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357264 13f79535-47bb-0310-9956-ffa450edef68;18f5927a2bd0f423197a2da49ddd5733cdccb651
BOOKKEEPER-280: LedgerHandle.addEntry() should return an entryId (mmerli via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1355467 13f79535-47bb-0310-9956-ffa450edef68;de432058b7e7c026fcf0b69b1e20bcf9ae1b1de2
BOOKKEEPER-322: New protobufs generates findbugs errors (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1355083 13f79535-47bb-0310-9956-ffa450edef68;441bf650859bc96a49b667961a19afd936b67e4c
BOOKKEEPER-302: No more messages delivered when hub server scans messages over two ledgers. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1355079 13f79535-47bb-0310-9956-ffa450edef68;4d15e5675c0394cb910e54c9b0d9743e98fb64c7
BOOKKEEPER-303: LedgerMetadata should serialized using protobufs (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1354492 13f79535-47bb-0310-9956-ffa450edef68;744edf07394472d3146e57831592a69d5a86616c
BOOKKEEPER-307: BookieShell introduces 4 findbugs warnings (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1354326 13f79535-47bb-0310-9956-ffa450edef68;d193780cc404c2e3694c82385d7f422accc416f3
BOOKKEEPER-292: Test backward compatibility automatically between versions. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1351651 13f79535-47bb-0310-9956-ffa450edef68;18728877881a23d2639eb650d47b7c41bbccd9ca
BOOKKEEPER-203: improve ledger manager interface to remove zookeeper dependency on metadata operations. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1351646 13f79535-47bb-0310-9956-ffa450edef68;297eb745440443eea1a8217c89299abf8d18fc3f
BOOKKEEPER-298: We run with preferIPv4Stack in the scripts but not in the tests (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1351374 13f79535-47bb-0310-9956-ffa450edef68;9472fae8739be41301847b1c8e31954f376997e6
BOOKKEEPER-183: Provide tools to read/check data files in bookie server (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1349896 13f79535-47bb-0310-9956-ffa450edef68;a2cd9899405ef7313a50e87a370aecef543ae4eb
BOOKKEEPER-274: Hedwig cpp client library should not link to cppunit which is just used for test. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1349423 13f79535-47bb-0310-9956-ffa450edef68;aa7f37c6095f61e89a290fc608fd14a50bc7b0e0
BOOKKEEPER-289: mvn clean doesn't remove test output files (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1349400 13f79535-47bb-0310-9956-ffa450edef68;863f32a8ed33a5be3c9c622fb1c701bf3b48a2e0
update release date for release 4.1.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1347634 13f79535-47bb-0310-9956-ffa450edef68;2f5024bbc720f2159efa67eed7a9f21d208a134b
BOOKKEEPER-288: NOTICE files don't have the correct year (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1347628 13f79535-47bb-0310-9956-ffa450edef68;0a3ea6222061e4ba504cdf8ab8937ab26f71b5a9
BOOKKEEPER-287: NoSuchElementException in LedgerCacheImpl (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1346966 13f79535-47bb-0310-9956-ffa450edef68;d5caab3aae143352f2d8c3faea71dce11fdb6b45
BOOKKEEPER-286: Compilation warning (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1346340 13f79535-47bb-0310-9956-ffa450edef68;25552d910c5d32307bda64cc3ae022e607850b7c
BOOKKEEPER-285: TestZkSubscriptionManager quits due to NPE, so other tests are not run in hedwig server. (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1346321 13f79535-47bb-0310-9956-ffa450edef68;27b6dd6a40f3e4721a29ea2030d96994869a8260
BOOKKEEPER-279: LocalBookKeeper is failing intermittently due to zkclient connection establishment delay (Rakesh R via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1346257 13f79535-47bb-0310-9956-ffa450edef68;a788614f5c73b0ab2c18f73d9eff7a858229a94e
BOOKKEEPER-281: BKClient is failing when zkclient connection delays (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1346247 13f79535-47bb-0310-9956-ffa450edef68;10b9c5b40bcb66690f6a25330500610c8b296779
Bump version number to 4.2.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1344543 13f79535-47bb-0310-9956-ffa450edef68;586873a6163021a3c1b218b20f4f9c4ebc921af3
Preparing for release 4.1.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1344538 13f79535-47bb-0310-9956-ffa450edef68;687de61ce5077451957307a37c2feecdfb1ed8b5
BOOKKEEPER-273: LedgerHandle.deleteLedger() should be idempotent (Matteo Merli via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1344301 13f79535-47bb-0310-9956-ffa450edef68;d68727ddd09dc0646af2748c3531e8844fdcaaf4
BOOKKEEPER-271: Review documentation for message bounding (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1343996 13f79535-47bb-0310-9956-ffa450edef68;887546e7937db1c45e42b7ca49b3c82d790adca9
BOOKKEEPER-270: Review documentation on bookie cookie (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1343986 13f79535-47bb-0310-9956-ffa450edef68;f97ac5b415294aafb7e788c3569636882fa7ee4c
BOOKKEEPER-270: Review documentation on bookie cookie (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1343981 13f79535-47bb-0310-9956-ffa450edef68;0cb40cf90f13eedd54392ec954feadf8df28dede
BOOKKEEPER-269: Review documentation for hedwig console client (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1343973 13f79535-47bb-0310-9956-ffa450edef68;bfd09dd0bb5cb2d786d0f413f2c6bc8243d06d54
BOOKKEEPER-258: CompactionTest failed (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342933 13f79535-47bb-0310-9956-ffa450edef68;1dde3e5191e51a6f648c0d16b14ecc1e02fcff0a
BOOKKEEPER-260: Define constant for -1 (invalid entry id) (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342678 13f79535-47bb-0310-9956-ffa450edef68;a1eac18799ddc640bd42e6c038a31e1e26769056
BOOKKEEPER-265: Review JMX documentation (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342646 13f79535-47bb-0310-9956-ffa450edef68;cc28541520136968edd3258861e88c5433c5e154
BOOKKEEPER-266: Review versioning documentation (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342617 13f79535-47bb-0310-9956-ffa450edef68;7ed489997c11c891f91b9fe0659c803a87d57489
BOOKKEEPER-146: TestConcurrentTopicAcquisition sometimes hangs (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342550 13f79535-47bb-0310-9956-ffa450edef68;c59b7b8a285e5d4da72aea1232a29f31610c2306
BOOKKEEPER-263: ZK ledgers root path is hard coded (Aniruddha via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1342145 13f79535-47bb-0310-9956-ffa450edef68;67cbcdd7a2d1668c9bba0d45d6ea3235e4bd11e3
BOOKKEEPER-251: Noise error message printed when scanning entry log files those have been garbage collected. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1339715 13f79535-47bb-0310-9956-ffa450edef68;24e7fb03f6c9e3666aa83cc174b5088926eae3d1
BOOKKEEPER-238: Add log4j.properties in conf/ for bin packages (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1339698 13f79535-47bb-0310-9956-ffa450edef68;1c2141183dd3422c85314b64e7b538c8faacd283
BOOKKEEPER-72: Fix warnings issued by FindBugs (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1339691 13f79535-47bb-0310-9956-ffa450edef68;73dc3481846fdc0c97944c6a7c6ce0cef17ee938
BOOKKEEPER-254: Bump zookeeper version in poms (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1339672 13f79535-47bb-0310-9956-ffa450edef68;f05021f1e9e8461182f082b9ab7819b71703655c
BOOKKEEPER-224: Fix findbugs in bookkeeper-server component [missing changes] (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1339607 13f79535-47bb-0310-9956-ffa450edef68;132849503c0547d4d89d50cd14f700302b391ee2
BOOKKEEPER-209: Typo in ServerConfiguration for READAHEAD_ENABLED (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1338630 13f79535-47bb-0310-9956-ffa450edef68;ba0ab04216f94411bae27a52670c9c8b4da03476
BOOKKEEPER-145: Put notice and license file for distributed binaries in SVN (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1338616 13f79535-47bb-0310-9956-ffa450edef68;eaf6cf985ae7ca4a4f62da2de3ecb569ccc5d3f7
BOOKKEEPER-224: Fix findbugs in bookkeeper-server component (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1336645 13f79535-47bb-0310-9956-ffa450edef68;3a2fdc683eb7c8881e4ce9608bb1d7c3548e27d4
BOOKKEEPER-245: Intermittent failures in PersistanceManager tests (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1336569 13f79535-47bb-0310-9956-ffa450edef68;c32edf860040ebba19c6c57d226b12cd487a00d2
BOOKKEEPER-236: Benchmarking improvements from latest round of benchmarking (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1336100 13f79535-47bb-0310-9956-ffa450edef68;5f25edeba1cbf5de489e1f5a3070188f0163b51b
BOOKKEEPER-235: Bad syncing in entrylogger degrades performance for many concurrent ledgers (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1336083 13f79535-47bb-0310-9956-ffa450edef68;d368d86e287ef982fa70e069001e30124ee22b48
BOOKKEEPER-234: EntryLogger will throw NPE, if any dir does not exist or IO Errors. (umamaheswararao via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335996 13f79535-47bb-0310-9956-ffa450edef68;47ee081e6796ec84c774167dca67c3fd3ceda170
BOOKKEEPER-242: Bookkeeper not able to connect other zookeeper when shutdown the zookeeper server where the BK has connected. (sijie & rakeshr via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335973 13f79535-47bb-0310-9956-ffa450edef68;9efe73998fe1ee72ffae95f3e1b1e65884019710
BOOKKEEPER-215: Deadlock occurs under high load (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335958 13f79535-47bb-0310-9956-ffa450edef68;3e224c4b6d4a0d9317060f7fe0d3519fccc68f5a
BOOKKEEPER-241: Add documentation for bookie entry log compaction (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335947 13f79535-47bb-0310-9956-ffa450edef68;36a4a4190c342d7b3a1d5859c545ca1fc1b713cf
BOOKKEEPER-229: Deleted entry log files would be garbage collected again and again. (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335367 13f79535-47bb-0310-9956-ffa450edef68;a7d658179db3226dc33d53f4d25afd64ea90c061
BOOKKEEPER-232: AsyncBK tests failing (umamaheswararao via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335117 13f79535-47bb-0310-9956-ffa450edef68;6fc326ebd647afbbcc0beab6764b5d3748e50088
BOOKKEEPER-228: Fix the bugs in BK benchmark (umamaheswararao via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1334107 13f79535-47bb-0310-9956-ffa450edef68;268bdb8c6b5f642967329a99ec1dce5ba0af46d7
BOOKKEEPER-231: ZKUtil.killServer not closing the FileTxnSnapLog from ZK. (Uma Maheswara Rao G via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1331720 13f79535-47bb-0310-9956-ffa450edef68;6d50e72732aa741d3a620c4b3ec04593c68f1b62
BOOKKEEPER-56: Race condition of message handler in connection recovery in Hedwig client (added AlreadyStartDeliveryException file missed in r1329883) (sijie & Gavin Li via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1331704 13f79535-47bb-0310-9956-ffa450edef68;f7c1ad57ead301df4d3326b5d8c8950964387fa9
BOOKKEEPER-217: NPE in hedwig client when enable DEBUG (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1329886 13f79535-47bb-0310-9956-ffa450edef68;7f9005baadbbf312db857be6c3d3c095fe800c54
BOOKKEEPER-56: Race condition of message handler in connection recovery in Hedwig client (sijie & Gavin Li via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1329883 13f79535-47bb-0310-9956-ffa450edef68;4e9ee8d75582a66f3e11d78dea280afbb864db7e
BOOKKEEPER-173: Uncontrolled number of threads in bookkeeper (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1328452 13f79535-47bb-0310-9956-ffa450edef68;2f25ef611dd2c8ea2c94b48af09f183d74b6167e
BOOKKEEPER-168: Message bounding on subscriptions (ivank) [missing test]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1328270 13f79535-47bb-0310-9956-ffa450edef68;57a62a1c3ce151e1354a2a4ed212e9e8965928bf
BOOKKEEPER-213: PerChannelBookieClient calls the wrong errorOut function when encountering an exception (Aniruddha via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1327761 13f79535-47bb-0310-9956-ffa450edef68;b5c0791d38a093936016a7989c35363063cdb202
BOOKKEEPER-218: Provide journal manager to manage journal related operations (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1327045 13f79535-47bb-0310-9956-ffa450edef68;cf846eb5f57af19f68ccad42edda7551c852041d
BOOKKEEPER-196: Define interface between bookie and ledger storage (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1327027 13f79535-47bb-0310-9956-ffa450edef68;4a94ce1d8184f5f38def015d80777a8113b96690
BOOKKEEPER-216: Bookie doesn't exit with right exit code (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1326624 13f79535-47bb-0310-9956-ffa450edef68;3d834bd3798f22a43dc434d4b809a5c22731da38
BOOKKEEPER-197: HedwigConsole uses the same file to load bookkeeper client config and hub server config (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1326464 13f79535-47bb-0310-9956-ffa450edef68;8a1ad4c3208ad0e5b546ab8e5738132698fa56f5
BOOKKEEPER-200: Fix format and comments (fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1312034 13f79535-47bb-0310-9956-ffa450edef68;22bb0534ceebb3e9044b727177146fc220683b81
BOOKKEEPER-211: Bookie fails to to start (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1311564 13f79535-47bb-0310-9956-ffa450edef68;df5789843b6624ebda9c6e839458cdfbc3ed7d84
BOOKKEEPER-212: Bookie stops responding when creating and deleting many ledgers (sijie via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1311177 13f79535-47bb-0310-9956-ffa450edef68;8f02fb64ec9612af8422f23ed7908d7f6ccf5332
BOOKKEEPER-207: BenchBookie doesn't run correctly (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1309007 13f79535-47bb-0310-9956-ffa450edef68;f694716e289c448ab89cab5fa81ea0946f9d9193
BOOKKEEPER-135: Fencing does not check the ledger masterPasswd (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1308294 13f79535-47bb-0310-9956-ffa450edef68;47244dd77fb291ec95d5da4c96751ea92bc2d516
BOOKKEEPER-112: Bookie Recovery on an open ledger will cause LedgerHandle#close on that ledger to fail (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1307743 13f79535-47bb-0310-9956-ffa450edef68;682a23fb23c8de7756d5ef226fd6e97dd8d4e561
BOOKKEEPER-198: replaying entries of deleted ledgers would exhaust ledger cache. (sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1307732 13f79535-47bb-0310-9956-ffa450edef68;235bc1fec4d60567d113202b44f6fb4c1616d1ce
BOOKKEEPER-193: Ledger is garbage collected by mistake. (sijie, ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1307725 13f79535-47bb-0310-9956-ffa450edef68;30c68b0bebff1e0a012dd81e8f05ebbf83b4ff5f
BOOKKEEPER-166: Bookie will not recover its journal if the length prefix of an entry is truncated (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1307353 13f79535-47bb-0310-9956-ffa450edef68;4b32e049dca4a1a8eea4bfb2325aee2de629b132
BOOKKEEPER-194: Get correct latency for addEntry operations for JMX. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1306857 13f79535-47bb-0310-9956-ffa450edef68;83e8672a10fab050a5bbcc1beeb9a210c1b2b90b
BOOKKEEPER-190: Add entries would fail when number of open ledgers reaches more than openFileLimit. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1306839 13f79535-47bb-0310-9956-ffa450edef68;48304c7c07513a15d26cb61f311c9f4b998fd8fc
BOOKKEEPER-97: collect pub/sub/consume statistics on hub server (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1306798 13f79535-47bb-0310-9956-ffa450edef68;c805430253c6e6bb4341ad51b406ceabeafcd4e8
BOOKKEEPER-195: HierarchicalLedgerManager doesn't consider idgen as a "specialNode" (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1306616 13f79535-47bb-0310-9956-ffa450edef68;6d56d60831a63fe9520ce156686d0cb1142e44f5
BOOKKEEPER-189: AbstractZkLedgerManager doesn't disregard cookies (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1303291 13f79535-47bb-0310-9956-ffa450edef68;3d32544c0b2b1cd5b184531846a451f518486c7d
BOOKKEEPER-188: Garbage collection code is in the wrong place (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1303286 13f79535-47bb-0310-9956-ffa450edef68;f3a404e4e6b0d0c2a0b2a83d38cdedaff0683e68
BOOKKEEPER-175: Bookie code is very coupled (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1302870 13f79535-47bb-0310-9956-ffa450edef68;7199719beebe79325a93ef57a1140c2ed50c26e9
BOOKKEEPER-187: Create well defined interface for LedgerCache (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1302851 13f79535-47bb-0310-9956-ffa450edef68;841e7dc187b17e6cf4c437fc211f9e285191dd7c
BOOKKEEPER-186: Bookkeeper throttling - permits is not released when read has failed from all replicas (Rakesh R via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1302458 13f79535-47bb-0310-9956-ffa450edef68;3abac4eb86d64286d057d73024a177ef300283b0
BOOKKEEPER-96: extends zookeeper JMX to monitor and manage hedwig server (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1302392 13f79535-47bb-0310-9956-ffa450edef68;0663029788d504f38e98fd79e625a466bb4780c9
BOOKKEEPER-182: Entry log file is overwritten when fail to read lastLogId. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1301395 13f79535-47bb-0310-9956-ffa450edef68;33bef6356dfcf14928314e14c20ae73de80bdf99
BOOKKEEPER-184: CompactionTest failing on Jenkins (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1300862 13f79535-47bb-0310-9956-ffa450edef68;a4bded985ca1346a17ee0dcf08fe9dcd570dcfb7
BOOKKEEPER-185: Remove bookkeeper-server dependency on hadoop-common (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1300616 13f79535-47bb-0310-9956-ffa450edef68;e8a1dec3fbea9b2f8c59c32e2f189d60c1864688
BOOKKEEPER-168: Message bounding on subscriptions (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1300510 13f79535-47bb-0310-9956-ffa450edef68;fd5bb2bce8585ef49ba01d853241a4ee36d487e2
BOOKKEEPER-163: Prevent incorrect NoSuchLedgerException for readLastConfirmed. (ivank via sijie)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1299984 13f79535-47bb-0310-9956-ffa450edef68;c6cc7cca3a85603c8e935ba6d06fbf3d8d7a7eb5
Set benchmark script to executable (BOOKKEEPER-158)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1298847 13f79535-47bb-0310-9956-ffa450edef68;8207445ea25bef37e3369e749913acc0d597d9b2
BOOKKEEPER-158: Move latest benchmarking code into trunk (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1298825 13f79535-47bb-0310-9956-ffa450edef68;028a6d5360637417141f7f819a404e8e71117f9b
BOOKKEEPER-180: bookie server doesn't quit when running out of disk space (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1298492 13f79535-47bb-0310-9956-ffa450edef68;cb8296636b961253f9586f535db285bfafa54a8a
BOOKKEEPER-160: bookie server needs to do compaction over entry log files to reclaim disk space (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1298357 13f79535-47bb-0310-9956-ffa450edef68;e911559291b6ae9aa310a695fb4174796921ac81
BOOKKEEPER-176: HierarchicalBookieFailureTest Hung (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1295604 13f79535-47bb-0310-9956-ffa450edef68;431554da9e2598c73edfbaf671e87cfd9ae94716
BOOKKEEPER-74: Bookkeeper Persistence Manager should give up topic on error (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1295571 13f79535-47bb-0310-9956-ffa450edef68;76818a6aadd4aa40a45aca6f5b0acba79cd42515
BOOKKEEPER-113: NPE In BookKeeper test (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1293383 13f79535-47bb-0310-9956-ffa450edef68;9366322bfe3461a44a8b0444e66cd774ea1ac7d8
BOOKKEEPER-178: Delay ledger directory creation until the ledger index file was created (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1293372 13f79535-47bb-0310-9956-ffa450edef68;2ec70d4dbf2266b17bdb99975f974f30afa65593
BOOKKEEPER-177: Index file is lost or some index pages aren't flushed. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1293369 13f79535-47bb-0310-9956-ffa450edef68;9523193456992a2edd36106120a8a9f246af6995
BOOKKEEPER-172: Upgrade framework for filesystem layouts (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1293342 13f79535-47bb-0310-9956-ffa450edef68;110d36673bcc393853aaab4bb423d785daa947c7
BOOKKEEPER-174: Bookie can't start when replaying entries whose ledger were deleted and garbage collected. (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1245411 13f79535-47bb-0310-9956-ffa450edef68;014bcd501c14141facd0e3eb4bb488ccba3a2b7d
BOOKKEEPER-169: bookie hangs on reading header when encountering partial header index file (sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1245369 13f79535-47bb-0310-9956-ffa450edef68;bad375aa35a2c17c466d2be7481e7d16220d59b0
BOOKKEEPER-170: Bookie constructor starts a number of threads. (ivank via fpj)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1244528 13f79535-47bb-0310-9956-ffa450edef68;633a23b3a20b27a551328be2efe5f057be3c99e2
BOOKKEEPER-171: ServerConfiguration can't use more than one directory for ledgers--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1244421 13f79535-47bb-0310-9956-ffa450edef68;3defe9e5110472da995789b5ae14c286f58f1293
BOOKKEEPER-152: Can't recover a ledger whose current ensemble contain failed bookie. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1243539 13f79535-47bb-0310-9956-ffa450edef68;5a3b29d05abd71c6e5d1b3045abafd434db15f24
BOOKKEEPER-162: LedgerHandle.readLastConfirmed does not work (fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1243462 13f79535-47bb-0310-9956-ffa450edef68;29a472598083e522645f918ec602dd91d800f0d5
BOOKKEEPER-137: Do not create Ledger index files until absolutely necessary. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1242404 13f79535-47bb-0310-9956-ffa450edef68;c65d6ada34215ee3a5466c495d565d745857c435
BOOKKEEPER-165: Add versioning support for journal files (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1241922 13f79535-47bb-0310-9956-ffa450edef68;beca5951f73cb9c39be10a4166a90dee9fff3c1c
BOOKKEEPER-77: Add a console client for hedwig (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1241858 13f79535-47bb-0310-9956-ffa450edef68;a3c9c953db49bc1ec3d72f01212e6cbcd58cc5d3
BOOKKEEPER-156: BookieJournalRollingTest failing (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1241855 13f79535-47bb-0310-9956-ffa450edef68;bd2efa12f1f63afa90723ce405caebafb4afd6be
BOOKKEEPER-167: PerChannelBookieClient doesn't use ClientConfiguration (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1241854 13f79535-47bb-0310-9956-ffa450edef68;3272204448bf210d03377ba822d01419ad197a17
BOOKKEEPER-161: PerChannelBookieClient tries to reuse HashedWheelTimer, throws Exception (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1241404 13f79535-47bb-0310-9956-ffa450edef68;cfe3e650b69b2b599dd5b2f27f2164af38c7a2be
BOOKKEEPER-157. For small packets, increasing number of bookies actually degrades performance. (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1239167 13f79535-47bb-0310-9956-ffa450edef68;835d963cb26d0a5d5b1cc79a0faf185b49673d16
Removing file accidentally added in r1239096--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1239098 13f79535-47bb-0310-9956-ffa450edef68;d5fc00dc6b0a888b68131b7dff7309687c96d07e
BOOKKEEPER-98: collect add/read statistics on bookie server (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1239096 13f79535-47bb-0310-9956-ffa450edef68;5a7f4991610ad60d277830b72dc5d890c63a0f07
BOOKKEEPER-23: Timeout requests (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1239068 13f79535-47bb-0310-9956-ffa450edef68;7e12629ed7a2006e4805dac0e5c006324a52d5db
BOOKKEEPER-153: Ledger can't be opened or closed due to zero-length metadata (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1232890 13f79535-47bb-0310-9956-ffa450edef68;f56e596d70c66dac170008ffbe19489eee05be08
BOOKKEEPER-95: extends zookeeper JMX to monitor and manage bookie server (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1232852 13f79535-47bb-0310-9956-ffa450edef68;cdcfbb52cbf8f0e6f17d56d7185cf0d04c9c856b
BOOKKEEPER-150: Entry is lost when recovering a ledger with not enough bookies. (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1232448 13f79535-47bb-0310-9956-ffa450edef68;c7c8af741a2f532b554dcdabf85237c23ea14aaa
BOOKKEEPER-40: BookieClientTest fails intermittantly (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1231187 13f79535-47bb-0310-9956-ffa450edef68;0d43f404ea145a35d46371967975f9590649a033
BOOKKEEPER-148: Jenkins build is failing (ivank via fpj)-----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1230070 13f79535-47bb-0310-9956-ffa450edef68;e32715ad96558a9941910dd6ae91fc1c646baeb6
BOOKKEEPER-133: Hub server should update subscription state to zookeeper when losing topic or shutting down (Sijie Gou via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1222365 13f79535-47bb-0310-9956-ffa450edef68;0975f069d90748eb43fcec7622d3961b0446ea28
BOOKKEEPER-140: Hub server doesn't subscribe remote region correctly when a region is down. (Sijie Gou via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1221798 13f79535-47bb-0310-9956-ffa450edef68;8f755ed13f193ad6491fdca1794d834f3d3d4dcc
BOOKKEEPER-141: Run extracting ledger id from entry log files in GC thread to speed up bookie restart (Sijie Gou via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1215156 13f79535-47bb-0310-9956-ffa450edef68;015097021c1a2d2860643fda7fcb3e8a0d191442
BOOKKEEPER-142: Parsing last log id is wrong, which may make entry log files overwritten (Sijie Gou via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1215098 13f79535-47bb-0310-9956-ffa450edef68;9eb549d4c308963af0be3288a59b0c4c39cbb5e6
BOOKKEEPER-139: Binary packages do not carry NOTICE.txt (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1209671 13f79535-47bb-0310-9956-ffa450edef68;1c90beb59a6aa94f18ca6b5ca1f94a0db5e0cc14
BOOKKEEPER-138: NOTICE.txt is invalid (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1209650 13f79535-47bb-0310-9956-ffa450edef68;d006007ccf86f924d0773e267675a52e98314710
Reverting BOOKKEEPER-130: Add developer KEYS file to svn (ivank) --git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1209621 13f79535-47bb-0310-9956-ffa450edef68;213db5d6a6d55b5b093776a4c54fa5c8ffed5f0d
BOOKKEEPER-134: Delete superfluous lib directories (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1209276 13f79535-47bb-0310-9956-ffa450edef68;dcfe4bcc5123eb70a5366bbf3b4931d8d23f9e48
BOOKKEEPER-131: Fix zookeeper test dependency (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1209237 13f79535-47bb-0310-9956-ffa450edef68;86844d7303f62a8e2361ca56d83ba2d47e5c77b8
BOOKKEEPER-132: Sign artifacts before deploying to maven (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208487 13f79535-47bb-0310-9956-ffa450edef68;63b032331f28fe434ea37d7cb2e515609298b7ed
BOOKKEEPER-66: use IPv4 for builds (mmorel via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208472 13f79535-47bb-0310-9956-ffa450edef68;3bc2bdb0d0f38b004fa95a58e8b02104005c663b
Bumping version number for trunk: 4.0.0 -> 4.1.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208399 13f79535-47bb-0310-9956-ffa450edef68;9794cc0c6d8531c1a6540db660e55add2469d019
Fixing CHANGES.txt for new trunk--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208398 13f79535-47bb-0310-9956-ffa450edef68;5b90ba75a5cfa13a77297fd488024cd05ce07420
Preparing for release 4.0.0--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208396 13f79535-47bb-0310-9956-ffa450edef68;814f0ab6b4d43a35992e995c8abd804326ec633b
Cleanup of CHANGES.txt before cutting 4.0.0 branch--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208395 13f79535-47bb-0310-9956-ffa450edef68;f2e9d4ca08e6ce254c61e0a27a04a7b2f95c6642
BOOKKEEPER-130: Add developer KEYS file to svn (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208382 13f79535-47bb-0310-9956-ffa450edef68;12840c3e9e85ac400597d26663b19277c41987a7
BOOKKEEPER-129: ZK_TIMEOUT typo in client/server configuration (Sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208372 13f79535-47bb-0310-9956-ffa450edef68;92e69b331797ea6a4eb4d46b668360e6c7bb9bd4
BOOKKEEPER-128: pom and script modifications required for generating release packages (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208358 13f79535-47bb-0310-9956-ffa450edef68;fa78ba95d4e6ccff5ebb734e6036b11c802b3030
BOOKKEEPER-111: Document bookie recovery feature (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208133 13f79535-47bb-0310-9956-ffa450edef68;49aa4df144abcd6b117ac376b71ac70a5af946b7
BOOKKEEPER-122: Review BookKeeper server documentation (fpj & ivank) [Forgot to add 2 files]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208129 13f79535-47bb-0310-9956-ffa450edef68;86040b51874dcb40d1693593942d975c8327e919
BOOKKEEPER-122: Review BookKeeper server documentation (fpj & ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208123 13f79535-47bb-0310-9956-ffa450edef68;544f4b5c0480bb383134fe6e26c2fe0e0a6c8b11
BOOKKEEPER-120: Review BookKeeper client documentation (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208111 13f79535-47bb-0310-9956-ffa450edef68;e3b52e82ccccf4807100db0950609ec7ede8378c
BOOKKEEPER-127: Make poms use official zookeeper 3.4.0 (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208109 13f79535-47bb-0310-9956-ffa450edef68;aa1d8296672a1a29fdc3de630f5995c0d1a21429
BOOKKEEPER-121: Review Hedwig client documentation (breed via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1208050 13f79535-47bb-0310-9956-ffa450edef68;8b6f36788cb4614d506e0e526475592cd8fbeb6a
BOOKKEEPER-62: Bookie can not start when encountering corrupted records (breed via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207997 13f79535-47bb-0310-9956-ffa450edef68;da088187d80bf0b935aad14c1a4aa73e4920378f
BOOKKEEPER-125: log4j still used in some places (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207996 13f79535-47bb-0310-9956-ffa450edef68;504867718d934b66dfa4df8edc55c9c888aa3d42
BOOKKEEPER-124: build has RAT failures (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207797 13f79535-47bb-0310-9956-ffa450edef68;c323c003687319d20eb7539c0e85a9cf3a4a6d08
BOOKKEEPER-53: race condition of outstandingMsgSet@SubscribeResponseHandler---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207648 13f79535-47bb-0310-9956-ffa450edef68;924fb834de0ae926ea075385c47dd29f8dd804a3
BOOKKEEPER-39: Bookie server failed to restart because of too many ledgers (more than ~50,000 ledgers) (Sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207495 13f79535-47bb-0310-9956-ffa450edef68;3af9f38fc3b53c40751904972384ecb9a4e9fb44
BOOKKEEPER-119: Keys in configuration have inconsistent style (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207396 13f79535-47bb-0310-9956-ffa450edef68;d5d73a8591369458c075034b8111f0dfabc2916d
BOOKKEEPER-117: Support multi threads in hedwig cpp client to leverage multi-core hardware (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207289 13f79535-47bb-0310-9956-ffa450edef68;9daeb60bc274a425b9e90ed50d3454a6bfb3cf31
BOOKKEEPER-118: Hedwig client doesn't kill and remove old subscription channel after redirection. (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1207099 13f79535-47bb-0310-9956-ffa450edef68;e110067476eb55289d6dd86a94a6a1b0ab1a2ad8
BOOKKEEPER-79: randomly startDelivery/stopDelivery will core dump in c++ hedwig client (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1204437 13f79535-47bb-0310-9956-ffa450edef68;1bcbc47bcc6394b0c6fdeb73203aab59eab0fee5
BOOKKEEPER-114: add a shutdown hook to shut down bookie server safely. (Sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203790 13f79535-47bb-0310-9956-ffa450edef68;aed845b574b88abc825634d3c860dcfd40351fb8
BOOKKEEPER-115: LocalBookKeeper fails after BOOKKEEPER-108 (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203774 13f79535-47bb-0310-9956-ffa450edef68;d33f843a67ad8bc73367259c78170c0bfab24cdc
BOOKKEEPER-69: ServerRedirectLoopException when a machine (hosts bookie server & hub server) reboot, which is caused by race condition of topic manager (Sijie, ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203576 13f79535-47bb-0310-9956-ffa450edef68;4afc000c193174857925f357a32950ab743490bc
BOOKKEEPER-108: add configuration support for BK (Sijie via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203568 13f79535-47bb-0310-9956-ffa450edef68;4049d4c2b115f81008ef7a3920fd9153ced2f53c
BOOKKEEPER-90: Hedwig API changes for initial Bookkeeper release (ivank via fpj)-----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203380 13f79535-47bb-0310-9956-ffa450edef68;e14618559769b7f3fa68360a4571a84392e162e3
BOOKKEEPER-87: TestHedwigHub exhausts direct buffer memory with netty 3.2.4.Final (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203191 13f79535-47bb-0310-9956-ffa450edef68;03e03c2b4a0eb0266cad4eb5e34099100629425e
BOOKKEEPER-91: Bookkeeper and hedwig clients should not use log4j directly (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203138 13f79535-47bb-0310-9956-ffa450edef68;3969ff71a1865b5b8c32b60ac529999c6de71ab8
BOOKKEEPER-81: disk space of garbage collected entry logger files isn't reclaimed util process quit (Sijie Guo via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203118 13f79535-47bb-0310-9956-ffa450edef68;304bf8fe61bd545072d09c7089d8b92fc3c2f1d3
BOOKKEEPER-109: Add documentation to describe how bookies flushes data (Sijie Guo via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1203103 13f79535-47bb-0310-9956-ffa450edef68;b83d00086a263af5b51e3e061170934c53447976
BOOKKEEPER-104: Add versioning between bookie and its filesystem layout (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1202814 13f79535-47bb-0310-9956-ffa450edef68;4be547c861f024e48a7b0074effb8c26ff0a97fc
BOOKKEEPER-101 : Add Fencing to Bookkeeper (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1202758 13f79535-47bb-0310-9956-ffa450edef68;4d9f0c0ebe8614e0190c5df5bbd68c6fa1c05180
BOOKKEEPER-106:	recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble (forgot to edit CHANGES.txt)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1202372 13f79535-47bb-0310-9956-ffa450edef68;64411b9af4eede947f0cf0fd46da4d3170ec18e4
BOOKKEEPER-106: recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1202370 13f79535-47bb-0310-9956-ffa450edef68;75dbf699b90dd01b0dd44e4bdda60e7176b3ee12
BOOKKEEPER-82: support journal rolling (Sijie Guo via fpj)-----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1200806 13f79535-47bb-0310-9956-ffa450edef68;cc467bd5880c2879e6c0355469d51759f89bbabc
BOOKKEEPER-80: subscription msg queue race condition in hedwig c++ client (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1199372 13f79535-47bb-0310-9956-ffa450edef68;6e3b195d16ef4b24618d7bb13b3eede6b9126e74
BOOKKEEPER-107: memory leak in HostAddress of hedwig c++ client (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1199368 13f79535-47bb-0310-9956-ffa450edef68;2ea2fd09f2bbbea18e183c8af8e82e81eee9fe79
BOOKKEEPER-50: NullPointException at LedgerDescriptor#cmpMasterKey (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1197495 13f79535-47bb-0310-9956-ffa450edef68;c17dfb9aa2aeb6d3d1c6fa934dc9ef15bf6b5bc2
BOOKKEEPER-102: Make bookkeeper use ZK from temporary repo (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1197489 13f79535-47bb-0310-9956-ffa450edef68;e7184063b0fa20fbbb9802863143a11183858656
BOOKKEEPER-103: ledgerId and entryId is parsed wrong when addEntry (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1197472 13f79535-47bb-0310-9956-ffa450edef68;978c0e13dd5896494f306ec2afed026caa9993b0
BOOKKEEPER-71: hedwig c++ client does not build . (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1190306 13f79535-47bb-0310-9956-ffa450edef68;dc5f5d223502b8bc9ef6bc3706f3bbea975e757e
BOOKKEEPER-100: Some hedwig tests have build errors (dferro via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1189874 13f79535-47bb-0310-9956-ffa450edef68;ea616470cfbd129bb03098698a562e1b8dd8ecc4
BOOKKEEPER-93: bookkeeper doesn't work correctly on OpenLedgerNoRecovery (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1189867 13f79535-47bb-0310-9956-ffa450edef68;d1823db0509fe49b0ce8140c620e4c5100427407
BOOKKEEPER-89: Bookkeeper API changes for initial Bookkeeper release (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1189842 13f79535-47bb-0310-9956-ffa450edef68;68bdab655445f80314a0d2531e60e3b2e4d8fa17
BOOKKEEPER-83: Added versioning and flags to the bookie protocol (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1189753 13f79535-47bb-0310-9956-ffa450edef68;c898d53ab269fbd64cb00919808c7bb0c52c53a6
BOOKKEEPER-94: Double callbacks in readLastConfirmedOp which fails readLastConfirmed operation even received enough valid responses. (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1189225 13f79535-47bb-0310-9956-ffa450edef68;d6465cad801b4ee89b77d1beec6acc371f8ddb6c
BOOKKEEPER-92: using wrong context object in readLastConfirmedComplete callback (Sijie Guo via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1188704 13f79535-47bb-0310-9956-ffa450edef68;45f2edbb1c3233309f6498e581e4cdcd87dcb70a
BOOKKEEPER-88: derby doesn't like - in the topic names (breed via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1188059 13f79535-47bb-0310-9956-ffa450edef68;4f09c6b4af38b51d259d8a6068806f7f22cc1847
BOOKKEEPER-84: Add versioning for ZK metadata---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1187846 13f79535-47bb-0310-9956-ffa450edef68;477eb1053f5c1bff1c0037fb0d6a02b468148682
missing CHANGE.txt entry for BOOKKEEPER-61 (commit 1180266)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1186382 13f79535-47bb-0310-9956-ffa450edef68;d05e52ce5a6bf8b0076685ccec03f5ab91b2b32d
BOOKKEEPER-86: bookkeeper-benchmark fails to compile after BOOKKEEPER-68---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1185775 13f79535-47bb-0310-9956-ffa450edef68;2c91d144a7e283c09e90b3065aa6fb352e177083
BOOKKEEPER-68: Conditional setData (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1185532 13f79535-47bb-0310-9956-ffa450edef68;2f2f6c66da80e1f2e8a0f7661e91bcd0898d6289
BOOKKEEPER-65: fix dependencies on incompatible versions of netty (mmorel via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1185388 13f79535-47bb-0310-9956-ffa450edef68;c980c700d1313911903df3d4c3d48cf8da441827
  BOOKKEEPER-61: BufferedChannel read endless when the remaining bytes of file is less than the capacity of read buffer---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1180266 13f79535-47bb-0310-9956-ffa450edef68;9639b64a1296f937a7b2704de671a38deb31007b
BOOKKEEPER-41: Generation of packages for distribution (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1179705 13f79535-47bb-0310-9956-ffa450edef68;06eea6791177f3d9dcb116ceccff2f6c3f619a39
BOOKKEEPER-59: Race condition in netty code allocates and orphans resources (BK-5 revisited) (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1171607 13f79535-47bb-0310-9956-ffa450edef68;6823a35ceafcaf3d8802a8e502883d3d07e891f7
BOOKKEEPER-26: Indentation is all messed up in the BookKeeper code (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1165369 13f79535-47bb-0310-9956-ffa450edef68;ba9ebc213c14aa5d16a26f2e0601a39ac5888e10
BOOKKEEPER-63: Hedwig PubSubServer must wait for its Zookeeper client to be connected upon startup (morel via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1165231 13f79535-47bb-0310-9956-ffa450edef68;79ea05a3cbcc953bd86f024eb4143e4b85fcd8f1
BOOKKEEPER-57: NullPointException at bookie.zk@EntryLogger (xulei via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1163655 13f79535-47bb-0310-9956-ffa450edef68;28377803242f8514fcdf17f7a808aa756fa158b9
BOOKKEEPER-52: Message sequence confuse due to the subscribeMsgQueue@SubscribeResponseHandler (xulei via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1163161 13f79535-47bb-0310-9956-ffa450edef68;360174f12df9b853e4f3b65631c4063e150beb8f
BOOKKEEPER-51: NullPointException at FIFODeliveryManager#deliveryPtrs (xulei via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1163149 13f79535-47bb-0310-9956-ffa450edef68;675efc92fdb7c88ff9b871ba2ccf56974f769544
BOOKKEEPER-28: Create useful startup scripts for bookkeeper and hedwig (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1163137 13f79535-47bb-0310-9956-ffa450edef68;afdd3dd1e7e06f97e29ff5bcaa2001f81f6d9210
BOOKKEEPER-18: maven build is unstable (morel, ivank via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1162913 13f79535-47bb-0310-9956-ffa450edef68;da1df6bcf4f3a1cc2ed4d3798764e855555ab8f8
BOOKKEEPER-58: Changes introduced in BK-38 cause BookieClientTest to hang indefinitely. (ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1162912 13f79535-47bb-0310-9956-ffa450edef68;ad96c00dcd01ee310c63f78211c6b66c8c874e05
forgot to add test from BOOKKEEPER-38---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1160918 13f79535-47bb-0310-9956-ffa450edef68;c30c309bf95a6ba145d33326af73253fb835b1b4
BOOKKEEPER-44: Reuse publish channel to default server to avoid too many connect requests to default server when lots of producers came in same time---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1160917 13f79535-47bb-0310-9956-ffa450edef68;5095045d969a5fb4b7849cce89e3fa24ee830320
BOOKKEEPER-38: Bookie Server doesn't exit when its zookeeper session is expired. So the process is hang there.---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1160915 13f79535-47bb-0310-9956-ffa450edef68;a01067bb2003e6836acc638b734581844eb08324
BOOKKEEPER-43: NullPointException when releasing topic---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1160913 13f79535-47bb-0310-9956-ffa450edef68;a772663c8e7051396bac5bae5b4ba7bc7ec75e78
BOOKKEEPER-29: BookieRecoveryTest fails intermittently (ivank, fpj via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1156766 13f79535-47bb-0310-9956-ffa450edef68;40b13a6b7db9d2da337dce0c7084d8c87c4d6b06
BOOKKEEPER-33: Add length and offset parameter to addEntry (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1156723 13f79535-47bb-0310-9956-ffa450edef68;0910d6cd7ffb1a7b78ab91a327715e936a3eb9e5
BOOKKEEPER-29: BookieRecoveryTest fails intermittently (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1156096 13f79535-47bb-0310-9956-ffa450edef68;de1c3b26a1162fb545c91d9cef4eed435c662a66
BOOKKEEPER-27: mvn site failed with unresolved dependencies (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1152529 13f79535-47bb-0310-9956-ffa450edef68;3e9d596480537e45a23e591a1daabddffd2b15bf
BOOKKEEPER-11: Read from open ledger (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1151958 13f79535-47bb-0310-9956-ffa450edef68;74397e3e20b2cd3e3c920f00be7f044cf548e076
BOOKKEEPER-30: Test are too noisy (ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1145532 13f79535-47bb-0310-9956-ffa450edef68;45aeb04735d120d3aa9a0110becf3ba2d7ef6afc
BOOKKEEPER-5: Issue with Netty in BookKeeper (fpj and ivank via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1143850 13f79535-47bb-0310-9956-ffa450edef68;00f25f5622e69f063202f7bd46f09ad1d708983d
initial setup for hedwig and bookkeeper doc---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1140397 13f79535-47bb-0310-9956-ffa450edef68;d20cb28943e80c1d39cca5916f459651e29dd573
BOOKKEEPER-22: Exception in LedgerCache causes addEntry request to fail (fpj via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1132682 13f79535-47bb-0310-9956-ffa450edef68;267ed95a2ae2ef1a8f6a3166b217d86a28166391
BOOKKEEPER-1: Static variable makes tests fail (fpj via ivank) [CHANGES.txt]--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1127455 13f79535-47bb-0310-9956-ffa450edef68;266b1c2744a35b9379ba5e7023322a2450b91090
BOOKKEEPER-1: Static variable makes tests fail (fpj via ivank)--git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1127451 13f79535-47bb-0310-9956-ffa450edef68;9ea30d361649e13f28efb05ea2155cf765267a2f
BOOKKEEPER-19: BookKeeper doesn't support more than 2Gig of memory (ivan via fpj)----git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1125406 13f79535-47bb-0310-9956-ffa450edef68;8ee32a8ab80dcd51f7846972d92b7c9e83d99862
more fixing of the build (ivankelly via breed)---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1090338 13f79535-47bb-0310-9956-ffa450edef68;30c326643938bb3df6b35515e714622d98772352
got bookkeper work with maven---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1087198 13f79535-47bb-0310-9956-ffa450edef68;e988271acee2c217209d5c7f52c07f6211257e97
ZOOKEEPER-1038. Move bookkeeper and hedwig code in subversion---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1087134 13f79535-47bb-0310-9956-ffa450edef68;c1c8bef6125cb70ed2da68e92bb49e45f4ea64a9
added top level directories---git-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1086836 13f79535-47bb-0310-9956-ffa450edef68;9ea37773fa07e8e1c16e654020ae34c3d6564963
